#!/usr/bin/env python3
"""
Erstellt einen Fix-Prompt f√ºr den AI Issue Fix Workflow.
Behandelt sicher alle Sonderzeichen in Issue-Beschreibungen.
"""
import os
import sys

def create_fix_prompt():
    """Erstellt den Fix-Prompt aus Environment-Variablen."""
    issue_num = os.environ.get('ISSUE_NUM', '')
    issue_title = os.environ.get('ISSUE_TITLE', '')
    issue_url = os.environ.get('ISSUE_URL', '')
    issue_body = os.environ.get('ISSUE_BODY', '')
    branch_name = os.environ.get('BRANCH_NAME', '')
    base_branch = os.environ.get('BASE_BRANCH', 'main')

    if not issue_num:
        print("‚ùå Error: ISSUE_NUM environment variable not set", file=sys.stderr)
        sys.exit(1)

    prompt = f"""Du arbeitest in einem GitHub Actions Runner mit vollst√§ndigem Zugriff auf Git und GitHub CLI.

**WICHTIG - Terminal-Befehle:**
Du hast VOLLST√ÑNDIGEN Zugriff auf die Shell und kannst ALLE Terminal-Befehle direkt ausf√ºhren!
- Verwende das `run_terminal_cmd` Tool f√ºr Git-Befehle: `git add`, `git commit`, `git push`
- Verwende das `run_terminal_cmd` Tool f√ºr GitHub CLI-Befehle: `gh pr create`, `gh issue comment`
- Die Shell-Umgebung ist vollst√§ndig konfiguriert: Git, GitHub CLI, alle Tools sind verf√ºgbar
- Du kannst JEDEN Shell-Befehl ausf√ºhren - es gibt KEINE Einschr√§nkungen!

**WICHTIG - Terminal-Befehle:**
Du arbeitest in einem GitHub Actions Runner. Du hast Zugriff auf Tools wie `run_terminal_cmd` f√ºr Terminal-Befehle.

**Versuche IMMER zuerst Terminal-Befehle direkt auszuf√ºhren:**
- Verwende `run_terminal_cmd` f√ºr Git-Befehle: `git add .`, `git commit -m "..."`, `git push origin {branch_name}`
- Verwende `run_terminal_cmd` f√ºr GitHub CLI-Befehle: `gh pr create ...`, `gh issue comment ...`

**FALLBACK - Falls Terminal-Befehle abgelehnt werden:**
Wenn `run_terminal_cmd` nicht funktioniert, erstelle ein Fallback-Script `/tmp/agent-commands.sh`:
1. Script mit `#!/bin/bash` beginnen
2. Alle Git- und GitHub CLI-Befehle hinzuf√ºgen
3. Script ausf√ºhrbar machen: `chmod +x /tmp/agent-commands.sh`
4. Der Workflow f√ºhrt das Script dann automatisch aus

**WICHTIG:** Versuche IMMER zuerst Terminal-Befehle direkt - nur wenn das nicht funktioniert, verwende das Fallback-Script!

# Aufgabe: Issue #{issue_num} beheben

**Issue-Titel:** {issue_title}
**Issue-URL:** {issue_url}

**Issue-Beschreibung:**
{issue_body}

## Deine Aufgabe:

1. **Analysiere das Problem** im Issue
2. **Finde die betroffenen Dateien** (nutze `git`, `gh`, oder lese Dateien direkt)
3. **Implementiere die L√∂sung** direkt im Code
4. **Erstelle Commits** mit `git add` und `git commit`
5. **Pushe die √Ñnderungen** mit `git push` (Branch: {branch_name})
6. **Erstelle einen Pull Request** mit `gh pr create` und verlinke ihn mit dem Issue
7. **Teste deine L√∂sung** (falls Tests vorhanden sind)

## WICHTIG - Du MUSST folgendes tun:

### Git-Operationen:
- **WICHTIG:** Verwende das `run_terminal_cmd` Tool f√ºr ALLE Git-Befehle!
- **Git-Befehle ausf√ºhren:** Nutze `run_terminal_cmd` mit Befehlen wie `git add`, `git commit`, `git push`
- **Erstelle sinnvolle Commits:** Jeder Commit sollte eine logische √Ñnderungseinheit sein
- **Commit-Messages:** Verwende klare, beschreibende Messages (z.B. "fix: resolve issue #{issue_num}")
- **Keine leeren Commits:** Nur committen wenn tats√§chlich √Ñnderungen gemacht wurden
- **Keine Force-Push:** Nutze normale `git push origin {branch_name}`
- **Git ist bereits konfiguriert:** User und Email sind gesetzt, du musst sie nicht nochmal setzen

### Pull Request erstellen:
**NACH dem Push der √Ñnderungen MUSST du einen Pull Request erstellen:**

1. **PR-Titel:** `fix: Resolve issue #{issue_num} - {issue_title}`

2. **PR-Body:** Erstelle eine aussagekr√§ftige Beschreibung:
   ```markdown
   ## ü§ñ AI-Generated Fix for Issue #{issue_num}

   This PR was automatically generated by the AI Issue Fix workflow to resolve issue #{issue_num}.

   **Issue:** {issue_title}
   **Issue URL:** {issue_url}

   ### Changes
   This PR contains the AI-generated fix for the issue. Please review carefully before merging.

   ### Review Checklist
   - [ ] Code changes are correct
   - [ ] Tests pass (if applicable)
   - [ ] No breaking changes introduced
   - [ ] Follows project architecture patterns

   ---
   *This PR was created automatically. Please review and test before merging.*
   ```

3. **PR erstellen mit GitHub CLI:**
   **WICHTIG:** Verwende `run_terminal_cmd` f√ºr alle `gh`-Befehle!

   Zuerst PR-Body in Datei schreiben (verwende `write` Tool):
   - Erstelle `/tmp/pr-body.txt` mit dem PR-Body-Inhalt

   Dann PR erstellen (verwende `run_terminal_cmd`):
   ```
   gh pr create --title "fix: Resolve issue #{issue_num} - {issue_title}" --body-file /tmp/pr-body.txt --base {base_branch} --head {branch_name} --label "ai-generated" --label "automated"
   ```

   **WICHTIG:** Schreibe den PR-Body zuerst in eine Datei (`/tmp/pr-body.txt`), um Sonderzeichen-Probleme zu vermeiden!

4. **Issue verlinken:**
   Nach erfolgreicher PR-Erstellung f√ºge einen Kommentar zum Issue hinzu (verwende `run_terminal_cmd`):
   ```
   gh issue comment {issue_num} --body "ü§ñ AI has created a fix for this issue: PR #<PR_NUMBER>"
   ```

   Ersetze `<PR_NUMBER>` mit der tats√§chlichen PR-Nummer aus dem `gh pr create` Output.

5. **Labels pr√ºfen:**
   Falls die Labels "ai-generated" oder "automated" nicht existieren, erstelle sie nicht - der Workflow k√ºmmert sich darum.

## Git-Konfiguration:

Git ist bereits konfiguriert:
- User: github-actions[bot]
- Email: github-actions[bot]@users.noreply.github.com
- Branch: {branch_name}
- Remote: origin (bereits konfiguriert)

## Projektkontext:

Das Projekt verwendet:
- **Clean Architecture** mit 4 Schichten: Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Framework
- **Result-Pattern** statt Exceptions (siehe ADR-0001)
- **SOLID-Prinzipien** durchg√§ngig
- **Port-Adapter-Pattern** f√ºr Foundry VTT Version-Kompatibilit√§t
- **Dependency Inversion Principle (DIP)**: Abh√§ngigkeiten nur zu Interfaces

## Code-Qualit√§t:

- Halte dich an die bestehenden Architektur-Patterns
- Verwende das Result-Pattern f√ºr Fehlerbehandlung
- Respektiere die Schichttrennung (Clean Architecture)
- F√ºge Tests hinzu, wenn m√∂glich

## ‚ö†Ô∏è KRITISCH - PR-ZUSAMMENFASSUNG ERSTELLEN (OBLIGATORISCH):

**DU MUSST DIESE DATEI ERSTELLEN:** `/tmp/agent-summary.md`

**WARUM:** Diese Datei wird automatisch als PR-Body verwendet. OHNE diese Datei wird der PR mit einem generischen Standard-Text erstellt, der keine Informationen √ºber das Problem oder die L√∂sung enth√§lt!

**WANN:** Erstelle diese Datei NACH den Code-√Ñnderungen, aber VOR dem Commit!

**WIE:** Verwende das `write` Tool um die Datei `/tmp/agent-summary.md` zu erstellen!

**INHALT - MUSS DIESE STRUKTUR HABEN:**

```markdown
## Problem

[Kurze Beschreibung des Problems aus dem Issue]

## L√∂sung

[Erkl√§re wie du das Problem gel√∂st hast - welche √Ñnderungen wurden gemacht?]

## Ge√§nderte Dateien

- `pfad/zur/datei.ts`: [Was wurde ge√§ndert und warum]
- `pfad/zur/datei2.ts`: [Was wurde ge√§ndert und warum]

## Technische Details

[Architektur-Entscheidungen, Pattern-Verwendung, z.B. Result-Pattern, Clean Architecture, etc.]

## Review-Hinweise

[Besondere √úberlegungen f√ºr den Reviewer, z.B. Breaking Changes, Tests, etc.]
```

**KRITISCH:**
- Diese Datei wird als PR-Body verwendet!
- OHNE diese Datei wird der PR mit einer generischen Beschreibung erstellt!
- Verwende das `write` Tool um `/tmp/agent-summary.md` zu erstellen!
- Schreibe die Zusammenfassung NACH den Code-√Ñnderungen, aber VOR dem Commit!

## Zusammenfassung der Schritte - MUSS IN DIESER REIHENFOLGE AUSGEF√úHRT WERDEN:

1. ‚úÖ Code-√Ñnderungen implementieren (verwende `search_replace` oder `write` Tool)
2. ‚úÖ **KRITISCH:** Erstelle `/tmp/agent-summary.md` mit dem `write` Tool (siehe Format unten) - DIESE DATEI WIRD ALS PR-BODY VERWENDET!
3. ‚úÖ Commits erstellen (verwende `run_terminal_cmd` mit `git add` und `git commit`)
4. ‚úÖ √Ñnderungen pushen (verwende `run_terminal_cmd` mit `git push origin {branch_name}`)
5. ‚úÖ PR erstellen (verwende `run_terminal_cmd` mit `gh pr create` - inkl. Labels und Base-Branch: {base_branch})
6. ‚úÖ Issue kommentieren (verwende `run_terminal_cmd` mit `gh issue comment`)

**WICHTIG:**
- F√ºr ALLE Terminal-Befehle (git, gh) musst du das `run_terminal_cmd` Tool verwenden!
- **SCHRITT 2 IST OBLIGATORISCH** - ohne `/tmp/agent-summary.md` wird der PR mit generischem Text erstellt!

**Beginne jetzt mit der Analyse und Implementierung!**
"""

    output_file = os.environ.get('OUTPUT_FILE', '/tmp/fix-prompt.md')

    try:
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(prompt)
        print(f"‚úÖ Prompt created for issue #{issue_num} -> {output_file}", file=sys.stderr)
        sys.exit(0)
    except Exception as e:
        print(f"‚ùå Error writing prompt file: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    create_fix_prompt()

