name: "1. Select Issue"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Specific issue number (leave empty for all open issues)"
        required: false
        type: string
      label_filter:
        description: "Only process issues with this label (leave empty for all)"
        required: false
        type: string
      max_issues:
        description: "Maximum number of issues to process"
        required: false
        type: string
        default: "5"

jobs:
  select-issue:
    name: Select Issue to Fix
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    outputs:
      issue_number: ${{ steps.select.outputs.issue_number }}
      issue_title: ${{ steps.select.outputs.issue_title }}
      issue_body: ${{ steps.select.outputs.issue_body }}
      issue_url: ${{ steps.select.outputs.issue_url }}
      branch_name: ${{ steps.select.outputs.branch_name }}
      count: ${{ steps.select.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… GitHub CLI ready (using GH_TOKEN)"

      - name: Select Issue
        id: select
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Selecting issue to fix..."

          # Funktion zum PrÃ¼fen ob bereits ein offener PR fÃ¼r ein Issue existiert
          check_existing_pr() {
            local issue_num=$1
            echo "Checking for existing open PR for issue #$issue_num..."

            # Methode 1: PrÃ¼fe offene PRs die das Issue in der Beschreibung erwÃ¤hnen
            PR_WITH_ISSUE=$(gh pr list --state open --search "issue #$issue_num" --json number,title,state --jq '.[0].number' 2>/dev/null || echo "")
            if [ -n "$PR_WITH_ISSUE" ]; then
              echo "  âœ… Found open PR #$PR_WITH_ISSUE mentioning issue #$issue_num"
              return 0
            fi

            # Methode 2: PrÃ¼fe offene PRs mit Branch-Namen die das Issue enthalten
            PR_BRANCH=$(gh pr list --state open --json headRefName,number --jq ".[] | select(.headRefName | contains(\"issue-$issue_num\")) | .number" 2>/dev/null | head -1 || echo "")
            if [ -n "$PR_BRANCH" ]; then
              echo "  âœ… Found open PR #$PR_BRANCH with branch containing issue #$issue_num"
              return 0
            fi

            # Methode 3: PrÃ¼fe Issue-Kommentare nach PR-Links
            PR_IN_COMMENTS=$(gh issue view "$issue_num" --json comments --jq '.comments[] | select(.body | test("PR #|pull/[0-9]+|/pull/[0-9]+")) | .body' 2>/dev/null | grep -oP 'PR #\K[0-9]+|pull/\K[0-9]+|/pull/\K[0-9]+' | head -1 || echo "")
            if [ -n "$PR_IN_COMMENTS" ]; then
              PR_STATE=$(gh pr view "$PR_IN_COMMENTS" --json state --jq '.state' 2>/dev/null || echo "")
              if [ "$PR_STATE" = "OPEN" ]; then
                echo "  âœ… Found open PR #$PR_IN_COMMENTS mentioned in issue comments"
                return 0
              fi
            fi

            echo "  â„¹ï¸  No existing open PR found for issue #$issue_num"
            return 1
          }

          # PrÃ¼fe ob spezifische Issue-Nummer angegeben wurde
          if [ -n "${{ github.event.inputs.issue_number }}" ]; then
            ISSUE_NUM="${{ github.event.inputs.issue_number }}"
            echo "Processing specific issue: #$ISSUE_NUM"

            # PrÃ¼fe ob bereits ein PR existiert
            if check_existing_pr "$ISSUE_NUM"; then
              echo "âš ï¸ Issue #$ISSUE_NUM already has an associated PR, skipping"
              echo "count=0" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Lade Issue-Details
            gh issue view "$ISSUE_NUM" --json number,title,body,labels,state,url > /tmp/issue.json || {
              echo "âŒ Issue #$ISSUE_NUM not found or not accessible"
              exit 1
            }

            ISSUE_TITLE=$(cat /tmp/issue.json | jq -r '.title')
            ISSUE_BODY=$(cat /tmp/issue.json | jq -r '.body // ""')
            ISSUE_URL=$(cat /tmp/issue.json | jq -r '.url')

            echo "âœ… Selected issue #$ISSUE_NUM: $ISSUE_TITLE"
          else
            # Lade alle offenen Issues
            LABEL_FILTER="${{ github.event.inputs.label_filter }}"
            MAX_ISSUES="${{ github.event.inputs.max_issues }}"

            if [ -n "$LABEL_FILTER" ]; then
              echo "Filtering issues by label: $LABEL_FILTER"
              gh issue list --state open --label "$LABEL_FILTER" --json number,title,body,labels,state,url --limit "${MAX_ISSUES:-10}" > /tmp/all-issues.json || {
                echo "âš ï¸ No issues found with label $LABEL_FILTER"
                echo "count=0" >> $GITHUB_OUTPUT
                exit 0
              }
            else
              echo "Loading all open issues (max: ${MAX_ISSUES:-10})"
              gh issue list --state open --json number,title,body,labels,state,url --limit "${MAX_ISSUES:-10}" > /tmp/all-issues.json || {
                echo "âš ï¸ No open issues found"
                echo "count=0" >> $GITHUB_OUTPUT
                exit 0
              }
            fi

            # Filtere Issues die bereits einen PR haben
            echo "Filtering issues without existing PRs..."
            FILTERED_ISSUES="[]"
            ISSUE_COUNT=$(cat /tmp/all-issues.json | jq '. | length' 2>/dev/null || echo "0")

            if [ "$ISSUE_COUNT" -gt 0 ]; then
              while IFS= read -r issue_json; do
                ISSUE_NUM=$(echo "$issue_json" | jq -r '.number')
                if ! check_existing_pr "$ISSUE_NUM"; then
                  FILTERED_ISSUES=$(echo "$FILTERED_ISSUES" | jq ". + [$issue_json]")
                fi
              done < <(cat /tmp/all-issues.json | jq -c '.[]')
            fi

            FILTERED_COUNT=$(echo "$FILTERED_ISSUES" | jq '. | length' 2>/dev/null || echo "0")

            if [ "$FILTERED_COUNT" -eq 0 ]; then
              echo "âš ï¸ No issues found without existing PRs"
              echo "count=0" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Nimm das erste Issue
            SELECTED_ISSUE=$(echo "$FILTERED_ISSUES" | jq '.[0]')
            ISSUE_NUM=$(echo "$SELECTED_ISSUE" | jq -r '.number')
            ISSUE_TITLE=$(echo "$SELECTED_ISSUE" | jq -r '.title')
            ISSUE_BODY=$(echo "$SELECTED_ISSUE" | jq -r '.body // ""')
            ISSUE_URL=$(echo "$SELECTED_ISSUE" | jq -r '.url')

            echo "âœ… Selected issue #$ISSUE_NUM: $ISSUE_TITLE"
            echo "   (Found $FILTERED_COUNT issues without PRs, processing first one)"
          fi

          # Erstelle Branch-Name (sanitize)
          BRANCH_NAME="fix/issue-$ISSUE_NUM-$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-50)"

          # Setze Outputs
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "issue_title<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "count=1" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Selected Issue ==="
          echo "Number: #$ISSUE_NUM"
          echo "Title: $ISSUE_TITLE"
          echo "Branch: $BRANCH_NAME"
          echo "URL: $ISSUE_URL"

