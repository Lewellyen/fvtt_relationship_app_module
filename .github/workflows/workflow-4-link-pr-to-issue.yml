name: "4. Link PR to Issue"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number"
        required: true
        type: string
      pr_number:
        description: "PR number"
        required: true
        type: string
      pr_url:
        description: "PR URL"
        required: true
        type: string
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string
      pr_number:
        required: true
        type: string
      pr_url:
        required: true
        type: string

jobs:
  link-pr-to-issue:
    name: Link PR to Issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚úÖ GitHub CLI ready (using GH_TOKEN)"

      - name: Comment on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ inputs.issue_number || github.event.inputs.issue_number }}"
          PR_NUM="${{ inputs.pr_number || github.event.inputs.pr_number }}"
          PR_URL="${{ inputs.pr_url || github.event.inputs.pr_url }}"

          echo "Linking PR #$PR_NUM to issue #$ISSUE_NUM..."

          # Erstelle Kommentar auf Issue
          COMMENT_BODY="ü§ñ AI has created a fix for this issue: $PR_URL

          **Pull Request:** #$PR_NUM
          **Status:** Ready for review

          This PR was automatically created by the AI Issue Fix workflow."

          gh issue comment "$ISSUE_NUM" --body "$COMMENT_BODY" || {
            echo "‚ö†Ô∏è Failed to comment on issue (might already be commented)"
          }

          echo "‚úÖ PR linked to issue #$ISSUE_NUM"

      - name: Summary
        run: |
          echo "=== Link Summary ==="
          echo "Issue: #${{ inputs.issue_number || github.event.inputs.issue_number }}"
          echo "PR: #${{ inputs.pr_number || github.event.inputs.pr_number }}"
          echo "PR URL: ${{ inputs.pr_url || github.event.inputs.pr_url }}"
          echo ""
          echo "‚úÖ PR successfully linked to issue!"

