name: Security Audit

on:
  # Run security audit on pull requests
  pull_request:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'package-lock.json'
  
  # Run security audit on pushes to main/develop
  push:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'package-lock.json'
  
  # Weekly scheduled audit (Mondays at 9:00 UTC)
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  npm-audit:
    name: npm audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (production dependencies)
        run: npm audit --omit=dev --audit-level=moderate
        continue-on-error: true
        id: audit-prod

      - name: Run npm audit (development dependencies)
        run: npm audit --only=dev --audit-level=high
        continue-on-error: true
        id: audit-dev

      - name: Check audit results
        if: steps.audit-prod.outcome == 'failure' || steps.audit-dev.outcome == 'failure'
        run: |
          echo "::warning::Security vulnerabilities detected!"
          echo "Production dependencies: ${{ steps.audit-prod.outcome }}"
          echo "Development dependencies: ${{ steps.audit-dev.outcome }}"
          
          # Fail the workflow if production dependencies have issues
          if [ "${{ steps.audit-prod.outcome }}" == "failure" ]; then
            echo "::error::Production dependencies have moderate or higher vulnerabilities!"
            exit 1
          fi
          
          # Only warn for dev dependencies (don't fail workflow)
          if [ "${{ steps.audit-dev.outcome }}" == "failure" ]; then
            echo "::warning::Development dependencies have high or higher vulnerabilities (non-blocking)"
          fi

      - name: Generate audit report (on failure)
        if: failure()
        run: |
          npm audit --json > audit-report.json || true
          npm audit > audit-report.txt || true

      - name: Upload audit report
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: npm-audit-report
          path: |
            audit-report.json
            audit-report.txt
          retention-days: 30

