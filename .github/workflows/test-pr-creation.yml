name: Test PR Creation (with Mock Branch)

on:
  workflow_dispatch:
    inputs:
      test_branch_name:
        description: "Test branch name (default: test/pr-creation-test)"
        required: false
        type: string
        default: "test/pr-creation-test"

jobs:
  create-test-branch:
    name: Create Test Branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
      branch_url: ${{ steps.create-branch.outputs.branch_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Test Branch
        id: create-branch
        run: |
          TEST_BRANCH="${{ github.event.inputs.test_branch_name || 'test/pr-creation-test' }}"
          BASE_BRANCH="main"

          echo "Creating test branch: $TEST_BRANCH"

          # Checkout base branch
          git checkout "$BASE_BRANCH"
          git pull origin "$BASE_BRANCH"

          # Erstelle neuen Branch
          git checkout -b "$TEST_BRANCH" || {
            echo "⚠️ Branch might already exist, checking out..."
            git checkout "$TEST_BRANCH"
            git pull origin "$TEST_BRANCH" || true
          }

          # Erstelle Mock-Änderung (kleine Datei)
          MOCK_FILE=".github/test-mock-change.txt"
          echo "Test change created at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > "$MOCK_FILE"
          echo "Branch: $TEST_BRANCH" >> "$MOCK_FILE"
          echo "Workflow: ${{ github.workflow }}" >> "$MOCK_FILE"
          echo "Run ID: ${{ github.run_id }}" >> "$MOCK_FILE"

          # Stage und Commit
          git add "$MOCK_FILE"
          git commit -m "test: mock change for PR creation test" || {
            echo "⚠️ No changes to commit (file might already exist with same content)"
          }

          # Push Branch
          git push -u origin "$TEST_BRANCH" || {
            echo "⚠️ Push failed or branch already up-to-date"
            # Prüfe ob Branch bereits existiert
            if git ls-remote --heads origin "$TEST_BRANCH" | grep -q "$TEST_BRANCH"; then
              echo "✅ Branch already exists on remote"
            else
              echo "❌ Failed to push branch"
              exit 1
            fi
          }

          echo "✅ Test branch created and pushed: $TEST_BRANCH"
          echo "branch_name=$TEST_BRANCH" >> $GITHUB_OUTPUT
          echo "branch_url=https://github.com/${{ github.repository }}/tree/$TEST_BRANCH" >> $GITHUB_OUTPUT

      - name: Branch Summary
        run: |
          echo "=== Test Branch Created ==="
          echo "Branch: ${{ steps.create-branch.outputs.branch_name }}"
          echo "URL: ${{ steps.create-branch.outputs.branch_url }}"

  create-pr:
    name: Create Pull Request
    needs: create-test-branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "✅ GitHub CLI ready (using GH_TOKEN)"

      - name: Wait for branch to be available
        run: |
          BRANCH_NAME="${{ needs.create-test-branch.outputs.branch_name }}"
          echo "Waiting for branch to be available: $BRANCH_NAME"

          # Warte bis Branch auf Remote verfügbar ist
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "✅ Branch is available on remote"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "⏳ Waiting for branch... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 2
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "❌ Branch not available after $MAX_RETRIES retries"
            exit 1
          fi

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="main"
          BRANCH_NAME="${{ needs.create-test-branch.outputs.branch_name }}"
          PR_TITLE="Test: PR Creation from Workflow"
          PR_BODY="This is a test PR created automatically by GitHub Actions.

          **Test Details:**
          - Branch: \`$BRANCH_NAME\`
          - Base: \`$BASE_BRANCH\`
          - Workflow: \`${{ github.workflow }}\`
          - Run ID: \`${{ github.run_id }}\`
          - Created at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          This PR was created to test the PR creation workflow."

          echo "Creating PR..."
          echo "  Base: $BASE_BRANCH"
          echo "  Head: $BRANCH_NAME"
          echo "  Title: $PR_TITLE"

          # Prüfe ob PR bereits existiert
          EXISTING_PR=$(gh pr list --base "$BASE_BRANCH" --head "$BRANCH_NAME" --state all --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "⚠️ PR already exists: #$EXISTING_PR"
            PR_URL="https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "✅ Using existing PR: $PR_URL"
          else
            # Erstelle PR mit GitHub CLI
            # Versuche Label hinzuzufügen (falls es existiert)
            if gh label list --json name --jq '.[].name' | grep -q "^test$"; then
              PR_URL=$(gh pr create \
                --base "$BASE_BRANCH" \
                --head "$BRANCH_NAME" \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                --label "test" \
                --draft || echo "")
            else
              echo "⚠️ Label 'test' does not exist, creating PR without label"
              PR_URL=$(gh pr create \
                --base "$BASE_BRANCH" \
                --head "$BRANCH_NAME" \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                --draft || echo "")
            fi

            if [ -n "$PR_URL" ]; then
              echo "✅ PR created successfully: $PR_URL"
              echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

              # Extrahiere PR-Nummer
              PR_NUMBER=$(echo "$PR_URL" | grep -oP 'pull/\K[0-9]+' || echo "")
              if [ -n "$PR_NUMBER" ]; then
                echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                echo "PR Number: #$PR_NUMBER"
              fi
            else
              echo "❌ Failed to create PR"
              exit 1
            fi
          fi

      - name: PR Summary
        run: |
          echo "=== PR Creation Summary ==="
          echo "PR URL: ${{ steps.create-pr.outputs.pr_url }}"
          echo "PR Number: ${{ steps.create-pr.outputs.pr_number }}"
          echo "Branch: ${{ needs.create-test-branch.outputs.branch_name }}"
          echo ""
          echo "✅ Test completed successfully!"

