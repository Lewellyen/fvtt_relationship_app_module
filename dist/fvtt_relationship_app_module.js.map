{"version":3,"file":"fvtt_relationship_app_module.js","sources":["../src/infrastructure/shared/constants.ts","../src/infrastructure/shared/utils/result.ts","../src/infrastructure/di/tokenutilities.ts","../src/infrastructure/shared/tokens/core.tokens.ts","../src/infrastructure/shared/tokens/observability.tokens.ts","../src/infrastructure/shared/tokens/i18n.tokens.ts","../src/infrastructure/shared/tokens/notifications.tokens.ts","../src/infrastructure/shared/tokens/infrastructure.tokens.ts","../src/infrastructure/shared/tokens/foundry.tokens.ts","../src/infrastructure/shared/tokens/event.tokens.ts","../src/infrastructure/shared/tokens/ports.tokens.ts","../src/infrastructure/shared/tokens/collection-tokens.ts","../src/infrastructure/shared/tokens/repository-tokens.ts","../src/infrastructure/di/types/utilities/api-safe-token.ts","../src/infrastructure/di/types/core/servicelifecycle.ts","../src/infrastructure/di/types/core/serviceregistration.ts","../src/infrastructure/di/registry/TypeSafeRegistrationMap.ts","../src/infrastructure/di/types/utilities/runtime-safe-cast.ts","../src/infrastructure/di/registry/ServiceRegistry.ts","../src/infrastructure/di/validation/ContainerValidator.ts","../src/infrastructure/di/cache/InstanceCache.ts","../src/infrastructure/di/resolution/ServiceResolver.ts","../src/infrastructure/di/scope/ScopeManager.ts","../src/infrastructure/shared/utils/promise-timeout.ts","../src/framework/config/environment.ts","../src/infrastructure/observability/performance-tracker-impl.ts","../src/infrastructure/observability/bootstrap-performance-tracker.ts","../src/application/services/RuntimeConfigService.ts","../src/application/services/runtime-config-factory.ts","../src/infrastructure/di/container.ts","../src/application/health/ContainerHealthCheck.ts","../src/application/health/MetricsHealthCheck.ts","../src/infrastructure/observability/metrics-collector.ts","../src/infrastructure/observability/metrics-persistence/persistent-metrics-collector.ts","../src/infrastructure/observability/metrics-persistence/local-storage-metrics-storage.ts","../src/infrastructure/logging/ConsoleLoggerService.ts","../src/infrastructure/shared/utils/trace.ts","../src/infrastructure/observability/trace/TraceContext.ts","../src/application/services/ModuleHealthService.ts","../src/infrastructure/shared/utils/format-deprecation-info.ts","../src/infrastructure/di/types/utilities/deprecated-token.ts","../src/framework/core/api/readonly-wrapper.ts","../src/framework/core/api/public-api-wrappers.ts","../src/framework/core/api/api-token-config.ts","../src/framework/core/api/module-api-initializer.ts","../src/application/health/HealthCheckRegistry.ts","../node_modules/valibot/dist/index.js","../src/infrastructure/adapters/foundry/validation/setting-schemas.ts","../src/framework/core/bootstrap-init-hook.ts","../src/framework/core/bootstrap-ready-hook.ts","../src/framework/config/modules/core-services.config.ts","../src/infrastructure/adapters/foundry/versioning/port-selection-events.ts","../src/infrastructure/observability/observability-registry.ts","../src/framework/config/modules/observability.config.ts","../src/infrastructure/adapters/foundry/versioning/versiondetector.ts","../src/infrastructure/adapters/foundry/errors/FoundryErrors.ts","../src/infrastructure/adapters/foundry/versioning/portselector.ts","../src/infrastructure/adapters/foundry/versioning/portregistry.ts","../src/infrastructure/adapters/foundry/validation/schemas.ts","../src/infrastructure/adapters/foundry/validation/input-validators.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13GamePort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13HooksPort.ts","../src/infrastructure/shared/utils/type-guards.ts","../src/infrastructure/adapters/foundry/runtime-casts.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13DocumentPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13UIPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13SettingsPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13I18nPort.ts","../src/infrastructure/adapters/foundry/ports/v13/port-registration.ts","../src/infrastructure/adapters/foundry/adapters/foundry-ui-adapter.ts","../src/framework/config/modules/port-infrastructure.config.ts","../src/infrastructure/adapters/foundry/services/FoundryServiceBase.ts","../src/infrastructure/adapters/foundry/services/FoundryGamePort.ts","../src/infrastructure/adapters/foundry/services/FoundryHooksPort.ts","../src/infrastructure/adapters/foundry/services/FoundryDocumentPort.ts","../src/infrastructure/adapters/foundry/services/FoundryUIPort.ts","../src/infrastructure/adapters/foundry/services/FoundrySettingsPort.ts","../src/infrastructure/adapters/foundry/facades/foundry-journal-facade.ts","../src/infrastructure/adapters/foundry/domain-adapters/journal-visibility-adapter.ts","../src/infrastructure/cache/cache.interface.ts","../src/application/services/JournalVisibilityService.ts","../src/infrastructure/adapters/foundry/services/FoundryLibWrapperService.ts","../src/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService.ts","../src/framework/config/modules/foundry-services.config.ts","../src/infrastructure/performance/PerformanceTrackingService.ts","../src/infrastructure/retry/RetryService.ts","../src/framework/config/modules/utility-services.config.ts","../src/infrastructure/cache/CacheService.ts","../src/framework/config/modules/cache-services.config.ts","../src/infrastructure/adapters/foundry/services/FoundryI18nPort.ts","../src/infrastructure/i18n/LocalI18nService.ts","../src/infrastructure/i18n/I18nFacadeService.ts","../src/infrastructure/i18n/AbstractTranslationHandler.ts","../src/infrastructure/i18n/FoundryTranslationHandler.ts","../src/infrastructure/i18n/LocalTranslationHandler.ts","../src/infrastructure/i18n/FallbackTranslationHandler.ts","../src/infrastructure/i18n/TranslationHandlerChain.ts","../src/framework/config/modules/i18n-services.config.ts","../src/infrastructure/notifications/NotificationCenter.ts","../src/infrastructure/notifications/channels/ConsoleChannel.ts","../src/infrastructure/notifications/channels/UIChannel.ts","../src/framework/config/modules/notifications.config.ts","../src/infrastructure/shared/utils/validate-log-level.ts","../src/application/settings/log-level-setting.ts","../src/application/settings/cache-enabled-setting.ts","../src/application/settings/cache-default-ttl-setting.ts","../src/application/settings/cache-max-entries-setting.ts","../src/application/settings/performance-tracking-setting.ts","../src/application/settings/performance-sampling-setting.ts","../src/application/settings/metrics-persistence-enabled-setting.ts","../src/application/settings/metrics-persistence-key-setting.ts","../src/application/services/ModuleSettingsRegistrar.ts","../src/framework/config/modules/registrars.config.ts","../src/infrastructure/adapters/foundry/event-adapters/foundry-journal-event-adapter.ts","../src/application/use-cases/invalidate-journal-cache-on-change.use-case.ts","../src/application/use-cases/process-journal-directory-on-render.use-case.ts","../src/application/use-cases/trigger-journal-directory-rerender.use-case.ts","../src/application/use-cases/register-context-menu.use-case.ts","../src/application/handlers/hide-journal-context-menu-handler.ts","../src/infrastructure/shared/utils/dispose-hooks.ts","../src/application/services/ModuleEventRegistrar.ts","../src/framework/config/modules/event-ports.config.ts","../src/infrastructure/adapters/foundry/collection-adapters/foundry-journal-collection-adapter.ts","../src/infrastructure/adapters/foundry/repository-adapters/foundry-journal-repository-adapter.ts","../src/framework/config/modules/entity-ports.config.ts","../src/infrastructure/adapters/foundry/settings-adapters/foundry-settings-adapter.ts","../src/framework/config/modules/settings-ports.config.ts","../src/framework/config/dependencyconfig.ts","../src/infrastructure/logging/BootstrapLogger.ts","../src/framework/core/composition-root.ts","../src/framework/core/bootstrap-error-handler.ts","../src/framework/core/init-solid.ts"],"sourcesContent":["/**\r\n * Module-wide constants for the Foundry VTT Relationship App Module.\r\n * Contains metadata and configuration values used throughout the application.\r\n *\r\n * @constant\r\n *\r\n * @note ENCODING REQUIREMENT\r\n * All source files in this project MUST be saved as UTF-8 without BOM.\r\n * This ensures proper display of German text (ä, ö, ü, ß) and prevents mojibake.\r\n * Configure your editor to use UTF-8 encoding for all .ts, .js, and .svelte files.\r\n */\r\n/* v8 ignore file -- Reine Konstanten-Definition, keine ausführbare Logik -- @preserve */\r\n/**\r\n * Throttle window for hook callbacks in milliseconds.\r\n * Prevents excessive processing during rapid hook fires.\r\n *\r\n * Set to 150ms to allow multiple journal entries to be created\r\n * before processing, while still preventing excessive calls.\r\n */\r\nexport const HOOK_THROTTLE_WINDOW_MS = 150;\r\n\r\n/**\r\n * Validation constraints for input data.\r\n */\r\nexport const VALIDATION_CONSTRAINTS = {\r\n  /** Maximum length for IDs and keys */\r\n  MAX_ID_LENGTH: 100,\r\n  /** Maximum length for names */\r\n  MAX_NAME_LENGTH: 100,\r\n  /** Maximum length for flag keys */\r\n  MAX_FLAG_KEY_LENGTH: 100,\r\n} as const;\r\n\r\n/**\r\n * Metrics collection configuration.\r\n */\r\nexport const METRICS_CONFIG = {\r\n  /** Size of circular buffer for resolution times */\r\n  RESOLUTION_TIMES_BUFFER_SIZE: 100,\r\n} as const;\r\n\r\nexport const MODULE_CONSTANTS = {\r\n  MODULE: {\r\n    ID: \"fvtt_relationship_app_module\",\r\n    NAME: \"Beziehungsnetzwerke für Foundry\",\r\n    AUTHOR: \"Andreas Rothe\",\r\n    AUTHOR_EMAIL: \"forenadmin.tir@gmail.com\",\r\n    AUTHOR_DISCORD: \"lewellyen\",\r\n  },\r\n  LOG_PREFIX: \"Relationship App |\",\r\n  FLAGS: {\r\n    HIDDEN: \"hidden\",\r\n  },\r\n  HOOKS: {\r\n    RENDER_JOURNAL_DIRECTORY: \"renderJournalDirectory\",\r\n    INIT: \"init\",\r\n    READY: \"ready\",\r\n    CREATE_JOURNAL_ENTRY: \"createJournalEntry\",\r\n    UPDATE_JOURNAL_ENTRY: \"updateJournalEntry\",\r\n    DELETE_JOURNAL_ENTRY: \"deleteJournalEntry\",\r\n  },\r\n  SETTINGS: {\r\n    LOG_LEVEL: \"logLevel\",\r\n    CACHE_ENABLED: \"cacheEnabled\",\r\n    CACHE_TTL_MS: \"cacheTtlMs\",\r\n    CACHE_MAX_ENTRIES: \"cacheMaxEntries\",\r\n    PERFORMANCE_TRACKING_ENABLED: \"performanceTrackingEnabled\",\r\n    PERFORMANCE_SAMPLING_RATE: \"performanceSamplingRate\",\r\n    METRICS_PERSISTENCE_ENABLED: \"metricsPersistenceEnabled\",\r\n    METRICS_PERSISTENCE_KEY: \"metricsPersistenceKey\",\r\n  },\r\n  API: {\r\n    /**\r\n     * Public API version for external module consumption.\r\n     * Follows semantic versioning: MAJOR.MINOR.PATCH\r\n     *\r\n     * MAJOR: Breaking changes to public API\r\n     * MINOR: New features, backwards-compatible\r\n     * PATCH: Bug fixes, backwards-compatible\r\n     */\r\n    VERSION: \"1.0.0\",\r\n  },\r\n  DEFAULTS: {\r\n    UNKNOWN_NAME: \"Unknown\",\r\n    NO_VERSION_SELECTED: -1,\r\n    CACHE_NOT_INITIALIZED: -1,\r\n    CACHE_TTL_MS: 5000,\r\n  },\r\n} as const;\r\n\r\n// Deep freeze constants for runtime immutability\r\nObject.freeze(MODULE_CONSTANTS);\r\nObject.freeze(MODULE_CONSTANTS.MODULE);\r\nObject.freeze(MODULE_CONSTANTS.API);\r\nObject.freeze(MODULE_CONSTANTS.FLAGS);\r\nObject.freeze(MODULE_CONSTANTS.HOOKS);\r\nObject.freeze(MODULE_CONSTANTS.SETTINGS);\r\nObject.freeze(MODULE_CONSTANTS.DEFAULTS);\r\nObject.freeze(VALIDATION_CONSTRAINTS);\r\nObject.freeze(METRICS_CONFIG);\r\n","/**\r\n * Utility functions for working with the Result pattern.\r\n * Provides functional error handling with type safety.\r\n *\r\n * This module contains only runtime functions - types are imported from \"@/domain/types/result\"\r\n */\r\nimport type { Ok, Err, Result, AsyncResult } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Creates a successful Result with a value.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @param value - The successful value to wrap\r\n * @returns A Result indicating success with the provided value\r\n *\r\n * @example\r\n * ```typescript\r\n * const success = ok(42);\r\n * // { ok: true, value: 42 }\r\n * ```\r\n */\r\nexport function ok<SuccessType>(value: SuccessType): Ok<SuccessType> {\r\n  return { ok: true, value };\r\n}\r\n\r\n/**\r\n * Creates an error Result with an error value.\r\n *\r\n * @template ErrorType - The type of the error value\r\n * @param error - The error to wrap\r\n * @returns A Result indicating failure with the provided error\r\n *\r\n * @example\r\n * ```typescript\r\n * const failure = err(\"Not found\");\r\n * // { ok: false, error: \"Not found\" }\r\n * ```\r\n */\r\nexport function err<ErrorType>(error: ErrorType): Err<ErrorType> {\r\n  return { ok: false, error };\r\n}\r\n\r\n/**\r\n * Type guard to check if a Result is successful.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @template ErrorType - The type of the error value\r\n * @param result - The Result to check\r\n * @returns True if the Result is successful, narrowing the type to Ok<SuccessType>\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = someOperation();\r\n * if (isOk(result)) {\r\n *   console.log(result.value); // Type-safe access to value\r\n * }\r\n * ```\r\n */\r\nexport function isOk<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>\r\n): result is Ok<SuccessType> {\r\n  return result.ok;\r\n}\r\n\r\n/**\r\n * Type guard to check if a Result is an error.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @template ErrorType - The type of the error value\r\n * @param result - The Result to check\r\n * @returns True if the Result is an error, narrowing the type to Err<ErrorType>\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = someOperation();\r\n * if (isErr(result)) {\r\n *   console.error(result.error); // Type-safe access to error\r\n * }\r\n * ```\r\n */\r\nexport function isErr<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>\r\n): result is Err<ErrorType> {\r\n  return !result.ok;\r\n}\r\n\r\n/**\r\n * Transforms the value of a successful Result.\r\n * If the Result is an error, it is returned unchanged.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template NewSuccessType - The new success type after transformation\r\n * @template ErrorType - The error type\r\n * @param result - The Result to transform\r\n * @param transform - Function to transform the success value\r\n * @returns A new Result with the transformed value, or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(5);\r\n * const doubled = map(num, x => x * 2);\r\n * // { ok: true, value: 10 }\r\n * ```\r\n */\r\nexport function map<SuccessType, NewSuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  transform: (value: SuccessType) => NewSuccessType\r\n): Result<NewSuccessType, ErrorType> {\r\n  return result.ok ? ok(transform(result.value)) : result;\r\n}\r\n\r\n/**\r\n * Transforms the error of a failed Result.\r\n * If the Result is successful, it is returned unchanged.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The current error type\r\n * @template NewErrorType - The new error type after transformation\r\n * @param result - The Result to transform\r\n * @param transform - Function to transform the error value\r\n * @returns A new Result with the transformed error, or the original success\r\n *\r\n * @example\r\n * ```typescript\r\n * const failure = err(\"404\");\r\n * const formatted = mapError(failure, msg => `Error: ${msg}`);\r\n * // { ok: false, error: \"Error: 404\" }\r\n * ```\r\n */\r\nexport function mapError<SuccessType, ErrorType, NewErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  transform: (error: ErrorType) => NewErrorType\r\n): Result<SuccessType, NewErrorType> {\r\n  return result.ok ? result : err(transform(result.error));\r\n}\r\n\r\n/**\r\n * Chains Result operations. If the Result is successful, applies the function to the value.\r\n * Otherwise, returns the error unchanged. This is also known as \"flatMap\" or \"bind\".\r\n *\r\n * @template SuccessType - The current success type\r\n * @template ErrorType - The error type\r\n * @template NextSuccessType - The next success type after chaining\r\n * @param result - The Result to chain\r\n * @param next - Function that returns a new Result from the success value\r\n * @returns The next Result, or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const parseNumber = (str: string): Result<number, string> => {\r\n *   const num = parseInt(str);\r\n *   return isNaN(num) ? err(\"Invalid number\") : ok(num);\r\n * };\r\n *\r\n * const doubled = ok(\"5\").pipe(parseNumber).pipe(x => ok(x * 2));\r\n * ```\r\n */\r\nexport function andThen<SuccessType, ErrorType, NextSuccessType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  next: (value: SuccessType) => Result<NextSuccessType, ErrorType>\r\n): Result<NextSuccessType, ErrorType> {\r\n  return result.ok ? next(result.value) : result;\r\n}\r\n\r\n/**\r\n * Unwraps a successful Result or returns a fallback value if it's an error.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param result - The Result to unwrap\r\n * @param fallbackValue - The value to return if the Result is an error\r\n * @returns The success value, or the fallback value\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(42);\r\n * unwrapOr(num, 0); // 42\r\n *\r\n * const err = err(\"Failed\");\r\n * unwrapOr(err, 0); // 0\r\n * ```\r\n */\r\nexport function unwrapOr<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  fallbackValue: SuccessType\r\n): SuccessType {\r\n  return result.ok ? result.value : fallbackValue;\r\n}\r\n\r\n/**\r\n * Unwraps a successful Result or computes a fallback value from the error.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param result - The Result to unwrap\r\n * @param getFallback - Function that computes a fallback from the error\r\n * @returns The success value, or the computed fallback value\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = err(\"Not found\");\r\n * unwrapOrElse(num, error => 0); // 0\r\n * ```\r\n */\r\nexport function unwrapOrElse<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  getFallback: (error: ErrorType) => SuccessType\r\n): SuccessType {\r\n  return result.ok ? result.value : getFallback(result.error);\r\n}\r\n\r\n/**\r\n * Unwraps a successful Result or throws an error if it's a failure.\r\n * Use with caution - this defeats the purpose of using Result pattern.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @template ThrownError - The type of error to throw (must extend Error)\r\n * @param result - The Result to unwrap\r\n * @param toError - Optional function to convert the error to a thrown Error\r\n * @returns The success value\r\n * @throws ThrownError if the Result is an error\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(42);\r\n * getOrThrow(num); // 42\r\n *\r\n * const failure = err(\"Not found\");\r\n * getOrThrow(failure); // throws Error(\"Not found\")\r\n * ```\r\n */\r\nexport function getOrThrow<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  toError?: (error: ErrorType) => Error\r\n): SuccessType {\r\n  if (result.ok) return result.value;\r\n  const e = toError ? toError(result.error) : new Error(String(result.error));\r\n  throw e;\r\n}\r\n\r\n/**\r\n * Executes a function and wraps the result in a Result, catching any thrown errors.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param fn - The function to execute\r\n * @param mapUnknownError - Function to convert caught errors to the ErrorType\r\n * @returns A Result containing either the return value or the caught error\r\n *\r\n * @example\r\n * ```typescript\r\n * const parsed = tryCatch(\r\n *   () => JSON.parse(\"{ invalid json\"),\r\n *   (e) => `Parse error: ${e}`\r\n * );\r\n * // { ok: false, error: \"Parse error: ...\" }\r\n * ```\r\n */\r\nexport function tryCatch<SuccessType, ErrorType>(\r\n  fn: () => SuccessType,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): Result<SuccessType, ErrorType> {\r\n  try {\r\n    return ok(fn());\r\n  } catch (unknownError) {\r\n    return err(mapUnknownError(unknownError));\r\n  }\r\n}\r\n\r\n/**\r\n * Combines multiple Results into a single Result containing an array of values.\r\n * If any Result is an error, returns that error immediately (short-circuits).\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param results - Array of Results to combine\r\n * @returns A Result containing an array of values, or the first error encountered\r\n *\r\n * @example\r\n * ```typescript\r\n * const nums = [ok(1), ok(2), ok(3)];\r\n * all(nums); // { ok: true, value: [1, 2, 3] }\r\n *\r\n * const mixed = [ok(1), err(\"error\"), ok(3)];\r\n * all(mixed); // { ok: false, error: \"error\" }\r\n * ```\r\n */\r\nexport function all<SuccessType, ErrorType>(\r\n  results: Array<Result<SuccessType, ErrorType>>\r\n): Result<SuccessType[], ErrorType> {\r\n  const out: SuccessType[] = [];\r\n  for (const r of results) {\r\n    if (!r.ok) return r;\r\n    out.push(r.value);\r\n  }\r\n  return ok(out);\r\n}\r\n\r\n/**\r\n * Pattern matching for Results. Executes different handlers based on success or failure.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @template ReturnType - The return type of both handlers\r\n * @param result - The Result to match\r\n * @param handlers - Object with onOk and onErr handlers\r\n * @returns The result of the executed handler\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = ok(42);\r\n * match(result, {\r\n *   onOk: value => console.log(`Success: ${value}`),\r\n *   onErr: error => console.error(`Error: ${error}`)\r\n * });\r\n * ```\r\n */\r\nexport function match<SuccessType, ErrorType, ReturnType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  handlers: { onOk: (value: SuccessType) => ReturnType; onErr: (error: ErrorType) => ReturnType }\r\n): ReturnType {\r\n  return result.ok ? handlers.onOk(result.value) : handlers.onErr(result.error);\r\n}\r\n\r\n/**\r\n * Lifts a regular function to work with Results by wrapping it with error handling.\r\n *\r\n * @template ParamType - The function parameter type\r\n * @template SuccessType - The function return type (success type)\r\n * @template ErrorType - The error type\r\n * @param fn - The function to lift\r\n * @param mapUnknownError - Function to convert thrown errors to the ErrorType\r\n * @returns A function that returns a Result\r\n *\r\n * @example\r\n * ```typescript\r\n * const parseJSON = lift(\r\n *   (str: string) => JSON.parse(str),\r\n *   (e) => `Invalid JSON: ${e}`\r\n * );\r\n *\r\n * const result = parseJSON(\"{ invalid }\");\r\n * // { ok: false, error: \"Invalid JSON: ...\" }\r\n * ```\r\n */\r\nexport function lift<ParamType, SuccessType, ErrorType>(\r\n  fn: (param: ParamType) => SuccessType,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): (param: ParamType) => Result<SuccessType, ErrorType> {\r\n  return (param) => tryCatch(() => fn(param), mapUnknownError);\r\n}\r\n\r\n/**\r\n * Transforms the value of an async Result.\r\n * If the Result is an error, returns it unchanged.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template NewSuccessType - The new success type after transformation\r\n * @template ErrorType - The error type\r\n * @param asyncResult - The async Result to transform\r\n * @param transform - Async or sync function to transform the success value\r\n * @returns A promise that resolves to a Result with the transformed value or error\r\n *\r\n * @example\r\n * ```typescript\r\n * const asyncNum = Promise.resolve(ok(5));\r\n * const doubled = await asyncMap(asyncNum, x => x * 2);\r\n * // { ok: true, value: 10 }\r\n * ```\r\n */\r\nexport async function asyncMap<SuccessType, NewSuccessType, ErrorType>(\r\n  asyncResult: AsyncResult<SuccessType, ErrorType>,\r\n  transform: (value: SuccessType) => Promise<NewSuccessType> | NewSuccessType\r\n): AsyncResult<NewSuccessType, ErrorType> {\r\n  const result = await asyncResult;\r\n  return result.ok ? ok(await transform(result.value)) : result;\r\n}\r\n\r\n/**\r\n * Chains async Result operations.\r\n * If the Result is successful, applies the async function to the value.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template ErrorType - The error type\r\n * @template NextSuccessType - The next success type after chaining\r\n * @param asyncResult - The async Result to chain\r\n * @param next - Async function that returns a new async Result\r\n * @returns A promise that resolves to the chained Result or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const fetchAndProcess = async (url: string) => {\r\n *   const data = await fromPromise(fetch(url).then(r => r.json()), e => String(e));\r\n *   return asyncAndThen(data, processDataAsync);\r\n * };\r\n * ```\r\n */\r\nexport async function asyncAndThen<SuccessType, ErrorType, NextSuccessType>(\r\n  asyncResult: AsyncResult<SuccessType, ErrorType>,\r\n  next: (value: SuccessType) => AsyncResult<NextSuccessType, ErrorType>\r\n): AsyncResult<NextSuccessType, ErrorType> {\r\n  const result = await asyncResult;\r\n  return result.ok ? next(result.value) : result;\r\n}\r\n\r\n/**\r\n * Converts a Promise into an async Result.\r\n * Catches any rejection and converts it to an error Result.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param promise - The Promise to convert\r\n * @param mapUnknownError - Function to convert unknown errors to the ErrorType\r\n * @returns A promise that resolves to a Result\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = await fromPromise(\r\n *   fetch(\"/api/data\").then(r => r.json()),\r\n *   (e) => `Fetch failed: ${e}`\r\n * );\r\n * ```\r\n */\r\nexport async function fromPromise<SuccessType, ErrorType>(\r\n  promise: Promise<SuccessType>,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): AsyncResult<SuccessType, ErrorType> {\r\n  try {\r\n    return ok(await promise);\r\n  } catch (unknownError) {\r\n    return err(mapUnknownError(unknownError));\r\n  }\r\n}\r\n\r\n/**\r\n * Combines multiple async Results into a single Result containing an array of values.\r\n * If any Result is an error, returns that error (short-circuits).\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param asyncResults - Array of async Results to combine\r\n * @returns A promise that resolves to a Result containing an array of values or the first error\r\n *\r\n * @example\r\n * ```typescript\r\n * const results = [\r\n *   Promise.resolve(ok(1)),\r\n *   Promise.resolve(ok(2)),\r\n *   Promise.resolve(ok(3))\r\n * ];\r\n * const combined = await asyncAll(results);\r\n * // { ok: true, value: [1, 2, 3] }\r\n * ```\r\n */\r\nexport async function asyncAll<SuccessType, ErrorType>(\r\n  asyncResults: Array<AsyncResult<SuccessType, ErrorType>>\r\n): AsyncResult<SuccessType[], ErrorType> {\r\n  const results: Result<SuccessType, ErrorType>[] = await Promise.all(asyncResults);\r\n  return all(results);\r\n}\r\n","/**\r\n * Utility function to create type-safe injection tokens for dependency injection.\r\n */\r\nimport type { InjectionToken } from \"./types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Creates a unique, type-safe injection token for dependency injection.\r\n * Each call creates a new Symbol, ensuring uniqueness even with the same description.\r\n *\r\n * @template ServiceType - The type of service this token represents\r\n * @param description - A descriptive name for debugging purposes (appears in DevTools)\r\n * @returns A unique Symbol branded with the service type\r\n *\r\n * @example\r\n * // Create tokens for different services\r\n * const LoggerToken = createInjectionToken<Logger>('Logger');\r\n * const DatabaseToken = createInjectionToken<Database>('Database');\r\n *\r\n * // Tokens can be used with a DI container\r\n * container.register(LoggerToken, new Logger());\r\n */\r\nexport function createInjectionToken<TServiceType extends ServiceType>(\r\n  description: string\r\n): InjectionToken<TServiceType> {\r\n  return Symbol(description) as InjectionToken<TServiceType>;\r\n}\r\n","/**\r\n * Core application tokens for logging, domain services, configuration, and health.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { PlatformJournalVisibilityPort } from \"@/domain/ports/platform-journal-visibility-port.interface\";\r\nimport type { JournalVisibilityService } from \"@/application/services/JournalVisibilityService\";\r\nimport type { EnvironmentConfig } from \"@/framework/config/environment\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport type { ModuleHealthService } from \"@/application/services/ModuleHealthService\";\r\nimport type { HealthCheckRegistry } from \"@/application/health/HealthCheckRegistry\";\r\nimport type { ContainerHealthCheck } from \"@/application/health/ContainerHealthCheck\";\r\nimport type { MetricsHealthCheck } from \"@/application/health/MetricsHealthCheck\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { ModuleSettingsRegistrar } from \"@/application/services/ModuleSettingsRegistrar\";\r\nimport type { BootstrapInitHookService } from \"@/framework/core/bootstrap-init-hook\";\r\nimport type { BootstrapReadyHookService } from \"@/framework/core/bootstrap-ready-hook\";\r\n\r\n/**\r\n * Injection token for the application logger service.\r\n *\r\n * Resolves to ConsoleLoggerService, providing structured logging\r\n * with configurable log levels (DEBUG, INFO, WARN, ERROR).\r\n *\r\n * @example\r\n * ```typescript\r\n * const logger = container.resolve(loggerToken);\r\n * logger.info(\"Application started\");\r\n * logger.error(\"Error occurred\", { code: 500, details: error });\r\n * ```\r\n */\r\nexport const loggerToken = createInjectionToken<Logger>(\"Logger\");\r\n\r\n/**\r\n * Injection token for the PlatformJournalVisibilityPort.\r\n *\r\n * Port for journal visibility operations, abstracting platform details.\r\n * Implementations are provided by platform-specific adapters\r\n * (e.g., FoundryJournalVisibilityAdapter).\r\n *\r\n * @example\r\n * ```typescript\r\n * const port = container.resolve(journalVisibilityPortToken);\r\n * const entries = port.getAllEntries();\r\n * if (entries.ok) {\r\n *   console.log(`Found ${entries.value.length} entries`);\r\n * }\r\n * ```\r\n */\r\nexport const journalVisibilityPortToken =\r\n  createInjectionToken<PlatformJournalVisibilityPort>(\"JournalVisibilityPort\");\r\n\r\n/**\r\n * Injection token for the JournalVisibilityService.\r\n *\r\n * Manages visibility of journal entries based on module flags.\r\n * Handles hiding/showing entries in the Foundry UI and processes\r\n * journal directory rendering.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = container.resolve(journalVisibilityServiceToken);\r\n * const hidden = service.getHiddenJournalEntries();\r\n * if (hidden.ok) {\r\n *   console.log(`Found ${hidden.value.length} hidden entries`);\r\n * }\r\n * ```\r\n */\r\nexport const journalVisibilityServiceToken = createInjectionToken<JournalVisibilityService>(\r\n  \"JournalVisibilityService\"\r\n);\r\n\r\n/**\r\n * Injection token for the EnvironmentConfig.\r\n *\r\n * Provides access to environment configuration (development/production mode,\r\n * log levels, performance tracking settings, etc.).\r\n *\r\n * Injecting ENV as a service improves testability and follows DIP\r\n * (Dependency Inversion Principle) by depending on abstraction rather than\r\n * concrete global state.\r\n *\r\n * @example\r\n * ```typescript\r\n * export class MyService {\r\n *   static dependencies = [environmentConfigToken] as const;\r\n *\r\n *   constructor(private readonly env: EnvironmentConfig) {}\r\n *\r\n *   doSomething() {\r\n *     if (this.env.isDevelopment) {\r\n *       // Development-specific logic\r\n *     }\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const environmentConfigToken = createInjectionToken<EnvironmentConfig>(\"EnvironmentConfig\");\r\n\r\n/**\r\n * Injection token for the RuntimeConfigService.\r\n *\r\n * Provides access to the merged configuration layer that combines build-time\r\n * environment defaults with runtime Foundry settings and notifies consumers\r\n * of live changes.\r\n */\r\nexport const runtimeConfigToken =\r\n  createInjectionToken<RuntimeConfigService>(\"RuntimeConfigService\");\r\n\r\n/**\r\n * Injection token for the ModuleHealthService.\r\n *\r\n * Provides module health monitoring and diagnostics.\r\n * Checks container validation, port selection, and metrics for health assessment.\r\n *\r\n * @example\r\n * ```typescript\r\n * const healthService = container.resolve(moduleHealthServiceToken);\r\n * const health = healthService.getHealth();\r\n * console.log(`Module status: ${health.status}`);\r\n * ```\r\n */\r\nexport const moduleHealthServiceToken =\r\n  createInjectionToken<ModuleHealthService>(\"ModuleHealthService\");\r\n\r\n/**\r\n * Injection token for the HealthCheckRegistry.\r\n *\r\n * Central registry for health checks that can be dynamically registered.\r\n * Services implement HealthCheck interface and register themselves.\r\n *\r\n * @example\r\n * ```typescript\r\n * const registry = container.resolve(healthCheckRegistryToken);\r\n * registry.register(new ContainerHealthCheck(container));\r\n * const results = registry.runAll();\r\n * ```\r\n */\r\nexport const healthCheckRegistryToken =\r\n  createInjectionToken<HealthCheckRegistry>(\"HealthCheckRegistry\");\r\n\r\n/**\r\n * Injection token for the ContainerHealthCheck.\r\n *\r\n * Health check that validates the DI container state.\r\n *\r\n * @example\r\n * ```typescript\r\n * const check = container.resolve(containerHealthCheckToken);\r\n * const isHealthy = check.check(); // Returns true if container is validated\r\n * ```\r\n */\r\nexport const containerHealthCheckToken =\r\n  createInjectionToken<ContainerHealthCheck>(\"ContainerHealthCheck\");\r\n\r\n/**\r\n * Injection token for the MetricsHealthCheck.\r\n *\r\n * Health check that validates metrics and port selection status.\r\n *\r\n * @example\r\n * ```typescript\r\n * const check = container.resolve(metricsHealthCheckToken);\r\n * const isHealthy = check.check(); // Returns true if no port failures\r\n * ```\r\n */\r\nexport const metricsHealthCheckToken =\r\n  createInjectionToken<MetricsHealthCheck>(\"MetricsHealthCheck\");\r\n\r\n/**\r\n * Injection token for accessing the ServiceContainer itself.\r\n *\r\n * Primarily used for infrastructure services (e.g., health checks) that need\r\n * direct insight into the container state.\r\n */\r\nexport const serviceContainerToken = createInjectionToken<ServiceContainer>(\"ServiceContainer\");\r\n\r\n/**\r\n * Injection token for the ModuleSettingsRegistrar.\r\n *\r\n * Manages registration of all Foundry module settings.\r\n * Must be called during or after the 'init' hook.\r\n *\r\n * @example\r\n * ```typescript\r\n * const settingsRegistrar = container.resolve(moduleSettingsRegistrarToken);\r\n * settingsRegistrar.registerAll(container);\r\n * ```\r\n */\r\nexport const moduleSettingsRegistrarToken =\r\n  createInjectionToken<ModuleSettingsRegistrar>(\"ModuleSettingsRegistrar\");\r\n\r\n/**\r\n * Injection token for the BootstrapInitHookService.\r\n *\r\n * Service responsible for registering the Foundry 'init' hook.\r\n * Uses direct Hooks.on() to avoid chicken-egg problem with version detection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const initHookService = container.resolve(bootstrapInitHookServiceToken);\r\n * initHookService.register();\r\n * ```\r\n */\r\nexport const bootstrapInitHookServiceToken = createInjectionToken<BootstrapInitHookService>(\r\n  \"BootstrapInitHookService\"\r\n);\r\n\r\n/**\r\n * Injection token for the BootstrapReadyHookService.\r\n *\r\n * Service responsible for registering the Foundry 'ready' hook.\r\n * Uses direct Hooks.on() to avoid chicken-egg problem with version detection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const readyHookService = container.resolve(bootstrapReadyHookServiceToken);\r\n * readyHookService.register();\r\n * ```\r\n */\r\nexport const bootstrapReadyHookServiceToken = createInjectionToken<BootstrapReadyHookService>(\r\n  \"BootstrapReadyHookService\"\r\n);\r\n","/**\r\n * Observability tokens for metrics, tracing, and port selection monitoring.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { MetricsRecorder } from \"@/infrastructure/observability/interfaces/metrics-recorder\";\r\nimport type { MetricsSampler } from \"@/infrastructure/observability/interfaces/metrics-sampler\";\r\nimport type { MetricsStorage } from \"@/infrastructure/observability/metrics-persistence/metrics-storage\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport type { PortSelectionEventEmitter } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\nimport type { ObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\n\r\n/**\r\n * Injection token for the MetricsCollector service.\r\n *\r\n * Provides observability and performance tracking for the DI container.\r\n * Collects metrics about service resolutions, port selections, and cache performance.\r\n *\r\n * @example\r\n * ```typescript\r\n * const metrics = container.resolve(metricsCollectorToken);\r\n * metrics.recordResolution(someToken, 2.5, true);\r\n * const snapshot = metrics.getSnapshot();\r\n * console.table(snapshot);\r\n * ```\r\n */\r\nexport const metricsCollectorToken = createInjectionToken<MetricsCollector>(\"MetricsCollector\");\r\n\r\n/**\r\n * Injection token for the MetricsRecorder interface.\r\n *\r\n * Provides minimal recording capability without full MetricsCollector features.\r\n * Use this token when you only need to record metrics, not query or sample them.\r\n *\r\n * **Design:** Implements Interface Segregation Principle - depend on minimal interface.\r\n *\r\n * @example\r\n * ```typescript\r\n * class MyService {\r\n *   static dependencies = [metricsRecorderToken] as const;\r\n *   constructor(private recorder: MetricsRecorder) {}\r\n *   // Can record but not query metrics\r\n * }\r\n * ```\r\n */\r\nexport const metricsRecorderToken = createInjectionToken<MetricsRecorder>(\"MetricsRecorder\");\r\n\r\n/**\r\n * Injection token for the MetricsSampler interface.\r\n *\r\n * Provides sampling decision capability without full MetricsCollector features.\r\n * Use this token when you only need to check if sampling should occur.\r\n *\r\n * **Design:** Implements Interface Segregation Principle - depend on minimal interface.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PerformanceTracker {\r\n *   static dependencies = [metricsSamplerToken] as const;\r\n *   constructor(private sampler: MetricsSampler) {}\r\n *   // Can check sampling but not record or query\r\n * }\r\n * ```\r\n */\r\nexport const metricsSamplerToken = createInjectionToken<MetricsSampler>(\"MetricsSampler\");\r\n\r\n/**\r\n * Injection token for metrics persistence storage.\r\n */\r\nexport const metricsStorageToken = createInjectionToken<MetricsStorage>(\"MetricsStorage\");\r\n\r\n/**\r\n * Injection token for the TraceContext service.\r\n *\r\n * Provides automatic trace ID propagation across nested function calls.\r\n * Eliminates the need to manually pass trace IDs through function parameters.\r\n *\r\n * **Key Features:**\r\n * - Automatic trace ID generation\r\n * - Context stacking for nested traces\r\n * - Support for both sync and async operations\r\n * - Integration with Logger for automatic trace ID injection\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceContext = container.resolve(traceContextToken);\r\n *\r\n * // Automatic trace propagation\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Starting operation\"); // Automatically traced\r\n *   doSomething(); // Nested calls see the same trace ID\r\n * });\r\n *\r\n * // Async operation\r\n * await traceContext.traceAsync(async () => {\r\n *   const result = await fetchData();\r\n *   return result;\r\n * });\r\n * ```\r\n */\r\nexport const traceContextToken = createInjectionToken<TraceContext>(\"TraceContext\");\r\n\r\n/**\r\n * Injection token for the PortSelectionEventEmitter.\r\n *\r\n * Provides event emission infrastructure for PortSelector observability.\r\n * Registered as TRANSIENT - each service gets its own instance.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(emitter: PortSelectionEventEmitter) {\r\n *     this.emitter = emitter;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const portSelectionEventEmitterToken = createInjectionToken<PortSelectionEventEmitter>(\r\n  \"PortSelectionEventEmitter\"\r\n);\r\n\r\n/**\r\n * Injection token for the ObservabilityRegistry.\r\n *\r\n * Central registry for self-registering observable services.\r\n * Services register themselves at construction time for automatic observability.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(observability: ObservabilityRegistry) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const observabilityRegistryToken =\r\n  createInjectionToken<ObservabilityRegistry>(\"ObservabilityRegistry\");\r\n","/**\r\n * Internationalization (i18n) tokens for translation services and handlers.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { FoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\nimport type { LocalI18nService } from \"@/infrastructure/i18n/LocalI18nService\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for the FoundryI18nPort.\r\n *\r\n * Provides access to Foundry VTT's i18n API via Port-Adapter pattern.\r\n * Automatically selects the correct port based on Foundry version.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(foundryI18nToken);\r\n * const result = i18n.localize(\"MODULE.SETTINGS.logLevel.name\");\r\n * if (result.ok) {\r\n *   console.log(result.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundryI18nToken = createInjectionToken<FoundryI18nPort>(\"FoundryI18nPort\");\r\n\r\n/**\r\n * Injection token for the LocalI18nService.\r\n *\r\n * Provides Foundry-independent JSON-based translations.\r\n * Used as fallback when Foundry's i18n is unavailable.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(localI18nToken);\r\n * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\");\r\n * console.log(result.value);\r\n * ```\r\n */\r\nexport const localI18nToken = createInjectionToken<LocalI18nService>(\"LocalI18nService\");\r\n\r\n/**\r\n * Injection token for the I18nFacadeService.\r\n *\r\n * Combines Foundry's i18n and local translations with intelligent fallback.\r\n * This is the recommended token to use for all internationalization needs.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(i18nFacadeToken);\r\n * const text = i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\");\r\n * console.log(text);\r\n * ```\r\n */\r\nexport const i18nFacadeToken = createInjectionToken<I18nFacadeService>(\"I18nFacadeService\");\r\n\r\n/**\r\n * Injection token for the FoundryTranslationHandler.\r\n *\r\n * First handler in the translation chain: tries Foundry's i18n first.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const foundryTranslationHandlerToken = createInjectionToken<TranslationHandler>(\r\n  \"FoundryTranslationHandler\"\r\n);\r\n\r\n/**\r\n * Injection token for the LocalTranslationHandler.\r\n *\r\n * Second handler in the translation chain: provides local JSON-based translations.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const localTranslationHandlerToken =\r\n  createInjectionToken<TranslationHandler>(\"LocalTranslationHandler\");\r\n\r\n/**\r\n * Injection token for the FallbackTranslationHandler.\r\n *\r\n * Final handler in the translation chain: returns fallback or key itself.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const fallbackTranslationHandlerToken = createInjectionToken<TranslationHandler>(\r\n  \"FallbackTranslationHandler\"\r\n);\r\n\r\n/**\r\n * Injection token for the TranslationHandlerChain.\r\n *\r\n * Fully configured chain: Foundry → Local → Fallback.\r\n * Built via factory in DI container.\r\n */\r\nexport const translationHandlerChainToken =\r\n  createInjectionToken<TranslationHandler>(\"TranslationHandlerChain\");\r\n","/**\r\n * Notification tokens for message routing and channels.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { NotificationChannel } from \"@/infrastructure/notifications/notification-channel.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\n\r\n/**\r\n * Injection token for the NotificationCenter.\r\n *\r\n * Central message bus for all application notifications (debug, info, warn, error).\r\n * Routes notifications to registered channels (Console, UI, Sentry, etc.).\r\n *\r\n * @example\r\n * ```typescript\r\n * const notifications = container.resolve(notificationCenterToken);\r\n * notifications.debug(\"Processing data\");\r\n * notifications.error(\"Operation failed\", error);\r\n * ```\r\n */\r\nexport const notificationCenterToken =\r\n  createInjectionToken<NotificationCenter>(\"NotificationCenter\");\r\n\r\n/**\r\n * Injection token for ConsoleChannel.\r\n */\r\nexport const consoleChannelToken = createInjectionToken<NotificationChannel>(\"ConsoleChannel\");\r\n\r\n/**\r\n * Injection token for UIChannel.\r\n */\r\nexport const uiChannelToken = createInjectionToken<NotificationChannel>(\"UIChannel\");\r\n","/**\r\n * Infrastructure service tokens for caching, performance, and retry.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { CacheService, CacheServiceConfig } from \"@/infrastructure/cache/cache.interface\";\r\nimport type { PerformanceTrackingService } from \"@/infrastructure/performance/PerformanceTrackingService\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { ModuleApiInitializer } from \"@/framework/core/api/module-api-initializer\";\r\n\r\n/**\r\n * Injection token for the CacheService configuration.\r\n */\r\nexport const cacheServiceConfigToken =\r\n  createInjectionToken<CacheServiceConfig>(\"CacheServiceConfig\");\r\n\r\n/**\r\n * Injection token for the CacheService.\r\n */\r\nexport const cacheServiceToken = createInjectionToken<CacheService>(\"CacheService\");\r\n\r\n/**\r\n * Injection token for the PerformanceTrackingService.\r\n *\r\n * Provides centralized performance tracking with sampling support.\r\n * Automatically injects EnvironmentConfig and MetricsCollector.\r\n *\r\n * @example\r\n * ```typescript\r\n * const perfService = container.resolve(performanceTrackingServiceToken);\r\n * const result = perfService.track(() => expensiveOperation());\r\n * ```\r\n */\r\nexport const performanceTrackingServiceToken = createInjectionToken<PerformanceTrackingService>(\r\n  \"PerformanceTrackingService\"\r\n);\r\n\r\n/**\r\n * Injection token for the RetryService.\r\n *\r\n * Provides retry operations with exponential backoff and automatic logging.\r\n * Automatically injects Logger and MetricsCollector.\r\n *\r\n * @example\r\n * ```typescript\r\n * const retryService = container.resolve(retryServiceToken);\r\n * const result = await retryService.retry(\r\n *   () => fetchData(),\r\n *   { maxAttempts: 3, operationName: \"fetchData\" }\r\n * );\r\n * ```\r\n */\r\nexport const retryServiceToken = createInjectionToken<RetryService>(\"RetryService\");\r\n\r\n/**\r\n * Injection token for the ModuleApiInitializer.\r\n *\r\n * Initializes and exposes the public module API to external consumers.\r\n * Manages API-safe tokens and provides health status.\r\n */\r\nexport const moduleApiInitializerToken =\r\n  createInjectionToken<ModuleApiInitializer>(\"ModuleApiInitializer\");\r\n","/**\r\n * Injection tokens for the Foundry abstraction layer and its versioned ports.\r\n * These tokens allow services to be resolved via the DI container without\r\n * directly depending on concrete implementations.\r\n */\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\nimport type { PortSelector } from \"@/infrastructure/adapters/foundry/versioning/portselector\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryJournalFacade } from \"@/infrastructure/adapters/foundry/facades/foundry-journal-facade.interface\";\r\nimport type { LibWrapperService } from \"@/domain/services/lib-wrapper-service.interface\";\r\nimport type { JournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\n\r\n/**\r\n * Injection token for FoundryGame port.\r\n *\r\n * Provides access to Foundry's game API, specifically journal entries.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const game = container.resolve(foundryGameToken);\r\n * const entries = game.getJournalEntries();\r\n * if (entries.ok) {\r\n *   console.log(`Found ${entries.value.length} journal entries`);\r\n * }\r\n * ```\r\n */\r\nexport const foundryGameToken: InjectionToken<FoundryGame> =\r\n  createInjectionToken<FoundryGame>(\"FoundryGame\");\r\n\r\n/**\r\n * Injection token for FoundryHooks port.\r\n *\r\n * Provides access to Foundry's hook system for event registration.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const hooks = container.resolve(foundryHooksToken);\r\n * hooks.on(\"renderJournalDirectory\", (app, html) => {\r\n *   console.log(\"Journal directory rendered\");\r\n * });\r\n * ```\r\n */\r\nexport const foundryHooksToken: InjectionToken<FoundryHooks> =\r\n  createInjectionToken<FoundryHooks>(\"FoundryHooks\");\r\n\r\n/**\r\n * Injection token for FoundryDocument port.\r\n *\r\n * Provides access to Foundry's document API for flag management.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const doc = container.resolve(foundryDocumentToken);\r\n * const flag = doc.getFlag(journal, \"my-module\", \"my-flag\");\r\n * if (flag.ok) {\r\n *   console.log(\"Flag value:\", flag.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundryDocumentToken: InjectionToken<FoundryDocument> =\r\n  createInjectionToken<FoundryDocument>(\"FoundryDocument\");\r\n\r\n/**\r\n * Injection token for FoundryUI port.\r\n *\r\n * Provides access to Foundry's UI manipulation API for notifications\r\n * and DOM element management.\r\n *\r\n * @example\r\n * ```typescript\r\n * const ui = container.resolve(foundryUIToken);\r\n * ui.notify(\"Operation successful\", \"info\");\r\n * ```\r\n */\r\nexport const foundryUIToken: InjectionToken<FoundryUI> =\r\n  createInjectionToken<FoundryUI>(\"FoundryUI\");\r\n\r\n/**\r\n * Injection token for PortSelector.\r\n *\r\n * Selects the appropriate port implementation based on the current\r\n * Foundry VTT version. Uses factory-based selection to prevent crashes\r\n * from incompatible port constructors.\r\n *\r\n * @remarks\r\n * This is a core infrastructure service used internally by Foundry services.\r\n * Typically not accessed directly by application code.\r\n */\r\nexport const portSelectorToken: InjectionToken<PortSelector> =\r\n  createInjectionToken<PortSelector>(\"PortSelector\");\r\n\r\n/**\r\n * Injection token for FoundryGame PortRegistry.\r\n */\r\nexport const foundryGamePortRegistryToken: InjectionToken<PortRegistry<FoundryGame>> =\r\n  createInjectionToken<PortRegistry<FoundryGame>>(\"FoundryGamePortRegistry\");\r\n\r\n/**\r\n * Injection token for FoundryHooks PortRegistry.\r\n */\r\nexport const foundryHooksPortRegistryToken: InjectionToken<PortRegistry<FoundryHooks>> =\r\n  createInjectionToken<PortRegistry<FoundryHooks>>(\"FoundryHooksPortRegistry\");\r\n\r\n/**\r\n * Injection token for FoundryDocument PortRegistry.\r\n */\r\nexport const foundryDocumentPortRegistryToken: InjectionToken<PortRegistry<FoundryDocument>> =\r\n  createInjectionToken<PortRegistry<FoundryDocument>>(\"FoundryDocumentPortRegistry\");\r\n\r\n/**\r\n * Injection token for FoundryUI PortRegistry.\r\n */\r\nexport const foundryUIPortRegistryToken: InjectionToken<PortRegistry<FoundryUI>> =\r\n  createInjectionToken<PortRegistry<FoundryUI>>(\"FoundryUIPortRegistry\");\r\n\r\n/**\r\n * Injection token for FoundrySettings port.\r\n *\r\n * Provides access to Foundry's settings system for module configuration.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const settings = container.resolve(foundrySettingsToken);\r\n * const logLevel = settings.get(\"my-module\", \"logLevel\");\r\n * if (logLevel.ok) {\r\n *   console.log(\"Current log level:\", logLevel.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundrySettingsToken: InjectionToken<FoundrySettings> =\r\n  createInjectionToken<FoundrySettings>(\"FoundrySettings\");\r\n\r\n/**\r\n * Injection token for FoundrySettings PortRegistry.\r\n */\r\nexport const foundrySettingsPortRegistryToken: InjectionToken<PortRegistry<FoundrySettings>> =\r\n  createInjectionToken<PortRegistry<FoundrySettings>>(\"FoundrySettingsPortRegistry\");\r\n\r\n/**\r\n * Injection token for FoundryI18n PortRegistry.\r\n */\r\nexport const foundryI18nPortRegistryToken: InjectionToken<PortRegistry<FoundryI18n>> =\r\n  createInjectionToken<PortRegistry<FoundryI18n>>(\"FoundryI18nPortRegistry\");\r\n\r\n/**\r\n * Version-specific port tokens for Foundry VTT v13.\r\n * These tokens are used to register and resolve version-specific port implementations\r\n * via the DI container, ensuring DIP (Dependency Inversion Principle) compliance.\r\n *\r\n * Ports are registered in the container during bootstrap and resolved by PortSelector\r\n * based on the current Foundry version.\r\n */\r\n\r\n/**\r\n * Injection token for FoundryGame port v13 implementation.\r\n */\r\nexport const foundryV13GamePortToken: InjectionToken<FoundryGame> =\r\n  createInjectionToken<FoundryGame>(\"FoundryV13GamePort\");\r\n\r\n/**\r\n * Injection token for FoundryHooks port v13 implementation.\r\n */\r\nexport const foundryV13HooksPortToken: InjectionToken<FoundryHooks> =\r\n  createInjectionToken<FoundryHooks>(\"FoundryV13HooksPort\");\r\n\r\n/**\r\n * Injection token for FoundryDocument port v13 implementation.\r\n */\r\nexport const foundryV13DocumentPortToken: InjectionToken<FoundryDocument> =\r\n  createInjectionToken<FoundryDocument>(\"FoundryV13DocumentPort\");\r\n\r\n/**\r\n * Injection token for FoundryUI port v13 implementation.\r\n */\r\nexport const foundryV13UIPortToken: InjectionToken<FoundryUI> =\r\n  createInjectionToken<FoundryUI>(\"FoundryV13UIPort\");\r\n\r\n/**\r\n * Injection token for FoundrySettings port v13 implementation.\r\n */\r\nexport const foundryV13SettingsPortToken: InjectionToken<FoundrySettings> =\r\n  createInjectionToken<FoundrySettings>(\"FoundryV13SettingsPort\");\r\n\r\n/**\r\n * Injection token for FoundryI18n port v13 implementation.\r\n */\r\nexport const foundryV13I18nPortToken: InjectionToken<FoundryI18n> =\r\n  createInjectionToken<FoundryI18n>(\"FoundryV13I18nPort\");\r\n\r\n/**\r\n * Injection token for FoundryJournalFacade.\r\n *\r\n * Facade that combines FoundryGame, FoundryDocument, and FoundryUI\r\n * for journal-specific operations.\r\n *\r\n * **Benefits:**\r\n * - Reduces dependency count from 3 services to 1 facade\r\n * - Provides cohesive journal-specific API\r\n * - Easier to test and mock\r\n *\r\n * @example\r\n * ```typescript\r\n * const facade = container.resolve(foundryJournalFacadeToken);\r\n * const entries = facade.getJournalEntries();\r\n * if (entries.ok) {\r\n *   // Process entries\r\n * }\r\n * ```\r\n */\r\nexport const foundryJournalFacadeToken: InjectionToken<FoundryJournalFacade> =\r\n  createInjectionToken<FoundryJournalFacade>(\"FoundryJournalFacade\");\r\n\r\n/**\r\n * Injection token for LibWrapperService.\r\n *\r\n * Provides a facade over libWrapper for registering and unregistering method wrappers.\r\n * Handles tracking of registrations and cleanup.\r\n *\r\n * @example\r\n * ```typescript\r\n * const libWrapper = container.resolve(libWrapperServiceToken);\r\n * const result = libWrapper.register(\r\n *   \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n *   (wrapped, ...args) => {\r\n *     // Custom logic\r\n *     return wrapped(...args);\r\n *   },\r\n *   \"WRAPPER\"\r\n * );\r\n * ```\r\n */\r\nexport const libWrapperServiceToken: InjectionToken<LibWrapperService> =\r\n  createInjectionToken<LibWrapperService>(\"LibWrapperService\");\r\n\r\n/**\r\n * Injection token for JournalContextMenuLibWrapperService.\r\n *\r\n * Service for managing libWrapper registration for journal context menu.\r\n * Handles the registration of the libWrapper wrapper function for the Foundry\r\n * ContextMenu.render method and manages callbacks that can modify context menu options.\r\n *\r\n * NOTE: This is NOT an event system. The libWrapper is registered once during init,\r\n * and callbacks are registered separately.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = container.resolve(journalContextMenuLibWrapperServiceToken);\r\n *\r\n * // Register libWrapper (called during init)\r\n * const result = service.register();\r\n *\r\n * // Add callback for handling context menu\r\n * service.addCallback((event) => {\r\n *   event.options.push({\r\n *     name: \"Custom Option\",\r\n *     icon: '<i class=\"fas fa-star\"></i>',\r\n *     callback: () => { /* ... *\\/ }\r\n *   });\r\n * });\r\n * ```\r\n */\r\nexport const journalContextMenuLibWrapperServiceToken: InjectionToken<JournalContextMenuLibWrapperService> =\r\n  createInjectionToken<JournalContextMenuLibWrapperService>(\"JournalContextMenuLibWrapperService\");\r\n","import { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { InvalidateJournalCacheOnChangeUseCase } from \"@/application/use-cases/invalidate-journal-cache-on-change.use-case\";\r\nimport type { ProcessJournalDirectoryOnRenderUseCase } from \"@/application/use-cases/process-journal-directory-on-render.use-case\";\r\nimport type { TriggerJournalDirectoryReRenderUseCase } from \"@/application/use-cases/trigger-journal-directory-rerender.use-case\";\r\nimport type { RegisterContextMenuUseCase } from \"@/application/use-cases/register-context-menu.use-case\";\r\nimport type { HideJournalContextMenuHandler } from \"@/application/handlers/hide-journal-context-menu-handler\";\r\nimport type { ModuleEventRegistrar } from \"@/application/services/ModuleEventRegistrar\";\r\n\r\n/**\r\n * DI Token for PlatformJournalEventPort.\r\n *\r\n * Used to inject platform-agnostic journal event handling.\r\n * Default implementation: FoundryJournalEventAdapter (for Foundry VTT)\r\n */\r\nexport const platformJournalEventPortToken =\r\n  createInjectionToken<PlatformJournalEventPort>(\"JournalEventPort\");\r\n\r\n/**\r\n * DI Token for InvalidateJournalCacheOnChangeUseCase.\r\n *\r\n * Use-case that invalidates journal cache when journal entries change.\r\n */\r\nexport const invalidateJournalCacheOnChangeUseCaseToken =\r\n  createInjectionToken<InvalidateJournalCacheOnChangeUseCase>(\r\n    \"InvalidateJournalCacheOnChangeUseCase\"\r\n  );\r\n\r\n/**\r\n * DI Token for ProcessJournalDirectoryOnRenderUseCase.\r\n *\r\n * Use-case that processes journal directory when it's rendered.\r\n */\r\nexport const processJournalDirectoryOnRenderUseCaseToken =\r\n  createInjectionToken<ProcessJournalDirectoryOnRenderUseCase>(\r\n    \"ProcessJournalDirectoryOnRenderUseCase\"\r\n  );\r\n\r\n/**\r\n * DI Token for TriggerJournalDirectoryReRenderUseCase.\r\n *\r\n * Use-case that triggers journal directory re-render when hidden flag changes.\r\n */\r\nexport const triggerJournalDirectoryReRenderUseCaseToken =\r\n  createInjectionToken<TriggerJournalDirectoryReRenderUseCase>(\r\n    \"TriggerJournalDirectoryReRenderUseCase\"\r\n  );\r\n\r\n/**\r\n * DI Token for RegisterJournalContextMenuUseCase.\r\n *\r\n * @deprecated Use registerContextMenuUseCaseToken instead.\r\n * This token is kept for backwards compatibility but the implementation has been removed.\r\n */\r\nexport const registerJournalContextMenuUseCaseToken =\r\n  createInjectionToken<RegisterContextMenuUseCase>(\"RegisterJournalContextMenuUseCase\");\r\n\r\n/**\r\n * DI Token for RegisterContextMenuUseCase.\r\n *\r\n * Use-case that registers custom context menu entries for journal entries.\r\n */\r\nexport const registerContextMenuUseCaseToken = createInjectionToken<RegisterContextMenuUseCase>(\r\n  \"RegisterContextMenuUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for HideJournalContextMenuHandler.\r\n *\r\n * Handler that adds \"Journal ausblenden\" menu item to journal context menus.\r\n */\r\nexport const hideJournalContextMenuHandlerToken =\r\n  createInjectionToken<HideJournalContextMenuHandler>(\"HideJournalContextMenuHandler\");\r\n\r\n/**\r\n * DI Token for ModuleEventRegistrar.\r\n *\r\n * Manages registration of all platform-agnostic event listeners.\r\n */\r\nexport const moduleEventRegistrarToken =\r\n  createInjectionToken<ModuleEventRegistrar>(\"ModuleEventRegistrar\");\r\n","import { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { PlatformSettingsPort } from \"@/domain/ports/platform-settings-port.interface\";\r\n\r\n/**\r\n * DI Token for PlatformUIPort.\r\n *\r\n * Platform-agnostic UI operations port.\r\n * Default implementation: FoundryUIAdapter (for Foundry VTT)\r\n */\r\nexport const platformUIPortToken = createInjectionToken<PlatformUIPort>(\"PlatformUIPort\");\r\n\r\n/**\r\n * DI Token for PlatformSettingsPort.\r\n *\r\n * Platform-agnostic settings port.\r\n * Default implementation: FoundrySettingsAdapter (for Foundry VTT)\r\n */\r\nexport const platformSettingsPortToken =\r\n  createInjectionToken<PlatformSettingsPort>(\"PlatformSettingsPort\");\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { JournalCollectionPort } from \"@/domain/ports/collections/journal-collection-port.interface\";\r\n\r\n/**\r\n * Injection token for JournalCollectionPort.\r\n *\r\n * Provides read-only access to journal entry collections.\r\n * Platform-agnostic interface for querying journal entries.\r\n *\r\n * @example\r\n * ```typescript\r\n * const collection = container.resolve(journalCollectionPortToken);\r\n * const journals = collection.getAll();\r\n * if (journals.ok) {\r\n *   console.log(`Found ${journals.value.length} journals`);\r\n * }\r\n * ```\r\n */\r\nexport const journalCollectionPortToken: InjectionToken<JournalCollectionPort> =\r\n  createInjectionToken<JournalCollectionPort>(\"JournalCollectionPort\");\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { createInjectionToken } from \"@/infrastructure/di/tokenutilities\";\r\nimport type { JournalRepository } from \"@/domain/ports/repositories/journal-repository.interface\";\r\n\r\n/**\r\n * Injection token for JournalRepository.\r\n *\r\n * Provides full CRUD access to journal entries with batch operations and flag management.\r\n * Platform-agnostic interface for managing journal entries.\r\n *\r\n * @example\r\n * ```typescript\r\n * const repository = container.resolve(journalRepositoryToken);\r\n * const result = await repository.create({ name: \"New Journal\" });\r\n * if (result.ok) {\r\n *   console.log(`Created journal: ${result.value.id}`);\r\n * }\r\n * ```\r\n */\r\nexport const journalRepositoryToken: InjectionToken<JournalRepository> =\r\n  createInjectionToken<JournalRepository>(\"JournalRepository\");\r\n","import type { InjectionToken } from \"../core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Compile-time brand marker for API-safe tokens.\r\n *\r\n * This symbol only exists at the type level and is erased at runtime.\r\n * It's used to mark tokens that are safe for external module consumption via the public API.\r\n *\r\n * @internal This is a type-level-only marker\r\n */\r\ndeclare const API_SAFE_BRAND: unique symbol;\r\n\r\n/**\r\n * Runtime registry of API-safe tokens.\r\n *\r\n * Uses Set for O(1) lookups. Since symbols are primitives (not objects),\r\n * WeakSet cannot be used. This is safe because tokens are compile-time constants\r\n * and never get garbage collected anyway.\r\n *\r\n * @internal\r\n */\r\nconst apiSafeTokens = new Set<symbol>();\r\n\r\n/**\r\n * InjectionToken branded as \"API-safe\" for external module consumption.\r\n *\r\n * Only tokens marked via `markAsApiSafe()` can be used with the throwing\r\n * `container.resolve()` method. This enforces that internal code uses\r\n * `resolveWithError()` for Result-based error handling.\r\n *\r\n * **Enforcement:**\r\n * - Compile-time: TypeScript enforces ApiSafeToken type (prevents `container.resolve(regularToken)`)\r\n * - Runtime: Symbol marker validates token was marked via markAsApiSafe()\r\n *\r\n * **Design rationale:**\r\n * - External modules (unfamiliar with Result pattern) get exception-based API\r\n * - Internal code (uses Result pattern) cannot accidentally use throwing API\r\n * - Defense-in-depth: Type system + runtime guard\r\n *\r\n * @template T - The service type this token resolves to\r\n *\r\n * @see markAsApiSafe - Function to mark tokens as API-safe\r\n * @see https://github.com/tc39/proposal-type-annotations (future TC39 standard alignment)\r\n */\r\nexport type ApiSafeToken<T extends ServiceType> = InjectionToken<T> & {\r\n  readonly [API_SAFE_BRAND]: true;\r\n};\r\n\r\n/**\r\n * Marks an injection token as safe for API exposure.\r\n *\r\n * **🔒 RESTRICTED: Only call this in composition-root.ts**\r\n *\r\n * This function should ONLY be used when creating the public ModuleApi\r\n * to mark tokens that external modules can safely use with `api.resolve()`.\r\n *\r\n * Internal code should never call this function - it should always use\r\n * `resolveWithError()` with regular InjectionToken types.\r\n *\r\n * **Implementation:**\r\n * 1. Adds token to Set registry\r\n * 2. Returns token cast as ApiSafeToken (compile-time brand)\r\n *\r\n * **Performance:**\r\n * - Minimal runtime overhead (Set.add is O(1))\r\n * - Compile-time type checking prevents misuse\r\n *\r\n * @param token - The injection token to mark as API-safe\r\n * @returns The same token, branded as ApiSafeToken with runtime marker\r\n *\r\n * @example\r\n * ```typescript\r\n * // ✅ CORRECT: In composition-root.ts\r\n * const api: ModuleApi = {\r\n *   tokens: {\r\n *     loggerToken: markAsApiSafe(loggerToken),\r\n *     gameToken: markAsApiSafe(foundryGameToken),\r\n *   }\r\n * };\r\n *\r\n * // ❌ WRONG: In service code\r\n * const logger = container.resolve(markAsApiSafe(loggerToken));\r\n * // Use resolveWithError() instead!\r\n * ```\r\n */\r\nexport function markAsApiSafe<T extends ServiceType>(token: InjectionToken<T>): ApiSafeToken<T> {\r\n  // Add to Set registry (O(1) lookup)\r\n  apiSafeTokens.add(token);\r\n\r\n  /* type-coverage:ignore-next-line -- Nominal branding: Return with compile-time brand marker (type cast) */\r\n  return token as ApiSafeToken<T>;\r\n}\r\n\r\n/**\r\n * Runtime validation that a token is API-safe.\r\n *\r\n * Checks if the token is in the Set registry.\r\n * Used by container.resolve() to enforce API boundary at runtime.\r\n *\r\n * This provides defense-in-depth against:\r\n * - @ts-ignore comments bypassing type checks\r\n * - Type assertions (`token as ApiSafeToken`)\r\n * - JavaScript consumers (no type checking)\r\n *\r\n * **Performance:**\r\n * - O(1) Set lookup (~1-2 nanoseconds)\r\n * - Negligible impact (~0.4% of resolve() time)\r\n * - Safe: Tokens are compile-time constants, never GC'd\r\n *\r\n * @param token - The token to validate\r\n * @returns True if token was marked via markAsApiSafe(), false otherwise\r\n *\r\n * @internal Used by ServiceContainer, not intended for external use\r\n *\r\n * @example\r\n * ```typescript\r\n * // Container.resolve() implementation:\r\n * resolve(token) {\r\n *   if (!isApiSafeTokenRuntime(token)) {\r\n *     throw new Error(\"Use resolveWithError() in internal code\");\r\n *   }\r\n *   // ...\r\n * }\r\n * ```\r\n */\r\nexport function isApiSafeTokenRuntime<T extends ServiceType>(\r\n  token: InjectionToken<T>\r\n): token is ApiSafeToken<T> {\r\n  // Check Set registry\r\n  return apiSafeTokens.has(token);\r\n}\r\n","/**\r\n * Enum for service lifecycle strategies in dependency injection.\r\n *\r\n * - SINGLETON: One shared instance across the entire application\r\n * - TRANSIENT: New instance created on each resolution\r\n * - SCOPED: One instance per container scope\r\n *\r\n * @enum {string}\r\n * @property {string} SINGLETON - One instance for all\r\n * @property {string} TRANSIENT - New instance for each resolve()\r\n * @property {string} SCOPED - One instance per scope\r\n */\r\nexport enum ServiceLifecycle {\r\n  SINGLETON = \"singleton\",\r\n  TRANSIENT = \"transient\",\r\n  SCOPED = \"scoped\",\r\n}\r\n","import type { ServiceLifecycle } from \"./servicelifecycle\";\r\nimport type { InjectionToken } from \"./injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ServiceClass } from \"../resolution/serviceclass\";\r\nimport type { FactoryFunction } from \"../resolution/servicefactory\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle as SL } from \"./servicelifecycle\";\r\n\r\n/**\r\n * Represents a service registration in the DI container.\r\n * Stores all metadata required to create and manage service instances.\r\n *\r\n * Generic type parameter preserves the concrete service type through registration and resolution,\r\n * enabling type-safe dependency injection without runtime casts.\r\n *\r\n * Design: Uses separate optional fields instead of union type to:\r\n * - Prevent accidental calls to placeholder alias factories\r\n * - Make provider type clear and type-safe\r\n * - Support proper cloning for child scopes\r\n *\r\n * Use static factory methods to create instances:\r\n * - ServiceRegistration.createClass()\r\n * - ServiceRegistration.createFactory()\r\n * - ServiceRegistration.createValue()\r\n * - ServiceRegistration.createAlias()\r\n *\r\n * @template TServiceType - The concrete service type being registered\r\n */\r\nexport class ServiceRegistration<TServiceType extends ServiceType = ServiceType> {\r\n  /**\r\n   * Private constructor - use static factory methods instead.\r\n   * This prevents direct construction with invalid parameters\r\n   * and ensures Result-based error handling.\r\n   */\r\n  private constructor(\r\n    public readonly lifecycle: ServiceLifecycle,\r\n    public readonly dependencies: readonly InjectionToken<ServiceType>[], // Immutable array\r\n    public readonly providerType: \"class\" | \"factory\" | \"value\" | \"alias\",\r\n\r\n    // Exactly one of these must be set based on providerType:\r\n    public readonly serviceClass?: ServiceClass<TServiceType>,\r\n    public readonly factory?: FactoryFunction<TServiceType>,\r\n    public readonly value?: TServiceType,\r\n    public readonly aliasTarget?: InjectionToken<TServiceType>\r\n  ) {\r\n    // NO validation here - trust factory methods to provide valid data\r\n  }\r\n\r\n  /**\r\n   * Creates a class-based registration.\r\n   * @template TServiceType - The concrete service type\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of dependency tokens\r\n   * @param serviceClass - The class to instantiate\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createClass<TServiceType extends ServiceType>(\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: readonly InjectionToken<ServiceType>[],\r\n    serviceClass: ServiceClass<TServiceType>\r\n  ): Result<ServiceRegistration<TServiceType>, ContainerError> {\r\n    // Note: serviceClass validation is performed in ServiceRegistry.registerClass before calling this method\r\n    return ok(\r\n      new ServiceRegistration<TServiceType>(\r\n        lifecycle,\r\n        dependencies,\r\n        \"class\",\r\n        serviceClass,\r\n        undefined,\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a factory-based registration.\r\n   * @template TServiceType - The concrete service type\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of dependency tokens\r\n   * @param factory - Factory function that creates instances\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createFactory<TServiceType extends ServiceType>(\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: readonly InjectionToken<ServiceType>[],\r\n    factory: FactoryFunction<TServiceType>\r\n  ): Result<ServiceRegistration<TServiceType>, ContainerError> {\r\n    if (!factory) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"factory is required for factory registration\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<TServiceType>(\r\n        lifecycle,\r\n        dependencies,\r\n        \"factory\",\r\n        undefined,\r\n        factory,\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a value-based registration (always SINGLETON).\r\n   * @template TServiceType - The concrete service type\r\n   * @param value - The value to register\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createValue<TServiceType extends ServiceType>(\r\n    value: TServiceType\r\n  ): Result<ServiceRegistration<TServiceType>, ContainerError> {\r\n    if (value === undefined) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"value cannot be undefined for value registration\",\r\n      });\r\n    }\r\n\r\n    if (typeof value === \"function\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message:\r\n          \"registerValue() only accepts plain values, not functions or classes. Use registerClass() or registerFactory() instead.\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<TServiceType>(\r\n        SL.SINGLETON,\r\n        [],\r\n        \"value\",\r\n        undefined,\r\n        undefined,\r\n        value,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates an alias registration (always SINGLETON).\r\n   * @template TServiceType - The concrete service type\r\n   * @param targetToken - The token to resolve instead\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createAlias<TServiceType extends ServiceType>(\r\n    targetToken: InjectionToken<TServiceType>\r\n  ): Result<ServiceRegistration<TServiceType>, ContainerError> {\r\n    if (!targetToken) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"targetToken is required for alias registration\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<TServiceType>(\r\n        SL.SINGLETON,\r\n        [targetToken],\r\n        \"alias\",\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        targetToken\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a clone of this registration.\r\n   * Used when child containers inherit registrations from parent.\r\n   *\r\n   * @returns A new ServiceRegistration instance with cloned dependencies array\r\n   */\r\n  clone(): ServiceRegistration<TServiceType> {\r\n    return new ServiceRegistration<TServiceType>(\r\n      this.lifecycle,\r\n      [...this.dependencies], // Clone array to prevent shared mutations\r\n      this.providerType,\r\n      this.serviceClass,\r\n      this.factory,\r\n      this.value,\r\n      this.aliasTarget\r\n    );\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\n\r\n/**\r\n * Type-safe wrapper around Map for ServiceRegistrations.\r\n *\r\n * Preserves generic type information through token-based lookup, enabling\r\n * type-safe dependency injection without runtime casts in most cases.\r\n *\r\n * Design:\r\n * - Map stores ServiceRegistration<any> to support heterogeneous service types\r\n * - Generic methods preserve type information through token's type parameter\r\n * - Single cast in get() is architecturally sound (token identity guarantees type)\r\n *\r\n * @example\r\n * ```typescript\r\n * const map = new TypeSafeRegistrationMap();\r\n * const reg = ServiceRegistration.createClass<Logger>(...);\r\n * map.set(loggerToken, reg);\r\n *\r\n * const retrieved = map.get(loggerToken);\r\n * // retrieved is ServiceRegistration<Logger> | undefined\r\n * ```\r\n */\r\nexport class TypeSafeRegistrationMap {\r\n  private readonly map: Map<symbol, ServiceRegistration<any>> = new Map();\r\n\r\n  /**\r\n   * Stores a service registration.\r\n   *\r\n   * @template T - The concrete service type\r\n   * @param token - The injection token identifying the service\r\n   * @param registration - The service registration metadata\r\n   */\r\n  set<T extends ServiceType>(token: InjectionToken<T>, registration: ServiceRegistration<T>): void {\r\n    this.map.set(token as symbol, registration);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a service registration.\r\n   *\r\n   * Type-safe by design: The token's generic parameter guarantees that the\r\n   * returned registration matches the expected service type.\r\n   *\r\n   * @template T - The concrete service type\r\n   * @param token - The injection token identifying the service\r\n   * @returns The service registration or undefined if not found\r\n   */\r\n  get<T extends ServiceType>(token: InjectionToken<T>): ServiceRegistration<T> | undefined {\r\n    // Type-safe by design: Token's generic guarantees registration type\r\n    // Cast is necessary due to Map's type erasure but architecturally sound\r\n    return this.map.get(token as symbol) as ServiceRegistration<T> | undefined;\r\n  }\r\n\r\n  /**\r\n   * Checks if a service is registered.\r\n   *\r\n   * @param token - The injection token to check\r\n   * @returns True if the service is registered\r\n   */\r\n  has(token: InjectionToken<ServiceType>): boolean {\r\n    return this.map.has(token as symbol);\r\n  }\r\n\r\n  /**\r\n   * Removes a service registration.\r\n   *\r\n   * @param token - The injection token identifying the service\r\n   * @returns True if the service was found and removed\r\n   */\r\n  delete(token: InjectionToken<ServiceType>): boolean {\r\n    return this.map.delete(token as symbol);\r\n  }\r\n\r\n  /**\r\n   * Gets the number of registered services.\r\n   *\r\n   * @returns The count of registrations\r\n   */\r\n  get size(): number {\r\n    return this.map.size;\r\n  }\r\n\r\n  /**\r\n   * Removes all service registrations.\r\n   */\r\n  clear(): void {\r\n    this.map.clear();\r\n  }\r\n\r\n  /**\r\n   * Returns an iterator of all registration entries.\r\n   *\r\n   * @returns Iterator of [token, registration] pairs\r\n   */\r\n  entries(): IterableIterator<[symbol, ServiceRegistration<any>]> {\r\n    return this.map.entries();\r\n  }\r\n\r\n  /**\r\n   * Creates a shallow clone of this map.\r\n   * Used when child containers inherit registrations from parent.\r\n   *\r\n   * @returns A new TypeSafeRegistrationMap with cloned entries\r\n   */\r\n  clone(): TypeSafeRegistrationMap {\r\n    const cloned = new TypeSafeRegistrationMap();\r\n    this.map.forEach((value: ServiceRegistration<any>, key: symbol) => {\r\n      cloned.map.set(key, value);\r\n    });\r\n    return cloned;\r\n  }\r\n}\r\n","/**\r\n * Centralized helpers for a handful of runtime casts that are required by\r\n * the DI / cache / API infrastructure.\r\n *\r\n * Diese Datei ist absichtlich von der Type-Coverage ausgenommen, damit\r\n * wir an wenigen wohldokumentierten Stellen mit Runtime-Casts arbeiten\r\n * können, ohne den 100%-Anspruch für den restlichen Code zu verletzen.\r\n *\r\n * Diese Datei ist getrennt von `runtime-casts.ts` (Foundry-spezifische Casts),\r\n * da sie für die DI-Infrastruktur verwendet wird und ContainerError statt\r\n * FoundryError verwendet. Die Trennung ermöglicht klare Abhängigkeiten\r\n * und verhindert Import-Zyklen.\r\n */\r\n\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type {\r\n  RuntimeConfigKey,\r\n  RuntimeConfigValues,\r\n} from \"@/application/services/RuntimeConfigService\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { InjectionToken } from \"../core/injectiontoken\";\r\nimport type { ServiceRegistration } from \"../core/serviceregistration\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHookCallback } from \"@/infrastructure/adapters/foundry/types\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Listener-Typ aus RuntimeConfigService – hier als Alias erneut definiert,\r\n * um Import-Zyklen zu vermeiden.\r\n */\r\nexport type RuntimeConfigListener<K extends RuntimeConfigKey> = (\r\n  value: RuntimeConfigValues[K]\r\n) => void;\r\n\r\n/**\r\n * Hebt die Generik der Listener-Set-Instanz auf den gemeinsamen Key-Typ an.\r\n * Zur Laufzeit sind alle Listener gleichförmig, daher ist dieser Cast\r\n * rein für den TypeScript-Typchecker relevant.\r\n */\r\nexport function widenRuntimeConfigListeners<K extends RuntimeConfigKey>(\r\n  listeners: Set<RuntimeConfigListener<K>>\r\n): Set<RuntimeConfigListener<RuntimeConfigKey>> {\r\n  return listeners as Set<RuntimeConfigListener<RuntimeConfigKey>>;\r\n}\r\n\r\n/**\r\n * Hilfsfunktion für ReadOnly-Wrapper: konvertiert eine Schlüssel-Liste,\r\n * die als keyof T getypt ist, in ein string-Array für includes().\r\n */\r\nexport function toStringKeyArray<T extends Record<string, unknown>>(\r\n  allowed: readonly (keyof T)[]\r\n): readonly string[] {\r\n  return allowed as readonly string[];\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast vom Cache-Wert (unknown) auf den\r\n * erwarteten TValue. Die Typsicherheit wird durch die Aufrufer\r\n * (strukturierte Nutzung von CacheKeys) gewährleistet.\r\n */\r\nexport function castCacheValue<TValue>(value: unknown): TValue {\r\n  return value as TValue;\r\n}\r\n\r\n/**\r\n * Wrapper für I18nFacadeService im Module-API-Kontext.\r\n * Kapselt die notwendige Umwandlung von ServiceType → I18nFacadeService\r\n * und wieder zurück zu generischem TServiceType.\r\n */\r\nexport function wrapI18nService<TServiceType>(\r\n  service: TServiceType,\r\n  create: (i18n: I18nFacadeService) => I18nFacadeService\r\n): TServiceType {\r\n  const concrete = service as unknown as I18nFacadeService;\r\n  return create(concrete) as unknown as TServiceType;\r\n}\r\n\r\n/**\r\n * Entspricht wrapI18nService, aber für NotificationCenter.\r\n */\r\nexport function wrapNotificationCenterService<TServiceType>(\r\n  service: TServiceType,\r\n  create: (center: NotificationCenter) => NotificationCenter\r\n): TServiceType {\r\n  const concrete = service as unknown as NotificationCenter;\r\n  return create(concrete) as unknown as TServiceType;\r\n}\r\n\r\n/**\r\n * Entspricht wrapI18nService, aber für FoundrySettings.\r\n */\r\nexport function wrapFoundrySettingsPort<TServiceType>(\r\n  service: TServiceType,\r\n  create: (settings: FoundrySettings) => FoundrySettings\r\n): TServiceType {\r\n  const concrete = service as unknown as FoundrySettings;\r\n  return create(concrete) as unknown as TServiceType;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für gecachte Service-Instanzen.\r\n * Die Typsicherheit wird durch die Aufrufer gewährleistet, die sicherstellen,\r\n * dass der Token mit dem korrekten generischen Typ registriert wurde.\r\n *\r\n * @param instance - Die gecachte Service-Instanz (ServiceType union)\r\n * @returns Die Instanz als spezifischer generischer Typ\r\n */\r\nexport function castCachedServiceInstance<TServiceType extends ServiceType>(\r\n  instance: ServiceType | undefined\r\n): TServiceType | undefined {\r\n  return instance as TServiceType | undefined;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für gecachte Service-Instanzen in Result-Kontext.\r\n * Wird verwendet, wenn sichergestellt ist, dass die Instanz existiert.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass die Instanz nicht `undefined` ist. Bei Fehlern wird ein ContainerError\r\n * zurückgegeben statt einen Error zu werfen, um konsistent mit dem Result-Pattern\r\n * zu bleiben.\r\n *\r\n * @template TServiceType - Der spezifische Service-Typ\r\n * @param instance - Die gecachte Service-Instanz (ServiceType union oder undefined)\r\n * @returns Result mit der Instanz als spezifischer generischer Typ oder ContainerError\r\n *\r\n * @remarks\r\n * Diese Funktion sollte nur verwendet werden, wenn sichergestellt ist, dass\r\n * die Instanz im Cache existiert. Für optionale Instanzen sollte\r\n * `castCachedServiceInstance()` verwendet werden.\r\n *\r\n * @see {@link castCachedServiceInstance} Für optionale Service-Instanzen\r\n */\r\nexport function castCachedServiceInstanceForResult<TServiceType extends ServiceType>(\r\n  instance: ServiceType | undefined\r\n): Result<TServiceType, ContainerError> {\r\n  if (instance === undefined) {\r\n    return err({\r\n      code: \"TokenNotRegistered\",\r\n      message:\r\n        \"castCachedServiceInstanceForResult: instance must not be undefined. Use castCachedServiceInstance() for optional instances.\",\r\n      details: {},\r\n    });\r\n  }\r\n  return ok(instance as TServiceType);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für ServiceRegistration Map-Einträge.\r\n * Map.entries() verliert generische Typ-Information während der Iteration,\r\n * daher ist dieser Cast notwendig, um die korrekten Typen wiederherzustellen.\r\n *\r\n * @param token - Der Injection Token (symbol)\r\n * @param registration - Die ServiceRegistration (ServiceType union)\r\n * @returns Tuple mit typisierten Token und Registration\r\n */\r\nexport function castServiceRegistrationEntry(\r\n  token: symbol,\r\n  registration: ServiceRegistration<ServiceType>\r\n): [InjectionToken<ServiceType>, ServiceRegistration<ServiceType>] {\r\n  return [token as InjectionToken<ServiceType>, registration as ServiceRegistration<ServiceType>];\r\n}\r\n\r\n/**\r\n * Iteriert über ServiceRegistration Map-Einträge mit korrekter Typisierung.\r\n * Map.entries() verliert generische Typ-Information während der Iteration,\r\n * daher ist diese Funktion notwendig, um die korrekten Typen wiederherzustellen.\r\n *\r\n * @param entries - Die Map-Einträge (Iterable von [symbol, ServiceRegistration<ServiceType>])\r\n * @returns Iterable von typisierten [InjectionToken, ServiceRegistration] Tuples\r\n */\r\nexport function* iterateServiceRegistrationEntries(\r\n  entries: Iterable<[symbol, ServiceRegistration<ServiceType>]>\r\n): IterableIterator<[InjectionToken<ServiceType>, ServiceRegistration<ServiceType>]> {\r\n  for (const [token, registration] of entries) {\r\n    yield castServiceRegistrationEntry(token, registration);\r\n  }\r\n}\r\n\r\n/**\r\n * Extracts registration status from Result, with defensive fallback.\r\n *\r\n * This is a defensive check: isRegistered() should never fail in practice,\r\n * but the Result pattern requires handling the error case.\r\n *\r\n * @param result - Result from container.isRegistered()\r\n * @returns Registration status (true if registered, false on error)\r\n */\r\nexport function getRegistrationStatus(result: Result<boolean, ContainerError>): boolean {\r\n  return result.ok ? result.value : false;\r\n}\r\n\r\n/**\r\n * Safely gets the first element from an array that has been checked for length > 0.\r\n *\r\n * This helper encapsulates the non-null assertion for array access after a length check.\r\n * TypeScript requires this cast because it cannot infer that array[0] is defined\r\n * even when array.length > 0 has been verified.\r\n *\r\n * The caller must ensure that array.length > 0 before calling this function.\r\n *\r\n * @param array - Array that has been verified to have length > 0\r\n * @returns The first element of the array (guaranteed to be defined)\r\n */\r\nexport function getFirstArrayElement<T>(array: T[]): T {\r\n  // Type assertion is safe because caller must verify array.length > 0\r\n  return array[0] as T;\r\n}\r\n\r\n/**\r\n * Safely checks if a value is an array and returns its first element if it exists.\r\n *\r\n * This helper provides type-safe array access with a type guard check.\r\n * It returns null if the input is not an array or the array is empty.\r\n *\r\n * @param value - Unknown value that might be an array\r\n * @returns The first element of the array if it exists and is of type T, null otherwise\r\n */\r\nexport function getFirstElementIfArray<T>(\r\n  value: unknown,\r\n  typeGuard: (element: unknown) => element is T\r\n): T | null {\r\n  if (Array.isArray(value) && value.length > 0) {\r\n    const firstElement: unknown = value[0] as unknown;\r\n    if (typeGuard(firstElement)) {\r\n      return firstElement;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Casts a callback function to FoundryHookCallback.\r\n *\r\n * This is needed because TypeScript cannot infer that a generic callback\r\n * matches the FoundryHookCallback signature at the call site.\r\n * The caller must ensure the callback signature is compatible.\r\n *\r\n * @param callback - Callback function to cast\r\n * @returns The callback as FoundryHookCallback\r\n */\r\nexport function castToFoundryHookCallback(callback: unknown): FoundryHookCallback {\r\n  return callback as FoundryHookCallback;\r\n}\r\n\r\n/**\r\n * Type-safe assertion for CacheKey brand.\r\n *\r\n * This function encapsulates the brand assertion required for CacheKey.\r\n * The type safety is guaranteed by the structured usage of CacheKey creation\r\n * through createCacheKey() and the normalization process.\r\n *\r\n * @param value - The normalized string value to assert as CacheKey\r\n * @returns The value branded as CacheKey\r\n *\r\n * @example\r\n * ```typescript\r\n * const key = assertCacheKey(\"namespace:resource:id\");\r\n * ```\r\n */\r\nexport function assertCacheKey(\r\n  value: string\r\n): import(\"@/infrastructure/cache/cache.interface\").CacheKey {\r\n  return value as import(\"@/infrastructure/cache/cache.interface\").CacheKey;\r\n}\r\n\r\n/**\r\n * Safely casts an object to Record<string, unknown>.\r\n *\r\n * This function encapsulates the cast required when TypeScript cannot\r\n * narrow an object type to Record<string, unknown> even after runtime validation.\r\n * The caller must ensure that the value is an object before calling this function.\r\n *\r\n * @param value - The object value that has been validated as an object\r\n * @returns The value as Record<string, unknown>\r\n */\r\nexport function castToRecord(value: unknown): Record<string, unknown> {\r\n  return value as Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Safely normalizes an object to Record<string, unknown>.\r\n *\r\n * This function creates a new Record from an object, ensuring type safety.\r\n * The caller must ensure that the value is an object before calling this function.\r\n *\r\n * @param value - The object value that has been validated as an object\r\n * @returns A new Record<string, unknown> with the object's properties\r\n */\r\nexport function normalizeToRecord(value: unknown): Record<string, unknown> {\r\n  return Object.assign({}, value as Record<string, unknown>);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ServiceClass } from \"../types/resolution/serviceclass\";\r\nimport type { FactoryFunction } from \"../types/resolution/servicefactory\";\r\nimport type { ServiceDependencies } from \"../types/resolution/servicedependencies\";\r\nimport { ServiceLifecycle } from \"../types/core/servicelifecycle\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { TypeSafeRegistrationMap } from \"./TypeSafeRegistrationMap\";\r\nimport { iterateServiceRegistrationEntries } from \"../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Type for service classes that declare their dependencies.\r\n */\r\ntype ServiceClassWithDependencies<T extends ServiceType> = ServiceClass<T> & {\r\n  dependencies?: ReadonlyArray<InjectionToken<ServiceType>>;\r\n};\r\n\r\n/**\r\n * Type guard to check if a service class has a dependencies property.\r\n *\r\n * @template T - The service type\r\n * @param cls - The service class to check\r\n * @returns True if the class has a dependencies property\r\n */\r\nfunction hasDependencies<T extends ServiceType>(\r\n  cls: ServiceClass<T>\r\n): cls is ServiceClassWithDependencies<T> {\r\n  return \"dependencies\" in cls;\r\n}\r\n\r\n/**\r\n * Registry for service registrations.\r\n *\r\n * Responsibilities:\r\n * - Manage service registrations (add, retrieve, check existence)\r\n * - Validate registrations (no duplicates, valid values)\r\n * - Support cloning for child containers\r\n * - Enforce registration limits (DoS protection)\r\n *\r\n * This class does NOT handle:\r\n * - Service resolution (that's ServiceResolver's job)\r\n * - Dependency validation (that's ContainerValidator's job)\r\n */\r\nexport class ServiceRegistry {\r\n  private readonly MAX_REGISTRATIONS = 10000; // DoS protection: prevent unlimited registrations\r\n  private registrations = new TypeSafeRegistrationMap();\r\n  private lifecycleIndex = new Map<ServiceLifecycle, Set<InjectionToken<ServiceType>>>();\r\n\r\n  /**\r\n   * Updates the lifecycle index when a service is registered.\r\n   *\r\n   * @param token - The injection token\r\n   * @param lifecycle - The service lifecycle\r\n   */\r\n  private updateLifecycleIndex(\r\n    token: InjectionToken<ServiceType>,\r\n    lifecycle: ServiceLifecycle\r\n  ): void {\r\n    let tokenSet = this.lifecycleIndex.get(lifecycle);\r\n    if (!tokenSet) {\r\n      tokenSet = new Set();\r\n      this.lifecycleIndex.set(lifecycle, tokenSet);\r\n    }\r\n    tokenSet.add(token);\r\n  }\r\n\r\n  /**\r\n   * Registers a service class with automatic dependency injection.\r\n   *\r\n   * @template TServiceType - The type of service to register\r\n   * @param token - The injection token identifying this service\r\n   * @param serviceClass - The class to instantiate\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerClass<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    serviceClass: ServiceClass<TServiceType>,\r\n    lifecycle: ServiceLifecycle\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Validate serviceClass before using it\r\n    if (!serviceClass) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"serviceClass is required for class registration\",\r\n      });\r\n    }\r\n\r\n    const dependencies = hasDependencies(serviceClass) ? (serviceClass.dependencies ?? []) : [];\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createClass<TServiceType>(\r\n      lifecycle,\r\n      dependencies,\r\n      serviceClass\r\n    );\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, lifecycle);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers a factory function for creating service instances.\r\n   *\r\n   * @template TServiceType - The type of service this factory creates\r\n   * @param token - The injection token identifying this service\r\n   * @param factory - Factory function that creates instances\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of tokens this factory depends on\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerFactory<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    factory: FactoryFunction<TServiceType>,\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: ServiceDependencies\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createFactory<TServiceType>(\r\n      lifecycle,\r\n      dependencies,\r\n      factory\r\n    );\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, lifecycle);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers a constant value (always SINGLETON lifecycle).\r\n   *\r\n   * @template TServiceType - The type of value to register\r\n   * @param token - The injection token identifying this value\r\n   * @param value - The value to register\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerValue<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    value: TServiceType\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation (includes function check)\r\n    const registrationResult = ServiceRegistration.createValue<TServiceType>(value);\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, ServiceLifecycle.SINGLETON); // Values are always SINGLETON\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers an alias that points to another token.\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param aliasToken - The alias token\r\n   * @param targetToken - The token to resolve instead\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerAlias<TServiceType extends ServiceType>(\r\n    aliasToken: InjectionToken<TServiceType>,\r\n    targetToken: InjectionToken<TServiceType>\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(aliasToken)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(aliasToken)} already registered`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createAlias<TServiceType>(targetToken);\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(aliasToken, registrationResult.value);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a service registration.\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param token - The injection token identifying the service\r\n   * @returns The registration or undefined if not found\r\n   */\r\n  getRegistration<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): ServiceRegistration<TServiceType> | undefined {\r\n    return this.registrations.get(token);\r\n  }\r\n\r\n  /**\r\n   * Returns all registrations.\r\n   * Used by ContainerValidator for dependency validation.\r\n   *\r\n   * @returns Map of all registrations\r\n   */\r\n  getAllRegistrations(): Map<InjectionToken<ServiceType>, ServiceRegistration> {\r\n    return new Map(iterateServiceRegistrationEntries(this.registrations.entries())); // Defensive copy\r\n  }\r\n\r\n  /**\r\n   * Returns all registrations for a specific lifecycle.\r\n   * More efficient than filtering getAllRegistrations() when only one lifecycle is needed.\r\n   *\r\n   * @param lifecycle - The lifecycle to query\r\n   * @returns Array of registrations with the specified lifecycle\r\n   */\r\n  getRegistrationsByLifecycle(lifecycle: ServiceLifecycle): ServiceRegistration[] {\r\n    const tokens = this.lifecycleIndex.get(lifecycle) ?? new Set();\r\n    return Array.from(tokens)\r\n      .map((token) => this.registrations.get(token))\r\n      .filter((reg): reg is ServiceRegistration => reg !== undefined);\r\n  }\r\n\r\n  /**\r\n   * Checks if a service is registered.\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param token - The injection token to check\r\n   * @returns True if registered, false otherwise\r\n   */\r\n  has<TServiceType extends ServiceType>(token: InjectionToken<TServiceType>): boolean {\r\n    return this.registrations.has(token);\r\n  }\r\n\r\n  /**\r\n   * Clears all registrations.\r\n   * Warning: This removes all configured services.\r\n   */\r\n  clear(): void {\r\n    this.registrations.clear();\r\n    this.lifecycleIndex.clear();\r\n  }\r\n\r\n  /**\r\n   * Creates a deep clone of this registry for child containers.\r\n   *\r\n   * Important: Creates a new Map instance with cloned ServiceRegistration objects\r\n   * to prevent child containers from mutating parent registrations.\r\n   *\r\n   * @returns A new ServiceRegistry with cloned registrations\r\n   */\r\n  clone(): ServiceRegistry {\r\n    const clonedRegistry = new ServiceRegistry();\r\n\r\n    // Create new Map with cloned ServiceRegistration objects\r\n    for (const [token, registration] of iterateServiceRegistrationEntries(\r\n      this.registrations.entries()\r\n    )) {\r\n      clonedRegistry.registrations.set(token, registration.clone());\r\n    }\r\n\r\n    // Clone lifecycle index\r\n    for (const [lifecycle, tokens] of this.lifecycleIndex.entries()) {\r\n      clonedRegistry.lifecycleIndex.set(lifecycle, new Set(tokens));\r\n    }\r\n\r\n    return clonedRegistry;\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Validates service registrations and dependencies.\r\n *\r\n * Responsibilities:\r\n * - Check that all dependencies are registered\r\n * - Detect circular dependencies using DFS\r\n * - Validate alias targets exist\r\n *\r\n * Design:\r\n * - STATEFUL: Maintains cache for performance optimization\r\n * - Cache is cleared on each validate() call for fresh validation\r\n * - Returns aggregated errors for comprehensive feedback\r\n * - Can be extended later with granular validator components\r\n * - Performance optimization: Caches validated sub-graphs for large dependency trees (>500 services)\r\n *\r\n * Note: While this class has internal state, it can be shared between parent and child containers\r\n * because the cache is cleared on each validation run, preventing stale state issues.\r\n */\r\nexport class ContainerValidator {\r\n  // Performance optimization: Cache for validated sub-graphs\r\n  // Prevents redundant DFS traversals in large dependency trees (>500 services)\r\n  private validatedSubgraphs = new Set<InjectionToken<ServiceType>>();\r\n  /**\r\n   * Validates all registrations in the registry.\r\n   *\r\n   * Performs three checks:\r\n   * 1. All dependencies are registered\r\n   * 2. All alias targets exist\r\n   * 3. No circular dependencies\r\n   *\r\n   * @param registry - The service registry to validate\r\n   * @returns Result with void on success, or array of errors\r\n   */\r\n  validate(registry: ServiceRegistry): Result<void, ContainerError[]> {\r\n    // Clear cache for fresh validation\r\n    this.validatedSubgraphs = new Set<InjectionToken<ServiceType>>();\r\n\r\n    const errors: ContainerError[] = [\r\n      ...this.validateDependencies(registry),\r\n      ...this.validateAliasTargets(registry),\r\n      ...this.detectCircularDependencies(registry),\r\n    ];\r\n\r\n    return errors.length > 0 ? err(errors) : ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Checks that all declared dependencies are registered.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for missing dependencies\r\n   */\r\n  private validateDependencies(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const [token, registration] of registrations.entries()) {\r\n      for (const dep of registration.dependencies) {\r\n        if (!registry.has(dep)) {\r\n          errors.push({\r\n            code: \"TokenNotRegistered\",\r\n            message: `${String(token)} depends on ${String(dep)} which is not registered`,\r\n            tokenDescription: String(dep),\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Checks that all alias targets are registered.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for missing alias targets\r\n   */\r\n  private validateAliasTargets(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const [token, registration] of registrations.entries()) {\r\n      if (registration.providerType === \"alias\" && registration.aliasTarget) {\r\n        if (!registry.has(registration.aliasTarget)) {\r\n          errors.push({\r\n            code: \"AliasTargetNotFound\",\r\n            message: `Alias ${String(token)} points to ${String(registration.aliasTarget)} which is not registered`,\r\n            tokenDescription: String(registration.aliasTarget),\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Detects circular dependencies using depth-first search.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for detected cycles\r\n   */\r\n  private detectCircularDependencies(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const visited = new Set<InjectionToken<ServiceType>>();\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const token of registrations.keys()) {\r\n      const visiting = new Set<InjectionToken<ServiceType>>();\r\n      const path: InjectionToken<ServiceType>[] = [];\r\n\r\n      const error = this.checkCycleForToken(registry, token, visiting, visited, path);\r\n      if (error) {\r\n        errors.push(error);\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Recursively checks for cycles starting from a specific token.\r\n   *\r\n   * **Algorithm: Depth-First Search (DFS) with Three-Color Marking**\r\n   *\r\n   * Three states for each node (token):\r\n   * - WHITE (unvisited): Not in `visiting` or `visited` sets\r\n   * - GRAY (visiting): In `visiting` set (currently in DFS recursion stack)\r\n   * - BLACK (visited): In `visited` set (fully processed, all descendants checked)\r\n   *\r\n   * Cycle Detection:\r\n   * - If we encounter a GRAY node during traversal, we've found a back edge → cycle\r\n   * - GRAY nodes represent the current path from root to current node\r\n   * - Encountering a GRAY node means we're trying to visit an ancestor → circular dependency\r\n   *\r\n   * Performance Optimization:\r\n   * - `validatedSubgraphs` cache prevents redundant traversals of already-validated subtrees\r\n   * - Crucial for large dependency graphs (>500 services)\r\n   * - BLACK nodes can be safely skipped (all their descendants are cycle-free)\r\n   *\r\n   * Time Complexity: O(V + E) where V = number of services, E = number of dependencies\r\n   * Space Complexity: O(V) for visiting/visited sets + O(D) for recursion depth D\r\n   *\r\n   * @param registry - The service registry\r\n   * @param token - Current token being checked (current node in DFS)\r\n   * @param visiting - GRAY nodes: tokens currently in the DFS recursion stack\r\n   * @param visited - BLACK nodes: tokens fully processed in this validation run\r\n   * @param path - Current dependency path for error reporting (stack trace)\r\n   * @returns ContainerError if cycle detected, null otherwise\r\n   *\r\n   * @example\r\n   * Cycle A → B → C → A will be detected when:\r\n   * 1. Start at A (mark GRAY)\r\n   * 2. Visit B (mark GRAY)\r\n   * 3. Visit C (mark GRAY)\r\n   * 4. Try to visit A → A is GRAY → Back edge detected → Cycle!\r\n   */\r\n  private checkCycleForToken(\r\n    registry: ServiceRegistry,\r\n    token: InjectionToken<ServiceType>,\r\n    visiting: Set<InjectionToken<ServiceType>>,\r\n    visited: Set<InjectionToken<ServiceType>>,\r\n    path: InjectionToken<ServiceType>[]\r\n  ): ContainerError | null {\r\n    // GRAY node encountered: Back edge detected → Cycle exists\r\n    // This token is already in the current DFS path (visiting set)\r\n    // Example: A → B → C → A (when we reach A again from C)\r\n    if (visiting.has(token)) {\r\n      const cyclePath = [...path, token].map(String).join(\" → \");\r\n      return {\r\n        code: \"CircularDependency\",\r\n        message: `Circular dependency: ${cyclePath}`,\r\n        tokenDescription: String(token),\r\n      };\r\n    }\r\n\r\n    // Performance optimization: Skip already validated sub-graphs\r\n    // This token and all its descendants have been proven cycle-free\r\n    // Avoids redundant traversals in DAGs with shared dependencies\r\n    if (this.validatedSubgraphs.has(token)) {\r\n      return null;\r\n    }\r\n\r\n    // BLACK node: Already fully processed in this validation run\r\n    // All descendants of this token have been checked (no cycle below it)\r\n    // Cross edge or forward edge in DFS terminology\r\n    if (visited.has(token)) {\r\n      return null;\r\n    }\r\n\r\n    // Mark as GRAY: Add to current DFS path\r\n    // This token is now being visited (in recursion stack)\r\n    visiting.add(token);\r\n    path.push(token);\r\n\r\n    // DFS: Recursively check all dependencies (children in dependency graph)\r\n    // If any child has a cycle, propagate error up immediately\r\n    const registration = registry.getRegistration(token);\r\n    if (registration) {\r\n      for (const dep of registration.dependencies) {\r\n        const error = this.checkCycleForToken(registry, dep, visiting, visited, path);\r\n        if (error) return error; // Short-circuit: Stop on first cycle found\r\n      }\r\n    }\r\n\r\n    // Mark as BLACK: All descendants checked, no cycles found\r\n    // Remove from GRAY set (no longer in active DFS path)\r\n    // Add to BLACK set (fully processed, can be safely skipped in future)\r\n    visiting.delete(token);\r\n    path.pop();\r\n    visited.add(token);\r\n    this.validatedSubgraphs.add(token); // Cache for performance (persists across validation runs)\r\n\r\n    return null; // No cycle found in this subtree\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { castCachedServiceInstance } from \"../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Cache for service instances (Singleton and Scoped lifecycles).\r\n *\r\n * Responsibilities:\r\n * - Store and retrieve service instances by token\r\n * - Provide access to all instances for disposal\r\n * - Simple get/set/has/clear operations\r\n * - Track cache hits/misses for observability (when MetricsCollector is injected)\r\n *\r\n * Note: This class does NOT handle disposal logic - that's ScopeManager's responsibility.\r\n */\r\nexport class InstanceCache {\r\n  private instances = new Map<InjectionToken<ServiceType>, ServiceType>();\r\n  private metricsCollector: MetricsCollector | null = null;\r\n\r\n  /**\r\n   * Injects the MetricsCollector for cache hit/miss tracking.\r\n   * Called after container validation to enable observability.\r\n   *\r\n   * @param collector - The metrics collector instance\r\n   */\r\n  setMetricsCollector(collector: MetricsCollector): void {\r\n    this.metricsCollector = collector;\r\n  }\r\n\r\n  /**\r\n   * Retrieves a cached service instance.\r\n   *\r\n   * @template TServiceType - The type of service to retrieve\r\n   * @param token - The injection token identifying the service\r\n   * @returns The cached instance or undefined if not found\r\n   */\r\n  get<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): TServiceType | undefined {\r\n    const hasInstance = this.instances.has(token);\r\n    // Track cache access for observability (hit = instance found, miss = not found)\r\n    this.metricsCollector?.recordCacheAccess(hasInstance);\r\n    return castCachedServiceInstance<TServiceType>(this.instances.get(token));\r\n  }\r\n\r\n  /**\r\n   * Stores a service instance in the cache.\r\n   *\r\n   * @template TServiceType - The type of service to store\r\n   * @param token - The injection token identifying the service\r\n   * @param instance - The service instance to cache\r\n   */\r\n  set<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    instance: TServiceType\r\n  ): void {\r\n    this.instances.set(token, instance);\r\n  }\r\n\r\n  /**\r\n   * Checks if a service instance is cached.\r\n   *\r\n   * @template TServiceType - The type of service to check\r\n   * @param token - The injection token identifying the service\r\n   * @returns True if the instance is cached, false otherwise\r\n   */\r\n  has<TServiceType extends ServiceType>(token: InjectionToken<TServiceType>): boolean {\r\n    const hasInstance = this.instances.has(token);\r\n    // Track cache access for observability (hit = instance found, miss = not found)\r\n    this.metricsCollector?.recordCacheAccess(hasInstance);\r\n    return hasInstance;\r\n  }\r\n\r\n  /**\r\n   * Clears all cached instances.\r\n   * Note: Does not dispose instances - call getAllInstances() first if disposal is needed.\r\n   */\r\n  clear(): void {\r\n    this.instances.clear();\r\n  }\r\n\r\n  /**\r\n   * Returns all cached instances for disposal purposes.\r\n   * Used by ScopeManager to dispose Disposable services.\r\n   *\r\n   * @returns A map of all cached instances\r\n   */\r\n  getAllInstances(): Map<InjectionToken<ServiceType>, ServiceType> {\r\n    return new Map(this.instances);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport { InstanceCache } from \"../cache/InstanceCache\";\r\nimport { ServiceLifecycle } from \"../types/core/servicelifecycle\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { PerformanceTracker } from \"@/infrastructure/observability/performance-tracker.interface\";\r\nimport { castCachedServiceInstanceForResult } from \"../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Resolves service instances based on lifecycle and registration.\r\n *\r\n * Responsibilities:\r\n * - Resolve services by token\r\n * - Handle lifecycle strategies (Singleton, Transient, Scoped)\r\n * - Handle alias resolution\r\n * - Delegate to parent resolver for Singletons\r\n *\r\n * Design:\r\n * - Works with Result pattern (no throws)\r\n * - Wraps factory errors in FactoryFailedError\r\n * - Parent resolver for Singleton sharing across scopes\r\n * - PerformanceTracker injected via constructor (avoids circular dependency)\r\n * - MetricsCollector injected after container validation for metrics recording\r\n */\r\nexport class ServiceResolver {\r\n  private metricsCollector: MetricsCollector | null = null;\r\n\r\n  constructor(\r\n    private readonly registry: ServiceRegistry,\r\n    private readonly cache: InstanceCache,\r\n    private readonly parentResolver: ServiceResolver | null,\r\n    private readonly scopeName: string,\r\n    private readonly performanceTracker: PerformanceTracker\r\n  ) {}\r\n\r\n  /**\r\n   * Sets the MetricsCollector for metrics recording.\r\n   * Called by ServiceContainer after validation.\r\n   *\r\n   * @param collector - The metrics collector instance\r\n   */\r\n  setMetricsCollector(collector: MetricsCollector): void {\r\n    this.metricsCollector = collector;\r\n  }\r\n\r\n  /**\r\n   * Resolves a service by token.\r\n   *\r\n   * Handles:\r\n   * - Alias resolution (recursive)\r\n   * - Lifecycle-specific resolution (Singleton/Transient/Scoped)\r\n   * - Parent delegation for Singletons\r\n   * - Factory error wrapping\r\n   *\r\n   * Performance tracking is handled by the injected PerformanceTracker.\r\n   *\r\n   * @template TServiceType - The type of service to resolve\r\n   * @param token - The injection token identifying the service\r\n   * @returns Result with service instance or error\r\n   */\r\n  resolve<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    return this.performanceTracker.track(\r\n      () => {\r\n        // Check if service is registered\r\n        const registration = this.registry.getRegistration(token);\r\n        if (!registration) {\r\n          const stack = new Error().stack;\r\n          const error: ContainerError = {\r\n            code: \"TokenNotRegistered\",\r\n            message: `Service ${String(token)} not registered`,\r\n            tokenDescription: String(token),\r\n            ...(stack !== undefined && { stack }), // Only include stack if defined\r\n            timestamp: Date.now(),\r\n            containerScope: this.scopeName,\r\n          };\r\n          return err(error);\r\n        }\r\n\r\n        // Handle alias resolution\r\n        if (registration.providerType === \"alias\" && registration.aliasTarget) {\r\n          return this.resolve(registration.aliasTarget);\r\n        }\r\n\r\n        // Resolve based on lifecycle (all methods already return Result)\r\n        let result: Result<TServiceType, ContainerError>;\r\n\r\n        switch (registration.lifecycle) {\r\n          case ServiceLifecycle.SINGLETON:\r\n            result = this.resolveSingleton(token, registration);\r\n            break;\r\n\r\n          case ServiceLifecycle.TRANSIENT:\r\n            result = this.resolveTransient(token, registration);\r\n            break;\r\n\r\n          case ServiceLifecycle.SCOPED:\r\n            result = this.resolveScoped(token, registration);\r\n            break;\r\n\r\n          default:\r\n            // TypeScript exhaustive check: ensures all enum values are handled\r\n            const _exhaustiveCheck: never = registration.lifecycle;\r\n            result = err({\r\n              code: \"InvalidLifecycle\",\r\n              message: `Invalid service lifecycle: ${String(_exhaustiveCheck)}`,\r\n              tokenDescription: String(token),\r\n            });\r\n        }\r\n\r\n        return result;\r\n      },\r\n      (duration, result) => {\r\n        this.metricsCollector?.recordResolution(token, duration, result.ok);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Instantiates a service based on registration type.\r\n   *\r\n   * CRITICAL: Returns Result to preserve error context and avoid breaking Result-Contract.\r\n   * Handles dependency resolution for classes, direct factory calls, and value returns.\r\n   *\r\n   * @template TServiceType - The type of service to instantiate\r\n   * @param token - The injection token (used for error messages)\r\n   * @param registration - The service registration metadata\r\n   * @returns Result with instance or detailed error (DependencyResolveFailed, FactoryFailed, etc.)\r\n   */\r\n  private instantiateService<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    registration: ServiceRegistration<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    if (registration.serviceClass) {\r\n      // Class: Resolve all dependencies first\r\n      const resolvedDeps: ServiceType[] = [];\r\n\r\n      for (const dep of registration.dependencies) {\r\n        const depResult = this.resolve(dep);\r\n        if (!depResult.ok) {\r\n          // Return structured error with cause chain\r\n          return err({\r\n            code: \"DependencyResolveFailed\",\r\n            message: `Cannot resolve dependency ${String(dep)} for ${String(token)}`,\r\n            tokenDescription: String(dep),\r\n            cause: depResult.error,\r\n          });\r\n        }\r\n        resolvedDeps.push(depResult.value);\r\n      }\r\n\r\n      // Instantiate class with resolved dependencies\r\n      try {\r\n        return ok(new registration.serviceClass(...resolvedDeps));\r\n      } catch (constructorError) {\r\n        return err({\r\n          code: \"FactoryFailed\",\r\n          message: `Constructor failed for ${String(token)}: ${String(constructorError)}`,\r\n          tokenDescription: String(token),\r\n          cause: constructorError,\r\n        });\r\n      }\r\n    } else if (registration.factory) {\r\n      // Factory: Call directly\r\n      try {\r\n        return ok(registration.factory());\r\n      } catch (factoryError) {\r\n        return err({\r\n          code: \"FactoryFailed\",\r\n          message: `Factory failed for ${String(token)}: ${String(factoryError)}`,\r\n          tokenDescription: String(token),\r\n          cause: factoryError,\r\n        });\r\n      }\r\n    } else if (registration.value !== undefined) {\r\n      // Value: Return as-is\r\n      return ok(registration.value);\r\n    } else {\r\n      // Invalid registration\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: `Invalid registration for ${String(token)} - no class, factory, or value`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolves a Singleton service.\r\n   *\r\n   * Strategy:\r\n   * 1. Try parent resolver first (for shared parent singletons)\r\n   * 2. If parent returns error:\r\n   *    - CircularDependency → propagate error\r\n   *    - TokenNotRegistered → fallback to own cache (child-specific singleton)\r\n   * 3. Use own cache for root container or child-specific singletons\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param token - The injection token\r\n   * @param registration - The service registration\r\n   * @returns Result with instance or error\r\n   */\r\n  private resolveSingleton<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    registration: ServiceRegistration<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    // Try parent resolver first for shared singletons\r\n    if (this.parentResolver !== null) {\r\n      const parentResult = this.parentResolver.resolve(token);\r\n\r\n      if (parentResult.ok) {\r\n        // Parent has it - use parent's singleton instance (shared)\r\n        return parentResult;\r\n      }\r\n\r\n      // Check error code to determine action\r\n      if (parentResult.error.code === \"CircularDependency\") {\r\n        // Real circular dependency - propagate as-is\r\n        return parentResult;\r\n      }\r\n\r\n      // TokenNotRegistered or other error -> fallback to own cache\r\n      // This allows child-specific singleton registrations\r\n    }\r\n\r\n    // Root container OR parent doesn't have it: use own cache\r\n    if (!this.cache.has(token)) {\r\n      const instanceResult = this.instantiateService(token, registration);\r\n      if (!instanceResult.ok) {\r\n        return instanceResult; // Propagate error without wrapping\r\n      }\r\n      this.cache.set(token, instanceResult.value);\r\n    }\r\n\r\n    const instanceResult = castCachedServiceInstanceForResult<TServiceType>(this.cache.get(token));\r\n    if (!instanceResult.ok) {\r\n      return instanceResult; // Propagate error\r\n    }\r\n    return ok(instanceResult.value);\r\n  }\r\n\r\n  /**\r\n   * Resolves a Transient service.\r\n   *\r\n   * Strategy:\r\n   * - Always create new instance (no caching)\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param token - The injection token\r\n   * @param registration - The service registration\r\n   * @returns Result with new instance\r\n   */\r\n  private resolveTransient<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    registration: ServiceRegistration<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    return this.instantiateService(token, registration);\r\n  }\r\n\r\n  /**\r\n   * Resolves a Scoped service.\r\n   *\r\n   * ⚠️ IMPORTANT: Scoped services can ONLY be resolved in child containers.\r\n   * Attempting to resolve a scoped service in the root container will return\r\n   * a ScopeRequired error.\r\n   *\r\n   * Strategy:\r\n   * - Must be in child scope (not root)\r\n   * - One instance per scope (cached)\r\n   * - Each child scope gets its own isolated instance\r\n   *\r\n   * Use createScope() to create a child container before resolving scoped services.\r\n   *\r\n   * @template TServiceType - The type of service\r\n   * @param token - The injection token\r\n   * @param registration - The service registration\r\n   * @returns Result with scoped instance or ScopeRequired error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // ❌ WRONG: Trying to resolve scoped service in root\r\n   * const root = ServiceContainer.createRoot();\r\n   * root.registerClass(RequestToken, RequestContext, SCOPED);\r\n   * root.validate();\r\n   * const result = root.resolve(RequestToken); // Error: ScopeRequired\r\n   *\r\n   * // ✅ CORRECT: Create child scope first\r\n   * const child = root.createScope(\"request\").value!;\r\n   * child.validate(); // Child must validate separately\r\n   * const ctx = child.resolve(RequestToken); // OK\r\n   * ```\r\n   */\r\n  private resolveScoped<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    registration: ServiceRegistration<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    // Scoped services require a child scope\r\n    if (this.parentResolver === null) {\r\n      return err({\r\n        code: \"ScopeRequired\",\r\n        message: `Scoped service ${String(token)} requires a scope container. Use createScope() to create a child container first.`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Check cache (one instance per scope)\r\n    if (!this.cache.has(token)) {\r\n      const instanceResult = this.instantiateService(token, registration);\r\n      if (!instanceResult.ok) {\r\n        return instanceResult; // Propagate error\r\n      }\r\n      this.cache.set(token, instanceResult.value);\r\n    }\r\n\r\n    const instanceResult = castCachedServiceInstanceForResult<TServiceType>(this.cache.get(token));\r\n    if (!instanceResult.ok) {\r\n      return instanceResult; // Propagate error\r\n    }\r\n    return ok(instanceResult.value);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { Disposable, AsyncDisposable } from \"../interfaces\";\r\nimport { InstanceCache } from \"../cache/InstanceCache\";\r\nimport { ok, err, tryCatch, isErr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Helper function to generate unique scope names.\r\n * Tries crypto.randomUUID(), falls back to timestamp + random.\r\n */\r\nfunction generateScopeId(): string {\r\n  try {\r\n    return crypto.randomUUID();\r\n  } catch {\r\n    return Date.now() + \"-\" + Math.random();\r\n  }\r\n}\r\n\r\n/**\r\n * Manages scope hierarchy and disposal lifecycle.\r\n *\r\n * Responsibilities:\r\n * - Track child scopes in hierarchy\r\n * - Generate scope names\r\n * - Dispose instances (supports both Disposable and AsyncDisposable patterns)\r\n * - Cascade disposal to children\r\n * - Enforce maximum scope depth (stack overflow protection)\r\n *\r\n * Design:\r\n * - NO dependency on ServiceResolver (avoids circular dependency)\r\n * - createChild() returns data for facade to build new container\r\n * - Disposal order: children first, then instances (critical!)\r\n * - Supports both sync (dispose()) and async (disposeAsync()) disposal modes\r\n *\r\n * Disposal Modes:\r\n * - dispose(): Synchronous disposal (for browser unload, emergency cleanup)\r\n * - disposeAsync(): Asynchronous disposal (preferred, handles async cleanup properly)\r\n */\r\nexport class ScopeManager {\r\n  private readonly MAX_SCOPE_DEPTH = 10; // Prevent deep nesting and potential stack overflow\r\n  private children = new Set<ScopeManager>();\r\n  private disposed = false;\r\n  private readonly depth: number;\r\n  private readonly scopeId: string; // Unique correlation ID for tracing\r\n\r\n  constructor(\r\n    private readonly scopeName: string,\r\n    private readonly parent: ScopeManager | null,\r\n    private readonly cache: InstanceCache,\r\n    depth: number = 0\r\n  ) {\r\n    this.depth = depth;\r\n    // Generate unique correlation ID for this scope (useful for logging/tracing)\r\n    this.scopeId = `${scopeName}-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Creates a child scope manager.\r\n   *\r\n   * Note: Returns data (scopeName, cache, childManager) instead of full container\r\n   * to avoid circular dependency with ServiceResolver.\r\n   *\r\n   * @param name - Optional custom name for the scope\r\n   * @returns Result with child scope data or error if disposed or max depth exceeded\r\n   */\r\n  createChild(\r\n    name?: string\r\n  ): Result<{ scopeName: string; cache: InstanceCache; manager: ScopeManager }, ContainerError> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot create child scope from disposed scope: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Check maximum scope depth (stack overflow protection)\r\n    if (this.depth >= this.MAX_SCOPE_DEPTH) {\r\n      return err({\r\n        code: \"MaxScopeDepthExceeded\",\r\n        message: `Maximum scope depth of ${this.MAX_SCOPE_DEPTH} exceeded. Current depth: ${this.depth}`,\r\n      });\r\n    }\r\n\r\n    // Build hierarchical scope name\r\n    const uniqueId = name ?? `scope-${generateScopeId()}`;\r\n    const childScopeName = `${this.scopeName}.${uniqueId}`;\r\n\r\n    // Create new cache for child\r\n    const childCache = new InstanceCache();\r\n\r\n    // Create child manager with incremented depth\r\n    const childManager = new ScopeManager(childScopeName, this, childCache, this.depth + 1);\r\n\r\n    // Only add to children set AFTER successful creation\r\n    this.children.add(childManager);\r\n\r\n    return ok({\r\n      scopeName: childScopeName,\r\n      cache: childCache,\r\n      manager: childManager,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Disposes this scope and all child scopes.\r\n   *\r\n   * Disposal order (critical):\r\n   * 1. Recursively dispose all children\r\n   * 2. Dispose instances in this scope (if Disposable)\r\n   * 3. Clear instance cache\r\n   * 4. Remove from parent's children set\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  dispose(): Result<void, ContainerError> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Scope already disposed: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Mark as disposed BEFORE disposing children to prevent concurrent operations\r\n    this.disposed = true;\r\n\r\n    // Collect disposal errors instead of logging\r\n    const childDisposalErrors: Array<{ scopeName: string; error: ContainerError }> = [];\r\n\r\n    // Step 1: Recursively dispose all child scopes (children first!)\r\n    for (const child of this.children) {\r\n      const childResult = child.dispose();\r\n\r\n      if (isErr(childResult)) {\r\n        // Collect error instead of logging\r\n        childDisposalErrors.push({\r\n          scopeName: child.scopeName,\r\n          error: childResult.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Step 2: Dispose instances in this scope\r\n    const disposeResult = this.disposeInstances();\r\n    if (!disposeResult.ok) {\r\n      return disposeResult;\r\n    }\r\n\r\n    // Step 3: Clear cache\r\n    this.cache.clear();\r\n\r\n    // Step 4: Remove from parent's children set\r\n    if (this.parent !== null) {\r\n      this.parent.children.delete(this);\r\n    }\r\n\r\n    // Return aggregated errors if any children failed\r\n    if (childDisposalErrors.length > 0) {\r\n      return err({\r\n        code: \"PartialDisposal\",\r\n        message: `Failed to dispose ${childDisposalErrors.length} child scope(s)`,\r\n        details: childDisposalErrors,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Asynchronously disposes this scope and all child scopes.\r\n   *\r\n   * Preferred method for cleanup as it properly handles async dispose operations.\r\n   * Falls back to sync dispose() for services that only implement Disposable.\r\n   *\r\n   * Disposal order (critical):\r\n   * 1. Recursively dispose all children (async)\r\n   * 2. Dispose instances in this scope (async or sync)\r\n   * 3. Clear instance cache\r\n   * 4. Remove from parent's children set\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   */\r\n  async disposeAsync(): Promise<Result<void, ContainerError>> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Scope already disposed: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Mark as disposed BEFORE disposing children to prevent concurrent operations\r\n    this.disposed = true;\r\n\r\n    // Collect disposal errors instead of logging\r\n    const childDisposalErrors: Array<{ scopeName: string; error: ContainerError }> = [];\r\n\r\n    // Step 1: Recursively dispose all child scopes (children first!)\r\n    for (const child of this.children) {\r\n      const childResult = await child.disposeAsync();\r\n\r\n      if (isErr(childResult)) {\r\n        // Collect error instead of logging\r\n        childDisposalErrors.push({\r\n          scopeName: child.scopeName,\r\n          error: childResult.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Step 2: Dispose instances in this scope (async)\r\n    const disposeResult = await this.disposeInstancesAsync();\r\n    if (!disposeResult.ok) {\r\n      return disposeResult;\r\n    }\r\n\r\n    // Step 3: Clear cache\r\n    this.cache.clear();\r\n\r\n    // Step 4: Remove from parent's children set\r\n    if (this.parent !== null) {\r\n      this.parent.children.delete(this);\r\n    }\r\n\r\n    // Return aggregated errors if any children failed\r\n    if (childDisposalErrors.length > 0) {\r\n      return err({\r\n        code: \"PartialDisposal\",\r\n        message: `Failed to dispose ${childDisposalErrors.length} child scope(s)`,\r\n        details: childDisposalErrors,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Disposes all instances in the cache that implement Disposable (sync).\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  private disposeInstances(): Result<void, ContainerError> {\r\n    const instances = this.cache.getAllInstances();\r\n\r\n    for (const [token, instance] of instances.entries()) {\r\n      if (this.isDisposable(instance)) {\r\n        const result = tryCatch(\r\n          () => instance.dispose(),\r\n          (error): ContainerError => ({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          })\r\n        );\r\n\r\n        if (isErr(result)) {\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Disposes all instances in the cache that implement Disposable or AsyncDisposable (async).\r\n   * Prefers async disposal when available, falls back to sync.\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   */\r\n  private async disposeInstancesAsync(): Promise<Result<void, ContainerError>> {\r\n    const instances = this.cache.getAllInstances();\r\n\r\n    for (const [token, instance] of instances.entries()) {\r\n      // Try async disposal first (preferred)\r\n      if (this.isAsyncDisposable(instance)) {\r\n        try {\r\n          await instance.disposeAsync();\r\n        } catch (error) {\r\n          return err({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          });\r\n        }\r\n      }\r\n      // Fallback to sync disposal\r\n      else if (this.isDisposable(instance)) {\r\n        const disposableInstance = instance;\r\n        const result = tryCatch(\r\n          () => disposableInstance.dispose(),\r\n          (error): ContainerError => ({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          })\r\n        );\r\n\r\n        if (isErr(result)) {\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Type guard to check if an instance implements the Disposable pattern.\r\n   *\r\n   * @param instance - The service instance to check\r\n   * @returns True if instance has dispose() method\r\n   */\r\n  private isDisposable(instance: ServiceType): instance is ServiceType & Disposable {\r\n    return (\r\n      \"dispose\" in instance &&\r\n      // Narrowing via Partial so we can check dispose presence without full interface\r\n      typeof (instance as Partial<Disposable>).dispose === \"function\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Type guard to check if an instance implements the AsyncDisposable pattern.\r\n   *\r\n   * @param instance - The service instance to check\r\n   * @returns True if instance has disposeAsync() method\r\n   */\r\n  private isAsyncDisposable(instance: ServiceType): instance is ServiceType & AsyncDisposable {\r\n    return (\r\n      \"disposeAsync\" in instance &&\r\n      // Narrowing via Partial so we can check disposeAsync presence without full interface\r\n      typeof (instance as { disposeAsync?: unknown }).disposeAsync === \"function\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Checks if this scope is disposed.\r\n   *\r\n   * @returns True if disposed, false otherwise\r\n   */\r\n  isDisposed(): boolean {\r\n    return this.disposed;\r\n  }\r\n\r\n  /**\r\n   * Gets the hierarchical scope name.\r\n   *\r\n   * @returns The scope name (e.g., \"root.child1.grandchild\")\r\n   */\r\n  getScopeName(): string {\r\n    return this.scopeName;\r\n  }\r\n\r\n  /**\r\n   * Gets the unique correlation ID for this scope.\r\n   *\r\n   * Useful for tracing and logging in distributed/concurrent scenarios.\r\n   * Each scope gets a unique ID combining name, timestamp, and random string.\r\n   *\r\n   * @returns The unique scope ID (e.g., \"root-1730761234567-abc123\")\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const scope = container.createScope(\"request\").value!;\r\n   * logger.info(`[${scope.getScopeId()}] Processing request`);\r\n   * ```\r\n   */\r\n  getScopeId(): string {\r\n    return this.scopeId;\r\n  }\r\n}\r\n","/**\r\n * Promise timeout utility.\r\n * Wraps a promise with a timeout, rejecting if the promise doesn't resolve in time.\r\n */\r\n\r\n/**\r\n * Error thrown when a promise times out.\r\n */\r\nexport class TimeoutError extends Error {\r\n  constructor(timeoutMs: number) {\r\n    super(`Operation timed out after ${timeoutMs}ms`);\r\n    this.name = \"TimeoutError\";\r\n  }\r\n}\r\n\r\n/**\r\n * Wraps a promise with a timeout.\r\n *\r\n * If the promise doesn't resolve/reject within the specified time,\r\n * it rejects with a TimeoutError.\r\n *\r\n * @template T - Type of the promise result\r\n * @param promise - Promise to wrap\r\n * @param timeoutMs - Timeout in milliseconds\r\n * @returns Promise that rejects with TimeoutError if timeout is exceeded\r\n *\r\n * @example\r\n * ```typescript\r\n * try {\r\n *   const result = await withTimeout(fetchData(), 5000);\r\n *   console.log(\"Got result:\", result);\r\n * } catch (error) {\r\n *   if (error instanceof TimeoutError) {\r\n *     console.error(\"Operation timed out\");\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport function withTimeout<T>(promise: Promise<T>, timeoutMs: number): Promise<T> {\r\n  let timeoutHandle: NodeJS.Timeout | null = null;\r\n\r\n  const timeoutPromise = new Promise<T>((_, reject) => {\r\n    timeoutHandle = setTimeout(() => {\r\n      reject(new TimeoutError(timeoutMs));\r\n    }, timeoutMs);\r\n  });\r\n\r\n  return Promise.race([\r\n    promise.finally(() => {\r\n      // Clear timeout when promise settles (either resolves or rejects)\r\n      // This prevents the timeout from firing after the promise is already settled\r\n      if (timeoutHandle !== null) {\r\n        clearTimeout(timeoutHandle);\r\n      }\r\n    }),\r\n    timeoutPromise,\r\n  ]);\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Log level enumeration for controlling logging verbosity.\r\n * Lower numeric values = more verbose.\r\n */\r\nexport enum LogLevel {\r\n  DEBUG = 0,\r\n  INFO = 1,\r\n  WARN = 2,\r\n  ERROR = 3,\r\n}\r\n\r\n/**\r\n * Environment configuration for the application.\r\n * Provides environment-specific settings that can be configured via build-time variables.\r\n */\r\nexport interface EnvironmentConfig {\r\n  /** True if running in development mode */\r\n  isDevelopment: boolean;\r\n\r\n  /** True if running in production mode */\r\n  isProduction: boolean;\r\n\r\n  /** Minimum log level to output */\r\n  logLevel: LogLevel;\r\n\r\n  /** Enable performance tracking and metrics */\r\n  enablePerformanceTracking: boolean;\r\n\r\n  /** Enable persistence of metrics between sessions */\r\n  enableMetricsPersistence: boolean;\r\n\r\n  /** Storage key for persisted metrics */\r\n  metricsPersistenceKey: string;\r\n\r\n  /**\r\n   * Performance sampling rate for production environments (0.0 to 1.0).\r\n   * 0.01 = 1% sampling, 1.0 = 100% sampling.\r\n   * Reduces performance overhead in production by only tracking a percentage of operations.\r\n   * @default 0.01 (1% sampling in production)\r\n   */\r\n  performanceSamplingRate: number;\r\n\r\n  /** Enable module-level caching */\r\n  enableCacheService: boolean;\r\n\r\n  /** Default TTL for CacheService entries */\r\n  cacheDefaultTtlMs: number;\r\n\r\n  /** Optional maximum number of cached entries */\r\n  cacheMaxEntries?: number | undefined;\r\n}\r\n\r\n/**\r\n * Safely parses a sampling rate from an environment variable.\r\n * Ensures the value is a valid number between 0 and 1.\r\n *\r\n * @param envValue - Environment variable value to parse\r\n * @param fallback - Fallback value if parsing fails\r\n * @returns Valid sampling rate between 0.0 and 1.0\r\n * @internal Exported for testing\r\n */\r\nexport function parseSamplingRate(envValue: string | undefined, fallback: number): number {\r\n  const raw = parseFloat(envValue ?? String(fallback));\r\n  // Check if valid number and clamp to [0, 1] range\r\n  return Number.isFinite(raw) ? Math.min(1, Math.max(0, raw)) : fallback;\r\n}\r\n\r\nfunction parseNonNegativeNumber(envValue: string | undefined, fallback: number): number {\r\n  const parsed = Number(envValue);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallback;\r\n  }\r\n  return parsed < 0 ? fallback : parsed;\r\n}\r\n\r\nfunction parseOptionalPositiveInteger(envValue: string | undefined): number | undefined {\r\n  if (!envValue) {\r\n    return undefined;\r\n  }\r\n  const parsed = Number(envValue);\r\n  if (!Number.isFinite(parsed) || parsed <= 0) {\r\n    return undefined;\r\n  }\r\n  return Math.floor(parsed);\r\n}\r\n\r\n/**\r\n * Type-safe wrapper for accessing Vite environment variables.\r\n *\r\n * Vite's import.meta.env is available at build-time, but TypeScript\r\n * cannot infer the types for dynamic property access. This wrapper\r\n * provides type-safe access with explicit parsing.\r\n *\r\n * @param key - The environment variable key (e.g., 'VITE_CACHE_MAX_ENTRIES')\r\n * @param parser - Function to parse the string value to the desired type\r\n * @returns The parsed value of type T\r\n *\r\n * @example\r\n * ```typescript\r\n * const maxEntries = getEnvVar('VITE_CACHE_MAX_ENTRIES', parseOptionalPositiveInteger);\r\n * ```\r\n */\r\nfunction getEnvVar<T>(key: string, parser: (val: string | undefined) => T): T {\r\n  // Access import.meta.env dynamically - type is string | undefined at runtime\r\n  const value = (import.meta.env as Record<string, string | undefined>)[key];\r\n  return parser(value);\r\n}\r\n\r\n/**\r\n * Current environment configuration.\r\n * Reads from Vite environment variables (import.meta.env).\r\n */\r\nconst parsedCacheMaxEntries = getEnvVar(\"VITE_CACHE_MAX_ENTRIES\", parseOptionalPositiveInteger);\r\n\r\nexport const ENV: EnvironmentConfig = {\r\n  isDevelopment: import.meta.env.MODE === \"development\",\r\n  isProduction: import.meta.env.MODE === \"production\",\r\n  logLevel: import.meta.env.MODE === \"development\" ? LogLevel.DEBUG : LogLevel.INFO,\r\n  enablePerformanceTracking: import.meta.env.VITE_ENABLE_PERF_TRACKING === \"true\",\r\n  enableMetricsPersistence: getEnvVar(\"VITE_ENABLE_METRICS_PERSISTENCE\", (val) => val === \"true\"),\r\n  metricsPersistenceKey: getEnvVar(\r\n    \"VITE_METRICS_PERSISTENCE_KEY\",\r\n    (val) => val ?? \"fvtt_relationship_app_module.metrics\"\r\n  ),\r\n  // 1% sampling in production, 100% in development\r\n  performanceSamplingRate:\r\n    import.meta.env.MODE === \"production\"\r\n      ? parseSamplingRate(import.meta.env.VITE_PERF_SAMPLING_RATE, 0.01)\r\n      : 1.0,\r\n  enableCacheService: getEnvVar(\"VITE_CACHE_ENABLED\", (val) =>\r\n    val === undefined ? true : val === \"true\"\r\n  ),\r\n  cacheDefaultTtlMs: getEnvVar(\"VITE_CACHE_TTL_MS\", (val) =>\r\n    parseNonNegativeNumber(val, MODULE_CONSTANTS.DEFAULTS.CACHE_TTL_MS)\r\n  ),\r\n  ...(parsedCacheMaxEntries !== undefined ? { cacheMaxEntries: parsedCacheMaxEntries } : {}),\r\n};\r\n","/**\r\n * Shared performance tracker implementation.\r\n *\r\n * This base class contains the common logic used by both:\r\n * - BootstrapPerformanceTracker (bootstrap phase, no DI)\r\n * - PerformanceTrackingService (production phase, with DI)\r\n *\r\n * **Design Rationale:**\r\n * - Eliminates code duplication between bootstrap and production trackers\r\n * - Both implementations share identical tracking logic\r\n * - Only difference is how they're instantiated (direct vs DI)\r\n *\r\n * @see PerformanceTracker interface\r\n * @see BootstrapPerformanceTracker for bootstrap usage\r\n * @see PerformanceTrackingService for DI-based usage\r\n */\r\n\r\nimport type { PerformanceTracker } from \"@/infrastructure/observability/performance-tracker.interface\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport type { MetricsSampler } from \"./interfaces/metrics-sampler\";\r\n\r\n/**\r\n * Base implementation of PerformanceTracker with shared logic.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Extend in subclasses\r\n * export class MyTracker extends PerformanceTrackerImpl {\r\n *   static dependencies = [envToken, metricsToken] as const;\r\n *   // DI dependencies handled by subclass\r\n * }\r\n * ```\r\n */\r\nexport class PerformanceTrackerImpl implements PerformanceTracker {\r\n  /**\r\n   * Creates a performance tracker implementation.\r\n   *\r\n   * @param env - Environment configuration for tracking settings\r\n   * @param sampler - Optional metrics sampler for sampling decisions (null during early bootstrap)\r\n   */\r\n  constructor(\r\n    protected readonly config: RuntimeConfigService,\r\n    protected readonly sampler: MetricsSampler | null\r\n  ) {}\r\n\r\n  /**\r\n   * Tracks synchronous operation execution time.\r\n   *\r\n   * Only measures when:\r\n   * 1. Performance tracking is enabled (env.enablePerformanceTracking)\r\n   * 2. MetricsCollector is available\r\n   * 3. Sampling check passes (metricsCollector.shouldSample())\r\n   *\r\n   * @template T - Return type of the operation\r\n   * @param operation - Function to execute and measure\r\n   * @param onComplete - Optional callback invoked with duration and result\r\n   * @returns Result of the operation\r\n   */\r\n  track<T>(operation: () => T, onComplete?: (duration: number, result: T) => void): T {\r\n    // Early exit if performance tracking is disabled or sampling fails\r\n    if (!this.config.get(\"enablePerformanceTracking\") || !this.sampler?.shouldSample()) {\r\n      return operation();\r\n    }\r\n\r\n    const startTime = performance.now();\r\n    const result = operation();\r\n    const duration = performance.now() - startTime;\r\n\r\n    if (onComplete) {\r\n      onComplete(duration, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Tracks asynchronous operation execution time.\r\n   *\r\n   * Only measures when:\r\n   * 1. Performance tracking is enabled (env.enablePerformanceTracking)\r\n   * 2. MetricsCollector is available\r\n   * 3. Sampling check passes (metricsCollector.shouldSample())\r\n   *\r\n   * @template T - Return type of the async operation\r\n   * @param operation - Async function to execute and measure\r\n   * @param onComplete - Optional callback invoked with duration and result\r\n   * @returns Promise resolving to the operation result\r\n   */\r\n  async trackAsync<T>(\r\n    operation: () => Promise<T>,\r\n    onComplete?: (duration: number, result: T) => void\r\n  ): Promise<T> {\r\n    // Early exit if performance tracking is disabled or sampling fails\r\n    if (!this.config.get(\"enablePerformanceTracking\") || !this.sampler?.shouldSample()) {\r\n      return operation();\r\n    }\r\n\r\n    const startTime = performance.now();\r\n    const result = await operation();\r\n    const duration = performance.now() - startTime;\r\n\r\n    if (onComplete) {\r\n      onComplete(duration, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n}\r\n","/**\r\n * Lightweight performance tracker for bootstrap phase.\r\n *\r\n * This implementation is used during container initialization to avoid circular dependencies.\r\n * Unlike PerformanceTrackingService, it does NOT use dependency injection and can be\r\n * instantiated directly with its dependencies.\r\n *\r\n * **Design Rationale:**\r\n * - ServiceResolver needs performance tracking during bootstrap\r\n * - PerformanceTrackingService cannot be used (circular dependency)\r\n * - Solution: Lightweight tracker that extends shared implementation\r\n *\r\n * **Usage:**\r\n * - Bootstrap phase only (ServiceContainer.createRoot)\r\n * - Direct instantiation (no DI)\r\n * - Same behavior as PerformanceTrackingService\r\n *\r\n * @see PerformanceTracker interface\r\n * @see PerformanceTrackingService for full-featured DI-based implementation\r\n * @see PerformanceTrackerImpl for shared implementation\r\n */\r\n\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport type { MetricsSampler } from \"./interfaces/metrics-sampler\";\r\nimport { PerformanceTrackerImpl } from \"@/infrastructure/observability/performance-tracker-impl\";\r\n\r\n/**\r\n * Bootstrap-phase implementation of PerformanceTracker.\r\n *\r\n * Extends the shared PerformanceTrackerImpl base class to eliminate code duplication.\r\n *\r\n * @example\r\n * ```typescript\r\n * // During bootstrap (no DI available yet)\r\n * const tracker = new BootstrapPerformanceTracker(env, metricsCollector);\r\n * const resolver = new ServiceResolver(registry, cache, null, \"root\", tracker);\r\n * ```\r\n */\r\nexport class BootstrapPerformanceTracker extends PerformanceTrackerImpl {\r\n  /**\r\n   * Creates a bootstrap performance tracker.\r\n   *\r\n   * @param env - Environment configuration for tracking settings\r\n   * @param sampler - Optional metrics sampler for sampling decisions (null during early bootstrap)\r\n   */\r\n  constructor(config: RuntimeConfigService, sampler: MetricsSampler | null) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n","import type { EnvironmentConfig, LogLevel } from \"@/framework/config/environment\";\r\nimport { widenRuntimeConfigListeners } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\nexport type RuntimeConfigValues = {\r\n  isDevelopment: boolean;\r\n  isProduction: boolean;\r\n  logLevel: LogLevel;\r\n  enablePerformanceTracking: boolean;\r\n  performanceSamplingRate: number;\r\n  enableMetricsPersistence: boolean;\r\n  metricsPersistenceKey: string;\r\n  enableCacheService: boolean;\r\n  cacheDefaultTtlMs: number;\r\n  cacheMaxEntries: number | undefined;\r\n};\r\n\r\nexport type RuntimeConfigKey = keyof RuntimeConfigValues;\r\n\r\ntype RuntimeConfigListener<K extends RuntimeConfigKey> = (value: RuntimeConfigValues[K]) => void;\r\n\r\n/**\r\n * RuntimeConfigService\r\n *\r\n * Acts as a bridge between build-time environment defaults (VITE_*) and\r\n * runtime Foundry settings. Provides a central registry that services can\r\n * query for current values and subscribe to for live updates.\r\n */\r\nexport class RuntimeConfigService {\r\n  private readonly values: RuntimeConfigValues;\r\n  private readonly listeners = new Map<\r\n    RuntimeConfigKey,\r\n    Set<RuntimeConfigListener<RuntimeConfigKey>>\r\n  >();\r\n\r\n  constructor(env: EnvironmentConfig) {\r\n    this.values = {\r\n      isDevelopment: env.isDevelopment,\r\n      isProduction: env.isProduction,\r\n      logLevel: env.logLevel,\r\n      enablePerformanceTracking: env.enablePerformanceTracking,\r\n      performanceSamplingRate: env.performanceSamplingRate,\r\n      enableMetricsPersistence: env.enableMetricsPersistence,\r\n      metricsPersistenceKey: env.metricsPersistenceKey,\r\n      enableCacheService: env.enableCacheService,\r\n      cacheDefaultTtlMs: env.cacheDefaultTtlMs,\r\n      cacheMaxEntries: env.cacheMaxEntries,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Returns the current value for the given configuration key.\r\n   */\r\n  get<K extends RuntimeConfigKey>(key: K): RuntimeConfigValues[K] {\r\n    return this.values[key];\r\n  }\r\n\r\n  /**\r\n   * Updates the configuration value based on Foundry settings and notifies listeners\r\n   * only if the value actually changed.\r\n   */\r\n  setFromFoundry<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void {\r\n    this.updateValue(key, value);\r\n  }\r\n\r\n  /**\r\n   * Registers a listener for the given key. Returns an unsubscribe function.\r\n   */\r\n  onChange<K extends RuntimeConfigKey>(key: K, listener: RuntimeConfigListener<K>): () => void {\r\n    const existing = this.listeners.get(key) as Set<RuntimeConfigListener<K>> | undefined;\r\n    const listeners: Set<RuntimeConfigListener<K>> =\r\n      existing ?? new Set<RuntimeConfigListener<K>>();\r\n    listeners.add(listener);\r\n    this.listeners.set(key, widenRuntimeConfigListeners(listeners));\r\n\r\n    return () => {\r\n      const activeListeners = this.listeners.get(key) as Set<RuntimeConfigListener<K>> | undefined;\r\n      activeListeners?.delete(listener);\r\n      if (!activeListeners || activeListeners.size === 0) {\r\n        this.listeners.delete(key);\r\n      }\r\n    };\r\n  }\r\n\r\n  private updateValue<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void {\r\n    const current = this.values[key];\r\n    if (Object.is(current, value)) {\r\n      return;\r\n    }\r\n\r\n    this.values[key] = value;\r\n    const listeners = this.listeners.get(key) as Set<RuntimeConfigListener<K>> | undefined;\r\n    if (!listeners || listeners.size === 0) {\r\n      return;\r\n    }\r\n\r\n    for (const listener of listeners) {\r\n      listener(value);\r\n    }\r\n  }\r\n}\r\n","import type { EnvironmentConfig } from \"@/framework/config/environment\";\r\nimport { RuntimeConfigService } from \"./RuntimeConfigService\";\r\n\r\n/**\r\n * Factory function for creating RuntimeConfigService instances.\r\n *\r\n * Centralizes the creation of RuntimeConfigService to follow the Dependency Inversion Principle (DIP).\r\n * This allows for easier testing (mocking) and future extensions (caching, pooling, etc.).\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\n * import { ENV } from \"@/framework/config/environment\";\r\n *\r\n * const config = createRuntimeConfig(ENV);\r\n * ```\r\n *\r\n * @param env - The environment configuration to use\r\n * @returns A new RuntimeConfigService instance\r\n */\r\nexport function createRuntimeConfig(env: EnvironmentConfig): RuntimeConfigService {\r\n  return new RuntimeConfigService(env);\r\n}\r\n","import type { InjectionToken } from \"./types/core/injectiontoken\";\r\nimport type { FactoryFunction } from \"./types/resolution/servicefactory\";\r\nimport type { ServiceClass } from \"./types/resolution/serviceclass\";\r\nimport type { ServiceDependencies } from \"./types/resolution/servicedependencies\";\r\nimport type { ContainerValidationState } from \"./types/errors/containervalidationstate\";\r\nimport type { ApiSafeToken } from \"./types/utilities/api-safe-token\";\r\nimport { isApiSafeTokenRuntime } from \"./types/utilities/api-safe-token\";\r\nimport { ServiceLifecycle } from \"./types/core/servicelifecycle\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport { ok, err, isOk } from \"@/infrastructure/shared/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { Container } from \"./interfaces\";\r\nimport type { ContainerError } from \"./interfaces\";\r\nimport { ServiceRegistry } from \"./registry/ServiceRegistry\";\r\nimport { ContainerValidator } from \"./validation/ContainerValidator\";\r\nimport { InstanceCache } from \"./cache/InstanceCache\";\r\nimport { ServiceResolver } from \"./resolution/ServiceResolver\";\r\nimport { ScopeManager } from \"./scope/ScopeManager\";\r\nimport { withTimeout, TimeoutError } from \"@/infrastructure/shared/utils/promise-timeout\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { BootstrapPerformanceTracker } from \"@/infrastructure/observability/bootstrap-performance-tracker\";\r\nimport { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Dependency injection container (Facade pattern).\r\n *\r\n * Delegates to specialized components:\r\n * - ServiceRegistry: manages registrations\r\n * - ContainerValidator: validates dependencies\r\n * - InstanceCache: caches instances\r\n * - ServiceResolver: resolves services\r\n * - ScopeManager: manages lifecycle and disposal\r\n *\r\n * **Scope Chain Behavior:**\r\n * When a parent container is disposed, all child containers are automatically disposed.\r\n * This ensures proper cleanup of resources across the container hierarchy.\r\n *\r\n * **Architecture:**\r\n * This is a Facade that coordinates specialized components, adhering to Single Responsibility Principle.\r\n * Each component has a focused responsibility, making the system testable and maintainable.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Basic usage\r\n * const container = ServiceContainer.createRoot();\r\n * container.registerClass(LoggerToken, Logger, ServiceLifecycle.SINGLETON);\r\n * container.validate();\r\n * const logger = container.resolve(LoggerToken);\r\n * ```\r\n *\r\n * @example\r\n * ```typescript\r\n * // Scope chain with cascading disposal\r\n * const root = ServiceContainer.createRoot();\r\n * root.validate();\r\n * const child1 = root.createScope(\"child1\").value!;\r\n * const child2 = root.createScope(\"child2\").value!;\r\n *\r\n * // Disposing root automatically disposes all children\r\n * root.dispose();\r\n * ```\r\n */\r\nexport class ServiceContainer implements Container {\r\n  private registry: ServiceRegistry;\r\n  private validator: ContainerValidator;\r\n  private cache: InstanceCache;\r\n  private resolver: ServiceResolver;\r\n  private scopeManager: ScopeManager;\r\n  private validationState: ContainerValidationState;\r\n  private validationPromise: Promise<Result<void, ContainerError[]>> | null = null;\r\n\r\n  /**\r\n   * Private constructor - use ServiceContainer.createRoot() instead.\r\n   *\r\n   * This constructor is private to:\r\n   * - Enforce factory pattern usage\r\n   * - Prevent constructor throws (Result-Contract-breaking)\r\n   * - Make child creation explicit through createScope()\r\n   *\r\n   * @param registry - Service registry\r\n   * @param validator - Container validator (shared for parent/child)\r\n   * @param cache - Instance cache\r\n   * @param resolver - Service resolver\r\n   * @param scopeManager - Scope manager\r\n   * @param validationState - Initial validation state\r\n   */\r\n  private constructor(\r\n    registry: ServiceRegistry,\r\n    validator: ContainerValidator,\r\n    cache: InstanceCache,\r\n    resolver: ServiceResolver,\r\n    scopeManager: ScopeManager,\r\n    validationState: ContainerValidationState\r\n  ) {\r\n    this.registry = registry;\r\n    this.validator = validator;\r\n    this.cache = cache;\r\n    this.resolver = resolver;\r\n    this.scopeManager = scopeManager;\r\n    this.validationState = validationState;\r\n  }\r\n\r\n  /**\r\n   * Creates a new root container.\r\n   *\r\n   * This is the preferred way to create containers.\r\n   * All components are created fresh for the root container.\r\n   *\r\n   * **Bootstrap Performance Tracking:**\r\n   * Uses BootstrapPerformanceTracker with RuntimeConfigService(ENV) und null MetricsCollector.\r\n   * MetricsCollector is injected later via setMetricsCollector() after validation.\r\n   *\r\n   * @returns A new root ServiceContainer\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const container = ServiceContainer.createRoot();\r\n   * container.registerClass(LoggerToken, Logger, SINGLETON);\r\n   * container.validate();\r\n   * ```\r\n   */\r\n  static createRoot(): ServiceContainer {\r\n    const registry = new ServiceRegistry();\r\n    const validator = new ContainerValidator();\r\n    const cache = new InstanceCache();\r\n    const scopeManager = new ScopeManager(\"root\", null, cache);\r\n\r\n    // Bootstrap performance tracker (no MetricsCollector yet)\r\n    const performanceTracker = new BootstrapPerformanceTracker(createRuntimeConfig(ENV), null);\r\n    const resolver = new ServiceResolver(registry, cache, null, \"root\", performanceTracker);\r\n\r\n    return new ServiceContainer(registry, validator, cache, resolver, scopeManager, \"registering\");\r\n  }\r\n\r\n  /**\r\n   * Register a service class with automatic dependency injection.\r\n   */\r\n  registerClass<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    serviceClass: ServiceClass<TServiceType>,\r\n    lifecycle: ServiceLifecycle\r\n  ): Result<void, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.validationState === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerClass(token, serviceClass, lifecycle);\r\n  }\r\n\r\n  /**\r\n   * Register a factory function.\r\n   */\r\n  registerFactory<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    factory: FactoryFunction<TServiceType>,\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: ServiceDependencies\r\n  ): Result<void, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.validationState === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    // Validate factory parameter\r\n    if (!factory || typeof factory !== \"function\") {\r\n      return err({\r\n        code: \"InvalidFactory\",\r\n        message: \"Factory must be a function\",\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    return this.registry.registerFactory(token, factory, lifecycle, dependencies);\r\n  }\r\n\r\n  /**\r\n   * Register a constant value.\r\n   */\r\n  registerValue<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    value: TServiceType\r\n  ): Result<void, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.validationState === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerValue(token, value);\r\n  }\r\n\r\n  /**\r\n   * Register an already created instance.\r\n   * Internally treated the same as a value registration.\r\n   */\r\n  registerInstance<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>,\r\n    instance: TServiceType\r\n  ): Result<void, ContainerError> {\r\n    return this.registerValue(token, instance);\r\n  }\r\n\r\n  /**\r\n   * Returns a previously registered constant value without requiring validation.\r\n   * Useful for bootstrap/static values that are needed while the container is still registering services.\r\n   */\r\n  getRegisteredValue<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): TServiceType | null {\r\n    const registration = this.registry.getRegistration(token);\r\n    if (!registration) {\r\n      return null;\r\n    }\r\n    if (registration.providerType !== \"value\") {\r\n      return null;\r\n    }\r\n    const value = registration.value as TServiceType | undefined;\r\n    if (value === undefined) {\r\n      return null;\r\n    }\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Register an alias.\r\n   */\r\n  registerAlias<TServiceType extends ServiceType>(\r\n    aliasToken: InjectionToken<TServiceType>,\r\n    targetToken: InjectionToken<TServiceType>\r\n  ): Result<void, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    if (this.validationState === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerAlias(aliasToken, targetToken);\r\n  }\r\n\r\n  /**\r\n   * Validate all registrations.\r\n   */\r\n  validate(): Result<void, ContainerError[]> {\r\n    if (this.validationState === \"validated\") {\r\n      return ok(undefined);\r\n    }\r\n\r\n    if (this.validationState === \"validating\") {\r\n      return err([\r\n        {\r\n          code: \"InvalidOperation\",\r\n          message: \"Validation already in progress\",\r\n        },\r\n      ]);\r\n    }\r\n\r\n    this.validationState = \"validating\";\r\n\r\n    const result = this.validator.validate(this.registry);\r\n\r\n    if (result.ok) {\r\n      this.validationState = \"validated\";\r\n      // Inject MetricsCollector into resolver after validation (if available)\r\n      this.injectMetricsCollector();\r\n    } else {\r\n      this.validationState = \"registering\";\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Injects MetricsCollector into resolver and cache after validation.\r\n   * This enables metrics recording without circular dependencies during bootstrap.\r\n   *\r\n   * Note: EnvironmentConfig is already injected via BootstrapPerformanceTracker\r\n   * during container creation, so only MetricsCollector needs to be injected here.\r\n   *\r\n   * Static import is safe here because:\r\n   * - tokenindex.ts only uses `import type { ServiceContainer }` (removed at runtime)\r\n   * - No circular runtime dependency exists\r\n   * - Container is already validated when this is called\r\n   */\r\n  private injectMetricsCollector(): void {\r\n    const metricsResult = this.resolveWithError(metricsCollectorToken);\r\n    if (metricsResult.ok) {\r\n      this.resolver.setMetricsCollector(metricsResult.value);\r\n      this.cache.setMetricsCollector(metricsResult.value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get validation state.\r\n   */\r\n  getValidationState(): ContainerValidationState {\r\n    return this.validationState;\r\n  }\r\n\r\n  /**\r\n   * Async-safe validation for concurrent environments with timeout.\r\n   *\r\n   * Prevents race conditions when multiple callers validate simultaneously\r\n   * by ensuring only one validation runs at a time.\r\n   *\r\n   * @param timeoutMs - Timeout in milliseconds (default: 30000 = 30 seconds)\r\n   * @returns Promise resolving to validation result\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const container = ServiceContainer.createRoot();\r\n   * // ... register services\r\n   * await container.validateAsync(); // Safe for concurrent calls\r\n   * await container.validateAsync(5000); // With 5 second timeout\r\n   * ```\r\n   */\r\n  async validateAsync(timeoutMs: number = 30000): Promise<Result<void, ContainerError[]>> {\r\n    // Return immediately if already validated\r\n    if (this.validationState === \"validated\") {\r\n      return ok(undefined);\r\n    }\r\n\r\n    // Wait for ongoing validation\r\n    if (this.validationPromise !== null) {\r\n      return this.validationPromise;\r\n    }\r\n\r\n    // Validation already in progress (sync)\r\n    if (this.validationState === \"validating\") {\r\n      return err([\r\n        {\r\n          code: \"InvalidOperation\",\r\n          message: \"Validation already in progress\",\r\n        },\r\n      ]);\r\n    }\r\n\r\n    this.validationState = \"validating\";\r\n\r\n    // Track if timeout occurred to prevent state changes after timeout\r\n    let timedOut = false;\r\n\r\n    // Create validation task\r\n    const validationTask = Promise.resolve().then(() => {\r\n      const result = this.validator.validate(this.registry);\r\n\r\n      // Only update state if no timeout occurred\r\n      if (!timedOut) {\r\n        if (result.ok) {\r\n          this.validationState = \"validated\";\r\n        } else {\r\n          this.validationState = \"registering\";\r\n        }\r\n      }\r\n\r\n      return result;\r\n    });\r\n\r\n    // Wrap validation with timeout\r\n    try {\r\n      this.validationPromise = withTimeout(validationTask, timeoutMs);\r\n      const result = await this.validationPromise;\r\n\r\n      // Inject MetricsCollector if validation succeeded\r\n      if (result.ok) {\r\n        this.injectMetricsCollector();\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      // Handle timeout\r\n      if (error instanceof TimeoutError) {\r\n        timedOut = true; // Mark timeout occurred\r\n        this.validationState = \"registering\"; // Deterministisch zurücksetzen\r\n        return err([\r\n          {\r\n            code: \"InvalidOperation\",\r\n            message: `Validation timed out after ${timeoutMs}ms`,\r\n          },\r\n        ]);\r\n      }\r\n      // Re-throw unexpected errors\r\n      throw error;\r\n    } finally {\r\n      this.validationPromise = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a child scope container.\r\n   *\r\n   * Child containers:\r\n   * - Inherit parent registrations (cloned)\r\n   * - Can add their own registrations\r\n   * - Must call validate() before resolving\r\n   * - Share parent's singleton instances\r\n   * - Have isolated scoped instances\r\n   *\r\n   * @param name - Optional custom name for the scope\r\n   * @returns Result with child container or error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const parent = ServiceContainer.createRoot();\r\n   * parent.registerClass(LoggerToken, Logger, SINGLETON);\r\n   * parent.validate();\r\n   *\r\n   * const child = parent.createScope(\"request\").value!;\r\n   * child.registerClass(RequestToken, RequestContext, SCOPED);\r\n   * child.validate();\r\n   *\r\n   * const logger = child.resolve(LoggerToken);   // From parent (shared)\r\n   * const ctx = child.resolve(RequestToken);      // From child (isolated)\r\n   * ```\r\n   */\r\n  createScope(name?: string): Result<ServiceContainer, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot create scope from disposed container`,\r\n      });\r\n    }\r\n\r\n    if (this.validationState !== \"validated\") {\r\n      return err({\r\n        code: \"NotValidated\",\r\n        message: \"Parent must be validated before creating scopes. Call validate() first.\",\r\n      });\r\n    }\r\n\r\n    // Create child scope (pure Result, no throws)\r\n    const scopeResult = this.scopeManager.createChild(name);\r\n    if (!scopeResult.ok) {\r\n      return err(scopeResult.error); // Structured error, not exception\r\n    }\r\n\r\n    // Build child container components\r\n    const childRegistry = this.registry.clone();\r\n    const childCache = scopeResult.value.cache;\r\n    const childManager = scopeResult.value.manager;\r\n\r\n    // Create performance tracker for child (same as root)\r\n    const childPerformanceTracker = new BootstrapPerformanceTracker(createRuntimeConfig(ENV), null);\r\n    const childResolver = new ServiceResolver(\r\n      childRegistry,\r\n      childCache,\r\n      this.resolver, // Parent resolver for singleton delegation\r\n      scopeResult.value.scopeName,\r\n      childPerformanceTracker\r\n    );\r\n\r\n    // Create child using private constructor\r\n    const child = new ServiceContainer(\r\n      childRegistry,\r\n      this.validator, // Shared (stateless)\r\n      childCache,\r\n      childResolver,\r\n      childManager,\r\n      \"registering\" // FIX: Child starts in registering state, not validated!\r\n    );\r\n\r\n    return ok(child);\r\n  }\r\n\r\n  /**\r\n   * Resolve service with Result return.\r\n   */\r\n  resolveWithError<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): Result<TServiceType, ContainerError> {\r\n    if (this.scopeManager.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot resolve from disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.validationState !== \"validated\") {\r\n      return err({\r\n        code: \"NotValidated\",\r\n        message: \"Container must be validated before resolving. Call validate() first.\",\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    return this.resolver.resolve(token);\r\n  }\r\n\r\n  /**\r\n   * Resolves a service instance (throws on failure).\r\n   *\r\n   * **🎯 FOR EXTERNAL API USE ONLY**\r\n   *\r\n   * This method is designed for the public ModuleApi to provide\r\n   * exception-based error handling for external Foundry VTT modules.\r\n   *\r\n   * **Enforcement (Defense-in-Depth):**\r\n   * - **Compile-Time:** Only accepts ApiSafeToken types\r\n   * - **Runtime:** Validates token has API_SAFE_RUNTIME_MARKER (always active)\r\n   *\r\n   * Internal code MUST use `resolveWithError()` for Result-based error handling.\r\n   *\r\n   * @param token - An API-safe injection token (from api.tokens)\r\n   * @returns The resolved service instance\r\n   * @throws {Error} If token is not API-safe or resolution fails\r\n   *\r\n   * @example External Module Usage\r\n   * ```typescript\r\n   * const api = game.modules.get('fvtt_relationship_app_module').api;\r\n   *\r\n   * try {\r\n   *   const notifications = api.resolve(api.tokens.notificationCenterToken);\r\n   *   notifications.error(\"Success\", { code: \"API\", message: \"It works\" });\r\n   * } catch (error) {\r\n   *   console.error(\"Failed:\", error);\r\n   * }\r\n   * ```\r\n   *\r\n   * @example Internal Code (WRONG - Use resolveWithError)\r\n   * ```typescript\r\n   * // ❌ TypeScript Error + Runtime Error\r\n   * const notifications = container.resolve(notificationCenterToken);\r\n   *\r\n   * // ✅ CORRECT\r\n   * const result = container.resolveWithError(notificationCenterToken);\r\n   * if (result.ok) {\r\n   *   result.value.error(\"Success\", { code: \"API\", message: \"It works\" });\r\n   * }\r\n   * ```\r\n   */\r\n  resolve<TServiceType extends ServiceType>(token: ApiSafeToken<TServiceType>): TServiceType;\r\n\r\n  /**\r\n   * @deprecated Internal code must use resolveWithError()\r\n   * @internal This overload prevents direct calls with non-branded tokens\r\n   */\r\n  resolve<TServiceType extends ServiceType>(token: InjectionToken<TServiceType>): never;\r\n\r\n  // Implementation (unified for both overloads)\r\n  resolve<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType> | ApiSafeToken<TServiceType>\r\n  ): TServiceType {\r\n    // 🛡️ RUNTIME GUARD (always active for defense-in-depth)\r\n    if (!isApiSafeTokenRuntime(token)) {\r\n      throw new Error(\r\n        `API Boundary Violation: resolve() called with non-API-safe token: ${String(token)}.\\n` +\r\n          `This token was not marked via markAsApiSafe().\\n` +\r\n          `\\n` +\r\n          `Internal code MUST use resolveWithError() instead:\\n` +\r\n          `  const result = container.resolveWithError(${String(token)});\\n` +\r\n          `  if (result.ok) { /* use result.value */ }\\n` +\r\n          `\\n` +\r\n          `Only the public ModuleApi should expose resolve() for external modules.`\r\n      );\r\n    }\r\n\r\n    // Standard resolution via Result pattern\r\n    const result = this.resolveWithError(token);\r\n\r\n    if (isOk(result)) {\r\n      return result.value;\r\n    }\r\n\r\n    // No fallback - throw with context\r\n    throw new Error(`Cannot resolve ${String(token)}: ${result.error.message}`);\r\n  }\r\n\r\n  /**\r\n   * Check if service is registered.\r\n   */\r\n  isRegistered<TServiceType extends ServiceType>(\r\n    token: InjectionToken<TServiceType>\r\n  ): Result<boolean, never> {\r\n    return ok(this.registry.has(token));\r\n  }\r\n\r\n  /**\r\n   * Returns API-safe token metadata for external consumption.\r\n   */\r\n  getApiSafeToken<T extends ServiceType>(\r\n    token: ApiSafeToken<T>\r\n  ): { description: string; isRegistered: boolean } | null {\r\n    if (!isApiSafeTokenRuntime(token)) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      description: String(token),\r\n      isRegistered: this.registry.has(token),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Synchronously dispose container and all children.\r\n   *\r\n   * Use this for scenarios where async disposal is not possible (e.g., browser unload).\r\n   * For normal cleanup, prefer disposeAsync() which handles async disposal properly.\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  dispose(): Result<void, ContainerError> {\r\n    const result = this.scopeManager.dispose();\r\n\r\n    // Reset validation state after disposal (per review feedback)\r\n    if (result.ok) {\r\n      this.validationState = \"registering\";\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Asynchronously dispose container and all children.\r\n   *\r\n   * This is the preferred disposal method as it properly handles services that\r\n   * implement AsyncDisposable, allowing for proper cleanup of resources like\r\n   * database connections, file handles, or network sockets.\r\n   *\r\n   * Falls back to synchronous disposal for services implementing only Disposable.\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // Preferred: async disposal\r\n   * const result = await container.disposeAsync();\r\n   * if (result.ok) {\r\n   *   console.log(\"Container disposed successfully\");\r\n   * }\r\n   *\r\n   * // Browser unload (sync required)\r\n   * window.addEventListener('beforeunload', () => {\r\n   *   container.dispose();  // Sync fallback\r\n   * });\r\n   * ```\r\n   */\r\n  async disposeAsync(): Promise<Result<void, ContainerError>> {\r\n    const result = await this.scopeManager.disposeAsync();\r\n\r\n    // Reset validation state after disposal (per review feedback)\r\n    if (result.ok) {\r\n      this.validationState = \"registering\";\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Clear all registrations and instances.\r\n   *\r\n   * IMPORTANT: Resets validation state (per review feedback).\r\n   */\r\n  clear(): Result<void, never> {\r\n    this.registry.clear();\r\n    this.cache.clear();\r\n    this.validationState = \"registering\"; // Critical: reset validation state\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { HealthCheck } from \"./health-check.interface\";\r\nimport type { HealthCheckRegistry } from \"./HealthCheckRegistry\";\r\nimport { healthCheckRegistryToken, serviceContainerToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Health check validating that the service container completed its bootstrap phase.\r\n */\r\nexport class ContainerHealthCheck implements HealthCheck {\r\n  readonly name = \"container\";\r\n  private readonly container: ServiceContainer;\r\n\r\n  constructor(container: ServiceContainer) {\r\n    this.container = container;\r\n  }\r\n\r\n  check(): boolean {\r\n    return this.container.getValidationState() === \"validated\";\r\n  }\r\n\r\n  getDetails(): string | null {\r\n    const state = this.container.getValidationState();\r\n    if (state !== \"validated\") {\r\n      return `Container state: ${state}`;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  dispose(): void {\r\n    // Nothing to clean up – the container owns its own lifecycle.\r\n  }\r\n}\r\n\r\nexport class DIContainerHealthCheck extends ContainerHealthCheck {\r\n  static dependencies = [serviceContainerToken, healthCheckRegistryToken] as const;\r\n\r\n  constructor(container: ServiceContainer, registry: HealthCheckRegistry) {\r\n    super(container);\r\n    registry.register(this);\r\n  }\r\n}\r\n","import type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { healthCheckRegistryToken, metricsCollectorToken } from \"@/infrastructure/shared/tokens\";\r\nimport type { HealthCheck } from \"./health-check.interface\";\r\nimport type { HealthCheckRegistry } from \"./HealthCheckRegistry\";\r\n\r\n/**\r\n * Health check that surfaces critical issues from the metrics collector\r\n * (port selection failures and container resolution errors).\r\n */\r\nexport class MetricsHealthCheck implements HealthCheck {\r\n  readonly name = \"metrics\";\r\n  private readonly metricsCollector: MetricsCollector;\r\n\r\n  constructor(metricsCollector: MetricsCollector) {\r\n    this.metricsCollector = metricsCollector;\r\n  }\r\n\r\n  check(): boolean {\r\n    const snapshot = this.metricsCollector.getSnapshot();\r\n    const hasPortFailures = Object.keys(snapshot.portSelectionFailures).length > 0;\r\n    const hasResolutionErrors = snapshot.resolutionErrors > 0;\r\n    return !hasPortFailures && !hasResolutionErrors;\r\n  }\r\n\r\n  getDetails(): string | null {\r\n    const snapshot = this.metricsCollector.getSnapshot();\r\n    const failures = Object.keys(snapshot.portSelectionFailures);\r\n\r\n    if (failures.length > 0) {\r\n      return `Port selection failures: ${failures.join(\", \")}`;\r\n    }\r\n\r\n    if (snapshot.resolutionErrors > 0) {\r\n      return `Resolution errors: ${snapshot.resolutionErrors}`;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  dispose(): void {\r\n    // No resources to dispose – collector lives for the entire runtime.\r\n  }\r\n}\r\n\r\nexport class DIMetricsHealthCheck extends MetricsHealthCheck {\r\n  static dependencies = [metricsCollectorToken, healthCheckRegistryToken] as const;\r\n\r\n  constructor(metricsCollector: MetricsCollector, registry: HealthCheckRegistry) {\r\n    super(metricsCollector);\r\n    registry.register(this);\r\n  }\r\n}\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport { METRICS_CONFIG } from \"@/infrastructure/shared/constants\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport { runtimeConfigToken } from \"@/infrastructure/shared/tokens\";\r\nimport type { MetricsRecorder } from \"./interfaces/metrics-recorder\";\r\nimport type { MetricsSampler } from \"./interfaces/metrics-sampler\";\r\n\r\n/**\r\n * Snapshot of current metrics data.\r\n * Provides read-only access to collected performance metrics.\r\n */\r\nexport interface MetricsSnapshot {\r\n  /** Total number of container service resolutions */\r\n  containerResolutions: number;\r\n  /** Number of failed resolution attempts */\r\n  resolutionErrors: number;\r\n  /** Average resolution time in milliseconds (rolling window) */\r\n  avgResolutionTimeMs: number;\r\n  /** Count of port selections by Foundry version */\r\n  portSelections: Record<number, number>;\r\n  /** Count of port selection failures by Foundry version */\r\n  portSelectionFailures: Record<number, number>;\r\n  /** Cache hit rate as percentage (0-100) */\r\n  cacheHitRate: number;\r\n}\r\n\r\n/**\r\n * Serializable snapshot of internal metrics state used for persistence.\r\n */\r\nexport interface MetricsPersistenceState {\r\n  metrics: {\r\n    containerResolutions: number;\r\n    resolutionErrors: number;\r\n    cacheHits: number;\r\n    cacheMisses: number;\r\n    portSelections: Record<number, number>;\r\n    portSelectionFailures: Record<number, number>;\r\n  };\r\n  resolutionTimes: number[];\r\n  resolutionTimesIndex: number;\r\n  resolutionTimesCount: number;\r\n}\r\n\r\n/**\r\n * Table data structure for console.table() output in logSummary().\r\n * Uses string keys to match console.table() expectations.\r\n * Naming convention disabled for console.table() compatibility.\r\n */\r\ninterface MetricsTableData {\r\n  \"Total Resolutions\": number;\r\n  Errors: number;\r\n  \"Avg Time (ms)\": string;\r\n  \"Cache Hit Rate\": string;\r\n}\r\n\r\n/**\r\n * Metrics collector for observability and performance tracking.\r\n *\r\n * Implements MetricsRecorder and MetricsSampler interfaces to provide\r\n * segregated access for different use cases (Interface Segregation Principle).\r\n *\r\n * Collects performance metrics for:\r\n * - Container service resolutions\r\n * - Port selections\r\n * - Cache hit/miss rates\r\n *\r\n * Metrics are only collected when ENV.enablePerformanceTracking is true.\r\n *\r\n * Now managed via Dependency Injection as a Singleton service.\r\n *\r\n * @example\r\n * ```typescript\r\n * const collector = container.resolve(metricsCollectorToken);\r\n * collector.recordResolution(token, 2.5, true);\r\n *\r\n * const snapshot = collector.getSnapshot();\r\n * console.log(`Avg resolution time: ${snapshot.avgResolutionTimeMs}ms`);\r\n * ```\r\n */\r\nexport class MetricsCollector implements MetricsRecorder, MetricsSampler {\r\n  static dependencies: readonly InjectionToken<ServiceType>[] = [runtimeConfigToken];\r\n\r\n  private metrics = {\r\n    containerResolutions: 0,\r\n    resolutionErrors: 0,\r\n    cacheHits: 0,\r\n    cacheMisses: 0,\r\n    portSelections: new Map<number, number>(),\r\n    portSelectionFailures: new Map<number, number>(),\r\n  };\r\n\r\n  // Circular buffer for resolution times (more efficient than array shift)\r\n  private resolutionTimes = new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE);\r\n  private resolutionTimesIndex = 0;\r\n  private resolutionTimesCount = 0;\r\n  private readonly MAX_RESOLUTION_TIMES = METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE;\r\n\r\n  constructor(private readonly config: RuntimeConfigService) {}\r\n\r\n  /**\r\n   * Records a service resolution attempt.\r\n   *\r\n   * @param token - The injection token that was resolved\r\n   * @param durationMs - Time taken to resolve in milliseconds\r\n   * @param success - Whether resolution succeeded\r\n   */\r\n  recordResolution(token: InjectionToken<ServiceType>, durationMs: number, success: boolean): void {\r\n    this.metrics.containerResolutions++;\r\n\r\n    if (!success) {\r\n      this.metrics.resolutionErrors++;\r\n    }\r\n\r\n    // Circular buffer: O(1) instead of O(n) with array shift\r\n    this.resolutionTimes[this.resolutionTimesIndex] = durationMs;\r\n    this.resolutionTimesIndex = (this.resolutionTimesIndex + 1) % this.MAX_RESOLUTION_TIMES;\r\n    this.resolutionTimesCount = Math.min(this.resolutionTimesCount + 1, this.MAX_RESOLUTION_TIMES);\r\n\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a port selection event.\r\n   *\r\n   * @param version - The Foundry version for which a port was selected\r\n   */\r\n  recordPortSelection(version: number): void {\r\n    const count = this.metrics.portSelections.get(version) ?? 0;\r\n    this.metrics.portSelections.set(version, count + 1);\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a port selection failure.\r\n   *\r\n   * Useful for tracking when no compatible port is available for a version.\r\n   *\r\n   * @param version - The Foundry version for which port selection failed\r\n   */\r\n  recordPortSelectionFailure(version: number): void {\r\n    const count = this.metrics.portSelectionFailures.get(version) ?? 0;\r\n    this.metrics.portSelectionFailures.set(version, count + 1);\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a cache access (hit or miss).\r\n   *\r\n   * @param hit - True if cache hit, false if cache miss\r\n   */\r\n  recordCacheAccess(hit: boolean): void {\r\n    if (hit) {\r\n      this.metrics.cacheHits++;\r\n    } else {\r\n      this.metrics.cacheMisses++;\r\n    }\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Determines if a performance operation should be sampled based on sampling rate.\r\n   *\r\n   * In production mode, uses probabilistic sampling to reduce overhead.\r\n   * In development mode, always samples (returns true).\r\n   *\r\n   * @returns True if the operation should be measured/recorded\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const metrics = container.resolve(metricsCollectorToken);\r\n   * if (metrics.shouldSample()) {\r\n   *   performance.mark('operation-start');\r\n   *   // ... operation ...\r\n   *   performance.mark('operation-end');\r\n   *   performance.measure('operation', 'operation-start', 'operation-end');\r\n   * }\r\n   * ```\r\n   */\r\n  shouldSample(): boolean {\r\n    // Always sample in development mode\r\n    if (this.config.get(\"isDevelopment\")) {\r\n      return true;\r\n    }\r\n\r\n    // Probabilistic sampling in production based on configured rate\r\n    return Math.random() < this.config.get(\"performanceSamplingRate\");\r\n  }\r\n\r\n  /**\r\n   * Gets a snapshot of current metrics.\r\n   *\r\n   * @returns Immutable snapshot of metrics data\r\n   */\r\n  getSnapshot(): MetricsSnapshot {\r\n    // Calculate average from circular buffer\r\n    const times = this.resolutionTimes.slice(0, this.resolutionTimesCount);\r\n    const sum = times.reduce((acc, time) => acc + time, 0);\r\n    const avgTime = this.resolutionTimesCount > 0 ? sum / this.resolutionTimesCount : 0;\r\n\r\n    const totalCacheAccess = this.metrics.cacheHits + this.metrics.cacheMisses;\r\n    const cacheHitRate =\r\n      totalCacheAccess > 0 ? (this.metrics.cacheHits / totalCacheAccess) * 100 : 0;\r\n\r\n    return {\r\n      containerResolutions: this.metrics.containerResolutions,\r\n      resolutionErrors: this.metrics.resolutionErrors,\r\n      avgResolutionTimeMs: avgTime,\r\n      portSelections: Object.fromEntries(this.metrics.portSelections),\r\n      portSelectionFailures: Object.fromEntries(this.metrics.portSelectionFailures),\r\n      cacheHitRate,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Logs a formatted metrics summary to the console.\r\n   * Uses console.table() for easy-to-read tabular output.\r\n   */\r\n  logSummary(): void {\r\n    const snapshot = this.getSnapshot();\r\n\r\n    const tableData: MetricsTableData = {\r\n      \"Total Resolutions\": snapshot.containerResolutions,\r\n      Errors: snapshot.resolutionErrors,\r\n      \"Avg Time (ms)\": snapshot.avgResolutionTimeMs.toFixed(2),\r\n      \"Cache Hit Rate\": `${snapshot.cacheHitRate.toFixed(1)}%`,\r\n    };\r\n    console.table(tableData);\r\n  }\r\n\r\n  /**\r\n   * Resets all collected metrics.\r\n   * Useful for testing or starting fresh measurements.\r\n   */\r\n  reset(): void {\r\n    this.metrics = {\r\n      containerResolutions: 0,\r\n      resolutionErrors: 0,\r\n      cacheHits: 0,\r\n      cacheMisses: 0,\r\n      portSelections: new Map(),\r\n      portSelectionFailures: new Map(),\r\n    };\r\n    this.resolutionTimes = new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE);\r\n    this.resolutionTimesIndex = 0;\r\n    this.resolutionTimesCount = 0;\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Hook invoked after state mutations. Subclasses can override to react\r\n   * (e.g., persist metrics).\r\n   */\r\n\r\n  protected onStateChanged(): void {}\r\n\r\n  /**\r\n   * Captures the internal state for persistence.\r\n   *\r\n   * @returns Serializable metrics state\r\n   */\r\n  protected getPersistenceState(): MetricsPersistenceState {\r\n    return {\r\n      metrics: {\r\n        containerResolutions: this.metrics.containerResolutions,\r\n        resolutionErrors: this.metrics.resolutionErrors,\r\n        cacheHits: this.metrics.cacheHits,\r\n        cacheMisses: this.metrics.cacheMisses,\r\n        portSelections: Object.fromEntries(this.metrics.portSelections),\r\n        portSelectionFailures: Object.fromEntries(this.metrics.portSelectionFailures),\r\n      },\r\n      resolutionTimes: Array.from(this.resolutionTimes),\r\n      resolutionTimesIndex: this.resolutionTimesIndex,\r\n      resolutionTimesCount: this.resolutionTimesCount,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Restores internal state from a persisted snapshot.\r\n   *\r\n   * @param state - Persisted metrics state\r\n   */\r\n  protected restoreFromPersistenceState(state: MetricsPersistenceState | null | undefined): void {\r\n    if (!state) {\r\n      return;\r\n    }\r\n\r\n    const { metrics, resolutionTimes, resolutionTimesCount, resolutionTimesIndex } = state;\r\n\r\n    this.metrics = {\r\n      containerResolutions: Math.max(0, metrics?.containerResolutions ?? 0),\r\n      resolutionErrors: Math.max(0, metrics?.resolutionErrors ?? 0),\r\n      cacheHits: Math.max(0, metrics?.cacheHits ?? 0),\r\n      cacheMisses: Math.max(0, metrics?.cacheMisses ?? 0),\r\n      portSelections: new Map<number, number>(\r\n        Object.entries(metrics?.portSelections ?? {}).map(([key, value]) => [\r\n          Number(key),\r\n          Number.isFinite(Number(value)) ? Number(value) : 0,\r\n        ])\r\n      ),\r\n      portSelectionFailures: new Map<number, number>(\r\n        Object.entries(metrics?.portSelectionFailures ?? {}).map(([key, value]) => [\r\n          Number(key),\r\n          Number.isFinite(Number(value)) ? Number(value) : 0,\r\n        ])\r\n      ),\r\n    };\r\n\r\n    this.resolutionTimes = new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE);\r\n    if (Array.isArray(resolutionTimes)) {\r\n      const maxLength = Math.min(resolutionTimes.length, this.resolutionTimes.length);\r\n      for (let index = 0; index < maxLength; index++) {\r\n        const value = Number(resolutionTimes[index]);\r\n        this.resolutionTimes[index] = Number.isFinite(value) ? value : 0;\r\n      }\r\n    }\r\n\r\n    const safeIndex = Number.isFinite(resolutionTimesIndex) ? Number(resolutionTimesIndex) : 0;\r\n    const safeCount = Number.isFinite(resolutionTimesCount) ? Number(resolutionTimesCount) : 0;\r\n\r\n    this.resolutionTimesIndex = Math.min(Math.max(0, safeIndex), this.MAX_RESOLUTION_TIMES - 1);\r\n    this.resolutionTimesCount = Math.min(Math.max(0, safeCount), this.MAX_RESOLUTION_TIMES);\r\n  }\r\n}\r\n\r\nexport class DIMetricsCollector extends MetricsCollector {\r\n  static override dependencies: readonly InjectionToken<ServiceType>[] = [runtimeConfigToken];\r\n\r\n  constructor(config: RuntimeConfigService) {\r\n    super(config);\r\n  }\r\n}\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport { runtimeConfigToken, metricsStorageToken } from \"@/infrastructure/shared/tokens\";\r\nimport type { MetricsPersistenceState } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { MetricsStorage } from \"./metrics-storage\";\r\n\r\n/**\r\n * MetricsCollector variant that persists state via MetricsStorage.\r\n */\r\nexport class PersistentMetricsCollector extends MetricsCollector {\r\n  static override dependencies: readonly InjectionToken<ServiceType>[] = [\r\n    runtimeConfigToken,\r\n    metricsStorageToken,\r\n  ];\r\n\r\n  private suppressPersistence = false;\r\n\r\n  constructor(\r\n    config: RuntimeConfigService,\r\n    private readonly metricsStorage: MetricsStorage\r\n  ) {\r\n    super(config);\r\n    this.restoreFromStorage();\r\n  }\r\n\r\n  clearPersistentState(): void {\r\n    this.metricsStorage.clear?.();\r\n    this.suppressPersistence = true;\r\n    try {\r\n      super.reset();\r\n    } finally {\r\n      this.suppressPersistence = false;\r\n    }\r\n  }\r\n\r\n  protected override onStateChanged(): void {\r\n    if (this.suppressPersistence) {\r\n      return;\r\n    }\r\n    this.persist();\r\n  }\r\n\r\n  private restoreFromStorage(): void {\r\n    let state: MetricsPersistenceState | null = null;\r\n    try {\r\n      state = this.metricsStorage.load();\r\n    } catch {\r\n      state = null;\r\n    }\r\n\r\n    if (!state) {\r\n      return;\r\n    }\r\n\r\n    this.suppressPersistence = true;\r\n    try {\r\n      this.restoreFromPersistenceState(state);\r\n    } finally {\r\n      this.suppressPersistence = false;\r\n    }\r\n  }\r\n\r\n  private persist(): void {\r\n    try {\r\n      this.metricsStorage.save(this.getPersistenceState());\r\n    } catch {\r\n      // Persistence failures are non-critical; ignore\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIPersistentMetricsCollector extends PersistentMetricsCollector {\r\n  static override dependencies: readonly InjectionToken<ServiceType>[] = [\r\n    runtimeConfigToken,\r\n    metricsStorageToken,\r\n  ];\r\n\r\n  constructor(config: RuntimeConfigService, metricsStorage: MetricsStorage) {\r\n    super(config, metricsStorage);\r\n  }\r\n}\r\n","import type { MetricsPersistenceState } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { MetricsStorage } from \"./metrics-storage\";\r\n\r\n/**\r\n * LocalStorage-based metrics persistence.\r\n *\r\n * Gracefully degrades when localStorage is unavailable (e.g., in private mode\r\n * or server-side rendering) by behaving like a no-op storage.\r\n */\r\nexport class LocalStorageMetricsStorage implements MetricsStorage {\r\n  constructor(\r\n    private readonly storageKey: string,\r\n    private readonly storage: Storage | null = getStorage()\r\n  ) {}\r\n\r\n  load(): MetricsPersistenceState | null {\r\n    if (!this.storage) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const raw = this.storage.getItem(this.storageKey);\r\n      if (!raw) {\r\n        return null;\r\n      }\r\n      return JSON.parse(raw) as MetricsPersistenceState;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  save(state: MetricsPersistenceState): void {\r\n    if (!this.storage) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.storage.setItem(this.storageKey, JSON.stringify(state));\r\n    } catch {\r\n      // Storage quota exceeded or serialization failed → ignore silently\r\n    }\r\n  }\r\n\r\n  clear(): void {\r\n    if (!this.storage) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.storage.removeItem(this.storageKey);\r\n    } catch {\r\n      // Ignore storage errors\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the localStorage object if available in the current environment.\r\n * Returns null if localStorage is not available (e.g., server-side, private mode).\r\n * Exported for testing purposes.\r\n */\r\nexport function getStorage(): Storage | null {\r\n  try {\r\n    if (typeof globalThis !== \"undefined\" && \"localStorage\" in globalThis) {\r\n      return globalThis.localStorage;\r\n    }\r\n  } catch {\r\n    // Accessing localStorage can throw in some environments\r\n  }\r\n  return null;\r\n}\r\n","import { LogLevel } from \"@/framework/config/environment\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { Logger } from \"./logger.interface\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport { runtimeConfigToken, traceContextToken } from \"@/infrastructure/shared/tokens\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\n\r\n/**\r\n * Logger implementation that writes to the browser console with module prefix\r\n * and optional trace context correlation.\r\n */\r\nexport class ConsoleLoggerService implements Logger {\r\n  private minLevel: LogLevel;\r\n  private readonly traceContext: TraceContext | null;\r\n  private runtimeConfigUnsubscribe: (() => void) | null = null;\r\n\r\n  constructor(config: RuntimeConfigService, traceContext?: TraceContext) {\r\n    this.traceContext = traceContext ?? null;\r\n    this.minLevel = config.get(\"logLevel\");\r\n    this.bindRuntimeConfig(config);\r\n  }\r\n\r\n  setMinLevel(level: LogLevel): void {\r\n    this.minLevel = level;\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    const formattedMessage = this.formatWithContextTrace(message);\r\n    console.log(`${MODULE_CONSTANTS.LOG_PREFIX} ${formattedMessage}`, ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.ERROR < this.minLevel) return;\r\n    const formattedMessage = this.formatWithContextTrace(message);\r\n    console.error(`${MODULE_CONSTANTS.LOG_PREFIX} ${formattedMessage}`, ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.WARN < this.minLevel) return;\r\n    const formattedMessage = this.formatWithContextTrace(message);\r\n    console.warn(`${MODULE_CONSTANTS.LOG_PREFIX} ${formattedMessage}`, ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.INFO < this.minLevel) return;\r\n    const formattedMessage = this.formatWithContextTrace(message);\r\n    console.info(`${MODULE_CONSTANTS.LOG_PREFIX} ${formattedMessage}`, ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.DEBUG < this.minLevel) return;\r\n    const formattedMessage = this.formatWithContextTrace(message);\r\n    console.debug(`${MODULE_CONSTANTS.LOG_PREFIX} ${formattedMessage}`, ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    return new TracedLogger(this, traceId);\r\n  }\r\n\r\n  private bindRuntimeConfig(runtimeConfig: RuntimeConfigService): void {\r\n    this.minLevel = runtimeConfig.get(\"logLevel\");\r\n    this.runtimeConfigUnsubscribe?.();\r\n    this.runtimeConfigUnsubscribe = runtimeConfig.onChange(\"logLevel\", (level) => {\r\n      this.setMinLevel(level);\r\n    });\r\n  }\r\n\r\n  private getContextTraceId(): string | null {\r\n    return this.traceContext?.getCurrentTraceId() ?? null;\r\n  }\r\n\r\n  private formatWithContextTrace(message: string): string {\r\n    const contextTraceId = this.getContextTraceId();\r\n    if (contextTraceId) {\r\n      return `[${contextTraceId}] ${message}`;\r\n    }\r\n    return message;\r\n  }\r\n}\r\n\r\nclass TracedLogger implements Logger {\r\n  constructor(\r\n    private readonly baseLogger: Logger,\r\n    private readonly traceId: string\r\n  ) {}\r\n\r\n  setMinLevel?(level: LogLevel): void {\r\n    this.baseLogger.setMinLevel?.(level);\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.log(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.error(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.warn(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.info(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.debug(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  withTraceId?(newTraceId: string): Logger {\r\n    return new TracedLogger(this.baseLogger, `${this.traceId}/${newTraceId}`);\r\n  }\r\n\r\n  private formatMessage(message: string): string {\r\n    return `[${this.traceId}] ${message}`;\r\n  }\r\n}\r\n\r\nexport class DIConsoleLoggerService extends ConsoleLoggerService {\r\n  static dependencies = [runtimeConfigToken, traceContextToken] as const;\r\n\r\n  constructor(config: RuntimeConfigService, traceContext?: TraceContext) {\r\n    super(config, traceContext);\r\n  }\r\n}\r\n","/**\r\n * Utilities for distributed tracing and request correlation.\r\n * Provides unique trace IDs to correlate log messages across operations.\r\n */\r\n\r\n/**\r\n * Generates a unique trace ID for correlating related log entries.\r\n *\r\n * Format: {timestamp}-{random}\r\n * - timestamp: Unix timestamp in milliseconds (for chronological ordering)\r\n * - random: Random hex string for uniqueness\r\n *\r\n * @returns A unique trace ID string\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceId = generateTraceId();\r\n * logger.withTraceId(traceId).info('Starting operation');\r\n * // ... nested operations can use the same traceId ...\r\n * logger.withTraceId(traceId).info('Operation completed');\r\n * ```\r\n */\r\nexport function generateTraceId(): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 10);\r\n  return `${timestamp}-${random}`;\r\n}\r\n\r\n/**\r\n * Extracts timestamp from a trace ID (if available).\r\n * Useful for debugging and metrics correlation.\r\n *\r\n * @param traceId - The trace ID to parse\r\n * @returns The timestamp in milliseconds, or null if invalid format\r\n */\r\nexport function getTraceTimestamp(traceId: string): number | null {\r\n  const parts = traceId.split(\"-\");\r\n  if (parts.length !== 2) {\r\n    return null;\r\n  }\r\n\r\n  const [timestampStr, randomStr] = parts;\r\n  if (!timestampStr || !randomStr) {\r\n    return null;\r\n  }\r\n\r\n  const timestamp = parseInt(timestampStr, 10);\r\n  return isNaN(timestamp) ? null : timestamp;\r\n}\r\n","/**\r\n * TraceContext service for automatic trace ID propagation.\r\n *\r\n * Provides automatic trace ID management across nested function calls,\r\n * eliminating the need to manually pass trace IDs through function parameters.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Automatic trace propagation\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Starting operation\"); // Automatically traced!\r\n *   doSomething(); // Nested calls see the same trace ID\r\n *   logger.info(\"Completed\"); // Same trace ID\r\n * });\r\n *\r\n * // Custom trace ID\r\n * traceContext.trace(() => {\r\n *   // ...\r\n * }, { traceId: \"custom-trace-123\" });\r\n *\r\n * // Nested traces\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Outer trace\");\r\n *   traceContext.trace(() => {\r\n *     logger.info(\"Inner trace\"); // Different trace ID\r\n *   });\r\n *   logger.info(\"Back to outer trace\");\r\n * });\r\n * ```\r\n */\r\n\r\nimport { generateTraceId } from \"@/infrastructure/shared/utils/trace\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\n\r\n/**\r\n * Options for trace operations.\r\n */\r\nexport interface TraceOptions {\r\n  /**\r\n   * Custom trace ID to use instead of auto-generating.\r\n   * If not provided, a new trace ID will be generated.\r\n   */\r\n  traceId?: string;\r\n\r\n  /**\r\n   * Optional operation name for logging purposes.\r\n   */\r\n  operationName?: string;\r\n\r\n  /**\r\n   * Optional metadata to attach to the trace context.\r\n   */\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Service for managing trace context across function calls.\r\n *\r\n * Provides automatic trace ID propagation through a call stack,\r\n * eliminating the need to manually pass trace IDs as parameters.\r\n *\r\n * Key features:\r\n * - Automatic trace ID generation\r\n * - Context stacking for nested traces\r\n * - Proper cleanup via try/finally\r\n * - Support for both sync and async operations\r\n *\r\n * Note: TraceContext has no dependencies to avoid circular dependency with Logger.\r\n * Logger can optionally use TraceContext.getCurrentTraceId() for automatic trace injection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceContext = container.resolve(traceContextToken);\r\n *\r\n * // Sync operation\r\n * const result = traceContext.trace(() => {\r\n *   return performOperation();\r\n * });\r\n *\r\n * // Async operation\r\n * const result = await traceContext.traceAsync(async () => {\r\n *   return await fetchData();\r\n * });\r\n *\r\n * // Check current trace ID\r\n * const currentTraceId = traceContext.getCurrentTraceId();\r\n * ```\r\n */\r\nexport class TraceContext implements Disposable {\r\n  static dependencies = [] as const;\r\n\r\n  /**\r\n   * Current trace ID in the context stack.\r\n   * Null when not in a traced context.\r\n   */\r\n  private currentTraceId: string | null = null;\r\n\r\n  /**\r\n   * Executes a synchronous function with trace context.\r\n   *\r\n   * Automatically generates a trace ID if not provided.\r\n   * Maintains a context stack for nested traces.\r\n   * Ensures proper cleanup via try/finally.\r\n   *\r\n   * @template T - The return type of the function\r\n   * @param fn - Function to execute with trace context\r\n   * @param options - Trace options (trace ID, operation name, metadata)\r\n   * @returns The result of the function execution\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = traceContext.trace(() => {\r\n   *   logger.info(\"Processing\"); // Automatically traced\r\n   *   return processData();\r\n   * });\r\n   * ```\r\n   */\r\n  trace<T>(fn: () => T, options?: string | TraceOptions): T {\r\n    // Normalize options\r\n    const opts = typeof options === \"string\" ? { traceId: options } : options;\r\n    const traceId = opts?.traceId ?? generateTraceId();\r\n\r\n    // Save previous trace ID for context restoration\r\n    const previousTraceId = this.currentTraceId;\r\n\r\n    // Set new trace ID\r\n    this.currentTraceId = traceId;\r\n\r\n    try {\r\n      // Execute function in trace context\r\n      return fn();\r\n    } finally {\r\n      // Always restore previous trace ID (even on exception)\r\n      this.currentTraceId = previousTraceId;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes an asynchronous function with trace context.\r\n   *\r\n   * Similar to trace() but for async operations.\r\n   * Automatically generates a trace ID if not provided.\r\n   * Maintains a context stack for nested traces.\r\n   * Ensures proper cleanup via try/finally.\r\n   *\r\n   * @template T - The return type of the async function\r\n   * @param fn - Async function to execute with trace context\r\n   * @param options - Trace options (trace ID, operation name, metadata)\r\n   * @returns Promise resolving to the result of the function execution\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await traceContext.traceAsync(async () => {\r\n   *   logger.info(\"Fetching data\"); // Automatically traced\r\n   *   return await fetchData();\r\n   * });\r\n   * ```\r\n   */\r\n  async traceAsync<T>(fn: () => Promise<T>, options?: string | TraceOptions): Promise<T> {\r\n    // Normalize options\r\n    const opts = typeof options === \"string\" ? { traceId: options } : options;\r\n    const traceId = opts?.traceId ?? generateTraceId();\r\n\r\n    // Save previous trace ID for context restoration\r\n    const previousTraceId = this.currentTraceId;\r\n\r\n    // Set new trace ID\r\n    this.currentTraceId = traceId;\r\n\r\n    try {\r\n      // Execute async function in trace context\r\n      return await fn();\r\n    } finally {\r\n      // Always restore previous trace ID (even on exception)\r\n      this.currentTraceId = previousTraceId;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the current trace ID from the context stack.\r\n   *\r\n   * Returns null if not currently in a traced context.\r\n   * Useful for services that need to access the current trace ID\r\n   * without having it passed as a parameter.\r\n   *\r\n   * @returns Current trace ID or null if not in traced context\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const traceId = traceContext.getCurrentTraceId();\r\n   * if (traceId) {\r\n   *   console.log(`Current trace: ${traceId}`);\r\n   * }\r\n   * ```\r\n   */\r\n  getCurrentTraceId(): string | null {\r\n    return this.currentTraceId;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * For TraceContext, this resets the current trace ID.\r\n   */\r\n  dispose(): void {\r\n    this.currentTraceId = null;\r\n  }\r\n}\r\n\r\nexport class DITraceContext extends TraceContext {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { HealthStatus } from \"@/framework/core/api/module-api\";\r\nimport type { HealthCheckRegistry } from \"@/application/health/HealthCheckRegistry\";\r\nimport { healthCheckRegistryToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Service for monitoring module health and diagnostics.\r\n *\r\n * Uses Health-Check-Registry Pattern for extensible health monitoring.\r\n *\r\n * Responsibilities:\r\n * - Aggregate health checks from registry\r\n * - Determine overall health status\r\n * - Provide structured health status with details\r\n *\r\n * Extracted from CompositionRoot to follow Single Responsibility Principle.\r\n */\r\nexport class ModuleHealthService {\r\n  private healthChecksInitialized = false;\r\n\r\n  constructor(private readonly registry: HealthCheckRegistry) {}\r\n\r\n  /**\r\n   * Gets the current health status of the module.\r\n   *\r\n   * Health is determined by running all registered health checks.\r\n   * Overall status:\r\n   * - \"healthy\": All checks pass\r\n   * - \"unhealthy\": Container check fails\r\n   * - \"degraded\": Other checks fail\r\n   *\r\n   * @returns HealthStatus with overall status, individual checks, and timestamp\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const healthService = container.resolve(moduleHealthServiceToken);\r\n   * const health = healthService.getHealth();\r\n   *\r\n   * if (health.status !== 'healthy') {\r\n   *   console.warn('Module is not healthy:', health.checks);\r\n   * }\r\n   * ```\r\n   */\r\n  getHealth(): HealthStatus {\r\n    // Lazy initialization: Ensure health checks are registered on first call\r\n    // This is done lazily because health checks need to be resolved after container validation\r\n    if (!this.healthChecksInitialized) {\r\n      this.healthChecksInitialized = true;\r\n      // Note: Health checks will be registered when their factories execute\r\n      // This happens automatically when they are resolved for the first time\r\n    }\r\n\r\n    const results = this.registry.runAll();\r\n\r\n    // Determine overall status\r\n    const allHealthy = Array.from(results.values()).every((result) => result);\r\n\r\n    // Determine health status based on results\r\n    const status: \"healthy\" | \"degraded\" | \"unhealthy\" = allHealthy\r\n      ? \"healthy\"\r\n      : results.get(\"container\") === false\r\n        ? \"unhealthy\"\r\n        : \"degraded\";\r\n\r\n    // Collect details from unhealthy checks\r\n    const checks = this.registry.getAllChecks();\r\n    let lastError: string | null = null;\r\n\r\n    for (const check of checks) {\r\n      const result = results.get(check.name);\r\n      if (!result && check.getDetails) {\r\n        lastError = check.getDetails();\r\n      }\r\n    }\r\n\r\n    return {\r\n      status,\r\n      checks: {\r\n        containerValidated: results.get(\"container\") ?? true,\r\n        portsSelected: results.get(\"metrics\") ?? true,\r\n        lastError,\r\n      },\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n}\r\n\r\nexport class DIModuleHealthService extends ModuleHealthService {\r\n  static dependencies = [healthCheckRegistryToken] as const;\r\n\r\n  constructor(registry: HealthCheckRegistry) {\r\n    super(registry);\r\n  }\r\n}\r\n","/**\r\n * Formats deprecation replacement information for console warnings.\r\n *\r\n * @param replacement - The replacement token name, or null if no replacement is available\r\n * @returns Formatted replacement message, or empty string if no replacement\r\n */\r\nexport function formatReplacementInfo(replacement: string | null): string {\r\n  return replacement ? `Use \"${replacement}\" instead.\\n` : \"\";\r\n}\r\n","import type { InjectionToken } from \"../core/injectiontoken\";\r\nimport type { ApiSafeToken } from \"./api-safe-token\";\r\nimport { markAsApiSafe } from \"./api-safe-token\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Deprecation metadata attached to deprecated tokens.\r\n * Stores information about why the token is deprecated and what to use instead.\r\n */\r\nexport interface DeprecationInfo {\r\n  /** Reason why the token is deprecated */\r\n  reason: string;\r\n  /** Replacement token description (if available) */\r\n  replacement: string | null;\r\n  /** Version in which the token will be removed */\r\n  removedInVersion: string;\r\n  /** Whether the deprecation warning has been shown (prevents spam) */\r\n  warningShown: boolean;\r\n}\r\n\r\n/**\r\n * Map to store deprecation metadata for tokens.\r\n * Symbols are used as keys directly (Map supports symbol keys natively).\r\n *\r\n * Memory: Tokens are singletons (defined once in tokenindex.ts), so no memory leak risk.\r\n * Using Map instead of WeakMap for 100% type-coverage (no any-casts needed).\r\n */\r\nconst deprecationMetadata = new Map<symbol, DeprecationInfo>();\r\n\r\n/**\r\n * Marks an injection token as deprecated with metadata.\r\n *\r\n * The token remains functional but will emit a console warning when resolved.\r\n * This allows for graceful migration periods before breaking changes.\r\n *\r\n * @param token - The injection token to deprecate\r\n * @param reason - Human-readable reason for deprecation\r\n * @param replacement - Optional replacement token (for migration guidance)\r\n * @param removedInVersion - Version in which the token will be removed\r\n * @returns API-safe token with deprecation metadata attached\r\n *\r\n * @example\r\n * ```typescript\r\n * // Deprecate oldLoggerToken in favor of loggerToken\r\n * const wellKnownTokens = {\r\n *   oldLoggerToken: markAsDeprecated(\r\n *     oldLoggerInternalToken,\r\n *     \"Use enhanced logger v2 with better performance\",\r\n *     loggerToken,\r\n *     \"2.0.0\"\r\n *   ),\r\n *   loggerToken: markAsApiSafe(loggerToken)\r\n * };\r\n *\r\n * // User code will see:\r\n * // ⚠️ DEPRECATED: Token \"oldLoggerToken\" is deprecated.\r\n * // Reason: Use enhanced logger v2 with better performance\r\n * // Use \"Symbol(Logger)\" instead.\r\n * // This token will be removed in version 2.0.0.\r\n * ```\r\n */\r\nexport function markAsDeprecated<T extends ServiceType>(\r\n  token: InjectionToken<T>,\r\n  reason: string,\r\n  replacement: InjectionToken<T> | null,\r\n  removedInVersion: string\r\n): ApiSafeToken<T> {\r\n  const apiSafeToken = markAsApiSafe(token);\r\n\r\n  // Store deprecation metadata in Map (symbols are valid keys)\r\n  deprecationMetadata.set(apiSafeToken, {\r\n    reason,\r\n    replacement: replacement ? String(replacement) : null,\r\n    removedInVersion,\r\n    warningShown: false,\r\n  });\r\n\r\n  return apiSafeToken;\r\n}\r\n\r\n/**\r\n * Checks if a token has deprecation metadata attached.\r\n *\r\n * @param token - Token to check\r\n * @returns Deprecation info if token is deprecated, null otherwise\r\n * @internal\r\n */\r\nexport function getDeprecationInfo(token: unknown): DeprecationInfo | null {\r\n  if (!token || typeof token !== \"symbol\") {\r\n    return null;\r\n  }\r\n  return deprecationMetadata.get(token) || null;\r\n}\r\n","/**\r\n * Checks if a property key is in the allowed methods list.\r\n *\r\n * @param prop - The property key to check\r\n * @param allowed - Array of allowed method keys\r\n * @returns True if prop is a string and in the allowed list\r\n */\r\nfunction isAllowedKey(prop: string | symbol, allowed: readonly string[]): boolean {\r\n  if (typeof prop !== \"string\") {\r\n    return false;\r\n  }\r\n  return allowed.includes(prop);\r\n}\r\n\r\n/**\r\n * Creates a read-only proxy wrapper for a service.\r\n *\r\n * Only allows access to whitelisted methods. Property access and\r\n * modifications are blocked to prevent external modules from\r\n * changing internal state.\r\n *\r\n * @param service - The service instance to wrap\r\n * @param allowedMethods - Array of method names that are allowed to be called\r\n * @returns Proxied service that only allows whitelisted methods\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicLogger = createReadOnlyWrapper(logger, [\r\n *   \"debug\", \"info\", \"warn\", \"error\"\r\n * ]);\r\n *\r\n * publicLogger.info(\"Hello\");  // ✅ OK\r\n * publicLogger.setMinLevel(0); // ❌ Error: \"setMinLevel is not accessible\"\r\n * publicLogger.minLevel = 0;   // ❌ Error: \"Cannot modify service\"\r\n * ```\r\n */\r\nexport function createReadOnlyWrapper<T extends object>(\r\n  service: T,\r\n  allowedMethods: readonly string[]\r\n): T {\r\n  return new Proxy(service, {\r\n    get(target, prop, receiver: unknown) {\r\n      // Allow whitelisted methods only\r\n      if (isAllowedKey(prop, allowedMethods)) {\r\n        const value: unknown = Reflect.get(target, prop, receiver);\r\n\r\n        // Bind 'this' context for methods\r\n        if (typeof value === \"function\") {\r\n          return value.bind(target);\r\n        }\r\n\r\n        return value;\r\n      }\r\n\r\n      // Block non-whitelisted property access\r\n      throw new Error(\r\n        `Property \"${String(prop)}\" is not accessible via Public API. ` +\r\n          `Only these methods are allowed: ${allowedMethods.map(String).join(\", \")}`\r\n      );\r\n    },\r\n\r\n    set() {\r\n      // Block all property modifications\r\n      throw new Error(\"Cannot modify services via Public API (read-only)\");\r\n    },\r\n\r\n    deleteProperty() {\r\n      // Block property deletion\r\n      throw new Error(\"Cannot delete properties via Public API (read-only)\");\r\n    },\r\n  });\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport { createReadOnlyWrapper } from \"./readonly-wrapper\";\r\n\r\n/**\r\n * Creates a read-only wrapper for Logger service.\r\n *\r\n * Only allows logging methods, blocks configuration methods like setMinLevel().\r\n * This prevents external modules from changing the global logger configuration.\r\n *\r\n * @param logger - Logger service instance\r\n * @returns Read-only logger proxy\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicLogger = createPublicLogger(logger);\r\n * publicLogger.info(\"Hello\");  // ✅ OK\r\n * publicLogger.setMinLevel(0); // ❌ Error\r\n * ```\r\n */\r\nexport function createPublicLogger(logger: Logger): Logger {\r\n  return createReadOnlyWrapper(logger, [\r\n    \"log\",\r\n    \"debug\",\r\n    \"info\",\r\n    \"warn\",\r\n    \"error\",\r\n    \"withTraceId\", // Decorator pattern for trace context\r\n  ]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for I18nFacadeService.\r\n *\r\n * Only allows read operations (translate, format, has).\r\n * Prevents modification of internal translation state.\r\n *\r\n * @param i18n - I18nFacadeService instance\r\n * @returns Read-only i18n proxy\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicI18n = createPublicI18n(i18n);\r\n * publicI18n.translate(\"key\"); // ✅ OK\r\n * publicI18n.internalState = {}; // ❌ Error\r\n * ```\r\n */\r\nexport function createPublicI18n(i18n: I18nFacadeService): I18nFacadeService {\r\n  return createReadOnlyWrapper(i18n, [\"translate\", \"format\", \"has\"]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for NotificationCenter.\r\n *\r\n * Allows routing notifications while preventing external modules from\r\n * mutating registered channels.\r\n *\r\n * @param notificationCenter - NotificationCenter instance\r\n * @returns Read-only notification proxy\r\n */\r\nexport function createPublicNotificationCenter(\r\n  notificationCenter: NotificationCenter\r\n): NotificationCenter {\r\n  return createReadOnlyWrapper(notificationCenter, [\r\n    \"debug\",\r\n    \"info\",\r\n    \"warn\",\r\n    \"error\",\r\n    \"getChannelNames\",\r\n  ]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for FoundrySettings service.\r\n *\r\n * Allows validated reads of settings while blocking registration and mutation\r\n * operations that could impact module configuration.\r\n *\r\n * @param foundrySettings - FoundrySettings service instance\r\n * @returns Read-only settings proxy\r\n */\r\nexport function createPublicFoundrySettings(foundrySettings: FoundrySettings): FoundrySettings {\r\n  return createReadOnlyWrapper(foundrySettings, [\"get\"]);\r\n}\r\n","import { markAsApiSafe } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport {\r\n  notificationCenterToken,\r\n  journalVisibilityServiceToken,\r\n  i18nFacadeToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport {\r\n  foundryGameToken,\r\n  foundryHooksToken,\r\n  foundryDocumentToken,\r\n  foundryUIToken,\r\n  foundrySettingsToken,\r\n  foundryJournalFacadeToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\n\r\n/**\r\n * Creates the well-known API tokens collection.\r\n *\r\n * All internal tokens are marked as API-safe for external consumption.\r\n * This factory is called during API initialization phase.\r\n *\r\n * @returns Type-safe token collection for external modules\r\n */\r\nexport function createApiTokens(): ModuleApiTokens {\r\n  return {\r\n    notificationCenterToken: markAsApiSafe(notificationCenterToken),\r\n    journalVisibilityServiceToken: markAsApiSafe(journalVisibilityServiceToken),\r\n    foundryGameToken: markAsApiSafe(foundryGameToken),\r\n    foundryHooksToken: markAsApiSafe(foundryHooksToken),\r\n    foundryDocumentToken: markAsApiSafe(foundryDocumentToken),\r\n    foundryUIToken: markAsApiSafe(foundryUIToken),\r\n    foundrySettingsToken: markAsApiSafe(foundrySettingsToken),\r\n    i18nFacadeToken: markAsApiSafe(i18nFacadeToken),\r\n    foundryJournalFacadeToken: markAsApiSafe(foundryJournalFacadeToken),\r\n  };\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { formatReplacementInfo } from \"@/infrastructure/shared/utils/format-deprecation-info\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { type ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport { getDeprecationInfo } from \"@/infrastructure/di/types/utilities/deprecated-token\";\r\nimport {\r\n  createPublicI18n,\r\n  createPublicNotificationCenter,\r\n  createPublicFoundrySettings,\r\n} from \"@/framework/core/api/public-api-wrappers\";\r\nimport { createApiTokens } from \"@/framework/core/api/api-token-config\";\r\nimport type {\r\n  ModuleApi,\r\n  TokenInfo,\r\n  HealthStatus,\r\n  ModuleApiTokens,\r\n} from \"@/framework/core/api/module-api\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport type { ContainerError } from \"@/infrastructure/di/interfaces\";\r\nimport {\r\n  wrapFoundrySettingsPort,\r\n  wrapI18nService,\r\n  wrapNotificationCenterService,\r\n  getRegistrationStatus,\r\n} from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport {\r\n  journalVisibilityServiceToken,\r\n  metricsCollectorToken,\r\n  moduleHealthServiceToken,\r\n  i18nFacadeToken,\r\n  notificationCenterToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport {\r\n  foundryGameToken,\r\n  foundryHooksToken,\r\n  foundryDocumentToken,\r\n  foundryUIToken,\r\n  foundrySettingsToken,\r\n  foundryJournalFacadeToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * ModuleApiInitializer\r\n *\r\n * Responsible for exposing the module's public API to external consumers.\r\n * Separated from CompositionRoot for Single Responsibility Principle.\r\n *\r\n * Responsibilities:\r\n * - Create API token collection\r\n * - Create API object with resolve(), getMetrics(), getHealth(), etc.\r\n * - Apply deprecation warnings (via console.warn for external visibility)\r\n * - Apply read-only wrappers for sensitive services\r\n * - Expose API to game.modules.get(MODULE_ID).api\r\n *\r\n * Design: No dependencies, uses Result-Pattern for error handling.\r\n */\r\nexport class ModuleApiInitializer {\r\n  static dependencies = [] as const;\r\n  /**\r\n   * Handles deprecation warnings for tokens.\r\n   * Logs warning to console if token is deprecated and warning hasn't been shown yet.\r\n   *\r\n   * Uses console.warn instead of Logger because:\r\n   * - Deprecation warnings are for external API consumers (not internal logs)\r\n   * - Should be visible even if Logger is disabled/configured differently\r\n   * - Follows npm/Node.js convention for deprecation warnings\r\n   *\r\n   * @param token - Token to check for deprecation\r\n   * @private\r\n   */\r\n  private handleDeprecationWarning<TServiceType extends ServiceType>(\r\n    token: ApiSafeToken<TServiceType>\r\n  ): void {\r\n    const deprecationInfo = getDeprecationInfo(token);\r\n    if (deprecationInfo && !deprecationInfo.warningShown) {\r\n      const replacementInfo = formatReplacementInfo(deprecationInfo.replacement);\r\n      console.warn(\r\n        `[${MODULE_CONSTANTS.MODULE.ID}] DEPRECATED: Token \"${String(token)}\" is deprecated.\\n` +\r\n          `Reason: ${deprecationInfo.reason}\\n` +\r\n          replacementInfo +\r\n          `This token will be removed in version ${deprecationInfo.removedInVersion}.`\r\n      );\r\n      deprecationInfo.warningShown = true; // Only warn once per session\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates the resolve() function for the public API.\r\n   * Resolves services and applies wrappers (throws on error).\r\n   *\r\n   * @param container - ServiceContainer for resolution\r\n   * @returns Resolve function for ModuleApi\r\n   * @private\r\n   */\r\n  private createResolveFunction(\r\n    container: ServiceContainer,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): <TServiceType extends ServiceType>(token: ApiSafeToken<TServiceType>) => TServiceType {\r\n    return <TServiceType extends ServiceType>(token: ApiSafeToken<TServiceType>): TServiceType => {\r\n      // Handle deprecation warnings\r\n      this.handleDeprecationWarning(token);\r\n\r\n      // Resolve service from container\r\n      const service: TServiceType = container.resolve(token);\r\n\r\n      return this.wrapSensitiveService(token, service, wellKnownTokens);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Creates the resolveWithError() function for the public API.\r\n   * Resolves services with Result pattern (never throws).\r\n   *\r\n   * @param container - ServiceContainer for resolution\r\n   * @returns ResolveWithError function for ModuleApi\r\n   * @private\r\n   */\r\n  private createResolveWithErrorFunction(\r\n    container: ServiceContainer,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): <TServiceType extends ServiceType>(\r\n    token: ApiSafeToken<TServiceType>\r\n  ) => Result<TServiceType, ContainerError> {\r\n    return <TServiceType extends ServiceType>(\r\n      token: ApiSafeToken<TServiceType>\r\n    ): Result<TServiceType, ContainerError> => {\r\n      // Handle deprecation warnings\r\n      this.handleDeprecationWarning(token);\r\n\r\n      // Resolve with Result-Pattern (never throws)\r\n      const result = container.resolveWithError(token);\r\n\r\n      // Apply wrappers if resolution succeeded\r\n      if (!result.ok) {\r\n        return result; // Return error as-is\r\n      }\r\n\r\n      const service = result.value;\r\n\r\n      const wrappedService = this.wrapSensitiveService(token, service, wellKnownTokens);\r\n      return ok(wrappedService);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Applies read-only wrappers when API consumers resolve sensitive services.\r\n   *\r\n   * @param token - API token used for resolution\r\n   * @param service - Service resolved from the container\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Wrapped service when applicable\r\n   * @private\r\n   */\r\n  private wrapSensitiveService<TServiceType extends ServiceType>(\r\n    token: ApiSafeToken<TServiceType>,\r\n    service: TServiceType,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): TServiceType {\r\n    if (token === wellKnownTokens.i18nFacadeToken) {\r\n      return wrapI18nService(service, createPublicI18n);\r\n    }\r\n\r\n    if (token === wellKnownTokens.notificationCenterToken) {\r\n      return wrapNotificationCenterService(service, createPublicNotificationCenter);\r\n    }\r\n\r\n    if (token === wellKnownTokens.foundrySettingsToken) {\r\n      return wrapFoundrySettingsPort(service, createPublicFoundrySettings);\r\n    }\r\n\r\n    // Default: return original service for read-only or safe services\r\n    return service;\r\n  }\r\n\r\n  /**\r\n   * Creates the complete ModuleApi object with all methods.\r\n   *\r\n   * @param container - ServiceContainer for service resolution\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Complete ModuleApi object\r\n   * @private\r\n   */\r\n  private createApiObject(\r\n    container: ServiceContainer,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): ModuleApi {\r\n    return {\r\n      version: MODULE_CONSTANTS.API.VERSION,\r\n\r\n      // Overloaded resolve method (throws on error)\r\n      resolve: this.createResolveFunction(container, wellKnownTokens),\r\n\r\n      // Result-Pattern method (safe, never throws)\r\n      resolveWithError: this.createResolveWithErrorFunction(container, wellKnownTokens),\r\n\r\n      getAvailableTokens: (): Map<symbol, TokenInfo> => {\r\n        const tokenMap = new Map<symbol, TokenInfo>();\r\n\r\n        // Add well-known tokens with their registration status\r\n        const tokenEntries: Array<[string, InjectionToken<ServiceType>]> = [\r\n          [\"journalVisibilityServiceToken\", journalVisibilityServiceToken],\r\n          [\"foundryGameToken\", foundryGameToken],\r\n          [\"foundryHooksToken\", foundryHooksToken],\r\n          [\"foundryDocumentToken\", foundryDocumentToken],\r\n          [\"foundryUIToken\", foundryUIToken],\r\n          [\"foundrySettingsToken\", foundrySettingsToken],\r\n          [\"i18nFacadeToken\", i18nFacadeToken],\r\n          [\"foundryJournalFacadeToken\", foundryJournalFacadeToken],\r\n          [\"notificationCenterToken\", notificationCenterToken],\r\n        ];\r\n\r\n        for (const [, token] of tokenEntries) {\r\n          const isRegisteredResult = container.isRegistered(token);\r\n          tokenMap.set(token, {\r\n            description: String(token).replace(\"Symbol(\", \"\").replace(\")\", \"\"),\r\n            isRegistered: getRegistrationStatus(isRegisteredResult),\r\n          });\r\n        }\r\n\r\n        return tokenMap;\r\n      },\r\n\r\n      tokens: wellKnownTokens,\r\n\r\n      getMetrics: () => {\r\n        const metricsResult = container.resolveWithError(metricsCollectorToken);\r\n        if (!metricsResult.ok) {\r\n          return {\r\n            containerResolutions: 0,\r\n            resolutionErrors: 0,\r\n            avgResolutionTimeMs: 0,\r\n            portSelections: {},\r\n            portSelectionFailures: {},\r\n            cacheHitRate: 0,\r\n          };\r\n        }\r\n        return metricsResult.value.getSnapshot();\r\n      },\r\n\r\n      getHealth: (): HealthStatus => {\r\n        // Delegate to ModuleHealthService for health checks\r\n        const healthServiceResult = container.resolveWithError(moduleHealthServiceToken);\r\n        if (!healthServiceResult.ok) {\r\n          // Fallback health status if service cannot be resolved\r\n          return {\r\n            status: \"unhealthy\",\r\n            checks: {\r\n              containerValidated: false,\r\n              portsSelected: false,\r\n              lastError: \"ModuleHealthService not available\",\r\n            },\r\n            timestamp: new Date().toISOString(),\r\n          };\r\n        }\r\n        return healthServiceResult.value.getHealth();\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Exposes the module's public API to game.modules.get(MODULE_ID).api\r\n   *\r\n   * @param container - Initialized and validated ServiceContainer\r\n   * @returns Result<void, string> - Ok if successful, Err with error message\r\n   */\r\n  expose(container: ServiceContainer): Result<void, string> {\r\n    // Guard: Foundry game object available?\r\n    if (typeof game === \"undefined\" || !game?.modules) {\r\n      return err(\"Game modules not available - API cannot be exposed\");\r\n    }\r\n\r\n    const mod = game.modules.get(MODULE_CONSTANTS.MODULE.ID);\r\n    if (!mod) {\r\n      return err(`Module '${MODULE_CONSTANTS.MODULE.ID}' not found in game.modules`);\r\n    }\r\n\r\n    // Create well-known tokens collection\r\n    const wellKnownTokens = createApiTokens();\r\n\r\n    // Create complete API object\r\n    const api = this.createApiObject(container, wellKnownTokens);\r\n\r\n    // Expose API to Foundry module\r\n    mod.api = api;\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\nexport class DIModuleApiInitializer extends ModuleApiInitializer {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","/**\r\n * Registry for health checks.\r\n * Services can register themselves for health monitoring.\r\n */\r\n\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport type { HealthCheck } from \"./health-check.interface\";\r\n\r\nexport class HealthCheckRegistry implements Disposable {\r\n  static dependencies = [] as const;\r\n\r\n  private checks = new Map<string, HealthCheck>();\r\n\r\n  register(check: HealthCheck): void {\r\n    this.checks.set(check.name, check);\r\n  }\r\n\r\n  unregister(name: string): void {\r\n    this.checks.delete(name);\r\n  }\r\n\r\n  runAll(): Map<string, boolean> {\r\n    const results = new Map<string, boolean>();\r\n    for (const [name, check] of this.checks) {\r\n      results.set(name, check.check());\r\n    }\r\n    return results;\r\n  }\r\n\r\n  getCheck(name: string): HealthCheck | undefined {\r\n    return this.checks.get(name);\r\n  }\r\n\r\n  getAllChecks(): HealthCheck[] {\r\n    return Array.from(this.checks.values());\r\n  }\r\n\r\n  dispose(): void {\r\n    for (const check of this.checks.values()) {\r\n      check.dispose();\r\n    }\r\n    this.checks.clear();\r\n  }\r\n}\r\n\r\nexport class DIHealthCheckRegistry extends HealthCheckRegistry {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","// src/storages/globalConfig/globalConfig.ts\nvar store;\nfunction setGlobalConfig(config2) {\n  store = { ...store, ...config2 };\n}\n// @__NO_SIDE_EFFECTS__\nfunction getGlobalConfig(config2) {\n  return {\n    lang: config2?.lang ?? store?.lang,\n    message: config2?.message,\n    abortEarly: config2?.abortEarly ?? store?.abortEarly,\n    abortPipeEarly: config2?.abortPipeEarly ?? store?.abortPipeEarly\n  };\n}\nfunction deleteGlobalConfig() {\n  store = void 0;\n}\n\n// src/storages/globalMessage/globalMessage.ts\nvar store2;\nfunction setGlobalMessage(message2, lang) {\n  if (!store2) store2 = /* @__PURE__ */ new Map();\n  store2.set(lang, message2);\n}\n// @__NO_SIDE_EFFECTS__\nfunction getGlobalMessage(lang) {\n  return store2?.get(lang);\n}\nfunction deleteGlobalMessage(lang) {\n  store2?.delete(lang);\n}\n\n// src/storages/schemaMessage/schemaMessage.ts\nvar store3;\nfunction setSchemaMessage(message2, lang) {\n  if (!store3) store3 = /* @__PURE__ */ new Map();\n  store3.set(lang, message2);\n}\n// @__NO_SIDE_EFFECTS__\nfunction getSchemaMessage(lang) {\n  return store3?.get(lang);\n}\nfunction deleteSchemaMessage(lang) {\n  store3?.delete(lang);\n}\n\n// src/storages/specificMessage/specificMessage.ts\nvar store4;\nfunction setSpecificMessage(reference, message2, lang) {\n  if (!store4) store4 = /* @__PURE__ */ new Map();\n  if (!store4.get(reference)) store4.set(reference, /* @__PURE__ */ new Map());\n  store4.get(reference).set(lang, message2);\n}\n// @__NO_SIDE_EFFECTS__\nfunction getSpecificMessage(reference, lang) {\n  return store4?.get(reference)?.get(lang);\n}\nfunction deleteSpecificMessage(reference, lang) {\n  store4?.get(reference)?.delete(lang);\n}\n\n// src/utils/_stringify/_stringify.ts\n// @__NO_SIDE_EFFECTS__\nfunction _stringify(input) {\n  const type = typeof input;\n  if (type === \"string\") {\n    return `\"${input}\"`;\n  }\n  if (type === \"number\" || type === \"bigint\" || type === \"boolean\") {\n    return `${input}`;\n  }\n  if (type === \"object\" || type === \"function\") {\n    return (input && Object.getPrototypeOf(input)?.constructor?.name) ?? \"null\";\n  }\n  return type;\n}\n\n// src/utils/_addIssue/_addIssue.ts\nfunction _addIssue(context, label, dataset, config2, other) {\n  const input = other && \"input\" in other ? other.input : dataset.value;\n  const expected = other?.expected ?? context.expects ?? null;\n  const received = other?.received ?? _stringify(input);\n  const issue = {\n    kind: context.kind,\n    type: context.type,\n    input,\n    expected,\n    received,\n    message: `Invalid ${label}: ${expected ? `Expected ${expected} but r` : \"R\"}eceived ${received}`,\n    requirement: context.requirement,\n    path: other?.path,\n    issues: other?.issues,\n    lang: config2.lang,\n    abortEarly: config2.abortEarly,\n    abortPipeEarly: config2.abortPipeEarly\n  };\n  const isSchema = context.kind === \"schema\";\n  const message2 = other?.message ?? context.message ?? getSpecificMessage(context.reference, issue.lang) ?? (isSchema ? getSchemaMessage(issue.lang) : null) ?? config2.message ?? getGlobalMessage(issue.lang);\n  if (message2 !== void 0) {\n    issue.message = typeof message2 === \"function\" ? (\n      // @ts-expect-error\n      message2(issue)\n    ) : message2;\n  }\n  if (isSchema) {\n    dataset.typed = false;\n  }\n  if (dataset.issues) {\n    dataset.issues.push(issue);\n  } else {\n    dataset.issues = [issue];\n  }\n}\n\n// src/utils/_getByteCount/_getByteCount.ts\nvar textEncoder;\n// @__NO_SIDE_EFFECTS__\nfunction _getByteCount(input) {\n  if (!textEncoder) {\n    textEncoder = new TextEncoder();\n  }\n  return textEncoder.encode(input).length;\n}\n\n// src/utils/_getGraphemeCount/_getGraphemeCount.ts\nvar segmenter;\n// @__NO_SIDE_EFFECTS__\nfunction _getGraphemeCount(input) {\n  if (!segmenter) {\n    segmenter = new Intl.Segmenter();\n  }\n  const segments = segmenter.segment(input);\n  let count = 0;\n  for (const _ of segments) {\n    count++;\n  }\n  return count;\n}\n\n// src/utils/_getLastMetadata/_getLastMetadata.ts\n// @__NO_SIDE_EFFECTS__\nfunction _getLastMetadata(schema, type) {\n  if (\"pipe\" in schema) {\n    const nestedSchemas = [];\n    for (let index = schema.pipe.length - 1; index >= 0; index--) {\n      const item = schema.pipe[index];\n      if (item.kind === \"schema\" && \"pipe\" in item) {\n        nestedSchemas.push(item);\n      } else if (item.kind === \"metadata\" && item.type === type) {\n        return item[type];\n      }\n    }\n    for (const nestedSchema of nestedSchemas) {\n      const result = /* @__PURE__ */ _getLastMetadata(nestedSchema, type);\n      if (result !== void 0) {\n        return result;\n      }\n    }\n  }\n}\n\n// src/utils/_getStandardProps/_getStandardProps.ts\n// @__NO_SIDE_EFFECTS__\nfunction _getStandardProps(context) {\n  return {\n    version: 1,\n    vendor: \"valibot\",\n    validate(value2) {\n      return context[\"~run\"]({ value: value2 }, getGlobalConfig());\n    }\n  };\n}\n\n// src/utils/_getWordCount/_getWordCount.ts\nvar store5;\n// @__NO_SIDE_EFFECTS__\nfunction _getWordCount(locales, input) {\n  if (!store5) {\n    store5 = /* @__PURE__ */ new Map();\n  }\n  if (!store5.get(locales)) {\n    store5.set(locales, new Intl.Segmenter(locales, { granularity: \"word\" }));\n  }\n  const segments = store5.get(locales).segment(input);\n  let count = 0;\n  for (const segment of segments) {\n    if (segment.isWordLike) {\n      count++;\n    }\n  }\n  return count;\n}\n\n// src/utils/_isLuhnAlgo/_isLuhnAlgo.ts\nvar NON_DIGIT_REGEX = /\\D/gu;\n// @__NO_SIDE_EFFECTS__\nfunction _isLuhnAlgo(input) {\n  const number2 = input.replace(NON_DIGIT_REGEX, \"\");\n  let length2 = number2.length;\n  let bit = 1;\n  let sum = 0;\n  while (length2) {\n    const value2 = +number2[--length2];\n    bit ^= 1;\n    sum += bit ? [0, 2, 4, 6, 8, 1, 3, 5, 7, 9][value2] : value2;\n  }\n  return sum % 10 === 0;\n}\n\n// src/utils/_isValidObjectKey/_isValidObjectKey.ts\n// @__NO_SIDE_EFFECTS__\nfunction _isValidObjectKey(object2, key) {\n  return Object.hasOwn(object2, key) && key !== \"__proto__\" && key !== \"prototype\" && key !== \"constructor\";\n}\n\n// src/utils/_joinExpects/_joinExpects.ts\n// @__NO_SIDE_EFFECTS__\nfunction _joinExpects(values2, separator) {\n  const list = [...new Set(values2)];\n  if (list.length > 1) {\n    return `(${list.join(` ${separator} `)})`;\n  }\n  return list[0] ?? \"never\";\n}\n\n// src/utils/entriesFromList/entriesFromList.ts\n// @__NO_SIDE_EFFECTS__\nfunction entriesFromList(list, schema) {\n  const entries2 = {};\n  for (const key of list) {\n    entries2[key] = schema;\n  }\n  return entries2;\n}\n\n// src/utils/entriesFromObjects/entriesFromObjects.ts\n// @__NO_SIDE_EFFECTS__\nfunction entriesFromObjects(schemas) {\n  const entries2 = {};\n  for (const schema of schemas) {\n    Object.assign(entries2, schema.entries);\n  }\n  return entries2;\n}\n\n// src/utils/getDotPath/getDotPath.ts\n// @__NO_SIDE_EFFECTS__\nfunction getDotPath(issue) {\n  if (issue.path) {\n    let key = \"\";\n    for (const item of issue.path) {\n      if (typeof item.key === \"string\" || typeof item.key === \"number\") {\n        if (key) {\n          key += `.${item.key}`;\n        } else {\n          key += item.key;\n        }\n      } else {\n        return null;\n      }\n    }\n    return key;\n  }\n  return null;\n}\n\n// src/utils/isOfKind/isOfKind.ts\n// @__NO_SIDE_EFFECTS__\nfunction isOfKind(kind, object2) {\n  return object2.kind === kind;\n}\n\n// src/utils/isOfType/isOfType.ts\n// @__NO_SIDE_EFFECTS__\nfunction isOfType(type, object2) {\n  return object2.type === type;\n}\n\n// src/utils/isValiError/isValiError.ts\n// @__NO_SIDE_EFFECTS__\nfunction isValiError(error) {\n  return error instanceof ValiError;\n}\n\n// src/utils/ValiError/ValiError.ts\nvar ValiError = class extends Error {\n  /**\n   * Creates a Valibot error with useful information.\n   *\n   * @param issues The error issues.\n   */\n  constructor(issues) {\n    super(issues[0].message);\n    this.name = \"ValiError\";\n    this.issues = issues;\n  }\n};\n\n// src/actions/args/args.ts\n// @__NO_SIDE_EFFECTS__\nfunction args(schema) {\n  return {\n    kind: \"transformation\",\n    type: \"args\",\n    reference: args,\n    async: false,\n    schema,\n    \"~run\"(dataset, config2) {\n      const func = dataset.value;\n      dataset.value = (...args_) => {\n        const argsDataset = this.schema[\"~run\"]({ value: args_ }, config2);\n        if (argsDataset.issues) {\n          throw new ValiError(argsDataset.issues);\n        }\n        return func(...argsDataset.value);\n      };\n      return dataset;\n    }\n  };\n}\n\n// src/actions/args/argsAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction argsAsync(schema) {\n  return {\n    kind: \"transformation\",\n    type: \"args\",\n    reference: argsAsync,\n    async: false,\n    schema,\n    \"~run\"(dataset, config2) {\n      const func = dataset.value;\n      dataset.value = async (...args2) => {\n        const argsDataset = await schema[\"~run\"]({ value: args2 }, config2);\n        if (argsDataset.issues) {\n          throw new ValiError(argsDataset.issues);\n        }\n        return func(...argsDataset.value);\n      };\n      return dataset;\n    }\n  };\n}\n\n// src/actions/await/awaitAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction awaitAsync() {\n  return {\n    kind: \"transformation\",\n    type: \"await\",\n    reference: awaitAsync,\n    async: true,\n    async \"~run\"(dataset) {\n      dataset.value = await dataset.value;\n      return dataset;\n    }\n  };\n}\n\n// src/regex.ts\nvar BASE64_REGEX = /^(?:[\\da-z+/]{4})*(?:[\\da-z+/]{2}==|[\\da-z+/]{3}=)?$/iu;\nvar BIC_REGEX = /^[A-Z]{6}(?!00)[\\dA-Z]{2}(?:[\\dA-Z]{3})?$/u;\nvar CUID2_REGEX = /^[a-z][\\da-z]*$/u;\nvar DECIMAL_REGEX = /^[+-]?(?:\\d*\\.)?\\d+$/u;\nvar DIGITS_REGEX = /^\\d+$/u;\nvar EMAIL_REGEX = /^[\\w+-]+(?:\\.[\\w+-]+)*@[\\da-z]+(?:[.-][\\da-z]+)*\\.[a-z]{2,}$/iu;\nvar EMOJI_REGEX = (\n  // eslint-disable-next-line redos-detector/no-unsafe-regex, regexp/no-dupe-disjunctions -- false positives\n  /^(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|\\u{1F3F4}[\\u{E0061}-\\u{E007A}]{2}[\\u{E0030}-\\u{E0039}\\u{E0061}-\\u{E007A}]{1,3}\\u{E007F}|(?:\\p{Emoji}\\uFE0F\\u20E3?|\\p{Emoji_Modifier_Base}\\p{Emoji_Modifier}?|\\p{Emoji_Presentation})(?:\\u200D(?:\\p{Emoji}\\uFE0F\\u20E3?|\\p{Emoji_Modifier_Base}\\p{Emoji_Modifier}?|\\p{Emoji_Presentation}))*)+$/u\n);\nvar HEXADECIMAL_REGEX = /^(?:0[hx])?[\\da-fA-F]+$/u;\nvar HEX_COLOR_REGEX = /^#(?:[\\da-fA-F]{3,4}|[\\da-fA-F]{6}|[\\da-fA-F]{8})$/u;\nvar IMEI_REGEX = /^\\d{15}$|^\\d{2}-\\d{6}-\\d{6}-\\d$/u;\nvar IPV4_REGEX = (\n  // eslint-disable-next-line redos-detector/no-unsafe-regex -- false positive\n  /^(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])(?:\\.(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])){3}$/u\n);\nvar IPV6_REGEX = /^(?:(?:[\\da-f]{1,4}:){7}[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,7}:|(?:[\\da-f]{1,4}:){1,6}:[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,5}(?::[\\da-f]{1,4}){1,2}|(?:[\\da-f]{1,4}:){1,4}(?::[\\da-f]{1,4}){1,3}|(?:[\\da-f]{1,4}:){1,3}(?::[\\da-f]{1,4}){1,4}|(?:[\\da-f]{1,4}:){1,2}(?::[\\da-f]{1,4}){1,5}|[\\da-f]{1,4}:(?::[\\da-f]{1,4}){1,6}|:(?:(?::[\\da-f]{1,4}){1,7}|:)|fe80:(?::[\\da-f]{0,4}){0,4}%[\\da-z]+|::(?:f{4}(?::0{1,4})?:)?(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)|(?:[\\da-f]{1,4}:){1,4}:(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d))$/iu;\nvar IP_REGEX = /^(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])(?:\\.(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])){3}$|^(?:(?:[\\da-f]{1,4}:){7}[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,7}:|(?:[\\da-f]{1,4}:){1,6}:[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,5}(?::[\\da-f]{1,4}){1,2}|(?:[\\da-f]{1,4}:){1,4}(?::[\\da-f]{1,4}){1,3}|(?:[\\da-f]{1,4}:){1,3}(?::[\\da-f]{1,4}){1,4}|(?:[\\da-f]{1,4}:){1,2}(?::[\\da-f]{1,4}){1,5}|[\\da-f]{1,4}:(?::[\\da-f]{1,4}){1,6}|:(?:(?::[\\da-f]{1,4}){1,7}|:)|fe80:(?::[\\da-f]{0,4}){0,4}%[\\da-z]+|::(?:f{4}(?::0{1,4})?:)?(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)|(?:[\\da-f]{1,4}:){1,4}:(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d))$/iu;\nvar ISO_DATE_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])$/u;\nvar ISO_DATE_TIME_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])[T ](?:0\\d|1\\d|2[0-3]):[0-5]\\d$/u;\nvar ISO_TIME_REGEX = /^(?:0\\d|1\\d|2[0-3]):[0-5]\\d$/u;\nvar ISO_TIME_SECOND_REGEX = /^(?:0\\d|1\\d|2[0-3])(?::[0-5]\\d){2}$/u;\nvar ISO_TIMESTAMP_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])[T ](?:0\\d|1\\d|2[0-3])(?::[0-5]\\d){2}(?:\\.\\d{1,9})?(?:Z|[+-](?:0\\d|1\\d|2[0-3])(?::?[0-5]\\d)?)$/u;\nvar ISO_WEEK_REGEX = /^\\d{4}-W(?:0[1-9]|[1-4]\\d|5[0-3])$/u;\nvar MAC48_REGEX = /^(?:[\\da-f]{2}:){5}[\\da-f]{2}$|^(?:[\\da-f]{2}-){5}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){2}[\\da-f]{4}$/iu;\nvar MAC64_REGEX = /^(?:[\\da-f]{2}:){7}[\\da-f]{2}$|^(?:[\\da-f]{2}-){7}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){3}[\\da-f]{4}$|^(?:[\\da-f]{4}:){3}[\\da-f]{4}$/iu;\nvar MAC_REGEX = /^(?:[\\da-f]{2}:){5}[\\da-f]{2}$|^(?:[\\da-f]{2}-){5}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){2}[\\da-f]{4}$|^(?:[\\da-f]{2}:){7}[\\da-f]{2}$|^(?:[\\da-f]{2}-){7}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){3}[\\da-f]{4}$|^(?:[\\da-f]{4}:){3}[\\da-f]{4}$/iu;\nvar NANO_ID_REGEX = /^[\\w-]+$/u;\nvar OCTAL_REGEX = /^(?:0o)?[0-7]+$/u;\nvar RFC_EMAIL_REGEX = (\n  // eslint-disable-next-line regexp/prefer-w, no-useless-escape, regexp/no-useless-escape, regexp/require-unicode-regexp\n  /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/\n);\nvar SLUG_REGEX = /^[\\da-z]+(?:[-_][\\da-z]+)*$/u;\nvar ULID_REGEX = /^[\\da-hjkmnp-tv-zA-HJKMNP-TV-Z]{26}$/u;\nvar UUID_REGEX = /^[\\da-f]{8}(?:-[\\da-f]{4}){3}-[\\da-f]{12}$/iu;\n\n// src/actions/base64/base64.ts\n// @__NO_SIDE_EFFECTS__\nfunction base64(message2) {\n  return {\n    kind: \"validation\",\n    type: \"base64\",\n    reference: base64,\n    async: false,\n    expects: null,\n    requirement: BASE64_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"Base64\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/bic/bic.ts\n// @__NO_SIDE_EFFECTS__\nfunction bic(message2) {\n  return {\n    kind: \"validation\",\n    type: \"bic\",\n    reference: bic,\n    async: false,\n    expects: null,\n    requirement: BIC_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"BIC\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/brand/brand.ts\n// @__NO_SIDE_EFFECTS__\nfunction brand(name) {\n  return {\n    kind: \"transformation\",\n    type: \"brand\",\n    reference: brand,\n    async: false,\n    name,\n    \"~run\"(dataset) {\n      return dataset;\n    }\n  };\n}\n\n// src/actions/bytes/bytes.ts\n// @__NO_SIDE_EFFECTS__\nfunction bytes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"bytes\",\n    reference: bytes,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const length2 = _getByteCount(dataset.value);\n        if (length2 !== this.requirement) {\n          _addIssue(this, \"bytes\", dataset, config2, {\n            received: `${length2}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/check/check.ts\n// @__NO_SIDE_EFFECTS__\nfunction check(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"check\",\n    reference: check,\n    async: false,\n    expects: null,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"input\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/check/checkAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction checkAsync(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"check\",\n    reference: checkAsync,\n    async: true,\n    expects: null,\n    requirement,\n    message: message2,\n    async \"~run\"(dataset, config2) {\n      if (dataset.typed && !await this.requirement(dataset.value)) {\n        _addIssue(this, \"input\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/checkItems/checkItems.ts\n// @__NO_SIDE_EFFECTS__\nfunction checkItems(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"check_items\",\n    reference: checkItems,\n    async: false,\n    expects: null,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        for (let index = 0; index < dataset.value.length; index++) {\n          const item = dataset.value[index];\n          if (!this.requirement(item, index, dataset.value)) {\n            _addIssue(this, \"item\", dataset, config2, {\n              input: item,\n              path: [\n                {\n                  type: \"array\",\n                  origin: \"value\",\n                  input: dataset.value,\n                  key: index,\n                  value: item\n                }\n              ]\n            });\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/checkItems/checkItemsAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction checkItemsAsync(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"check_items\",\n    reference: checkItemsAsync,\n    async: true,\n    expects: null,\n    requirement,\n    message: message2,\n    async \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const requirementResults = await Promise.all(\n          dataset.value.map(this.requirement)\n        );\n        for (let index = 0; index < dataset.value.length; index++) {\n          if (!requirementResults[index]) {\n            const item = dataset.value[index];\n            _addIssue(this, \"item\", dataset, config2, {\n              input: item,\n              path: [\n                {\n                  type: \"array\",\n                  origin: \"value\",\n                  input: dataset.value,\n                  key: index,\n                  value: item\n                }\n              ]\n            });\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/creditCard/creditCard.ts\nvar CREDIT_CARD_REGEX = /^(?:\\d{14,19}|\\d{4}(?: \\d{3,6}){2,4}|\\d{4}(?:-\\d{3,6}){2,4})$/u;\nvar SANITIZE_REGEX = /[- ]/gu;\nvar PROVIDER_REGEX_LIST = [\n  // American Express\n  /^3[47]\\d{13}$/u,\n  // Diners Club\n  /^3(?:0[0-5]|[68]\\d)\\d{11,13}$/u,\n  // Discover\n  /^6(?:011|5\\d{2})\\d{12,15}$/u,\n  // JCB\n  /^(?:2131|1800|35\\d{3})\\d{11}$/u,\n  // Mastercard\n  // eslint-disable-next-line redos-detector/no-unsafe-regex\n  /^5[1-5]\\d{2}|(?:222\\d|22[3-9]\\d|2[3-6]\\d{2}|27[01]\\d|2720)\\d{12}$/u,\n  // UnionPay\n  /^(?:6[27]\\d{14,17}|81\\d{14,17})$/u,\n  // Visa\n  /^4\\d{12}(?:\\d{3,6})?$/u\n];\n// @__NO_SIDE_EFFECTS__\nfunction creditCard(message2) {\n  return {\n    kind: \"validation\",\n    type: \"credit_card\",\n    reference: creditCard,\n    async: false,\n    expects: null,\n    requirement(input) {\n      let sanitized;\n      return CREDIT_CARD_REGEX.test(input) && // Remove any hyphens and blanks\n      (sanitized = input.replace(SANITIZE_REGEX, \"\")) && // Check if it matches a provider\n      PROVIDER_REGEX_LIST.some((regex2) => regex2.test(sanitized)) && // Check if passes luhn algorithm\n      _isLuhnAlgo(sanitized);\n    },\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"credit card\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/cuid2/cuid2.ts\n// @__NO_SIDE_EFFECTS__\nfunction cuid2(message2) {\n  return {\n    kind: \"validation\",\n    type: \"cuid2\",\n    reference: cuid2,\n    async: false,\n    expects: null,\n    requirement: CUID2_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"Cuid2\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/decimal/decimal.ts\n// @__NO_SIDE_EFFECTS__\nfunction decimal(message2) {\n  return {\n    kind: \"validation\",\n    type: \"decimal\",\n    reference: decimal,\n    async: false,\n    expects: null,\n    requirement: DECIMAL_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"decimal\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/description/description.ts\n// @__NO_SIDE_EFFECTS__\nfunction description(description_) {\n  return {\n    kind: \"metadata\",\n    type: \"description\",\n    reference: description,\n    description: description_\n  };\n}\n\n// src/actions/digits/digits.ts\n// @__NO_SIDE_EFFECTS__\nfunction digits(message2) {\n  return {\n    kind: \"validation\",\n    type: \"digits\",\n    reference: digits,\n    async: false,\n    expects: null,\n    requirement: DIGITS_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"digits\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/email/email.ts\n// @__NO_SIDE_EFFECTS__\nfunction email(message2) {\n  return {\n    kind: \"validation\",\n    type: \"email\",\n    reference: email,\n    expects: null,\n    async: false,\n    requirement: EMAIL_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"email\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/emoji/emoji.ts\n// @__NO_SIDE_EFFECTS__\nfunction emoji(message2) {\n  return {\n    kind: \"validation\",\n    type: \"emoji\",\n    reference: emoji,\n    async: false,\n    expects: null,\n    requirement: EMOJI_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"emoji\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/empty/empty.ts\n// @__NO_SIDE_EFFECTS__\nfunction empty(message2) {\n  return {\n    kind: \"validation\",\n    type: \"empty\",\n    reference: empty,\n    async: false,\n    expects: \"0\",\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length > 0) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: `${dataset.value.length}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/endsWith/endsWith.ts\n// @__NO_SIDE_EFFECTS__\nfunction endsWith(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"ends_with\",\n    reference: endsWith,\n    async: false,\n    expects: `\"${requirement}\"`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !dataset.value.endsWith(this.requirement)) {\n        _addIssue(this, \"end\", dataset, config2, {\n          received: `\"${dataset.value.slice(-this.requirement.length)}\"`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/entries/entries.ts\n// @__NO_SIDE_EFFECTS__\nfunction entries(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"entries\",\n    reference: entries,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (!dataset.typed) return dataset;\n      const count = Object.keys(dataset.value).length;\n      if (dataset.typed && count !== this.requirement) {\n        _addIssue(this, \"entries\", dataset, config2, {\n          received: `${count}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/everyItem/everyItem.ts\n// @__NO_SIDE_EFFECTS__\nfunction everyItem(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"every_item\",\n    reference: everyItem,\n    async: false,\n    expects: null,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !dataset.value.every(this.requirement)) {\n        _addIssue(this, \"item\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/excludes/excludes.ts\n// @__NO_SIDE_EFFECTS__\nfunction excludes(requirement, message2) {\n  const received = _stringify(requirement);\n  return {\n    kind: \"validation\",\n    type: \"excludes\",\n    reference: excludes,\n    async: false,\n    expects: `!${received}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.includes(this.requirement)) {\n        _addIssue(this, \"content\", dataset, config2, { received });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/filterItems/filterItems.ts\n// @__NO_SIDE_EFFECTS__\nfunction filterItems(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"filter_items\",\n    reference: filterItems,\n    async: false,\n    operation,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.filter(this.operation);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/findItem/findItem.ts\n// @__NO_SIDE_EFFECTS__\nfunction findItem(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"find_item\",\n    reference: findItem,\n    async: false,\n    operation,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.find(this.operation);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/finite/finite.ts\n// @__NO_SIDE_EFFECTS__\nfunction finite(message2) {\n  return {\n    kind: \"validation\",\n    type: \"finite\",\n    reference: finite,\n    async: false,\n    expects: null,\n    requirement: Number.isFinite,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"finite\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/flavor/flavor.ts\n// @__NO_SIDE_EFFECTS__\nfunction flavor(name) {\n  return {\n    kind: \"transformation\",\n    type: \"flavor\",\n    reference: flavor,\n    async: false,\n    name,\n    \"~run\"(dataset) {\n      return dataset;\n    }\n  };\n}\n\n// src/actions/graphemes/graphemes.ts\n// @__NO_SIDE_EFFECTS__\nfunction graphemes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"graphemes\",\n    reference: graphemes,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getGraphemeCount(dataset.value);\n        if (count !== this.requirement) {\n          _addIssue(this, \"graphemes\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/gtValue/gtValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction gtValue(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"gt_value\",\n    reference: gtValue,\n    async: false,\n    expects: `>${requirement instanceof Date ? requirement.toJSON() : _stringify(requirement)}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !(dataset.value > this.requirement)) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/hash/hash.ts\nvar HASH_LENGTHS = {\n  md4: 32,\n  md5: 32,\n  sha1: 40,\n  sha256: 64,\n  sha384: 96,\n  sha512: 128,\n  ripemd128: 32,\n  ripemd160: 40,\n  tiger128: 32,\n  tiger160: 40,\n  tiger192: 48,\n  crc32: 8,\n  crc32b: 8,\n  adler32: 8\n};\n// @__NO_SIDE_EFFECTS__\nfunction hash(types, message2) {\n  return {\n    kind: \"validation\",\n    type: \"hash\",\n    reference: hash,\n    expects: null,\n    async: false,\n    requirement: RegExp(\n      types.map((type) => `^[a-f0-9]{${HASH_LENGTHS[type]}}$`).join(\"|\"),\n      \"iu\"\n    ),\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"hash\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/hexadecimal/hexadecimal.ts\n// @__NO_SIDE_EFFECTS__\nfunction hexadecimal(message2) {\n  return {\n    kind: \"validation\",\n    type: \"hexadecimal\",\n    reference: hexadecimal,\n    async: false,\n    expects: null,\n    requirement: HEXADECIMAL_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"hexadecimal\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/hexColor/hexColor.ts\n// @__NO_SIDE_EFFECTS__\nfunction hexColor(message2) {\n  return {\n    kind: \"validation\",\n    type: \"hex_color\",\n    reference: hexColor,\n    async: false,\n    expects: null,\n    requirement: HEX_COLOR_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"hex color\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/imei/imei.ts\n// @__NO_SIDE_EFFECTS__\nfunction imei(message2) {\n  return {\n    kind: \"validation\",\n    type: \"imei\",\n    reference: imei,\n    async: false,\n    expects: null,\n    requirement(input) {\n      return IMEI_REGEX.test(input) && _isLuhnAlgo(input);\n    },\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"IMEI\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/includes/includes.ts\n// @__NO_SIDE_EFFECTS__\nfunction includes(requirement, message2) {\n  const expects = _stringify(requirement);\n  return {\n    kind: \"validation\",\n    type: \"includes\",\n    reference: includes,\n    async: false,\n    expects,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !dataset.value.includes(this.requirement)) {\n        _addIssue(this, \"content\", dataset, config2, {\n          received: `!${expects}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/integer/integer.ts\n// @__NO_SIDE_EFFECTS__\nfunction integer(message2) {\n  return {\n    kind: \"validation\",\n    type: \"integer\",\n    reference: integer,\n    async: false,\n    expects: null,\n    requirement: Number.isInteger,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"integer\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/ip/ip.ts\n// @__NO_SIDE_EFFECTS__\nfunction ip(message2) {\n  return {\n    kind: \"validation\",\n    type: \"ip\",\n    reference: ip,\n    async: false,\n    expects: null,\n    requirement: IP_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"IP\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/ipv4/ipv4.ts\n// @__NO_SIDE_EFFECTS__\nfunction ipv4(message2) {\n  return {\n    kind: \"validation\",\n    type: \"ipv4\",\n    reference: ipv4,\n    async: false,\n    expects: null,\n    requirement: IPV4_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"IPv4\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/ipv6/ipv6.ts\n// @__NO_SIDE_EFFECTS__\nfunction ipv6(message2) {\n  return {\n    kind: \"validation\",\n    type: \"ipv6\",\n    reference: ipv6,\n    async: false,\n    expects: null,\n    requirement: IPV6_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"IPv6\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoDate/isoDate.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoDate(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_date\",\n    reference: isoDate,\n    async: false,\n    expects: null,\n    requirement: ISO_DATE_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"date\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoDateTime/isoDateTime.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoDateTime(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_date_time\",\n    reference: isoDateTime,\n    async: false,\n    expects: null,\n    requirement: ISO_DATE_TIME_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"date-time\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoTime/isoTime.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoTime(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_time\",\n    reference: isoTime,\n    async: false,\n    expects: null,\n    requirement: ISO_TIME_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"time\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoTimeSecond/isoTimeSecond.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoTimeSecond(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_time_second\",\n    reference: isoTimeSecond,\n    async: false,\n    expects: null,\n    requirement: ISO_TIME_SECOND_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"time-second\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoTimestamp/isoTimestamp.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoTimestamp(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_timestamp\",\n    reference: isoTimestamp,\n    async: false,\n    expects: null,\n    requirement: ISO_TIMESTAMP_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"timestamp\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/isoWeek/isoWeek.ts\n// @__NO_SIDE_EFFECTS__\nfunction isoWeek(message2) {\n  return {\n    kind: \"validation\",\n    type: \"iso_week\",\n    reference: isoWeek,\n    async: false,\n    expects: null,\n    requirement: ISO_WEEK_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"week\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/length/length.ts\n// @__NO_SIDE_EFFECTS__\nfunction length(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"length\",\n    reference: length,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length !== this.requirement) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: `${dataset.value.length}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/ltValue/ltValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction ltValue(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"lt_value\",\n    reference: ltValue,\n    async: false,\n    expects: `<${requirement instanceof Date ? requirement.toJSON() : _stringify(requirement)}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !(dataset.value < this.requirement)) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/mac/mac.ts\n// @__NO_SIDE_EFFECTS__\nfunction mac(message2) {\n  return {\n    kind: \"validation\",\n    type: \"mac\",\n    reference: mac,\n    async: false,\n    expects: null,\n    requirement: MAC_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"MAC\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/mac48/mac48.ts\n// @__NO_SIDE_EFFECTS__\nfunction mac48(message2) {\n  return {\n    kind: \"validation\",\n    type: \"mac48\",\n    reference: mac48,\n    async: false,\n    expects: null,\n    requirement: MAC48_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"48-bit MAC\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/mac64/mac64.ts\n// @__NO_SIDE_EFFECTS__\nfunction mac64(message2) {\n  return {\n    kind: \"validation\",\n    type: \"mac64\",\n    reference: mac64,\n    async: false,\n    expects: null,\n    requirement: MAC64_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"64-bit MAC\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/mapItems/mapItems.ts\n// @__NO_SIDE_EFFECTS__\nfunction mapItems(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"map_items\",\n    reference: mapItems,\n    async: false,\n    operation,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.map(this.operation);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxBytes/maxBytes.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxBytes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_bytes\",\n    reference: maxBytes,\n    async: false,\n    expects: `<=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const length2 = _getByteCount(dataset.value);\n        if (length2 > this.requirement) {\n          _addIssue(this, \"bytes\", dataset, config2, {\n            received: `${length2}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxEntries/maxEntries.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxEntries(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_entries\",\n    reference: maxEntries,\n    async: false,\n    expects: `<=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (!dataset.typed) return dataset;\n      const count = Object.keys(dataset.value).length;\n      if (dataset.typed && count > this.requirement) {\n        _addIssue(this, \"entries\", dataset, config2, {\n          received: `${count}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxGraphemes/maxGraphemes.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxGraphemes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_graphemes\",\n    reference: maxGraphemes,\n    async: false,\n    expects: `<=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getGraphemeCount(dataset.value);\n        if (count > this.requirement) {\n          _addIssue(this, \"graphemes\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxLength/maxLength.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxLength(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_length\",\n    reference: maxLength,\n    async: false,\n    expects: `<=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length > this.requirement) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: `${dataset.value.length}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxSize/maxSize.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxSize(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_size\",\n    reference: maxSize,\n    async: false,\n    expects: `<=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.size > this.requirement) {\n        _addIssue(this, \"size\", dataset, config2, {\n          received: `${dataset.value.size}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxValue/maxValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxValue(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_value\",\n    reference: maxValue,\n    async: false,\n    expects: `<=${requirement instanceof Date ? requirement.toJSON() : _stringify(requirement)}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !(dataset.value <= this.requirement)) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/maxWords/maxWords.ts\n// @__NO_SIDE_EFFECTS__\nfunction maxWords(locales, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"max_words\",\n    reference: maxWords,\n    async: false,\n    expects: `<=${requirement}`,\n    locales,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getWordCount(this.locales, dataset.value);\n        if (count > this.requirement) {\n          _addIssue(this, \"words\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/metadata/metadata.ts\n// @__NO_SIDE_EFFECTS__\nfunction metadata(metadata_) {\n  return {\n    kind: \"metadata\",\n    type: \"metadata\",\n    reference: metadata,\n    metadata: metadata_\n  };\n}\n\n// src/actions/mimeType/mimeType.ts\n// @__NO_SIDE_EFFECTS__\nfunction mimeType(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"mime_type\",\n    reference: mimeType,\n    async: false,\n    expects: _joinExpects(\n      requirement.map((option) => `\"${option}\"`),\n      \"|\"\n    ),\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.includes(dataset.value.type)) {\n        _addIssue(this, \"MIME type\", dataset, config2, {\n          received: `\"${dataset.value.type}\"`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minBytes/minBytes.ts\n// @__NO_SIDE_EFFECTS__\nfunction minBytes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_bytes\",\n    reference: minBytes,\n    async: false,\n    expects: `>=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const length2 = _getByteCount(dataset.value);\n        if (length2 < this.requirement) {\n          _addIssue(this, \"bytes\", dataset, config2, {\n            received: `${length2}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minEntries/minEntries.ts\n// @__NO_SIDE_EFFECTS__\nfunction minEntries(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_entries\",\n    reference: minEntries,\n    async: false,\n    expects: `>=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (!dataset.typed) return dataset;\n      const count = Object.keys(dataset.value).length;\n      if (dataset.typed && count < this.requirement) {\n        _addIssue(this, \"entries\", dataset, config2, {\n          received: `${count}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minGraphemes/minGraphemes.ts\n// @__NO_SIDE_EFFECTS__\nfunction minGraphemes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_graphemes\",\n    reference: minGraphemes,\n    async: false,\n    expects: `>=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getGraphemeCount(dataset.value);\n        if (count < this.requirement) {\n          _addIssue(this, \"graphemes\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minLength/minLength.ts\n// @__NO_SIDE_EFFECTS__\nfunction minLength(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_length\",\n    reference: minLength,\n    async: false,\n    expects: `>=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length < this.requirement) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: `${dataset.value.length}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minSize/minSize.ts\n// @__NO_SIDE_EFFECTS__\nfunction minSize(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_size\",\n    reference: minSize,\n    async: false,\n    expects: `>=${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.size < this.requirement) {\n        _addIssue(this, \"size\", dataset, config2, {\n          received: `${dataset.value.size}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minValue/minValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction minValue(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_value\",\n    reference: minValue,\n    async: false,\n    expects: `>=${requirement instanceof Date ? requirement.toJSON() : _stringify(requirement)}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !(dataset.value >= this.requirement)) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/minWords/minWords.ts\n// @__NO_SIDE_EFFECTS__\nfunction minWords(locales, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"min_words\",\n    reference: minWords,\n    async: false,\n    expects: `>=${requirement}`,\n    locales,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getWordCount(this.locales, dataset.value);\n        if (count < this.requirement) {\n          _addIssue(this, \"words\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/multipleOf/multipleOf.ts\n// @__NO_SIDE_EFFECTS__\nfunction multipleOf(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"multiple_of\",\n    reference: multipleOf,\n    async: false,\n    expects: `%${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value % this.requirement != 0) {\n        _addIssue(this, \"multiple\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/nanoid/nanoid.ts\n// @__NO_SIDE_EFFECTS__\nfunction nanoid(message2) {\n  return {\n    kind: \"validation\",\n    type: \"nanoid\",\n    reference: nanoid,\n    async: false,\n    expects: null,\n    requirement: NANO_ID_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"Nano ID\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/nonEmpty/nonEmpty.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonEmpty(message2) {\n  return {\n    kind: \"validation\",\n    type: \"non_empty\",\n    reference: nonEmpty,\n    async: false,\n    expects: \"!0\",\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length === 0) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: \"0\"\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/normalize/normalize.ts\n// @__NO_SIDE_EFFECTS__\nfunction normalize(form) {\n  return {\n    kind: \"transformation\",\n    type: \"normalize\",\n    reference: normalize,\n    async: false,\n    form,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.normalize(this.form);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notBytes/notBytes.ts\n// @__NO_SIDE_EFFECTS__\nfunction notBytes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_bytes\",\n    reference: notBytes,\n    async: false,\n    expects: `!${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const length2 = _getByteCount(dataset.value);\n        if (length2 === this.requirement) {\n          _addIssue(this, \"bytes\", dataset, config2, {\n            received: `${length2}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notEntries/notEntries.ts\n// @__NO_SIDE_EFFECTS__\nfunction notEntries(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_entries\",\n    reference: notEntries,\n    async: false,\n    expects: `!${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (!dataset.typed) return dataset;\n      const count = Object.keys(dataset.value).length;\n      if (dataset.typed && count === this.requirement) {\n        _addIssue(this, \"entries\", dataset, config2, {\n          received: `${count}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notGraphemes/notGraphemes.ts\n// @__NO_SIDE_EFFECTS__\nfunction notGraphemes(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_graphemes\",\n    reference: notGraphemes,\n    async: false,\n    expects: `!${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getGraphemeCount(dataset.value);\n        if (count === this.requirement) {\n          _addIssue(this, \"graphemes\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notLength/notLength.ts\n// @__NO_SIDE_EFFECTS__\nfunction notLength(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_length\",\n    reference: notLength,\n    async: false,\n    expects: `!${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.length === this.requirement) {\n        _addIssue(this, \"length\", dataset, config2, {\n          received: `${dataset.value.length}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notSize/notSize.ts\n// @__NO_SIDE_EFFECTS__\nfunction notSize(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_size\",\n    reference: notSize,\n    async: false,\n    expects: `!${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.size === this.requirement) {\n        _addIssue(this, \"size\", dataset, config2, {\n          received: `${dataset.value.size}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notValue/notValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction notValue(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_value\",\n    reference: notValue,\n    async: false,\n    expects: requirement instanceof Date ? `!${requirement.toJSON()}` : `!${_stringify(requirement)}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && this.requirement <= dataset.value && this.requirement >= dataset.value) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notValues/notValues.ts\n// @__NO_SIDE_EFFECTS__\nfunction notValues(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_values\",\n    reference: notValues,\n    async: false,\n    expects: `!${_joinExpects(\n      requirement.map(\n        (value2) => value2 instanceof Date ? value2.toJSON() : _stringify(value2)\n      ),\n      \"|\"\n    )}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && this.requirement.some(\n        (value2) => value2 <= dataset.value && value2 >= dataset.value\n      )) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/notWords/notWords.ts\n// @__NO_SIDE_EFFECTS__\nfunction notWords(locales, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"not_words\",\n    reference: notWords,\n    async: false,\n    expects: `!${requirement}`,\n    locales,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getWordCount(this.locales, dataset.value);\n        if (count === this.requirement) {\n          _addIssue(this, \"words\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/octal/octal.ts\n// @__NO_SIDE_EFFECTS__\nfunction octal(message2) {\n  return {\n    kind: \"validation\",\n    type: \"octal\",\n    reference: octal,\n    async: false,\n    expects: null,\n    requirement: OCTAL_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"octal\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/parseJson/parseJson.ts\n// @__NO_SIDE_EFFECTS__\nfunction parseJson(config2, message2) {\n  return {\n    kind: \"transformation\",\n    type: \"parse_json\",\n    reference: parseJson,\n    config: config2,\n    message: message2,\n    async: false,\n    \"~run\"(dataset, config3) {\n      try {\n        dataset.value = JSON.parse(dataset.value, this.config?.reviver);\n      } catch (error) {\n        if (error instanceof Error) {\n          _addIssue(this, \"JSON\", dataset, config3, {\n            received: `\"${error.message}\"`\n          });\n          dataset.typed = false;\n        } else {\n          throw error;\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/partialCheck/utils/_isPartiallyTyped/_isPartiallyTyped.ts\n// @__NO_SIDE_EFFECTS__\nfunction _isPartiallyTyped(dataset, paths) {\n  if (dataset.issues) {\n    for (const path of paths) {\n      for (const issue of dataset.issues) {\n        let typed = false;\n        const bound = Math.min(path.length, issue.path?.length ?? 0);\n        for (let index = 0; index < bound; index++) {\n          if (\n            // @ts-expect-error\n            path[index] !== issue.path[index].key && // @ts-expect-error\n            (path[index] !== \"$\" || issue.path[index].type !== \"array\")\n          ) {\n            typed = true;\n            break;\n          }\n        }\n        if (!typed) {\n          return false;\n        }\n      }\n    }\n  }\n  return true;\n}\n\n// src/actions/partialCheck/partialCheck.ts\n// @__NO_SIDE_EFFECTS__\nfunction partialCheck(paths, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"partial_check\",\n    reference: partialCheck,\n    async: false,\n    expects: null,\n    paths,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if ((dataset.typed || _isPartiallyTyped(dataset, paths)) && // @ts-expect-error\n      !this.requirement(dataset.value)) {\n        _addIssue(this, \"input\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/partialCheck/partialCheckAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction partialCheckAsync(paths, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"partial_check\",\n    reference: partialCheckAsync,\n    async: true,\n    expects: null,\n    paths,\n    requirement,\n    message: message2,\n    async \"~run\"(dataset, config2) {\n      if ((dataset.typed || _isPartiallyTyped(dataset, paths)) && // @ts-expect-error\n      !await this.requirement(dataset.value)) {\n        _addIssue(this, \"input\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/rawCheck/rawCheck.ts\n// @__NO_SIDE_EFFECTS__\nfunction rawCheck(action) {\n  return {\n    kind: \"validation\",\n    type: \"raw_check\",\n    reference: rawCheck,\n    async: false,\n    expects: null,\n    \"~run\"(dataset, config2) {\n      action({\n        dataset,\n        config: config2,\n        addIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config2, info)\n      });\n      return dataset;\n    }\n  };\n}\n\n// src/actions/rawCheck/rawCheckAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction rawCheckAsync(action) {\n  return {\n    kind: \"validation\",\n    type: \"raw_check\",\n    reference: rawCheckAsync,\n    async: true,\n    expects: null,\n    async \"~run\"(dataset, config2) {\n      await action({\n        dataset,\n        config: config2,\n        addIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config2, info)\n      });\n      return dataset;\n    }\n  };\n}\n\n// src/actions/rawTransform/rawTransform.ts\n// @__NO_SIDE_EFFECTS__\nfunction rawTransform(action) {\n  return {\n    kind: \"transformation\",\n    type: \"raw_transform\",\n    reference: rawTransform,\n    async: false,\n    \"~run\"(dataset, config2) {\n      const output = action({\n        dataset,\n        config: config2,\n        addIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config2, info),\n        NEVER: null\n      });\n      if (dataset.issues) {\n        dataset.typed = false;\n      } else {\n        dataset.value = output;\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/rawTransform/rawTransformAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction rawTransformAsync(action) {\n  return {\n    kind: \"transformation\",\n    type: \"raw_transform\",\n    reference: rawTransformAsync,\n    async: true,\n    async \"~run\"(dataset, config2) {\n      const output = await action({\n        dataset,\n        config: config2,\n        addIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config2, info),\n        NEVER: null\n      });\n      if (dataset.issues) {\n        dataset.typed = false;\n      } else {\n        dataset.value = output;\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/readonly/readonly.ts\n// @__NO_SIDE_EFFECTS__\nfunction readonly() {\n  return {\n    kind: \"transformation\",\n    type: \"readonly\",\n    reference: readonly,\n    async: false,\n    \"~run\"(dataset) {\n      return dataset;\n    }\n  };\n}\n\n// src/actions/reduceItems/reduceItems.ts\n// @__NO_SIDE_EFFECTS__\nfunction reduceItems(operation, initial) {\n  return {\n    kind: \"transformation\",\n    type: \"reduce_items\",\n    reference: reduceItems,\n    async: false,\n    operation,\n    initial,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.reduce(this.operation, this.initial);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/regex/regex.ts\n// @__NO_SIDE_EFFECTS__\nfunction regex(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"regex\",\n    reference: regex,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"format\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/returns/returns.ts\n// @__NO_SIDE_EFFECTS__\nfunction returns(schema) {\n  return {\n    kind: \"transformation\",\n    type: \"returns\",\n    reference: returns,\n    async: false,\n    schema,\n    \"~run\"(dataset, config2) {\n      const func = dataset.value;\n      dataset.value = (...args_) => {\n        const returnsDataset = this.schema[\"~run\"](\n          { value: func(...args_) },\n          config2\n        );\n        if (returnsDataset.issues) {\n          throw new ValiError(returnsDataset.issues);\n        }\n        return returnsDataset.value;\n      };\n      return dataset;\n    }\n  };\n}\n\n// src/actions/returns/returnsAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction returnsAsync(schema) {\n  return {\n    kind: \"transformation\",\n    type: \"returns\",\n    reference: returnsAsync,\n    async: false,\n    schema,\n    \"~run\"(dataset, config2) {\n      const func = dataset.value;\n      dataset.value = async (...args_) => {\n        const returnsDataset = await this.schema[\"~run\"](\n          { value: await func(...args_) },\n          config2\n        );\n        if (returnsDataset.issues) {\n          throw new ValiError(returnsDataset.issues);\n        }\n        return returnsDataset.value;\n      };\n      return dataset;\n    }\n  };\n}\n\n// src/actions/rfcEmail/rfcEmail.ts\n// @__NO_SIDE_EFFECTS__\nfunction rfcEmail(message2) {\n  return {\n    kind: \"validation\",\n    type: \"rfc_email\",\n    reference: rfcEmail,\n    expects: null,\n    async: false,\n    requirement: RFC_EMAIL_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"email\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/safeInteger/safeInteger.ts\n// @__NO_SIDE_EFFECTS__\nfunction safeInteger(message2) {\n  return {\n    kind: \"validation\",\n    type: \"safe_integer\",\n    reference: safeInteger,\n    async: false,\n    expects: null,\n    requirement: Number.isSafeInteger,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"safe integer\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/size/size.ts\n// @__NO_SIDE_EFFECTS__\nfunction size(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"size\",\n    reference: size,\n    async: false,\n    expects: `${requirement}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && dataset.value.size !== this.requirement) {\n        _addIssue(this, \"size\", dataset, config2, {\n          received: `${dataset.value.size}`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/slug/slug.ts\n// @__NO_SIDE_EFFECTS__\nfunction slug(message2) {\n  return {\n    kind: \"validation\",\n    type: \"slug\",\n    reference: slug,\n    async: false,\n    expects: null,\n    requirement: SLUG_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"slug\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/someItem/someItem.ts\n// @__NO_SIDE_EFFECTS__\nfunction someItem(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"some_item\",\n    reference: someItem,\n    async: false,\n    expects: null,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !dataset.value.some(this.requirement)) {\n        _addIssue(this, \"item\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/sortItems/sortItems.ts\n// @__NO_SIDE_EFFECTS__\nfunction sortItems(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"sort_items\",\n    reference: sortItems,\n    async: false,\n    operation,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.sort(this.operation);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/startsWith/startsWith.ts\n// @__NO_SIDE_EFFECTS__\nfunction startsWith(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"starts_with\",\n    reference: startsWith,\n    async: false,\n    expects: `\"${requirement}\"`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !dataset.value.startsWith(this.requirement)) {\n        _addIssue(this, \"start\", dataset, config2, {\n          received: `\"${dataset.value.slice(0, this.requirement.length)}\"`\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/stringifyJson/stringifyJson.ts\n// @__NO_SIDE_EFFECTS__\nfunction stringifyJson(config2, message2) {\n  return {\n    kind: \"transformation\",\n    type: \"stringify_json\",\n    reference: stringifyJson,\n    message: message2,\n    config: config2,\n    async: false,\n    \"~run\"(dataset, config3) {\n      try {\n        const output = JSON.stringify(\n          dataset.value,\n          // @ts-expect-error\n          this.config?.replacer,\n          this.config?.space\n        );\n        if (output === void 0) {\n          _addIssue(this, \"JSON\", dataset, config3);\n          dataset.typed = false;\n        }\n        dataset.value = output;\n      } catch (error) {\n        if (error instanceof Error) {\n          _addIssue(this, \"JSON\", dataset, config3, {\n            received: `\"${error.message}\"`\n          });\n          dataset.typed = false;\n        } else {\n          throw error;\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/title/title.ts\n// @__NO_SIDE_EFFECTS__\nfunction title(title_) {\n  return {\n    kind: \"metadata\",\n    type: \"title\",\n    reference: title,\n    title: title_\n  };\n}\n\n// src/actions/toLowerCase/toLowerCase.ts\n// @__NO_SIDE_EFFECTS__\nfunction toLowerCase() {\n  return {\n    kind: \"transformation\",\n    type: \"to_lower_case\",\n    reference: toLowerCase,\n    async: false,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.toLowerCase();\n      return dataset;\n    }\n  };\n}\n\n// src/actions/toMaxValue/toMaxValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction toMaxValue(requirement) {\n  return {\n    kind: \"transformation\",\n    type: \"to_max_value\",\n    reference: toMaxValue,\n    async: false,\n    requirement,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value > this.requirement ? this.requirement : dataset.value;\n      return dataset;\n    }\n  };\n}\n\n// src/actions/toMinValue/toMinValue.ts\n// @__NO_SIDE_EFFECTS__\nfunction toMinValue(requirement) {\n  return {\n    kind: \"transformation\",\n    type: \"to_min_value\",\n    reference: toMinValue,\n    async: false,\n    requirement,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value < this.requirement ? this.requirement : dataset.value;\n      return dataset;\n    }\n  };\n}\n\n// src/actions/toUpperCase/toUpperCase.ts\n// @__NO_SIDE_EFFECTS__\nfunction toUpperCase() {\n  return {\n    kind: \"transformation\",\n    type: \"to_upper_case\",\n    reference: toUpperCase,\n    async: false,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.toUpperCase();\n      return dataset;\n    }\n  };\n}\n\n// src/actions/transform/transform.ts\n// @__NO_SIDE_EFFECTS__\nfunction transform(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"transform\",\n    reference: transform,\n    async: false,\n    operation,\n    \"~run\"(dataset) {\n      dataset.value = this.operation(dataset.value);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/transform/transformAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction transformAsync(operation) {\n  return {\n    kind: \"transformation\",\n    type: \"transform\",\n    reference: transformAsync,\n    async: true,\n    operation,\n    async \"~run\"(dataset) {\n      dataset.value = await this.operation(dataset.value);\n      return dataset;\n    }\n  };\n}\n\n// src/actions/trim/trim.ts\n// @__NO_SIDE_EFFECTS__\nfunction trim() {\n  return {\n    kind: \"transformation\",\n    type: \"trim\",\n    reference: trim,\n    async: false,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.trim();\n      return dataset;\n    }\n  };\n}\n\n// src/actions/trimEnd/trimEnd.ts\n// @__NO_SIDE_EFFECTS__\nfunction trimEnd() {\n  return {\n    kind: \"transformation\",\n    type: \"trim_end\",\n    reference: trimEnd,\n    async: false,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.trimEnd();\n      return dataset;\n    }\n  };\n}\n\n// src/actions/trimStart/trimStart.ts\n// @__NO_SIDE_EFFECTS__\nfunction trimStart() {\n  return {\n    kind: \"transformation\",\n    type: \"trim_start\",\n    reference: trimStart,\n    async: false,\n    \"~run\"(dataset) {\n      dataset.value = dataset.value.trimStart();\n      return dataset;\n    }\n  };\n}\n\n// src/actions/ulid/ulid.ts\n// @__NO_SIDE_EFFECTS__\nfunction ulid(message2) {\n  return {\n    kind: \"validation\",\n    type: \"ulid\",\n    reference: ulid,\n    async: false,\n    expects: null,\n    requirement: ULID_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"ULID\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/url/url.ts\n// @__NO_SIDE_EFFECTS__\nfunction url(message2) {\n  return {\n    kind: \"validation\",\n    type: \"url\",\n    reference: url,\n    async: false,\n    expects: null,\n    requirement(input) {\n      try {\n        new URL(input);\n        return true;\n      } catch {\n        return false;\n      }\n    },\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement(dataset.value)) {\n        _addIssue(this, \"URL\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/uuid/uuid.ts\n// @__NO_SIDE_EFFECTS__\nfunction uuid(message2) {\n  return {\n    kind: \"validation\",\n    type: \"uuid\",\n    reference: uuid,\n    async: false,\n    expects: null,\n    requirement: UUID_REGEX,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.test(dataset.value)) {\n        _addIssue(this, \"UUID\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/value/value.ts\n// @__NO_SIDE_EFFECTS__\nfunction value(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"value\",\n    reference: value,\n    async: false,\n    expects: requirement instanceof Date ? requirement.toJSON() : _stringify(requirement),\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !(this.requirement <= dataset.value && this.requirement >= dataset.value)) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/values/values.ts\n// @__NO_SIDE_EFFECTS__\nfunction values(requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"values\",\n    reference: values,\n    async: false,\n    expects: `${_joinExpects(\n      requirement.map(\n        (value2) => value2 instanceof Date ? value2.toJSON() : _stringify(value2)\n      ),\n      \"|\"\n    )}`,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed && !this.requirement.some(\n        (value2) => value2 <= dataset.value && value2 >= dataset.value\n      )) {\n        _addIssue(this, \"value\", dataset, config2, {\n          received: dataset.value instanceof Date ? dataset.value.toJSON() : _stringify(dataset.value)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/actions/words/words.ts\n// @__NO_SIDE_EFFECTS__\nfunction words(locales, requirement, message2) {\n  return {\n    kind: \"validation\",\n    type: \"words\",\n    reference: words,\n    async: false,\n    expects: `${requirement}`,\n    locales,\n    requirement,\n    message: message2,\n    \"~run\"(dataset, config2) {\n      if (dataset.typed) {\n        const count = _getWordCount(this.locales, dataset.value);\n        if (count !== this.requirement) {\n          _addIssue(this, \"words\", dataset, config2, {\n            received: `${count}`\n          });\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/assert/assert.ts\nfunction assert(schema, input) {\n  const issues = schema[\"~run\"]({ value: input }, { abortEarly: true }).issues;\n  if (issues) {\n    throw new ValiError(issues);\n  }\n}\n\n// src/methods/config/config.ts\n// @__NO_SIDE_EFFECTS__\nfunction config(schema, config2) {\n  return {\n    ...schema,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config_) {\n      return schema[\"~run\"](dataset, { ...config_, ...config2 });\n    }\n  };\n}\n\n// src/methods/getFallback/getFallback.ts\n// @__NO_SIDE_EFFECTS__\nfunction getFallback(schema, dataset, config2) {\n  return typeof schema.fallback === \"function\" ? (\n    // @ts-expect-error\n    schema.fallback(dataset, config2)\n  ) : (\n    // @ts-expect-error\n    schema.fallback\n  );\n}\n\n// src/methods/fallback/fallback.ts\n// @__NO_SIDE_EFFECTS__\nfunction fallback(schema, fallback2) {\n  return {\n    ...schema,\n    fallback: fallback2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const outputDataset = schema[\"~run\"](dataset, config2);\n      return outputDataset.issues ? { typed: true, value: getFallback(this, outputDataset, config2) } : outputDataset;\n    }\n  };\n}\n\n// src/methods/fallback/fallbackAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction fallbackAsync(schema, fallback2) {\n  return {\n    ...schema,\n    fallback: fallback2,\n    async: true,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const outputDataset = await schema[\"~run\"](dataset, config2);\n      return outputDataset.issues ? {\n        typed: true,\n        value: await getFallback(this, outputDataset, config2)\n      } : outputDataset;\n    }\n  };\n}\n\n// src/methods/flatten/flatten.ts\n// @__NO_SIDE_EFFECTS__\nfunction flatten(issues) {\n  const flatErrors = {};\n  for (const issue of issues) {\n    if (issue.path) {\n      const dotPath = getDotPath(issue);\n      if (dotPath) {\n        if (!flatErrors.nested) {\n          flatErrors.nested = {};\n        }\n        if (flatErrors.nested[dotPath]) {\n          flatErrors.nested[dotPath].push(issue.message);\n        } else {\n          flatErrors.nested[dotPath] = [issue.message];\n        }\n      } else {\n        if (flatErrors.other) {\n          flatErrors.other.push(issue.message);\n        } else {\n          flatErrors.other = [issue.message];\n        }\n      }\n    } else {\n      if (flatErrors.root) {\n        flatErrors.root.push(issue.message);\n      } else {\n        flatErrors.root = [issue.message];\n      }\n    }\n  }\n  return flatErrors;\n}\n\n// src/methods/forward/forward.ts\n// @__NO_SIDE_EFFECTS__\nfunction forward(action, path) {\n  return {\n    ...action,\n    \"~run\"(dataset, config2) {\n      const prevIssues = dataset.issues && [...dataset.issues];\n      dataset = action[\"~run\"](dataset, config2);\n      if (dataset.issues) {\n        for (const issue of dataset.issues) {\n          if (!prevIssues?.includes(issue)) {\n            let pathInput = dataset.value;\n            for (const key of path) {\n              const pathValue = pathInput[key];\n              const pathItem = {\n                type: \"unknown\",\n                origin: \"value\",\n                input: pathInput,\n                key,\n                value: pathValue\n              };\n              if (issue.path) {\n                issue.path.push(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              if (!pathValue) {\n                break;\n              }\n              pathInput = pathValue;\n            }\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/forward/forwardAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction forwardAsync(action, path) {\n  return {\n    ...action,\n    async: true,\n    async \"~run\"(dataset, config2) {\n      const prevIssues = dataset.issues && [...dataset.issues];\n      dataset = await action[\"~run\"](dataset, config2);\n      if (dataset.issues) {\n        for (const issue of dataset.issues) {\n          if (!prevIssues?.includes(issue)) {\n            let pathInput = dataset.value;\n            for (const key of path) {\n              const pathValue = pathInput[key];\n              const pathItem = {\n                type: \"unknown\",\n                origin: \"value\",\n                input: pathInput,\n                key,\n                value: pathValue\n              };\n              if (issue.path) {\n                issue.path.push(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              if (!pathValue) {\n                break;\n              }\n              pathInput = pathValue;\n            }\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/getDefault/getDefault.ts\n// @__NO_SIDE_EFFECTS__\nfunction getDefault(schema, dataset, config2) {\n  return typeof schema.default === \"function\" ? (\n    // @ts-expect-error\n    schema.default(dataset, config2)\n  ) : (\n    // @ts-expect-error\n    schema.default\n  );\n}\n\n// src/methods/getDefaults/getDefaults.ts\n// @__NO_SIDE_EFFECTS__\nfunction getDefaults(schema) {\n  if (\"entries\" in schema) {\n    const object2 = {};\n    for (const key in schema.entries) {\n      object2[key] = /* @__PURE__ */ getDefaults(schema.entries[key]);\n    }\n    return object2;\n  }\n  if (\"items\" in schema) {\n    return schema.items.map(getDefaults);\n  }\n  return getDefault(schema);\n}\n\n// src/methods/getDefaults/getDefaultsAsync.ts\n// @__NO_SIDE_EFFECTS__\nasync function getDefaultsAsync(schema) {\n  if (\"entries\" in schema) {\n    return Object.fromEntries(\n      await Promise.all(\n        Object.entries(schema.entries).map(async ([key, value2]) => [\n          key,\n          await /* @__PURE__ */ getDefaultsAsync(value2)\n        ])\n      )\n    );\n  }\n  if (\"items\" in schema) {\n    return Promise.all(schema.items.map(getDefaultsAsync));\n  }\n  return getDefault(schema);\n}\n\n// src/methods/getDescription/getDescription.ts\n// @__NO_SIDE_EFFECTS__\nfunction getDescription(schema) {\n  return _getLastMetadata(schema, \"description\");\n}\n\n// src/methods/getFallbacks/getFallbacks.ts\n// @__NO_SIDE_EFFECTS__\nfunction getFallbacks(schema) {\n  if (\"entries\" in schema) {\n    const object2 = {};\n    for (const key in schema.entries) {\n      object2[key] = /* @__PURE__ */ getFallbacks(schema.entries[key]);\n    }\n    return object2;\n  }\n  if (\"items\" in schema) {\n    return schema.items.map(getFallbacks);\n  }\n  return getFallback(schema);\n}\n\n// src/methods/getFallbacks/getFallbacksAsync.ts\n// @__NO_SIDE_EFFECTS__\nasync function getFallbacksAsync(schema) {\n  if (\"entries\" in schema) {\n    return Object.fromEntries(\n      await Promise.all(\n        Object.entries(schema.entries).map(async ([key, value2]) => [\n          key,\n          await /* @__PURE__ */ getFallbacksAsync(value2)\n        ])\n      )\n    );\n  }\n  if (\"items\" in schema) {\n    return Promise.all(schema.items.map(getFallbacksAsync));\n  }\n  return getFallback(schema);\n}\n\n// src/methods/getMetadata/getMetadata.ts\n// @__NO_SIDE_EFFECTS__\nfunction getMetadata(schema) {\n  const result = {};\n  function depthFirstMerge(schema2) {\n    if (\"pipe\" in schema2) {\n      for (const item of schema2.pipe) {\n        if (item.kind === \"schema\" && \"pipe\" in item) {\n          depthFirstMerge(item);\n        } else if (item.kind === \"metadata\" && item.type === \"metadata\") {\n          Object.assign(result, item.metadata);\n        }\n      }\n    }\n  }\n  depthFirstMerge(schema);\n  return result;\n}\n\n// src/methods/getTitle/getTitle.ts\n// @__NO_SIDE_EFFECTS__\nfunction getTitle(schema) {\n  return _getLastMetadata(schema, \"title\");\n}\n\n// src/methods/is/is.ts\n// @__NO_SIDE_EFFECTS__\nfunction is(schema, input) {\n  return !schema[\"~run\"]({ value: input }, { abortEarly: true }).issues;\n}\n\n// src/schemas/any/any.ts\n// @__NO_SIDE_EFFECTS__\nfunction any() {\n  return {\n    kind: \"schema\",\n    type: \"any\",\n    reference: any,\n    expects: \"any\",\n    async: false,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset) {\n      dataset.typed = true;\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/array/array.ts\n// @__NO_SIDE_EFFECTS__\nfunction array(item, message2) {\n  return {\n    kind: \"schema\",\n    type: \"array\",\n    reference: array,\n    expects: \"Array\",\n    async: false,\n    item,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        for (let key = 0; key < input.length; key++) {\n          const value2 = input[key];\n          const itemDataset = this.item[\"~run\"]({ value: value2 }, config2);\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/array/arrayAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction arrayAsync(item, message2) {\n  return {\n    kind: \"schema\",\n    type: \"array\",\n    reference: arrayAsync,\n    expects: \"Array\",\n    async: true,\n    item,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        const itemDatasets = await Promise.all(\n          input.map((value2) => this.item[\"~run\"]({ value: value2 }, config2))\n        );\n        for (let key = 0; key < itemDatasets.length; key++) {\n          const itemDataset = itemDatasets[key];\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: input[key]\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/bigint/bigint.ts\n// @__NO_SIDE_EFFECTS__\nfunction bigint(message2) {\n  return {\n    kind: \"schema\",\n    type: \"bigint\",\n    reference: bigint,\n    expects: \"bigint\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"bigint\") {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/blob/blob.ts\n// @__NO_SIDE_EFFECTS__\nfunction blob(message2) {\n  return {\n    kind: \"schema\",\n    type: \"blob\",\n    reference: blob,\n    expects: \"Blob\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value instanceof Blob) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/boolean/boolean.ts\n// @__NO_SIDE_EFFECTS__\nfunction boolean(message2) {\n  return {\n    kind: \"schema\",\n    type: \"boolean\",\n    reference: boolean,\n    expects: \"boolean\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"boolean\") {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/custom/custom.ts\n// @__NO_SIDE_EFFECTS__\nfunction custom(check2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"custom\",\n    reference: custom,\n    expects: \"unknown\",\n    async: false,\n    check: check2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (this.check(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/custom/customAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction customAsync(check2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"custom\",\n    reference: customAsync,\n    expects: \"unknown\",\n    async: true,\n    check: check2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (await this.check(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/date/date.ts\n// @__NO_SIDE_EFFECTS__\nfunction date(message2) {\n  return {\n    kind: \"schema\",\n    type: \"date\",\n    reference: date,\n    expects: \"Date\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value instanceof Date) {\n        if (!isNaN(dataset.value)) {\n          dataset.typed = true;\n        } else {\n          _addIssue(this, \"type\", dataset, config2, {\n            received: '\"Invalid Date\"'\n          });\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/enum/enum.ts\n// @__NO_SIDE_EFFECTS__\nfunction enum_(enum__, message2) {\n  const options = [];\n  for (const key in enum__) {\n    if (`${+key}` !== key || typeof enum__[key] !== \"string\" || !Object.is(enum__[enum__[key]], +key)) {\n      options.push(enum__[key]);\n    }\n  }\n  return {\n    kind: \"schema\",\n    type: \"enum\",\n    reference: enum_,\n    expects: _joinExpects(options.map(_stringify), \"|\"),\n    async: false,\n    enum: enum__,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (this.options.includes(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/exactOptional/exactOptional.ts\n// @__NO_SIDE_EFFECTS__\nfunction exactOptional(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"exact_optional\",\n    reference: exactOptional,\n    expects: wrapped.expects,\n    async: false,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/exactOptional/exactOptionalAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction exactOptionalAsync(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"exact_optional\",\n    reference: exactOptionalAsync,\n    expects: wrapped.expects,\n    async: true,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/file/file.ts\n// @__NO_SIDE_EFFECTS__\nfunction file(message2) {\n  return {\n    kind: \"schema\",\n    type: \"file\",\n    reference: file,\n    expects: \"File\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value instanceof File) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/function/function.ts\n// @__NO_SIDE_EFFECTS__\nfunction function_(message2) {\n  return {\n    kind: \"schema\",\n    type: \"function\",\n    reference: function_,\n    expects: \"Function\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"function\") {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/instance/instance.ts\n// @__NO_SIDE_EFFECTS__\nfunction instance(class_, message2) {\n  return {\n    kind: \"schema\",\n    type: \"instance\",\n    reference: instance,\n    expects: class_.name,\n    async: false,\n    class: class_,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value instanceof this.class) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/intersect/utils/_merge/_merge.ts\n// @__NO_SIDE_EFFECTS__\nfunction _merge(value1, value2) {\n  if (typeof value1 === typeof value2) {\n    if (value1 === value2 || value1 instanceof Date && value2 instanceof Date && +value1 === +value2) {\n      return { value: value1 };\n    }\n    if (value1 && value2 && value1.constructor === Object && value2.constructor === Object) {\n      for (const key in value2) {\n        if (key in value1) {\n          const dataset = /* @__PURE__ */ _merge(value1[key], value2[key]);\n          if (dataset.issue) {\n            return dataset;\n          }\n          value1[key] = dataset.value;\n        } else {\n          value1[key] = value2[key];\n        }\n      }\n      return { value: value1 };\n    }\n    if (Array.isArray(value1) && Array.isArray(value2)) {\n      if (value1.length === value2.length) {\n        for (let index = 0; index < value1.length; index++) {\n          const dataset = /* @__PURE__ */ _merge(value1[index], value2[index]);\n          if (dataset.issue) {\n            return dataset;\n          }\n          value1[index] = dataset.value;\n        }\n        return { value: value1 };\n      }\n    }\n  }\n  return { issue: true };\n}\n\n// src/schemas/intersect/intersect.ts\n// @__NO_SIDE_EFFECTS__\nfunction intersect(options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"intersect\",\n    reference: intersect,\n    expects: _joinExpects(\n      options.map((option) => option.expects),\n      \"&\"\n    ),\n    async: false,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (this.options.length) {\n        const input = dataset.value;\n        let outputs;\n        dataset.typed = true;\n        for (const schema of this.options) {\n          const optionDataset = schema[\"~run\"]({ value: input }, config2);\n          if (optionDataset.issues) {\n            if (dataset.issues) {\n              dataset.issues.push(...optionDataset.issues);\n            } else {\n              dataset.issues = optionDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!optionDataset.typed) {\n            dataset.typed = false;\n          }\n          if (dataset.typed) {\n            if (outputs) {\n              outputs.push(optionDataset.value);\n            } else {\n              outputs = [optionDataset.value];\n            }\n          }\n        }\n        if (dataset.typed) {\n          dataset.value = outputs[0];\n          for (let index = 1; index < outputs.length; index++) {\n            const mergeDataset = _merge(dataset.value, outputs[index]);\n            if (mergeDataset.issue) {\n              _addIssue(this, \"type\", dataset, config2, {\n                received: \"unknown\"\n              });\n              break;\n            }\n            dataset.value = mergeDataset.value;\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/intersect/intersectAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction intersectAsync(options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"intersect\",\n    reference: intersectAsync,\n    expects: _joinExpects(\n      options.map((option) => option.expects),\n      \"&\"\n    ),\n    async: true,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (this.options.length) {\n        const input = dataset.value;\n        let outputs;\n        dataset.typed = true;\n        const optionDatasets = await Promise.all(\n          this.options.map((schema) => schema[\"~run\"]({ value: input }, config2))\n        );\n        for (const optionDataset of optionDatasets) {\n          if (optionDataset.issues) {\n            if (dataset.issues) {\n              dataset.issues.push(...optionDataset.issues);\n            } else {\n              dataset.issues = optionDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!optionDataset.typed) {\n            dataset.typed = false;\n          }\n          if (dataset.typed) {\n            if (outputs) {\n              outputs.push(optionDataset.value);\n            } else {\n              outputs = [optionDataset.value];\n            }\n          }\n        }\n        if (dataset.typed) {\n          dataset.value = outputs[0];\n          for (let index = 1; index < outputs.length; index++) {\n            const mergeDataset = _merge(dataset.value, outputs[index]);\n            if (mergeDataset.issue) {\n              _addIssue(this, \"type\", dataset, config2, {\n                received: \"unknown\"\n              });\n              break;\n            }\n            dataset.value = mergeDataset.value;\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/lazy/lazy.ts\n// @__NO_SIDE_EFFECTS__\nfunction lazy(getter) {\n  return {\n    kind: \"schema\",\n    type: \"lazy\",\n    reference: lazy,\n    expects: \"unknown\",\n    async: false,\n    getter,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      return this.getter(dataset.value)[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/lazy/lazyAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction lazyAsync(getter) {\n  return {\n    kind: \"schema\",\n    type: \"lazy\",\n    reference: lazyAsync,\n    expects: \"unknown\",\n    async: true,\n    getter,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      return (await this.getter(dataset.value))[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/literal/literal.ts\n// @__NO_SIDE_EFFECTS__\nfunction literal(literal_, message2) {\n  return {\n    kind: \"schema\",\n    type: \"literal\",\n    reference: literal,\n    expects: _stringify(literal_),\n    async: false,\n    literal: literal_,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === this.literal) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/looseObject/looseObject.ts\n// @__NO_SIDE_EFFECTS__\nfunction looseObject(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"loose_object\",\n    reference: looseObject,\n    expects: \"Object\",\n    async: false,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        for (const key in this.entries) {\n          const valueSchema = this.entries[key];\n          if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n          valueSchema.default !== void 0) {\n            const value2 = key in input ? (\n              // @ts-expect-error\n              input[key]\n            ) : getDefault(valueSchema);\n            const valueDataset = valueSchema[\"~run\"]({ value: value2 }, config2);\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  // @ts-expect-error\n                  value: input[key]\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const key in input) {\n            if (_isValidObjectKey(input, key) && !(key in this.entries)) {\n              dataset.value[key] = input[key];\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/looseObject/looseObjectAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction looseObjectAsync(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"loose_object\",\n    reference: looseObjectAsync,\n    expects: \"Object\",\n    async: true,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        const valueDatasets = await Promise.all(\n          Object.entries(this.entries).map(async ([key, valueSchema]) => {\n            if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n            valueSchema.default !== void 0) {\n              const value2 = key in input ? (\n                // @ts-expect-error\n                input[key]\n              ) : await getDefault(valueSchema);\n              return [\n                key,\n                value2,\n                valueSchema,\n                await valueSchema[\"~run\"]({ value: value2 }, config2)\n              ];\n            }\n            return [\n              key,\n              // @ts-expect-error\n              input[key],\n              valueSchema,\n              null\n            ];\n          })\n        );\n        for (const [key, value2, valueSchema, valueDataset] of valueDatasets) {\n          if (valueDataset) {\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = await getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  value: value2\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const key in input) {\n            if (_isValidObjectKey(input, key) && !(key in this.entries)) {\n              dataset.value[key] = input[key];\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/looseTuple/looseTuple.ts\n// @__NO_SIDE_EFFECTS__\nfunction looseTuple(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"loose_tuple\",\n    reference: looseTuple,\n    expects: \"Array\",\n    async: false,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        for (let key = 0; key < this.items.length; key++) {\n          const value2 = input[key];\n          const itemDataset = this.items[key][\"~run\"]({ value: value2 }, config2);\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (let key = this.items.length; key < input.length; key++) {\n            dataset.value.push(input[key]);\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/looseTuple/looseTupleAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction looseTupleAsync(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"loose_tuple\",\n    reference: looseTupleAsync,\n    expects: \"Array\",\n    async: true,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        const itemDatasets = await Promise.all(\n          this.items.map(async (item, key) => {\n            const value2 = input[key];\n            return [key, value2, await item[\"~run\"]({ value: value2 }, config2)];\n          })\n        );\n        for (const [key, value2, itemDataset] of itemDatasets) {\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (let key = this.items.length; key < input.length; key++) {\n            dataset.value.push(input[key]);\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/map/map.ts\n// @__NO_SIDE_EFFECTS__\nfunction map(key, value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"map\",\n    reference: map,\n    expects: \"Map\",\n    async: false,\n    key,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input instanceof Map) {\n        dataset.typed = true;\n        dataset.value = /* @__PURE__ */ new Map();\n        for (const [inputKey, inputValue] of input) {\n          const keyDataset = this.key[\"~run\"]({ value: inputKey }, config2);\n          if (keyDataset.issues) {\n            const pathItem = {\n              type: \"map\",\n              origin: \"key\",\n              input,\n              key: inputKey,\n              value: inputValue\n            };\n            for (const issue of keyDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = keyDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          const valueDataset = this.value[\"~run\"](\n            { value: inputValue },\n            config2\n          );\n          if (valueDataset.issues) {\n            const pathItem = {\n              type: \"map\",\n              origin: \"value\",\n              input,\n              key: inputKey,\n              value: inputValue\n            };\n            for (const issue of valueDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = valueDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!keyDataset.typed || !valueDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.set(keyDataset.value, valueDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/map/mapAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction mapAsync(key, value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"map\",\n    reference: mapAsync,\n    expects: \"Map\",\n    async: true,\n    key,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input instanceof Map) {\n        dataset.typed = true;\n        dataset.value = /* @__PURE__ */ new Map();\n        const datasets = await Promise.all(\n          [...input].map(\n            ([inputKey, inputValue]) => Promise.all([\n              inputKey,\n              inputValue,\n              this.key[\"~run\"]({ value: inputKey }, config2),\n              this.value[\"~run\"]({ value: inputValue }, config2)\n            ])\n          )\n        );\n        for (const [\n          inputKey,\n          inputValue,\n          keyDataset,\n          valueDataset\n        ] of datasets) {\n          if (keyDataset.issues) {\n            const pathItem = {\n              type: \"map\",\n              origin: \"key\",\n              input,\n              key: inputKey,\n              value: inputValue\n            };\n            for (const issue of keyDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = keyDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (valueDataset.issues) {\n            const pathItem = {\n              type: \"map\",\n              origin: \"value\",\n              input,\n              key: inputKey,\n              value: inputValue\n            };\n            for (const issue of valueDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = valueDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!keyDataset.typed || !valueDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.set(keyDataset.value, valueDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nan/nan.ts\n// @__NO_SIDE_EFFECTS__\nfunction nan(message2) {\n  return {\n    kind: \"schema\",\n    type: \"nan\",\n    reference: nan,\n    expects: \"NaN\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (Number.isNaN(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/never/never.ts\n// @__NO_SIDE_EFFECTS__\nfunction never(message2) {\n  return {\n    kind: \"schema\",\n    type: \"never\",\n    reference: never,\n    expects: \"never\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      _addIssue(this, \"type\", dataset, config2);\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonNullable/nonNullable.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonNullable(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_nullable\",\n    reference: nonNullable,\n    expects: \"!null\",\n    async: false,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value !== null) {\n        dataset = this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === null) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonNullable/nonNullableAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonNullableAsync(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_nullable\",\n    reference: nonNullableAsync,\n    expects: \"!null\",\n    async: true,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value !== null) {\n        dataset = await this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === null) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonNullish/nonNullish.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonNullish(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_nullish\",\n    reference: nonNullish,\n    expects: \"(!null & !undefined)\",\n    async: false,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (!(dataset.value === null || dataset.value === void 0)) {\n        dataset = this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === null || dataset.value === void 0) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonNullish/nonNullishAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonNullishAsync(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_nullish\",\n    reference: nonNullishAsync,\n    expects: \"(!null & !undefined)\",\n    async: true,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (!(dataset.value === null || dataset.value === void 0)) {\n        dataset = await this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === null || dataset.value === void 0) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonOptional/nonOptional.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonOptional(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_optional\",\n    reference: nonOptional,\n    expects: \"!undefined\",\n    async: false,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value !== void 0) {\n        dataset = this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === void 0) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nonOptional/nonOptionalAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction nonOptionalAsync(wrapped, message2) {\n  return {\n    kind: \"schema\",\n    type: \"non_optional\",\n    reference: nonOptionalAsync,\n    expects: \"!undefined\",\n    async: true,\n    wrapped,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value !== void 0) {\n        dataset = await this.wrapped[\"~run\"](dataset, config2);\n      }\n      if (dataset.value === void 0) {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/null/null.ts\n// @__NO_SIDE_EFFECTS__\nfunction null_(message2) {\n  return {\n    kind: \"schema\",\n    type: \"null\",\n    reference: null_,\n    expects: \"null\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === null) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/nullable/nullable.ts\n// @__NO_SIDE_EFFECTS__\nfunction nullable(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"nullable\",\n    reference: nullable,\n    expects: `(${wrapped.expects} | null)`,\n    async: false,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === null) {\n        if (this.default !== void 0) {\n          dataset.value = getDefault(this, dataset, config2);\n        }\n        if (dataset.value === null) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/nullable/nullableAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction nullableAsync(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"nullable\",\n    reference: nullableAsync,\n    expects: `(${wrapped.expects} | null)`,\n    async: true,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value === null) {\n        if (this.default !== void 0) {\n          dataset.value = await getDefault(this, dataset, config2);\n        }\n        if (dataset.value === null) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/nullish/nullish.ts\n// @__NO_SIDE_EFFECTS__\nfunction nullish(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"nullish\",\n    reference: nullish,\n    expects: `(${wrapped.expects} | null | undefined)`,\n    async: false,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === null || dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = getDefault(this, dataset, config2);\n        }\n        if (dataset.value === null || dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/nullish/nullishAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction nullishAsync(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"nullish\",\n    reference: nullishAsync,\n    expects: `(${wrapped.expects} | null | undefined)`,\n    async: true,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value === null || dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = await getDefault(this, dataset, config2);\n        }\n        if (dataset.value === null || dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/number/number.ts\n// @__NO_SIDE_EFFECTS__\nfunction number(message2) {\n  return {\n    kind: \"schema\",\n    type: \"number\",\n    reference: number,\n    expects: \"number\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"number\" && !isNaN(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/object/object.ts\n// @__NO_SIDE_EFFECTS__\nfunction object(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"object\",\n    reference: object,\n    expects: \"Object\",\n    async: false,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        for (const key in this.entries) {\n          const valueSchema = this.entries[key];\n          if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n          valueSchema.default !== void 0) {\n            const value2 = key in input ? (\n              // @ts-expect-error\n              input[key]\n            ) : getDefault(valueSchema);\n            const valueDataset = valueSchema[\"~run\"]({ value: value2 }, config2);\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  // @ts-expect-error\n                  value: input[key]\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/object/objectAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction objectAsync(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"object\",\n    reference: objectAsync,\n    expects: \"Object\",\n    async: true,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        const valueDatasets = await Promise.all(\n          Object.entries(this.entries).map(async ([key, valueSchema]) => {\n            if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n            valueSchema.default !== void 0) {\n              const value2 = key in input ? (\n                // @ts-expect-error\n                input[key]\n              ) : await getDefault(valueSchema);\n              return [\n                key,\n                value2,\n                valueSchema,\n                await valueSchema[\"~run\"]({ value: value2 }, config2)\n              ];\n            }\n            return [\n              key,\n              // @ts-expect-error\n              input[key],\n              valueSchema,\n              null\n            ];\n          })\n        );\n        for (const [key, value2, valueSchema, valueDataset] of valueDatasets) {\n          if (valueDataset) {\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = await getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  value: value2\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/objectWithRest/objectWithRest.ts\n// @__NO_SIDE_EFFECTS__\nfunction objectWithRest(entries2, rest, message2) {\n  return {\n    kind: \"schema\",\n    type: \"object_with_rest\",\n    reference: objectWithRest,\n    expects: \"Object\",\n    async: false,\n    entries: entries2,\n    rest,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        for (const key in this.entries) {\n          const valueSchema = this.entries[key];\n          if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n          valueSchema.default !== void 0) {\n            const value2 = key in input ? (\n              // @ts-expect-error\n              input[key]\n            ) : getDefault(valueSchema);\n            const valueDataset = valueSchema[\"~run\"]({ value: value2 }, config2);\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  // @ts-expect-error\n                  value: input[key]\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const key in input) {\n            if (_isValidObjectKey(input, key) && !(key in this.entries)) {\n              const valueDataset = this.rest[\"~run\"](\n                // @ts-expect-error\n                { value: input[key] },\n                config2\n              );\n              if (valueDataset.issues) {\n                const pathItem = {\n                  type: \"object\",\n                  origin: \"value\",\n                  input,\n                  key,\n                  // @ts-expect-error\n                  value: input[key]\n                };\n                for (const issue of valueDataset.issues) {\n                  if (issue.path) {\n                    issue.path.unshift(pathItem);\n                  } else {\n                    issue.path = [pathItem];\n                  }\n                  dataset.issues?.push(issue);\n                }\n                if (!dataset.issues) {\n                  dataset.issues = valueDataset.issues;\n                }\n                if (config2.abortEarly) {\n                  dataset.typed = false;\n                  break;\n                }\n              }\n              if (!valueDataset.typed) {\n                dataset.typed = false;\n              }\n              dataset.value[key] = valueDataset.value;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/objectWithRest/objectWithRestAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction objectWithRestAsync(entries2, rest, message2) {\n  return {\n    kind: \"schema\",\n    type: \"object_with_rest\",\n    reference: objectWithRestAsync,\n    expects: \"Object\",\n    async: true,\n    entries: entries2,\n    rest,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        const [normalDatasets, restDatasets] = await Promise.all([\n          // If key is present or its an optional schema with a default value,\n          // parse input of key or default value asynchronously\n          Promise.all(\n            Object.entries(this.entries).map(async ([key, valueSchema]) => {\n              if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n              valueSchema.default !== void 0) {\n                const value2 = key in input ? (\n                  // @ts-expect-error\n                  input[key]\n                ) : await getDefault(valueSchema);\n                return [\n                  key,\n                  value2,\n                  valueSchema,\n                  await valueSchema[\"~run\"]({ value: value2 }, config2)\n                ];\n              }\n              return [\n                key,\n                // @ts-expect-error\n                input[key],\n                valueSchema,\n                null\n              ];\n            })\n          ),\n          // Parse other entries with rest schema asynchronously\n          // Hint: We exclude specific keys for security reasons\n          Promise.all(\n            Object.entries(input).filter(\n              ([key]) => _isValidObjectKey(input, key) && !(key in this.entries)\n            ).map(\n              async ([key, value2]) => [\n                key,\n                value2,\n                await this.rest[\"~run\"]({ value: value2 }, config2)\n              ]\n            )\n          )\n        ]);\n        for (const [key, value2, valueSchema, valueDataset] of normalDatasets) {\n          if (valueDataset) {\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = await getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  value: value2\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const [key, value2, valueDataset] of restDatasets) {\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/optional/optional.ts\n// @__NO_SIDE_EFFECTS__\nfunction optional(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"optional\",\n    reference: optional,\n    expects: `(${wrapped.expects} | undefined)`,\n    async: false,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = getDefault(this, dataset, config2);\n        }\n        if (dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/optional/optionalAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction optionalAsync(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"optional\",\n    reference: optionalAsync,\n    expects: `(${wrapped.expects} | undefined)`,\n    async: true,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = await getDefault(this, dataset, config2);\n        }\n        if (dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/picklist/picklist.ts\n// @__NO_SIDE_EFFECTS__\nfunction picklist(options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"picklist\",\n    reference: picklist,\n    expects: _joinExpects(options.map(_stringify), \"|\"),\n    async: false,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (this.options.includes(dataset.value)) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/promise/promise.ts\n// @__NO_SIDE_EFFECTS__\nfunction promise(message2) {\n  return {\n    kind: \"schema\",\n    type: \"promise\",\n    reference: promise,\n    expects: \"Promise\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value instanceof Promise) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/record/record.ts\n// @__NO_SIDE_EFFECTS__\nfunction record(key, value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"record\",\n    reference: record,\n    expects: \"Object\",\n    async: false,\n    key,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        for (const entryKey in input) {\n          if (_isValidObjectKey(input, entryKey)) {\n            const entryValue = input[entryKey];\n            const keyDataset = this.key[\"~run\"]({ value: entryKey }, config2);\n            if (keyDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"key\",\n                input,\n                key: entryKey,\n                value: entryValue\n              };\n              for (const issue of keyDataset.issues) {\n                issue.path = [pathItem];\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = keyDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            const valueDataset = this.value[\"~run\"](\n              { value: entryValue },\n              config2\n            );\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key: entryKey,\n                value: entryValue\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!keyDataset.typed || !valueDataset.typed) {\n              dataset.typed = false;\n            }\n            if (keyDataset.typed) {\n              dataset.value[keyDataset.value] = valueDataset.value;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/record/recordAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction recordAsync(key, value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"record\",\n    reference: recordAsync,\n    expects: \"Object\",\n    async: true,\n    key,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        const datasets = await Promise.all(\n          Object.entries(input).filter(([key2]) => _isValidObjectKey(input, key2)).map(\n            ([entryKey, entryValue]) => Promise.all([\n              entryKey,\n              entryValue,\n              this.key[\"~run\"]({ value: entryKey }, config2),\n              this.value[\"~run\"]({ value: entryValue }, config2)\n            ])\n          )\n        );\n        for (const [\n          entryKey,\n          entryValue,\n          keyDataset,\n          valueDataset\n        ] of datasets) {\n          if (keyDataset.issues) {\n            const pathItem = {\n              type: \"object\",\n              origin: \"key\",\n              input,\n              key: entryKey,\n              value: entryValue\n            };\n            for (const issue of keyDataset.issues) {\n              issue.path = [pathItem];\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = keyDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (valueDataset.issues) {\n            const pathItem = {\n              type: \"object\",\n              origin: \"value\",\n              input,\n              key: entryKey,\n              value: entryValue\n            };\n            for (const issue of valueDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = valueDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!keyDataset.typed || !valueDataset.typed) {\n            dataset.typed = false;\n          }\n          if (keyDataset.typed) {\n            dataset.value[keyDataset.value] = valueDataset.value;\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/set/set.ts\n// @__NO_SIDE_EFFECTS__\nfunction set(value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"set\",\n    reference: set,\n    expects: \"Set\",\n    async: false,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input instanceof Set) {\n        dataset.typed = true;\n        dataset.value = /* @__PURE__ */ new Set();\n        for (const inputValue of input) {\n          const valueDataset = this.value[\"~run\"](\n            { value: inputValue },\n            config2\n          );\n          if (valueDataset.issues) {\n            const pathItem = {\n              type: \"set\",\n              origin: \"value\",\n              input,\n              key: null,\n              value: inputValue\n            };\n            for (const issue of valueDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = valueDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!valueDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.add(valueDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/set/setAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction setAsync(value2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"set\",\n    reference: setAsync,\n    expects: \"Set\",\n    async: true,\n    value: value2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input instanceof Set) {\n        dataset.typed = true;\n        dataset.value = /* @__PURE__ */ new Set();\n        const valueDatasets = await Promise.all(\n          [...input].map(\n            async (inputValue) => [\n              inputValue,\n              await this.value[\"~run\"]({ value: inputValue }, config2)\n            ]\n          )\n        );\n        for (const [inputValue, valueDataset] of valueDatasets) {\n          if (valueDataset.issues) {\n            const pathItem = {\n              type: \"set\",\n              origin: \"value\",\n              input,\n              key: null,\n              value: inputValue\n            };\n            for (const issue of valueDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = valueDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!valueDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.add(valueDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/strictObject/strictObject.ts\n// @__NO_SIDE_EFFECTS__\nfunction strictObject(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"strict_object\",\n    reference: strictObject,\n    expects: \"Object\",\n    async: false,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        for (const key in this.entries) {\n          const valueSchema = this.entries[key];\n          if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n          valueSchema.default !== void 0) {\n            const value2 = key in input ? (\n              // @ts-expect-error\n              input[key]\n            ) : getDefault(valueSchema);\n            const valueDataset = valueSchema[\"~run\"]({ value: value2 }, config2);\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  // @ts-expect-error\n                  value: input[key]\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const key in input) {\n            if (!(key in this.entries)) {\n              _addIssue(this, \"key\", dataset, config2, {\n                input: key,\n                expected: \"never\",\n                path: [\n                  {\n                    type: \"object\",\n                    origin: \"key\",\n                    input,\n                    key,\n                    // @ts-expect-error\n                    value: input[key]\n                  }\n                ]\n              });\n              break;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/strictObject/strictObjectAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction strictObjectAsync(entries2, message2) {\n  return {\n    kind: \"schema\",\n    type: \"strict_object\",\n    reference: strictObjectAsync,\n    expects: \"Object\",\n    async: true,\n    entries: entries2,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        dataset.typed = true;\n        dataset.value = {};\n        const valueDatasets = await Promise.all(\n          Object.entries(this.entries).map(async ([key, valueSchema]) => {\n            if (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && // @ts-expect-error\n            valueSchema.default !== void 0) {\n              const value2 = key in input ? (\n                // @ts-expect-error\n                input[key]\n              ) : await getDefault(valueSchema);\n              return [\n                key,\n                value2,\n                valueSchema,\n                await valueSchema[\"~run\"]({ value: value2 }, config2)\n              ];\n            }\n            return [\n              key,\n              // @ts-expect-error\n              input[key],\n              valueSchema,\n              null\n            ];\n          })\n        );\n        for (const [key, value2, valueSchema, valueDataset] of valueDatasets) {\n          if (valueDataset) {\n            if (valueDataset.issues) {\n              const pathItem = {\n                type: \"object\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of valueDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = valueDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!valueDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value[key] = valueDataset.value;\n          } else if (valueSchema.fallback !== void 0) {\n            dataset.value[key] = await getFallback(valueSchema);\n          } else if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n            _addIssue(this, \"key\", dataset, config2, {\n              input: void 0,\n              expected: `\"${key}\"`,\n              path: [\n                {\n                  type: \"object\",\n                  origin: \"key\",\n                  input,\n                  key,\n                  value: value2\n                }\n              ]\n            });\n            if (config2.abortEarly) {\n              break;\n            }\n          }\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const key in input) {\n            if (!(key in this.entries)) {\n              _addIssue(this, \"key\", dataset, config2, {\n                input: key,\n                expected: \"never\",\n                path: [\n                  {\n                    type: \"object\",\n                    origin: \"key\",\n                    input,\n                    key,\n                    // @ts-expect-error\n                    value: input[key]\n                  }\n                ]\n              });\n              break;\n            }\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/strictTuple/strictTuple.ts\n// @__NO_SIDE_EFFECTS__\nfunction strictTuple(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"strict_tuple\",\n    reference: strictTuple,\n    expects: \"Array\",\n    async: false,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        for (let key = 0; key < this.items.length; key++) {\n          const value2 = input[key];\n          const itemDataset = this.items[key][\"~run\"]({ value: value2 }, config2);\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!(dataset.issues && config2.abortEarly) && this.items.length < input.length) {\n          _addIssue(this, \"type\", dataset, config2, {\n            input: input[this.items.length],\n            expected: \"never\",\n            path: [\n              {\n                type: \"array\",\n                origin: \"value\",\n                input,\n                key: this.items.length,\n                value: input[this.items.length]\n              }\n            ]\n          });\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/strictTuple/strictTupleAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction strictTupleAsync(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"strict_tuple\",\n    reference: strictTupleAsync,\n    expects: \"Array\",\n    async: true,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        const itemDatasets = await Promise.all(\n          this.items.map(async (item, key) => {\n            const value2 = input[key];\n            return [key, value2, await item[\"~run\"]({ value: value2 }, config2)];\n          })\n        );\n        for (const [key, value2, itemDataset] of itemDatasets) {\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!(dataset.issues && config2.abortEarly) && this.items.length < input.length) {\n          _addIssue(this, \"type\", dataset, config2, {\n            input: input[this.items.length],\n            expected: \"never\",\n            path: [\n              {\n                type: \"array\",\n                origin: \"value\",\n                input,\n                key: this.items.length,\n                value: input[this.items.length]\n              }\n            ]\n          });\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/string/string.ts\n// @__NO_SIDE_EFFECTS__\nfunction string(message2) {\n  return {\n    kind: \"schema\",\n    type: \"string\",\n    reference: string,\n    expects: \"string\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"string\") {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/symbol/symbol.ts\n// @__NO_SIDE_EFFECTS__\nfunction symbol(message2) {\n  return {\n    kind: \"schema\",\n    type: \"symbol\",\n    reference: symbol,\n    expects: \"symbol\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (typeof dataset.value === \"symbol\") {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/tuple/tuple.ts\n// @__NO_SIDE_EFFECTS__\nfunction tuple(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"tuple\",\n    reference: tuple,\n    expects: \"Array\",\n    async: false,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        for (let key = 0; key < this.items.length; key++) {\n          const value2 = input[key];\n          const itemDataset = this.items[key][\"~run\"]({ value: value2 }, config2);\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/tuple/tupleAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction tupleAsync(items, message2) {\n  return {\n    kind: \"schema\",\n    type: \"tuple\",\n    reference: tupleAsync,\n    expects: \"Array\",\n    async: true,\n    items,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        const itemDatasets = await Promise.all(\n          this.items.map(async (item, key) => {\n            const value2 = input[key];\n            return [key, value2, await item[\"~run\"]({ value: value2 }, config2)];\n          })\n        );\n        for (const [key, value2, itemDataset] of itemDatasets) {\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/tupleWithRest/tupleWithRest.ts\n// @__NO_SIDE_EFFECTS__\nfunction tupleWithRest(items, rest, message2) {\n  return {\n    kind: \"schema\",\n    type: \"tuple_with_rest\",\n    reference: tupleWithRest,\n    expects: \"Array\",\n    async: false,\n    items,\n    rest,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        for (let key = 0; key < this.items.length; key++) {\n          const value2 = input[key];\n          const itemDataset = this.items[key][\"~run\"]({ value: value2 }, config2);\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (let key = this.items.length; key < input.length; key++) {\n            const value2 = input[key];\n            const itemDataset = this.rest[\"~run\"]({ value: value2 }, config2);\n            if (itemDataset.issues) {\n              const pathItem = {\n                type: \"array\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of itemDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = itemDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!itemDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value.push(itemDataset.value);\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/tupleWithRest/tupleWithRestAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction tupleWithRestAsync(items, rest, message2) {\n  return {\n    kind: \"schema\",\n    type: \"tuple_with_rest\",\n    reference: tupleWithRestAsync,\n    expects: \"Array\",\n    async: true,\n    items,\n    rest,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (Array.isArray(input)) {\n        dataset.typed = true;\n        dataset.value = [];\n        const [normalDatasets, restDatasets] = await Promise.all([\n          // Parse schema of each normal item\n          Promise.all(\n            this.items.map(async (item, key) => {\n              const value2 = input[key];\n              return [\n                key,\n                value2,\n                await item[\"~run\"]({ value: value2 }, config2)\n              ];\n            })\n          ),\n          // Parse other items with rest schema\n          Promise.all(\n            input.slice(this.items.length).map(async (value2, key) => {\n              return [\n                key + this.items.length,\n                value2,\n                await this.rest[\"~run\"]({ value: value2 }, config2)\n              ];\n            })\n          )\n        ]);\n        for (const [key, value2, itemDataset] of normalDatasets) {\n          if (itemDataset.issues) {\n            const pathItem = {\n              type: \"array\",\n              origin: \"value\",\n              input,\n              key,\n              value: value2\n            };\n            for (const issue of itemDataset.issues) {\n              if (issue.path) {\n                issue.path.unshift(pathItem);\n              } else {\n                issue.path = [pathItem];\n              }\n              dataset.issues?.push(issue);\n            }\n            if (!dataset.issues) {\n              dataset.issues = itemDataset.issues;\n            }\n            if (config2.abortEarly) {\n              dataset.typed = false;\n              break;\n            }\n          }\n          if (!itemDataset.typed) {\n            dataset.typed = false;\n          }\n          dataset.value.push(itemDataset.value);\n        }\n        if (!dataset.issues || !config2.abortEarly) {\n          for (const [key, value2, itemDataset] of restDatasets) {\n            if (itemDataset.issues) {\n              const pathItem = {\n                type: \"array\",\n                origin: \"value\",\n                input,\n                key,\n                value: value2\n              };\n              for (const issue of itemDataset.issues) {\n                if (issue.path) {\n                  issue.path.unshift(pathItem);\n                } else {\n                  issue.path = [pathItem];\n                }\n                dataset.issues?.push(issue);\n              }\n              if (!dataset.issues) {\n                dataset.issues = itemDataset.issues;\n              }\n              if (config2.abortEarly) {\n                dataset.typed = false;\n                break;\n              }\n            }\n            if (!itemDataset.typed) {\n              dataset.typed = false;\n            }\n            dataset.value.push(itemDataset.value);\n          }\n        }\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/undefined/undefined.ts\n// @__NO_SIDE_EFFECTS__\nfunction undefined_(message2) {\n  return {\n    kind: \"schema\",\n    type: \"undefined\",\n    reference: undefined_,\n    expects: \"undefined\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/undefinedable/undefinedable.ts\n// @__NO_SIDE_EFFECTS__\nfunction undefinedable(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"undefinedable\",\n    reference: undefinedable,\n    expects: `(${wrapped.expects} | undefined)`,\n    async: false,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = getDefault(this, dataset, config2);\n        }\n        if (dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/undefinedable/undefinedableAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction undefinedableAsync(wrapped, default_) {\n  return {\n    kind: \"schema\",\n    type: \"undefinedable\",\n    reference: undefinedableAsync,\n    expects: `(${wrapped.expects} | undefined)`,\n    async: true,\n    wrapped,\n    default: default_,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        if (this.default !== void 0) {\n          dataset.value = await getDefault(this, dataset, config2);\n        }\n        if (dataset.value === void 0) {\n          dataset.typed = true;\n          return dataset;\n        }\n      }\n      return this.wrapped[\"~run\"](dataset, config2);\n    }\n  };\n}\n\n// src/schemas/union/utils/_subIssues/_subIssues.ts\n// @__NO_SIDE_EFFECTS__\nfunction _subIssues(datasets) {\n  let issues;\n  if (datasets) {\n    for (const dataset of datasets) {\n      if (issues) {\n        issues.push(...dataset.issues);\n      } else {\n        issues = dataset.issues;\n      }\n    }\n  }\n  return issues;\n}\n\n// src/schemas/union/union.ts\n// @__NO_SIDE_EFFECTS__\nfunction union(options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"union\",\n    reference: union,\n    expects: _joinExpects(\n      options.map((option) => option.expects),\n      \"|\"\n    ),\n    async: false,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      let validDataset;\n      let typedDatasets;\n      let untypedDatasets;\n      for (const schema of this.options) {\n        const optionDataset = schema[\"~run\"]({ value: dataset.value }, config2);\n        if (optionDataset.typed) {\n          if (optionDataset.issues) {\n            if (typedDatasets) {\n              typedDatasets.push(optionDataset);\n            } else {\n              typedDatasets = [optionDataset];\n            }\n          } else {\n            validDataset = optionDataset;\n            break;\n          }\n        } else {\n          if (untypedDatasets) {\n            untypedDatasets.push(optionDataset);\n          } else {\n            untypedDatasets = [optionDataset];\n          }\n        }\n      }\n      if (validDataset) {\n        return validDataset;\n      }\n      if (typedDatasets) {\n        if (typedDatasets.length === 1) {\n          return typedDatasets[0];\n        }\n        _addIssue(this, \"type\", dataset, config2, {\n          issues: _subIssues(typedDatasets)\n        });\n        dataset.typed = true;\n      } else if (untypedDatasets?.length === 1) {\n        return untypedDatasets[0];\n      } else {\n        _addIssue(this, \"type\", dataset, config2, {\n          issues: _subIssues(untypedDatasets)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/union/unionAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction unionAsync(options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"union\",\n    reference: unionAsync,\n    expects: _joinExpects(\n      options.map((option) => option.expects),\n      \"|\"\n    ),\n    async: true,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      let validDataset;\n      let typedDatasets;\n      let untypedDatasets;\n      for (const schema of this.options) {\n        const optionDataset = await schema[\"~run\"](\n          { value: dataset.value },\n          config2\n        );\n        if (optionDataset.typed) {\n          if (optionDataset.issues) {\n            if (typedDatasets) {\n              typedDatasets.push(optionDataset);\n            } else {\n              typedDatasets = [optionDataset];\n            }\n          } else {\n            validDataset = optionDataset;\n            break;\n          }\n        } else {\n          if (untypedDatasets) {\n            untypedDatasets.push(optionDataset);\n          } else {\n            untypedDatasets = [optionDataset];\n          }\n        }\n      }\n      if (validDataset) {\n        return validDataset;\n      }\n      if (typedDatasets) {\n        if (typedDatasets.length === 1) {\n          return typedDatasets[0];\n        }\n        _addIssue(this, \"type\", dataset, config2, {\n          issues: _subIssues(typedDatasets)\n        });\n        dataset.typed = true;\n      } else if (untypedDatasets?.length === 1) {\n        return untypedDatasets[0];\n      } else {\n        _addIssue(this, \"type\", dataset, config2, {\n          issues: _subIssues(untypedDatasets)\n        });\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/unknown/unknown.ts\n// @__NO_SIDE_EFFECTS__\nfunction unknown() {\n  return {\n    kind: \"schema\",\n    type: \"unknown\",\n    reference: unknown,\n    expects: \"unknown\",\n    async: false,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset) {\n      dataset.typed = true;\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/variant/variant.ts\n// @__NO_SIDE_EFFECTS__\nfunction variant(key, options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"variant\",\n    reference: variant,\n    expects: \"Object\",\n    async: false,\n    key,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        let outputDataset;\n        let maxDiscriminatorPriority = 0;\n        let invalidDiscriminatorKey = this.key;\n        let expectedDiscriminators = [];\n        const parseOptions = (variant2, allKeys) => {\n          for (const schema of variant2.options) {\n            if (schema.type === \"variant\") {\n              parseOptions(schema, new Set(allKeys).add(schema.key));\n            } else {\n              let keysAreValid = true;\n              let currentPriority = 0;\n              for (const currentKey of allKeys) {\n                const discriminatorSchema = schema.entries[currentKey];\n                if (currentKey in input ? discriminatorSchema[\"~run\"](\n                  // @ts-expect-error\n                  { typed: false, value: input[currentKey] },\n                  { abortEarly: true }\n                ).issues : discriminatorSchema.type !== \"exact_optional\" && discriminatorSchema.type !== \"optional\" && discriminatorSchema.type !== \"nullish\") {\n                  keysAreValid = false;\n                  if (invalidDiscriminatorKey !== currentKey && (maxDiscriminatorPriority < currentPriority || maxDiscriminatorPriority === currentPriority && currentKey in input && !(invalidDiscriminatorKey in input))) {\n                    maxDiscriminatorPriority = currentPriority;\n                    invalidDiscriminatorKey = currentKey;\n                    expectedDiscriminators = [];\n                  }\n                  if (invalidDiscriminatorKey === currentKey) {\n                    expectedDiscriminators.push(\n                      schema.entries[currentKey].expects\n                    );\n                  }\n                  break;\n                }\n                currentPriority++;\n              }\n              if (keysAreValid) {\n                const optionDataset = schema[\"~run\"]({ value: input }, config2);\n                if (!outputDataset || !outputDataset.typed && optionDataset.typed) {\n                  outputDataset = optionDataset;\n                }\n              }\n            }\n            if (outputDataset && !outputDataset.issues) {\n              break;\n            }\n          }\n        };\n        parseOptions(this, /* @__PURE__ */ new Set([this.key]));\n        if (outputDataset) {\n          return outputDataset;\n        }\n        _addIssue(this, \"type\", dataset, config2, {\n          // @ts-expect-error\n          input: input[invalidDiscriminatorKey],\n          expected: _joinExpects(expectedDiscriminators, \"|\"),\n          path: [\n            {\n              type: \"object\",\n              origin: \"value\",\n              input,\n              key: invalidDiscriminatorKey,\n              // @ts-expect-error\n              value: input[invalidDiscriminatorKey]\n            }\n          ]\n        });\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/variant/variantAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction variantAsync(key, options, message2) {\n  return {\n    kind: \"schema\",\n    type: \"variant\",\n    reference: variantAsync,\n    expects: \"Object\",\n    async: true,\n    key,\n    options,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      const input = dataset.value;\n      if (input && typeof input === \"object\") {\n        let outputDataset;\n        let maxDiscriminatorPriority = 0;\n        let invalidDiscriminatorKey = this.key;\n        let expectedDiscriminators = [];\n        const parseOptions = async (variant2, allKeys) => {\n          for (const schema of variant2.options) {\n            if (schema.type === \"variant\") {\n              await parseOptions(schema, new Set(allKeys).add(schema.key));\n            } else {\n              let keysAreValid = true;\n              let currentPriority = 0;\n              for (const currentKey of allKeys) {\n                const discriminatorSchema = schema.entries[currentKey];\n                if (currentKey in input ? (await discriminatorSchema[\"~run\"](\n                  // @ts-expect-error\n                  { typed: false, value: input[currentKey] },\n                  { abortEarly: true }\n                )).issues : discriminatorSchema.type !== \"exact_optional\" && discriminatorSchema.type !== \"optional\" && discriminatorSchema.type !== \"nullish\") {\n                  keysAreValid = false;\n                  if (invalidDiscriminatorKey !== currentKey && (maxDiscriminatorPriority < currentPriority || maxDiscriminatorPriority === currentPriority && currentKey in input && !(invalidDiscriminatorKey in input))) {\n                    maxDiscriminatorPriority = currentPriority;\n                    invalidDiscriminatorKey = currentKey;\n                    expectedDiscriminators = [];\n                  }\n                  if (invalidDiscriminatorKey === currentKey) {\n                    expectedDiscriminators.push(\n                      schema.entries[currentKey].expects\n                    );\n                  }\n                  break;\n                }\n                currentPriority++;\n              }\n              if (keysAreValid) {\n                const optionDataset = await schema[\"~run\"](\n                  { value: input },\n                  config2\n                );\n                if (!outputDataset || !outputDataset.typed && optionDataset.typed) {\n                  outputDataset = optionDataset;\n                }\n              }\n            }\n            if (outputDataset && !outputDataset.issues) {\n              break;\n            }\n          }\n        };\n        await parseOptions(this, /* @__PURE__ */ new Set([this.key]));\n        if (outputDataset) {\n          return outputDataset;\n        }\n        _addIssue(this, \"type\", dataset, config2, {\n          // @ts-expect-error\n          input: input[invalidDiscriminatorKey],\n          expected: _joinExpects(expectedDiscriminators, \"|\"),\n          path: [\n            {\n              type: \"object\",\n              origin: \"value\",\n              input,\n              key: invalidDiscriminatorKey,\n              // @ts-expect-error\n              value: input[invalidDiscriminatorKey]\n            }\n          ]\n        });\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/schemas/void/void.ts\n// @__NO_SIDE_EFFECTS__\nfunction void_(message2) {\n  return {\n    kind: \"schema\",\n    type: \"void\",\n    reference: void_,\n    expects: \"void\",\n    async: false,\n    message: message2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      if (dataset.value === void 0) {\n        dataset.typed = true;\n      } else {\n        _addIssue(this, \"type\", dataset, config2);\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/keyof/keyof.ts\n// @__NO_SIDE_EFFECTS__\nfunction keyof(schema, message2) {\n  return picklist(Object.keys(schema.entries), message2);\n}\n\n// src/methods/message/message.ts\n// @__NO_SIDE_EFFECTS__\nfunction message(schema, message_) {\n  return {\n    ...schema,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      return schema[\"~run\"](dataset, { ...config2, message: message_ });\n    }\n  };\n}\n\n// src/methods/omit/omit.ts\n// @__NO_SIDE_EFFECTS__\nfunction omit(schema, keys) {\n  const entries2 = {\n    ...schema.entries\n  };\n  for (const key of keys) {\n    delete entries2[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/parse/parse.ts\nfunction parse(schema, input, config2) {\n  const dataset = schema[\"~run\"]({ value: input }, getGlobalConfig(config2));\n  if (dataset.issues) {\n    throw new ValiError(dataset.issues);\n  }\n  return dataset.value;\n}\n\n// src/methods/parse/parseAsync.ts\nasync function parseAsync(schema, input, config2) {\n  const dataset = await schema[\"~run\"](\n    { value: input },\n    getGlobalConfig(config2)\n  );\n  if (dataset.issues) {\n    throw new ValiError(dataset.issues);\n  }\n  return dataset.value;\n}\n\n// src/methods/parser/parser.ts\n// @__NO_SIDE_EFFECTS__\nfunction parser(schema, config2) {\n  const func = (input) => parse(schema, input, config2);\n  func.schema = schema;\n  func.config = config2;\n  return func;\n}\n\n// src/methods/parser/parserAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction parserAsync(schema, config2) {\n  const func = (input) => parseAsync(schema, input, config2);\n  func.schema = schema;\n  func.config = config2;\n  return func;\n}\n\n// src/methods/partial/partial.ts\n// @__NO_SIDE_EFFECTS__\nfunction partial(schema, keys) {\n  const entries2 = {};\n  for (const key in schema.entries) {\n    entries2[key] = !keys || keys.includes(key) ? optional(schema.entries[key]) : schema.entries[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/partial/partialAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction partialAsync(schema, keys) {\n  const entries2 = {};\n  for (const key in schema.entries) {\n    entries2[key] = !keys || keys.includes(key) ? optionalAsync(schema.entries[key]) : schema.entries[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/pick/pick.ts\n// @__NO_SIDE_EFFECTS__\nfunction pick(schema, keys) {\n  const entries2 = {};\n  for (const key of keys) {\n    entries2[key] = schema.entries[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/pipe/pipe.ts\n// @__NO_SIDE_EFFECTS__\nfunction pipe(...pipe2) {\n  return {\n    ...pipe2[0],\n    pipe: pipe2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    \"~run\"(dataset, config2) {\n      for (const item of pipe2) {\n        if (item.kind !== \"metadata\") {\n          if (dataset.issues && (item.kind === \"schema\" || item.kind === \"transformation\")) {\n            dataset.typed = false;\n            break;\n          }\n          if (!dataset.issues || !config2.abortEarly && !config2.abortPipeEarly) {\n            dataset = item[\"~run\"](dataset, config2);\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/pipe/pipeAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction pipeAsync(...pipe2) {\n  return {\n    ...pipe2[0],\n    pipe: pipe2,\n    async: true,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    },\n    async \"~run\"(dataset, config2) {\n      for (const item of pipe2) {\n        if (item.kind !== \"metadata\") {\n          if (dataset.issues && (item.kind === \"schema\" || item.kind === \"transformation\")) {\n            dataset.typed = false;\n            break;\n          }\n          if (!dataset.issues || !config2.abortEarly && !config2.abortPipeEarly) {\n            dataset = await item[\"~run\"](dataset, config2);\n          }\n        }\n      }\n      return dataset;\n    }\n  };\n}\n\n// src/methods/required/required.ts\n// @__NO_SIDE_EFFECTS__\nfunction required(schema, arg2, arg3) {\n  const keys = Array.isArray(arg2) ? arg2 : void 0;\n  const message2 = Array.isArray(arg2) ? arg3 : arg2;\n  const entries2 = {};\n  for (const key in schema.entries) {\n    entries2[key] = !keys || keys.includes(key) ? nonOptional(schema.entries[key], message2) : schema.entries[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/required/requiredAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction requiredAsync(schema, arg2, arg3) {\n  const keys = Array.isArray(arg2) ? arg2 : void 0;\n  const message2 = Array.isArray(arg2) ? arg3 : arg2;\n  const entries2 = {};\n  for (const key in schema.entries) {\n    entries2[key] = !keys || keys.includes(key) ? nonOptionalAsync(schema.entries[key], message2) : schema.entries[key];\n  }\n  return {\n    ...schema,\n    entries: entries2,\n    get \"~standard\"() {\n      return _getStandardProps(this);\n    }\n  };\n}\n\n// src/methods/safeParse/safeParse.ts\n// @__NO_SIDE_EFFECTS__\nfunction safeParse(schema, input, config2) {\n  const dataset = schema[\"~run\"]({ value: input }, getGlobalConfig(config2));\n  return {\n    typed: dataset.typed,\n    success: !dataset.issues,\n    output: dataset.value,\n    issues: dataset.issues\n  };\n}\n\n// src/methods/safeParse/safeParseAsync.ts\n// @__NO_SIDE_EFFECTS__\nasync function safeParseAsync(schema, input, config2) {\n  const dataset = await schema[\"~run\"](\n    { value: input },\n    getGlobalConfig(config2)\n  );\n  return {\n    typed: dataset.typed,\n    success: !dataset.issues,\n    output: dataset.value,\n    issues: dataset.issues\n  };\n}\n\n// src/methods/safeParser/safeParser.ts\n// @__NO_SIDE_EFFECTS__\nfunction safeParser(schema, config2) {\n  const func = (input) => safeParse(schema, input, config2);\n  func.schema = schema;\n  func.config = config2;\n  return func;\n}\n\n// src/methods/safeParser/safeParserAsync.ts\n// @__NO_SIDE_EFFECTS__\nfunction safeParserAsync(schema, config2) {\n  const func = (input) => safeParseAsync(schema, input, config2);\n  func.schema = schema;\n  func.config = config2;\n  return func;\n}\n\n// src/methods/summarize/summarize.ts\n// @__NO_SIDE_EFFECTS__\nfunction summarize(issues) {\n  let summary = \"\";\n  for (const issue of issues) {\n    if (summary) {\n      summary += \"\\n\";\n    }\n    summary += `\\xD7 ${issue.message}`;\n    const dotPath = getDotPath(issue);\n    if (dotPath) {\n      summary += `\n  \\u2192 at ${dotPath}`;\n    }\n  }\n  return summary;\n}\n\n// src/methods/unwrap/unwrap.ts\n// @__NO_SIDE_EFFECTS__\nfunction unwrap(schema) {\n  return schema.wrapped;\n}\nexport {\n  BASE64_REGEX,\n  BIC_REGEX,\n  CUID2_REGEX,\n  DECIMAL_REGEX,\n  DIGITS_REGEX,\n  EMAIL_REGEX,\n  EMOJI_REGEX,\n  HEXADECIMAL_REGEX,\n  HEX_COLOR_REGEX,\n  IMEI_REGEX,\n  IPV4_REGEX,\n  IPV6_REGEX,\n  IP_REGEX,\n  ISO_DATE_REGEX,\n  ISO_DATE_TIME_REGEX,\n  ISO_TIMESTAMP_REGEX,\n  ISO_TIME_REGEX,\n  ISO_TIME_SECOND_REGEX,\n  ISO_WEEK_REGEX,\n  MAC48_REGEX,\n  MAC64_REGEX,\n  MAC_REGEX,\n  NANO_ID_REGEX,\n  OCTAL_REGEX,\n  RFC_EMAIL_REGEX,\n  SLUG_REGEX,\n  ULID_REGEX,\n  UUID_REGEX,\n  ValiError,\n  _addIssue,\n  _getByteCount,\n  _getGraphemeCount,\n  _getLastMetadata,\n  _getStandardProps,\n  _getWordCount,\n  _isLuhnAlgo,\n  _isValidObjectKey,\n  _joinExpects,\n  _stringify,\n  any,\n  args,\n  argsAsync,\n  array,\n  arrayAsync,\n  assert,\n  awaitAsync,\n  base64,\n  bic,\n  bigint,\n  blob,\n  boolean,\n  brand,\n  bytes,\n  check,\n  checkAsync,\n  checkItems,\n  checkItemsAsync,\n  config,\n  creditCard,\n  cuid2,\n  custom,\n  customAsync,\n  date,\n  decimal,\n  deleteGlobalConfig,\n  deleteGlobalMessage,\n  deleteSchemaMessage,\n  deleteSpecificMessage,\n  description,\n  digits,\n  email,\n  emoji,\n  empty,\n  endsWith,\n  entries,\n  entriesFromList,\n  entriesFromObjects,\n  enum_ as enum,\n  enum_,\n  everyItem,\n  exactOptional,\n  exactOptionalAsync,\n  excludes,\n  fallback,\n  fallbackAsync,\n  file,\n  filterItems,\n  findItem,\n  finite,\n  flatten,\n  flavor,\n  forward,\n  forwardAsync,\n  function_ as function,\n  function_,\n  getDefault,\n  getDefaults,\n  getDefaultsAsync,\n  getDescription,\n  getDotPath,\n  getFallback,\n  getFallbacks,\n  getFallbacksAsync,\n  getGlobalConfig,\n  getGlobalMessage,\n  getMetadata,\n  getSchemaMessage,\n  getSpecificMessage,\n  getTitle,\n  graphemes,\n  gtValue,\n  hash,\n  hexColor,\n  hexadecimal,\n  imei,\n  includes,\n  instance,\n  integer,\n  intersect,\n  intersectAsync,\n  ip,\n  ipv4,\n  ipv6,\n  is,\n  isOfKind,\n  isOfType,\n  isValiError,\n  isoDate,\n  isoDateTime,\n  isoTime,\n  isoTimeSecond,\n  isoTimestamp,\n  isoWeek,\n  keyof,\n  lazy,\n  lazyAsync,\n  length,\n  literal,\n  looseObject,\n  looseObjectAsync,\n  looseTuple,\n  looseTupleAsync,\n  ltValue,\n  mac,\n  mac48,\n  mac64,\n  map,\n  mapAsync,\n  mapItems,\n  maxBytes,\n  maxEntries,\n  maxGraphemes,\n  maxLength,\n  maxSize,\n  maxValue,\n  maxWords,\n  message,\n  metadata,\n  mimeType,\n  minBytes,\n  minEntries,\n  minGraphemes,\n  minLength,\n  minSize,\n  minValue,\n  minWords,\n  multipleOf,\n  nan,\n  nanoid,\n  never,\n  nonEmpty,\n  nonNullable,\n  nonNullableAsync,\n  nonNullish,\n  nonNullishAsync,\n  nonOptional,\n  nonOptionalAsync,\n  normalize,\n  notBytes,\n  notEntries,\n  notGraphemes,\n  notLength,\n  notSize,\n  notValue,\n  notValues,\n  notWords,\n  null_ as null,\n  null_,\n  nullable,\n  nullableAsync,\n  nullish,\n  nullishAsync,\n  number,\n  object,\n  objectAsync,\n  objectWithRest,\n  objectWithRestAsync,\n  octal,\n  omit,\n  optional,\n  optionalAsync,\n  parse,\n  parseAsync,\n  parseJson,\n  parser,\n  parserAsync,\n  partial,\n  partialAsync,\n  partialCheck,\n  partialCheckAsync,\n  pick,\n  picklist,\n  pipe,\n  pipeAsync,\n  promise,\n  rawCheck,\n  rawCheckAsync,\n  rawTransform,\n  rawTransformAsync,\n  readonly,\n  record,\n  recordAsync,\n  reduceItems,\n  regex,\n  required,\n  requiredAsync,\n  returns,\n  returnsAsync,\n  rfcEmail,\n  safeInteger,\n  safeParse,\n  safeParseAsync,\n  safeParser,\n  safeParserAsync,\n  set,\n  setAsync,\n  setGlobalConfig,\n  setGlobalMessage,\n  setSchemaMessage,\n  setSpecificMessage,\n  size,\n  slug,\n  someItem,\n  sortItems,\n  startsWith,\n  strictObject,\n  strictObjectAsync,\n  strictTuple,\n  strictTupleAsync,\n  string,\n  stringifyJson,\n  summarize,\n  symbol,\n  title,\n  toLowerCase,\n  toMaxValue,\n  toMinValue,\n  toUpperCase,\n  transform,\n  transformAsync,\n  trim,\n  trimEnd,\n  trimStart,\n  tuple,\n  tupleAsync,\n  tupleWithRest,\n  tupleWithRestAsync,\n  ulid,\n  undefined_ as undefined,\n  undefined_,\n  undefinedable,\n  undefinedableAsync,\n  union,\n  unionAsync,\n  unknown,\n  unwrap,\n  url,\n  uuid,\n  value,\n  values,\n  variant,\n  variantAsync,\n  void_ as void,\n  void_,\n  words\n};\n","/**\r\n * Valibot schemas for runtime validation of Foundry settings and flags.\r\n *\r\n * SECURITY: Settings and flags are external input and must be validated!\r\n */\r\n\r\nimport * as v from \"valibot\";\r\nimport { LogLevel } from \"@/framework/config/environment\";\r\n\r\n/**\r\n * Schema for LogLevel setting values.\r\n * Validates that value is one of the defined LogLevel enum values.\r\n */\r\nexport const LOG_LEVEL_SCHEMA = v.picklist([\r\n  LogLevel.DEBUG,\r\n  LogLevel.INFO,\r\n  LogLevel.WARN,\r\n  LogLevel.ERROR,\r\n]);\r\n\r\n/**\r\n * Schema for boolean flag values.\r\n * Used for journal entry flags like \"hidden\".\r\n */\r\nexport const BOOLEAN_FLAG_SCHEMA = v.boolean();\r\n\r\n/**\r\n * Schema for non-negative numbers (>= 0).\r\n */\r\nexport const NON_NEGATIVE_NUMBER_SCHEMA = v.pipe(v.number(), v.minValue(0));\r\n\r\n/**\r\n * Schema for non-negative integers (>= 0).\r\n */\r\nexport const NON_NEGATIVE_INTEGER_SCHEMA = v.pipe(v.number(), v.integer(), v.minValue(0));\r\n\r\n/**\r\n * Schema for sampling rates between 0 and 1.\r\n */\r\nexport const SAMPLING_RATE_SCHEMA = v.pipe(v.number(), v.minValue(0), v.maxValue(1));\r\n\r\n/**\r\n * Schema for non-empty strings.\r\n */\r\nexport const NON_EMPTY_STRING_SCHEMA = v.pipe(v.string(), v.minLength(1));\r\n","/**\r\n * Bootstrap init hook registration service.\r\n *\r\n * CRITICAL: Uses direct Hooks.on() instead of PlatformEventPort to avoid chicken-egg problem.\r\n * The PlatformEventPort system requires version detection (game.version), but game.version\r\n * might not be available before the init hook runs. These bootstrap hooks must be registered\r\n * immediately, so we use direct Foundry Hooks API here.\r\n *\r\n * All other hooks (registered inside init) can use PlatformEventPort normally.\r\n */\r\n\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport {\r\n  moduleSettingsRegistrarToken,\r\n  moduleEventRegistrarToken,\r\n  moduleApiInitializerToken,\r\n  notificationCenterToken,\r\n  uiChannelToken,\r\n  journalContextMenuLibWrapperServiceToken,\r\n  registerContextMenuUseCaseToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens\";\r\nimport { LOG_LEVEL_SCHEMA } from \"@/infrastructure/adapters/foundry/validation/setting-schemas\";\r\nimport { LogLevel } from \"@/framework/config/environment\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { loggerToken, serviceContainerToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Service responsible for registering the Foundry 'init' hook.\r\n * Handles all initialization logic when the init hook fires.\r\n */\r\nexport class BootstrapInitHookService {\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly container: ServiceContainer\r\n  ) {}\r\n\r\n  /**\r\n   * Registers the init hook with direct Hooks.on().\r\n   * Must be called before Foundry's init hook fires.\r\n   */\r\n  register(): void {\r\n    // Guard: Ensure Foundry Hooks API is available\r\n    if (typeof Hooks === \"undefined\") {\r\n      this.logger.warn(\"Foundry Hooks API not available - init hook registration skipped\");\r\n      return;\r\n    }\r\n\r\n    /* v8 ignore start -- @preserve */\r\n    /* Foundry-Hooks und UI-spezifische Pfade hängen stark von der Laufzeitumgebung ab\r\n     * und werden primär über Integrations-/E2E-Tests abgesichert. Für das aktuelle Quality-Gateway\r\n     * blenden wir diese verzweigten Pfade temporär aus und reduzieren die Ignores später gezielt. */\r\n    // CRITICAL: Use direct Hooks.on() instead of PlatformEventPort to avoid chicken-egg problem\r\n    Hooks.on(\"init\", () => {\r\n      this.logger.info(\"init-phase\");\r\n\r\n      // Add UI notifications channel once Foundry UI ports are available.\r\n      const notificationCenterResult = this.container.resolveWithError(notificationCenterToken);\r\n      if (notificationCenterResult.ok) {\r\n        const uiChannelResult = this.container.resolveWithError(uiChannelToken);\r\n        if (uiChannelResult.ok) {\r\n          notificationCenterResult.value.addChannel(uiChannelResult.value);\r\n        } else {\r\n          this.logger.warn(\r\n            \"UI channel could not be resolved; NotificationCenter will remain console-only\",\r\n            uiChannelResult.error\r\n          );\r\n        }\r\n      } else {\r\n        this.logger.warn(\r\n          \"NotificationCenter could not be resolved during init; UI channel not attached\",\r\n          notificationCenterResult.error\r\n        );\r\n      }\r\n\r\n      // Expose Module API via DI-Service\r\n      const apiInitializerResult = this.container.resolveWithError(moduleApiInitializerToken);\r\n      if (!apiInitializerResult.ok) {\r\n        this.logger.error(\r\n          `Failed to resolve ModuleApiInitializer: ${apiInitializerResult.error.message}`\r\n        );\r\n        return;\r\n      }\r\n\r\n      const exposeResult = apiInitializerResult.value.expose(this.container);\r\n      if (!exposeResult.ok) {\r\n        this.logger.error(`Failed to expose API: ${exposeResult.error}`);\r\n        return;\r\n      }\r\n\r\n      // Register module settings (must be done before settings are read)\r\n      const settingsRegistrarResult = this.container.resolveWithError(moduleSettingsRegistrarToken);\r\n      if (!settingsRegistrarResult.ok) {\r\n        this.logger.error(\r\n          `Failed to resolve ModuleSettingsRegistrar: ${settingsRegistrarResult.error.message}`\r\n        );\r\n        return;\r\n      }\r\n      // Container parameter removed - all dependencies injected via constructor\r\n      settingsRegistrarResult.value.registerAll();\r\n\r\n      // Configure logger with current setting value\r\n      const settingsResult = this.container.resolveWithError(foundrySettingsToken);\r\n      if (settingsResult.ok) {\r\n        const settings = settingsResult.value;\r\n        const logLevelResult = settings.get(\r\n          MODULE_CONSTANTS.MODULE.ID,\r\n          MODULE_CONSTANTS.SETTINGS.LOG_LEVEL,\r\n          LOG_LEVEL_SCHEMA\r\n        );\r\n\r\n        if (logLevelResult.ok && this.logger.setMinLevel) {\r\n          this.logger.setMinLevel(logLevelResult.value);\r\n          this.logger.debug(`Logger configured with level: ${LogLevel[logLevelResult.value]}`);\r\n        }\r\n      }\r\n\r\n      // Register event listeners\r\n      const eventRegistrarResult = this.container.resolveWithError(moduleEventRegistrarToken);\r\n      if (!eventRegistrarResult.ok) {\r\n        this.logger.error(\r\n          `Failed to resolve ModuleEventRegistrar: ${eventRegistrarResult.error.message}`\r\n        );\r\n        return;\r\n      }\r\n      // Container parameter removed - all dependencies injected via constructor\r\n      const eventRegistrationResult = eventRegistrarResult.value.registerAll();\r\n      if (!eventRegistrationResult.ok) {\r\n        this.logger.error(\"Failed to register one or more event listeners\", {\r\n          errors: eventRegistrationResult.error.map((e) => e.message),\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Register context menu libWrapper (NOT an event - direct libWrapper registration)\r\n      const contextMenuLibWrapperResult = this.container.resolveWithError(\r\n        journalContextMenuLibWrapperServiceToken\r\n      );\r\n      if (contextMenuLibWrapperResult.ok) {\r\n        const registerResult = contextMenuLibWrapperResult.value.register();\r\n        if (!registerResult.ok) {\r\n          this.logger.warn(\r\n            `Failed to register context menu libWrapper: ${registerResult.error.message}`\r\n          );\r\n        } else {\r\n          this.logger.debug(\"Context menu libWrapper registered successfully\");\r\n\r\n          // Register context menu callbacks (after libWrapper is registered)\r\n          const contextMenuUseCaseResult = this.container.resolveWithError(\r\n            registerContextMenuUseCaseToken\r\n          );\r\n          if (contextMenuUseCaseResult.ok) {\r\n            const callbackRegisterResult = contextMenuUseCaseResult.value.register();\r\n            if (!callbackRegisterResult.ok) {\r\n              this.logger.warn(\r\n                `Failed to register context menu callbacks: ${callbackRegisterResult.error.message}`\r\n              );\r\n            } else {\r\n              this.logger.debug(\"Context menu callbacks registered successfully\");\r\n            }\r\n          } else {\r\n            this.logger.warn(\r\n              `Failed to resolve RegisterContextMenuUseCase: ${contextMenuUseCaseResult.error.message}`\r\n            );\r\n          }\r\n        }\r\n      } else {\r\n        this.logger.warn(\r\n          `Failed to resolve JournalContextMenuLibWrapperService: ${contextMenuLibWrapperResult.error.message}`\r\n        );\r\n      }\r\n\r\n      this.logger.info(\"init-phase completed\");\r\n    });\r\n    /* v8 ignore stop -- @preserve */\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for BootstrapInitHookService.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIBootstrapInitHookService extends BootstrapInitHookService {\r\n  static dependencies = [loggerToken, serviceContainerToken] as const;\r\n\r\n  constructor(logger: Logger, container: ServiceContainer) {\r\n    super(logger, container);\r\n  }\r\n}\r\n","/**\r\n * Bootstrap ready hook registration service.\r\n *\r\n * CRITICAL: Uses direct Hooks.on() instead of PlatformEventPort to avoid chicken-egg problem.\r\n * The PlatformEventPort system requires version detection (game.version), but game.version\r\n * might not be available before the init hook runs. These bootstrap hooks must be registered\r\n * immediately, so we use direct Foundry Hooks API here.\r\n *\r\n * All other hooks (registered inside init) can use PlatformEventPort normally.\r\n */\r\n\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Service responsible for registering the Foundry 'ready' hook.\r\n * Handles ready-phase logic when the ready hook fires.\r\n */\r\nexport class BootstrapReadyHookService {\r\n  constructor(private readonly logger: Logger) {}\r\n\r\n  /**\r\n   * Registers the ready hook with direct Hooks.on().\r\n   * Must be called before Foundry's ready hook fires.\r\n   */\r\n  register(): void {\r\n    // Guard: Ensure Foundry Hooks API is available\r\n    if (typeof Hooks === \"undefined\") {\r\n      this.logger.warn(\"Foundry Hooks API not available - ready hook registration skipped\");\r\n      return;\r\n    }\r\n\r\n    /* v8 ignore start -- @preserve */\r\n    /* Foundry-Hooks und UI-spezifische Pfade hängen stark von der Laufzeitumgebung ab\r\n     * und werden primär über Integrations-/E2E-Tests abgesichert. Für das aktuelle Quality-Gateway\r\n     * blenden wir diese verzweigten Pfade temporär aus und reduzieren die Ignores später gezielt. */\r\n    // CRITICAL: Use direct Hooks.on() instead of PlatformEventPort to avoid chicken-egg problem\r\n    Hooks.on(\"ready\", () => {\r\n      this.logger.info(\"ready-phase\");\r\n      this.logger.info(\"ready-phase completed\");\r\n    });\r\n    /* v8 ignore stop -- @preserve */\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for BootstrapReadyHookService.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIBootstrapReadyHookService extends BootstrapReadyHookService {\r\n  static dependencies = [loggerToken] as const;\r\n\r\n  constructor(logger: Logger) {\r\n    super(logger);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  metricsCollectorToken,\r\n  metricsRecorderToken,\r\n  metricsSamplerToken,\r\n  loggerToken,\r\n  traceContextToken,\r\n  moduleHealthServiceToken,\r\n  moduleApiInitializerToken,\r\n  healthCheckRegistryToken,\r\n  metricsStorageToken,\r\n  runtimeConfigToken,\r\n  bootstrapInitHookServiceToken,\r\n  bootstrapReadyHookServiceToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIMetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { DIPersistentMetricsCollector } from \"@/infrastructure/observability/metrics-persistence/persistent-metrics-collector\";\r\nimport { LocalStorageMetricsStorage } from \"@/infrastructure/observability/metrics-persistence/local-storage-metrics-storage\";\r\nimport { DIConsoleLoggerService } from \"@/infrastructure/logging/ConsoleLoggerService\";\r\nimport { DITraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport { DIModuleHealthService } from \"@/application/services/ModuleHealthService\";\r\nimport { DIModuleApiInitializer } from \"@/framework/core/api/module-api-initializer\";\r\nimport { DIHealthCheckRegistry } from \"@/application/health/HealthCheckRegistry\";\r\nimport { DIBootstrapInitHookService } from \"@/framework/core/bootstrap-init-hook\";\r\nimport { DIBootstrapReadyHookService } from \"@/framework/core/bootstrap-ready-hook\";\r\n\r\n/**\r\n * Registers core infrastructure services.\r\n *\r\n * Services registered:\r\n * - MetricsCollector (singleton)\r\n * - MetricsRecorder/MetricsSampler (aliases to MetricsCollector)\r\n * - Logger (singleton, self-configuring via RuntimeConfigService, optional TraceContext)\r\n * - TraceContext (singleton, deps: [loggerToken])\r\n * - HealthCheckRegistry (singleton)\r\n * - ContainerHealthCheck (singleton, auto-registered)\r\n * - MetricsHealthCheck (singleton, auto-registered)\r\n * - ModuleHealthService (singleton, uses HealthCheckRegistry)\r\n * - ModuleApiInitializer (singleton, handles API exposition)\r\n *\r\n * INITIALIZATION ORDER:\r\n * 1. MetricsCollector (deps: [runtimeConfigToken])\r\n * 2. TraceContext (no dependencies)\r\n * 3. Logger (klassische DI mit deps: [runtimeConfigToken, traceContextToken])\r\n * 4. HealthCheckRegistry (no dependencies)\r\n * 5. ContainerHealthCheck & MetricsHealthCheck (auto-register to registry)\r\n * 6. ModuleHealthService (deps: [healthCheckRegistryToken])\r\n * 7. ModuleApiInitializer (no dependencies)\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerCoreServices(container: ServiceContainer): Result<void, string> {\r\n  const runtimeConfig = container.getRegisteredValue(runtimeConfigToken);\r\n  if (!runtimeConfig) {\r\n    return err(\"RuntimeConfigService not registered\");\r\n  }\r\n  const enablePersistence = runtimeConfig.get(\"enableMetricsPersistence\") === true;\r\n\r\n  if (enablePersistence) {\r\n    const metricsKey =\r\n      runtimeConfig.get(\"metricsPersistenceKey\") ?? \"fvtt_relationship_app_module.metrics\";\r\n    const storageInstance = new LocalStorageMetricsStorage(metricsKey);\r\n    const storageResult = container.registerValue(metricsStorageToken, storageInstance);\r\n    if (isErr(storageResult)) {\r\n      return err(`Failed to register MetricsStorage: ${storageResult.error.message}`);\r\n    }\r\n\r\n    const persistentResult = container.registerClass(\r\n      metricsCollectorToken,\r\n      DIPersistentMetricsCollector,\r\n      ServiceLifecycle.SINGLETON\r\n    );\r\n    if (isErr(persistentResult)) {\r\n      return err(\r\n        `Failed to register PersistentMetricsCollector: ${persistentResult.error.message}`\r\n      );\r\n    }\r\n  } else {\r\n    const metricsResult = container.registerClass(\r\n      metricsCollectorToken,\r\n      DIMetricsCollector,\r\n      ServiceLifecycle.SINGLETON\r\n    );\r\n    if (isErr(metricsResult)) {\r\n      return err(`Failed to register MetricsCollector: ${metricsResult.error.message}`);\r\n    }\r\n  }\r\n\r\n  // Register MetricsRecorder and MetricsSampler as aliases to MetricsCollector\r\n  // This provides segregated interfaces (ISP - Interface Segregation Principle)\r\n  container.registerAlias(metricsRecorderToken, metricsCollectorToken);\r\n  container.registerAlias(metricsSamplerToken, metricsCollectorToken);\r\n\r\n  // Register TraceContext first (no dependencies)\r\n  // TraceContext must be registered before Logger to avoid circular dependency\r\n  const traceContextResult = container.registerClass(\r\n    traceContextToken,\r\n    DITraceContext,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(traceContextResult)) {\r\n    return err(`Failed to register TraceContext: ${traceContextResult.error.message}`);\r\n  }\r\n\r\n  // Register Logger with class injection (EnvironmentConfig + TraceContext)\r\n  const loggerResult = container.registerClass(\r\n    loggerToken,\r\n    DIConsoleLoggerService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(loggerResult)) {\r\n    return err(`Failed to register Logger: ${loggerResult.error.message}`);\r\n  }\r\n\r\n  // Register HealthCheckRegistry (but don't resolve yet - needs container validation first)\r\n  const registryResult = container.registerClass(\r\n    healthCheckRegistryToken,\r\n    DIHealthCheckRegistry,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(registryResult)) {\r\n    return err(`Failed to register HealthCheckRegistry: ${registryResult.error.message}`);\r\n  }\r\n\r\n  // Register ModuleHealthService (uses HealthCheckRegistry)\r\n  const healthResult = container.registerClass(\r\n    moduleHealthServiceToken,\r\n    DIModuleHealthService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(healthResult)) {\r\n    return err(`Failed to register ModuleHealthService: ${healthResult.error.message}`);\r\n  }\r\n\r\n  // Register ModuleApiInitializer (no dependencies, handles API exposition)\r\n  const apiInitResult = container.registerClass(\r\n    moduleApiInitializerToken,\r\n    DIModuleApiInitializer,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(apiInitResult)) {\r\n    return err(`Failed to register ModuleApiInitializer: ${apiInitResult.error.message}`);\r\n  }\r\n\r\n  // Register BootstrapInitHookService (deps: [loggerToken, serviceContainerToken])\r\n  const initHookResult = container.registerClass(\r\n    bootstrapInitHookServiceToken,\r\n    DIBootstrapInitHookService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(initHookResult)) {\r\n    return err(`Failed to register BootstrapInitHookService: ${initHookResult.error.message}`);\r\n  }\r\n\r\n  // Register BootstrapReadyHookService (deps: [loggerToken])\r\n  const readyHookResult = container.registerClass(\r\n    bootstrapReadyHookServiceToken,\r\n    DIBootstrapReadyHookService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(readyHookResult)) {\r\n    return err(`Failed to register BootstrapReadyHookService: ${readyHookResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * Event system for PortSelector observability.\r\n *\r\n * **Design Rationale:**\r\n * - Decouples PortSelector from logging and metrics concerns\r\n * - Follows Observer Pattern for extensible observability\r\n * - Reduces PortSelector dependencies from 3 to 0\r\n * - Allows multiple observers without modifying PortSelector\r\n *\r\n * @see PortSelector for event emission\r\n * @see PortSelectionObserver for event consumption\r\n */\r\n\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\n\r\nexport type PortSelectionSuccessEvent = {\r\n  type: \"success\";\r\n  selectedVersion: number;\r\n  foundryVersion: number;\r\n  durationMs: number;\r\n  adapterName?: string;\r\n};\r\n\r\nexport type PortSelectionFailureEvent = {\r\n  type: \"failure\";\r\n  foundryVersion: number;\r\n  availableVersions: string;\r\n  adapterName?: string;\r\n  error: FoundryError;\r\n};\r\n\r\nexport type PortSelectionEvent = PortSelectionSuccessEvent | PortSelectionFailureEvent;\r\nexport type PortSelectionEventCallback = (event: PortSelectionEvent) => void;\r\n\r\n/**\r\n * Simple observable emitter used by the PortSelector to notify interested\r\n * observers about success/failure outcomes.\r\n */\r\nexport class PortSelectionEventEmitter {\r\n  private readonly subscribers = new Set<PortSelectionEventCallback>();\r\n\r\n  subscribe(callback: PortSelectionEventCallback): () => void {\r\n    this.subscribers.add(callback);\r\n    let active = true;\r\n\r\n    return () => {\r\n      if (!active) {\r\n        return;\r\n      }\r\n      active = false;\r\n      this.subscribers.delete(callback);\r\n    };\r\n  }\r\n\r\n  emit(event: PortSelectionEvent): void {\r\n    for (const callback of this.subscribers) {\r\n      try {\r\n        callback(event);\r\n      } catch (error) {\r\n        console.error(\"PortSelectionEventEmitter subscriber error\", error);\r\n      }\r\n    }\r\n  }\r\n\r\n  clear(): void {\r\n    this.subscribers.clear();\r\n  }\r\n\r\n  getSubscriberCount(): number {\r\n    return this.subscribers.size;\r\n  }\r\n}\r\n\r\nexport class DIPortSelectionEventEmitter extends PortSelectionEventEmitter {\r\n  static dependencies = [] as const;\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { MetricsRecorder } from \"./interfaces/metrics-recorder\";\r\nimport type { PortSelectionEvent } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\nimport { loggerToken, metricsRecorderToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Observable service interface.\r\n * Services implementing this can be registered for observability.\r\n */\r\nexport interface ObservableService<TEvent = unknown> {\r\n  onEvent(callback: (event: TEvent) => void): () => void;\r\n}\r\n\r\n/**\r\n * ObservabilityRegistry\r\n *\r\n * Central registry for self-registering observable services.\r\n * Routes events to appropriate observers based on event type.\r\n *\r\n * DESIGN: Services register themselves via constructor injection.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(observability: ObservabilityRegistry) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport class ObservabilityRegistry {\r\n  private readonly subscriptions: Array<() => void> = [];\r\n\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly metrics: MetricsRecorder\r\n  ) {}\r\n\r\n  /**\r\n   * Register a PortSelector for observability.\r\n   * Wires event emission to logging and metrics.\r\n   *\r\n   * @param service - Observable service that emits PortSelectionEvents\r\n   */\r\n  registerPortSelector(service: ObservableService<PortSelectionEvent>): void {\r\n    const unsubscribe = service.onEvent((event) => {\r\n      if (event.type === \"success\") {\r\n        const adapterSuffix = event.adapterName ? ` for ${event.adapterName}` : \"\";\r\n        this.logger.debug(\r\n          `Port v${event.selectedVersion} selected in ${event.durationMs.toFixed(2)}ms${adapterSuffix}`\r\n        );\r\n        this.metrics.recordPortSelection(event.selectedVersion);\r\n      } else {\r\n        this.logger.error(\"Port selection failed\", {\r\n          foundryVersion: event.foundryVersion,\r\n          availableVersions: event.availableVersions,\r\n          adapterName: event.adapterName,\r\n        });\r\n        this.metrics.recordPortSelectionFailure(event.foundryVersion);\r\n      }\r\n    });\r\n\r\n    this.subscriptions.push(unsubscribe);\r\n  }\r\n\r\n  /**\r\n   * Disposes all registered observers and clears internal state.\r\n   * Intended to be called when the DI container is disposed.\r\n   */\r\n  dispose(): void {\r\n    while (this.subscriptions.length > 0) {\r\n      const unsubscribe = this.subscriptions.pop();\r\n      try {\r\n        unsubscribe?.();\r\n      } catch {\r\n        // Swallow errors during dispose to avoid masking shutdown failures\r\n      }\r\n    }\r\n  }\r\n\r\n  // Future: Add more registration methods for other observable services\r\n  // registerSomeOtherService(service: ObservableService<OtherEvent>): void { ... }\r\n}\r\n\r\nexport class DIObservabilityRegistry extends ObservabilityRegistry {\r\n  static dependencies = [loggerToken, metricsRecorderToken] as const;\r\n\r\n  constructor(logger: Logger, metrics: MetricsRecorder) {\r\n    super(logger, metrics);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  portSelectionEventEmitterToken,\r\n  observabilityRegistryToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIPortSelectionEventEmitter } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\nimport { DIObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\n\r\n/**\r\n * Registers observability infrastructure.\r\n *\r\n * Services registered:\r\n * - PortSelectionEventEmitter (TRANSIENT - new instance per service)\r\n * - ObservabilityRegistry (SINGLETON - central registry)\r\n *\r\n * DESIGN PATTERN: Self-Registration\r\n * Services register themselves with ObservabilityRegistry in their constructor.\r\n * Example:\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(emitter: PortSelectionEventEmitter, observability: ObservabilityRegistry) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerObservability(container: ServiceContainer): Result<void, string> {\r\n  // Register PortSelectionEventEmitter as TRANSIENT\r\n  // Each service that needs event emission gets its own instance\r\n  const emitterResult = container.registerClass(\r\n    portSelectionEventEmitterToken,\r\n    DIPortSelectionEventEmitter,\r\n    ServiceLifecycle.TRANSIENT\r\n  );\r\n\r\n  if (isErr(emitterResult)) {\r\n    return err(`Failed to register PortSelectionEventEmitter: ${emitterResult.error.message}`);\r\n  }\r\n\r\n  // Register ObservabilityRegistry as SINGLETON\r\n  // Central registry for all observable services\r\n  const registryResult = container.registerClass(\r\n    observabilityRegistryToken,\r\n    DIObservabilityRegistry,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(registryResult)) {\r\n    return err(`Failed to register ObservabilityRegistry: ${registryResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * Version detection for Foundry VTT.\r\n * Extracts the major version number from Foundry's version string.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Cached version result to avoid repeated game.version access.\r\n * Improves performance when version is checked multiple times (e.g., during port selection).\r\n */\r\nlet cachedVersion: Result<number, string> | null = null;\r\n\r\n/**\r\n * Internal function to detect Foundry version without caching.\r\n * Called only once on first version check.\r\n */\r\nfunction detectFoundryVersion(): Result<number, string> {\r\n  if (typeof game === \"undefined\") {\r\n    return err(\"Foundry game object is not available or version cannot be determined\");\r\n  }\r\n\r\n  // game.version is typed as string by fvtt-types\r\n  // Format is \"{major}.{minor}\" (e.g., \"13.348\")\r\n  const versionString = game.version;\r\n  if (!versionString) {\r\n    return err(\"Foundry version is not available on the game object\");\r\n  }\r\n\r\n  const versionStr = versionString.match(/^(\\d+)/)?.[1];\r\n  if (!versionStr) {\r\n    return err(`Could not parse Foundry version from: ${versionString}`);\r\n  }\r\n\r\n  return ok(Number.parseInt(versionStr, 10));\r\n}\r\n\r\n/**\r\n * Gets the major version number of the currently running Foundry VTT instance.\r\n * Returns a Result for proper error handling.\r\n *\r\n * Performance: Version is cached after first detection to avoid repeated game.version access.\r\n *\r\n * @returns Result with major version number (e.g., 13 for \"13.348\") or error message\r\n *\r\n * @example\r\n * ```typescript\r\n * const versionResult = getFoundryVersionResult();\r\n * if (versionResult.ok) {\r\n *   console.log(`Foundry version: ${versionResult.value}`);\r\n * } else {\r\n *   console.error(`Version detection failed: ${versionResult.error}`);\r\n * }\r\n * ```\r\n */\r\nexport function getFoundryVersionResult(): Result<number, string> {\r\n  if (cachedVersion === null) {\r\n    cachedVersion = detectFoundryVersion();\r\n  }\r\n  return cachedVersion;\r\n}\r\n\r\n/**\r\n * Resets the version cache.\r\n *\r\n * @internal For testing purposes only.\r\n *\r\n * Should be called in test cleanup (afterEach) to ensure test isolation.\r\n * DO NOT use in production code - version detection is intentionally cached\r\n * for performance reasons.\r\n */\r\nexport function resetVersionCache(): void {\r\n  cachedVersion = null;\r\n}\r\n\r\n/**\r\n * Safely gets the Foundry version, returning undefined if it cannot be determined.\r\n * @returns The major version number or undefined if not available\r\n */\r\nexport function tryGetFoundryVersion(): number | undefined {\r\n  const result = getFoundryVersionResult();\r\n  return result.ok ? result.value : undefined;\r\n}\r\n","/**\r\n * Error codes for Foundry API operations.\r\n * Provides type-safe classification of Foundry-related errors.\r\n */\r\nexport type FoundryErrorCode =\r\n  | \"API_NOT_AVAILABLE\" // Foundry API (game, Hooks, etc.) not available\r\n  | \"VALIDATION_FAILED\" // Runtime validation failed\r\n  | \"NOT_FOUND\" // Entity not found by ID\r\n  | \"ACCESS_DENIED\" // Permission denied\r\n  | \"PORT_SELECTION_FAILED\" // Port selection/instantiation failed\r\n  | \"PORT_REGISTRY_ERROR\" // Port registry duplicate registration\r\n  | \"PORT_NOT_FOUND\" // No compatible port found for version\r\n  | \"DISPOSED\" // Port or service has been disposed\r\n  | \"OPERATION_FAILED\"; // General operation failure\r\n\r\n/**\r\n * Structured error for Foundry operations.\r\n * Provides detailed context for debugging and error handling.\r\n *\r\n * @example\r\n * ```typescript\r\n * const error: FoundryError = {\r\n *   code: \"API_NOT_AVAILABLE\",\r\n *   message: \"Foundry game API not available\",\r\n *   details: { api: \"game.journal\" }\r\n * };\r\n * ```\r\n */\r\nexport interface FoundryError {\r\n  /** Error code classifying the type of error */\r\n  code: FoundryErrorCode;\r\n\r\n  /** Human-readable error message */\r\n  message: string;\r\n\r\n  /** Optional additional context (IDs, names, etc.) */\r\n  details?: unknown;\r\n\r\n  /** Optional underlying error or exception that caused this error */\r\n  cause?: unknown;\r\n}\r\n\r\n/**\r\n * Factory for creating FoundryError instances.\r\n *\r\n * @param code - Error code\r\n * @param message - Error message\r\n * @param details - Optional additional context\r\n * @param cause - Optional underlying error\r\n * @returns FoundryError instance\r\n *\r\n * @example\r\n * ```typescript\r\n * const error = createFoundryError(\r\n *   \"NOT_FOUND\",\r\n *   \"Journal entry not found\",\r\n *   { journalId: \"abc123\" }\r\n * );\r\n * ```\r\n */\r\nexport function createFoundryError(\r\n  code: FoundryErrorCode,\r\n  message: string,\r\n  details?: unknown,\r\n  cause?: unknown\r\n): FoundryError {\r\n  return { code, message, details, cause };\r\n}\r\n\r\n/**\r\n * Type guard helper for error-like objects.\r\n */\r\ninterface ErrorLike {\r\n  code?: unknown;\r\n  message?: unknown;\r\n}\r\n\r\n/**\r\n * Checks if an object has error-like properties.\r\n */\r\nfunction isErrorLike(obj: unknown): obj is ErrorLike {\r\n  return typeof obj === \"object\" && obj !== null;\r\n}\r\n\r\n/**\r\n * Type guard to check if an error is a FoundryError.\r\n *\r\n * @param error - Error to check\r\n * @returns True if error is a FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * if (isFoundryError(error)) {\r\n *   console.log(error.code); // Type-safe access\r\n * }\r\n * ```\r\n */\r\nexport function isFoundryError(error: unknown): error is FoundryError {\r\n  if (!isErrorLike(error)) return false;\r\n\r\n  return (\r\n    \"code\" in error &&\r\n    \"message\" in error &&\r\n    typeof error.code === \"string\" &&\r\n    typeof error.message === \"string\"\r\n  );\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { err, ok } from \"@/infrastructure/shared/utils/result\";\r\nimport { getFoundryVersionResult } from \"./versiondetector\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { PortSelectionEventEmitter } from \"./port-selection-events\";\r\nimport type { PortSelectionEventCallback } from \"./port-selection-events\";\r\nimport type { ObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport {\r\n  portSelectionEventEmitterToken,\r\n  observabilityRegistryToken,\r\n  serviceContainerToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Selects the appropriate port implementation based on Foundry version.\r\n * Implements the logic:\r\n * - Foundry v13 → uses v13 ports\r\n * - Foundry v14 → uses v14 ports (if available), otherwise falls back to v13\r\n * - Never uses ports with version number higher than current Foundry version\r\n *\r\n * **Observability:**\r\n * - Emits events for success/failure via injected EventEmitter\r\n * - Self-registers with ObservabilityRegistry for automatic logging/metrics\r\n * - Conforms to DI architecture: EventEmitter as TRANSIENT service\r\n *\r\n * **Dependency Injection:**\r\n * - Resolves ports from the DI container using injection tokens\r\n * - Ensures DIP (Dependency Inversion Principle) compliance\r\n */\r\nexport class PortSelector {\r\n  constructor(\r\n    private readonly eventEmitter: PortSelectionEventEmitter,\r\n    observability: ObservabilityRegistry,\r\n    private readonly container: ServiceContainer\r\n  ) {\r\n    // Self-register for observability\r\n    observability.registerPortSelector(this);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to port selection events.\r\n   *\r\n   * Allows observers to be notified of port selection success/failure for\r\n   * logging, metrics, and other observability concerns.\r\n   *\r\n   * @param callback - Function to call when port selection events occur\r\n   * @returns Unsubscribe function\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const selector = new PortSelector();\r\n   * const unsubscribe = selector.onEvent((event) => {\r\n   *   if (event.type === 'success') {\r\n   *     console.log(`Port v${event.selectedVersion} selected`);\r\n   *   }\r\n   * });\r\n   * ```\r\n   */\r\n  onEvent(callback: PortSelectionEventCallback): () => void {\r\n    return this.eventEmitter.subscribe(callback);\r\n  }\r\n\r\n  /**\r\n   * Selects and resolves the appropriate port from injection tokens.\r\n   *\r\n   * CRITICAL: Works with token map to avoid eager instantiation.\r\n   * Only the selected token is resolved from the DI container, preventing crashes from\r\n   * incompatible constructors accessing unavailable APIs.\r\n   *\r\n   * @template T - The port type\r\n   * @param tokens - Map of version numbers to injection tokens\r\n   * @param foundryVersion - Optional version override (uses getFoundryVersion() if not provided)\r\n   * @param adapterName - Optional adapter name for observability\r\n   * @returns Result with resolved port or error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const tokens = new Map([\r\n   *   [13, foundryV13GamePortToken],\r\n   *   [14, foundryV14GamePortToken]\r\n   * ]);\r\n   * const selector = new PortSelector(eventEmitter, observability, container);\r\n   * const result = selector.selectPortFromTokens(tokens);\r\n   * // On Foundry v13: resolves only v13 port from container (v14 token never resolved)\r\n   * // On Foundry v14: resolves v14 port from container\r\n   * ```\r\n   */\r\n  selectPortFromTokens<T extends ServiceType>(\r\n    tokens: Map<number, InjectionToken<T>>,\r\n    foundryVersion?: number,\r\n    adapterName?: string\r\n  ): Result<T, FoundryError> {\r\n    // Inline performance tracking (no dependency on PerformanceTrackingService)\r\n    const startTime = performance.now();\r\n\r\n    // Use central version detection\r\n    let version: number;\r\n    if (foundryVersion !== undefined) {\r\n      version = foundryVersion;\r\n    } else {\r\n      const versionResult = getFoundryVersionResult();\r\n      if (!versionResult.ok) {\r\n        return err(\r\n          createFoundryError(\r\n            \"PORT_SELECTION_FAILED\",\r\n            \"Could not determine Foundry version\",\r\n            undefined,\r\n            versionResult.error\r\n          )\r\n        );\r\n      }\r\n      version = versionResult.value;\r\n    }\r\n\r\n    /**\r\n     * Version Matching Algorithm: Find highest compatible port\r\n     *\r\n     * Strategy: Greedy selection of the newest compatible port version\r\n     *\r\n     * Rules:\r\n     * 1. Never select a port with version > current Foundry version\r\n     *    (prevents using APIs that don't exist yet)\r\n     * 2. Select the highest port version that is <= Foundry version\r\n     *    (use the newest compatible implementation)\r\n     *\r\n     * Example Scenarios:\r\n     * - Foundry v13 + Ports [v12, v13, v14] → Select v13 (exact match)\r\n     * - Foundry v14 + Ports [v12, v13] → Select v13 (fallback to highest compatible)\r\n     * - Foundry v13 + Ports [v14, v15] → ERROR (no compatible port, all too new)\r\n     * - Foundry v20 + Ports [v13, v14] → Select v14 (future-proof fallback)\r\n     *\r\n     * Time Complexity: O(n) where n = number of registered ports\r\n     * Space Complexity: O(1)\r\n     *\r\n     * Note: This algorithm assumes ports are forward-compatible within reason.\r\n     * A v13 port should work on v14+ unless breaking API changes occur.\r\n     */\r\n    let selectedToken: InjectionToken<T> | undefined;\r\n    let selectedVersion: number = MODULE_CONSTANTS.DEFAULTS.NO_VERSION_SELECTED;\r\n\r\n    // Linear search for highest compatible version\r\n    // Could be optimized with sorted array + binary search, but n is typically small (2-5 ports)\r\n    for (const [portVersion, token] of tokens.entries()) {\r\n      // Rule 1: Skip ports newer than current Foundry version\r\n      // These ports may use APIs that don't exist yet → runtime crashes\r\n      if (portVersion > version) {\r\n        continue; // Incompatible (too new)\r\n      }\r\n\r\n      // Rule 2: Greedy selection - always prefer higher version numbers\r\n      // Track the highest compatible version seen so far\r\n      if (portVersion > selectedVersion) {\r\n        selectedVersion = portVersion;\r\n        selectedToken = token;\r\n      }\r\n    }\r\n\r\n    if (selectedToken === undefined) {\r\n      const availableVersions = Array.from(tokens.keys())\r\n        .sort((a, b) => a - b)\r\n        .join(\", \");\r\n\r\n      const error = createFoundryError(\r\n        \"PORT_SELECTION_FAILED\",\r\n        `No compatible port found for Foundry version ${version}`,\r\n        { version, availableVersions: availableVersions || \"none\" }\r\n      );\r\n\r\n      // Emit failure event for observability\r\n      this.eventEmitter.emit({\r\n        type: \"failure\",\r\n        foundryVersion: version,\r\n        availableVersions,\r\n        ...(adapterName !== undefined ? { adapterName } : {}),\r\n        error,\r\n      });\r\n\r\n      return err(error);\r\n    }\r\n\r\n    // CRITICAL: Only now resolve the selected port from the DI container\r\n    try {\r\n      const resolveResult = this.container.resolveWithError(selectedToken);\r\n      if (!resolveResult.ok) {\r\n        const foundryError = createFoundryError(\r\n          \"PORT_SELECTION_FAILED\",\r\n          `Failed to resolve port v${selectedVersion} from container`,\r\n          { selectedVersion },\r\n          resolveResult.error\r\n        );\r\n\r\n        // Emit failure event for observability\r\n        this.eventEmitter.emit({\r\n          type: \"failure\",\r\n          foundryVersion: version,\r\n          availableVersions: Array.from(tokens.keys())\r\n            .sort((a, b) => a - b)\r\n            .join(\", \"),\r\n          ...(adapterName !== undefined ? { adapterName } : {}),\r\n          error: foundryError,\r\n        });\r\n\r\n        return err(foundryError);\r\n      }\r\n\r\n      const port = resolveResult.value;\r\n      const durationMs = performance.now() - startTime;\r\n\r\n      // Emit success event for observability\r\n      this.eventEmitter.emit({\r\n        type: \"success\",\r\n        selectedVersion,\r\n        foundryVersion: version,\r\n        ...(adapterName !== undefined ? { adapterName } : {}),\r\n        durationMs,\r\n      });\r\n\r\n      return ok(port);\r\n    } catch (error) {\r\n      const foundryError = createFoundryError(\r\n        \"PORT_SELECTION_FAILED\",\r\n        `Failed to resolve port v${selectedVersion} from container`,\r\n        { selectedVersion },\r\n        error\r\n      );\r\n\r\n      // Emit failure event for observability\r\n      this.eventEmitter.emit({\r\n        type: \"failure\",\r\n        foundryVersion: version,\r\n        availableVersions: Array.from(tokens.keys())\r\n          .sort((a, b) => a - b)\r\n          .join(\", \"),\r\n        ...(adapterName !== undefined ? { adapterName } : {}),\r\n        error: foundryError,\r\n      });\r\n\r\n      return err(foundryError);\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIPortSelector extends PortSelector {\r\n  static dependencies = [\r\n    portSelectionEventEmitterToken,\r\n    observabilityRegistryToken,\r\n    serviceContainerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    eventEmitter: PortSelectionEventEmitter,\r\n    observability: ObservabilityRegistry,\r\n    container: ServiceContainer\r\n  ) {\r\n    super(eventEmitter, observability, container);\r\n  }\r\n}\r\n","/**\r\n * Registry for managing available port implementations across different Foundry versions.\r\n * Centralizes port registration and discovery.\r\n *\r\n * Ports are registered via DI container tokens, ensuring DIP (Dependency Inversion Principle)\r\n * compliance. PortSelector resolves ports from the container using these tokens.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  createFoundryError,\r\n  type FoundryError,\r\n} from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Registry that holds exactly one port injection token per version.\r\n * @template T - The port interface type\r\n */\r\nexport class PortRegistry<T extends ServiceType> {\r\n  // Exactly one token per version\r\n  private readonly tokens = new Map<number, InjectionToken<T>>();\r\n\r\n  /**\r\n   * Registers a port injection token for a specific Foundry version.\r\n   * @param version - The Foundry version this port supports\r\n   * @param token - Injection token for resolving the port from the DI container\r\n   * @returns Result indicating success or duplicate registration error\r\n   */\r\n  register(version: number, token: InjectionToken<T>): Result<void, FoundryError> {\r\n    if (this.tokens.has(version)) {\r\n      return err(\r\n        createFoundryError(\r\n          \"PORT_REGISTRY_ERROR\",\r\n          `Port for version ${version} already registered`,\r\n          { version }\r\n        )\r\n      );\r\n    }\r\n    this.tokens.set(version, token);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Gets all registered port versions.\r\n   * @returns Array of registered version numbers, sorted ascending\r\n   */\r\n  getAvailableVersions(): number[] {\r\n    return Array.from(this.tokens.keys()).sort((a, b) => a - b);\r\n  }\r\n\r\n  /**\r\n   * Gets the token map without resolving ports.\r\n   * Use with PortSelector.selectPortFromTokens() for safe lazy instantiation via DI.\r\n   *\r\n   * @returns Map of version numbers to injection tokens (NOT instances)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const registry = new PortRegistry<FoundryGame>();\r\n   * registry.register(13, foundryV13GamePortToken);\r\n   * registry.register(14, foundryGamePortV14Token);\r\n   *\r\n   * const tokens = registry.getTokens();\r\n   * const selector = new PortSelector(container);\r\n   * const result = selector.selectPortFromTokens(tokens);\r\n   * // Only compatible port is resolved from container\r\n   * ```\r\n   */\r\n  getTokens(): Map<number, InjectionToken<T>> {\r\n    return new Map(this.tokens);\r\n  }\r\n\r\n  /**\r\n   * Checks if a port is registered for a specific version.\r\n   * @param version - The version to check\r\n   * @returns True if a port is registered for this version\r\n   */\r\n  hasVersion(version: number): boolean {\r\n    return this.tokens.has(version);\r\n  }\r\n\r\n  /**\r\n   * Gets the highest registered port version.\r\n   * @returns The highest version number or undefined if no ports are registered\r\n   */\r\n  getHighestVersion(): number | undefined {\r\n    const versions = this.getAvailableVersions();\r\n    return versions.at(-1);\r\n  }\r\n}\r\n","import * as v from \"valibot\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\n\r\n/**\r\n * Type guard to check if value is string based on expectedType check.\r\n * Used after runtime type validation to narrow unknown to string.\r\n *\r\n * @param value - The value to check\r\n * @param expectedType - The expected type\r\n * @returns True if expectedType is \"string\" and value is actually a string\r\n */\r\nfunction isStringValue(value: unknown, expectedType: string): value is string {\r\n  return expectedType === \"string\" && typeof value === \"string\";\r\n}\r\n\r\n/**\r\n * Valibot schema for JournalEntry validation.\r\n * Validates that objects from Foundry API conform to expected structure.\r\n */\r\nexport const JournalEntrySchema = v.object({\r\n  id: v.string(),\r\n  name: v.optional(v.string()),\r\n  flags: v.optional(v.record(v.string(), v.unknown())),\r\n  getFlag: v.optional(\r\n    v.custom<(scope: string, key: string) => unknown>((val) => typeof val === \"function\")\r\n  ),\r\n  setFlag: v.optional(\r\n    v.custom<(scope: string, key: string, value: unknown) => Promise<unknown>>(\r\n      (val) => typeof val === \"function\"\r\n    )\r\n  ),\r\n});\r\n\r\n/**\r\n * Type for validated journal entries.\r\n */\r\nexport type ValidatedJournalEntry = v.InferOutput<typeof JournalEntrySchema>;\r\n\r\n/**\r\n * Validates an array of journal entries against the schema.\r\n *\r\n * @param entries - Array of unknown objects to validate\r\n * @returns Result with validated entries or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const entries = Array.from(game.journal.contents);\r\n * const result = validateJournalEntries(entries);\r\n * if (result.ok) {\r\n *   // entries are validated\r\n * }\r\n * ```\r\n */\r\nexport function validateJournalEntries(\r\n  entries: unknown[]\r\n): Result<ValidatedJournalEntry[], FoundryError> {\r\n  const result = v.safeParse(v.array(JournalEntrySchema), entries);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Journal entry validation failed\",\r\n        undefined,\r\n        result.issues\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n\r\n/**\r\n * Valibot schema for validating setting values based on their type.\r\n * Provides type-safe validation for Foundry settings.\r\n */\r\n\r\n/**\r\n * Validates a setting value against expected types and constraints.\r\n *\r\n * @param key - Setting key for error messages\r\n * @param value - Value to validate\r\n * @param expectedType - Expected type (string, number, boolean, or specific values)\r\n * @param choices - Optional array of allowed values\r\n * @returns Result with validated value or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * // Validate log level\r\n * const result = validateSettingValue(\"logLevel\", \"DEBUG\", \"string\", [\"DEBUG\", \"INFO\", \"WARN\", \"ERROR\"]);\r\n * if (result.ok) {\r\n *   // value is valid\r\n * }\r\n * ```\r\n */\r\nexport function validateSettingValue(\r\n  key: string,\r\n  value: unknown,\r\n  expectedType: \"string\" | \"number\" | \"boolean\",\r\n  choices?: readonly string[]\r\n): Result<unknown, FoundryError> {\r\n  // Type validation\r\n  if (expectedType === \"string\" && typeof value !== \"string\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected string, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  if (expectedType === \"number\" && typeof value !== \"number\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected number, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  if (expectedType === \"boolean\" && typeof value !== \"boolean\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected boolean, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  // Choice validation (only for strings)\r\n  if (choices && isStringValue(value, expectedType)) {\r\n    if (!choices.includes(value)) {\r\n      return err(\r\n        createFoundryError(\r\n          \"VALIDATION_FAILED\",\r\n          `Setting ${key}: Invalid value \"${value}\". Allowed: ${choices.join(\", \")}`,\r\n          { key, value, choices }\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  return ok(value);\r\n}\r\n\r\n/**\r\n * Valibot schema for Foundry setting configuration.\r\n * Validates the structure and types of setting registration config.\r\n */\r\nexport const SettingConfigSchema = v.object({\r\n  name: v.optional(v.string()),\r\n  hint: v.optional(v.string()),\r\n  scope: v.optional(v.picklist([\"world\", \"client\", \"user\"])),\r\n  config: v.optional(v.boolean()),\r\n  type: v.optional(v.any()), // typeof String, Number, Boolean - cannot validate constructors\r\n  default: v.optional(v.any()), // Default value depends on type\r\n  choices: v.optional(v.record(v.string(), v.string())), // Record keys must be string in TS\r\n  onChange: v.optional(v.custom<(value: unknown) => void>((val) => typeof val === \"function\")),\r\n});\r\n\r\n/**\r\n * Validates setting registration config using Valibot schema.\r\n *\r\n * @param namespace - Module namespace\r\n * @param key - Setting key\r\n * @param config - Setting configuration object\r\n * @returns Result with validated config or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateSettingConfig(\"my-module\", \"logLevel\", {\r\n *   name: \"Log Level\",\r\n *   scope: \"world\",\r\n *   config: true,\r\n *   type: Number,\r\n *   default: 1\r\n * });\r\n * ```\r\n */\r\nexport function validateSettingConfig(\r\n  namespace: string,\r\n  key: string,\r\n  config: unknown\r\n): Result<unknown, FoundryError> {\r\n  // Namespace validation\r\n  if (!namespace || typeof namespace !== \"string\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Invalid setting namespace: must be non-empty string\",\r\n        { namespace, key }\r\n      )\r\n    );\r\n  }\r\n\r\n  // Key validation\r\n  if (!key || typeof key !== \"string\") {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Invalid setting key: must be non-empty string\", {\r\n        namespace,\r\n        key,\r\n      })\r\n    );\r\n  }\r\n\r\n  // Config validation (must be object)\r\n  if (!config || typeof config !== \"object\") {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Invalid setting config: must be object\", {\r\n        namespace,\r\n        key,\r\n      })\r\n    );\r\n  }\r\n\r\n  // Validate config structure with Valibot\r\n  const result = v.safeParse(SettingConfigSchema, config);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting config validation failed for ${namespace}.${key}: ${result.issues.map((i) => i.message).join(\", \")}`,\r\n        { namespace, key, config, issues: result.issues }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n\r\n// Re-export SettingConfig type for convenience\r\nexport type { SettingConfig } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\n\r\n/**\r\n * Sanitizes a string for use in HTML/CSS selectors.\r\n * Removes all characters except alphanumeric, hyphens, and underscores.\r\n * Prevents CSS injection attacks.\r\n *\r\n * @param id - The ID to sanitize\r\n * @returns Sanitized ID safe for use in selectors\r\n *\r\n * @example\r\n * ```typescript\r\n * sanitizeId(\"journal-123\");  // \"journal-123\"\r\n * sanitizeId(\"../../../etc/passwd\");  // \"etcpasswd\"\r\n * sanitizeId(\"<script>alert('xss')</script>\");  // \"scriptalertxssscript\"\r\n * ```\r\n */\r\nexport function sanitizeId(id: string): string {\r\n  return id.replace(/[^a-zA-Z0-9-_]/g, \"\");\r\n}\r\n\r\n/**\r\n * Sanitizes a string for display in HTML.\r\n * Escapes HTML entities to prevent XSS attacks.\r\n *\r\n * @param text - The text to sanitize\r\n * @returns HTML-safe text\r\n *\r\n * @example\r\n * ```typescript\r\n * sanitizeHtml(\"<script>alert('xss')</script>\");\r\n * // \"&lt;script&gt;alert('xss')&lt;/script&gt;\"\r\n *\r\n * sanitizeHtml(\"Normal text\");\r\n * // \"Normal text\"\r\n * ```\r\n */\r\nexport function sanitizeHtml(text: string): string {\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Valibot schema for validating Foundry Application objects in hooks.\r\n * Validates minimal required properties for safe hook processing.\r\n */\r\nexport const FoundryApplicationSchema = v.object({\r\n  // Application should have a string ID\r\n  id: v.string(),\r\n  // Application should have object property (typed as record instead of any)\r\n  object: v.optional(v.record(v.string(), v.unknown())),\r\n  // Application should have options property\r\n  options: v.optional(v.record(v.string(), v.unknown())),\r\n});\r\n\r\n/**\r\n * Type for validated Foundry Application.\r\n */\r\nexport type ValidatedFoundryApplication = v.InferOutput<typeof FoundryApplicationSchema>;\r\n\r\n/**\r\n * Validates a hook app parameter.\r\n *\r\n * @param app - Unknown app object to validate\r\n * @returns Result with validated app or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateHookApp(app);\r\n * if (result.ok) {\r\n *   // app is validated and safe to use\r\n * }\r\n * ```\r\n */\r\nexport function validateHookApp(app: unknown): Result<ValidatedFoundryApplication, FoundryError> {\r\n  // Null/undefined check\r\n  if (app === null || app === undefined) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Hook app parameter is null or undefined\",\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  const result = v.safeParse(FoundryApplicationSchema, app);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Hook app parameter validation failed\",\r\n        undefined,\r\n        result.issues\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  createFoundryError,\r\n  type FoundryError,\r\n} from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { VALIDATION_CONSTRAINTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Validates a journal entry ID.\r\n *\r\n * Fast manual validation optimized for hot-path operations.\r\n * Validates format, length, and character constraints.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 100 characters (VALIDATION_CONSTRAINTS.MAX_ID_LENGTH)\r\n * - Only alphanumeric characters, hyphens, and underscores\r\n *\r\n * @param id - Journal entry ID to validate\r\n * @returns Result with validated ID or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateJournalId(\"journal-entry-123\");\r\n * if (result.ok) {\r\n *   // Safe to use result.value\r\n * }\r\n * ```\r\n */\r\nexport function validateJournalId(id: string): Result<string, FoundryError> {\r\n  if (id.length === 0) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"ID cannot be empty\"));\r\n  }\r\n\r\n  if (id.length > VALIDATION_CONSTRAINTS.MAX_ID_LENGTH) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `ID too long (max ${VALIDATION_CONSTRAINTS.MAX_ID_LENGTH} characters)`\r\n      )\r\n    );\r\n  }\r\n\r\n  if (!/^[a-zA-Z0-9-_]+$/.test(id)) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"ID contains invalid characters (allowed: a-z, A-Z, 0-9, -, _)\",\r\n        { id }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(id);\r\n}\r\n\r\n/**\r\n * Validates a journal entry name.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 255 characters\r\n *\r\n * @param name - Journal entry name to validate\r\n * @returns Result with validated name or FoundryError\r\n */\r\nexport function validateJournalName(name: string): Result<string, FoundryError> {\r\n  if (typeof name !== \"string\" || name.length === 0) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Name cannot be empty\"));\r\n  }\r\n\r\n  if (name.length > 255) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Name too long (max 255 characters)\"));\r\n  }\r\n\r\n  return ok(name);\r\n}\r\n\r\n/**\r\n * Validates a module flag key.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 100 characters (VALIDATION_CONSTRAINTS.MAX_ID_LENGTH)\r\n * - Only alphanumeric characters and underscores\r\n *\r\n * @param key - Flag key to validate\r\n * @returns Result with validated key or FoundryError\r\n */\r\nexport function validateFlagKey(key: string): Result<string, FoundryError> {\r\n  if (\r\n    typeof key !== \"string\" ||\r\n    key.length === 0 ||\r\n    key.length > VALIDATION_CONSTRAINTS.MAX_FLAG_KEY_LENGTH\r\n  ) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Invalid flag key length\"));\r\n  }\r\n\r\n  if (!/^[a-zA-Z0-9_]+$/.test(key)) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Invalid flag key format\"));\r\n  }\r\n\r\n  return ok(key);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryGame } from \"../../interfaces/FoundryGame\";\r\nimport type { FoundryJournalEntry } from \"../../types\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { tryCatch, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { validateJournalEntries } from \"../../validation/schemas\";\r\nimport { validateJournalId } from \"../../validation/input-validators\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * v13 implementation of FoundryGame interface.\r\n * Encapsulates Foundry v13-specific game API access.\r\n *\r\n * Performance optimization: Caches validated journal entries with TTL-based invalidation\r\n * to avoid expensive Valibot validation on every call. Cache expires after 5 seconds.\r\n */\r\nexport class FoundryV13GamePort implements FoundryGame {\r\n  #disposed = false;\r\n  private cachedEntries: FoundryJournalEntry[] | null = null;\r\n  private lastCheckTimestamp = 0;\r\n  private readonly cacheTtlMs = MODULE_CONSTANTS.DEFAULTS.CACHE_TTL_MS;\r\n\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot get journal entries on disposed port\"));\r\n    }\r\n    if (typeof game === \"undefined\" || !game?.journal) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry game API not available\"));\r\n    }\r\n\r\n    const now = Date.now();\r\n    const cacheAge = now - this.lastCheckTimestamp;\r\n\r\n    // Check TTL-based cache validity\r\n    if (this.cachedEntries !== null && cacheAge < this.cacheTtlMs) {\r\n      // Cache hit - return cached entries\r\n      return { ok: true, value: this.cachedEntries };\r\n    }\r\n\r\n    // Cache miss - fetch fresh entries\r\n\r\n    // game.journal is typed as DocumentCollection<JournalEntry> by fvtt-types\r\n    // DocumentCollection.contents is an array of the stored documents\r\n    const entries = tryCatch(\r\n      () => Array.from(game.journal.contents),\r\n      (error) =>\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to access journal entries\", undefined, error)\r\n    );\r\n\r\n    if (!entries.ok) {\r\n      return entries;\r\n    }\r\n\r\n    // Validate entries to ensure they have expected structure (expensive, cached for TTL duration)\r\n    // IMPORTANT: Use validation as guard only, keep original Foundry objects with prototypes\r\n    const validationResult = validateJournalEntries(entries.value);\r\n    if (!validationResult.ok) {\r\n      // Return validation error directly (preserves VALIDATION_FAILED code and details)\r\n      return validationResult;\r\n    }\r\n\r\n    // Update cache with ORIGINAL entries (preserving Foundry prototypes like sheet.render, update, etc.)\r\n    // Do NOT cache validationResult.value as it strips prototypes\r\n    this.cachedEntries = entries.value;\r\n    this.lastCheckTimestamp = now;\r\n\r\n    return { ok: true, value: this.cachedEntries };\r\n  }\r\n\r\n  /**\r\n   * Invalidates the journal entries cache.\r\n   * Forces the next getJournalEntries() call to fetch and validate fresh data.\r\n   */\r\n  invalidateCache(): void {\r\n    this.cachedEntries = null;\r\n    this.lastCheckTimestamp = 0;\r\n  }\r\n\r\n  getJournalEntryById(id: string): Result<FoundryJournalEntry | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot get journal entry on disposed port\"));\r\n    }\r\n    // Validate input\r\n    const validationResult = validateJournalId(id);\r\n    if (!validationResult.ok) {\r\n      return validationResult;\r\n    }\r\n\r\n    if (typeof game === \"undefined\" || !game?.journal) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry game API not available\"));\r\n    }\r\n\r\n    return tryCatch(\r\n      () => {\r\n        // game.journal.get() is typed by fvtt-types and returns JournalEntry | undefined\r\n        const entry = game.journal.get(validationResult.value);\r\n        return entry ?? null;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get journal entry by ID ${validationResult.value}`,\r\n          { id: validationResult.value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // Invalidate cache on disposal\r\n    this.cachedEntries = null;\r\n    this.lastCheckTimestamp = 0;\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHooks } from \"../../interfaces/FoundryHooks\";\r\nimport type { FoundryHookCallback } from \"../../types\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { tryCatch } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\n\r\n/**\r\n * Type-safe interface for Foundry Hooks with dynamic hook names.\r\n * Avoids 'any' while working around fvtt-types strict hook name typing.\r\n */\r\ninterface DynamicHooksApi {\r\n  on(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n  once(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n  off(hookName: string, callbackOrId: number | ((...args: unknown[]) => unknown)): void;\r\n}\r\n\r\n/**\r\n * v13 implementation of FoundryHooks interface.\r\n * Encapsulates Foundry v13-specific hook system access.\r\n *\r\n * Based on Foundry VTT v13 Hooks API:\r\n * https://foundryvtt.com/api/classes/foundry.helpers.Hooks.html\r\n */\r\nexport class FoundryV13HooksPort implements FoundryHooks {\r\n  #disposed = false;\r\n\r\n  on(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot register hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (typeof Hooks === \"undefined\") {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        // Type-safe cast for dynamic hook names\r\n        // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n        // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n        const hookId = (Hooks as DynamicHooksApi).on(hookName, callback);\r\n        return hookId;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  once(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot register one-time hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (typeof Hooks === \"undefined\") {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        // Type-safe cast for dynamic hook names\r\n        // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n        // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n        const hookId = (Hooks as DynamicHooksApi).once(hookName, callback);\r\n        return hookId;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register one-time hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  off(hookName: string, callbackOrId: FoundryHookCallback | number): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot unregister hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (typeof Hooks === \"undefined\") {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        // Type-safe cast for dynamic hook names\r\n        // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n        // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n        (Hooks as DynamicHooksApi).off(hookName, callbackOrId);\r\n        return undefined;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to unregister hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // Note: Hook cleanup is handled by FoundryHooksPort.dispose()\r\n    // Port remains stateless - it only wraps Foundry API\r\n  }\r\n}\r\n","/**\r\n * Type-Guard-Utilities for runtime type checking.\r\n *\r\n * These utilities provide safe runtime validation for objects and their properties/methods,\r\n * used by runtime cast functions to ensure type safety at runtime.\r\n */\r\n\r\n/**\r\n * Checks if an object has a method with the given name.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param methodName - The name of the method to check for\r\n * @returns True if the object has the method, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { dispose: () => {} };\r\n * if (hasMethod(obj, \"dispose\")) {\r\n *   obj.dispose(); // Type-safe\r\n * }\r\n * ```\r\n */\r\nexport function hasMethod(obj: unknown, methodName: string): boolean {\r\n  return (\r\n    obj !== null &&\r\n    obj !== undefined &&\r\n    typeof obj === \"object\" &&\r\n    methodName in obj &&\r\n    // type-coverage:ignore-next-line - Runtime type guard requires cast to check method type\r\n    typeof (obj as Record<string, unknown>)[methodName] === \"function\"\r\n  );\r\n}\r\n\r\n/**\r\n * Checks if an object has a property with the given name.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param propertyName - The name of the property to check for\r\n * @returns True if the object has the property, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { name: \"test\" };\r\n * if (hasProperty(obj, \"name\")) {\r\n *   console.log(obj.name); // Type-safe\r\n * }\r\n * ```\r\n */\r\nexport function hasProperty(obj: unknown, propertyName: string): boolean {\r\n  return obj !== null && obj !== undefined && typeof obj === \"object\" && propertyName in obj;\r\n}\r\n\r\n/**\r\n * Checks if an object has all the required methods.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param methodNames - Array of method names that must exist\r\n * @returns True if the object has all required methods, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { register: () => {}, get: () => {}, set: () => {} };\r\n * if (isObjectWithMethods(obj, [\"register\", \"get\", \"set\"])) {\r\n *   // obj has all required methods\r\n * }\r\n * ```\r\n */\r\nexport function isObjectWithMethods(obj: unknown, methodNames: string[]): boolean {\r\n  if (obj === null || obj === undefined || typeof obj !== \"object\") {\r\n    return false;\r\n  }\r\n\r\n  return methodNames.every((methodName) => hasMethod(obj, methodName));\r\n}\r\n","/**\r\n * Centralized helpers for Foundry-specific runtime casts that are required by\r\n * the Foundry adapter layer (ports, services, facades).\r\n *\r\n * Diese Datei ist absichtlich von der Type-Coverage ausgenommen, damit\r\n * wir an wenigen wohldokumentierten Stellen mit Runtime-Casts arbeiten\r\n * können, ohne den 100%-Anspruch für den restlichen Code zu verletzen.\r\n *\r\n * Diese Datei ist getrennt von `runtime-safe-cast.ts` (DI-Infrastruktur),\r\n * da sie Foundry-spezifische Casts enthält und FoundryError statt ContainerError\r\n * verwendet. Die Trennung ermöglicht klare Abhängigkeiten und verhindert\r\n * Import-Zyklen zwischen Foundry-Adapter und DI-Infrastruktur.\r\n */\r\n\r\nimport type { SettingConfig } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { isObjectWithMethods, hasMethod } from \"@/infrastructure/shared/utils/type-guards\";\r\n\r\n/**\r\n * Type-safe interface for Foundry Settings with dynamic namespaces.\r\n * Avoids 'any' while working around fvtt-types namespace restrictions.\r\n */\r\nexport interface DynamicSettingsApi {\r\n  register<T>(namespace: string, key: string, config: SettingConfig<T>): void;\r\n  get<T>(namespace: string, key: string): T;\r\n  set<T>(namespace: string, key: string, value: T): Promise<T>;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für `game.settings` mit dynamischen Namespaces.\r\n * Foundry's Settings API unterstützt Modul-Namespaces, aber fvtt-types\r\n * beschränkt den Namespace-Typ auf \"core\" nur.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Settings-Objekt die erforderlichen Methoden hat. Bei Fehlern wird\r\n * ein FoundryError zurückgegeben statt einen Error zu werfen, um konsistent\r\n * mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param settings - Das game.settings Objekt (unknown, da game global ist)\r\n * @returns Result mit dem Settings-Objekt als DynamicSettingsApi oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methoden `register`, `get` und `set`\r\n * vorhanden sind. Dies stellt sicher, dass das Settings-Objekt die erwartete\r\n * API-Struktur hat.\r\n */\r\nexport function castFoundrySettingsApi(\r\n  settings: unknown\r\n): Result<DynamicSettingsApi, FoundryError> {\r\n  if (!isObjectWithMethods(settings, [\"register\", \"get\", \"set\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"game.settings does not have required methods (register, get, set)\",\r\n        {\r\n          missingMethods: [\"register\", \"get\", \"set\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n  return ok(settings as DynamicSettingsApi);\r\n}\r\n\r\n/**\r\n * Type definition for documents with flag methods.\r\n */\r\ntype DocumentWithFlags = {\r\n  getFlag: (scope: string, key: string) => unknown;\r\n  setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n};\r\n\r\n/**\r\n * Type definition for documents with update method.\r\n * Generic type allows for specific return types.\r\n */\r\ntype DocumentWithUpdate<TDocument extends { id: string } = { id: string; name?: string | null }> = {\r\n  update: (changes: unknown) => Promise<TDocument>;\r\n};\r\n\r\n/**\r\n * Type definition for Foundry JournalEntry class constructor.\r\n */\r\ntype JournalEntryConstructor = {\r\n  create: (data: unknown) => Promise<{ id: string; name?: string | null }>;\r\n};\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für JournalEntry.getFlag mit modul-spezifischen Scopes.\r\n * fvtt-types JournalEntry.getFlag hat einen restriktiven Scope-Typ (\"core\" nur),\r\n * aber Modul-Flags verwenden die Modul-ID als Scope.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Dokument die erforderlichen Methoden `getFlag` und `setFlag` hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param document - Das Foundry-Dokument (unknown, da Typen variieren)\r\n * @returns Result mit dem Dokument mit getFlag/setFlag-Methoden oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methoden `getFlag` und `setFlag`\r\n * vorhanden sind. Dies stellt sicher, dass das Dokument die erwartete\r\n * API-Struktur für Flag-Operationen hat.\r\n *\r\n * @see {@link DynamicSettingsApi} Für ähnliche Cast-Funktionen mit Runtime-Validierung\r\n */\r\nexport function castFoundryDocumentForFlag(\r\n  document: unknown\r\n): Result<DocumentWithFlags, FoundryError> {\r\n  if (!isObjectWithMethods(document, [\"getFlag\", \"setFlag\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Document does not have required methods (getFlag, setFlag)\",\r\n        {\r\n          missingMethods: [\"getFlag\", \"setFlag\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n  return ok(document as DocumentWithFlags);\r\n}\r\n\r\n/**\r\n * Kapselt den Cast nach Runtime-Type-Check für FoundryError.\r\n * Wird verwendet, wenn bereits zur Laufzeit geprüft wurde, dass das Error-Objekt\r\n * die FoundryError-Struktur hat (code, message vorhanden).\r\n *\r\n * @param error - Das Error-Objekt (unknown, da es verschiedene Fehlerquellen gibt)\r\n * @returns Das Error als FoundryError gecastet\r\n */\r\nexport function castFoundryError(error: unknown): FoundryError {\r\n  return error as FoundryError;\r\n}\r\n\r\n/**\r\n * Kapselt den Cast für Disposable-Interface in FoundryServiceBase.\r\n * Ports sind als generischer ServiceType typisiert, aber zur Laufzeit\r\n * kann geprüft werden, ob sie das Disposable-Interface implementieren.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass der Port das `dispose`-Interface implementiert. Wenn nicht, wird `null`\r\n * zurückgegeben (analog zu `extractHtmlElement`), da dies ein optionales Feature ist.\r\n *\r\n * @param port - Der Port (unknown, da generischer ServiceType)\r\n * @returns Der Port als Disposable gecastet oder null, wenn nicht verfügbar\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob der Port eine `dispose`-Methode hat.\r\n * Dies ist konsistent mit anderen optionalen Type-Guards wie `extractHtmlElement`,\r\n * die ebenfalls `null` zurückgeben statt ein Result-Pattern zu verwenden.\r\n *\r\n * @see {@link extractHtmlElement} Für ähnliche optional Type-Guards mit null-Rückgabe\r\n */\r\nexport function castDisposablePort(port: unknown): Disposable | null {\r\n  if (!port || typeof port !== \"object\") {\r\n    return null;\r\n  }\r\n  if (hasMethod(port, \"dispose\")) {\r\n    return port as Disposable;\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Type-Guard für Non-Empty-Arrays mit Result-Pattern.\r\n * Stellt sicher, dass ein Array mindestens ein Element hat.\r\n * Ersetzt Non-Null-Assertions durch type-safe Guards.\r\n *\r\n * @template T - Der Element-Typ\r\n * @param arr - Das Array, das geprüft werden soll\r\n * @returns Result mit type-narrowed non-empty array oder FoundryError\r\n */\r\nexport function ensureNonEmptyArray<T>(arr: T[]): Result<[T, ...T[]], FoundryError> {\r\n  if (arr.length === 0) {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Array must not be empty\", { arrayLength: 0 })\r\n    );\r\n  }\r\n  return ok(arr as [T, ...T[]]);\r\n}\r\n\r\n/**\r\n * Extracts HTMLElement from hook argument.\r\n *\r\n * In Foundry VTT V13+, hooks receive native HTMLElement directly.\r\n * jQuery support has been deprecated and is no longer needed.\r\n *\r\n * @param html - The hook argument (unknown type)\r\n * @returns HTMLElement if the argument is an HTMLElement, null otherwise\r\n */\r\nexport function extractHtmlElement(html: unknown): HTMLElement | null {\r\n  return html instanceof HTMLElement ? html : null;\r\n}\r\n\r\n/**\r\n * Gets a factory from a Map or returns an error if not found.\r\n *\r\n * This is a defensive check: theoretically, if a version exists in the Map keys,\r\n * the factory should also exist. However, TypeScript's type system doesn't\r\n * guarantee this, so the check exists for type safety.\r\n *\r\n * @template T - The type that the factory creates\r\n * @param factories - Map of version numbers to factory functions\r\n * @param version - The version to look up\r\n * @returns Result with factory function or error\r\n */\r\nexport function getFactoryOrError<T>(\r\n  factories: Map<number, () => T>,\r\n  version: number\r\n): Result<() => T, FoundryError> {\r\n  const factory = factories.get(version);\r\n  if (!factory) {\r\n    return err(\r\n      createFoundryError(\"PORT_NOT_FOUND\", `Factory for version ${version} not found in registry`, {\r\n        version,\r\n      })\r\n    );\r\n  }\r\n  return ok(factory);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für Dokumente mit update-Methode.\r\n * Wird verwendet, wenn ein Dokument zur Laufzeit geprüft werden muss,\r\n * ob es eine update-Methode hat (z.B. als Fallback für unsetFlag).\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Dokument die erforderliche `update`-Methode hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param document - Das Foundry-Dokument (unknown, da Typen variieren)\r\n * @returns Result mit dem Dokument mit update-Methode oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methode `update` vorhanden ist.\r\n * Dies stellt sicher, dass das Dokument die erwartete API-Struktur für\r\n * Update-Operationen hat.\r\n *\r\n * @see {@link castFoundryDocumentForFlag} Für ähnliche Cast-Funktionen mit Runtime-Validierung\r\n */\r\nexport function castFoundryDocumentWithUpdate<\r\n  TDocument extends { id: string } = { id: string; name?: string | null },\r\n>(document: unknown): Result<DocumentWithUpdate<TDocument>, FoundryError> {\r\n  if (!isObjectWithMethods(document, [\"update\"])) {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Document does not have required method (update)\", {\r\n        missingMethods: [\"update\"],\r\n      })\r\n    );\r\n  }\r\n  // type-coverage:ignore-next-line - Runtime cast required for Foundry document update\r\n  return ok(document as DocumentWithUpdate<TDocument>);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für globalThis.JournalEntry.\r\n * Foundry VTT stellt JournalEntry als globale Klasse zur Verfügung,\r\n * aber TypeScript kann dies nicht statisch prüfen.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass JournalEntry vorhanden ist und die erforderliche `create`-Methode hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @returns Result mit JournalEntry-Konstruktor oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob JournalEntry im globalThis verfügbar ist\r\n * und die Methode `create` hat. Dies stellt sicher, dass die Foundry-API\r\n * korrekt geladen ist.\r\n */\r\nexport function castFoundryJournalEntryClass(): Result<JournalEntryConstructor, FoundryError> {\r\n  // Check if globalThis has JournalEntry property\r\n  if (typeof globalThis !== \"object\" || globalThis === null || !(\"JournalEntry\" in globalThis)) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"Foundry JournalEntry class not available in globalThis\",\r\n        {}\r\n      )\r\n    );\r\n  }\r\n\r\n  const journalEntryClass = (globalThis as Record<string, unknown>).JournalEntry;\r\n\r\n  if (!isObjectWithMethods(journalEntryClass, [\"create\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"Foundry JournalEntry class does not have required method (create)\",\r\n        {\r\n          missingMethods: [\"create\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(journalEntryClass as JournalEntryConstructor);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryDocument } from \"../../interfaces/FoundryDocument\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { fromPromise, tryCatch, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { castFoundryError, castFoundryDocumentWithUpdate } from \"../../runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * v13 implementation of FoundryDocument interface.\r\n * Encapsulates Foundry v13-specific document operations.\r\n */\r\nexport class FoundryV13DocumentPort implements FoundryDocument {\r\n  #disposed = false;\r\n\r\n  async create<TDocument extends { id: string }>(\r\n    documentClass: { create: (data: unknown) => Promise<TDocument> },\r\n    data: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot create document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<TDocument, FoundryError>(documentClass.create(data), (error) =>\r\n      createFoundryError(\"OPERATION_FAILED\", \"Failed to create document\", { data }, error)\r\n    );\r\n  }\r\n\r\n  async update<TDocument extends { id: string }>(\r\n    document: { update: (changes: unknown) => Promise<TDocument> },\r\n    changes: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot update document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<TDocument, FoundryError>(document.update(changes), (error) =>\r\n      createFoundryError(\"OPERATION_FAILED\", \"Failed to update document\", { changes }, error)\r\n    );\r\n  }\r\n\r\n  async delete(document: { delete: () => Promise<unknown> }): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot delete document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<void, FoundryError>(\r\n      document.delete().then(() => undefined),\r\n      (error) =>\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to delete document\", undefined, error)\r\n    );\r\n  }\r\n\r\n  getFlag<T>(\r\n    document: { getFlag: (scope: string, key: string) => unknown },\r\n    scope: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot get flag on disposed port\", { scope, key }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (!document?.getFlag) {\r\n          throw new Error(\"Document does not have getFlag method\");\r\n        }\r\n\r\n        const rawValue = document.getFlag(scope, key);\r\n\r\n        // Handle null/undefined as valid \"not set\" state\r\n        if (rawValue === null || rawValue === undefined) {\r\n          return null;\r\n        }\r\n\r\n        // Runtime validation with Valibot\r\n        const parseResult = v.safeParse(schema, rawValue);\r\n\r\n        if (!parseResult.success) {\r\n          const error = createFoundryError(\r\n            \"VALIDATION_FAILED\",\r\n            `Flag ${scope}.${key} failed validation: ${parseResult.issues.map((i) => i.message).join(\", \")}`,\r\n            { scope, key, rawValue, issues: parseResult.issues }\r\n          );\r\n          throw error;\r\n        }\r\n\r\n        return parseResult.output;\r\n      },\r\n      (error) => {\r\n        // Check if it's already a FoundryError (from validation)\r\n        if (error && typeof error === \"object\" && \"code\" in error && \"message\" in error) {\r\n          return castFoundryError(error);\r\n        }\r\n        // Otherwise wrap as OPERATION_FAILED\r\n        return createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get flag ${scope}.${key}`,\r\n          { scope, key },\r\n          error\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  async setFlag<T = unknown>(\r\n    document: { setFlag: (scope: string, key: string, value: T) => Promise<unknown> },\r\n    scope: string,\r\n    key: string,\r\n    value: T\r\n  ): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot set flag on disposed port\", { scope, key }),\r\n      };\r\n    }\r\n    return fromPromise<void, FoundryError>(\r\n      (async () => {\r\n        if (!document?.setFlag) {\r\n          throw new Error(\"Document does not have setFlag method\");\r\n        }\r\n        await document.setFlag(scope, key, value);\r\n      })(),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to set flag ${scope}.${key}`,\r\n          { scope, key, value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  async unsetFlag(\r\n    document: {\r\n      unsetFlag?: (scope: string, key: string) => Promise<unknown>;\r\n      setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n    },\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot unset flag on disposed port\", { scope, key })\r\n      );\r\n    }\r\n\r\n    return fromPromise<void, FoundryError>(\r\n      (async () => {\r\n        // Use unsetFlag if available (recommended)\r\n        if (document.unsetFlag) {\r\n          await document.unsetFlag(scope, key);\r\n        } else {\r\n          // Fallback: Use update with \"-=\" syntax\r\n          // Document must have update method for fallback\r\n          const docWithUpdateResult = castFoundryDocumentWithUpdate(document);\r\n          if (!docWithUpdateResult.ok) {\r\n            throw new Error(\r\n              `Document does not support unsetFlag or update: ${docWithUpdateResult.error.message}`\r\n            );\r\n          }\r\n          await docWithUpdateResult.value.update({\r\n            [`flags.${scope}.-=${key}`]: null,\r\n          });\r\n        }\r\n      })(),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to unset flag ${scope}.${key}`,\r\n          { scope, key },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryUI, FoundryNotificationOptions } from \"../../interfaces/FoundryUI\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { sanitizeId } from \"../../validation/schemas\";\r\n\r\n/**\r\n * Type definition for Foundry's ui.sidebar structure\r\n */\r\ninterface FoundryUISidebar {\r\n  tabs?: {\r\n    journal?: {\r\n      render?: (force: boolean) => void;\r\n    };\r\n  };\r\n}\r\n\r\n/**\r\n * Type guard to check if sidebar has the expected structure\r\n */\r\nfunction isFoundryUISidebar(sidebar: unknown): sidebar is FoundryUISidebar {\r\n  // Since tabs is optional, we only need to verify it's an object\r\n  // and not null/undefined. The actual structure validation happens\r\n  // when accessing nested properties.\r\n  return typeof sidebar === \"object\" && sidebar !== null;\r\n}\r\n\r\n/**\r\n * v13 implementation of FoundryUI interface.\r\n * Encapsulates Foundry v13-specific UI manipulation.\r\n */\r\nexport class FoundryV13UIPort implements FoundryUI {\r\n  #disposed = false;\r\n\r\n  removeJournalElement(\r\n    journalId: string,\r\n    journalName: string,\r\n    html: HTMLElement\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot remove journal element on disposed port\"));\r\n    }\r\n    // Sanitize ID to prevent CSS injection\r\n    const safeId = sanitizeId(journalId);\r\n\r\n    // Support both selectors: Foundry v13 uses data-document-id, older versions used data-entry-id\r\n    const element = html.querySelector(\r\n      `li.directory-item[data-document-id=\"${safeId}\"], li.directory-item[data-entry-id=\"${safeId}\"]`\r\n    ) as HTMLElement | null;\r\n\r\n    if (!element) {\r\n      return err(\r\n        createFoundryError(\r\n          \"NOT_FOUND\",\r\n          `Could not find element for journal entry: ${journalName}`,\r\n          { journalName, journalId: safeId }\r\n        )\r\n      );\r\n    }\r\n\r\n    try {\r\n      element.remove();\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          \"Failed to remove element from DOM\",\r\n          { journalName, journalId: safeId },\r\n          error\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  findElement(container: HTMLElement, selector: string): Result<HTMLElement | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot find element on disposed port\"));\r\n    }\r\n    const element = container.querySelector(selector) as HTMLElement | null;\r\n    return ok(element);\r\n  }\r\n\r\n  notify(\r\n    message: string,\r\n    type: \"info\" | \"warning\" | \"error\",\r\n    options?: FoundryNotificationOptions\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot show notification on disposed port\"));\r\n    }\r\n    if (typeof ui === \"undefined\" || !ui?.notifications) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry UI notifications not available\"));\r\n    }\r\n\r\n    try {\r\n      switch (type) {\r\n        case \"info\":\r\n          ui.notifications.info(message, options);\r\n          break;\r\n        case \"warning\":\r\n          ui.notifications.warn(message, options);\r\n          break;\r\n        case \"error\":\r\n          ui.notifications.error(message, options);\r\n          break;\r\n      }\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          \"Failed to show notification\",\r\n          { message, type },\r\n          error\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot rerender journal directory on disposed port\")\r\n      );\r\n    }\r\n\r\n    try {\r\n      const journalElement = document.querySelector(\"#journal\");\r\n      if (!journalElement) {\r\n        return ok(false);\r\n      }\r\n\r\n      if (typeof ui === \"undefined\" || !ui?.sidebar) {\r\n        return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry UI sidebar not available\"));\r\n      }\r\n\r\n      if (!isFoundryUISidebar(ui.sidebar)) {\r\n        return err(\r\n          createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry UI sidebar has unexpected structure\")\r\n        );\r\n      }\r\n\r\n      const sidebar = ui.sidebar;\r\n      const journalApp = sidebar.tabs?.journal;\r\n\r\n      let rendered = false;\r\n\r\n      // Versuche zuerst journalApp.render(), falls verfügbar\r\n      if (journalApp && typeof journalApp.render === \"function\") {\r\n        journalApp.render(false);\r\n        rendered = true;\r\n      }\r\n\r\n      // Fallback: Direktes Directory-Render (wie im funktionierenden Script)\r\n      // Das funktioniert auch, wenn journalApp nicht verfügbar ist (z.B. wenn Context-Menü geöffnet ist)\r\n      if (typeof game !== \"undefined\" && game.journal?.directory?.render) {\r\n        game.journal.directory.render();\r\n        rendered = true;\r\n      }\r\n\r\n      return ok(rendered);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to re-render journal directory\", {}, error)\r\n      );\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundrySettings, SettingConfig } from \"../../interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { tryCatch, err, fromPromise } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { validateSettingConfig } from \"../../validation/schemas\";\r\nimport { castFoundrySettingsApi, castFoundryError } from \"../../runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * v13 implementation of FoundrySettings interface.\r\n * Encapsulates Foundry v13-specific settings API access.\r\n *\r\n * Supports all three setting scopes:\r\n * - world: Shared across all users in the world\r\n * - client: Browser/device-specific\r\n * - user: User-specific within a world (new in v13)\r\n */\r\nexport class FoundryV13SettingsPort implements FoundrySettings {\r\n  #disposed = false;\r\n\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: SettingConfig<T>\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot register setting on disposed port\", {\r\n          namespace,\r\n          key,\r\n        })\r\n      );\r\n    }\r\n    // Validate config before attempting registration\r\n    const configValidation = validateSettingConfig(namespace, key, config);\r\n    if (!configValidation.ok) {\r\n      return err(configValidation.error);\r\n    }\r\n\r\n    if (typeof game === \"undefined\" || !game?.settings) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    const settingsResult = castFoundrySettingsApi(game.settings);\r\n    if (!settingsResult.ok) {\r\n      return settingsResult; // Propagate error\r\n    }\r\n    const settings = settingsResult.value;\r\n\r\n    return tryCatch(\r\n      () => {\r\n        settings.register(namespace, key, config);\r\n        return undefined;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register setting ${namespace}.${key}`,\r\n          { namespace, key },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  get<T>(\r\n    namespace: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot get setting on disposed port\", { namespace, key })\r\n      );\r\n    }\r\n    if (typeof game === \"undefined\" || !game?.settings) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    const settingsResult = castFoundrySettingsApi(game.settings);\r\n    if (!settingsResult.ok) {\r\n      return settingsResult; // Propagate error\r\n    }\r\n    const settings = settingsResult.value;\r\n\r\n    return tryCatch(\r\n      () => {\r\n        const rawValue = settings.get(namespace, key);\r\n\r\n        // Runtime validation with Valibot\r\n        const parseResult = v.safeParse(schema, rawValue);\r\n\r\n        if (!parseResult.success) {\r\n          const error = createFoundryError(\r\n            \"VALIDATION_FAILED\",\r\n            `Setting ${namespace}.${key} failed validation: ${parseResult.issues.map((i) => i.message).join(\", \")}`,\r\n            { namespace, key, rawValue, issues: parseResult.issues }\r\n          );\r\n          throw error;\r\n        }\r\n\r\n        return parseResult.output;\r\n      },\r\n      (error) => {\r\n        // Check if it's already a FoundryError (from validation)\r\n        if (error && typeof error === \"object\" && \"code\" in error && \"message\" in error) {\r\n          return castFoundryError(error);\r\n        }\r\n        // Otherwise wrap as OPERATION_FAILED\r\n        return createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get setting ${namespace}.${key}`,\r\n          { namespace, key },\r\n          error\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot set setting on disposed port\", { namespace, key })\r\n      );\r\n    }\r\n    if (typeof game === \"undefined\" || !game?.settings) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    const settingsResult = castFoundrySettingsApi(game.settings);\r\n    if (!settingsResult.ok) {\r\n      return Promise.resolve(settingsResult); // Propagate error\r\n    }\r\n    const settings = settingsResult.value;\r\n\r\n    return fromPromise(\r\n      settings.set(namespace, key, value).then(() => undefined),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to set setting ${namespace}.${key}`,\r\n          { namespace, key, value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryI18n } from \"../../interfaces/FoundryI18n\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { ok } from \"@/infrastructure/shared/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\n\r\n/**\r\n * Foundry VTT v13+ implementation of the i18n interface.\r\n *\r\n * Wraps `game.i18n` API with Result pattern for type-safe error handling.\r\n *\r\n * @implements {FoundryI18n}\r\n */\r\nexport class FoundryV13I18nPort implements FoundryI18n {\r\n  #disposed = false;\r\n  static dependencies = [] as const;\r\n\r\n  /**\r\n   * Localizes a translation key using Foundry's i18n system.\r\n   *\r\n   * @param key - Translation key\r\n   * @returns Result with translated string (returns key itself if not found)\r\n   */\r\n  localize(key: string): Result<string, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot localize on disposed port\", { key }),\r\n      };\r\n    }\r\n    try {\r\n      if (typeof game === \"undefined\" || !game?.i18n) {\r\n        return ok(key); // Graceful degradation: return key as-is\r\n      }\r\n\r\n      const translated = game.i18n.localize(key);\r\n      return ok(translated);\r\n    } catch {\r\n      return ok(key); // Fallback: return key on error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formats a translation key with placeholder values.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @returns Result with formatted string\r\n   */\r\n  format(key: string, data: Record<string, unknown>): Result<string, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot format translation on disposed port\", {\r\n          key,\r\n        }),\r\n      };\r\n    }\r\n    try {\r\n      if (typeof game === \"undefined\" || !game?.i18n) {\r\n        return ok(key); // Graceful degradation\r\n      }\r\n\r\n      // Convert unknown values to strings for Foundry's type requirements\r\n      const stringData: Record<string, string> = {};\r\n      for (const [k, v] of Object.entries(data)) {\r\n        stringData[k] = String(v);\r\n      }\r\n\r\n      const formatted = game.i18n.format(key, stringData);\r\n      return ok(formatted);\r\n    } catch {\r\n      return ok(key); // Fallback: return key on error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with boolean indicating existence\r\n   */\r\n  has(key: string): Result<boolean, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot check translation key on disposed port\", {\r\n          key,\r\n        }),\r\n      };\r\n    }\r\n    try {\r\n      if (typeof game === \"undefined\" || !game?.i18n) {\r\n        return ok(false); // No game.i18n available → key doesn't exist\r\n      }\r\n\r\n      const exists = game.i18n.has(key);\r\n      return ok(exists);\r\n    } catch {\r\n      return ok(false); // Fallback: assume key doesn't exist on error\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n","/**\r\n * Port registration for Foundry VTT v13.\r\n * This file is part of the \"Concrete Platform Concrete Version\" layer.\r\n * It registers all v13 port implementations into the DI container and their respective registries.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryV13GamePort } from \"./FoundryV13GamePort\";\r\nimport { FoundryV13HooksPort } from \"./FoundryV13HooksPort\";\r\nimport { FoundryV13DocumentPort } from \"./FoundryV13DocumentPort\";\r\nimport { FoundryV13UIPort } from \"./FoundryV13UIPort\";\r\nimport { FoundryV13SettingsPort } from \"./FoundryV13SettingsPort\";\r\nimport { FoundryV13I18nPort } from \"./FoundryV13I18nPort\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  foundryV13GamePortToken,\r\n  foundryV13HooksPortToken,\r\n  foundryV13DocumentPortToken,\r\n  foundryV13UIPortToken,\r\n  foundryV13SettingsPortToken,\r\n  foundryV13I18nPortToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\n\r\n/**\r\n * Helper function for port registration.\r\n * Reduces duplication when registering multiple ports.\r\n */\r\nfunction registerPortToRegistry<T extends ServiceType>(\r\n  registry: PortRegistry<T>,\r\n  version: number,\r\n  token: InjectionToken<T>,\r\n  portName: string,\r\n  errors: string[]\r\n): void {\r\n  const result = registry.register(version, token);\r\n  if (isErr(result)) {\r\n    errors.push(`${portName} v${version}: ${result.error}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Registers all v13 port implementations into the DI container and their respective registries.\r\n *\r\n * This function is called from the version-agnostic config layer to populate\r\n * port registries with v13-specific implementations. Ports are registered in the\r\n * DI container first, then their tokens are stored in the registries for later resolution.\r\n *\r\n * @param registries - Object containing all port registries to populate\r\n * @param container - Service container for dependency injection\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerV13Ports(\r\n  registries: {\r\n    gamePortRegistry: PortRegistry<FoundryGame>;\r\n    hooksPortRegistry: PortRegistry<FoundryHooks>;\r\n    documentPortRegistry: PortRegistry<FoundryDocument>;\r\n    uiPortRegistry: PortRegistry<FoundryUI>;\r\n    settingsPortRegistry: PortRegistry<FoundrySettings>;\r\n    i18nPortRegistry: PortRegistry<FoundryI18n>;\r\n  },\r\n  container: ServiceContainer\r\n): Result<void, string> {\r\n  const portRegistrationErrors: string[] = [];\r\n\r\n  // Register all v13 port classes with the DI container (VOR PortRegistry-Registrierungen)\r\n  container.registerClass(foundryV13GamePortToken, FoundryV13GamePort, ServiceLifecycle.SINGLETON);\r\n  container.registerClass(\r\n    foundryV13HooksPortToken,\r\n    FoundryV13HooksPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  container.registerClass(\r\n    foundryV13DocumentPortToken,\r\n    FoundryV13DocumentPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  container.registerClass(foundryV13UIPortToken, FoundryV13UIPort, ServiceLifecycle.SINGLETON);\r\n  container.registerClass(\r\n    foundryV13SettingsPortToken,\r\n    FoundryV13SettingsPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  container.registerClass(foundryV13I18nPortToken, FoundryV13I18nPort, ServiceLifecycle.SINGLETON);\r\n\r\n  // Register FoundryGame port token in registry\r\n  registerPortToRegistry(\r\n    registries.gamePortRegistry,\r\n    13,\r\n    foundryV13GamePortToken,\r\n    \"FoundryGame\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryHooks port token in registry\r\n  registerPortToRegistry(\r\n    registries.hooksPortRegistry,\r\n    13,\r\n    foundryV13HooksPortToken,\r\n    \"FoundryHooks\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryDocument port token in registry\r\n  registerPortToRegistry(\r\n    registries.documentPortRegistry,\r\n    13,\r\n    foundryV13DocumentPortToken,\r\n    \"FoundryDocument\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryUI port token in registry\r\n  registerPortToRegistry(\r\n    registries.uiPortRegistry,\r\n    13,\r\n    foundryV13UIPortToken,\r\n    \"FoundryUI\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundrySettings port token in registry\r\n  registerPortToRegistry(\r\n    registries.settingsPortRegistry,\r\n    13,\r\n    foundryV13SettingsPortToken,\r\n    \"FoundrySettings\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryI18n port token in registry\r\n  registerPortToRegistry(\r\n    registries.i18nPortRegistry,\r\n    13,\r\n    foundryV13I18nPortToken,\r\n    \"FoundryI18n\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Check for registration errors\r\n  if (portRegistrationErrors.length > 0) {\r\n    return err(`Port registration failed: ${portRegistrationErrors.join(\"; \")}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformUIPort, PlatformUIError } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformUIPort.\r\n *\r\n * Adapts FoundryUI (Foundry-specific) to PlatformUIPort (platform-agnostic).\r\n * This allows domain/application layers to depend only on PlatformUIPort.\r\n */\r\nexport class FoundryUIAdapter implements PlatformUIPort {\r\n  constructor(private readonly foundryUI: FoundryUI) {}\r\n\r\n  removeJournalElement(\r\n    journalId: string,\r\n    journalName: string,\r\n    html: HTMLElement\r\n  ): Result<void, PlatformUIError> {\r\n    const result = this.foundryUI.removeJournalElement(journalId, journalName, html);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"DOM_MANIPULATION_FAILED\",\r\n        message: `Failed to remove journal element '${journalName}' (${journalId}): ${result.error.message}`,\r\n        operation: \"removeJournalElement\",\r\n        details: { journalId, journalName, cause: result.error },\r\n      });\r\n    }\r\n    return ok(undefined);\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, PlatformUIError> {\r\n    const result = this.foundryUI.rerenderJournalDirectory();\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"RERENDER_FAILED\",\r\n        message: `Failed to re-render journal directory: ${result.error.message}`,\r\n        operation: \"rerenderJournalDirectory\",\r\n        details: { cause: result.error },\r\n      });\r\n    }\r\n    return ok(result.value);\r\n  }\r\n\r\n  notify(message: string, type: \"info\" | \"warning\" | \"error\"): Result<void, PlatformUIError> {\r\n    const result = this.foundryUI.notify(message, type);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: result.error.code,\r\n        message: result.error.message,\r\n        operation: \"notify\",\r\n        details: { cause: result.error },\r\n      });\r\n    }\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryUIAdapter.\r\n */\r\nexport class DIFoundryUIAdapter extends FoundryUIAdapter {\r\n  static dependencies = [foundryUIToken] as const;\r\n\r\n  constructor(foundryUI: FoundryUI) {\r\n    super(foundryUI);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryGamePortRegistryToken,\r\n  foundryHooksPortRegistryToken,\r\n  foundryDocumentPortRegistryToken,\r\n  foundryUIPortRegistryToken,\r\n  foundrySettingsPortRegistryToken,\r\n  foundryI18nPortRegistryToken,\r\n  platformUIPortToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIPortSelector } from \"@/infrastructure/adapters/foundry/versioning/portselector\";\r\nimport { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport { registerV13Ports } from \"@/infrastructure/adapters/foundry/ports/v13/port-registration\";\r\nimport { DIFoundryUIAdapter } from \"@/infrastructure/adapters/foundry/adapters/foundry-ui-adapter\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\n\r\n/**\r\n * Creates and registers all port implementations to their respective registries.\r\n * Returns the populated registries for container registration.\r\n *\r\n * This function is version-agnostic and delegates to version-specific registration\r\n * functions (e.g., registerV13Ports) to populate the registries.\r\n *\r\n * @param container - Service container for dependency injection (passed to port registration functions)\r\n */\r\nfunction createPortRegistries(container: ServiceContainer): Result<\r\n  {\r\n    gamePortRegistry: PortRegistry<FoundryGame>;\r\n    hooksPortRegistry: PortRegistry<FoundryHooks>;\r\n    documentPortRegistry: PortRegistry<FoundryDocument>;\r\n    uiPortRegistry: PortRegistry<FoundryUI>;\r\n    settingsPortRegistry: PortRegistry<FoundrySettings>;\r\n    i18nPortRegistry: PortRegistry<FoundryI18n>;\r\n  },\r\n  string\r\n> {\r\n  // Create empty port registries\r\n  const gamePortRegistry = new PortRegistry<FoundryGame>();\r\n  const hooksPortRegistry = new PortRegistry<FoundryHooks>();\r\n  const documentPortRegistry = new PortRegistry<FoundryDocument>();\r\n  const uiPortRegistry = new PortRegistry<FoundryUI>();\r\n  const settingsPortRegistry = new PortRegistry<FoundrySettings>();\r\n  const i18nPortRegistry = new PortRegistry<FoundryI18n>();\r\n\r\n  // Register v13 ports (version-specific registration is delegated to v13 layer)\r\n  // Container is passed to allow future ports to use DI, even though current v13 ports don't need it\r\n  const v13RegistrationResult = registerV13Ports(\r\n    {\r\n      gamePortRegistry,\r\n      hooksPortRegistry,\r\n      documentPortRegistry,\r\n      uiPortRegistry,\r\n      settingsPortRegistry,\r\n      i18nPortRegistry,\r\n    },\r\n    container\r\n  );\r\n\r\n  if (isErr(v13RegistrationResult)) {\r\n    return v13RegistrationResult;\r\n  }\r\n\r\n  // Future: Add calls to registerV14Ports(), registerV15Ports(), etc. here\r\n  // Each version registers itself into the same registries\r\n\r\n  return ok({\r\n    gamePortRegistry,\r\n    hooksPortRegistry,\r\n    documentPortRegistry,\r\n    uiPortRegistry,\r\n    settingsPortRegistry,\r\n    i18nPortRegistry,\r\n  });\r\n}\r\n\r\n/**\r\n * Registers port infrastructure root services.\r\n *\r\n * Services registered:\r\n * - PortSelector (singleton, with EventEmitter, ObservabilityRegistry, and ServiceContainer dependencies)\r\n * - PlatformUIPort (singleton, via FoundryUIAdapter)\r\n *\r\n * OBSERVABILITY: PortSelector self-registers with ObservabilityRegistry for automatic\r\n * event observation (logging/metrics). No manual wiring needed.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerPortInfrastructure(container: ServiceContainer): Result<void, string> {\r\n  // Register PortSelector\r\n  // Dependencies: [portSelectionEventEmitterToken, observabilityRegistryToken, serviceContainerToken]\r\n  const portSelectorResult = container.registerClass(\r\n    portSelectorToken,\r\n    DIPortSelector,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(portSelectorResult)) {\r\n    return err(`Failed to register PortSelector: ${portSelectorResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformUIPort (Foundry implementation via adapter)\r\n  const platformUIPortResult = container.registerClass(\r\n    platformUIPortToken,\r\n    DIFoundryUIAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(platformUIPortResult)) {\r\n    return err(`Failed to register PlatformUIPort: ${platformUIPortResult.error.message}`);\r\n  }\r\n\r\n  // Note: Observability handled via self-registration pattern\r\n  // PortSelector registers itself at ObservabilityRegistry in constructor\r\n  // No manual wiring needed here\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers Foundry port registries (sub-container values).\r\n *\r\n * Each registry is pre-populated with versioned factories and stored as a singleton value.\r\n *\r\n * @param container - The service container to register registries in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerPortRegistries(container: ServiceContainer): Result<void, string> {\r\n  const portsResult = createPortRegistries(container);\r\n  if (isErr(portsResult)) return portsResult;\r\n\r\n  const {\r\n    gamePortRegistry,\r\n    hooksPortRegistry,\r\n    documentPortRegistry,\r\n    uiPortRegistry,\r\n    settingsPortRegistry,\r\n    i18nPortRegistry,\r\n  } = portsResult.value;\r\n\r\n  // Register FoundryGame PortRegistry\r\n  const gameRegistryResult = container.registerValue(\r\n    foundryGamePortRegistryToken,\r\n    gamePortRegistry\r\n  );\r\n  if (isErr(gameRegistryResult)) {\r\n    return err(`Failed to register FoundryGame PortRegistry: ${gameRegistryResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryHooks PortRegistry\r\n  const hooksRegistryResult = container.registerValue(\r\n    foundryHooksPortRegistryToken,\r\n    hooksPortRegistry\r\n  );\r\n  if (isErr(hooksRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundryHooks PortRegistry: ${hooksRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryDocument PortRegistry\r\n  const documentRegistryResult = container.registerValue(\r\n    foundryDocumentPortRegistryToken,\r\n    documentPortRegistry\r\n  );\r\n  if (isErr(documentRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundryDocument PortRegistry: ${documentRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryUI PortRegistry\r\n  const uiRegistryResult = container.registerValue(foundryUIPortRegistryToken, uiPortRegistry);\r\n  if (isErr(uiRegistryResult)) {\r\n    return err(`Failed to register FoundryUI PortRegistry: ${uiRegistryResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundrySettings PortRegistry\r\n  const settingsRegistryResult = container.registerValue(\r\n    foundrySettingsPortRegistryToken,\r\n    settingsPortRegistry\r\n  );\r\n  if (isErr(settingsRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundrySettings PortRegistry: ${settingsRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryI18n PortRegistry\r\n  const i18nRegistryResult = container.registerValue(\r\n    foundryI18nPortRegistryToken,\r\n    i18nPortRegistry\r\n  );\r\n  if (isErr(i18nRegistryResult)) {\r\n    return err(`Failed to register FoundryI18n PortRegistry: ${i18nRegistryResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * Abstract base class for Foundry service wrappers.\r\n *\r\n * Provides:\r\n * - Common lazy-loading logic for port selection\r\n * - Retry capability for transient Foundry API failures\r\n * - Consistent cleanup via Disposable\r\n *\r\n * WHY RETRY FOR FOUNDRY API?\r\n * Foundry VTT APIs can have transient failures:\r\n * - Race conditions (game.journal not yet initialized)\r\n * - Timing issues (DOM not ready, settings not loaded)\r\n * - Port selection failures (version detection glitches)\r\n *\r\n * A single retry (maxAttempts: 2) catches 90% of transient errors\r\n * without performance impact.\r\n *\r\n * @template TPort - The port interface type (e.g., FoundryGame, FoundryHooks)\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { ServiceType } from \"@/infrastructure/shared/tokens\";\r\nimport { castDisposablePort } from \"@/infrastructure/adapters/foundry/runtime-casts\";\r\n\r\nexport abstract class FoundryServiceBase<TPort extends ServiceType> implements Disposable {\r\n  protected port: TPort | null = null;\r\n  protected readonly portSelector: PortSelector;\r\n  protected readonly portRegistry: PortRegistry<TPort>;\r\n  protected readonly retryService: RetryService;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<TPort>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portSelector = portSelector;\r\n    this.portRegistry = portRegistry;\r\n    this.retryService = retryService;\r\n  }\r\n\r\n  /**\r\n   * Lazy-loads the appropriate port based on Foundry version.\r\n   * Uses PortSelector with token-based selection to resolve ports from the DI container.\r\n   *\r\n   * CRITICAL: This prevents crashes when newer port constructors access\r\n   * APIs not available in the current Foundry version. Ports are resolved\r\n   * from the DI container, ensuring DIP (Dependency Inversion Principle) compliance.\r\n   *\r\n   * @param adapterName - Name for logging purposes (e.g., \"FoundryGame\")\r\n   * @returns Result containing the port or a FoundryError if no compatible port can be selected\r\n   */\r\n  protected getPort(adapterName: string): Result<TPort, FoundryError> {\r\n    if (this.port === null) {\r\n      const tokens = this.portRegistry.getTokens();\r\n      const portResult = this.portSelector.selectPortFromTokens(tokens, undefined, adapterName);\r\n      if (!portResult.ok) {\r\n        return portResult;\r\n      }\r\n      this.port = portResult.value;\r\n    }\r\n    // At this point, this.port is guaranteed to be non-null\r\n    return { ok: true, value: this.port as TPort };\r\n  }\r\n\r\n  /**\r\n   * Executes a Foundry API operation with automatic retry on transient failures.\r\n   *\r\n   * Use this for any port method call to handle:\r\n   * - Race conditions (Foundry not fully initialized)\r\n   * - Timing issues (DOM/Settings not ready)\r\n   * - Transient port selection failures\r\n   *\r\n   * @template T - The success type\r\n   * @param fn - Function to execute (should call port methods)\r\n   * @param operationName - Operation name for logging (e.g., \"FoundryGame.getJournalEntries\")\r\n   * @param maxAttempts - Max retry attempts (default: 2 = 1 retry)\r\n   * @returns Result from operation or mapped error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * getJournalEntries(): Result<Entry[], FoundryError> {\r\n   *   return this.withRetry(\r\n   *     () => {\r\n   *       const portResult = this.getPort(\"FoundryGame\");\r\n   *       if (!portResult.ok) return portResult;\r\n   *       return portResult.value.getJournalEntries();\r\n   *     },\r\n   *     \"FoundryGame.getJournalEntries\"\r\n   *   );\r\n   * }\r\n   * ```\r\n   */\r\n  protected withRetry<T>(\r\n    fn: () => Result<T, FoundryError>,\r\n    operationName: string,\r\n    maxAttempts: number = 2\r\n  ): Result<T, FoundryError> {\r\n    return this.retryService.retrySync(fn, {\r\n      maxAttempts,\r\n      operationName,\r\n      mapException: (error) => ({\r\n        code: \"OPERATION_FAILED\" as const,\r\n        message: `${operationName} failed: ${String(error)}`,\r\n        cause: error instanceof Error ? error : undefined,\r\n      }),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Async variant of withRetry for async operations.\r\n   *\r\n   * @template T - The success type\r\n   * @param fn - Async function to execute\r\n   * @param operationName - Operation name for logging\r\n   * @param maxAttempts - Max retry attempts (default: 2)\r\n   * @returns Promise resolving to Result\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * async setFlag<T>(doc, scope, key, value): Promise<Result<void, FoundryError>> {\r\n   *   return this.withRetryAsync(\r\n   *     async () => {\r\n   *       const portResult = this.getPort(\"FoundryDocument\");\r\n   *       if (!portResult.ok) return portResult;\r\n   *       return await portResult.value.setFlag(doc, scope, key, value);\r\n   *     },\r\n   *     \"FoundryDocument.setFlag\"\r\n   *   );\r\n   * }\r\n   * ```\r\n   */\r\n  protected async withRetryAsync<T>(\r\n    fn: () => Promise<Result<T, FoundryError>>,\r\n    operationName: string,\r\n    maxAttempts: number = 2\r\n  ): Promise<Result<T, FoundryError>> {\r\n    return this.retryService.retry(fn, {\r\n      maxAttempts,\r\n      delayMs: 100, // 100ms delay between retries\r\n      operationName,\r\n      mapException: (error) => ({\r\n        code: \"OPERATION_FAILED\" as const,\r\n        message: `${operationName} failed: ${String(error)}`,\r\n        cause: error instanceof Error ? error : undefined,\r\n      }),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then resets the reference.\r\n   * All ports now implement dispose() with #disposed state guards.\r\n   */\r\n  dispose(): void {\r\n    // Dispose port if it implements Disposable interface\r\n    const disposable = castDisposablePort(this.port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.port = null;\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryGame } from \"../interfaces/FoundryGame\";\r\nimport type { FoundryJournalEntry } from \"../types\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryGamePortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\n\r\n/**\r\n * Port wrapper for FoundryGame that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase for consistent port selection and retry logic.\r\n */\r\nexport class FoundryGamePort extends FoundryServiceBase<FoundryGame> implements FoundryGame {\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryGame>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryGame\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getJournalEntries();\r\n    }, \"FoundryGame.getJournalEntries\");\r\n  }\r\n\r\n  getJournalEntryById(id: string): Result<FoundryJournalEntry | null, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryGame\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getJournalEntryById(id);\r\n    }, \"FoundryGame.getJournalEntryById\");\r\n  }\r\n\r\n  invalidateCache(): void {\r\n    const portResult = this.getPort(\"FoundryGame\");\r\n    if (portResult.ok) {\r\n      portResult.value.invalidateCache();\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIFoundryGamePort extends FoundryGamePort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryGamePortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryGame>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHooks } from \"../interfaces/FoundryHooks\";\r\nimport type { FoundryHookCallback } from \"../types\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type {\r\n  PlatformEventPort,\r\n  EventRegistrationId,\r\n  PlatformEventError,\r\n} from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryHooksPortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { loggerToken, retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\nimport { err, ok } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Type-safe interface for Foundry Hooks with dynamic hook names.\r\n * Allows calling Hooks.off() with runtime-determined hook names without using 'any'.\r\n */\r\ninterface DynamicHooksApi {\r\n  off(hookName: string, callback: (...args: unknown[]) => unknown): void;\r\n  on(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n  once(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n}\r\n\r\n/**\r\n * Port wrapper for FoundryHooks that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase but maintains its own dispose() logic for hook cleanup.\r\n * Implements both FoundryHooks (Foundry-specific) and PlatformEventPort (platform-agnostic).\r\n */\r\nexport class FoundryHooksPort\r\n  extends FoundryServiceBase<FoundryHooks>\r\n  implements FoundryHooks, PlatformEventPort<unknown>\r\n{\r\n  private readonly logger: Logger;\r\n  private registeredHooks = new Map<string, Map<number, FoundryHookCallback>>();\r\n  // Bidirectional mapping: callback function -> array of hook registrations (supports reused callbacks)\r\n  private callbackToIdMap = new Map<FoundryHookCallback, Array<{ hookName: string; id: number }>>();\r\n  // Mapping from registration ID to hook name for unregisterListener()\r\n  private idToHookNameMap = new Map<number, string>();\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryHooks>,\r\n    retryService: RetryService,\r\n    logger: Logger\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n    this.logger = logger;\r\n  }\r\n\r\n  on(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    const result = this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.on(hookName, callback);\r\n    }, \"FoundryHooks.on\");\r\n\r\n    if (result.ok) {\r\n      // Track registered hook for cleanup (both directions)\r\n      let hookMap = this.registeredHooks.get(hookName);\r\n      if (!hookMap) {\r\n        hookMap = new Map();\r\n        this.registeredHooks.set(hookName, hookMap);\r\n      }\r\n      hookMap.set(result.value, callback);\r\n\r\n      // Support multiple registrations of the same callback\r\n      const existing = this.callbackToIdMap.get(callback) || [];\r\n      existing.push({ hookName, id: result.value });\r\n      this.callbackToIdMap.set(callback, existing);\r\n\r\n      // Track ID to hook name for unregisterListener()\r\n      this.idToHookNameMap.set(result.value, hookName);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  once(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    // once() hooks are automatically deregistered by Foundry after firing\r\n    // No tracking needed - they clean themselves up\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.once(hookName, callback);\r\n    }, \"FoundryHooks.once\");\r\n  }\r\n\r\n  off(hookName: string, callbackOrId: FoundryHookCallback | number): Result<void, FoundryError> {\r\n    const result = this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.off(hookName, callbackOrId);\r\n    }, \"FoundryHooks.off\");\r\n\r\n    if (result.ok) {\r\n      // Remove from tracked hooks (handle both ID and callback variants)\r\n      if (typeof callbackOrId === \"number\") {\r\n        // ID variant: remove by ID\r\n        const hooks = this.registeredHooks.get(hookName);\r\n        if (hooks) {\r\n          const callback = hooks.get(callbackOrId);\r\n          hooks.delete(callbackOrId);\r\n          // Clean up bidirectional mapping - remove only this specific registration\r\n          if (callback) {\r\n            const hookInfos = this.callbackToIdMap.get(callback);\r\n            if (hookInfos) {\r\n              const filtered = hookInfos.filter(\r\n                (info) => !(info.hookName === hookName && info.id === callbackOrId)\r\n              );\r\n              if (filtered.length === 0) {\r\n                this.callbackToIdMap.delete(callback);\r\n              } else {\r\n                this.callbackToIdMap.set(callback, filtered);\r\n              }\r\n            }\r\n          }\r\n          // Remove from ID to hook name mapping\r\n          this.idToHookNameMap.delete(callbackOrId);\r\n        }\r\n      } else {\r\n        // Callback variant: lookup all registrations for this hookName via callbackToIdMap\r\n        const hookInfos = this.callbackToIdMap.get(callbackOrId);\r\n        if (hookInfos) {\r\n          // Find all registrations for this specific hookName\r\n          const matchingInfos = hookInfos.filter((info) => info.hookName === hookName);\r\n\r\n          // Remove from registeredHooks\r\n          const hooks = this.registeredHooks.get(hookName);\r\n          if (hooks) {\r\n            for (const info of matchingInfos) {\r\n              hooks.delete(info.id);\r\n            }\r\n          }\r\n\r\n          // Update callbackToIdMap - keep registrations for other hooks\r\n          const filtered = hookInfos.filter((info) => info.hookName !== hookName);\r\n          if (filtered.length === 0) {\r\n            this.callbackToIdMap.delete(callbackOrId);\r\n          } else {\r\n            this.callbackToIdMap.set(callbackOrId, filtered);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Cleans up all registered hooks.\r\n   * Called automatically when the container is disposed.\r\n   */\r\n  override dispose(): void {\r\n    // Iterate through all callbacks and their registrations\r\n    for (const [callback, hookInfos] of this.callbackToIdMap) {\r\n      for (const info of hookInfos) {\r\n        try {\r\n          if (typeof Hooks !== \"undefined\") {\r\n            // Type-safe cast for dynamic hook names\r\n            // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n            // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n            (Hooks as DynamicHooksApi).off(info.hookName, callback);\r\n          }\r\n        } catch (error) {\r\n          this.logger.warn(\"Failed to unregister hook\", {\r\n            hookName: info.hookName,\r\n            hookId: info.id,\r\n            error,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    this.registeredHooks.clear();\r\n    this.callbackToIdMap.clear();\r\n    this.idToHookNameMap.clear();\r\n    this.port = null;\r\n  }\r\n\r\n  // ===== PlatformEventPort Implementation =====\r\n\r\n  /**\r\n   * Register a listener for platform events.\r\n   * Delegates to FoundryHooks.on() for Foundry-specific implementation.\r\n   * Wraps the PlatformEventPort callback to receive Foundry hook arguments as an array.\r\n   */\r\n  registerListener(\r\n    eventType: string,\r\n    callback: (event: unknown) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Wrap callback: Foundry hooks pass multiple arguments, but PlatformEventPort expects single event\r\n    // We pass the arguments as an array to preserve the original Foundry hook signature\r\n    const foundryCallback: FoundryHookCallback = (...args: unknown[]): void => {\r\n      // Pass arguments as array to PlatformEventPort callback\r\n      callback(args);\r\n    };\r\n    const result = this.on(eventType, foundryCallback);\r\n\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"EVENT_REGISTRATION_FAILED\",\r\n        message: `Failed to register listener for event \"${eventType}\": ${result.error.message}`,\r\n        details: result.error,\r\n      });\r\n    }\r\n\r\n    return ok(result.value);\r\n  }\r\n\r\n  /**\r\n   * Unregister a previously registered listener.\r\n   * Requires mapping from registration ID to hook name.\r\n   */\r\n  unregisterListener(registrationId: EventRegistrationId): Result<void, PlatformEventError> {\r\n    // Convert to number if it's a string\r\n    const id =\r\n      typeof registrationId === \"string\" ? Number.parseInt(registrationId, 10) : registrationId;\r\n\r\n    if (Number.isNaN(id)) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `Invalid registration ID: ${String(registrationId)}`,\r\n      });\r\n    }\r\n\r\n    // Look up hook name from ID\r\n    const hookName = this.idToHookNameMap.get(id);\r\n    if (!hookName) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `No registration found for ID ${id}`,\r\n      });\r\n    }\r\n\r\n    // Use off() with ID\r\n    const result = this.off(hookName, id);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `Failed to unregister listener for event \"${hookName}\": ${result.error.message}`,\r\n        details: result.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\nexport class DIFoundryHooksPort extends FoundryHooksPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryHooksPortRegistryToken,\r\n    retryServiceToken,\r\n    loggerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryHooks>,\r\n    retryService: RetryService,\r\n    logger: Logger\r\n  ) {\r\n    super(portSelector, portRegistry, retryService, logger);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryDocument } from \"../interfaces/FoundryDocument\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryDocumentPortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\nimport type * as v from \"valibot\";\r\n\r\n/**\r\n * Port wrapper for FoundryDocument that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase for consistent port selection and retry logic.\r\n */\r\nexport class FoundryDocumentPort\r\n  extends FoundryServiceBase<FoundryDocument>\r\n  implements FoundryDocument\r\n{\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryDocument>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n\r\n  async create<TDocument extends { id: string }>(\r\n    documentClass: { create: (data: unknown) => Promise<TDocument> },\r\n    data: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.create(documentClass, data);\r\n    }, \"FoundryDocument.create\");\r\n  }\r\n\r\n  async update<TDocument extends { id: string }>(\r\n    document: { update: (changes: unknown) => Promise<TDocument> },\r\n    changes: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.update(document, changes);\r\n    }, \"FoundryDocument.update\");\r\n  }\r\n\r\n  async delete(document: { delete: () => Promise<unknown> }): Promise<Result<void, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.delete(document);\r\n    }, \"FoundryDocument.delete\");\r\n  }\r\n\r\n  getFlag<T>(\r\n    document: { getFlag: (scope: string, key: string) => unknown },\r\n    scope: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getFlag<T>(document, scope, key, schema);\r\n    }, \"FoundryDocument.getFlag\");\r\n  }\r\n\r\n  async setFlag<T = unknown>(\r\n    document: { setFlag: (scope: string, key: string, value: T) => Promise<unknown> },\r\n    scope: string,\r\n    key: string,\r\n    value: T\r\n  ): Promise<Result<void, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.setFlag(document, scope, key, value);\r\n    }, \"FoundryDocument.setFlag\");\r\n  }\r\n\r\n  async unsetFlag(\r\n    document: {\r\n      unsetFlag?: (scope: string, key: string) => Promise<unknown>;\r\n      setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n    },\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.unsetFlag(document, scope, key);\r\n    }, \"FoundryDocument.unsetFlag\");\r\n  }\r\n}\r\n\r\nexport class DIFoundryDocumentPort extends FoundryDocumentPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryDocumentPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryDocument>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryNotificationOptions, FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryUIPortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\n\r\n/**\r\n * Port wrapper for FoundryUI that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase for consistent port selection and retry logic.\r\n */\r\nexport class FoundryUIPort extends FoundryServiceBase<FoundryUI> implements FoundryUI {\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryUI>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n\r\n  removeJournalElement(\r\n    journalId: string,\r\n    journalName: string,\r\n    html: HTMLElement\r\n  ): Result<void, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.removeJournalElement(journalId, journalName, html);\r\n    }, \"FoundryUI.removeJournalElement\");\r\n  }\r\n\r\n  findElement(container: HTMLElement, selector: string): Result<HTMLElement | null, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.findElement(container, selector);\r\n    }, \"FoundryUI.findElement\");\r\n  }\r\n\r\n  notify(\r\n    message: string,\r\n    type: \"info\" | \"warning\" | \"error\",\r\n    options?: FoundryNotificationOptions\r\n  ): Result<void, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.notify(message, type, options);\r\n    }, \"FoundryUI.notify\");\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.rerenderJournalDirectory();\r\n    }, \"FoundryUI.rerenderJournalDirectory\");\r\n  }\r\n}\r\n\r\nexport class DIFoundryUIPort extends FoundryUIPort {\r\n  static dependencies = [portSelectorToken, foundryUIPortRegistryToken, retryServiceToken] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryUI>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundrySettings, SettingConfig } from \"../interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport {\r\n  portSelectorToken,\r\n  foundrySettingsPortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport type * as v from \"valibot\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\n\r\n/**\r\n * Port wrapper for FoundrySettings that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase for consistent port selection and retry logic.\r\n */\r\nexport class FoundrySettingsPort\r\n  extends FoundryServiceBase<FoundrySettings>\r\n  implements FoundrySettings\r\n{\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundrySettings>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: SettingConfig<T>\r\n  ): Result<void, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.register(namespace, key, config);\r\n    }, \"FoundrySettings.register\");\r\n  }\r\n\r\n  get<T>(\r\n    namespace: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.get(namespace, key, schema);\r\n    }, \"FoundrySettings.get\");\r\n  }\r\n\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, FoundryError>> {\r\n    return this.withRetryAsync(async () => {\r\n      const portResult = this.getPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.set(namespace, key, value);\r\n    }, \"FoundrySettings.set\");\r\n  }\r\n}\r\n\r\nexport class DIFoundrySettingsPort extends FoundrySettingsPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundrySettingsPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundrySettings>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","/**\r\n * Implementation of FoundryJournalFacade.\r\n *\r\n * Combines FoundryGame, FoundryDocument, and FoundryUI services\r\n * into a unified facade for journal operations.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { FoundryJournalEntry } from \"../types\";\r\nimport type { FoundryGame } from \"../interfaces/FoundryGame\";\r\nimport type { FoundryDocument } from \"../interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport type { FoundryJournalFacade as IFoundryJournalFacade } from \"./foundry-journal-facade.interface\";\r\nimport {\r\n  foundryGameToken,\r\n  foundryDocumentToken,\r\n  foundryUIToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport { castFoundryDocumentForFlag } from \"@/infrastructure/adapters/foundry/runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Facade for journal-related Foundry operations.\r\n *\r\n * **Benefits:**\r\n * - Reduces JournalVisibilityService dependencies from 4 to 2 (facade + logger)\r\n * - Provides cohesive journal-specific API\r\n * - Easier to test (single facade mock instead of 3 service mocks)\r\n * - Clear boundary for journal-related operations\r\n */\r\nexport class FoundryJournalFacade implements IFoundryJournalFacade {\r\n  constructor(\r\n    private readonly game: FoundryGame,\r\n    private readonly document: FoundryDocument,\r\n    private readonly ui: FoundryUI\r\n  ) {}\r\n\r\n  /**\r\n   * Get all journal entries from Foundry.\r\n   *\r\n   * Delegates to FoundryGame.getJournalEntries().\r\n   */\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    return this.game.getJournalEntries();\r\n  }\r\n\r\n  /**\r\n   * Get a module flag from a journal entry with runtime validation.\r\n   *\r\n   * Delegates to FoundryDocument.getFlag() with module scope and schema.\r\n   *\r\n   * @template T - The flag value type\r\n   * @param entry - The Foundry journal entry\r\n   * @param key - The flag key\r\n   * @param schema - Valibot schema for validation\r\n   */\r\n  getEntryFlag<T>(\r\n    entry: FoundryJournalEntry,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    // Type widening: fvtt-types JournalEntry.getFlag has overly restrictive scope type (\"core\" only),\r\n    // but module flags use module ID as scope. Cast to generic interface is safe.\r\n    const documentResult = castFoundryDocumentForFlag(entry);\r\n    if (!documentResult.ok) {\r\n      return documentResult; // Propagate error\r\n    }\r\n    return this.document.getFlag<T>(documentResult.value, MODULE_CONSTANTS.MODULE.ID, key, schema);\r\n  }\r\n\r\n  /**\r\n   * Remove a journal element from the UI.\r\n   *\r\n   * Delegates to FoundryUI.removeJournalElement().\r\n   *\r\n   * @param id - Journal entry ID\r\n   * @param name - Journal entry name (for logging)\r\n   * @param html - HTML container element\r\n   */\r\n  removeJournalElement(id: string, name: string, html: HTMLElement): Result<void, FoundryError> {\r\n    return this.ui.removeJournalElement(id, name, html);\r\n  }\r\n\r\n  /**\r\n   * Set a module flag on a journal entry.\r\n   *\r\n   * Delegates to FoundryDocument.setFlag() with module scope.\r\n   *\r\n   * @param entry - The Foundry journal entry\r\n   * @param key - The flag key\r\n   * @param value - The boolean value to set\r\n   * @returns Result indicating success or error\r\n   */\r\n  async setEntryFlag(\r\n    entry: FoundryJournalEntry,\r\n    key: string,\r\n    value: boolean\r\n  ): Promise<Result<void, FoundryError>> {\r\n    const documentResult = castFoundryDocumentForFlag(entry);\r\n    if (!documentResult.ok) {\r\n      return documentResult; // Propagate error\r\n    }\r\n    return await this.document.setFlag(\r\n      documentResult.value,\r\n      MODULE_CONSTANTS.MODULE.ID,\r\n      key,\r\n      value\r\n    );\r\n  }\r\n}\r\n\r\nexport class DIFoundryJournalFacade extends FoundryJournalFacade {\r\n  static dependencies = [foundryGameToken, foundryDocumentToken, foundryUIToken] as const;\r\n\r\n  constructor(game: FoundryGame, document: FoundryDocument, ui: FoundryUI) {\r\n    super(game, document, ui);\r\n  }\r\n}\r\n","import type { PlatformJournalVisibilityPort } from \"@/domain/ports/platform-journal-visibility-port.interface\";\r\nimport type { JournalEntry, JournalVisibilityError } from \"@/domain/entities/journal-entry\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryJournalFacade } from \"@/infrastructure/adapters/foundry/facades/foundry-journal-facade.interface\";\r\nimport { BOOLEAN_FLAG_SCHEMA } from \"@/infrastructure/adapters/foundry/validation/setting-schemas\";\r\nimport { foundryJournalFacadeToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Foundry-specific adapter for PlatformJournalVisibilityPort.\r\n *\r\n * Translates between domain types (JournalEntry) and Foundry types (FoundryJournalEntry).\r\n * The adapter is version-independent, as it uses FoundryJournalFacade which already\r\n * handles version selection via PortSelector.\r\n */\r\nexport class FoundryJournalVisibilityAdapter implements PlatformJournalVisibilityPort {\r\n  constructor(private readonly foundryJournalFacade: FoundryJournalFacade) {}\r\n\r\n  getAllEntries(): Result<JournalEntry[], JournalVisibilityError> {\r\n    const result = this.foundryJournalFacade.getJournalEntries();\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"INVALID_ENTRY_DATA\",\r\n          message: result.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Map FoundryJournalEntry → JournalEntry\r\n    const entries: JournalEntry[] = result.value.map((foundryEntry) => ({\r\n      id: foundryEntry.id,\r\n      name: foundryEntry.name ?? null,\r\n    }));\r\n\r\n    return { ok: true, value: entries };\r\n  }\r\n\r\n  getEntryFlag(\r\n    entry: JournalEntry,\r\n    flagKey: string\r\n  ): Result<boolean | null, JournalVisibilityError> {\r\n    // Find FoundryJournalEntry by ID (we need to fetch all to find the right one)\r\n    const foundryEntriesResult = this.foundryJournalFacade.getJournalEntries();\r\n    if (!foundryEntriesResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"FLAG_READ_FAILED\",\r\n          entryId: entry.id,\r\n          message: foundryEntriesResult.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    const foundryEntry = foundryEntriesResult.value.find((e) => e.id === entry.id);\r\n    if (!foundryEntry) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"ENTRY_NOT_FOUND\",\r\n          entryId: entry.id,\r\n          message: `Journal entry with ID ${entry.id} not found`,\r\n        },\r\n      };\r\n    }\r\n\r\n    const flagResult = this.foundryJournalFacade.getEntryFlag<boolean>(\r\n      foundryEntry,\r\n      flagKey,\r\n      BOOLEAN_FLAG_SCHEMA\r\n    );\r\n\r\n    if (!flagResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"FLAG_READ_FAILED\",\r\n          entryId: entry.id,\r\n          message: flagResult.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: flagResult.value };\r\n  }\r\n\r\n  async setEntryFlag(\r\n    entry: JournalEntry,\r\n    flagKey: string,\r\n    value: boolean\r\n  ): Promise<Result<void, JournalVisibilityError>> {\r\n    // Find FoundryJournalEntry by ID (we need to fetch all to find the right one)\r\n    const foundryEntriesResult = this.foundryJournalFacade.getJournalEntries();\r\n    if (!foundryEntriesResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"FLAG_SET_FAILED\",\r\n          entryId: entry.id,\r\n          message: foundryEntriesResult.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    const foundryEntry = foundryEntriesResult.value.find((e) => e.id === entry.id);\r\n    if (!foundryEntry) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"ENTRY_NOT_FOUND\",\r\n          entryId: entry.id,\r\n          message: `Journal entry with ID ${entry.id} not found`,\r\n        },\r\n      };\r\n    }\r\n\r\n    const flagResult = await this.foundryJournalFacade.setEntryFlag(foundryEntry, flagKey, value);\r\n\r\n    if (!flagResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"FLAG_SET_FAILED\",\r\n          entryId: entry.id,\r\n          message: flagResult.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n}\r\n\r\n// DI-Wrapper\r\nexport class DIFoundryJournalVisibilityAdapter extends FoundryJournalVisibilityAdapter {\r\n  static dependencies = [foundryJournalFacadeToken] as const;\r\n\r\n  constructor(foundryJournalFacade: FoundryJournalFacade) {\r\n    super(foundryJournalFacade);\r\n  }\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { assertCacheKey } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\nconst KEY_SEPARATOR = \":\";\r\n\r\n/**\r\n * Normalized cache key used by CacheService.\r\n */\r\nexport type CacheKey = string & { readonly __cacheKeyBrand: unique symbol };\r\n\r\n/**\r\n * Parts required to build a cache key.\r\n */\r\nexport interface CacheKeyParts {\r\n  /** Logical namespace, e.g. \"journal\" */\r\n  namespace: string;\r\n  /** Resource or operation name, e.g. \"hidden\" */\r\n  resource: string;\r\n  /** Optional identifier or scope information */\r\n  identifier?: string | number | null;\r\n}\r\n\r\n/**\r\n * Options to configure cache entries at set-time.\r\n */\r\nexport interface CacheSetOptions {\r\n  /** Explicit TTL in milliseconds. Falls back to service default when omitted. */\r\n  ttlMs?: number;\r\n  /** Arbitrary tags that can be used for bulk invalidation. */\r\n  tags?: readonly string[];\r\n}\r\n\r\n/**\r\n * Snapshot of metadata tracked for a cache entry.\r\n */\r\nexport interface CacheEntryMetadata {\r\n  key: CacheKey;\r\n  createdAt: number;\r\n  expiresAt: number | null;\r\n  lastAccessedAt: number;\r\n  hits: number;\r\n  tags: readonly string[];\r\n}\r\n\r\n/**\r\n * Result returned from cache lookups.\r\n */\r\nexport interface CacheLookupResult<T> {\r\n  hit: boolean;\r\n  value?: T;\r\n  metadata: CacheEntryMetadata;\r\n}\r\n\r\n/**\r\n * Aggregate statistics for the entire cache.\r\n */\r\nexport interface CacheStatistics {\r\n  hits: number;\r\n  misses: number;\r\n  evictions: number;\r\n  size: number;\r\n  enabled: boolean;\r\n}\r\n\r\n/**\r\n * Configuration used to instantiate CacheService.\r\n */\r\nexport interface CacheServiceConfig {\r\n  enabled: boolean;\r\n  defaultTtlMs: number;\r\n  maxEntries?: number | undefined;\r\n  namespace?: string;\r\n}\r\n\r\n/**\r\n * Predicate used for targeted cache invalidation.\r\n */\r\nexport type CacheInvalidationPredicate = (entry: CacheEntryMetadata) => boolean;\r\n\r\n/**\r\n * CacheService contract exposed through DI.\r\n */\r\nexport interface CacheService {\r\n  readonly isEnabled: boolean;\r\n  readonly size: number;\r\n  get<TValue>(key: CacheKey): CacheLookupResult<TValue> | null;\r\n  set<TValue>(key: CacheKey, value: TValue, options?: CacheSetOptions): CacheEntryMetadata;\r\n  delete(key: CacheKey): boolean;\r\n  has(key: CacheKey): boolean;\r\n  clear(): number;\r\n  invalidateWhere(predicate: CacheInvalidationPredicate): number;\r\n  getMetadata(key: CacheKey): CacheEntryMetadata | null;\r\n  getStatistics(): CacheStatistics;\r\n  getOrSet<TValue>(\r\n    key: CacheKey,\r\n    factory: () => TValue | Promise<TValue>,\r\n    options?: CacheSetOptions\r\n  ): Promise<Result<CacheLookupResult<TValue>, string>>;\r\n}\r\n\r\n/**\r\n * Normalizes individual key segments.\r\n */\r\nfunction normalizeSegment(segment: string): string {\r\n  return segment\r\n    .trim()\r\n    .replace(/\\s+/g, \"-\")\r\n    .replace(/[^a-zA-Z0-9-_]/g, \"\")\r\n    .toLowerCase();\r\n}\r\n\r\n/**\r\n * Creates a module-scoped cache key.\r\n */\r\nexport function createCacheKey(parts: CacheKeyParts): CacheKey {\r\n  const { namespace, resource, identifier } = parts;\r\n  const payload = [MODULE_CONSTANTS.MODULE.ID, namespace, resource];\r\n  if (identifier !== null && identifier !== undefined) {\r\n    payload.push(String(identifier));\r\n  }\r\n  return assertCacheKey(payload.map(normalizeSegment).join(KEY_SEPARATOR));\r\n}\r\n\r\n/**\r\n * Helper to build cache key factories for a namespace.\r\n */\r\nexport function createCacheNamespace(namespace: string) {\r\n  const normalizedNamespace = normalizeSegment(namespace);\r\n  return (resource: string, identifier?: string | number | null): CacheKey =>\r\n    identifier === undefined\r\n      ? createCacheKey({ namespace: normalizedNamespace, resource })\r\n      : createCacheKey({ namespace: normalizedNamespace, resource, identifier });\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalVisibilityPort } from \"@/domain/ports/platform-journal-visibility-port.interface\";\r\nimport type { JournalVisibilityError } from \"@/domain/entities/journal-entry\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { CacheService } from \"@/infrastructure/cache/cache.interface\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport { createCacheNamespace } from \"@/infrastructure/cache/cache.interface\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport { getFirstArrayElement } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport {\r\n  journalVisibilityPortToken,\r\n  cacheServiceToken,\r\n  notificationCenterToken,\r\n  platformUIPortToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { sanitizeHtml } from \"@/infrastructure/adapters/foundry/validation/schemas\";\r\n\r\nconst buildJournalCacheKey = createCacheNamespace(\"journal-visibility\");\r\nconst HIDDEN_JOURNAL_CACHE_KEY = buildJournalCacheKey(\"hidden-directory\");\r\nexport const HIDDEN_JOURNAL_CACHE_TAG = \"journal:hidden\";\r\n\r\n/**\r\n * Service for managing journal entry visibility based on module flags.\r\n * Handles business logic for hiding/showing journal entries in the UI.\r\n *\r\n * **Dependencies:**\r\n * - PlatformJournalVisibilityPort: Platform-agnostic port for journal operations\r\n * - NotificationCenter: For logging and notifications\r\n * - CacheService: For caching hidden entries\r\n * - PlatformUIPort: Platform-agnostic port for UI operations\r\n *\r\n * **DIP-Compliance:**\r\n * - Depends on domain-neutral ports, not Foundry-specific types\r\n * - Platform-specific adapters implement the ports\r\n */\r\nexport class JournalVisibilityService {\r\n  constructor(\r\n    private readonly port: PlatformJournalVisibilityPort,\r\n    private readonly notificationCenter: NotificationCenter,\r\n    private readonly cacheService: CacheService,\r\n    private readonly platformUI: PlatformUIPort\r\n  ) {}\r\n\r\n  /**\r\n   * Sanitizes a string for safe use in log messages.\r\n   * Escapes HTML entities to prevent log injection or display issues.\r\n   *\r\n   * Delegates to sanitizeHtml for robust DOM-based sanitization.\r\n   *\r\n   * @param input - The string to sanitize\r\n   * @returns HTML-safe string\r\n   */\r\n  private sanitizeForLog(input: string): string {\r\n    return sanitizeHtml(input);\r\n  }\r\n\r\n  /**\r\n   * Gets journal entries marked as hidden via module flag.\r\n   * Logs warnings for entries where flag reading fails to aid diagnosis.\r\n   */\r\n  getHiddenJournalEntries(): Result<JournalEntry[], JournalVisibilityError> {\r\n    const cached = this.cacheService.get<JournalEntry[]>(HIDDEN_JOURNAL_CACHE_KEY);\r\n    if (cached?.hit && cached.value) {\r\n      this.notificationCenter.debug(\r\n        `Serving ${cached.value.length} hidden journal entries from cache (ttl=${\r\n          cached.metadata.expiresAt ?? \"∞\"\r\n        })`,\r\n        { context: { cached } },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n      return { ok: true, value: cached.value };\r\n    }\r\n\r\n    const allEntriesResult = this.port.getAllEntries();\r\n    if (!allEntriesResult.ok) return allEntriesResult;\r\n\r\n    const hidden: JournalEntry[] = [];\r\n\r\n    for (const journal of allEntriesResult.value) {\r\n      const flagResult = this.port.getEntryFlag(journal, MODULE_CONSTANTS.FLAGS.HIDDEN);\r\n\r\n      if (flagResult.ok) {\r\n        if (flagResult.value === true) {\r\n          hidden.push(journal);\r\n        }\r\n      } else {\r\n        // Log flag read errors for diagnosis without interrupting processing\r\n        const journalIdentifier = journal.name ?? journal.id;\r\n        this.notificationCenter.warn(\r\n          `Failed to read hidden flag for journal \"${this.sanitizeForLog(journalIdentifier)}\"`,\r\n          {\r\n            errorCode: flagResult.error.code,\r\n            errorMessage: flagResult.error.message,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n\r\n        // Continue processing other entries\r\n      }\r\n    }\r\n\r\n    this.cacheService.set(HIDDEN_JOURNAL_CACHE_KEY, hidden.slice(), {\r\n      tags: [HIDDEN_JOURNAL_CACHE_TAG],\r\n    });\r\n\r\n    return { ok: true, value: hidden };\r\n  }\r\n\r\n  /**\r\n   * Processes journal directory HTML to hide flagged entries.\r\n   * @returns Result indicating success or failure with aggregated errors\r\n   */\r\n  processJournalDirectory(htmlElement: HTMLElement): Result<void, JournalVisibilityError> {\r\n    this.notificationCenter.debug(\r\n      \"Processing journal directory for hidden entries\",\r\n      { context: { htmlElement } },\r\n      {\r\n        channels: [\"ConsoleChannel\"],\r\n      }\r\n    );\r\n\r\n    const hiddenResult = this.getHiddenJournalEntries();\r\n    if (!hiddenResult.ok) {\r\n      // Log error but return it for caller to handle\r\n      this.notificationCenter.error(\"Error getting hidden journal entries\", hiddenResult.error, {\r\n        channels: [\"ConsoleChannel\"],\r\n      });\r\n      return hiddenResult;\r\n    }\r\n\r\n    const hidden = hiddenResult.value;\r\n    this.notificationCenter.debug(\r\n      `Found ${hidden.length} hidden journal entries`,\r\n      { context: { hidden } },\r\n      {\r\n        channels: [\"ConsoleChannel\"],\r\n      }\r\n    );\r\n\r\n    return this.hideEntries(hidden, htmlElement);\r\n  }\r\n\r\n  private hideEntries(\r\n    entries: JournalEntry[],\r\n    html: HTMLElement\r\n  ): Result<void, JournalVisibilityError> {\r\n    const errors: JournalVisibilityError[] = [];\r\n\r\n    for (const journal of entries) {\r\n      const journalName = journal.name ?? MODULE_CONSTANTS.DEFAULTS.UNKNOWN_NAME;\r\n      const removeResult = this.platformUI.removeJournalElement(journal.id, journalName, html);\r\n\r\n      // Map PlatformUIError to JournalVisibilityError\r\n      if (!removeResult.ok) {\r\n        const journalError: JournalVisibilityError = {\r\n          code: \"DOM_MANIPULATION_FAILED\",\r\n          entryId: journal.id,\r\n          message: removeResult.error.message,\r\n        };\r\n        errors.push(journalError);\r\n        this.notificationCenter.warn(\"Error removing journal entry\", journalError, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n      } else {\r\n        this.notificationCenter.debug(\r\n          `Removing journal entry: ${this.sanitizeForLog(journalName)}`,\r\n          { context: { journal } },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    // If any errors occurred, return the first one\r\n    // In future, could aggregate multiple errors into a single error\r\n    if (errors.length > 0) {\r\n      // errors[0] is always defined when errors.length > 0\r\n      // Use helper from runtime-safe-cast to maintain type coverage\r\n      const firstError = getFirstArrayElement(errors);\r\n      return { ok: false, error: firstError };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n}\r\n\r\nexport class DIJournalVisibilityService extends JournalVisibilityService {\r\n  static dependencies = [\r\n    journalVisibilityPortToken,\r\n    notificationCenterToken,\r\n    cacheServiceToken,\r\n    platformUIPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    port: PlatformJournalVisibilityPort,\r\n    notificationCenter: NotificationCenter,\r\n    cacheService: CacheService,\r\n    platformUI: PlatformUIPort\r\n  ) {\r\n    super(port, notificationCenter, cacheService, platformUI);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  LibWrapperService,\r\n  LibWrapperFunction,\r\n  LibWrapperType,\r\n  LibWrapperRegistrationId,\r\n  LibWrapperError,\r\n} from \"@/domain/services/lib-wrapper-service.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport { tryCatch } from \"@/infrastructure/shared/utils/result\";\r\nimport { err, ok } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Type for libWrapper global (provided by lib-wrapper module in Foundry).\r\n */\r\ndeclare global {\r\n  var libWrapper:\r\n    | {\r\n        register: (\r\n          moduleId: string,\r\n          target: string,\r\n          fn: LibWrapperFunction,\r\n          type: LibWrapperType\r\n        ) => void;\r\n        unregister: (moduleId: string, target: string) => void;\r\n      }\r\n    | undefined;\r\n}\r\n\r\n/**\r\n * Foundry-specific implementation of LibWrapperService.\r\n *\r\n * Provides a facade over libWrapper that handles registration and unregistration\r\n * of method wrappers. Tracks all registrations for proper cleanup.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = new FoundryLibWrapperService(\"my-module-id\", logger);\r\n *\r\n * const result = service.register(\r\n *   \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n *   (wrapped, ...args) => {\r\n *     // Custom logic\r\n *     return wrapped(...args);\r\n *   },\r\n *   \"WRAPPER\"\r\n * );\r\n *\r\n * // Later: Cleanup\r\n * service.dispose();\r\n * ```\r\n */\r\nexport class FoundryLibWrapperService implements LibWrapperService {\r\n  private registeredTargets = new Map<string, boolean>();\r\n  private nextId = 1;\r\n\r\n  constructor(\r\n    private readonly moduleId: string,\r\n    private readonly logger: Logger\r\n  ) {}\r\n\r\n  register(\r\n    target: string,\r\n    wrapperFn: LibWrapperFunction,\r\n    type: LibWrapperType\r\n  ): Result<LibWrapperRegistrationId, LibWrapperError> {\r\n    // Prüfe libWrapper Verfügbarkeit\r\n    if (typeof globalThis.libWrapper === \"undefined\") {\r\n      return err({\r\n        code: \"LIBWRAPPER_NOT_AVAILABLE\",\r\n        message: \"libWrapper is not available\",\r\n      });\r\n    }\r\n\r\n    // Prüfe, ob Target bereits registriert ist\r\n    if (this.registeredTargets.has(target)) {\r\n      return err({\r\n        code: \"REGISTRATION_FAILED\",\r\n        message: `Target \"${target}\" is already registered`,\r\n        details: { target },\r\n      });\r\n    }\r\n\r\n    const result = tryCatch(\r\n      () => {\r\n        const libWrapperInstance = globalThis.libWrapper;\r\n        if (typeof libWrapperInstance === \"undefined\") {\r\n          throw new Error(\"libWrapper is not available\");\r\n        }\r\n\r\n        libWrapperInstance.register(this.moduleId, target, wrapperFn, type);\r\n\r\n        // Track registration\r\n        this.registeredTargets.set(target, true);\r\n        const registrationId = this.nextId++;\r\n\r\n        return registrationId;\r\n      },\r\n      (error): LibWrapperError => ({\r\n        code: \"REGISTRATION_FAILED\",\r\n        message: `Failed to register wrapper for target \"${target}\": ${String(error)}`,\r\n        details: { target, error },\r\n      })\r\n    );\r\n\r\n    if (result.ok) {\r\n      return ok(result.value);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  unregister(target: string): Result<void, LibWrapperError> {\r\n    // Prüfe, ob Target registriert ist\r\n    if (!this.registeredTargets.has(target)) {\r\n      return err({\r\n        code: \"TARGET_NOT_REGISTERED\",\r\n        message: `Target \"${target}\" is not registered`,\r\n        details: { target },\r\n      });\r\n    }\r\n\r\n    // Prüfe libWrapper Verfügbarkeit\r\n    if (typeof globalThis.libWrapper === \"undefined\") {\r\n      return err({\r\n        code: \"LIBWRAPPER_NOT_AVAILABLE\",\r\n        message: \"libWrapper is not available\",\r\n      });\r\n    }\r\n\r\n    const result = tryCatch(\r\n      () => {\r\n        const libWrapperInstance = globalThis.libWrapper;\r\n        if (typeof libWrapperInstance === \"undefined\") {\r\n          throw new Error(\"libWrapper is not available\");\r\n        }\r\n\r\n        libWrapperInstance.unregister(this.moduleId, target);\r\n\r\n        // Remove from tracking\r\n        this.registeredTargets.delete(target);\r\n      },\r\n      (error): LibWrapperError => ({\r\n        code: \"UNREGISTRATION_FAILED\",\r\n        message: `Failed to unregister wrapper for target \"${target}\": ${String(error)}`,\r\n        details: { target, error },\r\n      })\r\n    );\r\n\r\n    if (result.ok) {\r\n      return ok(undefined);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Cleanup all registered wrappers.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    // Unregister all tracked targets\r\n    const targets = Array.from(this.registeredTargets.keys());\r\n    for (const target of targets) {\r\n      const result = this.unregister(target);\r\n      if (!result.ok) {\r\n        this.logger.warn(\"Failed to unregister libWrapper target during dispose\", {\r\n          target,\r\n          error: result.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    this.registeredTargets.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryLibWrapperService.\r\n *\r\n * Uses MODULE_CONSTANTS.MODULE.ID directly, consistent with other services.\r\n */\r\nexport class DIFoundryLibWrapperService extends FoundryLibWrapperService {\r\n  static dependencies = [loggerToken] as const;\r\n\r\n  constructor(logger: Logger) {\r\n    super(MODULE_CONSTANTS.MODULE.ID, logger);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  LibWrapperService,\r\n  LibWrapperFunction,\r\n  LibWrapperRegistrationId,\r\n} from \"@/domain/services/lib-wrapper-service.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport { loggerToken, libWrapperServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { err, ok } from \"@/infrastructure/shared/utils/result\";\r\n\r\n// Type for Foundry ContextMenu instance (used by libWrapper)\r\ntype FoundryContextMenu = {\r\n  menuItems?: Array<{ name: string; icon: string; callback: () => void }>;\r\n};\r\n\r\n/**\r\n * Service for managing libWrapper registration for journal context menu.\r\n *\r\n * This service handles the registration of the libWrapper wrapper function\r\n * for the Foundry ContextMenu.render method. It manages callbacks that can\r\n * modify the context menu options for journal entries.\r\n *\r\n * NOTE: This is NOT an event system. The libWrapper is registered once during\r\n * init, and callbacks are registered separately.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = new JournalContextMenuLibWrapperService(\r\n *   libWrapperService,\r\n *   logger\r\n * );\r\n *\r\n * // Register libWrapper (called during init)\r\n * const result = service.register();\r\n *\r\n * // Add callback for handling context menu\r\n * service.addCallback((event) => {\r\n *   event.options.push({\r\n *     name: \"Custom Option\",\r\n *     icon: '<i class=\"fas fa-star\"></i>',\r\n *     callback: () => { /* ... *\\/ }\r\n *   });\r\n * });\r\n * ```\r\n */\r\nexport class JournalContextMenuLibWrapperService {\r\n  private libWrapperRegistered = false;\r\n  private callbacks: Array<(event: JournalContextMenuEvent) => void> = [];\r\n  private registrationId: LibWrapperRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly libWrapperService: LibWrapperService,\r\n    private readonly logger: Logger\r\n  ) {}\r\n\r\n  /**\r\n   * Register libWrapper for ContextMenu.render.\r\n   * Should be called once during module initialization.\r\n   *\r\n   * @returns Success or error if registration failed\r\n   */\r\n  register(): Result<void, Error> {\r\n    if (this.libWrapperRegistered) {\r\n      return ok(undefined);\r\n    }\r\n\r\n    // Prüfe ContextMenu Verfügbarkeit\r\n    const contextMenuClass = globalThis.foundry?.applications?.ux?.ContextMenu?.implementation;\r\n    if (!contextMenuClass) {\r\n      return err(new Error(\"ContextMenu is not available\"));\r\n    }\r\n\r\n    // Erstelle Wrapper-Funktion\r\n    const wrapperFn = this.createWrapperFunction();\r\n\r\n    // Registriere via LibWrapperService\r\n    const result = this.libWrapperService.register(\r\n      \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n      wrapperFn,\r\n      \"WRAPPER\"\r\n    );\r\n\r\n    if (!result.ok) {\r\n      return err(new Error(result.error.message));\r\n    }\r\n\r\n    this.registrationId = result.value;\r\n    this.libWrapperRegistered = true;\r\n    this.logger.debug(\"Journal context menu libWrapper registered\");\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Add a callback that will be called when a journal context menu is rendered.\r\n   *\r\n   * @param callback - Callback function that receives the context menu event\r\n   */\r\n  addCallback(callback: (event: JournalContextMenuEvent) => void): void {\r\n    this.callbacks.push(callback);\r\n  }\r\n\r\n  /**\r\n   * Remove a previously registered callback.\r\n   *\r\n   * @param callback - The callback function to remove\r\n   */\r\n  removeCallback(callback: (event: JournalContextMenuEvent) => void): void {\r\n    const index = this.callbacks.indexOf(callback);\r\n    if (index > -1) {\r\n      this.callbacks.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister libWrapper.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    if (this.libWrapperRegistered) {\r\n      const result = this.libWrapperService.unregister(\r\n        \"foundry.applications.ux.ContextMenu.implementation.prototype.render\"\r\n      );\r\n      if (!result.ok) {\r\n        this.logger.warn(\"Failed to unregister context menu libWrapper\", {\r\n          error: result.error,\r\n        });\r\n      }\r\n      this.libWrapperRegistered = false;\r\n      this.registrationId = undefined;\r\n    }\r\n    this.callbacks = [];\r\n  }\r\n\r\n  /**\r\n   * Create the wrapper function for libWrapper.\r\n   * This function intercepts ContextMenu.render calls and allows\r\n   * registered callbacks to modify the menu options.\r\n   */\r\n  private createWrapperFunction(): LibWrapperFunction {\r\n    // Closure für Callbacks-Array (damit libWrapper-Wrapper darauf zugreifen kann)\r\n    const callbacksRef = this.callbacks;\r\n\r\n    return function (\r\n      this: FoundryContextMenu,\r\n      wrapped: (...args: unknown[]) => unknown,\r\n      ...args: unknown[]\r\n    ): unknown {\r\n      // Extract target from args (first argument)\r\n      const firstArg = args[0];\r\n      const target: HTMLElement | undefined =\r\n        firstArg instanceof HTMLElement ? firstArg : undefined;\r\n\r\n      if (!target) {\r\n        return wrapped.call(this, ...args);\r\n      }\r\n\r\n      // `this` ist hier das ContextMenu-Objekt (libWrapper ruft die Funktion mit dem ContextMenu als this auf)\r\n      const menuItemsRaw = this.menuItems;\r\n      if (!menuItemsRaw) {\r\n        return wrapped.call(this, ...args);\r\n      }\r\n      // Type guard: menuItems ist jetzt definitiv definiert\r\n      const menuItems: Array<{ name: string; icon: string; callback: () => void }> = menuItemsRaw;\r\n\r\n      // Prüfe, ob es ein Journal-Eintrag ist (target zuerst)\r\n      const journalId =\r\n        target.getAttribute?.(\"data-entry-id\") || target.getAttribute?.(\"data-document-id\");\r\n\r\n      if (journalId) {\r\n        // Erstelle Event-Objekt (wie im Hook-Pattern)\r\n        const event: JournalContextMenuEvent = {\r\n          htmlElement: target,\r\n          options: menuItems.map((item: { name: string; icon: string; callback: () => void }) => ({\r\n            name: item.name,\r\n            icon: item.icon,\r\n            callback: item.callback,\r\n          })),\r\n          timestamp: Date.now(),\r\n        };\r\n\r\n        // Rufe alle registrierten Callbacks auf (via Closure)\r\n        // Handler können event.options modifizieren (z.B. neue Menü-Einträge hinzufügen)\r\n        for (const cb of callbacksRef) {\r\n          cb(event);\r\n        }\r\n\r\n        // Kopiere die modifizierten options zurück in this.menuItems\r\n        // Wichtig: Nur neue Einträge hinzufügen, nicht alle ersetzen (um andere Modifikationen zu erhalten)\r\n        const existingNames = new Set(menuItems.map((item) => item.name));\r\n        for (const newOption of event.options) {\r\n          if (!existingNames.has(newOption.name)) {\r\n            // Konvertiere ContextMenuOption zu menuItems-Format\r\n            menuItems.push({\r\n              name: newOption.name,\r\n              icon: newOption.icon,\r\n              callback: () => {\r\n                // ContextMenuOption callback erwartet HTMLElement, aber menuItems callback nicht\r\n                // Wir rufen den callback mit dem target-Element auf\r\n                const result = newOption.callback(target);\r\n                // Handle Promise falls vorhanden\r\n                if (result instanceof Promise) {\r\n                  result.catch(() => {\r\n                    // Ignore errors\r\n                  });\r\n                }\r\n              },\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      return wrapped.call(this, ...args);\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for JournalContextMenuLibWrapperService.\r\n */\r\nexport class DIJournalContextMenuLibWrapperService extends JournalContextMenuLibWrapperService {\r\n  static dependencies = [libWrapperServiceToken, loggerToken] as const;\r\n\r\n  constructor(libWrapperService: LibWrapperService, logger: Logger) {\r\n    super(libWrapperService, logger);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  foundryGameToken,\r\n  foundryHooksToken,\r\n  foundryDocumentToken,\r\n  foundryUIToken,\r\n  foundrySettingsToken,\r\n  foundryJournalFacadeToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport {\r\n  journalVisibilityServiceToken,\r\n  journalVisibilityPortToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIFoundryGamePort } from \"@/infrastructure/adapters/foundry/services/FoundryGamePort\";\r\nimport { DIFoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\nimport { DIFoundryDocumentPort } from \"@/infrastructure/adapters/foundry/services/FoundryDocumentPort\";\r\nimport { DIFoundryUIPort } from \"@/infrastructure/adapters/foundry/services/FoundryUIPort\";\r\nimport { DIFoundrySettingsPort } from \"@/infrastructure/adapters/foundry/services/FoundrySettingsPort\";\r\nimport { DIFoundryJournalFacade } from \"@/infrastructure/adapters/foundry/facades/foundry-journal-facade\";\r\nimport { DIFoundryJournalVisibilityAdapter } from \"@/infrastructure/adapters/foundry/domain-adapters/journal-visibility-adapter\";\r\nimport { DIJournalVisibilityService } from \"@/application/services/JournalVisibilityService\";\r\nimport { DIFoundryLibWrapperService } from \"@/infrastructure/adapters/foundry/services/FoundryLibWrapperService\";\r\nimport { DIJournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\nimport {\r\n  libWrapperServiceToken,\r\n  journalContextMenuLibWrapperServiceToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Registers Foundry service wrappers.\r\n *\r\n * Services registered:\r\n * - FoundryGamePort (singleton)\r\n * - FoundryHooksPort (singleton)\r\n * - FoundryDocumentPort (singleton)\r\n * - FoundryUIPort (singleton)\r\n * - FoundrySettingsPort (singleton)\r\n * - FoundryJournalFacade (singleton)\r\n * - FoundryJournalVisibilityAdapter (singleton) - must be registered before JournalVisibilityService\r\n * - JournalVisibilityService (singleton)\r\n * - FoundryLibWrapperService (singleton) - Facade for libWrapper\r\n * - JournalContextMenuLibWrapperService (singleton) - Manages libWrapper for journal context menu\r\n *\r\n * All services use port-based adapter pattern for Foundry version compatibility.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerFoundryServices(container: ServiceContainer): Result<void, string> {\r\n  // Register FoundryGamePort\r\n  const gameServiceResult = container.registerClass(\r\n    foundryGameToken,\r\n    DIFoundryGamePort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(gameServiceResult)) {\r\n    return err(`Failed to register FoundryGame service: ${gameServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryHooksPort\r\n  const hooksServiceResult = container.registerClass(\r\n    foundryHooksToken,\r\n    DIFoundryHooksPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(hooksServiceResult)) {\r\n    return err(`Failed to register FoundryHooks service: ${hooksServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryDocumentPort\r\n  const documentServiceResult = container.registerClass(\r\n    foundryDocumentToken,\r\n    DIFoundryDocumentPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(documentServiceResult)) {\r\n    return err(\r\n      `Failed to register FoundryDocument service: ${documentServiceResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryUIPort\r\n  const uiServiceResult = container.registerClass(\r\n    foundryUIToken,\r\n    DIFoundryUIPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiServiceResult)) {\r\n    return err(`Failed to register FoundryUI service: ${uiServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundrySettingsPort\r\n  const settingsServiceResult = container.registerClass(\r\n    foundrySettingsToken,\r\n    DIFoundrySettingsPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsServiceResult)) {\r\n    return err(\r\n      `Failed to register FoundrySettings service: ${settingsServiceResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryJournalFacade\r\n  // Combines Game, Document, UI for journal operations\r\n  // Must be registered BEFORE FoundryJournalVisibilityAdapter which depends on it\r\n  const journalFacadeResult = container.registerClass(\r\n    foundryJournalFacadeToken,\r\n    DIFoundryJournalFacade,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(journalFacadeResult)) {\r\n    return err(`Failed to register FoundryJournalFacade: ${journalFacadeResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryJournalVisibilityAdapter\r\n  // Implements PlatformJournalVisibilityPort for Foundry platform\r\n  // Must be registered BEFORE JournalVisibilityService which depends on it\r\n  const adapterResult = container.registerClass(\r\n    journalVisibilityPortToken,\r\n    DIFoundryJournalVisibilityAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(adapterResult)) {\r\n    return err(`Failed to register JournalVisibilityAdapter: ${adapterResult.error.message}`);\r\n  }\r\n\r\n  // Register JournalVisibilityService\r\n  const journalVisibilityResult = container.registerClass(\r\n    journalVisibilityServiceToken,\r\n    DIJournalVisibilityService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(journalVisibilityResult)) {\r\n    return err(\r\n      `Failed to register JournalVisibility service: ${journalVisibilityResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryLibWrapperService\r\n  const libWrapperServiceResult = container.registerClass(\r\n    libWrapperServiceToken,\r\n    DIFoundryLibWrapperService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(libWrapperServiceResult)) {\r\n    return err(`Failed to register LibWrapperService: ${libWrapperServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register JournalContextMenuLibWrapperService\r\n  const contextMenuLibWrapperResult = container.registerClass(\r\n    journalContextMenuLibWrapperServiceToken,\r\n    DIJournalContextMenuLibWrapperService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(contextMenuLibWrapperResult)) {\r\n    return err(\r\n      `Failed to register JournalContextMenuLibWrapperService: ${contextMenuLibWrapperResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * Service for performance tracking with sampling support.\r\n * Provides centralized performance measurement with configurable sampling rates.\r\n *\r\n * This service wraps the performance tracking logic that was previously\r\n * implemented as utility functions, making it easier to:\r\n * - Inject via DI instead of passing ENV and MetricsCollector as parameters\r\n * - Test with mocks\r\n * - Configure centrally\r\n * - Add logging and metrics without modifying call sites\r\n *\r\n * **Design:**\r\n * Extends the shared PerformanceTrackerImpl base class to enable polymorphic usage\r\n * alongside BootstrapPerformanceTracker. This allows the same interface\r\n * to be used during bootstrap (no DI) and production (with DI).\r\n */\r\n\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport type { MetricsSampler } from \"@/infrastructure/observability/interfaces/metrics-sampler\";\r\nimport { runtimeConfigToken, metricsSamplerToken } from \"@/infrastructure/shared/tokens\";\r\nimport { PerformanceTrackerImpl } from \"@/infrastructure/observability/performance-tracker-impl\";\r\n\r\n/**\r\n * Service for tracking performance of operations.\r\n *\r\n * Extends the shared PerformanceTrackerImpl base class to eliminate code duplication\r\n * with BootstrapPerformanceTracker.\r\n *\r\n * @example\r\n * ```typescript\r\n * const perfService = container.resolve(performanceTrackingServiceToken);\r\n *\r\n * // Track sync operation\r\n * const result = perfService.track(\r\n *   () => expensiveOperation(),\r\n *   (duration, result) => {\r\n *     console.log(`Operation took ${duration}ms`);\r\n *   }\r\n * );\r\n *\r\n * // Track async operation\r\n * const result = await perfService.trackAsync(\r\n *   async () => await fetchData(),\r\n *   (duration, result) => {\r\n *     metricsCollector.recordOperation(duration, result.ok);\r\n *   }\r\n * );\r\n * ```\r\n */\r\nexport class PerformanceTrackingService extends PerformanceTrackerImpl {\r\n  constructor(config: RuntimeConfigService, sampler: MetricsSampler) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n\r\nexport class DIPerformanceTrackingService extends PerformanceTrackingService {\r\n  static dependencies = [runtimeConfigToken, metricsSamplerToken] as const;\r\n\r\n  constructor(config: RuntimeConfigService, sampler: MetricsSampler) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n","/**\r\n * Service for handling transient failures with automatic retry logic.\r\n * Provides retry operations with exponential backoff and optional logging.\r\n *\r\n * This service wraps the retry logic that was previously implemented\r\n * as utility functions, making it easier to:\r\n * - Inject via DI\r\n * - Add logging for retry attempts (via Logger)\r\n * - Configure default retry strategies zentral an einer Stelle\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { err } from \"@/infrastructure/shared/utils/result\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Options for retry operations.\r\n * Allows customization of retry behavior and error handling.\r\n */\r\nexport interface RetryOptions<ErrorType> {\r\n  /**\r\n   * Maximum number of retry attempts.\r\n   * Must be >= 1.\r\n   * @default 3\r\n   */\r\n  maxAttempts?: number;\r\n\r\n  /**\r\n   * Base delay in milliseconds between retry attempts.\r\n   * With exponential backoff: delayMs * attempt (100ms, 200ms, 300ms, ...)\r\n   * @default 100\r\n   */\r\n  delayMs?: number;\r\n\r\n  /**\r\n   * Exponential backoff factor.\r\n   * Delay = delayMs * (attempt ^ backoffFactor)\r\n   * @default 1 (linear backoff)\r\n   */\r\n  backoffFactor?: number;\r\n\r\n  /**\r\n   * Maps exceptions (thrown errors or unknown errors) to the expected ErrorType.\r\n   *\r\n   * REQUIRED for type safety. Prevents unsafe 'as ErrorType' casts that violate type guarantees.\r\n   *\r\n   * @param error - The caught exception (unknown type)\r\n   * @param attempt - The current attempt number (1-based)\r\n   * @returns A valid ErrorType instance\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await retryService.retry(\r\n   *   () => fetchData(),\r\n   *   {\r\n   *     maxAttempts: 3,\r\n   *     mapException: (error, attempt) => ({\r\n   *       code: 'OPERATION_FAILED' as const,\r\n   *       message: `Attempt ${attempt} failed: ${String(error)}`\r\n   *     })\r\n   *   }\r\n   * );\r\n   * ```\r\n   */\r\n  mapException: (error: unknown, attempt: number) => ErrorType;\r\n\r\n  /**\r\n   * Optional operation name for logging purposes.\r\n   * If provided, retry attempts will be logged.\r\n   */\r\n  operationName?: string;\r\n}\r\n\r\n/**\r\n * Service for retrying operations with exponential backoff.\r\n *\r\n * @example\r\n * ```typescript\r\n * const retryService = container.resolve(retryServiceToken);\r\n *\r\n * // Retry async operation\r\n * const result = await retryService.retry(\r\n *   () => foundryApi.fetchData(),\r\n *   {\r\n *     maxAttempts: 3,\r\n *     delayMs: 100,\r\n *     operationName: \"fetchData\",\r\n *     mapException: (error, attempt) => ({\r\n *       code: 'OPERATION_FAILED' as const,\r\n *       message: `Attempt ${attempt} failed: ${String(error)}`\r\n *     })\r\n *   }\r\n * );\r\n *\r\n * // Retry sync operation\r\n * const result = retryService.retrySync(\r\n *   () => parseData(input),\r\n *   { maxAttempts: 3 }\r\n * );\r\n * ```\r\n */\r\nexport class RetryService {\r\n  constructor(private readonly logger: Logger) {}\r\n\r\n  /**\r\n   * Retries an async operation with exponential backoff.\r\n   *\r\n   * Useful for handling transient failures in external APIs (e.g., Foundry API calls).\r\n   *\r\n   * @template SuccessType - The success type of the operation\r\n   * @template ErrorType - The error type of the operation\r\n   * @param fn - Async function that returns a Result\r\n   * @param options - Retry configuration options\r\n   * @returns Promise resolving to the Result (success or last error)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await retryService.retry(\r\n   *   () => foundryApi.fetchData(),\r\n   *   {\r\n   *     maxAttempts: 3,\r\n   *     delayMs: 100,\r\n   *     operationName: \"fetchData\",\r\n   *     mapException: (error, attempt) => ({\r\n   *       code: 'OPERATION_FAILED' as const,\r\n   *       message: `Attempt ${attempt} failed: ${String(error)}`\r\n   *     })\r\n   *   }\r\n   * );\r\n   * ```\r\n   */\r\n  async retry<SuccessType, ErrorType>(\r\n    fn: () => Promise<Result<SuccessType, ErrorType>>,\r\n    options: RetryOptions<ErrorType>\r\n  ): Promise<Result<SuccessType, ErrorType>> {\r\n    const maxAttempts = options.maxAttempts ?? 3;\r\n    const delayMs = options.delayMs ?? 100;\r\n    const backoffFactor = options.backoffFactor ?? 1;\r\n    const { mapException, operationName } = options;\r\n\r\n    // Validate maxAttempts to prevent undefined errors\r\n    if (maxAttempts < 1) {\r\n      return err(mapException(\"maxAttempts must be >= 1\", 0));\r\n    }\r\n\r\n    // Sentinel-Wert, damit lastError auch in theoretisch unerreichbaren Pfaden\r\n    // niemals undefined ist. Die eigentlichen Fehler werden in der Schleife gesetzt.\r\n    let lastError: ErrorType = mapException(\"Initial retry error\", 0);\r\n    const startTime = performance.now();\r\n\r\n    for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n      try {\r\n        // Wrap fn() in try/catch to handle thrown errors (breaks Result-Pattern)\r\n        const result = await fn();\r\n\r\n        if (result.ok) {\r\n          // Log success if this wasn't the first attempt\r\n          if (attempt > 1 && operationName) {\r\n            const duration = performance.now() - startTime;\r\n            this.logger.debug(\r\n              `Retry succeeded for \"${operationName}\" after ${attempt} attempts (${duration.toFixed(2)}ms)`\r\n            );\r\n          }\r\n          return result;\r\n        }\r\n\r\n        lastError = result.error;\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        // Log retry attempt\r\n        if (operationName) {\r\n          this.logger.debug(\r\n            `Retry attempt ${attempt}/${maxAttempts} failed for \"${operationName}\"`,\r\n            { error: lastError }\r\n          );\r\n        }\r\n\r\n        // Exponential backoff: delay * (attempt ^ backoffFactor)\r\n        const delay = delayMs * Math.pow(attempt, backoffFactor);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n      } catch (error) {\r\n        // Handle exception-based code that breaks Result-Pattern\r\n        // Use mapException to convert unknown error to ErrorType\r\n        lastError = mapException(error, attempt);\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        // Log exception\r\n        if (operationName) {\r\n          this.logger.warn(\r\n            `Retry attempt ${attempt}/${maxAttempts} threw exception for \"${operationName}\"`,\r\n            { error }\r\n          );\r\n        }\r\n\r\n        const delay = delayMs * Math.pow(attempt, backoffFactor);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n      }\r\n    }\r\n\r\n    // Record retry failure metric\r\n    if (operationName) {\r\n      const duration = performance.now() - startTime;\r\n      this.logger.warn(\r\n        `All retry attempts exhausted for \"${operationName}\" after ${maxAttempts} attempts (${duration.toFixed(2)}ms)`\r\n      );\r\n    }\r\n\r\n    return err(lastError);\r\n  }\r\n\r\n  /**\r\n   * Retries a synchronous operation.\r\n   * Similar to retry but for sync functions.\r\n   *\r\n   * @template SuccessType - The success type\r\n   * @template ErrorType - The error type\r\n   * @param fn - Function that returns a Result\r\n   * @param options - Retry configuration options\r\n   * @returns The Result (success or last error)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = retryService.retrySync(\r\n   *   () => parseData(input),\r\n   *   {\r\n   *     maxAttempts: 3,\r\n   *     operationName: \"parseData\",\r\n   *     mapException: (error, attempt) => ({\r\n   *       code: 'PARSE_FAILED' as const,\r\n   *       message: `Parse attempt ${attempt} failed: ${String(error)}`\r\n   *     })\r\n   *   }\r\n   * );\r\n   * ```\r\n   */\r\n  retrySync<SuccessType, ErrorType>(\r\n    fn: () => Result<SuccessType, ErrorType>,\r\n    options: Omit<RetryOptions<ErrorType>, \"delayMs\" | \"backoffFactor\">\r\n  ): Result<SuccessType, ErrorType> {\r\n    const maxAttempts = options.maxAttempts ?? 3;\r\n    const { mapException, operationName } = options;\r\n\r\n    // Validate maxAttempts to prevent undefined errors\r\n    if (maxAttempts < 1) {\r\n      return err(mapException(\"maxAttempts must be >= 1\", 0));\r\n    }\r\n\r\n    // Sentinel-Wert, damit lastError auch in theoretisch unerreichbaren Pfaden\r\n    // niemals undefined ist. Die eigentlichen Fehler werden in der Schleife gesetzt.\r\n    let lastError: ErrorType = mapException(\"Initial retry error\", 0);\r\n\r\n    for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n      try {\r\n        // Wrap fn() in try/catch to handle thrown errors (breaks Result-Pattern)\r\n        const result = fn();\r\n\r\n        if (result.ok) {\r\n          // Log success if this wasn't the first attempt\r\n          if (attempt > 1 && operationName) {\r\n            this.logger.debug(`Retry succeeded for \"${operationName}\" after ${attempt} attempts`);\r\n          }\r\n          return result;\r\n        }\r\n\r\n        lastError = result.error;\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        // Log retry attempt\r\n        if (operationName) {\r\n          this.logger.debug(\r\n            `Retry attempt ${attempt}/${maxAttempts} failed for \"${operationName}\"`,\r\n            { error: lastError }\r\n          );\r\n        }\r\n      } catch (error) {\r\n        // Handle exception-based code that breaks Result-Pattern\r\n        // Use mapException to convert unknown error to ErrorType\r\n        lastError = mapException(error, attempt);\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        // Log exception\r\n        if (operationName) {\r\n          this.logger.warn(\r\n            `Retry attempt ${attempt}/${maxAttempts} threw exception for \"${operationName}\"`,\r\n            { error }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    // Log retry failure\r\n    if (operationName) {\r\n      this.logger.warn(\r\n        `All retry attempts exhausted for \"${operationName}\" after ${maxAttempts} attempts`\r\n      );\r\n    }\r\n\r\n    return err(lastError);\r\n  }\r\n}\r\n\r\nexport class DIRetryService extends RetryService {\r\n  static dependencies = [loggerToken] as const;\r\n\r\n  constructor(logger: Logger) {\r\n    super(logger);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { performanceTrackingServiceToken, retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { DIPerformanceTrackingService } from \"@/infrastructure/performance/PerformanceTrackingService\";\r\nimport { DIRetryService } from \"@/infrastructure/retry/RetryService\";\r\n\r\n/**\r\n * Registers utility services.\r\n *\r\n * Services registered:\r\n * - PerformanceTrackingService (singleton)\r\n * - RetryService (singleton)\r\n *\r\n * These services provide cross-cutting concerns like performance tracking\r\n * and retry logic with exponential backoff.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerUtilityServices(container: ServiceContainer): Result<void, string> {\r\n  // Register PerformanceTrackingService\r\n  const perfTrackingResult = container.registerClass(\r\n    performanceTrackingServiceToken,\r\n    DIPerformanceTrackingService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(perfTrackingResult)) {\r\n    return err(\r\n      `Failed to register PerformanceTrackingService: ${perfTrackingResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register RetryService\r\n  const retryServiceResult = container.registerClass(\r\n    retryServiceToken,\r\n    DIRetryService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(retryServiceResult)) {\r\n    return err(`Failed to register RetryService: ${retryServiceResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type {\r\n  CacheEntryMetadata,\r\n  CacheInvalidationPredicate,\r\n  CacheKey,\r\n  CacheLookupResult,\r\n  CacheService as CacheServiceContract,\r\n  CacheServiceConfig,\r\n  CacheSetOptions,\r\n  CacheStatistics,\r\n} from \"./cache.interface\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport { castCacheValue } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport {\r\n  cacheServiceConfigToken,\r\n  metricsCollectorToken,\r\n  runtimeConfigToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, fromPromise } from \"@/infrastructure/shared/utils/result\";\r\n\r\ntype InternalCacheEntry = {\r\n  value: unknown;\r\n  expiresAt: number | null;\r\n  metadata: CacheEntryMetadata;\r\n};\r\n\r\nexport const DEFAULT_CACHE_SERVICE_CONFIG: CacheServiceConfig = {\r\n  enabled: true,\r\n  defaultTtlMs: MODULE_CONSTANTS.DEFAULTS.CACHE_TTL_MS,\r\n  namespace: \"global\",\r\n};\r\n\r\nfunction clampTtl(ttl: number | undefined, fallback: number): number {\r\n  if (typeof ttl !== \"number\" || Number.isNaN(ttl)) {\r\n    return fallback;\r\n  }\r\n  return ttl < 0 ? 0 : ttl;\r\n}\r\n\r\nexport class CacheService implements CacheServiceContract {\r\n  private readonly store = new Map<CacheKey, InternalCacheEntry>();\r\n  private readonly stats = {\r\n    hits: 0,\r\n    misses: 0,\r\n    evictions: 0,\r\n  };\r\n\r\n  private config: CacheServiceConfig;\r\n  private runtimeConfigUnsubscribe: (() => void) | null = null;\r\n\r\n  constructor(\r\n    config: CacheServiceConfig = DEFAULT_CACHE_SERVICE_CONFIG,\r\n    private readonly metricsCollector?: MetricsCollector,\r\n    private readonly clock: () => number = () => Date.now(),\r\n    runtimeConfig?: RuntimeConfigService\r\n  ) {\r\n    const resolvedMaxEntries =\r\n      typeof config?.maxEntries === \"number\" && config.maxEntries > 0\r\n        ? config.maxEntries\r\n        : undefined;\r\n\r\n    this.config = {\r\n      ...DEFAULT_CACHE_SERVICE_CONFIG,\r\n      ...config,\r\n      defaultTtlMs: clampTtl(config?.defaultTtlMs, DEFAULT_CACHE_SERVICE_CONFIG.defaultTtlMs),\r\n      ...(resolvedMaxEntries !== undefined ? { maxEntries: resolvedMaxEntries } : {}),\r\n    };\r\n\r\n    this.bindRuntimeConfig(runtimeConfig);\r\n  }\r\n\r\n  get isEnabled(): boolean {\r\n    return this.config.enabled;\r\n  }\r\n\r\n  get size(): number {\r\n    return this.store.size;\r\n  }\r\n\r\n  get<TValue>(key: CacheKey): CacheLookupResult<TValue> | null {\r\n    return this.accessEntry<TValue>(key, true);\r\n  }\r\n\r\n  async getOrSet<TValue>(\r\n    key: CacheKey,\r\n    factory: () => TValue | Promise<TValue>,\r\n    options?: CacheSetOptions\r\n  ): Promise<Result<CacheLookupResult<TValue>, string>> {\r\n    const existing = this.get<TValue>(key);\r\n    if (existing) {\r\n      return ok(existing);\r\n    }\r\n\r\n    // Wrap factory() to handle both sync and async errors\r\n    // Use try-catch for sync errors, fromPromise for async errors\r\n    let factoryValue: TValue;\r\n    try {\r\n      const factoryResult = factory();\r\n      // If factory returns a Promise, use fromPromise\r\n      if (factoryResult instanceof Promise) {\r\n        const asyncResult = await fromPromise(\r\n          factoryResult,\r\n          (error) => `Factory failed for cache key ${String(key)}: ${String(error)}`\r\n        );\r\n        if (!asyncResult.ok) {\r\n          return asyncResult;\r\n        }\r\n        factoryValue = asyncResult.value;\r\n      } else {\r\n        // Synchronous result\r\n        factoryValue = factoryResult;\r\n      }\r\n    } catch (error) {\r\n      // Synchronous error from factory()\r\n      return err(`Factory failed for cache key ${String(key)}: ${String(error)}`);\r\n    }\r\n\r\n    const metadata = this.set(key, factoryValue, options);\r\n    return ok({\r\n      hit: false,\r\n      value: factoryValue,\r\n      metadata,\r\n    });\r\n  }\r\n\r\n  set<TValue>(key: CacheKey, value: TValue, options?: CacheSetOptions): CacheEntryMetadata {\r\n    const now = this.clock();\r\n    const metadata = this.createMetadata(key, options, now);\r\n\r\n    if (!this.isEnabled) {\r\n      return metadata;\r\n    }\r\n\r\n    const entry: InternalCacheEntry = {\r\n      value,\r\n      expiresAt: metadata.expiresAt,\r\n      metadata,\r\n    };\r\n\r\n    this.store.set(key, entry);\r\n    this.enforceCapacity();\r\n    return { ...metadata, tags: [...metadata.tags] };\r\n  }\r\n\r\n  delete(key: CacheKey): boolean {\r\n    if (!this.isEnabled) return false;\r\n    const removed = this.store.delete(key);\r\n    if (removed) {\r\n      this.stats.evictions++;\r\n    }\r\n    return removed;\r\n  }\r\n\r\n  has(key: CacheKey): boolean {\r\n    return Boolean(this.accessEntry(key, false));\r\n  }\r\n\r\n  clear(): number {\r\n    if (!this.isEnabled) return 0;\r\n    return this.clearStore();\r\n  }\r\n\r\n  invalidateWhere(predicate: CacheInvalidationPredicate): number {\r\n    if (!this.isEnabled) return 0;\r\n\r\n    let removed = 0;\r\n    for (const [key, entry] of this.store.entries()) {\r\n      if (predicate(entry.metadata)) {\r\n        this.store.delete(key);\r\n        removed++;\r\n      }\r\n    }\r\n\r\n    if (removed > 0) {\r\n      this.stats.evictions += removed;\r\n    }\r\n\r\n    return removed;\r\n  }\r\n\r\n  getMetadata(key: CacheKey): CacheEntryMetadata | null {\r\n    if (!this.isEnabled) return null;\r\n\r\n    const entry = this.store.get(key) as InternalCacheEntry | undefined;\r\n    if (!entry) return null;\r\n    if (this.isExpired(entry)) {\r\n      this.handleExpiration(key);\r\n      return null;\r\n    }\r\n    return this.cloneMetadata(entry.metadata);\r\n  }\r\n\r\n  getStatistics(): CacheStatistics {\r\n    return {\r\n      hits: this.stats.hits,\r\n      misses: this.stats.misses,\r\n      evictions: this.stats.evictions,\r\n      size: this.store.size,\r\n      enabled: this.isEnabled,\r\n    };\r\n  }\r\n\r\n  private accessEntry<TValue>(\r\n    key: CacheKey,\r\n    mutateUsage: boolean\r\n  ): CacheLookupResult<TValue> | null {\r\n    if (!this.isEnabled) {\r\n      return null; // Keine Metrics tracken wenn disabled\r\n    }\r\n\r\n    const entry = this.store.get(key);\r\n    if (!entry) {\r\n      this.recordMiss();\r\n      return null;\r\n    }\r\n\r\n    if (this.isExpired(entry)) {\r\n      this.handleExpiration(key);\r\n      this.recordMiss();\r\n      return null;\r\n    }\r\n\r\n    if (mutateUsage) {\r\n      entry.metadata.hits += 1;\r\n      entry.metadata.lastAccessedAt = this.clock();\r\n    }\r\n\r\n    this.recordHit();\r\n\r\n    return {\r\n      hit: true,\r\n      value: castCacheValue<TValue>(entry.value),\r\n      metadata: this.cloneMetadata(entry.metadata),\r\n    };\r\n  }\r\n\r\n  private recordHit(): void {\r\n    this.metricsCollector?.recordCacheAccess(true);\r\n    this.stats.hits++;\r\n  }\r\n\r\n  private recordMiss(): void {\r\n    this.metricsCollector?.recordCacheAccess(false);\r\n    this.stats.misses++;\r\n  }\r\n\r\n  private handleExpiration(key: CacheKey): void {\r\n    if (this.store.delete(key)) {\r\n      this.stats.evictions++;\r\n    }\r\n  }\r\n\r\n  private isExpired(entry: InternalCacheEntry): boolean {\r\n    return (\r\n      typeof entry.expiresAt === \"number\" && entry.expiresAt > 0 && entry.expiresAt <= this.clock()\r\n    );\r\n  }\r\n\r\n  private enforceCapacity(): void {\r\n    if (!this.config.maxEntries || this.store.size <= this.config.maxEntries) {\r\n      return;\r\n    }\r\n\r\n    while (this.store.size > this.config.maxEntries) {\r\n      let lruKey: CacheKey | null = null;\r\n      let oldestTimestamp = Number.POSITIVE_INFINITY;\r\n\r\n      for (const [key, entry] of this.store.entries()) {\r\n        if (entry.metadata.lastAccessedAt < oldestTimestamp) {\r\n          oldestTimestamp = entry.metadata.lastAccessedAt;\r\n          lruKey = key;\r\n        }\r\n      }\r\n\r\n      if (!lruKey) {\r\n        break;\r\n      }\r\n\r\n      this.store.delete(lruKey);\r\n      this.stats.evictions++;\r\n    }\r\n  }\r\n\r\n  private createMetadata(\r\n    key: CacheKey,\r\n    options: CacheSetOptions | undefined,\r\n    now: number\r\n  ): CacheEntryMetadata {\r\n    const ttlMs = clampTtl(options?.ttlMs, this.config.defaultTtlMs);\r\n    const expiresAt = ttlMs > 0 ? now + ttlMs : null;\r\n    const tags = options?.tags ? Array.from(new Set(options.tags.map((tag) => String(tag)))) : [];\r\n\r\n    return {\r\n      key,\r\n      createdAt: now,\r\n      expiresAt,\r\n      lastAccessedAt: now,\r\n      hits: 0,\r\n      tags,\r\n    };\r\n  }\r\n\r\n  private cloneMetadata(metadata: CacheEntryMetadata): CacheEntryMetadata {\r\n    return {\r\n      ...metadata,\r\n      tags: [...metadata.tags],\r\n    };\r\n  }\r\n\r\n  private updateConfig(partial: Partial<CacheServiceConfig>): void {\r\n    const merged: CacheServiceConfig = {\r\n      ...this.config,\r\n      ...partial,\r\n    };\r\n\r\n    merged.defaultTtlMs = clampTtl(merged.defaultTtlMs, DEFAULT_CACHE_SERVICE_CONFIG.defaultTtlMs);\r\n\r\n    this.config = merged;\r\n\r\n    if (!this.isEnabled) {\r\n      this.clearStore();\r\n      return;\r\n    }\r\n\r\n    if (typeof this.config.maxEntries === \"number\") {\r\n      this.enforceCapacity();\r\n    }\r\n  }\r\n\r\n  private bindRuntimeConfig(runtimeConfig?: RuntimeConfigService): void {\r\n    if (!runtimeConfig) {\r\n      return;\r\n    }\r\n\r\n    this.runtimeConfigUnsubscribe?.();\r\n\r\n    const unsubscribers: Array<() => void> = [];\r\n    unsubscribers.push(\r\n      runtimeConfig.onChange(\"enableCacheService\", (enabled) => {\r\n        this.updateConfig({ enabled });\r\n      })\r\n    );\r\n    unsubscribers.push(\r\n      runtimeConfig.onChange(\"cacheDefaultTtlMs\", (ttl) => {\r\n        this.updateConfig({ defaultTtlMs: ttl });\r\n      })\r\n    );\r\n    unsubscribers.push(\r\n      runtimeConfig.onChange(\"cacheMaxEntries\", (maxEntries) => {\r\n        this.updateConfig({\r\n          maxEntries: typeof maxEntries === \"number\" && maxEntries > 0 ? maxEntries : undefined,\r\n        });\r\n      })\r\n    );\r\n\r\n    this.runtimeConfigUnsubscribe = () => {\r\n      for (const unsubscribe of unsubscribers) {\r\n        unsubscribe();\r\n      }\r\n    };\r\n  }\r\n\r\n  private clearStore(): number {\r\n    const removed = this.store.size;\r\n    this.store.clear();\r\n    if (removed > 0) {\r\n      this.stats.evictions += removed;\r\n    }\r\n    return removed;\r\n  }\r\n}\r\n\r\nexport class DICacheService extends CacheService {\r\n  static dependencies = [\r\n    cacheServiceConfigToken,\r\n    metricsCollectorToken,\r\n    runtimeConfigToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    config: CacheServiceConfig,\r\n    metrics: MetricsCollector,\r\n    runtimeConfig: RuntimeConfigService\r\n  ) {\r\n    super(config, metrics, undefined, runtimeConfig);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  cacheServiceConfigToken,\r\n  cacheServiceToken,\r\n  runtimeConfigToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport type { CacheServiceConfig } from \"@/infrastructure/cache/cache.interface\";\r\nimport { DICacheService } from \"@/infrastructure/cache/CacheService\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\n\r\n/**\r\n * Registers CacheService and its configuration.\r\n *\r\n * Reads defaults from RuntimeConfigService to make cache tuning possible\r\n * through build-time variables and Foundry settings instead of code changes.\r\n *\r\n * @param container - Root service container used during bootstrap\r\n * @returns Result with `void` on success or error message if registration fails\r\n */\r\nexport function registerCacheServices(container: ServiceContainer): Result<void, string> {\r\n  const runtimeConfig: RuntimeConfigService | null =\r\n    container.getRegisteredValue(runtimeConfigToken);\r\n  if (!runtimeConfig) {\r\n    return err(\"RuntimeConfigService not registered\");\r\n  }\r\n\r\n  const maxEntries = runtimeConfig.get(\"cacheMaxEntries\");\r\n  const config: CacheServiceConfig = {\r\n    enabled: runtimeConfig.get(\"enableCacheService\"),\r\n    defaultTtlMs: runtimeConfig.get(\"cacheDefaultTtlMs\"),\r\n    namespace: MODULE_CONSTANTS.MODULE.ID,\r\n    ...(typeof maxEntries === \"number\" && maxEntries > 0 ? { maxEntries } : {}),\r\n  };\r\n\r\n  const configResult = container.registerValue(cacheServiceConfigToken, config);\r\n  if (isErr(configResult)) {\r\n    return err(`Failed to register CacheServiceConfig: ${configResult.error.message}`);\r\n  }\r\n\r\n  const serviceResult = container.registerClass(\r\n    cacheServiceToken,\r\n    DICacheService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(serviceResult)) {\r\n    return err(`Failed to register CacheService: ${serviceResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryI18n } from \"../interfaces/FoundryI18n\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport {\r\n  portSelectorToken,\r\n  foundryI18nPortRegistryToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens\";\r\nimport { FoundryServiceBase } from \"./FoundryServiceBase\";\r\n\r\n/**\r\n * Port wrapper for FoundryI18n that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Extends FoundryServiceBase for consistent port selection and retry logic.\r\n */\r\nexport class FoundryI18nPort extends FoundryServiceBase<FoundryI18n> implements FoundryI18n {\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryI18n>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n\r\n  localize(key: string): Result<string, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.localize(key);\r\n    }, \"FoundryI18n.localize\");\r\n  }\r\n\r\n  format(key: string, data: Record<string, unknown>): Result<string, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.format(key, data);\r\n    }, \"FoundryI18n.format\");\r\n  }\r\n\r\n  has(key: string): Result<boolean, FoundryError> {\r\n    return this.withRetry(() => {\r\n      const portResult = this.getPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.has(key);\r\n    }, \"FoundryI18n.has\");\r\n  }\r\n}\r\n\r\nexport class DIFoundryI18nPort extends FoundryI18nPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryI18nPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryI18n>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Escapes special regex characters in a string.\r\n * Prevents regex injection when using user-provided strings in RegExp.\r\n *\r\n * @param str - String to escape\r\n * @returns Escaped string safe for use in RegExp\r\n */\r\nfunction escapeRegex(str: string): string {\r\n  return str.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n}\r\n\r\n/**\r\n * Local, Foundry-independent internationalization service.\r\n *\r\n * Provides fallback translations from JSON files when Foundry's i18n is unavailable.\r\n * Uses browser's locale detection for automatic language selection.\r\n *\r\n * **Design:**\r\n * - No Foundry dependency (can be used outside Foundry VTT)\r\n * - JSON-based translations loaded from `lang/` directory\r\n * - Browser locale detection via `navigator.language`\r\n * - Simple key-value lookup with fallback to key itself\r\n */\r\nexport class LocalI18nService {\r\n  static dependencies = [] as const;\r\n\r\n  private translations: Map<string, string> = new Map();\r\n  private currentLocale: string = \"en\";\r\n\r\n  constructor() {\r\n    this.detectLocale();\r\n  }\r\n\r\n  /**\r\n   * Detects browser locale and sets current language.\r\n   * Falls back to 'en' if detection fails.\r\n   */\r\n  private detectLocale(): void {\r\n    if (typeof navigator !== \"undefined\" && navigator.language) {\r\n      // Extract base language from locale (e.g., \"de-DE\" → \"de\")\r\n      const lang = navigator.language.split(\"-\")[0];\r\n      this.currentLocale = lang ?? \"en\";\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads translations from a JSON object.\r\n   * Useful for testing or pre-loaded translation data.\r\n   *\r\n   * @param translations - Object with key-value pairs\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const i18n = new LocalI18nService();\r\n   * i18n.loadTranslations({\r\n   *   \"MODULE.SETTINGS.logLevel.name\": \"Log Level\",\r\n   *   \"MODULE.WELCOME\": \"Welcome, {name}!\"\r\n   * });\r\n   * ```\r\n   */\r\n  loadTranslations(translations: Record<string, string>): void {\r\n    for (const [key, value] of Object.entries(translations)) {\r\n      this.translations.set(key, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Translates a key using local translations.\r\n   *\r\n   * @param key - Translation key\r\n   * @returns Result with translated string (or key itself if not found)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Enable Feature\" or key if not found\r\n   * }\r\n   * ```\r\n   */\r\n  translate(key: string): Result<string, string> {\r\n    const value = this.translations.get(key);\r\n    return ok(value ?? key); // Fallback to key itself if not found\r\n  }\r\n\r\n  /**\r\n   * Formats a string with placeholders.\r\n   * Simple implementation: replaces `{key}` with values from data object.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @returns Result with formatted string\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // Translation: \"Welcome, {name}!\"\r\n   * const result = i18n.format(\"MODULE.WELCOME\", { name: \"Alice\" });\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Welcome, Alice!\"\r\n   * }\r\n   * ```\r\n   */\r\n  format(key: string, data: Record<string, unknown>): Result<string, string> {\r\n    const template = this.translations.get(key) ?? key;\r\n    let formatted = template;\r\n\r\n    // Simple placeholder replacement: {key} → value\r\n    // Escape placeholder to prevent regex injection with special characters\r\n    for (const [placeholder, value] of Object.entries(data)) {\r\n      const escapedPlaceholder = escapeRegex(placeholder);\r\n      const regex = new RegExp(`\\\\{${escapedPlaceholder}\\\\}`, \"g\");\r\n      formatted = formatted.replace(regex, String(value));\r\n    }\r\n\r\n    return ok(formatted);\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with boolean\r\n   */\r\n  has(key: string): Result<boolean, string> {\r\n    return ok(this.translations.has(key));\r\n  }\r\n\r\n  /**\r\n   * Gets the current locale.\r\n   *\r\n   * @returns Current locale string (e.g., \"en\", \"de\")\r\n   */\r\n  getCurrentLocale(): string {\r\n    return this.currentLocale;\r\n  }\r\n\r\n  /**\r\n   * Sets the current locale.\r\n   * Note: Changing locale requires reloading translations for the new language.\r\n   *\r\n   * @param locale - Locale code (e.g., \"en\", \"de\", \"fr\")\r\n   */\r\n  setLocale(locale: string): void {\r\n    this.currentLocale = locale;\r\n  }\r\n}\r\n\r\nexport class DILocalI18nService extends LocalI18nService {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { LocalI18nService } from \"./LocalI18nService\";\r\nimport { localI18nToken, translationHandlerChainToken } from \"@/infrastructure/shared/tokens\";\r\nimport type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Facade service that combines Foundry's i18n and local fallback translations.\r\n *\r\n * **Pattern: Chain of Responsibility (via DI)**\r\n * 1. FoundryTranslationHandler → Try Foundry's `game.i18n`\r\n * 2. LocalTranslationHandler → Try local JSON-based translations\r\n * 3. FallbackTranslationHandler → Return key itself or provided fallback string\r\n *\r\n * Each handler tries to provide a translation. If it can't, it delegates to the next.\r\n *\r\n * **Dependency Injection:**\r\n * The handler chain is injected via DI, maintaining SOLID principles.\r\n * No `new` in application code - handlers are registered in DI container.\r\n *\r\n * **Use Cases:**\r\n * - Development/testing without Foundry runtime (uses LocalI18nService)\r\n * - Production with Foundry VTT (uses FoundryI18nPort)\r\n * - Graceful degradation when translations are missing\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(i18nFacadeToken);\r\n *\r\n * // Try Foundry first, then local, then fallback\r\n * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\");\r\n * if (result.ok) {\r\n *   console.log(result.value); // Translated or fallback\r\n * }\r\n * ```\r\n */\r\nexport class I18nFacadeService {\r\n  constructor(\r\n    private readonly handlerChain: TranslationHandler,\r\n    private readonly localI18n: LocalI18nService\r\n  ) {}\r\n\r\n  /**\r\n   * Translates a key using the handler chain: Foundry → Local → Fallback.\r\n   *\r\n   * @param key - Translation key\r\n   * @param fallback - Optional fallback string (defaults to key itself)\r\n   * @returns Result with translated string or fallback\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // With fallback\r\n   * const result = i18n.translate(\"MODULE.UNKNOWN_KEY\", \"Default Text\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Default Text\"\r\n   * }\r\n   *\r\n   * // Without fallback (returns key as fallback)\r\n   * const result2 = i18n.translate(\"MODULE.UNKNOWN_KEY\");\r\n   * if (result2.ok) {\r\n   *   console.log(result2.value); // \"MODULE.UNKNOWN_KEY\"\r\n   * }\r\n   * ```\r\n   */\r\n  translate(key: string, fallback?: string): Result<string, string> {\r\n    // Delegate to chain - it will try Foundry → Local → Fallback\r\n    return this.handlerChain.handle(key, undefined, fallback);\r\n  }\r\n\r\n  /**\r\n   * Formats a string with placeholders using the handler chain.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @param fallback - Optional fallback string\r\n   * @returns Result with formatted string or fallback\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = i18n.format(\"MODULE.WELCOME\", { name: \"Alice\" }, \"Welcome!\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Welcome, Alice!\" or \"Welcome!\"\r\n   * }\r\n   * ```\r\n   */\r\n  format(key: string, data: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    // Delegate to chain - it will try Foundry → Local → Fallback\r\n    return this.handlerChain.handle(key, data, fallback);\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists in the handler chain.\r\n   * Checks Foundry → Local (Fallback always returns false for has()).\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with true if key exists in Foundry or local i18n\r\n   */\r\n  has(key: string): Result<boolean, string> {\r\n    // Delegate to chain\r\n    return this.handlerChain.has(key);\r\n  }\r\n\r\n  /**\r\n   * Loads local translations from a JSON object.\r\n   * Useful for initializing translations on module startup.\r\n   *\r\n   * @param translations - Object with key-value pairs\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * i18n.loadLocalTranslations({\r\n   *   \"MODULE.SETTINGS.logLevel.name\": \"Log Level\",\r\n   *   \"MODULE.WELCOME\": \"Welcome, {name}!\"\r\n   * });\r\n   * ```\r\n   */\r\n  loadLocalTranslations(translations: Record<string, string>): void {\r\n    this.localI18n.loadTranslations(translations);\r\n  }\r\n}\r\n\r\nexport class DII18nFacadeService extends I18nFacadeService {\r\n  static dependencies = [translationHandlerChainToken, localI18nToken] as const;\r\n\r\n  constructor(handlerChain: TranslationHandler, localI18n: LocalI18nService) {\r\n    super(handlerChain, localI18n);\r\n  }\r\n}\r\n","import type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Abstract base class for translation handlers.\r\n * Implements the Chain of Responsibility pattern.\r\n *\r\n * Concrete handlers only need to implement:\r\n * - doHandle() - the actual translation logic\r\n * - doHas() - the key existence check\r\n */\r\nexport abstract class AbstractTranslationHandler implements TranslationHandler {\r\n  private nextHandler: TranslationHandler | null = null;\r\n\r\n  setNext(handler: TranslationHandler): TranslationHandler {\r\n    this.nextHandler = handler;\r\n    return handler; // Return handler for fluent chaining: a.setNext(b).setNext(c)\r\n  }\r\n\r\n  handle(key: string, data?: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    // Try to handle the request ourselves\r\n    const result = this.doHandle(key, data, fallback);\r\n    if (result.ok) {\r\n      return result;\r\n    }\r\n\r\n    // Delegate to next handler if available\r\n    if (this.nextHandler) {\r\n      return this.nextHandler.handle(key, data, fallback);\r\n    }\r\n\r\n    // No handler in chain could provide translation\r\n    // If fallback provided, use it; otherwise return error\r\n    if (fallback !== undefined) {\r\n      return ok(fallback);\r\n    }\r\n    return err(`Translation key not found: ${key}`);\r\n  }\r\n\r\n  has(key: string): Result<boolean, string> {\r\n    // Check our own source first\r\n    const ourResult = this.doHas(key);\r\n    if (!ourResult.ok) {\r\n      // Propagate error from doHas()\r\n      return ourResult;\r\n    }\r\n    if (ourResult.value) {\r\n      return ok(true);\r\n    }\r\n\r\n    // Check next handler if available\r\n    if (this.nextHandler) {\r\n      return this.nextHandler.has(key);\r\n    }\r\n\r\n    // No handler found the key\r\n    return ok(false);\r\n  }\r\n\r\n  /**\r\n   * Concrete implementation of translation logic.\r\n   * Should return Result with translated string, or error if this handler can't provide it.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Optional data for placeholder replacement\r\n   * @param fallback - Optional fallback string\r\n   * @returns Result with translated string or error\r\n   */\r\n  protected abstract doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    fallback?: string\r\n  ): Result<string, string>;\r\n\r\n  /**\r\n   * Concrete implementation of key existence check.\r\n   * Should return Result with true if this handler's source contains the key.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with true if key exists in this handler's source, false otherwise, or error\r\n   */\r\n  protected abstract doHas(key: string): Result<boolean, string>;\r\n}\r\n","import type { FoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\nimport { foundryI18nToken } from \"@/infrastructure/shared/tokens\";\r\nimport { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Translation handler that uses Foundry's i18n system.\r\n *\r\n * First handler in the chain: tries Foundry's game.i18n first.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n */\r\nexport class FoundryTranslationHandler extends AbstractTranslationHandler {\r\n  constructor(private readonly foundryI18n: FoundryI18nPort) {\r\n    super();\r\n  }\r\n\r\n  protected doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    _fallback?: string\r\n  ): Result<string, string> {\r\n    // Use format() if data is provided, otherwise localize()\r\n    const result = data ? this.foundryI18n.format(key, data) : this.foundryI18n.localize(key);\r\n\r\n    if (result.ok && result.value !== key) {\r\n      // Foundry has a translation (not just returning the key)\r\n      return ok(result.value);\r\n    }\r\n\r\n    // Can't handle - return error to delegate to next handler\r\n    return err(`Foundry i18n could not translate key: ${key}`);\r\n  }\r\n\r\n  protected doHas(key: string): Result<boolean, string> {\r\n    const result = this.foundryI18n.has(key);\r\n    if (!result.ok) {\r\n      return err(`Failed to check Foundry i18n for key: ${key}`);\r\n    }\r\n    return ok(result.value);\r\n  }\r\n}\r\n\r\nexport class DIFoundryTranslationHandler extends FoundryTranslationHandler {\r\n  static dependencies = [foundryI18nToken] as const;\r\n\r\n  constructor(foundryI18n: FoundryI18nPort) {\r\n    super(foundryI18n);\r\n  }\r\n}\r\n","import type { LocalI18nService } from \"./LocalI18nService\";\r\nimport { localI18nToken } from \"@/infrastructure/shared/tokens\";\r\nimport { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Translation handler that uses local JSON-based translations.\r\n *\r\n * Second handler in the chain: provides fallback when Foundry i18n unavailable.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n */\r\nexport class LocalTranslationHandler extends AbstractTranslationHandler {\r\n  constructor(private readonly localI18n: LocalI18nService) {\r\n    super();\r\n  }\r\n\r\n  protected doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    _fallback?: string\r\n  ): Result<string, string> {\r\n    // Use format() if data is provided, otherwise translate()\r\n    const result = data ? this.localI18n.format(key, data) : this.localI18n.translate(key);\r\n\r\n    if (result.ok && result.value !== key) {\r\n      // Local i18n has a translation (not just returning the key)\r\n      return ok(result.value);\r\n    }\r\n\r\n    // Can't handle - return error to delegate to next handler\r\n    return err(`Local i18n could not translate key: ${key}`);\r\n  }\r\n\r\n  protected doHas(key: string): Result<boolean, string> {\r\n    const result = this.localI18n.has(key);\r\n    if (!result.ok) {\r\n      return err(`Failed to check local i18n for key: ${key}`);\r\n    }\r\n    return ok(result.value);\r\n  }\r\n}\r\n\r\nexport class DILocalTranslationHandler extends LocalTranslationHandler {\r\n  static dependencies = [localI18nToken] as const;\r\n\r\n  constructor(localI18n: LocalI18nService) {\r\n    super(localI18n);\r\n  }\r\n}\r\n","import { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Final fallback handler in the translation chain.\r\n *\r\n * Always succeeds by returning the fallback string or the key itself.\r\n * Should be the last handler in the chain.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n * Has no dependencies (stateless).\r\n */\r\nexport class FallbackTranslationHandler extends AbstractTranslationHandler {\r\n  static dependencies = [] as const;\r\n  protected doHandle(\r\n    key: string,\r\n    _data?: Record<string, unknown>,\r\n    fallback?: string\r\n  ): Result<string, string> {\r\n    // Always return something: fallback or key\r\n    return ok(fallback ?? key);\r\n  }\r\n\r\n  protected doHas(_key: string): Result<boolean, string> {\r\n    // Fallback handler doesn't \"have\" any keys\r\n    // It just provides the fallback, so return false\r\n    return ok(false);\r\n  }\r\n}\r\n\r\nexport class DIFallbackTranslationHandler extends FallbackTranslationHandler {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import {\r\n  fallbackTranslationHandlerToken,\r\n  foundryTranslationHandlerToken,\r\n  localTranslationHandlerToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Small façade that wires the translation handlers into a chain of responsibility.\r\n * The Foundry handler is considered the head of the chain and receives requests first.\r\n */\r\nexport class TranslationHandlerChain implements TranslationHandler {\r\n  private readonly head: TranslationHandler;\r\n\r\n  constructor(\r\n    foundryHandler: TranslationHandler,\r\n    localHandler: TranslationHandler,\r\n    fallbackHandler: TranslationHandler\r\n  ) {\r\n    this.head = foundryHandler;\r\n    this.head.setNext(localHandler).setNext(fallbackHandler);\r\n  }\r\n\r\n  setNext(handler: TranslationHandler): TranslationHandler {\r\n    return this.head.setNext(handler);\r\n  }\r\n\r\n  handle(key: string, data?: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    return this.head.handle(key, data, fallback);\r\n  }\r\n\r\n  has(key: string): Result<boolean, string> {\r\n    return this.head.has(key);\r\n  }\r\n}\r\n\r\nexport class DITranslationHandlerChain extends TranslationHandlerChain {\r\n  static dependencies = [\r\n    foundryTranslationHandlerToken,\r\n    localTranslationHandlerToken,\r\n    fallbackTranslationHandlerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    foundryHandler: TranslationHandler,\r\n    localHandler: TranslationHandler,\r\n    fallbackHandler: TranslationHandler\r\n  ) {\r\n    super(foundryHandler, localHandler, fallbackHandler);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  foundryI18nToken,\r\n  localI18nToken,\r\n  i18nFacadeToken,\r\n  foundryTranslationHandlerToken,\r\n  localTranslationHandlerToken,\r\n  fallbackTranslationHandlerToken,\r\n  translationHandlerChainToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIFoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\nimport { DILocalI18nService } from \"@/infrastructure/i18n/LocalI18nService\";\r\nimport { DII18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport { DIFoundryTranslationHandler } from \"@/infrastructure/i18n/FoundryTranslationHandler\";\r\nimport { DILocalTranslationHandler } from \"@/infrastructure/i18n/LocalTranslationHandler\";\r\nimport { DIFallbackTranslationHandler } from \"@/infrastructure/i18n/FallbackTranslationHandler\";\r\nimport { DITranslationHandlerChain } from \"@/infrastructure/i18n/TranslationHandlerChain\";\r\n\r\n/**\r\n * Registers internationalization (i18n) services.\r\n *\r\n * Services registered:\r\n * - FoundryI18nPort (singleton) - Wraps Foundry's i18n system\r\n * - LocalI18nService (singleton) - Local translations\r\n * - Translation Handlers (singleton) - Chain of Responsibility pattern\r\n *   - FoundryTranslationHandler\r\n *   - LocalTranslationHandler\r\n *   - FallbackTranslationHandler\r\n * - TranslationHandlerChain (singleton) - Builds die Handler-Kette im Konstruktor\r\n * - I18nFacadeService (singleton) - Facade combining all sources\r\n *\r\n * I18nFacadeService provides a unified interface for translations,\r\n * falling back from Foundry → Local → Fallback using Chain of Responsibility.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerI18nServices(container: ServiceContainer): Result<void, string> {\r\n  // Register FoundryI18nPort\r\n  const foundryI18nResult = container.registerClass(\r\n    foundryI18nToken,\r\n    DIFoundryI18nPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(foundryI18nResult)) {\r\n    return err(`Failed to register FoundryI18nPort: ${foundryI18nResult.error.message}`);\r\n  }\r\n\r\n  // Register LocalI18nService\r\n  const localI18nResult = container.registerClass(\r\n    localI18nToken,\r\n    DILocalI18nService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(localI18nResult)) {\r\n    return err(`Failed to register LocalI18nService: ${localI18nResult.error.message}`);\r\n  }\r\n\r\n  // Register Translation Handlers\r\n  const foundryHandlerResult = container.registerClass(\r\n    foundryTranslationHandlerToken,\r\n    DIFoundryTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(foundryHandlerResult)) {\r\n    return err(\r\n      `Failed to register FoundryTranslationHandler: ${foundryHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  const localHandlerResult = container.registerClass(\r\n    localTranslationHandlerToken,\r\n    DILocalTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(localHandlerResult)) {\r\n    return err(`Failed to register LocalTranslationHandler: ${localHandlerResult.error.message}`);\r\n  }\r\n\r\n  const fallbackHandlerResult = container.registerClass(\r\n    fallbackTranslationHandlerToken,\r\n    DIFallbackTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(fallbackHandlerResult)) {\r\n    return err(\r\n      `Failed to register FallbackTranslationHandler: ${fallbackHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register Translation Handler Chain (Foundry → Local → Fallback)\r\n  const chainResult = container.registerClass(\r\n    translationHandlerChainToken,\r\n    DITranslationHandlerChain,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(chainResult)) {\r\n    return err(`Failed to register TranslationHandlerChain: ${chainResult.error.message}`);\r\n  }\r\n\r\n  // Register I18nFacadeService\r\n  const facadeResult = container.registerClass(\r\n    i18nFacadeToken,\r\n    DII18nFacadeService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(facadeResult)) {\r\n    return err(`Failed to register I18nFacadeService: ${facadeResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * NotificationCenter - Central Message Bus for all application notifications.\r\n *\r\n * **Responsibilities:**\r\n * - Route notifications to registered channels\r\n * - Support dynamic channel registration/removal\r\n * - Provide convenience methods for each log level\r\n * - Provide a single point to route notifications across channels\r\n *\r\n * **Architecture:**\r\n * - Strategy Pattern: Channels are pluggable strategies\r\n * - Observer Pattern: Channels observe notifications\r\n * - Open/Closed Principle: Extensible without modification\r\n *\r\n * **Channel Flow:**\r\n * ```\r\n * Service → NotificationCenter → [ConsoleChannel, UIChannel, SentryChannel, ...]\r\n * ```\r\n *\r\n * @example\r\n * ```typescript\r\n * class MyService {\r\n *   static dependencies = [notificationCenterToken];\r\n *   constructor(private notifications: NotificationCenter) {}\r\n *\r\n *   doSomething() {\r\n *     this.notifications.debug(\"Processing data\");\r\n *     this.notifications.info(\"Completed\", { count: 10 });\r\n *     this.notifications.warn(\"Deprecated API used\");\r\n *     this.notifications.error(\"Operation failed\", error);\r\n *   }\r\n * }\r\n * ```\r\n */\r\n\r\nimport { consoleChannelToken } from \"@/infrastructure/shared/tokens\";\r\nimport { err, ok } from \"@/infrastructure/shared/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryNotificationOptions } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type {\r\n  Notification,\r\n  NotificationChannel,\r\n  NotificationLevel,\r\n} from \"./notification-channel.interface\";\r\n\r\nexport type NotificationCenterOptions = {\r\n  /**\r\n   * Optional list of channel names that should receive this notification.\r\n   * If omitted, all registered channels are considered.\r\n   */\r\n  channels?: string[];\r\n  /**\r\n   * Optional trace identifier that gets attached to the notification.\r\n   */\r\n  traceId?: string;\r\n  /**\r\n   * Optional Foundry UI notification options to pass through `ui.notifications`.\r\n   */\r\n  uiOptions?: FoundryNotificationOptions;\r\n};\r\n\r\n/**\r\n * Central hub for module notifications. Routes notifications to registered channels\r\n * (console, UI, remote logging, ...), performs channel filtering, and aggregates\r\n * errors when deliveries fail.\r\n */\r\nexport class NotificationCenter {\r\n  private readonly channels: NotificationChannel[];\r\n\r\n  constructor(initialChannels: NotificationChannel[]) {\r\n    this.channels = [...initialChannels];\r\n  }\r\n\r\n  debug(\r\n    context: string,\r\n    data?: unknown,\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"debug\", context, payload, options);\r\n  }\r\n\r\n  info(context: string, data?: unknown, options?: NotificationCenterOptions): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"info\", context, payload, options);\r\n  }\r\n\r\n  warn(context: string, data?: unknown, options?: NotificationCenterOptions): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"warn\", context, payload, options);\r\n  }\r\n\r\n  error(\r\n    context: string,\r\n    error?: Notification[\"error\"],\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const payload = error === undefined ? {} : { error };\r\n    return this.notify(\"error\", context, payload, options);\r\n  }\r\n\r\n  addChannel(channel: NotificationChannel): void {\r\n    const alreadyRegistered = this.channels.some((existing) => existing.name === channel.name);\r\n    if (!alreadyRegistered) {\r\n      this.channels.push(channel);\r\n    }\r\n  }\r\n\r\n  removeChannel(name: string): boolean {\r\n    const index = this.channels.findIndex((channel) => channel.name === name);\r\n    if (index === -1) {\r\n      return false;\r\n    }\r\n\r\n    this.channels.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  getChannelNames(): string[] {\r\n    return this.channels.map((channel) => channel.name);\r\n  }\r\n\r\n  private notify(\r\n    level: NotificationLevel,\r\n    context: string,\r\n    payload: Partial<Pick<Notification, \"data\" | \"error\">>,\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const notification: Notification = {\r\n      level,\r\n      context,\r\n      timestamp: new Date(),\r\n      ...(payload.data !== undefined ? { data: payload.data } : {}),\r\n      ...(payload.error !== undefined ? { error: payload.error } : {}),\r\n      ...(options?.traceId !== undefined ? { traceId: options.traceId } : {}),\r\n      ...(options?.uiOptions !== undefined ? { uiOptions: options.uiOptions } : {}),\r\n    };\r\n\r\n    const targetChannels = this.selectChannels(options?.channels);\r\n    let attempted = false;\r\n    let succeeded = false;\r\n    const failures: string[] = [];\r\n\r\n    for (const channel of targetChannels) {\r\n      if (!channel.canHandle(notification)) {\r\n        continue;\r\n      }\r\n\r\n      attempted = true;\r\n      const result = channel.send(notification);\r\n      if (result.ok) {\r\n        succeeded = true;\r\n      } else {\r\n        failures.push(`${channel.name}: ${result.error}`);\r\n      }\r\n    }\r\n\r\n    if (!attempted) {\r\n      // No channel attempted to handle this notification.\r\n      // If explicit channel names were provided, treat this as configuration error.\r\n      if (options?.channels && options.channels.length > 0) {\r\n        return err(\r\n          `No channels attempted to handle notification (requested: ${options.channels.join(\", \")})`\r\n        );\r\n      }\r\n\r\n      // Otherwise treat as no-op: nothing was able to handle the notification.\r\n      return ok(undefined);\r\n    }\r\n\r\n    if (succeeded) {\r\n      return ok(undefined);\r\n    }\r\n\r\n    return err(`All channels failed: ${failures.join(\"; \")}`);\r\n  }\r\n\r\n  private selectChannels(channelNames?: string[]): NotificationChannel[] {\r\n    if (!channelNames || channelNames.length === 0) {\r\n      return this.channels;\r\n    }\r\n\r\n    return this.channels.filter((channel) => channelNames.includes(channel.name));\r\n  }\r\n}\r\n\r\nexport class DINotificationCenter extends NotificationCenter {\r\n  static dependencies = [consoleChannelToken] as const;\r\n\r\n  constructor(consoleChannel: NotificationChannel) {\r\n    super([consoleChannel]);\r\n  }\r\n}\r\n","/**\r\n * Console Channel - Routes notifications to console via Logger.\r\n *\r\n * **Responsibilities:**\r\n * - Send all notification levels to console\r\n * - Delegate to Logger service (debug, info, warn, error methods)\r\n * - No filtering - handles all notifications\r\n *\r\n * **Design:**\r\n * Console is for developers - no sanitization needed.\r\n * Full details are always logged.\r\n */\r\n\r\nimport type {\r\n  NotificationChannel,\r\n  Notification,\r\n} from \"@/infrastructure/notifications/notification-channel.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/infrastructure/shared/utils/result\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens\";\r\n\r\nexport class ConsoleChannel implements NotificationChannel {\r\n  readonly name = \"ConsoleChannel\";\r\n\r\n  constructor(private readonly logger: Logger) {}\r\n\r\n  canHandle(): boolean {\r\n    // Console accepts all notification levels\r\n    return true;\r\n  }\r\n\r\n  send(notification: Notification): Result<void, string> {\r\n    const { level, context, data, error } = notification;\r\n\r\n    // Route to appropriate logger method\r\n    switch (level) {\r\n      case \"debug\":\r\n        this.logger.debug(context, data);\r\n        break;\r\n      case \"info\":\r\n        this.logger.info(context, data);\r\n        break;\r\n      case \"warn\":\r\n        this.logger.warn(context, data ?? error);\r\n        break;\r\n      case \"error\":\r\n        this.logger.error(context, error ?? data);\r\n        break;\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\nexport class DIConsoleChannel extends ConsoleChannel {\r\n  static dependencies = [loggerToken] as const;\r\n\r\n  constructor(logger: Logger) {\r\n    super(logger);\r\n  }\r\n}\r\n","/**\r\n * UI Channel - Routes notifications to Foundry UI notifications.\r\n *\r\n * **Responsibilities:**\r\n * - Send user-facing notifications to Foundry UI\r\n * - Filter out debug messages (not relevant for end-users)\r\n * - Sanitize messages in production mode\r\n * - Map notification levels to UI notification types\r\n *\r\n * **Design:**\r\n * UI is for end-users - sanitization required in production.\r\n * Debug messages are never shown in UI (too technical).\r\n */\r\n\r\nimport type {\r\n  NotificationChannel,\r\n  Notification,\r\n} from \"@/infrastructure/notifications/notification-channel.interface\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { foundryUIToken, runtimeConfigToken } from \"@/infrastructure/shared/tokens\";\r\n\r\nexport class UIChannel implements NotificationChannel {\r\n  readonly name = \"UIChannel\";\r\n\r\n  constructor(\r\n    private readonly foundryUI: FoundryUI,\r\n    private readonly config: RuntimeConfigService\r\n  ) {}\r\n\r\n  canHandle(notification: Notification): boolean {\r\n    // Debug messages are too technical for UI\r\n    // Only info, warn, and error are user-facing\r\n    return notification.level !== \"debug\";\r\n  }\r\n\r\n  send(notification: Notification): Result<void, string> {\r\n    const sanitizedMessage = this.sanitizeForUI(notification);\r\n    const uiTypeResult = this.mapLevelToUIType(notification.level);\r\n    if (!uiTypeResult.ok) {\r\n      return uiTypeResult;\r\n    }\r\n    const uiType = uiTypeResult.value;\r\n    const uiOptions = notification.uiOptions;\r\n\r\n    const notifyResult = this.foundryUI.notify(sanitizedMessage, uiType, uiOptions);\r\n\r\n    if (!notifyResult.ok) {\r\n      return err(`UI notification failed: ${notifyResult.error.message}`);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Sanitizes notification message for UI display.\r\n   *\r\n   * Development: Shows detailed messages\r\n   * Production: Shows generic messages to prevent information leakage\r\n   */\r\n  private sanitizeForUI(notification: Notification): string {\r\n    const { level, context, data, error } = notification;\r\n\r\n    if (this.config.get(\"isDevelopment\")) {\r\n      // Development: Show meaningful details\r\n      if (level === \"error\" && error) {\r\n        return `${context}: ${error.message}`;\r\n      }\r\n      if (data && typeof data === \"object\" && \"message\" in data) {\r\n        return `${context}: ${String(data.message)}`;\r\n      }\r\n      return context;\r\n    }\r\n\r\n    // Production: Generic messages\r\n    if (level === \"error\" && error) {\r\n      // Show error code (not sensitive) for support debugging\r\n      return `${context}. Please try again or contact support. (Error: ${error.code})`;\r\n    }\r\n\r\n    // Info/Warn: Show context only (assume context is already user-friendly)\r\n    return context;\r\n  }\r\n\r\n  /**\r\n   * Maps notification level to Foundry UI notification type.\r\n   * Protected to allow testing of exhaustive type check.\r\n   */\r\n  protected mapLevelToUIType(\r\n    level: Notification[\"level\"]\r\n  ): Result<\"info\" | \"warning\" | \"error\", string> {\r\n    switch (level) {\r\n      case \"info\":\r\n        return ok(\"info\");\r\n      case \"warn\":\r\n        return ok(\"warning\");\r\n      case \"error\":\r\n        return ok(\"error\");\r\n      case \"debug\": {\r\n        // TypeScript-Compiler sollte hier warnen, wenn debug nicht mehr im Union ist\r\n        // This should never be called because canHandle() filters out debug level\r\n        // Return error to satisfy exhaustive check without type assertion\r\n        return err(`Debug level should be filtered by canHandle(). Received: ${level}`);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIUIChannel extends UIChannel {\r\n  static dependencies = [foundryUIToken, runtimeConfigToken] as const;\r\n\r\n  constructor(foundryUI: FoundryUI, config: RuntimeConfigService) {\r\n    super(foundryUI, config);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  notificationCenterToken,\r\n  consoleChannelToken,\r\n  uiChannelToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DINotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport { DIConsoleChannel } from \"@/infrastructure/notifications/channels/ConsoleChannel\";\r\nimport { DIUIChannel } from \"@/infrastructure/notifications/channels/UIChannel\";\r\n\r\n/**\r\n * Registers notification services and channels.\r\n *\r\n * **Architecture:**\r\n * 1. Register Channels (ConsoleChannel, UIChannel) als Singletons\r\n * 2. Register NotificationCenter via DI-Wrapper (erhält Channels injiziert)\r\n *\r\n * **Channel Flow:**\r\n * NotificationCenter → [ConsoleChannel, UIChannel, ...]\r\n *\r\n * **Extensibility:**\r\n * Add new channels by:\r\n * 1. Creating a new class implementing NotificationChannel\r\n * 2. Registering it here as singleton\r\n * 3. Adding it to the NotificationCenter factory array\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerNotifications(container: ServiceContainer): Result<void, string> {\r\n  // Register ConsoleChannel\r\n  const consoleChannelResult = container.registerClass(\r\n    consoleChannelToken,\r\n    DIConsoleChannel,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(consoleChannelResult)) {\r\n    return err(`Failed to register ConsoleChannel: ${consoleChannelResult.error.message}`);\r\n  }\r\n\r\n  // Register UIChannel\r\n  const uiChannelResult = container.registerClass(\r\n    uiChannelToken,\r\n    DIUIChannel,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiChannelResult)) {\r\n    return err(`Failed to register UIChannel: ${uiChannelResult.error.message}`);\r\n  }\r\n\r\n  // Register NotificationCenter as singleton (initially nur ConsoleChannel)\r\n  const notificationCenterResult = container.registerClass(\r\n    notificationCenterToken,\r\n    DINotificationCenter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(notificationCenterResult)) {\r\n    return err(`Failed to register NotificationCenter: ${notificationCenterResult.error.message}`);\r\n  }\r\n\r\n  // Hinweis: Zusätzliche Channels (z. B. UIChannel) werden erst nach dem Init-Hook\r\n  // via notificationCenter.addChannel(...) angebunden.\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { LogLevel } from \"@/framework/config/environment\";\r\nimport { LOG_LEVEL_SCHEMA } from \"@/infrastructure/adapters/foundry/validation/setting-schemas\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Validates and sets log level on logger.\r\n *\r\n * This function validates the log level value before applying it to the logger.\r\n * If validation fails, it falls back to INFO level and logs a warning.\r\n *\r\n * @param value - The log level value to validate and set\r\n * @param logger - The logger instance to configure\r\n */\r\nexport function validateAndSetLogLevel(value: number, logger: Logger): void {\r\n  // Validate value before using it (security!)\r\n  const validationResult = v.safeParse(LOG_LEVEL_SCHEMA, value);\r\n\r\n  if (!validationResult.success) {\r\n    logger.warn(`Invalid log level value received: ${value}, using default INFO`);\r\n    if (logger.setMinLevel) {\r\n      logger.setMinLevel(LogLevel.INFO);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Dynamically reconfigure logger when setting changes\r\n  if (logger.setMinLevel) {\r\n    logger.setMinLevel(validationResult.output);\r\n    logger.info(`Log level changed to: ${LogLevel[validationResult.output]}`);\r\n  }\r\n}\r\n","/**\r\n * Log level setting definition.\r\n *\r\n * Configures the minimum log level for the module's console output.\r\n */\r\n\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport { LogLevel } from \"@/framework/config/environment\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { validateAndSetLogLevel } from \"@/infrastructure/shared/utils/validate-log-level\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Log level setting definition.\r\n *\r\n * Provides dropdown with DEBUG/INFO/WARN/ERROR options.\r\n * OnChange handler dynamically reconfigures the logger.\r\n */\r\nexport const logLevelSetting: SettingDefinition<LogLevel> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.LOG_LEVEL,\r\n\r\n  createConfig(i18n: I18nFacadeService, logger: Logger) {\r\n    return {\r\n      name: unwrapOr(i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\"), \"Log Level\"),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.logLevel.hint\",\r\n          \"Minimum log level for module output. DEBUG shows all logs, ERROR only critical errors.\"\r\n        ),\r\n        \"Minimum log level for module output. DEBUG shows all logs, ERROR only critical errors.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      choices: {\r\n        [LogLevel.DEBUG]: unwrapOr(\r\n          i18n.translate(\r\n            \"MODULE.SETTINGS.logLevel.choices.debug\",\r\n            \"DEBUG (All logs - for debugging)\"\r\n          ),\r\n          \"DEBUG (All logs - for debugging)\"\r\n        ),\r\n        [LogLevel.INFO]: unwrapOr(\r\n          i18n.translate(\"MODULE.SETTINGS.logLevel.choices.info\", \"INFO (Standard)\"),\r\n          \"INFO (Standard)\"\r\n        ),\r\n        [LogLevel.WARN]: unwrapOr(\r\n          i18n.translate(\r\n            \"MODULE.SETTINGS.logLevel.choices.warn\",\r\n            \"WARN (Warnings and errors only)\"\r\n          ),\r\n          \"WARN (Warnings and errors only)\"\r\n        ),\r\n        [LogLevel.ERROR]: unwrapOr(\r\n          i18n.translate(\"MODULE.SETTINGS.logLevel.choices.error\", \"ERROR (Critical errors only)\"),\r\n          \"ERROR (Critical errors only)\"\r\n        ),\r\n      },\r\n      default: LogLevel.INFO,\r\n      onChange: (value: number) => {\r\n        validateAndSetLogLevel(value, logger);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting that toggles the CacheService globally.\r\n */\r\nexport const cacheEnabledSetting: SettingDefinition<boolean> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.CACHE_ENABLED,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheEnabled.name\", \"Enable Cache Service\"),\r\n        \"Enable Cache Service\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheEnabled.hint\",\r\n          \"Toggle the global CacheService. When disabled, all cache interactions bypass the cache layer.\"\r\n        ),\r\n        \"Toggle the global CacheService. When disabled, all cache interactions bypass the cache layer.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`CacheService ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting for configuring the default cache TTL (in milliseconds).\r\n */\r\nexport const cacheDefaultTtlSetting: SettingDefinition<number> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.CACHE_TTL_MS,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheDefaultTtlMs.name\", \"Cache TTL (ms)\"),\r\n        \"Cache TTL (ms)\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheDefaultTtlMs.hint\",\r\n          \"Default lifetime for cache entries in milliseconds. Use 0 to disable TTL (entries live until invalidated).\"\r\n        ),\r\n        \"Default lifetime for cache entries in milliseconds. Use 0 to disable TTL (entries live until invalidated).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: MODULE_CONSTANTS.DEFAULTS.CACHE_TTL_MS,\r\n      onChange: (value: number) => {\r\n        const numericValue = Number(value);\r\n        const sanitized = Number.isFinite(numericValue) && numericValue >= 0 ? numericValue : 0;\r\n        logger.info(`Cache TTL updated via settings: ${sanitized}ms`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting for configuring the optional CacheService max entries (LRU limit).\r\n */\r\nexport const cacheMaxEntriesSetting: SettingDefinition<number> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.CACHE_MAX_ENTRIES,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheMaxEntries.name\", \"Cache Max Entries\"),\r\n        \"Cache Max Entries\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheMaxEntries.hint\",\r\n          \"Optional LRU limit. Use 0 to allow unlimited cache entries.\"\r\n        ),\r\n        \"Optional LRU limit. Use 0 to allow unlimited cache entries.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: 0,\r\n      onChange: (value: number) => {\r\n        const numericValue = Number(value);\r\n        const sanitized =\r\n          Number.isFinite(numericValue) && numericValue > 0 ? Math.floor(numericValue) : 0;\r\n        if (sanitized === 0) {\r\n          logger.info(\"Cache max entries reset to unlimited via settings.\");\r\n        } else {\r\n          logger.info(`Cache max entries updated via settings: ${sanitized}`);\r\n        }\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting to toggle performance tracking at runtime.\r\n */\r\nexport const performanceTrackingSetting: SettingDefinition<boolean> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.PERFORMANCE_TRACKING_ENABLED,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.performanceTracking.name\", \"Performance Tracking\"),\r\n        \"Performance Tracking\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.performanceTracking.hint\",\r\n          \"Enables internal performance instrumentation (requires sampling).\"\r\n        ),\r\n        \"Enables internal performance instrumentation (requires sampling).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: false,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`Performance tracking ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting to adjust performance sampling rate (0.0 - 1.0).\r\n */\r\nexport const performanceSamplingSetting: SettingDefinition<number> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.PERFORMANCE_SAMPLING_RATE,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.performanceSamplingRate.name\", \"Performance Sampling Rate\"),\r\n        \"Performance Sampling Rate\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.performanceSamplingRate.hint\",\r\n          \"Fraction of operations to instrument (0 = 0%, 1 = 100%).\"\r\n        ),\r\n        \"Fraction of operations to instrument (0 = 0%, 1 = 100%).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: 1,\r\n      onChange: (value: number) => {\r\n        const clamped = Math.max(0, Math.min(1, Number(value) || 0));\r\n        logger.info(\r\n          `Performance sampling rate updated via settings: ${(clamped * 100).toFixed(1)}%`\r\n        );\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting to toggle metrics persistence between sessions.\r\n */\r\nexport const metricsPersistenceEnabledSetting: SettingDefinition<boolean> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_ENABLED,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.metricsPersistenceEnabled.name\", \"Persist Metrics\"),\r\n        \"Persist Metrics\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.metricsPersistenceEnabled.hint\",\r\n          \"Keeps observability metrics across Foundry restarts (uses LocalStorage).\"\r\n        ),\r\n        \"Keeps observability metrics across Foundry restarts (uses LocalStorage).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: false,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`Metrics persistence ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { unwrapOr } from \"@/infrastructure/shared/utils/result\";\r\n\r\n/**\r\n * Foundry setting to configure the LocalStorage key for persisted metrics.\r\n */\r\nexport const metricsPersistenceKeySetting: SettingDefinition<string> = {\r\n  key: MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_KEY,\r\n\r\n  createConfig(i18n, logger) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.metricsPersistenceKey.name\", \"Metrics Storage Key\"),\r\n        \"Metrics Storage Key\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.metricsPersistenceKey.hint\",\r\n          \"LocalStorage key used when metrics persistence is enabled.\"\r\n        ),\r\n        \"LocalStorage key used when metrics persistence is enabled.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: String,\r\n      default: `${MODULE_CONSTANTS.MODULE.ID}.metrics`,\r\n      onChange: (value: string) => {\r\n        logger.info(`Metrics persistence key set to: ${value || \"(empty)\"}`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type {\r\n  SettingDefinition,\r\n  SettingConfig as ModuleSettingConfig,\r\n} from \"@/application/settings/setting-definition.interface\";\r\nimport type { LogLevel } from \"@/framework/config/environment\";\r\nimport { logLevelSetting } from \"@/application/settings/log-level-setting\";\r\nimport { cacheEnabledSetting } from \"@/application/settings/cache-enabled-setting\";\r\nimport { cacheDefaultTtlSetting } from \"@/application/settings/cache-default-ttl-setting\";\r\nimport { cacheMaxEntriesSetting } from \"@/application/settings/cache-max-entries-setting\";\r\nimport { performanceTrackingSetting } from \"@/application/settings/performance-tracking-setting\";\r\nimport { performanceSamplingSetting } from \"@/application/settings/performance-sampling-setting\";\r\nimport { metricsPersistenceEnabledSetting } from \"@/application/settings/metrics-persistence-enabled-setting\";\r\nimport { metricsPersistenceKeySetting } from \"@/application/settings/metrics-persistence-key-setting\";\r\nimport type {\r\n  RuntimeConfigService,\r\n  RuntimeConfigKey,\r\n  RuntimeConfigValues,\r\n} from \"@/application/services/RuntimeConfigService\";\r\nimport {\r\n  LOG_LEVEL_SCHEMA,\r\n  BOOLEAN_FLAG_SCHEMA,\r\n  NON_NEGATIVE_NUMBER_SCHEMA,\r\n  NON_NEGATIVE_INTEGER_SCHEMA,\r\n  SAMPLING_RATE_SCHEMA,\r\n  NON_EMPTY_STRING_SCHEMA,\r\n} from \"@/infrastructure/adapters/foundry/validation/setting-schemas\";\r\nimport type { BaseIssue } from \"valibot\";\r\nimport type { BaseSchema } from \"valibot\";\r\nimport type { PlatformSettingsPort } from \"@/domain/ports/platform-settings-port.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport {\r\n  notificationCenterToken,\r\n  loggerToken,\r\n  i18nFacadeToken,\r\n  runtimeConfigToken,\r\n  platformSettingsPortToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\ninterface RuntimeConfigBinding<TSchema, K extends RuntimeConfigKey> {\r\n  runtimeKey: K;\r\n  schema: BaseSchema<unknown, TSchema, BaseIssue<unknown>>;\r\n  normalize: (value: TSchema) => RuntimeConfigValues[K];\r\n}\r\n\r\nexport const runtimeConfigBindings = {\r\n  [MODULE_CONSTANTS.SETTINGS.LOG_LEVEL]: {\r\n    runtimeKey: \"logLevel\",\r\n    schema: LOG_LEVEL_SCHEMA,\r\n    normalize: (value: LogLevel) => value,\r\n  } satisfies RuntimeConfigBinding<LogLevel, \"logLevel\">,\r\n  [MODULE_CONSTANTS.SETTINGS.CACHE_ENABLED]: {\r\n    runtimeKey: \"enableCacheService\",\r\n    schema: BOOLEAN_FLAG_SCHEMA,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enableCacheService\">,\r\n  [MODULE_CONSTANTS.SETTINGS.CACHE_TTL_MS]: {\r\n    runtimeKey: \"cacheDefaultTtlMs\",\r\n    schema: NON_NEGATIVE_NUMBER_SCHEMA,\r\n    normalize: (value: number) => value,\r\n  } satisfies RuntimeConfigBinding<number, \"cacheDefaultTtlMs\">,\r\n  [MODULE_CONSTANTS.SETTINGS.CACHE_MAX_ENTRIES]: {\r\n    runtimeKey: \"cacheMaxEntries\",\r\n    schema: NON_NEGATIVE_INTEGER_SCHEMA,\r\n    normalize: (value: number) => (value > 0 ? value : undefined),\r\n  } satisfies RuntimeConfigBinding<number, \"cacheMaxEntries\">,\r\n  [MODULE_CONSTANTS.SETTINGS.PERFORMANCE_TRACKING_ENABLED]: {\r\n    runtimeKey: \"enablePerformanceTracking\",\r\n    schema: BOOLEAN_FLAG_SCHEMA,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enablePerformanceTracking\">,\r\n  [MODULE_CONSTANTS.SETTINGS.PERFORMANCE_SAMPLING_RATE]: {\r\n    runtimeKey: \"performanceSamplingRate\",\r\n    schema: SAMPLING_RATE_SCHEMA,\r\n    normalize: (value: number) => value,\r\n  } satisfies RuntimeConfigBinding<number, \"performanceSamplingRate\">,\r\n  [MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_ENABLED]: {\r\n    runtimeKey: \"enableMetricsPersistence\",\r\n    schema: BOOLEAN_FLAG_SCHEMA,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enableMetricsPersistence\">,\r\n  [MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_KEY]: {\r\n    runtimeKey: \"metricsPersistenceKey\",\r\n    schema: NON_EMPTY_STRING_SCHEMA,\r\n    normalize: (value: string) => value,\r\n  } satisfies RuntimeConfigBinding<string, \"metricsPersistenceKey\">,\r\n} as const;\r\n\r\n/**\r\n * ModuleSettingsRegistrar\r\n *\r\n * Registers all Foundry module settings using definition-based approach.\r\n * Each setting is defined separately for better organization and testability.\r\n *\r\n * **Design Benefits:**\r\n * - Easy to add new settings without modifying this class\r\n * - Each setting definition can be tested in isolation\r\n * - Clear separation between registration logic and setting configuration\r\n * - Full DI: All dependencies injected via constructor (no Service Locator)\r\n */\r\nexport class ModuleSettingsRegistrar {\r\n  constructor(\r\n    private readonly settings: PlatformSettingsPort,\r\n    private readonly runtimeConfig: RuntimeConfigService,\r\n    private readonly notifications: NotificationCenter,\r\n    private readonly i18n: I18nFacadeService,\r\n    private readonly logger: Logger\r\n  ) {}\r\n\r\n  /**\r\n   * Registers all module settings.\r\n   * Must be called during or after the 'init' hook.\r\n   *\r\n   * NOTE: Container parameter removed - all dependencies injected via constructor.\r\n   */\r\n  registerAll(): void {\r\n    // Register all settings\r\n    this.registerDefinition(\r\n      logLevelSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.LOG_LEVEL],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      cacheEnabledSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.CACHE_ENABLED],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      cacheDefaultTtlSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.CACHE_TTL_MS],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      cacheMaxEntriesSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.CACHE_MAX_ENTRIES],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      performanceTrackingSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.PERFORMANCE_TRACKING_ENABLED],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      performanceSamplingSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.PERFORMANCE_SAMPLING_RATE],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      metricsPersistenceEnabledSetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_ENABLED],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n    this.registerDefinition(\r\n      metricsPersistenceKeySetting,\r\n      runtimeConfigBindings[MODULE_CONSTANTS.SETTINGS.METRICS_PERSISTENCE_KEY],\r\n      this.settings,\r\n      this.runtimeConfig,\r\n      this.notifications,\r\n      this.i18n,\r\n      this.logger\r\n    );\r\n  }\r\n\r\n  private attachRuntimeConfigBridge<TSchema, K extends RuntimeConfigKey>(\r\n    config: ModuleSettingConfig<TSchema>,\r\n    runtimeConfig: RuntimeConfigService,\r\n    binding: RuntimeConfigBinding<TSchema, K>\r\n  ): ModuleSettingConfig<TSchema> {\r\n    const originalOnChange = config.onChange;\r\n    return {\r\n      ...config,\r\n      onChange: (value: TSchema) => {\r\n        const normalized = binding.normalize(value);\r\n        runtimeConfig.setFromFoundry(binding.runtimeKey, normalized);\r\n        originalOnChange?.(value);\r\n      },\r\n    };\r\n  }\r\n\r\n  private syncRuntimeConfigFromSettings<TSchema, K extends RuntimeConfigKey>(\r\n    settings: PlatformSettingsPort,\r\n    runtimeConfig: RuntimeConfigService,\r\n    binding: RuntimeConfigBinding<TSchema, K>,\r\n    notifications: NotificationCenter,\r\n    settingKey: string\r\n  ): void {\r\n    const currentValue = settings.get(MODULE_CONSTANTS.MODULE.ID, settingKey, binding.schema);\r\n\r\n    if (!currentValue.ok) {\r\n      notifications.warn(`Failed to read initial value for ${settingKey}`, currentValue.error, {\r\n        channels: [\"ConsoleChannel\"],\r\n      });\r\n      return;\r\n    }\r\n\r\n    runtimeConfig.setFromFoundry(binding.runtimeKey, binding.normalize(currentValue.value));\r\n  }\r\n\r\n  private registerDefinition<TSchema, K extends RuntimeConfigKey>(\r\n    definition: SettingDefinition<TSchema>,\r\n    binding: RuntimeConfigBinding<TSchema, K> | undefined,\r\n    settings: PlatformSettingsPort,\r\n    runtimeConfig: RuntimeConfigService,\r\n    notifications: NotificationCenter,\r\n    i18n: I18nFacadeService,\r\n    logger: Logger\r\n  ): void {\r\n    const config = definition.createConfig(i18n, logger);\r\n    const configWithRuntimeBridge = binding\r\n      ? this.attachRuntimeConfigBridge(config, runtimeConfig, binding)\r\n      : config;\r\n\r\n    const result = settings.register(\r\n      MODULE_CONSTANTS.MODULE.ID,\r\n      definition.key,\r\n      configWithRuntimeBridge\r\n    );\r\n\r\n    if (!result.ok) {\r\n      // Convert SettingsError to NotificationCenter's error format\r\n      const error: { code: string; message: string; [key: string]: unknown } = {\r\n        code: result.error.code,\r\n        message: result.error.message,\r\n        ...(result.error.details !== undefined && { details: result.error.details }),\r\n      };\r\n      notifications.error(`Failed to register ${definition.key} setting`, error, {\r\n        channels: [\"ConsoleChannel\"],\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (binding) {\r\n      this.syncRuntimeConfigFromSettings(\r\n        settings,\r\n        runtimeConfig,\r\n        binding,\r\n        notifications,\r\n        definition.key\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIModuleSettingsRegistrar extends ModuleSettingsRegistrar {\r\n  static dependencies = [\r\n    platformSettingsPortToken,\r\n    runtimeConfigToken,\r\n    notificationCenterToken,\r\n    i18nFacadeToken,\r\n    loggerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    settings: PlatformSettingsPort,\r\n    runtimeConfig: RuntimeConfigService,\r\n    notifications: NotificationCenter,\r\n    i18n: I18nFacadeService,\r\n    logger: Logger\r\n  ) {\r\n    super(settings, runtimeConfig, notifications, i18n, logger);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { moduleSettingsRegistrarToken } from \"@/infrastructure/shared/tokens\";\r\nimport { DIModuleSettingsRegistrar } from \"@/application/services/ModuleSettingsRegistrar\";\r\n\r\n/**\r\n * Registers registrar services.\r\n *\r\n * Services registered:\r\n * - ModuleSettingsRegistrar (singleton) - Manages all settings\r\n *\r\n * NOTE: Event listeners are now registered via registerEventPorts() in event-ports.config.ts.\r\n * This separation improves modularity and follows Single Responsibility Principle.\r\n *\r\n * DESIGN: Registrars are DI services that can be resolved when needed.\r\n * They are NOT instantiated with 'new' in business logic.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerRegistrars(container: ServiceContainer): Result<void, string> {\r\n  // Register ModuleSettingsRegistrar\r\n  const settingsRegistrarResult = container.registerClass(\r\n    moduleSettingsRegistrarToken,\r\n    DIModuleSettingsRegistrar,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsRegistrarResult)) {\r\n    return err(\r\n      `Failed to register ModuleSettingsRegistrar: ${settingsRegistrarResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformJournalEventPort,\r\n  JournalCreatedEvent,\r\n  JournalUpdatedEvent,\r\n  JournalDeletedEvent,\r\n  JournalDirectoryRenderedEvent,\r\n  JournalEvent,\r\n  JournalChanges,\r\n} from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type {\r\n  EventRegistrationId,\r\n  PlatformEventError,\r\n} from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { FoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens\";\r\nimport {\r\n  getFirstElementIfArray,\r\n  castToRecord,\r\n  normalizeToRecord,\r\n} from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformJournalEventPort.\r\n *\r\n * Maps Foundry's Hook system to platform-agnostic journal events.\r\n * Uses FoundryHooksPort which implements PlatformEventPort for platform-agnostic event handling.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundryJournalEventAdapter(foundryHooksPort);\r\n *\r\n * adapter.onJournalCreated((event) => {\r\n *   console.log(`Journal created: ${event.journalId}`);\r\n * });\r\n * ```\r\n */\r\nexport class FoundryJournalEventAdapter implements PlatformJournalEventPort {\r\n  private registrations = new Map<EventRegistrationId, () => void>();\r\n  private nextId = 1;\r\n\r\n  constructor(private readonly foundryHooksPort: FoundryHooksPort) {}\r\n\r\n  // ===== Specialized Journal Methods =====\r\n\r\n  onJournalCreated(\r\n    callback: (event: JournalCreatedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\r\n      \"createJournalEntry\", // Foundry-spezifischer Hook-Name\r\n      (...args: unknown[]) => {\r\n        const [foundryEntry] = args;\r\n        // Mapping: Foundry-Event → Domain-Event\r\n        const event: JournalCreatedEvent = {\r\n          journalId: this.extractId(foundryEntry),\r\n          timestamp: Date.now(),\r\n        };\r\n        callback(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  onJournalUpdated(\r\n    callback: (event: JournalUpdatedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\r\n      \"updateJournalEntry\", // Foundry-spezifisch\r\n      (...args: unknown[]) => {\r\n        const [foundryEntry, changes] = args;\r\n        const event: JournalUpdatedEvent = {\r\n          journalId: this.extractId(foundryEntry),\r\n          changes: this.normalizeChanges(changes),\r\n          timestamp: Date.now(),\r\n        };\r\n        callback(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  onJournalDeleted(\r\n    callback: (event: JournalDeletedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\"deleteJournalEntry\", (...args: unknown[]) => {\r\n      const [foundryEntry] = args;\r\n      const event: JournalDeletedEvent = {\r\n        journalId: this.extractId(foundryEntry),\r\n        timestamp: Date.now(),\r\n      };\r\n      callback(event);\r\n    });\r\n  }\r\n\r\n  onJournalDirectoryRendered(\r\n    callback: (event: JournalDirectoryRenderedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\"renderJournalDirectory\", (app: unknown, html: unknown) => {\r\n      const htmlElement = this.extractHtmlElement(html);\r\n      if (!htmlElement) return;\r\n\r\n      const event: JournalDirectoryRenderedEvent = {\r\n        htmlElement,\r\n        timestamp: Date.now(),\r\n      };\r\n      callback(event);\r\n    });\r\n  }\r\n\r\n  // ===== Generic Methods (from PlatformEventPort) =====\r\n\r\n  registerListener(\r\n    eventType: string,\r\n    callback: (event: JournalEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Fallback für generische registerListener\r\n    // In der Praxis sollten die spezialisierten Methoden genutzt werden\r\n    // Use registerFoundryHook to ensure proper cleanup tracking\r\n    // Wrap callback to match Foundry hook signature while preserving type safety\r\n    const foundryCallback = (...args: unknown[]): void => {\r\n      // Foundry hooks pass multiple arguments, but we expect a single JournalEvent\r\n      // For generic registerListener, we pass the first argument as the event\r\n      // Type guard: check if first argument is a valid JournalEvent\r\n      if (args.length > 0 && typeof args[0] === \"object\" && args[0] !== null) {\r\n        // Type guard: validate that the object has journalId or timestamp property (JournalEvent requirement)\r\n        const candidate = args[0];\r\n        // Type guard: ensure candidate is an object and has required JournalEvent properties\r\n        // Use runtime-safe cast instead of type assertion\r\n        if (\r\n          typeof candidate === \"object\" &&\r\n          candidate !== null &&\r\n          (\"journalId\" in candidate || \"timestamp\" in candidate)\r\n        ) {\r\n          const eventRecord = castToRecord(candidate);\r\n          const event: JournalEvent = {\r\n            journalId: typeof eventRecord.journalId === \"string\" ? eventRecord.journalId : \"\",\r\n            timestamp:\r\n              typeof eventRecord.timestamp === \"number\" ? eventRecord.timestamp : Date.now(),\r\n          };\r\n          callback(event);\r\n        }\r\n      }\r\n    };\r\n    return this.registerFoundryHook(eventType, foundryCallback);\r\n  }\r\n\r\n  unregisterListener(registrationId: EventRegistrationId): Result<void, PlatformEventError> {\r\n    const cleanup = this.registrations.get(registrationId);\r\n    if (!cleanup) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"EVENT_UNREGISTRATION_FAILED\",\r\n          message: `No registration found for ID ${registrationId}`,\r\n        },\r\n      };\r\n    }\r\n\r\n    cleanup();\r\n    this.registrations.delete(registrationId);\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  // ===== Lifecycle =====\r\n\r\n  /**\r\n   * Cleanup all registered listeners.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    for (const cleanup of this.registrations.values()) {\r\n      cleanup();\r\n    }\r\n    this.registrations.clear();\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  private registerFoundryHook(\r\n    hookName: string,\r\n    callback: (...args: unknown[]) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Use PlatformEventPort.registerListener() instead of FoundryHooks.on()\r\n    // Wrap callback to match PlatformEventPort signature (single event parameter)\r\n    // The event parameter contains the original Foundry hook arguments as an array\r\n    const platformCallback = (event: unknown): void => {\r\n      // Foundry hooks pass multiple arguments, but PlatformEventPort expects single event\r\n      // We pass the event as an array to preserve the original Foundry hook signature\r\n      // Type guard: check if event is an array\r\n      // Use explicit type guard function to avoid type assertion\r\n      function isArrayOfUnknown(value: unknown): value is unknown[] {\r\n        return Array.isArray(value);\r\n      }\r\n      if (isArrayOfUnknown(event)) {\r\n        // Type guard: ensure all array elements are valid before spreading\r\n        // Use type predicate to narrow the type\r\n        function isValidArg(arg: unknown): arg is unknown {\r\n          return arg !== null && arg !== undefined;\r\n        }\r\n        const validArgs: unknown[] = event.filter(isValidArg);\r\n        if (validArgs.length > 0) {\r\n          callback(...validArgs);\r\n        }\r\n      } else {\r\n        // Fallback: if event is not an array, pass it as single argument\r\n        // This path is for compatibility with non-array events, which should be rare\r\n        // Type guard: ensure event is not null/undefined before passing\r\n        // Use type narrowing function to avoid type assertion\r\n        function isNotNullOrUndefined(value: unknown): value is NonNullable<unknown> {\r\n          return value !== null && value !== undefined;\r\n        }\r\n        if (isNotNullOrUndefined(event)) {\r\n          callback(event);\r\n        }\r\n      }\r\n    };\r\n    const result = this.foundryHooksPort.registerListener(hookName, platformCallback);\r\n\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n\r\n    const registrationId = result.value;\r\n\r\n    // Store cleanup function using PlatformEventPort.unregisterListener()\r\n    this.registrations.set(registrationId, () => {\r\n      this.foundryHooksPort.unregisterListener(registrationId);\r\n    });\r\n\r\n    return { ok: true, value: registrationId };\r\n  }\r\n\r\n  private extractId(foundryEntry: unknown): string {\r\n    // Foundry entries always have an id property\r\n    if (typeof foundryEntry === \"object\" && foundryEntry !== null && \"id\" in foundryEntry) {\r\n      const entry = castToRecord(foundryEntry);\r\n      if (typeof entry.id === \"string\") {\r\n        return entry.id;\r\n      }\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  private normalizeChanges(foundryChanges: unknown): JournalChanges {\r\n    if (!foundryChanges || typeof foundryChanges !== \"object\") {\r\n      return {};\r\n    }\r\n    // Use runtime-safe cast instead of type assertion\r\n    const changes = normalizeToRecord(foundryChanges);\r\n    const result: JournalChanges = { ...changes };\r\n    if (\r\n      changes.flags !== undefined &&\r\n      typeof changes.flags === \"object\" &&\r\n      changes.flags !== null\r\n    ) {\r\n      // Copy validated object into result.flags using runtime-safe cast\r\n      result.flags = normalizeToRecord(changes.flags);\r\n    }\r\n    if (changes.name !== undefined && typeof changes.name === \"string\") {\r\n      result.name = changes.name;\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private extractHtmlElement(htmlInput: unknown): HTMLElement | null {\r\n    if (htmlInput instanceof HTMLElement) return htmlInput;\r\n    // Use runtime-safe helper for array access with type guard\r\n    return getFirstElementIfArray(htmlInput, (el): el is HTMLElement => el instanceof HTMLElement);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryJournalEventAdapter.\r\n */\r\nexport class DIFoundryJournalEventAdapter extends FoundryJournalEventAdapter {\r\n  static dependencies = [foundryHooksToken] as const;\r\n\r\n  constructor(foundryHooksPort: FoundryHooksPort) {\r\n    super(foundryHooksPort);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { CacheService } from \"@/infrastructure/cache/cache.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  cacheServiceToken,\r\n  notificationCenterToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { getFirstArrayElement } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Use-Case: Invalidate journal cache when journal entries change.\r\n *\r\n * Platform-agnostic - works with any PlatformJournalEventPort implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new InvalidateJournalCacheOnChangeUseCase(\r\n *   journalEventPort,\r\n *   cacheService,\r\n *   notificationCenter\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();  // Stop listening\r\n * ```\r\n */\r\nexport class InvalidateJournalCacheOnChangeUseCase implements EventRegistrar {\r\n  private registrationIds: EventRegistrationId[] = [];\r\n\r\n  constructor(\r\n    private readonly journalEvents: PlatformJournalEventPort,\r\n    private readonly cache: CacheService,\r\n    private readonly notificationCenter: NotificationCenter\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listeners for journal change events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    // Register for all journal change events\r\n    const results = [\r\n      this.journalEvents.onJournalCreated((event) => {\r\n        this.invalidateCache(\"created\", event.journalId);\r\n      }),\r\n      this.journalEvents.onJournalUpdated((event) => {\r\n        this.invalidateCache(\"updated\", event.journalId);\r\n\r\n        // Check if hidden flag changed\r\n        if (event.changes.flags?.[\"hidden\"] !== undefined) {\r\n          this.triggerUIUpdate(event.journalId);\r\n        }\r\n      }),\r\n      this.journalEvents.onJournalDeleted((event) => {\r\n        this.invalidateCache(\"deleted\", event.journalId);\r\n      }),\r\n    ];\r\n\r\n    // Collect registration IDs for cleanup\r\n    const errors: Error[] = [];\r\n    for (const result of results) {\r\n      if (result.ok) {\r\n        this.registrationIds.push(result.value);\r\n      } else {\r\n        const error = new Error(\r\n          `Failed to register journal event listener: ${result.error.message}`\r\n        );\r\n        errors.push(error);\r\n        this.notificationCenter.error(\r\n          \"Failed to register journal event listener\",\r\n          {\r\n            code: result.error.code,\r\n            message: result.error.message,\r\n            details: result.error.details,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Roll back any registered listeners\r\n      this.dispose();\r\n      // Return first error - errors array is non-empty, so getFirstArrayElement is safe\r\n      return err(getFirstArrayElement(errors));\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Invalidate cache entries related to journals.\r\n   */\r\n  private invalidateCache(reason: string, journalId: string): void {\r\n    const removed = this.cache.invalidateWhere((meta) => meta.tags.includes(\"journal:hidden\"));\r\n\r\n    if (removed > 0) {\r\n      this.notificationCenter.debug(\r\n        `Invalidated ${removed} journal cache entries (${reason})`,\r\n        { journalId },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger UI update when journal visibility changes.\r\n   */\r\n  private triggerUIUpdate(journalId: string): void {\r\n    this.notificationCenter.debug(\r\n      \"Journal hidden flag changed, UI update needed\",\r\n      { journalId },\r\n      { channels: [\"ConsoleChannel\"] }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister all event listeners.\r\n   */\r\n  dispose(): void {\r\n    for (const id of this.registrationIds) {\r\n      this.journalEvents.unregisterListener(id);\r\n    }\r\n    this.registrationIds = [];\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for InvalidateJournalCacheOnChangeUseCase.\r\n */\r\nexport class DIInvalidateJournalCacheOnChangeUseCase extends InvalidateJournalCacheOnChangeUseCase {\r\n  static dependencies = [\r\n    platformJournalEventPortToken,\r\n    cacheServiceToken,\r\n    notificationCenterToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalEvents: PlatformJournalEventPort,\r\n    cache: CacheService,\r\n    notificationCenter: NotificationCenter\r\n  ) {\r\n    super(journalEvents, cache, notificationCenter);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { JournalVisibilityService } from \"@/application/services/JournalVisibilityService\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  journalVisibilityServiceToken,\r\n  notificationCenterToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Use-Case: Process journal directory when it's rendered.\r\n *\r\n * Platform-agnostic - works with any PlatformJournalEventPort implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new ProcessJournalDirectoryOnRenderUseCase(\r\n *   journalEventPort,\r\n *   journalVisibilityService,\r\n *   notificationCenter\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();   // Stop listening\r\n * ```\r\n */\r\nexport class ProcessJournalDirectoryOnRenderUseCase implements EventRegistrar {\r\n  private registrationId: EventRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly journalEvents: PlatformJournalEventPort,\r\n    private readonly journalVisibility: JournalVisibilityService,\r\n    private readonly notificationCenter: NotificationCenter\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listener for directory render events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    const result = this.journalEvents.onJournalDirectoryRendered((event) => {\r\n      this.notificationCenter.debug(\r\n        \"Journal directory rendered, processing visibility\",\r\n        { timestamp: event.timestamp },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n\r\n      const processResult = this.journalVisibility.processJournalDirectory(event.htmlElement);\r\n\r\n      if (!processResult.ok) {\r\n        this.notificationCenter.error(\"Failed to process journal directory\", processResult.error, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n      }\r\n    });\r\n\r\n    if (result.ok) {\r\n      this.registrationId = result.value;\r\n      return ok(undefined);\r\n    } else {\r\n      return err(new Error(result.error.message));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister event listener.\r\n   */\r\n  dispose(): void {\r\n    if (this.registrationId !== undefined) {\r\n      this.journalEvents.unregisterListener(this.registrationId);\r\n      this.registrationId = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for ProcessJournalDirectoryOnRenderUseCase.\r\n */\r\nexport class DIProcessJournalDirectoryOnRenderUseCase extends ProcessJournalDirectoryOnRenderUseCase {\r\n  static dependencies = [\r\n    platformJournalEventPortToken,\r\n    journalVisibilityServiceToken,\r\n    notificationCenterToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalEvents: PlatformJournalEventPort,\r\n    journalVisibility: JournalVisibilityService,\r\n    notificationCenter: NotificationCenter\r\n  ) {\r\n    super(journalEvents, journalVisibility, notificationCenter);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  platformUIPortToken,\r\n  notificationCenterToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Use-Case: Trigger journal directory re-render when hidden flag changes.\r\n *\r\n * Fully platform-agnostic through PlatformJournalEventPort and PlatformUIPort.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new TriggerJournalDirectoryReRenderUseCase(\r\n *   journalEventPort,\r\n *   platformUI,\r\n *   notificationCenter\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();   // Stop listening\r\n * ```\r\n */\r\nexport class TriggerJournalDirectoryReRenderUseCase implements EventRegistrar {\r\n  private registrationId: EventRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly journalEvents: PlatformJournalEventPort,\r\n    private readonly platformUI: PlatformUIPort,\r\n    private readonly notificationCenter: NotificationCenter\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listener for journal update events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    const result = this.journalEvents.onJournalUpdated((event) => {\r\n      // Prüfe, ob hidden flag geändert wurde\r\n      // Flags werden in Foundry unter einem Scope gespeichert: flags[moduleId][flagKey]\r\n      const moduleId = MODULE_CONSTANTS.MODULE.ID;\r\n      const flagKey = MODULE_CONSTANTS.FLAGS.HIDDEN;\r\n\r\n      const moduleFlags = event.changes.flags?.[moduleId];\r\n      if (moduleFlags && typeof moduleFlags === \"object\" && flagKey in moduleFlags) {\r\n        this.triggerReRender(event.journalId);\r\n      }\r\n    });\r\n\r\n    if (result.ok) {\r\n      this.registrationId = result.value;\r\n      return ok(undefined);\r\n    } else {\r\n      return err(new Error(result.error.message));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger journal directory re-render.\r\n   */\r\n  private triggerReRender(journalId: string): void {\r\n    const result = this.platformUI.rerenderJournalDirectory();\r\n\r\n    if (!result.ok) {\r\n      this.notificationCenter.warn(\r\n        \"Failed to re-render journal directory after hidden flag change\",\r\n        result.error,\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (result.value) {\r\n      this.notificationCenter.debug(\r\n        \"Triggered journal directory re-render after hidden flag change\",\r\n        { journalId },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister event listener.\r\n   */\r\n  dispose(): void {\r\n    if (this.registrationId !== undefined) {\r\n      this.journalEvents.unregisterListener(this.registrationId);\r\n      this.registrationId = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for TriggerJournalDirectoryReRenderUseCase.\r\n */\r\nexport class DITriggerJournalDirectoryReRenderUseCase extends TriggerJournalDirectoryReRenderUseCase {\r\n  static dependencies = [\r\n    platformJournalEventPortToken,\r\n    platformUIPortToken,\r\n    notificationCenterToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalEvents: PlatformJournalEventPort,\r\n    platformUI: PlatformUIPort,\r\n    notificationCenter: NotificationCenter\r\n  ) {\r\n    super(journalEvents, platformUI, notificationCenter);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { JournalContextMenuHandler } from \"@/application/handlers/journal-context-menu-handler.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { JournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\nimport {\r\n  journalContextMenuLibWrapperServiceToken,\r\n  hideJournalContextMenuHandlerToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { ok } from \"@/infrastructure/shared/utils/result\";\r\nimport type { HideJournalContextMenuHandler } from \"@/application/handlers/hide-journal-context-menu-handler\";\r\n\r\n/**\r\n * Use-Case: Register custom context menu entries for journal entries.\r\n *\r\n * Orchestrates multiple handlers that can add menu items.\r\n * Registers callbacks with the JournalContextMenuLibWrapperService.\r\n *\r\n * NOTE: This is NOT an EventRegistrar. The libWrapper is registered separately\r\n * during init, and this use-case only manages callback registration.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new RegisterContextMenuUseCase(\r\n *   contextMenuLibWrapperService,\r\n *   hideJournalHandler\r\n * );\r\n *\r\n * useCase.register();  // Register callbacks\r\n * useCase.dispose();   // Unregister callbacks\r\n * ```\r\n */\r\nexport class RegisterContextMenuUseCase {\r\n  private callback: ((event: JournalContextMenuEvent) => void) | undefined;\r\n\r\n  constructor(\r\n    private readonly contextMenuLibWrapperService: JournalContextMenuLibWrapperService,\r\n    private readonly hideJournalHandler: HideJournalContextMenuHandler\r\n  ) {}\r\n\r\n  /**\r\n   * Register callback for context menu events.\r\n   * All handlers are called for each context menu event.\r\n   */\r\n  register(): Result<void, Error> {\r\n    const handlers: JournalContextMenuHandler[] = [this.hideJournalHandler];\r\n\r\n    // Create callback that calls all handlers\r\n    this.callback = (event: JournalContextMenuEvent) => {\r\n      // Rufe alle Handler auf\r\n      for (const handler of handlers) {\r\n        handler.handle(event);\r\n      }\r\n    };\r\n\r\n    this.contextMenuLibWrapperService.addCallback(this.callback);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister callback.\r\n   */\r\n  dispose(): void {\r\n    if (this.callback !== undefined) {\r\n      this.contextMenuLibWrapperService.removeCallback(this.callback);\r\n      this.callback = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for RegisterContextMenuUseCase.\r\n * Resolves dependencies from container.\r\n */\r\nexport class DIRegisterContextMenuUseCase extends RegisterContextMenuUseCase {\r\n  static dependencies = [\r\n    journalContextMenuLibWrapperServiceToken,\r\n    hideJournalContextMenuHandlerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    contextMenuLibWrapperService: JournalContextMenuLibWrapperService,\r\n    hideJournalHandler: HideJournalContextMenuHandler\r\n  ) {\r\n    super(contextMenuLibWrapperService, hideJournalHandler);\r\n  }\r\n}\r\n","import type { JournalContextMenuHandler } from \"./journal-context-menu-handler.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { PlatformJournalVisibilityPort } from \"@/domain/ports/platform-journal-visibility-port.interface\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport {\r\n  journalVisibilityPortToken,\r\n  platformUIPortToken,\r\n  notificationCenterToken,\r\n  foundryGameToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Handler that adds \"Journal ausblenden\" menu item to journal context menus.\r\n *\r\n * This handler checks if a journal is already hidden and only adds the menu item\r\n * if the journal is not hidden. When clicked, it sets the HIDDEN flag and shows a notification.\r\n */\r\nexport class HideJournalContextMenuHandler implements JournalContextMenuHandler {\r\n  constructor(\r\n    private readonly journalVisibility: PlatformJournalVisibilityPort,\r\n    private readonly platformUI: PlatformUIPort,\r\n    private readonly notificationCenter: NotificationCenter,\r\n    private readonly foundryGame: FoundryGame\r\n  ) {}\r\n\r\n  handle(event: JournalContextMenuEvent): void {\r\n    // Extrahiere Journal-ID aus HTML-Element\r\n    const journalId = this.extractJournalId(event.htmlElement);\r\n\r\n    if (!journalId) {\r\n      return; // Kein Journal-Eintrag\r\n    }\r\n\r\n    // Prüfe, ob unser MenuItem bereits existiert\r\n    const existingItem = event.options.find((item) => item.name === \"Journal ausblenden\");\r\n\r\n    if (existingItem) {\r\n      return; // Bereits hinzugefügt\r\n    }\r\n\r\n    // Prüfe, ob Journal bereits versteckt ist\r\n    const flagResult = this.journalVisibility.getEntryFlag(\r\n      { id: journalId, name: null },\r\n      MODULE_CONSTANTS.FLAGS.HIDDEN\r\n    );\r\n\r\n    // Nur hinzufügen, wenn nicht versteckt\r\n    if (flagResult.ok && flagResult.value !== true) {\r\n      event.options.push({\r\n        name: \"Journal ausblenden\",\r\n        icon: '<i class=\"fas fa-eye-slash\"></i>',\r\n        callback: async (_li: HTMLElement) => {\r\n          // Journal verstecken\r\n          const hideResult = await this.journalVisibility.setEntryFlag(\r\n            { id: journalId, name: null },\r\n            MODULE_CONSTANTS.FLAGS.HIDDEN,\r\n            true\r\n          );\r\n\r\n          if (hideResult.ok) {\r\n            // Hole Journal-Eintrag, um den Namen zu bekommen\r\n            const journalEntryResult = this.foundryGame.getJournalEntryById(journalId);\r\n            const journalName =\r\n              journalEntryResult.ok && journalEntryResult.value\r\n                ? journalEntryResult.value.name\r\n                : journalId; // Fallback auf ID, falls Name nicht verfügbar\r\n\r\n            // Notification mit Journal-Namen (für UI)\r\n            const notifyResult = this.platformUI.notify(\r\n              `Journal \"${journalName}\" wurde ausgeblendet`,\r\n              \"info\"\r\n            );\r\n\r\n            if (!notifyResult.ok) {\r\n              this.notificationCenter.warn(\r\n                \"Failed to show notification after hiding journal\",\r\n                notifyResult.error,\r\n                { channels: [\"ConsoleChannel\"] }\r\n              );\r\n            }\r\n\r\n            // Log mit Journal-ID (für Debugging)\r\n            this.notificationCenter.debug(\r\n              `Journal ${journalId} (${journalName}) hidden via context menu`,\r\n              { journalId, journalName },\r\n              { channels: [\"ConsoleChannel\"] }\r\n            );\r\n          } else {\r\n            this.notificationCenter.error(`Failed to hide journal ${journalId}`, hideResult.error, {\r\n              channels: [\"ConsoleChannel\", \"UINotificationChannel\"],\r\n            });\r\n          }\r\n        },\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Extract journal ID from an HTML element.\r\n   */\r\n  private extractJournalId(element: HTMLElement): string | null {\r\n    // Foundry v13 uses data-document-id, older versions used data-entry-id\r\n    const documentId = element.getAttribute(\"data-document-id\");\r\n    if (documentId) return documentId;\r\n\r\n    const entryId = element.getAttribute(\"data-entry-id\");\r\n    if (entryId) return entryId;\r\n\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for HideJournalContextMenuHandler.\r\n */\r\nexport class DIHideJournalContextMenuHandler extends HideJournalContextMenuHandler {\r\n  static dependencies = [\r\n    journalVisibilityPortToken,\r\n    platformUIPortToken,\r\n    notificationCenterToken,\r\n    foundryGameToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalVisibility: PlatformJournalVisibilityPort,\r\n    platformUI: PlatformUIPort,\r\n    notificationCenter: NotificationCenter,\r\n    foundryGame: FoundryGame\r\n  ) {\r\n    super(journalVisibility, platformUI, notificationCenter, foundryGame);\r\n  }\r\n}\r\n","import type { EventRegistrar } from \"@/application/use-cases/event-registrar.interface\";\r\n\r\n/**\r\n * Disposes all hooks in the provided array.\r\n *\r\n * This is a lifecycle method that is called when the module is disabled or reloaded.\r\n * Each hook's dispose() method is called to clean up any registered Foundry hooks.\r\n *\r\n * @param hooks - Array of HookRegistrar instances to dispose\r\n */\r\nexport function disposeHooks(hooks: EventRegistrar[]): void {\r\n  for (const hook of hooks) {\r\n    hook.dispose();\r\n  }\r\n}\r\n","import type { EventRegistrar } from \"@/application/use-cases/event-registrar.interface\";\r\nimport type { NotificationCenter } from \"@/infrastructure/notifications/NotificationCenter\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { disposeHooks } from \"@/infrastructure/shared/utils/dispose-hooks\";\r\nimport {\r\n  notificationCenterToken,\r\n  invalidateJournalCacheOnChangeUseCaseToken,\r\n  processJournalDirectoryOnRenderUseCaseToken,\r\n  triggerJournalDirectoryReRenderUseCaseToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * ModuleEventRegistrar\r\n *\r\n * Manages registration of all platform-agnostic event listeners using Strategy Pattern.\r\n * Each event listener is implemented as a separate EventRegistrar class.\r\n *\r\n * **Design Benefits:**\r\n * - Easy to add new event listeners without modifying this class\r\n * - Each event listener can be tested in isolation\r\n * - Clear separation of concerns\r\n * - Full DI architecture: Event listeners injected as dependencies\r\n * - Platform-agnostic: Works with any event system (Foundry, Roll20, etc.)\r\n */\r\nexport class ModuleEventRegistrar {\r\n  private eventRegistrars: EventRegistrar[];\r\n\r\n  constructor(\r\n    processJournalDirectoryOnRender: EventRegistrar,\r\n    invalidateJournalCacheOnChange: EventRegistrar,\r\n    triggerJournalDirectoryReRender: EventRegistrar,\r\n    private readonly notificationCenter: NotificationCenter\r\n  ) {\r\n    this.eventRegistrars = [\r\n      processJournalDirectoryOnRender,\r\n      invalidateJournalCacheOnChange,\r\n      triggerJournalDirectoryReRender,\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Registers all event listeners.\r\n   *\r\n   * NOTE: Container parameter removed - event listeners receive all dependencies via constructor injection.\r\n   */\r\n  registerAll(): Result<void, Error[]> {\r\n    const errors: Error[] = [];\r\n\r\n    for (const registrar of this.eventRegistrars) {\r\n      const result = registrar.register();\r\n      if (!result.ok) {\r\n        // Convert string error to structured format\r\n        const error = {\r\n          code: \"EVENT_REGISTRATION_FAILED\" as const,\r\n          message: result.error.message,\r\n        };\r\n        // Bootstrap error - log to console only (no UI notification)\r\n        this.notificationCenter.error(\"Failed to register event listener\", error, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      return err(errors);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Dispose all event listeners.\r\n   * Called when the module is disabled or reloaded.\r\n   */\r\n  disposeAll(): void {\r\n    disposeHooks(this.eventRegistrars);\r\n  }\r\n}\r\n\r\nexport class DIModuleEventRegistrar extends ModuleEventRegistrar {\r\n  static dependencies = [\r\n    processJournalDirectoryOnRenderUseCaseToken,\r\n    invalidateJournalCacheOnChangeUseCaseToken,\r\n    triggerJournalDirectoryReRenderUseCaseToken,\r\n    notificationCenterToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    processJournalDirectoryOnRender: EventRegistrar,\r\n    invalidateJournalCacheOnChange: EventRegistrar,\r\n    triggerJournalDirectoryReRender: EventRegistrar,\r\n    notificationCenter: NotificationCenter\r\n  ) {\r\n    super(\r\n      processJournalDirectoryOnRender,\r\n      invalidateJournalCacheOnChange,\r\n      triggerJournalDirectoryReRender,\r\n      notificationCenter\r\n    );\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  invalidateJournalCacheOnChangeUseCaseToken,\r\n  processJournalDirectoryOnRenderUseCaseToken,\r\n  triggerJournalDirectoryReRenderUseCaseToken,\r\n  registerContextMenuUseCaseToken,\r\n  hideJournalContextMenuHandlerToken,\r\n  moduleEventRegistrarToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { DIFoundryJournalEventAdapter } from \"@/infrastructure/adapters/foundry/event-adapters/foundry-journal-event-adapter\";\r\nimport { DIInvalidateJournalCacheOnChangeUseCase } from \"@/application/use-cases/invalidate-journal-cache-on-change.use-case\";\r\nimport { DIProcessJournalDirectoryOnRenderUseCase } from \"@/application/use-cases/process-journal-directory-on-render.use-case\";\r\nimport { DITriggerJournalDirectoryReRenderUseCase } from \"@/application/use-cases/trigger-journal-directory-rerender.use-case\";\r\nimport { DIRegisterContextMenuUseCase } from \"@/application/use-cases/register-context-menu.use-case\";\r\nimport { DIHideJournalContextMenuHandler } from \"@/application/handlers/hide-journal-context-menu-handler\";\r\nimport { DIModuleEventRegistrar } from \"@/application/services/ModuleEventRegistrar\";\r\n\r\n/**\r\n * Registers event port services.\r\n *\r\n * Services registered:\r\n * - PlatformJournalEventPort (singleton) - Platform-agnostic journal event handling\r\n * - InvalidateJournalCacheOnChangeUseCase (singleton) - Cache invalidation use-case\r\n * - ProcessJournalDirectoryOnRenderUseCase (singleton) - Directory render use-case\r\n * - TriggerJournalDirectoryReRenderUseCase (singleton) - UI re-render use-case\r\n * - HideJournalContextMenuHandler (singleton) - Handler for \"Journal ausblenden\" context menu item\r\n * - RegisterContextMenuUseCase (singleton) - Context menu callback registration (NOT an event registrar)\r\n * - ModuleEventRegistrar (singleton) - Manages all event listeners\r\n *\r\n * DESIGN: Event ports are platform-agnostic abstractions over event systems.\r\n * They enable multi-VTT support by decoupling from Foundry-specific APIs.\r\n *\r\n * NOTE: RegisterContextMenuUseCase is NOT an EventRegistrar. It manages callbacks\r\n * for the context menu libWrapper, which is registered separately during init.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerEventPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register PlatformJournalEventPort (Foundry implementation)\r\n  const eventPortResult = container.registerClass(\r\n    platformJournalEventPortToken,\r\n    DIFoundryJournalEventAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(eventPortResult)) {\r\n    return err(`Failed to register PlatformJournalEventPort: ${eventPortResult.error.message}`);\r\n  }\r\n\r\n  // Register InvalidateJournalCacheOnChangeUseCase\r\n  const cacheInvalidationUseCaseResult = container.registerClass(\r\n    invalidateJournalCacheOnChangeUseCaseToken,\r\n    DIInvalidateJournalCacheOnChangeUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(cacheInvalidationUseCaseResult)) {\r\n    return err(\r\n      `Failed to register InvalidateJournalCacheOnChangeUseCase: ${cacheInvalidationUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ProcessJournalDirectoryOnRenderUseCase\r\n  const directoryRenderUseCaseResult = container.registerClass(\r\n    processJournalDirectoryOnRenderUseCaseToken,\r\n    DIProcessJournalDirectoryOnRenderUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(directoryRenderUseCaseResult)) {\r\n    return err(\r\n      `Failed to register ProcessJournalDirectoryOnRenderUseCase: ${directoryRenderUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register TriggerJournalDirectoryReRenderUseCase\r\n  const reRenderUseCaseResult = container.registerClass(\r\n    triggerJournalDirectoryReRenderUseCaseToken,\r\n    DITriggerJournalDirectoryReRenderUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(reRenderUseCaseResult)) {\r\n    return err(\r\n      `Failed to register TriggerJournalDirectoryReRenderUseCase: ${reRenderUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register HideJournalContextMenuHandler\r\n  const hideJournalHandlerResult = container.registerClass(\r\n    hideJournalContextMenuHandlerToken,\r\n    DIHideJournalContextMenuHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(hideJournalHandlerResult)) {\r\n    return err(\r\n      `Failed to register HideJournalContextMenuHandler: ${hideJournalHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register RegisterContextMenuUseCase\r\n  const contextMenuUseCaseResult = container.registerClass(\r\n    registerContextMenuUseCaseToken,\r\n    DIRegisterContextMenuUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(contextMenuUseCaseResult)) {\r\n    return err(\r\n      `Failed to register RegisterContextMenuUseCase: ${contextMenuUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ModuleEventRegistrar\r\n  const eventRegistrarResult = container.registerClass(\r\n    moduleEventRegistrarToken,\r\n    DIModuleEventRegistrar,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(eventRegistrarResult)) {\r\n    return err(`Failed to register ModuleEventRegistrar: ${eventRegistrarResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { JournalCollectionPort } from \"@/domain/ports/collections/journal-collection-port.interface\";\r\nimport type { EntityCollectionError } from \"@/domain/ports/collections/platform-entity-collection-port.interface\";\r\nimport type { EntitySearchQuery } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { EntityQueryBuilder } from \"@/domain/ports/collections/entity-query-builder.interface\";\r\nimport type { EntityFilter } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\n\r\n/**\r\n * Foundry-specific implementation of JournalCollectionPort.\r\n *\r\n * Maps Foundry's game.journal collection to platform-agnostic journal collection port.\r\n */\r\nexport class FoundryJournalCollectionAdapter implements JournalCollectionPort {\r\n  constructor(\r\n    private readonly foundryGame: FoundryGame // FoundryGamePort (version-agnostisch), nicht FoundryV13GamePort!\r\n  ) {}\r\n\r\n  getAll(): Result<JournalEntry[], EntityCollectionError> {\r\n    const result = this.foundryGame.getJournalEntries();\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"COLLECTION_NOT_AVAILABLE\",\r\n          message: `Failed to get journals from Foundry: ${result.error.message}`,\r\n          details: result.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Map Foundry types → Domain types\r\n    const entries: JournalEntry[] = result.value.map((foundryEntry) => ({\r\n      id: foundryEntry.id,\r\n      name: foundryEntry.name ?? null,\r\n    }));\r\n\r\n    return ok(entries);\r\n  }\r\n\r\n  getById(id: string): Result<JournalEntry | null, EntityCollectionError> {\r\n    const result = this.foundryGame.getJournalEntryById(id);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"PLATFORM_ERROR\",\r\n          message: `Failed to get journal ${id} from Foundry: ${result.error.message}`,\r\n          details: result.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Not found → return null (not an error)\r\n    if (!result.value) {\r\n      return ok(null);\r\n    }\r\n\r\n    // Map Foundry type → Domain type\r\n    const entry: JournalEntry = {\r\n      id: result.value.id,\r\n      name: result.value.name ?? null,\r\n    };\r\n\r\n    return ok(entry);\r\n  }\r\n\r\n  getByIds(ids: string[]): Result<JournalEntry[], EntityCollectionError> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityCollectionError[] = [];\r\n\r\n    for (const id of ids) {\r\n      const result = this.getById(id);\r\n      if (!result.ok) {\r\n        errors.push(result.error);\r\n      } else if (result.value) {\r\n        // Found - add to results\r\n        results.push(result.value);\r\n      }\r\n      // else: Not found - skip (not an error for batch operations)\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  exists(id: string): Result<boolean, EntityCollectionError> {\r\n    const result = this.getById(id);\r\n    if (!result.ok) {\r\n      return result; // Propagate error\r\n    }\r\n    return ok(result.value !== null);\r\n  }\r\n\r\n  count(): Result<number, EntityCollectionError> {\r\n    const result = this.getAll();\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: result.error,\r\n      };\r\n    }\r\n    return ok(result.value.length);\r\n  }\r\n\r\n  search(query: EntitySearchQuery<JournalEntry>): Result<JournalEntry[], EntityCollectionError> {\r\n    // Get all entities first\r\n    const allResult = this.getAll();\r\n    if (!allResult.ok) {\r\n      return allResult;\r\n    }\r\n\r\n    let results = allResult.value;\r\n\r\n    // Apply filters\r\n    if (query.filters && query.filters.length > 0) {\r\n      const filters = query.filters; // Type narrowing\r\n      results = results.filter((entity) => {\r\n        // All filters must match (AND logic)\r\n        return filters.every((filter) => {\r\n          const fieldValue = entity[filter.field];\r\n          return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n        });\r\n      });\r\n    }\r\n\r\n    // Apply filter groups (for complex AND/OR logic)\r\n    if (query.filterGroups && query.filterGroups.length > 0) {\r\n      const filterGroups = query.filterGroups; // Type narrowing\r\n      results = results.filter((entity) => {\r\n        // All groups must match (AND between groups)\r\n        return filterGroups.every((group) => {\r\n          if (group.filters.length === 0) return true;\r\n\r\n          if (group.logic === \"OR\") {\r\n            // At least one filter in group must match\r\n            return group.filters.some((filter) => {\r\n              const fieldValue = entity[filter.field];\r\n              return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n            });\r\n          } else {\r\n            // All filters in group must match (AND)\r\n            return group.filters.every((filter) => {\r\n              const fieldValue = entity[filter.field];\r\n              return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    // Apply sorting\r\n    if (query.sortBy) {\r\n      const sortBy = query.sortBy; // Type narrowing\r\n      results.sort((a, b) => {\r\n        const aValue = a[sortBy];\r\n        const bValue = b[sortBy];\r\n\r\n        if (aValue === bValue) return 0;\r\n        if (aValue === null || aValue === undefined) return 1;\r\n        if (bValue === null || bValue === undefined) return -1;\r\n\r\n        const comparison = aValue < bValue ? -1 : 1;\r\n        return query.sortOrder === \"desc\" ? -comparison : comparison;\r\n      });\r\n    }\r\n\r\n    // Apply pagination\r\n    if (query.offset) {\r\n      results = results.slice(query.offset);\r\n    }\r\n    if (query.limit) {\r\n      results = results.slice(0, query.limit);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  query(): EntityQueryBuilder<JournalEntry> {\r\n    return new FoundryJournalQueryBuilder(this);\r\n  }\r\n\r\n  private matchesFilter(fieldValue: unknown, operator: string, filterValue: unknown): boolean {\r\n    switch (operator) {\r\n      case \"equals\":\r\n        return fieldValue === filterValue;\r\n      case \"notEquals\":\r\n        return fieldValue !== filterValue;\r\n      case \"contains\":\r\n        return String(fieldValue).toLowerCase().includes(String(filterValue).toLowerCase());\r\n      case \"startsWith\":\r\n        return String(fieldValue).toLowerCase().startsWith(String(filterValue).toLowerCase());\r\n      case \"endsWith\":\r\n        return String(fieldValue).toLowerCase().endsWith(String(filterValue).toLowerCase());\r\n      case \"in\": {\r\n        if (!Array.isArray(filterValue)) {\r\n          return false;\r\n        }\r\n        // Type narrowing: filterValue is now known to be an array\r\n        const filterArray: unknown[] = filterValue;\r\n        return filterArray.includes(fieldValue);\r\n      }\r\n      case \"notIn\": {\r\n        if (!Array.isArray(filterValue)) {\r\n          return false;\r\n        }\r\n        // Type narrowing: filterValue is now known to be an array\r\n        const filterArray: unknown[] = filterValue;\r\n        return !filterArray.includes(fieldValue);\r\n      }\r\n      case \"greaterThan\":\r\n        return Number(fieldValue) > Number(filterValue);\r\n      case \"lessThan\":\r\n        return Number(fieldValue) < Number(filterValue);\r\n      case \"greaterThanOrEqual\":\r\n        return Number(fieldValue) >= Number(filterValue);\r\n      case \"lessThanOrEqual\":\r\n        return Number(fieldValue) <= Number(filterValue);\r\n      default:\r\n        return false;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Query builder implementation for Foundry journal collection.\r\n */\r\nclass FoundryJournalQueryBuilder implements EntityQueryBuilder<JournalEntry> {\r\n  private query: EntitySearchQuery<JournalEntry> = {};\r\n  private currentOrGroup: Array<{\r\n    field: keyof JournalEntry;\r\n    operator: EntityFilter<JournalEntry>[\"operator\"];\r\n    value: unknown;\r\n  }> | null = null;\r\n\r\n  constructor(private readonly adapter: FoundryJournalCollectionAdapter) {}\r\n\r\n  where(\r\n    field: keyof JournalEntry,\r\n    operator: EntityFilter<JournalEntry>[\"operator\"],\r\n    value: unknown\r\n  ): EntityQueryBuilder<JournalEntry> {\r\n    // If we're inside an or() callback, add to currentOrGroup\r\n    if (this.currentOrGroup !== null) {\r\n      this.currentOrGroup.push({ field, operator, value });\r\n      return this;\r\n    }\r\n\r\n    // Otherwise, close any open OR group and add to AND filters\r\n    this.closeOrGroup();\r\n\r\n    if (!this.query.filters) {\r\n      this.query.filters = [];\r\n    }\r\n    this.query.filters.push({ field, operator, value });\r\n    return this;\r\n  }\r\n\r\n  orWhere(\r\n    field: keyof JournalEntry,\r\n    operator: EntityFilter<JournalEntry>[\"operator\"],\r\n    value: unknown\r\n  ): EntityQueryBuilder<JournalEntry> {\r\n    // Start OR group if not already started\r\n    if (this.currentOrGroup === null) {\r\n      this.currentOrGroup = [];\r\n      // Move the last where() filter into the OR group\r\n      if (this.query.filters && this.query.filters.length > 0) {\r\n        // type-coverage:ignore-next-line - Array with length > 0 guarantees element from pop()\r\n        const lastFilter = this.query.filters.pop()!;\r\n        this.currentOrGroup.push({\r\n          field: lastFilter.field,\r\n          operator: lastFilter.operator,\r\n          value: lastFilter.value,\r\n        });\r\n      }\r\n    }\r\n\r\n    this.currentOrGroup.push({ field, operator, value });\r\n    return this;\r\n  }\r\n\r\n  or(callback: (qb: EntityQueryBuilder<JournalEntry>) => void): EntityQueryBuilder<JournalEntry> {\r\n    // Close any open OR group first\r\n    this.closeOrGroup();\r\n\r\n    // Create new OR group\r\n    const orGroup: Array<{\r\n      field: keyof JournalEntry;\r\n      operator: EntityFilter<JournalEntry>[\"operator\"];\r\n      value: unknown;\r\n    }> = [];\r\n\r\n    // Move the last where() filter into the OR group\r\n    if (this.query.filters && this.query.filters.length > 0) {\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element from pop()\r\n      const lastFilter = this.query.filters.pop()!;\r\n      orGroup.push({\r\n        field: lastFilter.field,\r\n        operator: lastFilter.operator,\r\n        value: lastFilter.value,\r\n      });\r\n    }\r\n\r\n    // Temporarily set currentOrGroup to capture filters from callback\r\n    const originalOrGroup = this.currentOrGroup;\r\n    this.currentOrGroup = orGroup;\r\n\r\n    // Execute callback - where() calls inside will be captured in orGroup\r\n    callback(this);\r\n\r\n    // Restore original state\r\n    this.currentOrGroup = originalOrGroup;\r\n\r\n    // Add OR group to filterGroups\r\n    if (orGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"OR\",\r\n        filters: orGroup.map((f) => ({ field: f.field, operator: f.operator, value: f.value })),\r\n      });\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  and(callback: (qb: EntityQueryBuilder<JournalEntry>) => void): EntityQueryBuilder<JournalEntry> {\r\n    // Close any open OR group first\r\n    this.closeOrGroup();\r\n\r\n    // Create new AND group\r\n    const andGroup: Array<{\r\n      field: keyof JournalEntry;\r\n      operator: EntityFilter<JournalEntry>[\"operator\"];\r\n      value: unknown;\r\n    }> = [];\r\n\r\n    // Temporarily set filters to capture where() calls from callback\r\n    const originalFilters = this.query.filters;\r\n    this.query.filters = andGroup as EntityFilter<JournalEntry>[];\r\n\r\n    // Execute callback - where() calls inside will be captured in andGroup\r\n    callback(this);\r\n\r\n    // Restore original state\r\n    if (originalFilters !== undefined) {\r\n      this.query.filters = originalFilters;\r\n    } else {\r\n      delete this.query.filters;\r\n    }\r\n\r\n    // Add AND group to filterGroups\r\n    if (andGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"AND\",\r\n        filters: andGroup.map((f) => ({ field: f.field, operator: f.operator, value: f.value })),\r\n      });\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  limit(count: number): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before limit\r\n    this.query.limit = count;\r\n    return this;\r\n  }\r\n\r\n  offset(count: number): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before offset\r\n    this.query.offset = count;\r\n    return this;\r\n  }\r\n\r\n  sortBy(field: keyof JournalEntry, order: \"asc\" | \"desc\"): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before sort\r\n    this.query.sortBy = field;\r\n    this.query.sortOrder = order;\r\n    return this;\r\n  }\r\n\r\n  execute(): Result<JournalEntry[], EntityCollectionError> {\r\n    this.closeOrGroup(); // Close any open OR group before execution\r\n    return this.adapter.search(this.query);\r\n  }\r\n\r\n  /**\r\n   * Closes the current OR group and adds it to filterGroups.\r\n   * Called automatically before where(), limit(), offset(), sortBy(), execute().\r\n   */\r\n  private closeOrGroup(): void {\r\n    if (this.currentOrGroup && this.currentOrGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"OR\",\r\n        filters: this.currentOrGroup.map((f) => ({\r\n          field: f.field,\r\n          operator: f.operator,\r\n          value: f.value,\r\n        })),\r\n      });\r\n      this.currentOrGroup = null;\r\n    }\r\n  }\r\n}\r\n\r\n// DI-Wrapper\r\nexport class DIFoundryJournalCollectionAdapter extends FoundryJournalCollectionAdapter {\r\n  static dependencies = [foundryGameToken] as const; // foundryGameToken → FoundryGamePort (version-agnostisch)\r\n\r\n  constructor(foundryGame: FoundryGame) {\r\n    // FoundryGamePort wird injiziert\r\n    super(foundryGame);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { JournalRepository } from \"@/domain/ports/repositories/journal-repository.interface\";\r\nimport type {\r\n  EntityRepositoryError,\r\n  CreateEntityData,\r\n  EntityChanges,\r\n} from \"@/domain/ports/repositories/platform-entity-repository.interface\";\r\nimport type { EntityCollectionError } from \"@/domain/ports/collections/platform-entity-collection-port.interface\";\r\nimport type { EntitySearchQuery } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { EntityQueryBuilder } from \"@/domain/ports/collections/entity-query-builder.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport { FoundryJournalCollectionAdapter } from \"../collection-adapters/foundry-journal-collection-adapter\";\r\nimport { ok, err } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  castFoundryDocumentForFlag,\r\n  castFoundryDocumentWithUpdate,\r\n  castFoundryJournalEntryClass,\r\n} from \"@/infrastructure/adapters/foundry/runtime-casts\";\r\nimport {\r\n  foundryGameToken,\r\n  foundryDocumentToken,\r\n} from \"@/infrastructure/shared/tokens/foundry.tokens\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Foundry-specific implementation of JournalRepository.\r\n *\r\n * Combines collection adapter with CRUD operations.\r\n */\r\nexport class FoundryJournalRepositoryAdapter implements JournalRepository {\r\n  private readonly collection: FoundryJournalCollectionAdapter;\r\n\r\n  constructor(\r\n    private readonly foundryGame: FoundryGame, // FoundryGamePort (version-agnostisch), nicht FoundryV13GamePort!\r\n    private readonly foundryDocument: FoundryDocument // FoundryDocumentPort (version-agnostisch), nicht FoundryV13DocumentPort!\r\n  ) {\r\n    this.collection = new FoundryJournalCollectionAdapter(foundryGame);\r\n  }\r\n\r\n  // ===== Collection Methods (delegate to collection adapter) =====\r\n\r\n  getAll(): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.getAll();\r\n  }\r\n  getById(id: string): Result<JournalEntry | null, EntityCollectionError> {\r\n    return this.collection.getById(id);\r\n  }\r\n  getByIds(ids: string[]): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.getByIds(ids);\r\n  }\r\n  exists(id: string): Result<boolean, EntityCollectionError> {\r\n    return this.collection.exists(id);\r\n  }\r\n  count(): Result<number, EntityCollectionError> {\r\n    return this.collection.count();\r\n  }\r\n  search(query: EntitySearchQuery<JournalEntry>): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.search(query);\r\n  }\r\n  query(): EntityQueryBuilder<JournalEntry> {\r\n    return this.collection.query();\r\n  }\r\n\r\n  // ===== CREATE Operations =====\r\n\r\n  async create(\r\n    data: CreateEntityData<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    // Foundry: JournalEntry.create() - statische Methode\r\n    // Nutzt FoundryDocumentPort für create()\r\n    // JournalEntry ist eine globale Foundry-Klasse\r\n    const journalEntryClassResult = castFoundryJournalEntryClass();\r\n    if (!journalEntryClassResult.ok) {\r\n      return err({\r\n        code: \"PLATFORM_ERROR\",\r\n        message: `Foundry JournalEntry class not available: ${journalEntryClassResult.error.message}`,\r\n        details: journalEntryClassResult.error,\r\n      });\r\n    }\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    const JournalEntryClass = journalEntryClassResult.value;\r\n\r\n    try {\r\n      const createResult = await this.foundryDocument.create(JournalEntryClass, data);\r\n      if (!createResult.ok) {\r\n        return err({\r\n          code: \"OPERATION_FAILED\",\r\n          message: `Failed to create journal: ${createResult.error.message}`,\r\n          details: createResult.error,\r\n        });\r\n      }\r\n\r\n      // Map Foundry type → Domain type\r\n      const createdEntry: JournalEntry = {\r\n        id: createResult.value.id,\r\n        name: createResult.value.name ?? null,\r\n      };\r\n\r\n      return ok(createdEntry);\r\n    } catch (error) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to create journal: ${error instanceof Error ? error.message : String(error)}`,\r\n        details: error,\r\n      });\r\n    }\r\n  }\r\n\r\n  async createMany(\r\n    data: CreateEntityData<JournalEntry>[]\r\n  ): Promise<Result<JournalEntry[], EntityRepositoryError>> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const item of data) {\r\n      const result = await this.create(item);\r\n      if (result.ok) {\r\n        results.push(result.value);\r\n      } else {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  // ===== UPDATE Operations =====\r\n\r\n  async update(\r\n    id: string,\r\n    changes: EntityChanges<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    // Get current entity\r\n    const currentResult = this.getById(id);\r\n    if (!currentResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"ENTITY_NOT_FOUND\",\r\n          message: `Journal ${id} not found`,\r\n          details: currentResult.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    if (!currentResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found in Foundry`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Prepare update data (nur normale Properties, KEINE Flags!)\r\n    // Flags werden über setFlag()/unsetFlag() gesetzt, nicht über update()\r\n    //\r\n    // WICHTIG: Properties löschen durch \"-=\" Notation!\r\n    // Foundry VTT verwendet Differences und Merges, daher braucht man eine spezielle\r\n    // Notation, um zu signalisieren, dass ein Wert gelöscht werden soll.\r\n    // Syntax: 'propertyName.-=key': null (für nested: 'system.-=key': null)\r\n    //\r\n    // HINWEIS:\r\n    // - Normale Properties: 'propertyName.-=': null oder 'system.-=key': null\r\n    // - Flags: unsetFlag() (empfohlen) oder 'flags.scope.-=key': null\r\n    // - Arrays: Müssen als Ganzes geschrieben werden (keine Index-Modifikation möglich)\r\n    const updateData: Record<string, unknown> = {};\r\n    if (changes.name !== undefined) {\r\n      if (changes.name === null) {\r\n        // Property löschen: \"-=\" Notation verwenden\r\n        updateData[\"name.-=\"] = null;\r\n      } else {\r\n        // Property aktualisieren: normaler Wert\r\n        updateData.name = changes.name;\r\n      }\r\n    }\r\n    // Weitere Properties hier hinzufügen...\r\n    // ❌ KEINE Flags hier! Flags werden über setFlag()/unsetFlag() gesetzt\r\n    // ❌ Arrays müssen als Ganzes geschrieben werden, nicht per Index!\r\n\r\n    // Foundry: entry.update(updateData) - nur für normale Properties\r\n    // Nutzt FoundryDocumentPort für update()\r\n    const docWithUpdateResult = castFoundryDocumentWithUpdate<{ id: string; name?: string | null }>(\r\n      foundryEntry\r\n    );\r\n    if (!docWithUpdateResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support update: ${docWithUpdateResult.error.message}`,\r\n        details: docWithUpdateResult.error,\r\n      });\r\n    }\r\n    const updateResult = await this.foundryDocument.update(docWithUpdateResult.value, updateData);\r\n    if (!updateResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to update journal ${id}: ${updateResult.error.message}`,\r\n        details: updateResult.error,\r\n      });\r\n    }\r\n\r\n    // Get updated entry (mapped to domain type)\r\n    const updatedResult = this.getById(id);\r\n    if (!updatedResult.ok || !updatedResult.value) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: \"Failed to retrieve updated journal\",\r\n      });\r\n    }\r\n\r\n    return ok(updatedResult.value);\r\n  }\r\n\r\n  async updateMany(\r\n    updates: Array<{ id: string; changes: EntityChanges<JournalEntry> }>\r\n  ): Promise<Result<JournalEntry[], EntityRepositoryError>> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const update of updates) {\r\n      const result = await this.update(update.id, update.changes);\r\n      if (result.ok) {\r\n        results.push(result.value);\r\n      } else {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  async patch(\r\n    id: string,\r\n    partial: Partial<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    return this.update(id, partial);\r\n  }\r\n\r\n  async upsert(\r\n    id: string,\r\n    data: CreateEntityData<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    const existsResult = this.exists(id);\r\n    if (!existsResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to check if journal ${id} exists`,\r\n        details: existsResult.error,\r\n      });\r\n    }\r\n\r\n    if (existsResult.value) {\r\n      // Update existing\r\n      return this.update(id, data);\r\n    } else {\r\n      // Create new - id needs to be added since CreateEntityData omits id\r\n      // For upsert, we need to provide id, so we cast to include it\r\n      // type-coverage:ignore-next-line - id is intentionally added for upsert operation\r\n      return this.create({ ...data, id } as CreateEntityData<JournalEntry>);\r\n    }\r\n  }\r\n\r\n  // ===== DELETE Operations =====\r\n\r\n  async delete(id: string): Promise<Result<void, EntityRepositoryError>> {\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    // Nutzt FoundryDocumentPort für delete()\r\n    const deleteResult = await this.foundryDocument.delete(foundryResult.value);\r\n    if (!deleteResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to delete journal ${id}: ${deleteResult.error.message}`,\r\n        details: deleteResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  async deleteMany(ids: string[]): Promise<Result<void, EntityRepositoryError>> {\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const id of ids) {\r\n      const result = await this.delete(id);\r\n      if (!result.ok) {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  // ===== Flag Convenience Methods =====\r\n\r\n  getFlag(id: string, scope: string, key: string): Result<unknown | null, EntityRepositoryError> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Use FoundryDocument.getFlag() with unknown schema to accept any value\r\n    const flagResult = this.foundryDocument.getFlag(documentResult.value, scope, key, v.unknown());\r\n    if (!flagResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to get flag ${scope}.${key}: ${flagResult.error.message}`,\r\n        details: flagResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(flagResult.value);\r\n  }\r\n\r\n  async setFlag(\r\n    id: string,\r\n    scope: string,\r\n    key: string,\r\n    value: unknown\r\n  ): Promise<Result<void, EntityRepositoryError>> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Foundry: entry.setFlag(scope, key, value) - separate API für Flags!\r\n    const flagResult = await this.foundryDocument.setFlag(documentResult.value, scope, key, value);\r\n\r\n    if (!flagResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to set flag ${scope}.${key}: ${flagResult.error.message}`,\r\n        details: flagResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  async unsetFlag(\r\n    id: string,\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, EntityRepositoryError>> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Foundry: entry.unsetFlag(scope, key) - recommended method for flags!\r\n    // Use FoundryDocument.unsetFlag() which uses the recommended approach\r\n    const unsetResult = await this.foundryDocument.unsetFlag(documentResult.value, scope, key);\r\n\r\n    if (!unsetResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to unset flag ${scope}.${key}: ${unsetResult.error.message}`,\r\n        details: unsetResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\n// DI-Wrapper\r\nexport class DIFoundryJournalRepositoryAdapter extends FoundryJournalRepositoryAdapter {\r\n  static dependencies = [foundryGameToken, foundryDocumentToken] as const;\r\n\r\n  constructor(foundryGame: FoundryGame, foundryDocument: FoundryDocument) {\r\n    super(foundryGame, foundryDocument);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { journalCollectionPortToken, journalRepositoryToken } from \"@/infrastructure/shared/tokens\";\r\nimport { DIFoundryJournalCollectionAdapter } from \"@/infrastructure/adapters/foundry/collection-adapters/foundry-journal-collection-adapter\";\r\nimport { DIFoundryJournalRepositoryAdapter } from \"@/infrastructure/adapters/foundry/repository-adapters/foundry-journal-repository-adapter\";\r\n\r\n/**\r\n * Registers entity collection and repository ports.\r\n *\r\n * Services registered:\r\n * - JournalCollectionPort (singleton) - Read-only access to journal collections\r\n * - JournalRepository (singleton) - Full CRUD access to journal entries\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerEntityPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register JournalCollectionPort\r\n  const collectionResult = container.registerClass(\r\n    journalCollectionPortToken,\r\n    DIFoundryJournalCollectionAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(collectionResult)) {\r\n    return err(`Failed to register JournalCollectionPort: ${collectionResult.error.message}`);\r\n  }\r\n\r\n  // Register JournalRepository\r\n  const repositoryResult = container.registerClass(\r\n    journalRepositoryToken,\r\n    DIFoundryJournalRepositoryAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(repositoryResult)) {\r\n    return err(`Failed to register JournalRepository: ${repositoryResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformSettingsPort,\r\n  PlatformSettingConfig,\r\n  SettingsError,\r\n  SettingType,\r\n} from \"@/domain/ports/platform-settings-port.interface\";\r\nimport type {\r\n  FoundrySettings,\r\n  SettingConfig,\r\n} from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type * as v from \"valibot\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformSettingsPort.\r\n *\r\n * Maps Foundry's game.settings API to platform-agnostic settings port.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundrySettingsAdapter(foundrySettings);\r\n *\r\n * adapter.register(\"my-module\", \"enabled\", {\r\n *   name: \"Enable Feature\",\r\n *   scope: \"world\",\r\n *   type: Boolean,\r\n *   default: true,\r\n * });\r\n *\r\n * const result = adapter.get(\"my-module\", \"enabled\", v.boolean());\r\n * ```\r\n */\r\nexport class FoundrySettingsAdapter implements PlatformSettingsPort {\r\n  constructor(private readonly foundrySettings: FoundrySettings) {}\r\n\r\n  /**\r\n   * Register a setting in Foundry.\r\n   *\r\n   * Maps platform config → Foundry config.\r\n   */\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: PlatformSettingConfig<T>\r\n  ): Result<void, SettingsError> {\r\n    // Map Platform config → Foundry config\r\n    const foundryConfig: SettingConfig<T> = {\r\n      name: config.name,\r\n      ...(config.hint !== undefined && { hint: config.hint }),\r\n      scope: config.scope,\r\n      config: config.config,\r\n      type: this.mapSettingType(config.type),\r\n      ...(config.choices !== undefined && { choices: config.choices }),\r\n      default: config.default,\r\n      ...(config.onChange !== undefined && { onChange: config.onChange }),\r\n    };\r\n\r\n    const result = this.foundrySettings.register(namespace, key, foundryConfig);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryErrorToSettingsError(result.error, \"register\", namespace, key),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  /**\r\n   * Get setting value from Foundry with validation.\r\n   *\r\n   * Uses Valibot schema to validate at runtime.\r\n   */\r\n  get<T>(\r\n    namespace: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T, SettingsError> {\r\n    const result = this.foundrySettings.get(namespace, key, schema);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryErrorToSettingsError(result.error, \"get\", namespace, key),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: result.value };\r\n  }\r\n\r\n  /**\r\n   * Set setting value in Foundry.\r\n   *\r\n   * Persists to Foundry's database and triggers onChange.\r\n   */\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, SettingsError>> {\r\n    const result = await this.foundrySettings.set(namespace, key, value);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryErrorToSettingsError(result.error, \"set\", namespace, key),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  /**\r\n   * Map platform type to Foundry type.\r\n   *\r\n   * Handles both constructor types and string types.\r\n   */\r\n  private mapSettingType(type: SettingType): typeof String | typeof Number | typeof Boolean {\r\n    if (type === \"String\" || type === String) return String;\r\n    if (type === \"Number\" || type === Number) return Number;\r\n    if (type === \"Boolean\" || type === Boolean) return Boolean;\r\n    throw new Error(`Unknown setting type: ${type}`);\r\n  }\r\n\r\n  /**\r\n   * Maps FoundryError to SettingsError.\r\n   *\r\n   * Maps Foundry-specific error codes to platform-agnostic settings error codes.\r\n   */\r\n  private mapFoundryErrorToSettingsError(\r\n    foundryError: FoundryError,\r\n    operation: \"register\" | \"get\" | \"set\",\r\n    namespace: string,\r\n    key: string\r\n  ): SettingsError {\r\n    // Map Foundry error codes to Settings error codes\r\n    let code: SettingsError[\"code\"];\r\n    switch (foundryError.code) {\r\n      case \"API_NOT_AVAILABLE\":\r\n        code = \"PLATFORM_NOT_AVAILABLE\";\r\n        break;\r\n      case \"VALIDATION_FAILED\":\r\n        code = \"SETTING_VALIDATION_FAILED\";\r\n        break;\r\n      case \"OPERATION_FAILED\":\r\n        // Check if it's a registration failure\r\n        if (operation === \"register\") {\r\n          code = \"SETTING_REGISTRATION_FAILED\";\r\n        } else {\r\n          // For get/set, could be unregistered setting or other issue\r\n          // Check error message for hints\r\n          const message = foundryError.message.toLowerCase();\r\n          if (message.includes(\"not registered\") || message.includes(\"not found\")) {\r\n            code = \"SETTING_NOT_REGISTERED\";\r\n          } else {\r\n            code = \"SETTING_VALIDATION_FAILED\";\r\n          }\r\n        }\r\n        break;\r\n      default:\r\n        // Default to registration failed for register, validation failed for get/set\r\n        code =\r\n          operation === \"register\" ? \"SETTING_REGISTRATION_FAILED\" : \"SETTING_VALIDATION_FAILED\";\r\n    }\r\n\r\n    return {\r\n      code,\r\n      message: `Failed to ${operation} setting \"${namespace}.${key}\": ${foundryError.message}`,\r\n      details: foundryError,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundrySettingsAdapter.\r\n */\r\nexport class DIFoundrySettingsAdapter extends FoundrySettingsAdapter {\r\n  static dependencies = [foundrySettingsToken] as const;\r\n\r\n  constructor(foundrySettings: FoundrySettings) {\r\n    super(foundrySettings);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { platformSettingsPortToken } from \"@/infrastructure/shared/tokens\";\r\nimport { DIFoundrySettingsAdapter } from \"@/infrastructure/adapters/foundry/settings-adapters/foundry-settings-adapter\";\r\n\r\n/**\r\n * Registers settings port services.\r\n *\r\n * Services registered:\r\n * - PlatformSettingsPort (singleton) - Platform-agnostic settings handling\r\n *\r\n * DESIGN: Settings ports are platform-agnostic abstractions over settings systems.\r\n * They enable multi-VTT support by decoupling from Foundry-specific APIs.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerSettingsPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register PlatformSettingsPort (Foundry implementation)\r\n  const settingsPortResult = container.registerClass(\r\n    platformSettingsPortToken,\r\n    DIFoundrySettingsAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsPortResult)) {\r\n    return err(`Failed to register PlatformSettingsPort: ${settingsPortResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","import { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { ok, err, isErr } from \"@/infrastructure/shared/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport {\r\n  environmentConfigToken,\r\n  containerHealthCheckToken,\r\n  metricsHealthCheckToken,\r\n  healthCheckRegistryToken,\r\n  metricsCollectorToken,\r\n  serviceContainerToken,\r\n  runtimeConfigToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\nimport { DIContainerHealthCheck } from \"@/application/health/ContainerHealthCheck\";\r\nimport { DIMetricsHealthCheck } from \"@/application/health/MetricsHealthCheck\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\n\r\n// Import config modules\r\nimport { registerCoreServices } from \"@/framework/config/modules/core-services.config\";\r\nimport { registerObservability } from \"@/framework/config/modules/observability.config\";\r\nimport {\r\n  registerPortInfrastructure,\r\n  registerPortRegistries,\r\n} from \"@/framework/config/modules/port-infrastructure.config\";\r\nimport { registerFoundryServices } from \"@/framework/config/modules/foundry-services.config\";\r\nimport { registerUtilityServices } from \"@/framework/config/modules/utility-services.config\";\r\nimport { registerCacheServices } from \"@/framework/config/modules/cache-services.config\";\r\nimport { registerI18nServices } from \"@/framework/config/modules/i18n-services.config\";\r\nimport { registerNotifications } from \"@/framework/config/modules/notifications.config\";\r\nimport { registerRegistrars } from \"@/framework/config/modules/registrars.config\";\r\nimport { registerEventPorts } from \"@/framework/config/modules/event-ports.config\";\r\nimport { registerEntityPorts } from \"@/framework/config/modules/entity-ports.config\";\r\nimport { registerSettingsPorts } from \"@/framework/config/modules/settings-ports.config\";\r\n\r\n/**\r\n * Registers static bootstrap values that already exist outside the container.\r\n */\r\nfunction registerStaticValues(container: ServiceContainer): Result<void, string> {\r\n  const envResult = container.registerValue(environmentConfigToken, ENV);\r\n  if (isErr(envResult)) {\r\n    return err(`Failed to register EnvironmentConfig: ${envResult.error.message}`);\r\n  }\r\n\r\n  const runtimeConfigResult = container.registerValue(runtimeConfigToken, createRuntimeConfig(ENV));\r\n  if (isErr(runtimeConfigResult)) {\r\n    return err(`Failed to register RuntimeConfigService: ${runtimeConfigResult.error.message}`);\r\n  }\r\n\r\n  const containerResult = container.registerValue(serviceContainerToken, container);\r\n  if (isErr(containerResult)) {\r\n    return err(`Failed to register ServiceContainer: ${containerResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers sub-container style values (e.g., Foundry Port registries).\r\n */\r\nfunction registerSubcontainerValues(container: ServiceContainer): Result<void, string> {\r\n  return registerPortRegistries(container);\r\n}\r\n\r\n/**\r\n * Registers loop-prevention health checks with DI metadata.\r\n */\r\nfunction registerLoopPreventionServices(container: ServiceContainer): Result<void, string> {\r\n  const containerCheckResult = container.registerClass(\r\n    containerHealthCheckToken,\r\n    DIContainerHealthCheck,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(containerCheckResult)) {\r\n    return err(`Failed to register ContainerHealthCheck: ${containerCheckResult.error.message}`);\r\n  }\r\n\r\n  const metricsCheckResult = container.registerClass(\r\n    metricsHealthCheckToken,\r\n    DIMetricsHealthCheck,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(metricsCheckResult)) {\r\n    return err(`Failed to register MetricsHealthCheck: ${metricsCheckResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Instantiates loop-prevention services (health checks) after validation.\r\n */\r\nfunction initializeLoopPreventionValues(container: ServiceContainer): Result<void, string> {\r\n  const registryRes = container.resolveWithError(healthCheckRegistryToken);\r\n  const metricsRes = container.resolveWithError(metricsCollectorToken);\r\n  if (!registryRes.ok) {\r\n    return err(`Failed to resolve HealthCheckRegistry: ${registryRes.error.message}`);\r\n  }\r\n  if (!metricsRes.ok) {\r\n    return err(`Failed to resolve MetricsCollector: ${metricsRes.error.message}`);\r\n  }\r\n\r\n  const containerCheckResult = container.resolveWithError(containerHealthCheckToken);\r\n  if (!containerCheckResult.ok) {\r\n    return err(`Failed to resolve ContainerHealthCheck: ${containerCheckResult.error.message}`);\r\n  }\r\n\r\n  const metricsCheckResult = container.resolveWithError(metricsHealthCheckToken);\r\n  if (!metricsCheckResult.ok) {\r\n    return err(`Failed to resolve MetricsHealthCheck: ${metricsCheckResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Validates the container configuration.\r\n * Ensures all dependencies are resolvable and no circular dependencies exist.\r\n */\r\nfunction validateContainer(container: ServiceContainer): Result<void, string> {\r\n  const validateResult = container.validate();\r\n  if (isErr(validateResult)) {\r\n    const errorMessages = validateResult.error.map((e) => e.message).join(\", \");\r\n    return err(`Validation failed: ${errorMessages}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Configures all dependency injection mappings for the application.\r\n *\r\n * RESPONSIBILITY: Orchestrate registration of all service modules.\r\n *\r\n * DESIGN PRINCIPLES:\r\n * - Services are self-configuring via constructor dependencies\r\n * - Observability uses self-registration pattern\r\n * - No manual wiring - all connections via DI\r\n * - Modular config files by domain\r\n *\r\n * REGISTRATION ORDER:\r\n * 1. Static Values (EnvironmentConfig)\r\n * 2. Core Services (Logger, Metrics, ModuleHealth)\r\n * 3. Observability (EventEmitter, ObservabilityRegistry)\r\n * 4. Utility Services (Performance, Retry)\r\n * 5. Port Infrastructure (PortSelector)\r\n * 6. Subcontainer Values (Foundry Port Registries)\r\n * 7. Foundry Services (Game, Hooks, Document, UI, Settings, Journal)\r\n * 8. Settings Ports (PlatformSettingsPort)\r\n * 9. I18n Services (FoundryI18n, LocalI18n, I18nFacade, TranslationHandlers)\r\n * 10. Notifications (NotificationCenter, ConsoleChannel, UIChannel)\r\n * 11. Event Ports (PlatformJournalEventPort, Use-Cases, ModuleEventRegistrar)\r\n * 12. Registrars (ModuleSettingsRegistrar, ModuleHookRegistrar)\r\n * 13. Validation (Check dependency graph)\r\n * 14. Loop-Prevention Services (Health checks referencing validated services)\r\n *\r\n * @param container - The service container to configure\r\n * @returns Result indicating success or configuration errors\r\n *\r\n * @example\r\n * ```typescript\r\n * const container = ServiceContainer.createRoot();\r\n * const result = configureDependencies(container);\r\n * if (isOk(result)) {\r\n *   const logger = container.resolve(loggerToken);\r\n * }\r\n * ```\r\n */\r\nexport function configureDependencies(container: ServiceContainer): Result<void, string> {\r\n  const staticValuesResult = registerStaticValues(container);\r\n  if (isErr(staticValuesResult)) return staticValuesResult;\r\n\r\n  // Register all service modules in order\r\n  const coreResult = registerCoreServices(container);\r\n  if (isErr(coreResult)) return coreResult;\r\n\r\n  const observabilityResult = registerObservability(container);\r\n  if (isErr(observabilityResult)) return observabilityResult;\r\n\r\n  const utilityResult = registerUtilityServices(container);\r\n  if (isErr(utilityResult)) return utilityResult;\r\n\r\n  const cacheServiceResult = registerCacheServices(container);\r\n  if (isErr(cacheServiceResult)) return cacheServiceResult;\r\n\r\n  const portInfraResult = registerPortInfrastructure(container);\r\n  if (isErr(portInfraResult)) return portInfraResult;\r\n\r\n  const subcontainerValuesResult = registerSubcontainerValues(container);\r\n  if (isErr(subcontainerValuesResult)) return subcontainerValuesResult;\r\n\r\n  const foundryServicesResult = registerFoundryServices(container);\r\n  if (isErr(foundryServicesResult)) return foundryServicesResult;\r\n\r\n  const settingsPortsResult = registerSettingsPorts(container);\r\n  if (isErr(settingsPortsResult)) return settingsPortsResult;\r\n\r\n  const entityPortsResult = registerEntityPorts(container);\r\n  if (isErr(entityPortsResult)) return entityPortsResult;\r\n\r\n  const i18nServicesResult = registerI18nServices(container);\r\n  if (isErr(i18nServicesResult)) return i18nServicesResult;\r\n\r\n  const notificationsResult = registerNotifications(container);\r\n  if (isErr(notificationsResult)) return notificationsResult;\r\n\r\n  const eventPortsResult = registerEventPorts(container);\r\n  if (isErr(eventPortsResult)) return eventPortsResult;\r\n\r\n  const registrarsResult = registerRegistrars(container);\r\n  if (isErr(registrarsResult)) return registrarsResult;\r\n\r\n  const loopServiceResult = registerLoopPreventionServices(container);\r\n  if (isErr(loopServiceResult)) return loopServiceResult;\r\n\r\n  // Validate container configuration\r\n  const validationResult = validateContainer(container);\r\n  if (isErr(validationResult)) return validationResult;\r\n\r\n  const loopPreventionInitResult = initializeLoopPreventionValues(container);\r\n  if (isErr(loopPreventionInitResult)) return loopPreventionInitResult;\r\n\r\n  return ok(undefined);\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport { ConsoleLoggerService } from \"./ConsoleLoggerService\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\n\r\n/**\r\n * Logger für die Bootstrap-Phase (vor Container-Validierung).\r\n *\r\n * Wird ausschließlich in Komponenten verwendet, die bereits vor `container.validate()`\r\n * Logging benötigen (z. B. CompositionRoot, configureDependencies).\r\n */\r\nexport class BootstrapLoggerService extends ConsoleLoggerService {\r\n  constructor() {\r\n    super(createRuntimeConfig(ENV));\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function for creating a bootstrap logger instance.\r\n *\r\n * Follows the Dependency Inversion Principle (DIP) by using a factory function\r\n * instead of directly exporting a concrete instance.\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { createBootstrapLogger } from \"@/infrastructure/logging/BootstrapLogger\";\r\n *\r\n * const logger = createBootstrapLogger();\r\n * logger.error(\"Bootstrap error\", error);\r\n * ```\r\n *\r\n * @returns A new Logger instance for bootstrap phase\r\n */\r\nexport function createBootstrapLogger(): Logger {\r\n  return new BootstrapLoggerService();\r\n}\r\n\r\n/**\r\n * Default bootstrap logger instance.\r\n *\r\n * **Note:** For new code, prefer using `createBootstrapLogger()` to follow DIP.\r\n * This export is maintained for backward compatibility.\r\n */\r\nexport const BOOTSTRAP_LOGGER: Logger = createBootstrapLogger();\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { configureDependencies } from \"@/framework/config/dependencyconfig\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { BootstrapPerformanceTracker } from \"@/infrastructure/observability/bootstrap-performance-tracker\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens\";\r\nimport { createBootstrapLogger } from \"@/infrastructure/logging/BootstrapLogger\";\r\nimport { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\n\r\n/**\r\n * CompositionRoot\r\n *\r\n * Responsible for DI-Container bootstrap only.\r\n * Creates the ServiceContainer and performs service registrations via configureDependencies.\r\n *\r\n * Responsibilities:\r\n * - Create ServiceContainer (createRoot)\r\n * - Execute configureDependencies (all service registrations)\r\n * - Track bootstrap performance\r\n * - Provide container access via getContainer()\r\n *\r\n * NOT responsible for:\r\n * - API exposition (handled by ModuleApiInitializer)\r\n * - Event listener registration (handled by ModuleEventRegistrar)\r\n * - Settings registration (handled by ModuleSettingsRegistrar)\r\n */\r\nexport class CompositionRoot {\r\n  private container: ServiceContainer | null = null;\r\n\r\n  /**\r\n   * Erstellt den ServiceContainer und führt Basis-Registrierungen aus.\r\n   * Misst Performance für Diagnose-Zwecke.\r\n   *\r\n   * **Performance Tracking:**\r\n   * Uses BootstrapPerformanceTracker with ENV (direct import) and null MetricsCollector.\r\n   * MetricsCollector is not yet available during bootstrap phase.\r\n   *\r\n   * @returns Result mit initialisiertem Container oder Fehlermeldung\r\n   */\r\n  bootstrap(): Result<ServiceContainer, string> {\r\n    const container = ServiceContainer.createRoot();\r\n\r\n    // Track bootstrap performance (no MetricsCollector yet)\r\n    const runtimeConfig = createRuntimeConfig(ENV);\r\n    const performanceTracker = new BootstrapPerformanceTracker(runtimeConfig, null);\r\n\r\n    const configured = performanceTracker.track(\r\n      () => configureDependencies(container),\r\n      (duration) => {\r\n        // Use logger from container if available (container is validated at this point)\r\n        const loggerResult = container.resolveWithError(loggerToken);\r\n        if (loggerResult.ok) {\r\n          loggerResult.value.debug(`Bootstrap completed in ${duration.toFixed(2)}ms`);\r\n        }\r\n      }\r\n    );\r\n\r\n    if (configured.ok) {\r\n      this.container = container;\r\n      return { ok: true, value: container };\r\n    }\r\n\r\n    createBootstrapLogger().error(\r\n      \"Failed to configure dependencies during bootstrap\",\r\n      configured.error\r\n    );\r\n    return { ok: false, error: configured.error };\r\n  }\r\n\r\n  /**\r\n   * Liefert den initialisierten Container als Result.\r\n   * @returns Result mit Container oder Fehlermeldung\r\n   */\r\n  getContainer(): Result<ServiceContainer, string> {\r\n    if (!this.container) {\r\n      return { ok: false, error: `${MODULE_CONSTANTS.LOG_PREFIX} Container not initialized` };\r\n    }\r\n    return { ok: true, value: this.container };\r\n  }\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Context information for error logging.\r\n * Provides structured metadata about where and when an error occurred.\r\n */\r\nexport interface ErrorContext {\r\n  /** Phase of module lifecycle when error occurred */\r\n  phase: \"bootstrap\" | \"initialization\" | \"runtime\";\r\n  /** Component or service where error originated */\r\n  component?: string;\r\n  /** Additional contextual metadata */\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Centralized error handler for bootstrap and initialization errors.\r\n *\r\n * Provides structured, grouped error logging in the browser console.\r\n * Uses console.group() for clear, collapsible output that's easy to\r\n * screenshot and share for debugging.\r\n *\r\n * @remarks\r\n * Foundry v13 does not write module console logs to error.log files,\r\n * so this handler optimizes for browser console readability.\r\n *\r\n * @example\r\n * ```typescript\r\n * BootstrapErrorHandler.logError(error, {\r\n *   phase: 'bootstrap',\r\n *   component: 'CompositionRoot',\r\n *   metadata: { foundryVersion: 13 }\r\n * });\r\n * ```\r\n */\r\nexport class BootstrapErrorHandler {\r\n  /**\r\n   * Logs an error with structured context in the browser console.\r\n   *\r\n   * Creates a collapsible group with timestamp, phase, component,\r\n   * error details, and metadata for easy debugging and screenshotting.\r\n   *\r\n   * @param error - The error that occurred (Error object, string, or unknown)\r\n   * @param context - Context information about the error\r\n   */\r\n  static logError(error: unknown, context: ErrorContext): void {\r\n    const timestamp = new Date().toISOString();\r\n\r\n    console.group(`[${timestamp}] ${MODULE_CONSTANTS.LOG_PREFIX} Error in ${context.phase}`);\r\n\r\n    if (context.component) {\r\n      console.error(\"Component:\", context.component);\r\n    }\r\n\r\n    console.error(\"Error:\", error);\r\n\r\n    if (context.metadata && Object.keys(context.metadata).length > 0) {\r\n      console.error(\"Metadata:\", context.metadata);\r\n    }\r\n\r\n    console.groupEnd();\r\n  }\r\n}\r\n","import { MODULE_CONSTANTS } from \"@/infrastructure/shared/constants\";\r\nimport { isOk } from \"@/infrastructure/shared/utils/result\";\r\nimport {\r\n  loggerToken,\r\n  bootstrapInitHookServiceToken,\r\n  bootstrapReadyHookServiceToken,\r\n} from \"@/infrastructure/shared/tokens\";\r\nimport { CompositionRoot } from \"@/framework/core/composition-root\";\r\nimport { tryGetFoundryVersion } from \"@/infrastructure/adapters/foundry/versioning/versiondetector\";\r\nimport { BootstrapErrorHandler } from \"@/framework/core/bootstrap-error-handler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { BootstrapInitHookService } from \"@/framework/core/bootstrap-init-hook\";\r\nimport type { BootstrapReadyHookService } from \"@/framework/core/bootstrap-ready-hook\";\r\n\r\n/**\r\n * Boot-Orchestrierung für das Modul.\r\n *\r\n * Ablauf:\r\n * - Vor init: DI-Container erstellen (CompositionRoot.bootstrap) und bei Fehler abbrechen\r\n * - In init: API (resolve) exponieren, Ports selektieren/binden (via externem Selector), Hooks registrieren\r\n * - In ready: nur Logging o.ä. – Services sind über api.resolve nutzbar\r\n */\r\n\r\n/**\r\n * Function to encapsulate initialization logic.\r\n * This allows us to use return statements for soft aborts.\r\n *\r\n * NOTE: The function is fully covered via init-solid.test.ts; only truly\r\n * environment-dependent branches (Foundry globals) use fine-grained v8 ignores.\r\n */\r\nfunction initializeFoundryModule(): void {\r\n  const containerResult = root.getContainer();\r\n  /* v8 ignore start -- @preserve */\r\n  // Edge case: getContainer() fails after successful bootstrap.\r\n  // This is extremely unlikely in practice, but the error path exists for defensive programming.\r\n  // The root instance is created at module level (line 162), making it difficult to mock\r\n  // this specific error path in tests. The code path exists and will execute in real scenarios.\r\n  if (!containerResult.ok) {\r\n    console.error(`${MODULE_CONSTANTS.LOG_PREFIX} ${containerResult.error}`);\r\n    return;\r\n  }\r\n  /* v8 ignore stop -- @preserve */\r\n\r\n  const loggerResult = containerResult.value.resolveWithError(loggerToken);\r\n  if (!loggerResult.ok) {\r\n    console.error(\r\n      `${MODULE_CONSTANTS.LOG_PREFIX} Failed to resolve logger: ${loggerResult.error.message}`\r\n    );\r\n    return;\r\n  }\r\n  const logger = loggerResult.value;\r\n\r\n  // Resolve bootstrap hook services and register hooks\r\n  // CRITICAL: Use direct Hooks.on() for init/ready hooks to avoid chicken-egg problem.\r\n  // The PlatformEventPort system requires version detection (game.version), but game.version\r\n  // might not be available before the init hook runs. These bootstrap hooks must be registered\r\n  // immediately, so we use direct Foundry Hooks API here.\r\n  // All other hooks (registered inside init) can use PlatformEventPort normally.\r\n  const initHookServiceResult = containerResult.value.resolveWithError<BootstrapInitHookService>(\r\n    bootstrapInitHookServiceToken\r\n  );\r\n  if (!initHookServiceResult.ok) {\r\n    logger.error(\r\n      `Failed to resolve BootstrapInitHookService: ${initHookServiceResult.error.message}`\r\n    );\r\n    return;\r\n  }\r\n  initHookServiceResult.value.register();\r\n\r\n  const readyHookServiceResult = containerResult.value.resolveWithError<BootstrapReadyHookService>(\r\n    bootstrapReadyHookServiceToken\r\n  );\r\n  if (!readyHookServiceResult.ok) {\r\n    logger.error(\r\n      `Failed to resolve BootstrapReadyHookService: ${readyHookServiceResult.error.message}`\r\n    );\r\n    return;\r\n  }\r\n  readyHookServiceResult.value.register();\r\n}\r\n\r\n// Eager bootstrap DI before Foundry init\r\nconst root = new CompositionRoot();\r\nconst bootstrapResult = root.bootstrap();\r\nconst bootstrapOk = isOk(bootstrapResult);\r\n\r\n/**\r\n * Internal export for testing purposes only.\r\n * Returns the container from init-solid.ts.\r\n * This allows integration tests to use the same container instance as the module.\r\n *\r\n * @internal - For testing only\r\n */\r\nexport function getRootContainer(): Result<ServiceContainer, string> {\r\n  return root.getContainer();\r\n}\r\n\r\n/* v8 ignore start -- @preserve */\r\n/* Bootstrap-Fehlerpfade sind stark Foundry-versionsabhängig und schwer\r\n * deterministisch in Unit-Tests abzudecken. Die Logik wird über Integrationspfade geprüft;\r\n * für das Coverage-Gateway markieren wir diese Zweige vorerst als ignoriert. */\r\nif (!bootstrapOk) {\r\n  // Detect version once and reuse for both error logging and version-specific checks\r\n  const foundryVersion = tryGetFoundryVersion();\r\n\r\n  BootstrapErrorHandler.logError(bootstrapResult.error, {\r\n    phase: \"bootstrap\",\r\n    component: \"CompositionRoot\",\r\n    metadata: {\r\n      foundryVersion,\r\n    },\r\n  });\r\n\r\n  // Check if error is due to old Foundry version\r\n  let isOldFoundryVersion = false;\r\n  if (\r\n    typeof bootstrapResult.error === \"string\" &&\r\n    bootstrapResult.error.includes(\"PORT_SELECTION_FAILED\")\r\n  ) {\r\n    if (foundryVersion !== undefined && foundryVersion < 13) {\r\n      isOldFoundryVersion = true;\r\n      /* v8 ignore next -- @preserve */\r\n      if (typeof ui !== \"undefined\" && ui?.notifications) {\r\n        ui.notifications.error(\r\n          `${MODULE_CONSTANTS.MODULE.NAME} benötigt mindestens Foundry VTT Version 13. ` +\r\n            `Ihre Version: ${foundryVersion}. Bitte aktualisieren Sie Foundry VTT.`,\r\n          { permanent: true }\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Show generic error notification (only if not old Foundry version)\r\n  if (!isOldFoundryVersion && typeof ui !== \"undefined\" && ui?.notifications) {\r\n    ui.notifications?.error(\r\n      `${MODULE_CONSTANTS.MODULE.NAME} failed to initialize. Check console for details.`,\r\n      { permanent: true }\r\n    );\r\n  }\r\n\r\n  // Soft abort: Don't proceed with initialization\r\n  // (no throw, no return - just don't call initializeFoundryModule)\r\n} else {\r\n  // Only initialize if bootstrap succeeded\r\n  initializeFoundryModule();\r\n}\r\n/* v8 ignore stop -- @preserve */\r\n"],"names":["_disposed","value","map","transform","getFallback","promise","description","ServiceLifecycle","SL","instance","entries","array","instanceResult","LogLevel","fallback","parser","config","maxLength","message","check","v.picklist","v.boolean","v.pipe","v.number","v.minValue","v.integer","v.maxValue","v.string","v.minLength","v.object","v.optional","v.record","v.unknown","v.custom","v.safeParse","v.array","v.any","document","args","game","ui","metadata","partial","maxEntries","regex"],"mappings":"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","x_google_ignoreList":[46]}