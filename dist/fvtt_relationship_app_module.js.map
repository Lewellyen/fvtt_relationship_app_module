{"version":3,"file":"fvtt_relationship_app_module.js","sources":["../src/application/constants/app-constants.ts","../src/domain/utils/result/creation.ts","../src/domain/utils/result/guards.ts","../src/domain/utils/result/transformation.ts","../src/domain/utils/result/unwrapping.ts","../src/domain/utils/result/combination.ts","../src/domain/utils/result/error-handling.ts","../src/domain/utils/result/async.ts","../src/application/di/token-factory.ts","../src/infrastructure/shared/tokens/core/logger.token.ts","../src/infrastructure/shared/tokens/core/bootstrap-init-hook-service.token.ts","../src/infrastructure/shared/tokens/core/bootstrap-ready-hook-service.token.ts","../src/domain/types/log-level.ts","../src/framework/config/environment.ts","../src/infrastructure/observability/performance-tracker-impl.ts","../src/infrastructure/observability/bootstrap-performance-tracker.ts","../src/framework/core/bootstrap-error-handler.ts","../src/application/services/RuntimeConfigService.ts","../src/application/services/RuntimeConfigStore.ts","../src/application/services/RuntimeConfigEventEmitter.ts","../src/application/services/runtime-config-factory.ts","../src/infrastructure/config/runtime-config-adapter.ts","../src/infrastructure/di/types/utilities/runtime-safe-cast.ts","../src/infrastructure/di/types/utilities/api-safe-token.ts","../src/infrastructure/di/types/core/servicelifecycle.ts","../src/infrastructure/di/types/core/serviceregistration.ts","../src/infrastructure/di/registry/TypeSafeRegistrationMap.ts","../src/infrastructure/di/registry/ServiceRegistry.ts","../src/infrastructure/di/validation/ContainerValidator.ts","../src/infrastructure/di/cache/InstanceCache.ts","../src/infrastructure/di/resolution/strategies/singleton-resolution-strategy.ts","../src/infrastructure/di/resolution/strategies/transient-resolution-strategy.ts","../src/infrastructure/di/resolution/strategies/scoped-resolution-strategy.ts","../src/infrastructure/di/resolution/lifecycle-resolver.ts","../src/infrastructure/di/resolution/service-instantiator.ts","../src/infrastructure/di/resolution/ServiceResolver.ts","../src/infrastructure/di/scope/ScopeManager.ts","../src/infrastructure/shared/utils/promise-timeout.ts","../src/infrastructure/shared/tokens/observability/metrics-collector.token.ts","../src/infrastructure/di/registration/ServiceRegistrationManager.ts","../src/infrastructure/di/validation/ContainerValidationManager.ts","../src/infrastructure/di/errors/ContainerErrorImpl.ts","../src/infrastructure/di/resolution/ServiceResolutionManager.ts","../src/infrastructure/di/scope/ScopeManagementFacade.ts","../src/infrastructure/di/metrics/MetricsInjectionManager.ts","../src/infrastructure/di/security/ApiSecurityManager.ts","../src/infrastructure/di/container.ts","../src/infrastructure/di/factory/ContainerBootstrapFactory.ts","../src/framework/core/factory/container-factory.ts","../src/infrastructure/shared/tokens/core/environment-config.token.ts","../src/infrastructure/shared/tokens/core/container-health-check.token.ts","../src/infrastructure/shared/tokens/core/metrics-health-check.token.ts","../src/application/tokens/health-check-registry.token.ts","../src/infrastructure/shared/tokens/core/service-container.token.ts","../src/application/tokens/runtime-config.token.ts","../src/application/tokens/domain-ports.tokens.ts","../src/application/health/ContainerHealthCheck.ts","../src/application/health/MetricsHealthCheck.ts","../src/infrastructure/shared/tokens/infrastructure/module-id.token.ts","../src/framework/config/dependency-registry.ts","../src/infrastructure/shared/tokens/foundry/port-selector.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-game-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-hooks-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-document-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-ui-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-settings-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-i18n-port-registry.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-module-port-registry.token.ts","../src/infrastructure/adapters/foundry/errors/FoundryErrors.ts","../src/infrastructure/shared/tokens/observability/port-selection-event-emitter.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-version-detector.token.ts","../src/infrastructure/adapters/foundry/versioning/port-resolution-strategy.ts","../src/infrastructure/shared/tokens/observability/port-selection-observability.token.ts","../src/infrastructure/shared/tokens/observability/port-selection-performance-tracker.token.ts","../src/infrastructure/shared/tokens/observability/port-selection-observer.token.ts","../src/infrastructure/adapters/foundry/versioning/greedy-port-match-strategy.ts","../src/infrastructure/adapters/foundry/versioning/portselector.ts","../src/infrastructure/adapters/foundry/versioning/versiondetector.ts","../src/infrastructure/adapters/foundry/versioning/foundry-version-detector.ts","../src/infrastructure/adapters/foundry/versioning/portregistry.ts","../node_modules/valibot/dist/index.mjs","../src/infrastructure/adapters/foundry/validation/schemas.ts","../src/infrastructure/shared/constants.ts","../src/infrastructure/adapters/foundry/validation/input-validators.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13GamePort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13HooksPort.ts","../src/infrastructure/shared/utils/type-guards.ts","../src/infrastructure/adapters/foundry/runtime-casts.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13DocumentPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13UIPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13SettingsPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13I18nPort.ts","../src/infrastructure/adapters/foundry/ports/v13/FoundryV13ModulePort.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-game-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-hooks-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-document-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-ui-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-settings-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-i18n-port.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-v13-module-port.token.ts","../src/infrastructure/adapters/foundry/ports/v13/port-registration.ts","../src/infrastructure/shared/tokens/foundry/foundry-ui.token.ts","../src/infrastructure/adapters/foundry/adapters/foundry-ui-adapter.ts","../src/infrastructure/validation/log-level-schema.ts","../src/infrastructure/validation/valibot-validation-adapter.ts","../src/infrastructure/validation/di-valibot-validation-adapter.ts","../src/infrastructure/observability/metrics-snapshot-adapter.ts","../src/infrastructure/observability/di-metrics-snapshot-adapter.ts","../src/framework/config/modules/port-infrastructure.config.ts","../src/infrastructure/shared/tokens/infrastructure/cache-service-config.token.ts","../src/infrastructure/shared/tokens/infrastructure/cache-service.token.ts","../src/infrastructure/shared/tokens/infrastructure/cache-config-sync.token.ts","../src/infrastructure/shared/tokens/infrastructure/cache-maintenance-port.token.ts","../src/infrastructure/cache/store/CacheStore.ts","../src/infrastructure/cache/expiration/CacheExpirationManager.ts","../src/infrastructure/cache/statistics/CacheStatisticsCollector.ts","../src/infrastructure/cache/config/CacheConfigManager.ts","../src/infrastructure/cache/cache-capacity-manager.ts","../src/infrastructure/cache/lru-eviction-strategy.ts","../src/infrastructure/cache/eviction-strategy-registry.ts","../src/infrastructure/cache/cache-metrics-collector.ts","../src/infrastructure/di/types/utilities/type-casts.ts","../src/infrastructure/cache/runtime/CacheRuntime.ts","../src/infrastructure/cache/policy/CachePolicy.ts","../src/infrastructure/cache/telemetry/CacheTelemetry.ts","../src/infrastructure/cache/factory/CacheCompositionFactory.ts","../src/infrastructure/cache/CacheService.ts","../src/infrastructure/cache/config/CacheConfigSyncObserver.ts","../src/infrastructure/cache/CacheConfigSync.ts","../src/infrastructure/adapters/cache/platform-cache-port-adapter.ts","../src/framework/config/modules/cache-services.config.ts","../src/infrastructure/shared/tokens/ports/platform-bootstrap-event-port.token.ts","../src/infrastructure/shared/tokens/observability/metrics-recorder.token.ts","../src/infrastructure/shared/tokens/observability/metrics-sampler.token.ts","../src/infrastructure/shared/tokens/observability/metrics-reporter.token.ts","../src/infrastructure/shared/tokens/observability/trace-context.token.ts","../src/infrastructure/shared/tokens/observability/metrics-storage.token.ts","../src/infrastructure/shared/tokens/observability/metrics-aggregator.token.ts","../src/infrastructure/shared/tokens/observability/metrics-persistence-manager.token.ts","../src/infrastructure/shared/tokens/observability/metrics-state-manager.token.ts","../src/infrastructure/shared/tokens/infrastructure/module-api-initializer.token.ts","../src/infrastructure/shared/tokens/core/module-health-service.token.ts","../src/infrastructure/observability/metrics-definition/metric-casts.ts","../src/infrastructure/observability/metrics-definition/metric-definition-registry.ts","../src/infrastructure/observability/metrics-definition/default-metric-definitions.ts","../src/infrastructure/observability/metrics-collector.ts","../src/infrastructure/observability/metrics-persistence/persistent-metrics-collector.ts","../src/infrastructure/observability/metrics-aggregator.ts","../src/infrastructure/observability/metrics-persistence/metrics-persistence-manager.ts","../src/infrastructure/observability/metrics-state/metrics-state-manager.ts","../src/infrastructure/observability/metrics-sampler.ts","../src/infrastructure/observability/metrics-reporter.ts","../src/infrastructure/observability/metrics-persistence/local-storage-metrics-storage.ts","../src/infrastructure/observability/metrics-persistence/metrics-storage-factory.ts","../src/infrastructure/logging/TracedLogger.ts","../src/infrastructure/logging/BaseConsoleLogger.ts","../src/infrastructure/logging/RuntimeConfigLoggerDecorator.ts","../src/infrastructure/logging/StackTraceLoggerDecorator.ts","../src/infrastructure/logging/TraceContextLoggerDecorator.ts","../src/infrastructure/logging/factory/logger-composition-factory.ts","../src/infrastructure/logging/ConsoleLoggerService.ts","../src/infrastructure/shared/utils/trace.ts","../src/infrastructure/observability/trace/TraceContext.ts","../src/application/services/ModuleHealthService.ts","../src/application/tokens/notifications/notification-center.token.ts","../src/application/tokens/application.tokens.ts","../src/infrastructure/shared/tokens/i18n/i18n-facade.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-game.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-hooks.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-document.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-settings.token.ts","../src/infrastructure/shared/tokens/foundry/foundry-journal-facade.token.ts","../src/framework/core/api/api-token-config.ts","../src/framework/core/api/builder/module-api-builder.ts","../src/framework/core/api/wrappers/strategies/api-wrapper-strategy-registry.ts","../src/framework/core/api/readonly-wrapper.ts","../src/framework/core/api/public-api-wrappers.ts","../src/infrastructure/di/types/utilities/api-casts.ts","../src/framework/core/api/wrappers/strategies/i18n-wrapper-strategy.ts","../src/framework/core/api/wrappers/strategies/notification-wrapper-strategy.ts","../src/framework/core/api/wrappers/strategies/settings-wrapper-strategy.ts","../src/framework/core/api/wrappers/strategies/noop-wrapper-strategy.ts","../src/framework/core/api/wrappers/service-wrapper-factory.ts","../src/infrastructure/shared/utils/format-deprecation-info.ts","../src/infrastructure/di/types/utilities/deprecated-token.ts","../src/framework/core/api/deprecation/deprecation-handler.ts","../src/framework/core/api/resolution/api-service-resolver.ts","../src/framework/core/api/health/api-health-metrics-provider.ts","../src/framework/core/api/module-api-initializer.ts","../src/application/health/HealthCheckRegistry.ts","../src/infrastructure/health/health-check-registry-adapter.ts","../src/framework/core/bootstrap/init-phase-registry.ts","../src/framework/core/bootstrap/init-phase.interface.ts","../src/framework/core/bootstrap/orchestrators/metrics-bootstrapper.ts","../src/framework/core/bootstrap/phases/metrics-init-phase.ts","../src/application/tokens/notifications/queued-ui-channel.token.ts","../src/framework/core/bootstrap/orchestrators/notification-bootstrapper.ts","../src/framework/core/bootstrap/phases/notification-init-phase.ts","../src/framework/core/bootstrap/orchestrators/api-bootstrapper.ts","../src/framework/core/bootstrap/phases/api-init-phase.ts","../src/infrastructure/shared/tokens/core/module-settings-registrar.token.ts","../src/framework/core/bootstrap/orchestrators/settings-bootstrapper.ts","../src/framework/core/bootstrap/phases/settings-init-phase.ts","../src/framework/core/bootstrap/orchestrators/logging-bootstrapper.ts","../src/framework/core/bootstrap/phases/logging-init-phase.ts","../src/application/tokens/event.tokens.ts","../src/framework/core/bootstrap/orchestrators/events-bootstrapper.ts","../src/framework/core/bootstrap/phases/events-init-phase.ts","../src/infrastructure/shared/tokens/foundry/journal-context-menu-lib-wrapper-service.token.ts","../src/framework/core/bootstrap/orchestrators/context-menu-bootstrapper.ts","../src/framework/core/bootstrap/phases/context-menu-init-phase.ts","../src/framework/core/bootstrap/orchestrators/sidebar-button-bootstrapper.ts","../src/framework/core/bootstrap/phases/sidebar-button-init-phase.ts","../src/framework/core/bootstrap/default-init-phase-registry.ts","../src/framework/core/bootstrap/init-phase-error-handler.ts","../src/framework/core/bootstrap/init-orchestrator.ts","../src/framework/core/bootstrap-init-hook.ts","../src/application/services/module-ready-service.ts","../src/framework/core/bootstrap-ready-hook.ts","../src/infrastructure/adapters/foundry/bootstrap-hooks-adapter.ts","../src/infrastructure/shared/tokens/infrastructure/retry-service.token.ts","../src/infrastructure/adapters/foundry/services/PortLoader.ts","../src/infrastructure/adapters/foundry/services/RetryableOperation.ts","../src/infrastructure/adapters/foundry/services/FoundryModuleReadyPort.ts","../src/framework/config/modules/core-services.config.ts","../src/infrastructure/shared/tokens/observability/observability-registry.token.ts","../src/infrastructure/adapters/foundry/versioning/port-selection-events.ts","../src/infrastructure/observability/observability-registry.ts","../src/infrastructure/adapters/foundry/versioning/port-selection-observability.ts","../src/infrastructure/adapters/foundry/versioning/port-selection-performance-tracker.ts","../src/infrastructure/adapters/foundry/versioning/port-selection-observer.ts","../src/framework/config/modules/observability.config.ts","../src/infrastructure/adapters/foundry/services/FoundryGamePort.ts","../src/infrastructure/adapters/foundry/services/FoundryHooksPort.ts","../src/infrastructure/adapters/foundry/services/FoundryDocumentPort.ts","../src/infrastructure/adapters/foundry/services/FoundryUIPort.ts","../src/infrastructure/adapters/foundry/services/FoundrySettingsPort.ts","../src/infrastructure/adapters/foundry/facades/foundry-journal-facade.ts","../src/application/utils/sanitize-utils.ts","../src/application/services/JournalVisibilityService.ts","../src/application/utils/array-utils.ts","../src/application/services/JournalDirectoryProcessor.ts","../src/infrastructure/adapters/foundry/services/FoundryLibWrapperService.ts","../src/infrastructure/shared/tokens/foundry/lib-wrapper-service.token.ts","../src/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService.ts","../src/infrastructure/adapters/foundry/settings-adapters/foundry-settings-registration-adapter.ts","../src/framework/config/modules/foundry-services.config.ts","../src/infrastructure/shared/tokens/infrastructure/performance-tracking-service.token.ts","../src/infrastructure/performance/PerformanceTrackingService.ts","../src/infrastructure/retry/BaseRetryService.ts","../src/infrastructure/retry/RetryObservabilityDecorator.ts","../src/infrastructure/retry/RetryService.ts","../src/framework/config/modules/utility-services.config.ts","../src/infrastructure/shared/tokens/i18n/foundry-i18n.token.ts","../src/infrastructure/shared/tokens/i18n/local-i18n.token.ts","../src/infrastructure/shared/tokens/i18n/foundry-translation-handler.token.ts","../src/infrastructure/shared/tokens/i18n/local-translation-handler.token.ts","../src/infrastructure/shared/tokens/i18n/fallback-translation-handler.token.ts","../src/infrastructure/shared/tokens/i18n/translation-handler-chain.token.ts","../src/infrastructure/shared/tokens/i18n/translation-handlers.token.ts","../src/infrastructure/adapters/foundry/services/FoundryI18nPort.ts","../src/infrastructure/i18n/LocalI18nService.ts","../src/infrastructure/i18n/I18nFacadeService.ts","../src/infrastructure/i18n/AbstractTranslationHandler.ts","../src/infrastructure/i18n/FoundryTranslationHandler.ts","../src/infrastructure/i18n/LocalTranslationHandler.ts","../src/infrastructure/i18n/FallbackTranslationHandler.ts","../src/infrastructure/i18n/TranslationHandlerChain.ts","../src/infrastructure/adapters/i18n/platform-i18n-port-adapter.ts","../src/framework/config/modules/i18n-services.config.ts","../src/application/tokens/notifications/console-channel.token.ts","../src/application/tokens/notifications/ui-channel.token.ts","../src/infrastructure/shared/tokens/notifications/notification-queue.token.ts","../src/application/services/NotificationCenter.ts","../src/infrastructure/notifications/channels/ConsoleChannel.ts","../src/infrastructure/notifications/channels/UIChannel.ts","../src/infrastructure/notifications/channels/QueuedUIChannel.ts","../src/infrastructure/adapters/notifications/platform-notification-port-adapter.ts","../src/infrastructure/notifications/NotificationQueue.ts","../src/infrastructure/adapters/foundry/services/FoundryUIAvailabilityPort.ts","../src/framework/config/modules/notifications.config.ts","../src/application/services/ModuleSettingsRegistrar.ts","../src/application/services/RuntimeConfigSync.ts","../src/application/services/runtime-config-settings-sync.ts","../src/application/services/SettingRegistrationErrorMapper.ts","../src/application/utils/registry-casts.ts","../src/application/utils/validate-log-level.ts","../src/application/settings/log-level-setting.ts","../src/application/settings/cache-enabled-setting.ts","../src/application/settings/cache-default-ttl-setting.ts","../src/application/settings/cache-max-entries-setting.ts","../src/application/settings/performance-tracking-setting.ts","../src/application/settings/performance-sampling-setting.ts","../src/application/settings/metrics-persistence-enabled-setting.ts","../src/application/settings/metrics-persistence-key-setting.ts","../src/application/settings/notification-queue-max-size-setting.ts","../src/application/services/registries/default-setting-definition-registry.ts","../src/domain/utils/setting-validators.ts","../src/application/config/runtime-config-bindings.ts","../src/application/services/registries/default-runtime-config-binding-registry.ts","../src/framework/config/modules/registrars.config.ts","../src/infrastructure/adapters/foundry/event-adapters/foundry-journal-event-adapter.ts","../src/infrastructure/adapters/foundry/event-adapters/foundry-journal-ui-event-adapter.ts","../src/application/use-cases/invalidate-journal-cache-on-change.use-case.ts","../src/application/use-cases/process-journal-directory-on-render.use-case.ts","../src/domain/constants/domain-constants.ts","../src/application/use-cases/trigger-journal-directory-rerender.use-case.ts","../src/application/use-cases/register-context-menu.use-case.ts","../src/application/use-cases/show-all-hidden-journals.use-case.ts","../src/application/handlers/hide-journal-context-menu-handler.ts","../src/application/utils/dispose-hooks.ts","../src/application/services/ModuleEventRegistrar.ts","../src/application/services/BatchUpdateContextService.ts","../src/framework/config/modules/event-ports.config.ts","../src/infrastructure/adapters/foundry/mappers/journal-mapper-registry.ts","../src/infrastructure/adapters/foundry/mappers/default-journal-mapper.ts","../src/infrastructure/adapters/foundry/collection-adapters/filter-operator-registry.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/equals-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/not-equals-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/contains-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/starts-with-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/ends-with-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/in-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/not-in-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/greater-than-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/less-than-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/greater-than-or-equal-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/operators/less-than-or-equal-operator.ts","../src/infrastructure/adapters/foundry/collection-adapters/default-filter-operators.ts","../src/infrastructure/adapters/foundry/collection-adapters/foundry-journal-collection-adapter.ts","../src/infrastructure/adapters/foundry/repository-adapters/foundry-journal-repository-adapter.ts","../src/framework/config/modules/entity-ports.config.ts","../src/infrastructure/shared/tokens/foundry/setting-type-mapper.token.ts","../src/infrastructure/shared/tokens/foundry/settings-error-mapper.token.ts","../src/infrastructure/adapters/foundry/settings-adapters/foundry-settings-adapter.ts","../src/infrastructure/adapters/foundry/settings-adapters/mappers/foundry-setting-type-mapper.ts","../src/infrastructure/adapters/foundry/settings-adapters/mappers/foundry-settings-error-mapper.ts","../src/framework/config/modules/settings-ports.config.ts","../src/infrastructure/cache/cache.interface.ts","../src/framework/config/modules/journal-visibility.config.ts","../src/framework/config/dependencyconfig.ts","../src/framework/core/config/dependency-configurator.ts","../src/framework/core/composition-root.ts","../src/framework/core/init-solid.ts"],"sourcesContent":["/**\r\n * Application-layer constants.\r\n *\r\n * Diese Konstanten repräsentieren Application-spezifische Konfiguration,\r\n * die von Application-Services verwendet wird.\r\n */\r\n\r\n/**\r\n * Module metadata.\r\n * Diese Informationen definieren das Modul selbst.\r\n */\r\nexport const MODULE_METADATA = {\r\n  ID: \"fvtt_relationship_app_module\",\r\n  NAME: \"Beziehungsnetzwerke für Foundry\",\r\n  AUTHOR: \"Andreas Rothe\",\r\n  AUTHOR_EMAIL: \"forenadmin.tir@gmail.com\",\r\n  AUTHOR_DISCORD: \"lewellyen\",\r\n} as const;\r\n\r\n/**\r\n * Setting keys für das Modul.\r\n * Diese Keys werden von Application-Services verwendet, um Settings zu lesen/schreiben.\r\n */\r\nexport const SETTING_KEYS = {\r\n  LOG_LEVEL: \"logLevel\",\r\n  CACHE_ENABLED: \"cacheEnabled\",\r\n  CACHE_TTL_MS: \"cacheTtlMs\",\r\n  CACHE_MAX_ENTRIES: \"cacheMaxEntries\",\r\n  PERFORMANCE_TRACKING_ENABLED: \"performanceTrackingEnabled\",\r\n  PERFORMANCE_SAMPLING_RATE: \"performanceSamplingRate\",\r\n  METRICS_PERSISTENCE_ENABLED: \"metricsPersistenceEnabled\",\r\n  METRICS_PERSISTENCE_KEY: \"metricsPersistenceKey\",\r\n  NOTIFICATION_QUEUE_MAX_SIZE: \"notificationQueueMaxSize\",\r\n} as const;\r\n\r\n/**\r\n * Default-Werte für Application-Logic.\r\n */\r\nexport const APP_DEFAULTS = {\r\n  UNKNOWN_NAME: \"Unknown\",\r\n  NO_VERSION_SELECTED: -1,\r\n  CACHE_NOT_INITIALIZED: -1,\r\n  CACHE_TTL_MS: 5000,\r\n} as const;\r\n\r\n/**\r\n * Public API Version.\r\n * Folgt Semantic Versioning: MAJOR.MINOR.PATCH\r\n *\r\n * - MAJOR: Breaking Changes zur Public API\r\n * - MINOR: Neue Features, backwards-compatible\r\n * - PATCH: Bug Fixes, backwards-compatible\r\n */\r\nexport const PUBLIC_API_VERSION = \"1.0.0\";\r\n\r\n/**\r\n * Log-Präfix für alle Log-Ausgaben des Moduls.\r\n */\r\nexport const LOG_PREFIX = \"Relationship App |\";\r\n\r\n// Deep freeze für Runtime-Immutability\r\nObject.freeze(MODULE_METADATA);\r\nObject.freeze(SETTING_KEYS);\r\nObject.freeze(APP_DEFAULTS);\r\n","/**\r\n * Functions for creating Result instances.\r\n */\r\nimport type { Ok, Err } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Creates a successful Result with a value.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @param value - The successful value to wrap\r\n * @returns A Result indicating success with the provided value\r\n *\r\n * @example\r\n * ```typescript\r\n * const success = ok(42);\r\n * // { ok: true, value: 42 }\r\n * ```\r\n */\r\nexport function ok<SuccessType>(value: SuccessType): Ok<SuccessType> {\r\n  return { ok: true, value };\r\n}\r\n\r\n/**\r\n * Creates an error Result with an error value.\r\n *\r\n * @template ErrorType - The type of the error value\r\n * @param error - The error to wrap\r\n * @returns A Result indicating failure with the provided error\r\n *\r\n * @example\r\n * ```typescript\r\n * const failure = err(\"Not found\");\r\n * // { ok: false, error: \"Not found\" }\r\n * ```\r\n */\r\nexport function err<ErrorType>(error: ErrorType): Err<ErrorType> {\r\n  return { ok: false, error };\r\n}\r\n","/**\r\n * Type guards for Result pattern.\r\n */\r\nimport type { Ok, Err, Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Type guard to check if a Result is successful.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @template ErrorType - The type of the error value\r\n * @param result - The Result to check\r\n * @returns True if the Result is successful, narrowing the type to Ok<SuccessType>\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = someOperation();\r\n * if (isOk(result)) {\r\n *   console.log(result.value); // Type-safe access to value\r\n * }\r\n * ```\r\n */\r\nexport function isOk<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>\r\n): result is Ok<SuccessType> {\r\n  return result.ok;\r\n}\r\n\r\n/**\r\n * Type guard to check if a Result is an error.\r\n *\r\n * @template SuccessType - The type of the successful value\r\n * @template ErrorType - The type of the error value\r\n * @param result - The Result to check\r\n * @returns True if the Result is an error, narrowing the type to Err<ErrorType>\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = someOperation();\r\n * if (isErr(result)) {\r\n *   console.error(result.error); // Type-safe access to error\r\n * }\r\n * ```\r\n */\r\nexport function isErr<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>\r\n): result is Err<ErrorType> {\r\n  return !result.ok;\r\n}\r\n","/**\r\n * Functions for transforming Result values and errors.\r\n */\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"./creation\";\r\n\r\n/**\r\n * Transforms the value of a successful Result.\r\n * If the Result is an error, it is returned unchanged.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template NewSuccessType - The new success type after transformation\r\n * @template ErrorType - The error type\r\n * @param result - The Result to transform\r\n * @param transform - Function to transform the success value\r\n * @returns A new Result with the transformed value, or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(5);\r\n * const doubled = map(num, x => x * 2);\r\n * // { ok: true, value: 10 }\r\n * ```\r\n */\r\nexport function map<SuccessType, NewSuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  transform: (value: SuccessType) => NewSuccessType\r\n): Result<NewSuccessType, ErrorType> {\r\n  return result.ok ? ok(transform(result.value)) : result;\r\n}\r\n\r\n/**\r\n * Transforms the error of a failed Result.\r\n * If the Result is successful, it is returned unchanged.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The current error type\r\n * @template NewErrorType - The new error type after transformation\r\n * @param result - The Result to transform\r\n * @param transform - Function to transform the error value\r\n * @returns A new Result with the transformed error, or the original success\r\n *\r\n * @example\r\n * ```typescript\r\n * const failure = err(\"404\");\r\n * const formatted = mapError(failure, msg => `Error: ${msg}`);\r\n * // { ok: false, error: \"Error: 404\" }\r\n * ```\r\n */\r\nexport function mapError<SuccessType, ErrorType, NewErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  transform: (error: ErrorType) => NewErrorType\r\n): Result<SuccessType, NewErrorType> {\r\n  return result.ok ? result : err(transform(result.error));\r\n}\r\n\r\n/**\r\n * Chains Result operations. If the Result is successful, applies the function to the value.\r\n * Otherwise, returns the error unchanged. This is also known as \"flatMap\" or \"bind\".\r\n *\r\n * @template SuccessType - The current success type\r\n * @template ErrorType - The error type\r\n * @template NextSuccessType - The next success type after chaining\r\n * @param result - The Result to chain\r\n * @param next - Function that returns a new Result from the success value\r\n * @returns The next Result, or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const parseNumber = (str: string): Result<number, string> => {\r\n *   const num = parseInt(str);\r\n *   return isNaN(num) ? err(\"Invalid number\") : ok(num);\r\n * };\r\n *\r\n * const doubled = ok(\"5\").pipe(parseNumber).pipe(x => ok(x * 2));\r\n * ```\r\n */\r\nexport function andThen<SuccessType, ErrorType, NextSuccessType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  next: (value: SuccessType) => Result<NextSuccessType, ErrorType>\r\n): Result<NextSuccessType, ErrorType> {\r\n  return result.ok ? next(result.value) : result;\r\n}\r\n","/**\r\n * Functions for unwrapping Result values with fallbacks.\r\n */\r\nimport type { Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Unwraps a successful Result or returns a fallback value if it's an error.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param result - The Result to unwrap\r\n * @param fallbackValue - The value to return if the Result is an error\r\n * @returns The success value, or the fallback value\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(42);\r\n * unwrapOr(num, 0); // 42\r\n *\r\n * const err = err(\"Failed\");\r\n * unwrapOr(err, 0); // 0\r\n * ```\r\n */\r\nexport function unwrapOr<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  fallbackValue: SuccessType\r\n): SuccessType {\r\n  return result.ok ? result.value : fallbackValue;\r\n}\r\n\r\n/**\r\n * Unwraps a successful Result or computes a fallback value from the error.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param result - The Result to unwrap\r\n * @param getFallback - Function that computes a fallback from the error\r\n * @returns The success value, or the computed fallback value\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = err(\"Not found\");\r\n * unwrapOrElse(num, error => 0); // 0\r\n * ```\r\n */\r\nexport function unwrapOrElse<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  getFallback: (error: ErrorType) => SuccessType\r\n): SuccessType {\r\n  return result.ok ? result.value : getFallback(result.error);\r\n}\r\n\r\n/**\r\n * Unwraps a successful Result or throws an error if it's a failure.\r\n * Use with caution - this defeats the purpose of using Result pattern.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @template ThrownError - The type of error to throw (must extend Error)\r\n * @param result - The Result to unwrap\r\n * @param toError - Optional function to convert the error to a thrown Error\r\n * @returns The success value\r\n * @throws ThrownError if the Result is an error\r\n *\r\n * @example\r\n * ```typescript\r\n * const num = ok(42);\r\n * getOrThrow(num); // 42\r\n *\r\n * const failure = err(\"Not found\");\r\n * getOrThrow(failure); // throws Error(\"Not found\")\r\n * ```\r\n */\r\nexport function getOrThrow<SuccessType, ErrorType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  toError?: (error: ErrorType) => Error\r\n): SuccessType {\r\n  if (result.ok) return result.value;\r\n  const e = toError ? toError(result.error) : new Error(String(result.error));\r\n  throw e;\r\n}\r\n","/**\r\n * Functions for combining Results and pattern matching.\r\n */\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"./creation\";\r\n\r\n/**\r\n * Combines multiple Results into a single Result containing an array of values.\r\n * If any Result is an error, returns that error immediately (short-circuits).\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param results - Array of Results to combine\r\n * @returns A Result containing an array of values, or the first error encountered\r\n *\r\n * @example\r\n * ```typescript\r\n * const nums = [ok(1), ok(2), ok(3)];\r\n * all(nums); // { ok: true, value: [1, 2, 3] }\r\n *\r\n * const mixed = [ok(1), err(\"error\"), ok(3)];\r\n * all(mixed); // { ok: false, error: \"error\" }\r\n * ```\r\n */\r\nexport function all<SuccessType, ErrorType>(\r\n  results: Array<Result<SuccessType, ErrorType>>\r\n): Result<SuccessType[], ErrorType> {\r\n  const out: SuccessType[] = [];\r\n  for (const r of results) {\r\n    if (!r.ok) return r;\r\n    out.push(r.value);\r\n  }\r\n  return ok(out);\r\n}\r\n\r\n/**\r\n * Pattern matching for Results. Executes different handlers based on success or failure.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @template ReturnType - The return type of both handlers\r\n * @param result - The Result to match\r\n * @param handlers - Object with onOk and onErr handlers\r\n * @returns The result of the executed handler\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = ok(42);\r\n * match(result, {\r\n *   onOk: value => console.log(`Success: ${value}`),\r\n *   onErr: error => console.error(`Error: ${error}`)\r\n * });\r\n * ```\r\n */\r\nexport function match<SuccessType, ErrorType, ReturnType>(\r\n  result: Result<SuccessType, ErrorType>,\r\n  handlers: { onOk: (value: SuccessType) => ReturnType; onErr: (error: ErrorType) => ReturnType }\r\n): ReturnType {\r\n  return result.ok ? handlers.onOk(result.value) : handlers.onErr(result.error);\r\n}\r\n","/**\r\n * Functions for error handling and lifting regular functions to Results.\r\n */\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"./creation\";\r\n\r\n/**\r\n * Executes a function and wraps the result in a Result, catching any thrown errors.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param fn - The function to execute\r\n * @param mapUnknownError - Function to convert caught errors to the ErrorType\r\n * @returns A Result containing either the return value or the caught error\r\n *\r\n * @example\r\n * ```typescript\r\n * const parsed = tryCatch(\r\n *   () => JSON.parse(\"{ invalid json\"),\r\n *   (e) => `Parse error: ${e}`\r\n * );\r\n * // { ok: false, error: \"Parse error: ...\" }\r\n * ```\r\n */\r\nexport function tryCatch<SuccessType, ErrorType>(\r\n  fn: () => SuccessType,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): Result<SuccessType, ErrorType> {\r\n  try {\r\n    return ok(fn());\r\n  } catch (unknownError) {\r\n    return err(mapUnknownError(unknownError));\r\n  }\r\n}\r\n\r\n/**\r\n * Lifts a regular function to work with Results by wrapping it with error handling.\r\n *\r\n * @template ParamType - The function parameter type\r\n * @template SuccessType - The function return type (success type)\r\n * @template ErrorType - The error type\r\n * @param fn - The function to lift\r\n * @param mapUnknownError - Function to convert thrown errors to the ErrorType\r\n * @returns A function that returns a Result\r\n *\r\n * @example\r\n * ```typescript\r\n * const parseJSON = lift(\r\n *   (str: string) => JSON.parse(str),\r\n *   (e) => `Invalid JSON: ${e}`\r\n * );\r\n *\r\n * const result = parseJSON(\"{ invalid }\");\r\n * // { ok: false, error: \"Invalid JSON: ...\" }\r\n * ```\r\n */\r\nexport function lift<ParamType, SuccessType, ErrorType>(\r\n  fn: (param: ParamType) => SuccessType,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): (param: ParamType) => Result<SuccessType, ErrorType> {\r\n  return (param) => tryCatch(() => fn(param), mapUnknownError);\r\n}\r\n","/**\r\n * Async variants of Result operations.\r\n */\r\nimport type { AsyncResult } from \"@/domain/types/result\";\r\nimport { ok, err } from \"./creation\";\r\nimport { all } from \"./combination\";\r\n\r\n/**\r\n * Transforms the value of an async Result.\r\n * If the Result is an error, returns it unchanged.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template NewSuccessType - The new success type after transformation\r\n * @template ErrorType - The error type\r\n * @param asyncResult - The async Result to transform\r\n * @param transform - Async or sync function to transform the success value\r\n * @returns A promise that resolves to a Result with the transformed value or error\r\n *\r\n * @example\r\n * ```typescript\r\n * const asyncNum = Promise.resolve(ok(5));\r\n * const doubled = await asyncMap(asyncNum, x => x * 2);\r\n * // { ok: true, value: 10 }\r\n * ```\r\n */\r\nexport async function asyncMap<SuccessType, NewSuccessType, ErrorType>(\r\n  asyncResult: AsyncResult<SuccessType, ErrorType>,\r\n  transform: (value: SuccessType) => Promise<NewSuccessType> | NewSuccessType\r\n): AsyncResult<NewSuccessType, ErrorType> {\r\n  const result = await asyncResult;\r\n  return result.ok ? ok(await transform(result.value)) : result;\r\n}\r\n\r\n/**\r\n * Chains async Result operations.\r\n * If the Result is successful, applies the async function to the value.\r\n *\r\n * @template SuccessType - The current success type\r\n * @template ErrorType - The error type\r\n * @template NextSuccessType - The next success type after chaining\r\n * @param asyncResult - The async Result to chain\r\n * @param next - Async function that returns a new async Result\r\n * @returns A promise that resolves to the chained Result or the original error\r\n *\r\n * @example\r\n * ```typescript\r\n * const fetchAndProcess = async (url: string) => {\r\n *   const data = await fromPromise(fetch(url).then(r => r.json()), e => String(e));\r\n *   return asyncAndThen(data, processDataAsync);\r\n * };\r\n * ```\r\n */\r\nexport async function asyncAndThen<SuccessType, ErrorType, NextSuccessType>(\r\n  asyncResult: AsyncResult<SuccessType, ErrorType>,\r\n  next: (value: SuccessType) => AsyncResult<NextSuccessType, ErrorType>\r\n): AsyncResult<NextSuccessType, ErrorType> {\r\n  const result = await asyncResult;\r\n  return result.ok ? next(result.value) : result;\r\n}\r\n\r\n/**\r\n * Converts a Promise into an async Result.\r\n * Catches any rejection and converts it to an error Result.\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param promise - The Promise to convert\r\n * @param mapUnknownError - Function to convert unknown errors to the ErrorType\r\n * @returns A promise that resolves to a Result\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = await fromPromise(\r\n *   fetch(\"/api/data\").then(r => r.json()),\r\n *   (e) => `Fetch failed: ${e}`\r\n * );\r\n * ```\r\n */\r\nexport async function fromPromise<SuccessType, ErrorType>(\r\n  promise: Promise<SuccessType>,\r\n  mapUnknownError: (unknownError: unknown) => ErrorType\r\n): AsyncResult<SuccessType, ErrorType> {\r\n  try {\r\n    return ok(await promise);\r\n  } catch (unknownError) {\r\n    return err(mapUnknownError(unknownError));\r\n  }\r\n}\r\n\r\n/**\r\n * Combines multiple async Results into a single Result containing an array of values.\r\n * If any Result is an error, returns that error (short-circuits).\r\n *\r\n * @template SuccessType - The success type\r\n * @template ErrorType - The error type\r\n * @param asyncResults - Array of async Results to combine\r\n * @returns A promise that resolves to a Result containing an array of values or the first error\r\n *\r\n * @example\r\n * ```typescript\r\n * const results = [\r\n *   Promise.resolve(ok(1)),\r\n *   Promise.resolve(ok(2)),\r\n *   Promise.resolve(ok(3))\r\n * ];\r\n * const combined = await asyncAll(results);\r\n * // { ok: true, value: [1, 2, 3] }\r\n * ```\r\n */\r\nexport async function asyncAll<SuccessType, ErrorType>(\r\n  asyncResults: Array<AsyncResult<SuccessType, ErrorType>>\r\n): AsyncResult<SuccessType[], ErrorType> {\r\n  const results = await Promise.all(asyncResults);\r\n  return all(results);\r\n}\r\n","/**\r\n * Token factory for creating type-safe injection tokens.\r\n *\r\n * Diese Funktion ist Teil der DI-Infrastruktur im Application Layer,\r\n * um Implementierungen aus Infrastructure/Framework mit Domain-Contracts zu verbinden.\r\n *\r\n * Die Funktion erstellt eindeutige, typsichere Injection-Tokens für Dependency Injection.\r\n * Jeder Aufruf erstellt ein neues Symbol, wodurch Eindeutigkeit auch bei gleicher Beschreibung gewährleistet ist.\r\n */\r\nimport type { InjectionToken } from \"./injection-token\";\r\n\r\n/**\r\n * Creates a unique, type-safe injection token for dependency injection.\r\n * Each call creates a new Symbol, ensuring uniqueness even with the same description.\r\n *\r\n * Teil der DI-Infrastruktur im Application Layer zur Verbindung von\r\n * Implementierungen (Infrastructure/Framework) mit Domain-Contracts.\r\n *\r\n * @template T - The type of service this token represents\r\n * @param description - A descriptive name for debugging purposes (appears in DevTools)\r\n * @returns A unique Symbol branded with the service type\r\n *\r\n * @example\r\n * ```typescript\r\n * // Create tokens for different services\r\n * const LoggerToken = createInjectionToken<Logger>('Logger');\r\n * const DatabaseToken = createInjectionToken<Database>('Database');\r\n *\r\n * // Tokens can be used with a DI container\r\n * container.register(LoggerToken, new Logger());\r\n * ```\r\n */\r\nexport function createInjectionToken<T>(description: string): InjectionToken<T> {\r\n  return Symbol(description) as InjectionToken<T>;\r\n}\r\n","/**\r\n * Injection token for the application logger service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\n\r\n/**\r\n * Injection token for the application logger service.\r\n *\r\n * Resolves to ConsoleLoggerService, providing structured logging\r\n * with configurable log levels (DEBUG, INFO, WARN, ERROR).\r\n *\r\n * @example\r\n * ```typescript\r\n * const logger = container.resolve(loggerToken);\r\n * logger.info(\"Application started\");\r\n * logger.error(\"Error occurred\", { code: 500, details: error });\r\n * ```\r\n */\r\nexport const loggerToken = createInjectionToken<Logger>(\"Logger\");\r\n","/**\r\n * Injection token for the BootstrapInitHookService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { BootstrapInitHookService } from \"@/infrastructure/shared/types/bootstrap-init-hook-service.interface\";\r\n\r\n/**\r\n * Injection token for the BootstrapInitHookService.\r\n *\r\n * Service responsible for registering the Foundry 'init' hook.\r\n * Uses direct Hooks.on() to avoid chicken-egg problem with version detection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const initHookService = container.resolve(bootstrapInitHookServiceToken);\r\n * initHookService.register();\r\n * ```\r\n */\r\nexport const bootstrapInitHookServiceToken = createInjectionToken<BootstrapInitHookService>(\r\n  \"BootstrapInitHookService\"\r\n);\r\n","/**\r\n * Injection token for the BootstrapReadyHookService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { BootstrapReadyHookService } from \"@/infrastructure/shared/types/bootstrap-ready-hook-service.interface\";\r\n\r\n/**\r\n * Injection token for the BootstrapReadyHookService.\r\n *\r\n * Service responsible for registering the Foundry 'ready' hook.\r\n * Uses direct Hooks.on() to avoid chicken-egg problem with version detection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const readyHookService = container.resolve(bootstrapReadyHookServiceToken);\r\n * readyHookService.register();\r\n * ```\r\n */\r\nexport const bootstrapReadyHookServiceToken = createInjectionToken<BootstrapReadyHookService>(\r\n  \"BootstrapReadyHookService\"\r\n);\r\n","/**\r\n * Log level enumeration for controlling logging verbosity.\r\n * Lower numeric values = more verbose.\r\n *\r\n * This is a domain type representing the business concept of log levels.\r\n * It is used across all layers of the application.\r\n */\r\nexport enum LogLevel {\r\n  DEBUG = 0,\r\n  INFO = 1,\r\n  WARN = 2,\r\n  ERROR = 3,\r\n}\r\n","import { APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n\r\n/**\r\n * Safely parses a sampling rate from an environment variable.\r\n * Ensures the value is a valid number between 0 and 1.\r\n *\r\n * @param envValue - Environment variable value to parse\r\n * @param fallback - Fallback value if parsing fails\r\n * @returns Valid sampling rate between 0.0 and 1.0\r\n * @internal Exported for testing\r\n */\r\nexport function parseSamplingRate(envValue: string | undefined, fallback: number): number {\r\n  const raw = parseFloat(envValue ?? String(fallback));\r\n  // Check if valid number and clamp to [0, 1] range\r\n  return Number.isFinite(raw) ? Math.min(1, Math.max(0, raw)) : fallback;\r\n}\r\n\r\nfunction parseNonNegativeNumber(envValue: string | undefined, fallback: number): number {\r\n  const parsed = Number(envValue);\r\n  if (!Number.isFinite(parsed)) {\r\n    return fallback;\r\n  }\r\n  return parsed < 0 ? fallback : parsed;\r\n}\r\n\r\nfunction parseOptionalPositiveInteger(envValue: string | undefined): number | undefined {\r\n  if (!envValue) {\r\n    return undefined;\r\n  }\r\n  const parsed = Number(envValue);\r\n  if (!Number.isFinite(parsed) || parsed <= 0) {\r\n    return undefined;\r\n  }\r\n  return Math.floor(parsed);\r\n}\r\n\r\n/**\r\n * Parses a positive integer from an environment variable.\r\n * Ensures the value is a valid positive integer.\r\n *\r\n * @param envValue - Environment variable value to parse\r\n * @param fallback - Fallback value if parsing fails\r\n * @returns Valid positive integer\r\n * @internal Exported for testing\r\n */\r\nexport function parsePositiveInteger(envValue: string | undefined, fallback: number): number {\r\n  const parsed = Number(envValue);\r\n  if (!Number.isFinite(parsed) || parsed <= 0) {\r\n    return fallback;\r\n  }\r\n  return Math.floor(parsed);\r\n}\r\n\r\n/**\r\n * Type-safe wrapper for accessing Vite environment variables.\r\n *\r\n * Vite's import.meta.env is available at build-time, but TypeScript\r\n * cannot infer the types for dynamic property access. This wrapper\r\n * provides type-safe access with explicit parsing.\r\n *\r\n * @param key - The environment variable key (e.g., 'VITE_CACHE_MAX_ENTRIES')\r\n * @param parser - Function to parse the string value to the desired type\r\n * @returns The parsed value of type T\r\n *\r\n * @example\r\n * ```typescript\r\n * const maxEntries = getEnvVar('VITE_CACHE_MAX_ENTRIES', parseOptionalPositiveInteger);\r\n * ```\r\n */\r\nfunction getEnvVar<T>(key: string, parser: (val: string | undefined) => T): T {\r\n  // Access import.meta.env dynamically - type is string | undefined at runtime\r\n  const value = (import.meta.env as Record<string, string | undefined>)[key];\r\n  return parser(value);\r\n}\r\n\r\n/**\r\n * Current environment configuration.\r\n * Reads from Vite environment variables (import.meta.env).\r\n */\r\nconst parsedCacheMaxEntries = getEnvVar(\"VITE_CACHE_MAX_ENTRIES\", parseOptionalPositiveInteger);\r\n\r\nexport const ENV: EnvironmentConfig = {\r\n  isDevelopment: import.meta.env.MODE === \"development\",\r\n  isProduction: import.meta.env.MODE === \"production\",\r\n  logLevel: import.meta.env.MODE === \"development\" ? LogLevel.DEBUG : LogLevel.INFO,\r\n  enablePerformanceTracking: import.meta.env.VITE_ENABLE_PERF_TRACKING === \"true\",\r\n  enableMetricsPersistence: getEnvVar(\"VITE_ENABLE_METRICS_PERSISTENCE\", (val) => val === \"true\"),\r\n  metricsPersistenceKey: getEnvVar(\r\n    \"VITE_METRICS_PERSISTENCE_KEY\",\r\n    (val) => val ?? \"fvtt_relationship_app_module.metrics\"\r\n  ),\r\n  // 1% sampling in production, 100% in development\r\n  performanceSamplingRate:\r\n    import.meta.env.MODE === \"production\"\r\n      ? parseSamplingRate(import.meta.env.VITE_PERF_SAMPLING_RATE, 0.01)\r\n      : 1.0,\r\n  enableCacheService: getEnvVar(\"VITE_CACHE_ENABLED\", (val) =>\r\n    val === undefined ? true : val === \"true\"\r\n  ),\r\n  cacheDefaultTtlMs: getEnvVar(\"VITE_CACHE_TTL_MS\", (val) =>\r\n    parseNonNegativeNumber(val, APP_DEFAULTS.CACHE_TTL_MS)\r\n  ),\r\n  ...(parsedCacheMaxEntries !== undefined ? { cacheMaxEntries: parsedCacheMaxEntries } : {}),\r\n  notificationQueueMinSize: getEnvVar(\"VITE_NOTIFICATION_QUEUE_MIN_SIZE\", (val) =>\r\n    parsePositiveInteger(val, 10)\r\n  ),\r\n  notificationQueueMaxSize: getEnvVar(\"VITE_NOTIFICATION_QUEUE_MAX_SIZE\", (val) =>\r\n    parsePositiveInteger(val, 1000)\r\n  ),\r\n  notificationQueueDefaultSize: getEnvVar(\"VITE_NOTIFICATION_QUEUE_DEFAULT_SIZE\", (val) =>\r\n    parsePositiveInteger(val, 50)\r\n  ),\r\n};\r\n","/**\r\n * Shared performance tracker implementation.\r\n *\r\n * This base class contains the common logic used by both:\r\n * - BootstrapPerformanceTracker (bootstrap phase, no DI)\r\n * - PerformanceTrackingService (production phase, with DI)\r\n *\r\n * **Design Rationale:**\r\n * - Eliminates code duplication between bootstrap and production trackers\r\n * - Both implementations share identical tracking logic\r\n * - Only difference is how they're instantiated (direct vs DI)\r\n *\r\n * @see PerformanceTracker interface\r\n * @see BootstrapPerformanceTracker for bootstrap usage\r\n * @see PerformanceTrackingService for DI-based usage\r\n */\r\n\r\nimport type { PerformanceTracker } from \"@/infrastructure/observability/performance-tracker.interface\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { MetricsSampler } from \"./interfaces/metrics-sampler\";\r\n\r\n/**\r\n * Base implementation of PerformanceTracker with shared logic.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Extend in subclasses\r\n * export class MyTracker extends PerformanceTrackerImpl {\r\n *   static dependencies = [envToken, metricsToken] as const;\r\n *   // DI dependencies handled by subclass\r\n * }\r\n * ```\r\n */\r\nexport class PerformanceTrackerImpl implements PerformanceTracker {\r\n  /**\r\n   * Creates a performance tracker implementation.\r\n   *\r\n   * @param env - Environment configuration for tracking settings\r\n   * @param sampler - Optional metrics sampler for sampling decisions (null during early bootstrap)\r\n   */\r\n  constructor(\r\n    protected readonly config: PlatformRuntimeConfigPort,\r\n    protected readonly sampler: MetricsSampler | null\r\n  ) {}\r\n\r\n  /**\r\n   * Tracks synchronous operation execution time.\r\n   *\r\n   * Only measures when:\r\n   * 1. Performance tracking is enabled (env.enablePerformanceTracking)\r\n   * 2. MetricsCollector is available\r\n   * 3. Sampling check passes (metricsCollector.shouldSample())\r\n   *\r\n   * @template T - Return type of the operation\r\n   * @param operation - Function to execute and measure\r\n   * @param onComplete - Optional callback invoked with duration and result\r\n   * @returns Result of the operation\r\n   */\r\n  track<T>(operation: () => T, onComplete?: (duration: number, result: T) => void): T {\r\n    // Early exit if performance tracking is disabled or sampling fails\r\n    if (!this.config.get(\"enablePerformanceTracking\") || !this.sampler?.shouldSample()) {\r\n      return operation();\r\n    }\r\n\r\n    const startTime = performance.now();\r\n    const result = operation();\r\n    const duration = performance.now() - startTime;\r\n\r\n    if (onComplete) {\r\n      onComplete(duration, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Tracks asynchronous operation execution time.\r\n   *\r\n   * Only measures when:\r\n   * 1. Performance tracking is enabled (env.enablePerformanceTracking)\r\n   * 2. MetricsCollector is available\r\n   * 3. Sampling check passes (metricsCollector.shouldSample())\r\n   *\r\n   * @template T - Return type of the async operation\r\n   * @param operation - Async function to execute and measure\r\n   * @param onComplete - Optional callback invoked with duration and result\r\n   * @returns Promise resolving to the operation result\r\n   */\r\n  async trackAsync<T>(\r\n    operation: () => Promise<T>,\r\n    onComplete?: (duration: number, result: T) => void\r\n  ): Promise<T> {\r\n    // Early exit if performance tracking is disabled or sampling fails\r\n    if (!this.config.get(\"enablePerformanceTracking\") || !this.sampler?.shouldSample()) {\r\n      return operation();\r\n    }\r\n\r\n    const startTime = performance.now();\r\n    const result = await operation();\r\n    const duration = performance.now() - startTime;\r\n\r\n    if (onComplete) {\r\n      onComplete(duration, result);\r\n    }\r\n\r\n    return result;\r\n  }\r\n}\r\n","/**\r\n * Lightweight performance tracker for bootstrap phase.\r\n *\r\n * This implementation is used during container initialization to avoid circular dependencies.\r\n * Unlike PerformanceTrackingService, it does NOT use dependency injection and can be\r\n * instantiated directly with its dependencies.\r\n *\r\n * **Design Rationale:**\r\n * - ServiceResolver needs performance tracking during bootstrap\r\n * - PerformanceTrackingService cannot be used (circular dependency)\r\n * - Solution: Lightweight tracker that extends shared implementation\r\n *\r\n * **Usage:**\r\n * - Bootstrap phase only (ServiceContainer.createRoot)\r\n * - Direct instantiation (no DI)\r\n * - Same behavior as PerformanceTrackingService\r\n *\r\n * @see PerformanceTracker interface\r\n * @see PerformanceTrackingService for full-featured DI-based implementation\r\n * @see PerformanceTrackerImpl for shared implementation\r\n */\r\n\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { MetricsSampler } from \"./interfaces/metrics-sampler\";\r\nimport { PerformanceTrackerImpl } from \"@/infrastructure/observability/performance-tracker-impl\";\r\n\r\n/**\r\n * Bootstrap-phase implementation of PerformanceTracker.\r\n *\r\n * Extends the shared PerformanceTrackerImpl base class to eliminate code duplication.\r\n *\r\n * @example\r\n * ```typescript\r\n * // During bootstrap (no DI available yet)\r\n * const tracker = new BootstrapPerformanceTracker(env, metricsCollector);\r\n * const resolver = new ServiceResolver(registry, cache, null, \"root\", tracker);\r\n * ```\r\n */\r\nexport class BootstrapPerformanceTracker extends PerformanceTrackerImpl {\r\n  /**\r\n   * Creates a bootstrap performance tracker.\r\n   *\r\n   * @param config - Runtime configuration port\r\n   * @param sampler - Optional metrics sampler for sampling decisions (null during early bootstrap)\r\n   */\r\n  constructor(config: PlatformRuntimeConfigPort, sampler: MetricsSampler | null) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n","import { LOG_PREFIX } from \"@/application/constants/app-constants\";\r\n\r\n/**\r\n * Context information for error logging.\r\n * Provides structured metadata about where and when an error occurred.\r\n */\r\nexport interface ErrorContext {\r\n  /** Phase of module lifecycle when error occurred */\r\n  phase: \"bootstrap\" | \"initialization\" | \"runtime\";\r\n  /** Component or service where error originated */\r\n  component?: string;\r\n  /** Additional contextual metadata */\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Centralized error handler for bootstrap and initialization errors.\r\n *\r\n * Provides structured, grouped error logging in the browser console.\r\n * Uses console.group() for clear, collapsible output that's easy to\r\n * screenshot and share for debugging.\r\n *\r\n * @remarks\r\n * Foundry v13 does not write module console logs to error.log files,\r\n * so this handler optimizes for browser console readability.\r\n *\r\n * @example\r\n * ```typescript\r\n * BootstrapErrorHandler.logError(error, {\r\n *   phase: 'bootstrap',\r\n *   component: 'CompositionRoot',\r\n *   metadata: { foundryVersion: 13 }\r\n * });\r\n * ```\r\n */\r\nexport class BootstrapErrorHandler {\r\n  /**\r\n   * Logs an error with structured context in the browser console.\r\n   *\r\n   * Creates a collapsible group with timestamp, phase, component,\r\n   * error details, and metadata for easy debugging and screenshotting.\r\n   *\r\n   * @param error - The error that occurred (Error object, string, or unknown)\r\n   * @param context - Context information about the error\r\n   */\r\n  static logError(error: unknown, context: ErrorContext): void {\r\n    const timestamp = new Date().toISOString();\r\n\r\n    console.group(`[${timestamp}] ${LOG_PREFIX} Error in ${context.phase}`);\r\n\r\n    if (context.component) {\r\n      console.error(\"Component:\", context.component);\r\n    }\r\n\r\n    console.error(\"Error:\", error);\r\n\r\n    if (context.metadata && Object.keys(context.metadata).length > 0) {\r\n      console.error(\"Metadata:\", context.metadata);\r\n    }\r\n\r\n    console.groupEnd();\r\n  }\r\n}\r\n","import type { RuntimeConfigKey, RuntimeConfigValues } from \"@/domain/types/runtime-config\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { IRuntimeConfigStore } from \"./RuntimeConfigStore\";\r\nimport type { IRuntimeConfigEventEmitter } from \"./RuntimeConfigEventEmitter\";\r\n\r\ntype RuntimeConfigListener<K extends RuntimeConfigKey> = (value: RuntimeConfigValues[K]) => void;\r\n\r\n/**\r\n * RuntimeConfigService\r\n *\r\n * Acts as a bridge between build-time environment defaults (VITE_*) and\r\n * runtime Foundry settings. Provides a central registry that services can\r\n * query for current values and subscribe to for live updates.\r\n *\r\n * Orchestrates RuntimeConfigStore (value management) and RuntimeConfigEventEmitter (listener management)\r\n * to follow the Single Responsibility Principle.\r\n *\r\n * Follows Dependency Inversion Principle (DIP) by accepting dependencies via constructor injection.\r\n *\r\n * Implements PlatformRuntimeConfigPort interface for platform-agnostic usage.\r\n */\r\nexport class RuntimeConfigService implements PlatformRuntimeConfigPort {\r\n  constructor(\r\n    private readonly store: IRuntimeConfigStore,\r\n    private readonly emitter: IRuntimeConfigEventEmitter\r\n  ) {}\r\n\r\n  /**\r\n   * Returns the current value for the given configuration key.\r\n   */\r\n  get<K extends RuntimeConfigKey>(key: K): RuntimeConfigValues[K] {\r\n    return this.store.get(key);\r\n  }\r\n\r\n  /**\r\n   * Updates the configuration value based on platform settings and notifies listeners\r\n   * only if the value actually changed.\r\n   *\r\n   * Implements PlatformRuntimeConfigPort interface.\r\n   */\r\n  setFromPlatform<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void {\r\n    const changed = this.store.set(key, value);\r\n    if (changed) {\r\n      this.emitter.notify(key, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registers a listener for the given key. Returns an unsubscribe function.\r\n   */\r\n  onChange<K extends RuntimeConfigKey>(key: K, listener: RuntimeConfigListener<K>): () => void {\r\n    return this.emitter.onChange(key, listener);\r\n  }\r\n}\r\n","import type { RuntimeConfigKey, RuntimeConfigValues } from \"@/domain/types/runtime-config\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n\r\n/**\r\n * Interface for runtime configuration value storage.\r\n * Allows for dependency injection and testing.\r\n */\r\nexport interface IRuntimeConfigStore {\r\n  get<K extends RuntimeConfigKey>(key: K): RuntimeConfigValues[K];\r\n  set<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): boolean;\r\n}\r\n\r\n/**\r\n * RuntimeConfigStore\r\n *\r\n * Manages the storage and retrieval of runtime configuration values.\r\n * Single Responsibility: Config value management only.\r\n */\r\nexport class RuntimeConfigStore implements IRuntimeConfigStore {\r\n  private readonly values: RuntimeConfigValues;\r\n\r\n  constructor(env: EnvironmentConfig) {\r\n    this.values = {\r\n      isDevelopment: env.isDevelopment,\r\n      isProduction: env.isProduction,\r\n      logLevel: env.logLevel,\r\n      enablePerformanceTracking: env.enablePerformanceTracking,\r\n      performanceSamplingRate: env.performanceSamplingRate,\r\n      enableMetricsPersistence: env.enableMetricsPersistence,\r\n      metricsPersistenceKey: env.metricsPersistenceKey,\r\n      enableCacheService: env.enableCacheService,\r\n      cacheDefaultTtlMs: env.cacheDefaultTtlMs,\r\n      cacheMaxEntries: env.cacheMaxEntries,\r\n      notificationQueueMaxSize: env.notificationQueueDefaultSize,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Returns the current value for the given configuration key.\r\n   */\r\n  get<K extends RuntimeConfigKey>(key: K): RuntimeConfigValues[K] {\r\n    return this.values[key];\r\n  }\r\n\r\n  /**\r\n   * Updates the configuration value.\r\n   * Returns true if the value actually changed, false otherwise.\r\n   */\r\n  set<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): boolean {\r\n    const current = this.values[key];\r\n    if (Object.is(current, value)) {\r\n      return false;\r\n    }\r\n\r\n    this.values[key] = value;\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Gets all current values (for testing/debugging purposes).\r\n   */\r\n  getAll(): Readonly<RuntimeConfigValues> {\r\n    return { ...this.values };\r\n  }\r\n}\r\n","import type { RuntimeConfigKey, RuntimeConfigValues } from \"@/domain/types/runtime-config\";\r\n\r\ntype RuntimeConfigListener<K extends RuntimeConfigKey> = (value: RuntimeConfigValues[K]) => void;\r\n\r\n/**\r\n * Interface for runtime configuration event emission.\r\n * Allows for dependency injection and testing.\r\n */\r\nexport interface IRuntimeConfigEventEmitter {\r\n  onChange<K extends RuntimeConfigKey>(key: K, listener: RuntimeConfigListener<K>): () => void;\r\n  notify<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void;\r\n}\r\n\r\n/**\r\n * RuntimeConfigEventEmitter\r\n *\r\n * Manages event listeners for runtime configuration changes.\r\n * Single Responsibility: Listener management only.\r\n */\r\nexport class RuntimeConfigEventEmitter implements IRuntimeConfigEventEmitter {\r\n  private readonly listeners = new Map<\r\n    RuntimeConfigKey,\r\n    Set<RuntimeConfigListener<RuntimeConfigKey>>\r\n  >();\r\n\r\n  /**\r\n   * Registers a listener for the given key. Returns an unsubscribe function.\r\n   */\r\n  onChange<K extends RuntimeConfigKey>(key: K, listener: RuntimeConfigListener<K>): () => void {\r\n    const existing = this.getListenersForKey<K>(key);\r\n    const listeners: Set<RuntimeConfigListener<K>> =\r\n      existing ?? new Set<RuntimeConfigListener<K>>();\r\n    listeners.add(listener);\r\n\r\n    this.setListenersForKey(key, listeners);\r\n\r\n    return () => {\r\n      const activeListeners = this.getListenersForKey<K>(key);\r\n      activeListeners?.delete(listener);\r\n      if (!activeListeners || activeListeners.size === 0) {\r\n        this.listeners.delete(key);\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notifies all listeners for the given key with the new value.\r\n   */\r\n  notify<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void {\r\n    const listeners = this.listeners.get(key) as Set<RuntimeConfigListener<K>> | undefined;\r\n    if (!listeners || listeners.size === 0) {\r\n      return;\r\n    }\r\n\r\n    for (const listener of listeners) {\r\n      listener(value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Type-safe helper to get listeners for a specific key.\r\n   * @ts-expect-error - Type coverage exclusion for generic Set cast\r\n   */\r\n  private getListenersForKey<K extends RuntimeConfigKey>(\r\n    key: K\r\n  ): Set<RuntimeConfigListener<K>> | undefined {\r\n    return this.listeners.get(key) as Set<RuntimeConfigListener<K>> | undefined;\r\n  }\r\n\r\n  /**\r\n   * Type-safe helper to set listeners for a specific key.\r\n   * @ts-expect-error - Type coverage exclusion for generic Set cast\r\n   */\r\n  private setListenersForKey<K extends RuntimeConfigKey>(\r\n    key: K,\r\n    listeners: Set<RuntimeConfigListener<K>>\r\n  ): void {\r\n    // type-coverage:ignore-next-line - Generic Set cast required for type-safe listener management\r\n    this.listeners.set(key, listeners as Set<RuntimeConfigListener<RuntimeConfigKey>>);\r\n  }\r\n}\r\n","import type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\nimport { RuntimeConfigService } from \"./RuntimeConfigService\";\r\nimport { RuntimeConfigStore } from \"./RuntimeConfigStore\";\r\nimport { RuntimeConfigEventEmitter } from \"./RuntimeConfigEventEmitter\";\r\nimport type { IRuntimeConfigStore } from \"./RuntimeConfigStore\";\r\nimport type { IRuntimeConfigEventEmitter } from \"./RuntimeConfigEventEmitter\";\r\n\r\n/**\r\n * Factory function for creating RuntimeConfigService instances.\r\n *\r\n * Centralizes the creation of RuntimeConfigService to follow the Dependency Inversion Principle (DIP).\r\n * This allows for easier testing (mocking) and future extensions (caching, pooling, etc.).\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\n * import type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n * // ENV should be obtained from domain layer or passed as parameter\r\n *\r\n * const config = createRuntimeConfig(envConfig);\r\n * ```\r\n *\r\n * @param env - The environment configuration to use\r\n * @param store - Optional store implementation (defaults to RuntimeConfigStore)\r\n * @param emitter - Optional emitter implementation (defaults to RuntimeConfigEventEmitter)\r\n * @returns A new RuntimeConfigService instance\r\n */\r\nexport function createRuntimeConfig(\r\n  env: EnvironmentConfig,\r\n  store?: IRuntimeConfigStore,\r\n  emitter?: IRuntimeConfigEventEmitter\r\n): RuntimeConfigService {\r\n  return new RuntimeConfigService(\r\n    store ?? new RuntimeConfigStore(env),\r\n    emitter ?? new RuntimeConfigEventEmitter()\r\n  );\r\n}\r\n","import type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { RuntimeConfigKey, RuntimeConfigValues } from \"@/domain/types/runtime-config\";\r\nimport { RuntimeConfigService } from \"@/application/services/RuntimeConfigService\";\r\nimport { createRuntimeConfig } from \"@/application/services/runtime-config-factory\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n\r\n/**\r\n * Infrastructure adapter that wraps RuntimeConfigService as PlatformRuntimeConfigPort.\r\n */\r\nexport class RuntimeConfigAdapter implements PlatformRuntimeConfigPort {\r\n  private readonly service: RuntimeConfigService;\r\n\r\n  constructor(env: EnvironmentConfig) {\r\n    this.service = createRuntimeConfig(env);\r\n  }\r\n\r\n  get<K extends RuntimeConfigKey>(key: K): RuntimeConfigValues[K] {\r\n    return this.service.get(key);\r\n  }\r\n\r\n  setFromPlatform<K extends RuntimeConfigKey>(key: K, value: RuntimeConfigValues[K]): void {\r\n    this.service.setFromPlatform(key, value);\r\n  }\r\n\r\n  onChange<K extends RuntimeConfigKey>(\r\n    key: K,\r\n    listener: (value: RuntimeConfigValues[K]) => void\r\n  ): () => void {\r\n    return this.service.onChange(key, listener);\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function for creating RuntimeConfigAdapter instances.\r\n *\r\n * Centralizes the creation of RuntimeConfigAdapter to follow the Dependency Inversion Principle (DIP).\r\n * This allows the Framework layer to create instances without directly importing the concrete class,\r\n * improving testability and reducing coupling.\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { createRuntimeConfigAdapter } from \"@/infrastructure/config/runtime-config-adapter\";\r\n * import type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n *\r\n * const adapter = createRuntimeConfigAdapter(envConfig);\r\n * ```\r\n *\r\n * @param env - The environment configuration to use\r\n * @returns A new RuntimeConfigAdapter instance\r\n */\r\nexport function createRuntimeConfigAdapter(env: EnvironmentConfig): RuntimeConfigAdapter {\r\n  return new RuntimeConfigAdapter(env);\r\n}\r\n","/**\r\n * Runtime-safe cast utilities für DI container internals.\r\n *\r\n * NUR Container-interne Operationen!\r\n * Für Bootstrap: siehe bootstrap-casts.ts\r\n * Für API: siehe api-casts.ts\r\n * Für Generics: siehe type-casts.ts\r\n *\r\n * Diese Datei enthält KEINE spezifischen Service-Imports mehr!\r\n * Alle Service-spezifischen Casts wurden in separate Dateien ausgelagert.\r\n *\r\n * @ts-expect-error - Type coverage exclusion: This file intentionally uses type assertions\r\n * for runtime-safe casts that are necessary for the DI infrastructure.\r\n */\r\n\r\nimport type { InjectionToken } from \"../core/injectiontoken\";\r\nimport type { ServiceRegistration } from \"../core/serviceregistration\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHookCallback } from \"@/infrastructure/adapters/foundry/types\";\r\nimport type { ContainerError, Container } from \"../../interfaces\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für gecachte Service-Instanzen.\r\n * Die Typsicherheit wird durch die Aufrufer gewährleistet, die sicherstellen,\r\n * dass der Token mit dem korrekten generischen Typ registriert wurde.\r\n *\r\n * @param instance - Die gecachte Service-Instanz (unknown)\r\n * @returns Die Instanz als spezifischer generischer Typ\r\n */\r\nexport function castCachedServiceInstance<T>(instance: unknown | undefined): T | undefined {\r\n  return instance as T | undefined;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für gecachte Service-Instanzen in Result-Kontext.\r\n * Wird verwendet, wenn sichergestellt ist, dass die Instanz existiert.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass die Instanz nicht `undefined` ist. Bei Fehlern wird ein ContainerError\r\n * zurückgegeben statt einen Error zu werfen, um konsistent mit dem Result-Pattern\r\n * zu bleiben.\r\n *\r\n * @template T - Der spezifische Service-Typ\r\n * @param instance - Die gecachte Service-Instanz (unknown oder undefined)\r\n * @returns Result mit der Instanz als spezifischer generischer Typ oder ContainerError\r\n *\r\n * @remarks\r\n * Diese Funktion sollte nur verwendet werden, wenn sichergestellt ist, dass\r\n * die Instanz im Cache existiert. Für optionale Instanzen sollte\r\n * `castCachedServiceInstance()` verwendet werden.\r\n *\r\n * @see {@link castCachedServiceInstance} Für optionale Service-Instanzen\r\n */\r\nexport function castCachedServiceInstanceForResult<T>(\r\n  instance: unknown | undefined\r\n): Result<T, ContainerError> {\r\n  if (instance === undefined) {\r\n    return err({\r\n      code: \"TokenNotRegistered\",\r\n      message:\r\n        \"castCachedServiceInstanceForResult: instance must not be undefined. Use castCachedServiceInstance() for optional instances.\",\r\n      details: {},\r\n    });\r\n  }\r\n  return ok(instance as T);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für ServiceRegistration Map-Einträge.\r\n * Map.entries() verliert generische Typ-Information während der Iteration,\r\n * daher ist dieser Cast notwendig, um die korrekten Typen wiederherzustellen.\r\n *\r\n * @param token - Der Injection Token (symbol)\r\n * @param registration - Die ServiceRegistration (unknown)\r\n * @returns Tuple mit typisierten Token und Registration\r\n */\r\nexport function castServiceRegistrationEntry(\r\n  token: symbol,\r\n  registration: ServiceRegistration<unknown>\r\n): [InjectionToken<unknown>, ServiceRegistration<unknown>] {\r\n  return [token as InjectionToken<unknown>, registration as ServiceRegistration<unknown>];\r\n}\r\n\r\n/**\r\n * Iteriert über ServiceRegistration Map-Einträge mit korrekter Typisierung.\r\n * Map.entries() verliert generische Typ-Information während der Iteration,\r\n * daher ist diese Funktion notwendig, um die korrekten Typen wiederherzustellen.\r\n *\r\n * @param entries - Die Map-Einträge (Iterable von [symbol, ServiceRegistration<unknown>])\r\n * @returns Iterable von typisierten [InjectionToken, ServiceRegistration] Tuples\r\n */\r\nexport function* iterateServiceRegistrationEntries(\r\n  entries: Iterable<[symbol, ServiceRegistration<unknown>]>\r\n): IterableIterator<[InjectionToken<unknown>, ServiceRegistration<unknown>]> {\r\n  for (const [token, registration] of entries) {\r\n    yield castServiceRegistrationEntry(token, registration);\r\n  }\r\n}\r\n\r\n/**\r\n * Extracts registration status from Result, with defensive fallback.\r\n *\r\n * This is a defensive check: isRegistered() should never fail in practice,\r\n * but the Result pattern requires handling the error case.\r\n *\r\n * @param result - Result from container.isRegistered()\r\n * @returns Registration status (true if registered, false on error)\r\n */\r\nexport function getRegistrationStatus(result: Result<boolean, ContainerError>): boolean {\r\n  return result.ok ? result.value : false;\r\n}\r\n\r\n/**\r\n * Casts a callback function to FoundryHookCallback.\r\n *\r\n * This is needed because TypeScript cannot infer that a generic callback\r\n * matches the FoundryHookCallback signature at the call site.\r\n * The caller must ensure the callback signature is compatible.\r\n *\r\n * @param callback - Callback function to cast\r\n * @returns The callback as FoundryHookCallback\r\n */\r\nexport function castToFoundryHookCallback(callback: unknown): FoundryHookCallback {\r\n  return callback as FoundryHookCallback;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für Container-Auflösungen in Bootstrapper-Dateien.\r\n * Diese Funktionen sind runtime-safe, da der Container die korrekten Typen zurückgibt.\r\n */\r\n\r\n/**\r\n * Generic Service Resolution Cast\r\n * Nur für interne Container-Operationen!\r\n * Für Bootstrap-spezifische Casts: siehe bootstrap-casts.ts\r\n */\r\nexport function castResolvedService<T>(value: unknown): T {\r\n  return value as T;\r\n}\r\n\r\n/**\r\n * Container Error Code Cast\r\n */\r\nexport function castContainerErrorCode(code: string): ContainerError[\"code\"] {\r\n  return code as ContainerError[\"code\"];\r\n}\r\n\r\n/**\r\n * Casts a Container token to PlatformContainerPort token for alias registration.\r\n * Runtime-safe because ServiceContainer implements both Container and PlatformContainerPort.\r\n * This is needed when registering PlatformContainerPort as an alias to ServiceContainer,\r\n * as the type system cannot automatically infer the compatibility.\r\n */\r\nexport function castContainerTokenToPlatformContainerPortToken(\r\n  token: InjectionToken<Container>\r\n): InjectionToken<PlatformContainerPort> {\r\n  return token as unknown as InjectionToken<PlatformContainerPort>;\r\n}\r\n","import type { InjectionToken } from \"../core/injectiontoken\";\r\n\r\n/**\r\n * Compile-time brand marker for API-safe tokens.\r\n *\r\n * This symbol only exists at the type level and is erased at runtime.\r\n * It's used to mark tokens that are safe for external module consumption via the public API.\r\n *\r\n * @internal This is a type-level-only marker\r\n */\r\ndeclare const API_SAFE_BRAND: unique symbol;\r\n\r\n/**\r\n * Runtime registry of API-safe tokens.\r\n *\r\n * Uses Set for O(1) lookups. Since symbols are primitives (not objects),\r\n * WeakSet cannot be used. This is safe because tokens are compile-time constants\r\n * and never get garbage collected anyway.\r\n *\r\n * @internal\r\n */\r\nconst apiSafeTokens = new Set<symbol>();\r\n\r\n/**\r\n * InjectionToken branded as \"API-safe\" for external module consumption.\r\n *\r\n * Only tokens marked via `markAsApiSafe()` can be used with the throwing\r\n * `container.resolve()` method. This enforces that internal code uses\r\n * `resolveWithError()` for Result-based error handling.\r\n *\r\n * **Enforcement:**\r\n * - Compile-time: TypeScript enforces ApiSafeToken type (prevents `container.resolve(regularToken)`)\r\n * - Runtime: Symbol marker validates token was marked via markAsApiSafe()\r\n *\r\n * **Design rationale:**\r\n * - External modules (unfamiliar with Result pattern) get exception-based API\r\n * - Internal code (uses Result pattern) cannot accidentally use throwing API\r\n * - Defense-in-depth: Type system + runtime guard\r\n *\r\n * @template T - The service type this token resolves to\r\n *\r\n * @see markAsApiSafe - Function to mark tokens as API-safe\r\n * @see https://github.com/tc39/proposal-type-annotations (future TC39 standard alignment)\r\n */\r\nexport type ApiSafeToken<T> = InjectionToken<T> & {\r\n  readonly [API_SAFE_BRAND]: true;\r\n};\r\n\r\n/**\r\n * Marks an injection token as safe for API exposure.\r\n *\r\n * **🔒 RESTRICTED: Only call this in composition-root.ts**\r\n *\r\n * This function should ONLY be used when creating the public ModuleApi\r\n * to mark tokens that external modules can safely use with `api.resolve()`.\r\n *\r\n * Internal code should never call this function - it should always use\r\n * `resolveWithError()` with regular InjectionToken types.\r\n *\r\n * **Implementation:**\r\n * 1. Adds token to Set registry\r\n * 2. Returns token cast as ApiSafeToken (compile-time brand)\r\n *\r\n * **Performance:**\r\n * - Minimal runtime overhead (Set.add is O(1))\r\n * - Compile-time type checking prevents misuse\r\n *\r\n * @param token - The injection token to mark as API-safe\r\n * @returns The same token, branded as ApiSafeToken with runtime marker\r\n *\r\n * @example\r\n * ```typescript\r\n * // ✅ CORRECT: In composition-root.ts\r\n * const api: ModuleApi = {\r\n *   tokens: {\r\n *     loggerToken: markAsApiSafe(loggerToken),\r\n *     gameToken: markAsApiSafe(foundryGameToken),\r\n *   }\r\n * };\r\n *\r\n * // ❌ WRONG: In service code\r\n * const logger = container.resolve(markAsApiSafe(loggerToken));\r\n * // Use resolveWithError() instead!\r\n * ```\r\n */\r\nexport function markAsApiSafe<T>(token: InjectionToken<T>): ApiSafeToken<T> {\r\n  // Add to Set registry (O(1) lookup)\r\n  apiSafeTokens.add(token);\r\n\r\n  /* type-coverage:ignore-next-line -- Nominal branding: Return with compile-time brand marker (type cast) */\r\n  return token as ApiSafeToken<T>;\r\n}\r\n\r\n/**\r\n * Runtime validation that a token is API-safe.\r\n *\r\n * Checks if the token is in the Set registry.\r\n * Used by container.resolve() to enforce API boundary at runtime.\r\n *\r\n * This provides defense-in-depth against:\r\n * - @ts-ignore comments bypassing type checks\r\n * - Type assertions (`token as ApiSafeToken`)\r\n * - JavaScript consumers (no type checking)\r\n *\r\n * **Performance:**\r\n * - O(1) Set lookup (~1-2 nanoseconds)\r\n * - Negligible impact (~0.4% of resolve() time)\r\n * - Safe: Tokens are compile-time constants, never GC'd\r\n *\r\n * @param token - The token to validate\r\n * @returns True if token was marked via markAsApiSafe(), false otherwise\r\n *\r\n * @internal Used by ServiceContainer, not intended for external use\r\n *\r\n * @example\r\n * ```typescript\r\n * // Container.resolve() implementation:\r\n * resolve(token) {\r\n *   if (!isApiSafeTokenRuntime(token)) {\r\n *     throw new Error(\"Use resolveWithError() in internal code\");\r\n *   }\r\n *   // ...\r\n * }\r\n * ```\r\n */\r\nexport function isApiSafeTokenRuntime<T>(token: InjectionToken<T>): token is ApiSafeToken<T> {\r\n  // Check Set registry\r\n  return apiSafeTokens.has(token);\r\n}\r\n","/**\r\n * Enum for service lifecycle strategies in dependency injection.\r\n *\r\n * - SINGLETON: One shared instance across the entire application\r\n * - TRANSIENT: New instance created on each resolution\r\n * - SCOPED: One instance per container scope\r\n *\r\n * @enum {string}\r\n * @property {string} SINGLETON - One instance for all\r\n * @property {string} TRANSIENT - New instance for each resolve()\r\n * @property {string} SCOPED - One instance per scope\r\n */\r\nexport enum ServiceLifecycle {\r\n  SINGLETON = \"singleton\",\r\n  TRANSIENT = \"transient\",\r\n  SCOPED = \"scoped\",\r\n}\r\n","import type { ServiceLifecycle } from \"./servicelifecycle\";\r\nimport type { InjectionToken } from \"./injectiontoken\";\r\nimport type { ServiceClass } from \"../resolution/serviceclass\";\r\nimport type { FactoryFunction } from \"../resolution/servicefactory\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle as SL } from \"./servicelifecycle\";\r\n\r\n/**\r\n * Represents a service registration in the DI container.\r\n * Stores all metadata required to create and manage service instances.\r\n *\r\n * Generic type parameter preserves the concrete service type through registration and resolution,\r\n * enabling type-safe dependency injection without runtime casts.\r\n *\r\n * Design: Uses separate optional fields instead of union type to:\r\n * - Prevent accidental calls to placeholder alias factories\r\n * - Make provider type clear and type-safe\r\n * - Support proper cloning for child scopes\r\n *\r\n * Use static factory methods to create instances:\r\n * - ServiceRegistration.createClass()\r\n * - ServiceRegistration.createFactory()\r\n * - ServiceRegistration.createValue()\r\n * - ServiceRegistration.createAlias()\r\n *\r\n * @template Tunknown - The concrete service type being registered\r\n */\r\nexport class ServiceRegistration<T = unknown> {\r\n  /**\r\n   * Private constructor - use static factory methods instead.\r\n   * This prevents direct construction with invalid parameters\r\n   * and ensures Result-based error handling.\r\n   */\r\n  private constructor(\r\n    public readonly lifecycle: ServiceLifecycle,\r\n    public readonly dependencies: readonly InjectionToken<unknown>[], // Immutable array\r\n    public readonly providerType: \"class\" | \"factory\" | \"value\" | \"alias\",\r\n\r\n    // Exactly one of these must be set based on providerType:\r\n    public readonly serviceClass?: ServiceClass<T>,\r\n    public readonly factory?: FactoryFunction<T>,\r\n    public readonly value?: T,\r\n    public readonly aliasTarget?: InjectionToken<T>\r\n  ) {\r\n    // NO validation here - trust factory methods to provide valid data\r\n  }\r\n\r\n  /**\r\n   * Creates a class-based registration.\r\n   * @template Tunknown - The concrete service type\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of dependency tokens\r\n   * @param serviceClass - The class to instantiate\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createClass<T>(\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: readonly InjectionToken<unknown>[],\r\n    serviceClass: ServiceClass<T>\r\n  ): Result<ServiceRegistration<T>, ContainerError> {\r\n    // Note: serviceClass validation is performed in ServiceRegistry.registerClass before calling this method\r\n    return ok(\r\n      new ServiceRegistration<T>(\r\n        lifecycle,\r\n        dependencies,\r\n        \"class\",\r\n        serviceClass,\r\n        undefined,\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a factory-based registration.\r\n   * @template Tunknown - The concrete service type\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of dependency tokens\r\n   * @param factory - Factory function that creates instances\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createFactory<T>(\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: readonly InjectionToken<unknown>[],\r\n    factory: FactoryFunction<T>\r\n  ): Result<ServiceRegistration<T>, ContainerError> {\r\n    if (!factory) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"factory is required for factory registration\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<T>(\r\n        lifecycle,\r\n        dependencies,\r\n        \"factory\",\r\n        undefined,\r\n        factory,\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a value-based registration (always SINGLETON).\r\n   * @template Tunknown - The concrete service type\r\n   * @param value - The value to register\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createValue<T>(value: T): Result<ServiceRegistration<T>, ContainerError> {\r\n    if (value === undefined) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"value cannot be undefined for value registration\",\r\n      });\r\n    }\r\n\r\n    if (typeof value === \"function\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message:\r\n          \"registerValue() only accepts plain values, not functions or classes. Use registerClass() or registerFactory() instead.\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<T>(SL.SINGLETON, [], \"value\", undefined, undefined, value, undefined)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates an alias registration (always SINGLETON).\r\n   * @template Tunknown - The concrete service type\r\n   * @param targetToken - The token to resolve instead\r\n   * @returns Result with registration or validation error\r\n   */\r\n  static createAlias<T>(\r\n    targetToken: InjectionToken<T>\r\n  ): Result<ServiceRegistration<T>, ContainerError> {\r\n    if (!targetToken) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"targetToken is required for alias registration\",\r\n      });\r\n    }\r\n\r\n    return ok(\r\n      new ServiceRegistration<T>(\r\n        SL.SINGLETON,\r\n        [targetToken],\r\n        \"alias\",\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        targetToken\r\n      )\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a clone of this registration.\r\n   * Used when child containers inherit registrations from parent.\r\n   *\r\n   * @returns A new ServiceRegistration instance with cloned dependencies array\r\n   */\r\n  clone(): ServiceRegistration<T> {\r\n    return new ServiceRegistration<T>(\r\n      this.lifecycle,\r\n      [...this.dependencies], // Clone array to prevent shared mutations\r\n      this.providerType,\r\n      this.serviceClass,\r\n      this.factory,\r\n      this.value,\r\n      this.aliasTarget\r\n    );\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\n\r\n/**\r\n * Type-safe wrapper around Map for ServiceRegistrations.\r\n *\r\n * Preserves generic type information through token-based lookup, enabling\r\n * type-safe dependency injection without runtime casts in most cases.\r\n *\r\n * Design:\r\n * - Map stores ServiceRegistration<any> to support heterogeneous service types\r\n * - Generic methods preserve type information through token's type parameter\r\n * - Single cast in get() is architecturally sound (token identity guarantees type)\r\n *\r\n * @example\r\n * ```typescript\r\n * const map = new TypeSafeRegistrationMap();\r\n * const reg = ServiceRegistration.createClass<Logger>(...);\r\n * map.set(loggerToken, reg);\r\n *\r\n * const retrieved = map.get(loggerToken);\r\n * // retrieved is ServiceRegistration<Logger> | undefined\r\n * ```\r\n */\r\nexport class TypeSafeRegistrationMap {\r\n  private readonly map: Map<symbol, ServiceRegistration<any>> = new Map();\r\n\r\n  /**\r\n   * Stores a service registration.\r\n   *\r\n   * @template T - The concrete service type\r\n   * @param token - The injection token identifying the service\r\n   * @param registration - The service registration metadata\r\n   */\r\n  set<T>(token: InjectionToken<T>, registration: ServiceRegistration<T>): void {\r\n    this.map.set(token as symbol, registration);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a service registration.\r\n   *\r\n   * Type-safe by design: The token's generic parameter guarantees that the\r\n   * returned registration matches the expected service type.\r\n   *\r\n   * @template T - The concrete service type\r\n   * @param token - The injection token identifying the service\r\n   * @returns The service registration or undefined if not found\r\n   */\r\n  get<T>(token: InjectionToken<T>): ServiceRegistration<T> | undefined {\r\n    // Type-safe by design: Token's generic guarantees registration type\r\n    // Cast is necessary due to Map's type erasure but architecturally sound\r\n    return this.map.get(token as symbol) as ServiceRegistration<T> | undefined;\r\n  }\r\n\r\n  /**\r\n   * Checks if a service is registered.\r\n   *\r\n   * @param token - The injection token to check\r\n   * @returns True if the service is registered\r\n   */\r\n  has(token: InjectionToken<unknown>): boolean {\r\n    return this.map.has(token as symbol);\r\n  }\r\n\r\n  /**\r\n   * Removes a service registration.\r\n   *\r\n   * @param token - The injection token identifying the service\r\n   * @returns True if the service was found and removed\r\n   */\r\n  delete(token: InjectionToken<unknown>): boolean {\r\n    return this.map.delete(token as symbol);\r\n  }\r\n\r\n  /**\r\n   * Gets the number of registered services.\r\n   *\r\n   * @returns The count of registrations\r\n   */\r\n  get size(): number {\r\n    return this.map.size;\r\n  }\r\n\r\n  /**\r\n   * Removes all service registrations.\r\n   */\r\n  clear(): void {\r\n    this.map.clear();\r\n  }\r\n\r\n  /**\r\n   * Returns an iterator of all registration entries.\r\n   *\r\n   * @returns Iterator of [token, registration] pairs\r\n   */\r\n  entries(): IterableIterator<[symbol, ServiceRegistration<any>]> {\r\n    return this.map.entries();\r\n  }\r\n\r\n  /**\r\n   * Creates a shallow clone of this map.\r\n   * Used when child containers inherit registrations from parent.\r\n   *\r\n   * @returns A new TypeSafeRegistrationMap with cloned entries\r\n   */\r\n  clone(): TypeSafeRegistrationMap {\r\n    const cloned = new TypeSafeRegistrationMap();\r\n    this.map.forEach((value: ServiceRegistration<any>, key: symbol) => {\r\n      cloned.map.set(key, value);\r\n    });\r\n    return cloned;\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceClass } from \"../types/resolution/serviceclass\";\r\nimport type { FactoryFunction } from \"../types/resolution/servicefactory\";\r\nimport type { ServiceDependencies } from \"../types/resolution/servicedependencies\";\r\nimport { ServiceLifecycle } from \"../types/core/servicelifecycle\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { TypeSafeRegistrationMap } from \"./TypeSafeRegistrationMap\";\r\nimport { iterateServiceRegistrationEntries } from \"../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Type for service classes that declare their dependencies.\r\n */\r\ntype ServiceClassWithDependencies<T> = ServiceClass<T> & {\r\n  dependencies?: ReadonlyArray<InjectionToken<unknown>>;\r\n};\r\n\r\n/**\r\n * Type guard to check if a service class has a dependencies property.\r\n *\r\n * @template T - The service type\r\n * @param cls - The service class to check\r\n * @returns True if the class has a dependencies property\r\n */\r\nfunction hasDependencies<T>(cls: ServiceClass<T>): cls is ServiceClassWithDependencies<T> {\r\n  return \"dependencies\" in cls;\r\n}\r\n\r\n/**\r\n * Registry for service registrations.\r\n *\r\n * Responsibilities:\r\n * - Manage service registrations (add, retrieve, check existence)\r\n * - Validate registrations (no duplicates, valid values)\r\n * - Support cloning for child containers\r\n * - Enforce registration limits (DoS protection)\r\n *\r\n * This class does NOT handle:\r\n * - Service resolution (that's ServiceResolver's job)\r\n * - Dependency validation (that's ContainerValidator's job)\r\n */\r\nexport class ServiceRegistry {\r\n  private readonly MAX_REGISTRATIONS = 10000; // DoS protection: prevent unlimited registrations\r\n  private registrations = new TypeSafeRegistrationMap();\r\n  private lifecycleIndex = new Map<ServiceLifecycle, Set<InjectionToken<unknown>>>();\r\n\r\n  /**\r\n   * Updates the lifecycle index when a service is registered.\r\n   *\r\n   * @param token - The injection token\r\n   * @param lifecycle - The service lifecycle\r\n   */\r\n  private updateLifecycleIndex(token: InjectionToken<unknown>, lifecycle: ServiceLifecycle): void {\r\n    let tokenSet = this.lifecycleIndex.get(lifecycle);\r\n    if (!tokenSet) {\r\n      tokenSet = new Set();\r\n      this.lifecycleIndex.set(lifecycle, tokenSet);\r\n    }\r\n    tokenSet.add(token);\r\n  }\r\n\r\n  /**\r\n   * Registers a service class with automatic dependency injection.\r\n   *\r\n   * @template Tunknown - The type of service to register\r\n   * @param token - The injection token identifying this service\r\n   * @param serviceClass - The class to instantiate\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerClass<T>(\r\n    token: InjectionToken<T>,\r\n    serviceClass: ServiceClass<T>,\r\n    lifecycle: ServiceLifecycle\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Validate serviceClass before using it\r\n    if (!serviceClass) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"serviceClass is required for class registration\",\r\n      });\r\n    }\r\n\r\n    const dependencies = hasDependencies(serviceClass) ? (serviceClass.dependencies ?? []) : [];\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createClass<T>(\r\n      lifecycle,\r\n      dependencies,\r\n      serviceClass\r\n    );\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, lifecycle);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers a factory function for creating service instances.\r\n   *\r\n   * @template Tunknown - The type of service this factory creates\r\n   * @param token - The injection token identifying this service\r\n   * @param factory - Factory function that creates instances\r\n   * @param lifecycle - Service lifecycle (SINGLETON, TRANSIENT, SCOPED)\r\n   * @param dependencies - Array of tokens this factory depends on\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerFactory<T>(\r\n    token: InjectionToken<T>,\r\n    factory: FactoryFunction<T>,\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: ServiceDependencies\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createFactory<T>(\r\n      lifecycle,\r\n      dependencies,\r\n      factory\r\n    );\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, lifecycle);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers a constant value (always SINGLETON lifecycle).\r\n   *\r\n   * @template Tunknown - The type of value to register\r\n   * @param token - The injection token identifying this value\r\n   * @param value - The value to register\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerValue<T>(token: InjectionToken<T>, value: T): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(token)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(token)} already registered`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation (includes function check)\r\n    const registrationResult = ServiceRegistration.createValue<T>(value);\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(token, registrationResult.value);\r\n    this.updateLifecycleIndex(token, ServiceLifecycle.SINGLETON); // Values are always SINGLETON\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Registers an alias that points to another token.\r\n   *\r\n   * @template Tunknown - The type of service\r\n   * @param aliasToken - The alias token\r\n   * @param targetToken - The token to resolve instead\r\n   * @returns Result indicating success or error\r\n   */\r\n  registerAlias<T>(\r\n    aliasToken: InjectionToken<T>,\r\n    targetToken: InjectionToken<T>\r\n  ): Result<void, ContainerError> {\r\n    // Check registration limit (DoS protection)\r\n    if (this.registrations.size >= this.MAX_REGISTRATIONS) {\r\n      return err({\r\n        code: \"MaxRegistrationsExceeded\",\r\n        message: `Cannot register more than ${this.MAX_REGISTRATIONS} services`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    if (this.registrations.has(aliasToken)) {\r\n      return err({\r\n        code: \"DuplicateRegistration\",\r\n        message: `Service ${String(aliasToken)} already registered`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    // Use static factory method for validation\r\n    const registrationResult = ServiceRegistration.createAlias<T>(targetToken);\r\n\r\n    if (isErr(registrationResult)) {\r\n      return registrationResult;\r\n    }\r\n\r\n    this.registrations.set(aliasToken, registrationResult.value);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a service registration.\r\n   *\r\n   * @template Tunknown - The type of service\r\n   * @param token - The injection token identifying the service\r\n   * @returns The registration or undefined if not found\r\n   */\r\n  getRegistration<T>(token: InjectionToken<T>): ServiceRegistration<T> | undefined {\r\n    return this.registrations.get(token);\r\n  }\r\n\r\n  /**\r\n   * Returns all registrations.\r\n   * Used by ContainerValidator for dependency validation.\r\n   *\r\n   * @returns Map of all registrations\r\n   */\r\n  getAllRegistrations(): Map<InjectionToken<unknown>, ServiceRegistration> {\r\n    return new Map(iterateServiceRegistrationEntries(this.registrations.entries())); // Defensive copy\r\n  }\r\n\r\n  /**\r\n   * Returns all registrations for a specific lifecycle.\r\n   * More efficient than filtering getAllRegistrations() when only one lifecycle is needed.\r\n   *\r\n   * @param lifecycle - The lifecycle to query\r\n   * @returns Array of registrations with the specified lifecycle\r\n   */\r\n  getRegistrationsByLifecycle(lifecycle: ServiceLifecycle): ServiceRegistration[] {\r\n    const tokens = this.lifecycleIndex.get(lifecycle) ?? new Set();\r\n    return Array.from(tokens)\r\n      .map((token) => this.registrations.get(token))\r\n      .filter((reg): reg is ServiceRegistration => reg !== undefined);\r\n  }\r\n\r\n  /**\r\n   * Checks if a service is registered.\r\n   *\r\n   * @template Tunknown - The type of service\r\n   * @param token - The injection token to check\r\n   * @returns True if registered, false otherwise\r\n   */\r\n  has<T>(token: InjectionToken<T>): boolean {\r\n    return this.registrations.has(token);\r\n  }\r\n\r\n  /**\r\n   * Clears all registrations.\r\n   * Warning: This removes all configured services.\r\n   */\r\n  clear(): void {\r\n    this.registrations.clear();\r\n    this.lifecycleIndex.clear();\r\n  }\r\n\r\n  /**\r\n   * Creates a deep clone of this registry for child containers.\r\n   *\r\n   * Important: Creates a new Map instance with cloned ServiceRegistration objects\r\n   * to prevent child containers from mutating parent registrations.\r\n   *\r\n   * @returns A new ServiceRegistry with cloned registrations\r\n   */\r\n  clone(): ServiceRegistry {\r\n    const clonedRegistry = new ServiceRegistry();\r\n\r\n    // Create new Map with cloned ServiceRegistration objects\r\n    for (const [token, registration] of iterateServiceRegistrationEntries(\r\n      this.registrations.entries()\r\n    )) {\r\n      clonedRegistry.registrations.set(token, registration.clone());\r\n    }\r\n\r\n    // Clone lifecycle index\r\n    for (const [lifecycle, tokens] of this.lifecycleIndex.entries()) {\r\n      clonedRegistry.lifecycleIndex.set(lifecycle, new Set(tokens));\r\n    }\r\n\r\n    return clonedRegistry;\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Validates service registrations and dependencies.\r\n *\r\n * Responsibilities:\r\n * - Check that all dependencies are registered\r\n * - Detect circular dependencies using DFS\r\n * - Validate alias targets exist\r\n *\r\n * Design:\r\n * - STATEFUL: Maintains cache for performance optimization\r\n * - Cache is cleared on each validate() call for fresh validation\r\n * - Returns aggregated errors for comprehensive feedback\r\n * - Can be extended later with granular validator components\r\n * - Performance optimization: Caches validated sub-graphs for large dependency trees (>500 services)\r\n *\r\n * Note: While this class has internal state, it can be shared between parent and child containers\r\n * because the cache is cleared on each validation run, preventing stale state issues.\r\n */\r\nexport class ContainerValidator {\r\n  // Performance optimization: Cache for validated sub-graphs\r\n  // Prevents redundant DFS traversals in large dependency trees (>500 services)\r\n  private validatedSubgraphs = new Set<InjectionToken<unknown>>();\r\n  /**\r\n   * Validates all registrations in the registry.\r\n   *\r\n   * Performs three checks:\r\n   * 1. All dependencies are registered\r\n   * 2. All alias targets exist\r\n   * 3. No circular dependencies\r\n   *\r\n   * @param registry - The service registry to validate\r\n   * @returns Result with void on success, or array of errors\r\n   */\r\n  validate(registry: ServiceRegistry): Result<void, ContainerError[]> {\r\n    // Clear cache for fresh validation\r\n    this.validatedSubgraphs = new Set<InjectionToken<unknown>>();\r\n\r\n    const errors: ContainerError[] = [\r\n      ...this.validateDependencies(registry),\r\n      ...this.validateAliasTargets(registry),\r\n      ...this.detectCircularDependencies(registry),\r\n    ];\r\n\r\n    return errors.length > 0 ? err(errors) : ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Checks that all declared dependencies are registered.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for missing dependencies\r\n   */\r\n  private validateDependencies(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const [token, registration] of registrations.entries()) {\r\n      for (const dep of registration.dependencies) {\r\n        if (!registry.has(dep)) {\r\n          errors.push({\r\n            code: \"TokenNotRegistered\",\r\n            message: `${String(token)} depends on ${String(dep)} which is not registered`,\r\n            tokenDescription: String(dep),\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Checks that all alias targets are registered.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for missing alias targets\r\n   */\r\n  private validateAliasTargets(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const [token, registration] of registrations.entries()) {\r\n      if (registration.providerType === \"alias\" && registration.aliasTarget) {\r\n        if (!registry.has(registration.aliasTarget)) {\r\n          errors.push({\r\n            code: \"AliasTargetNotFound\",\r\n            message: `Alias ${String(token)} points to ${String(registration.aliasTarget)} which is not registered`,\r\n            tokenDescription: String(registration.aliasTarget),\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Detects circular dependencies using depth-first search.\r\n   *\r\n   * @param registry - The service registry to check\r\n   * @returns Array of errors for detected cycles\r\n   */\r\n  private detectCircularDependencies(registry: ServiceRegistry): ContainerError[] {\r\n    const errors: ContainerError[] = [];\r\n    const visited = new Set<InjectionToken<unknown>>();\r\n    const registrations = registry.getAllRegistrations();\r\n\r\n    for (const token of registrations.keys()) {\r\n      const visiting = new Set<InjectionToken<unknown>>();\r\n      const path: InjectionToken<unknown>[] = [];\r\n\r\n      const error = this.checkCycleForToken(registry, token, visiting, visited, path);\r\n      if (error) {\r\n        errors.push(error);\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Recursively checks for cycles starting from a specific token.\r\n   *\r\n   * **Algorithm: Depth-First Search (DFS) with Three-Color Marking**\r\n   *\r\n   * Three states for each node (token):\r\n   * - WHITE (unvisited): Not in `visiting` or `visited` sets\r\n   * - GRAY (visiting): In `visiting` set (currently in DFS recursion stack)\r\n   * - BLACK (visited): In `visited` set (fully processed, all descendants checked)\r\n   *\r\n   * Cycle Detection:\r\n   * - If we encounter a GRAY node during traversal, we've found a back edge → cycle\r\n   * - GRAY nodes represent the current path from root to current node\r\n   * - Encountering a GRAY node means we're trying to visit an ancestor → circular dependency\r\n   *\r\n   * Performance Optimization:\r\n   * - `validatedSubgraphs` cache prevents redundant traversals of already-validated subtrees\r\n   * - Crucial for large dependency graphs (>500 services)\r\n   * - BLACK nodes can be safely skipped (all their descendants are cycle-free)\r\n   *\r\n   * Time Complexity: O(V + E) where V = number of services, E = number of dependencies\r\n   * Space Complexity: O(V) for visiting/visited sets + O(D) for recursion depth D\r\n   *\r\n   * @param registry - The service registry\r\n   * @param token - Current token being checked (current node in DFS)\r\n   * @param visiting - GRAY nodes: tokens currently in the DFS recursion stack\r\n   * @param visited - BLACK nodes: tokens fully processed in this validation run\r\n   * @param path - Current dependency path for error reporting (stack trace)\r\n   * @returns ContainerError if cycle detected, null otherwise\r\n   *\r\n   * @example\r\n   * Cycle A → B → C → A will be detected when:\r\n   * 1. Start at A (mark GRAY)\r\n   * 2. Visit B (mark GRAY)\r\n   * 3. Visit C (mark GRAY)\r\n   * 4. Try to visit A → A is GRAY → Back edge detected → Cycle!\r\n   */\r\n  private checkCycleForToken(\r\n    registry: ServiceRegistry,\r\n    token: InjectionToken<unknown>,\r\n    visiting: Set<InjectionToken<unknown>>,\r\n    visited: Set<InjectionToken<unknown>>,\r\n    path: InjectionToken<unknown>[]\r\n  ): ContainerError | null {\r\n    // GRAY node encountered: Back edge detected → Cycle exists\r\n    // This token is already in the current DFS path (visiting set)\r\n    // Example: A → B → C → A (when we reach A again from C)\r\n    if (visiting.has(token)) {\r\n      const cyclePath = [...path, token].map(String).join(\" → \");\r\n      return {\r\n        code: \"CircularDependency\",\r\n        message: `Circular dependency: ${cyclePath}`,\r\n        tokenDescription: String(token),\r\n      };\r\n    }\r\n\r\n    // Performance optimization: Skip already validated sub-graphs\r\n    // This token and all its descendants have been proven cycle-free\r\n    // Avoids redundant traversals in DAGs with shared dependencies\r\n    if (this.validatedSubgraphs.has(token)) {\r\n      return null;\r\n    }\r\n\r\n    // BLACK node: Already fully processed in this validation run\r\n    // All descendants of this token have been checked (no cycle below it)\r\n    // Cross edge or forward edge in DFS terminology\r\n    if (visited.has(token)) {\r\n      return null;\r\n    }\r\n\r\n    // Mark as GRAY: Add to current DFS path\r\n    // This token is now being visited (in recursion stack)\r\n    visiting.add(token);\r\n    path.push(token);\r\n\r\n    // DFS: Recursively check all dependencies (children in dependency graph)\r\n    // If any child has a cycle, propagate error up immediately\r\n    const registration = registry.getRegistration(token);\r\n    if (registration) {\r\n      for (const dep of registration.dependencies) {\r\n        const error = this.checkCycleForToken(registry, dep, visiting, visited, path);\r\n        if (error) return error; // Short-circuit: Stop on first cycle found\r\n      }\r\n    }\r\n\r\n    // Mark as BLACK: All descendants checked, no cycles found\r\n    // Remove from GRAY set (no longer in active DFS path)\r\n    // Add to BLACK set (fully processed, can be safely skipped in future)\r\n    visiting.delete(token);\r\n    path.pop();\r\n    visited.add(token);\r\n    this.validatedSubgraphs.add(token); // Cache for performance (persists across validation runs)\r\n\r\n    return null; // No cycle found in this subtree\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { castCachedServiceInstance } from \"../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Cache for service instances (Singleton and Scoped lifecycles).\r\n *\r\n * Responsibilities:\r\n * - Store and retrieve service instances by token\r\n * - Provide access to all instances for disposal\r\n * - Simple get/set/has/clear operations\r\n * - Track cache hits/misses for observability (when MetricsCollector is injected)\r\n *\r\n * Note: This class does NOT handle disposal logic - that's ScopeManager's responsibility.\r\n */\r\nexport class InstanceCache {\r\n  private instances = new Map<InjectionToken<unknown>, unknown>();\r\n  private metricsCollector: MetricsCollector | null = null;\r\n\r\n  /**\r\n   * Injects the MetricsCollector for cache hit/miss tracking.\r\n   * Called after container validation to enable observability.\r\n   *\r\n   * @param collector - The metrics collector instance\r\n   */\r\n  setMetricsCollector(collector: MetricsCollector): void {\r\n    this.metricsCollector = collector;\r\n  }\r\n\r\n  /**\r\n   * Retrieves a cached service instance.\r\n   *\r\n   * @template Tunknown - The type of service to retrieve\r\n   * @param token - The injection token identifying the service\r\n   * @returns The cached instance or undefined if not found\r\n   */\r\n  get<T>(token: InjectionToken<T>): T | undefined {\r\n    const hasInstance = this.instances.has(token);\r\n    // Track cache access for observability (hit = instance found, miss = not found)\r\n    this.metricsCollector?.recordCacheAccess(hasInstance);\r\n    return castCachedServiceInstance<T>(this.instances.get(token));\r\n  }\r\n\r\n  /**\r\n   * Stores a service instance in the cache.\r\n   *\r\n   * @template Tunknown - The type of service to store\r\n   * @param token - The injection token identifying the service\r\n   * @param instance - The service instance to cache\r\n   */\r\n  set<T>(token: InjectionToken<T>, instance: T): void {\r\n    this.instances.set(token, instance);\r\n  }\r\n\r\n  /**\r\n   * Checks if a service instance is cached.\r\n   *\r\n   * @template Tunknown - The type of service to check\r\n   * @param token - The injection token identifying the service\r\n   * @returns True if the instance is cached, false otherwise\r\n   */\r\n  has<T>(token: InjectionToken<T>): boolean {\r\n    const hasInstance = this.instances.has(token);\r\n    // Track cache access for observability (hit = instance found, miss = not found)\r\n    this.metricsCollector?.recordCacheAccess(hasInstance);\r\n    return hasInstance;\r\n  }\r\n\r\n  /**\r\n   * Clears all cached instances.\r\n   * Note: Does not dispose instances - call getAllInstances() first if disposal is needed.\r\n   */\r\n  clear(): void {\r\n    this.instances.clear();\r\n  }\r\n\r\n  /**\r\n   * Returns all cached instances for disposal purposes.\r\n   * Used by ScopeManager to dispose Disposable services.\r\n   *\r\n   * @returns A map of all cached instances\r\n   */\r\n  getAllInstances(): Map<InjectionToken<unknown>, unknown> {\r\n    return new Map(this.instances);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport type { ServiceRegistration } from \"../../types/core/serviceregistration\";\r\nimport type { DependencyResolver } from \"../dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"../service-instantiation.interface\";\r\nimport type { InstanceCache } from \"../../cache/InstanceCache\";\r\nimport type { LifecycleResolutionStrategy } from \"../lifecycle-resolution-strategy.interface\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport { castCachedServiceInstanceForResult } from \"../../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Resolution strategy for Singleton services.\r\n *\r\n * Strategy:\r\n * 1. Try parent resolver first (for shared parent singletons)\r\n * 2. If parent returns error:\r\n *    - CircularDependency → propagate error\r\n *    - TokenNotRegistered → fallback to own cache (child-specific singleton)\r\n * 3. Use own cache for root container or child-specific singletons\r\n */\r\nexport class SingletonResolutionStrategy implements LifecycleResolutionStrategy {\r\n  resolve<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>,\r\n    dependencyResolver: DependencyResolver,\r\n    instantiator: ServiceInstantiator,\r\n    cache: InstanceCache,\r\n    parentResolver: DependencyResolver | null,\r\n    _scopeName: string\r\n  ): Result<T, ContainerError> {\r\n    // Try parent resolver first for shared singletons\r\n    if (parentResolver !== null) {\r\n      const parentResult = parentResolver.resolve(token);\r\n\r\n      if (parentResult.ok) {\r\n        // Parent has it - use parent's singleton instance (shared)\r\n        return parentResult;\r\n      }\r\n\r\n      // Check error code to determine action\r\n      if (parentResult.error.code === \"CircularDependency\") {\r\n        // Real circular dependency - propagate as-is\r\n        return parentResult;\r\n      }\r\n\r\n      // TokenNotRegistered or other error -> fallback to own cache\r\n      // This allows child-specific singleton registrations\r\n    }\r\n\r\n    // Root container OR parent doesn't have it: use own cache\r\n    if (!cache.has(token)) {\r\n      const instanceResult = instantiator.instantiate(token, registration);\r\n      if (!instanceResult.ok) {\r\n        return instanceResult; // Propagate error without wrapping\r\n      }\r\n      cache.set(token, instanceResult.value);\r\n    }\r\n\r\n    const instanceResult = castCachedServiceInstanceForResult<T>(cache.get(token));\r\n    if (!instanceResult.ok) {\r\n      return instanceResult; // Propagate error\r\n    }\r\n    return ok(instanceResult.value);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport type { ServiceRegistration } from \"../../types/core/serviceregistration\";\r\nimport type { DependencyResolver } from \"../dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"../service-instantiation.interface\";\r\nimport type { InstanceCache } from \"../../cache/InstanceCache\";\r\nimport type { LifecycleResolutionStrategy } from \"../lifecycle-resolution-strategy.interface\";\r\n\r\n/**\r\n * Resolution strategy for Transient services.\r\n *\r\n * Strategy:\r\n * - Always create new instance (no caching)\r\n */\r\nexport class TransientResolutionStrategy implements LifecycleResolutionStrategy {\r\n  resolve<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>,\r\n    _dependencyResolver: DependencyResolver,\r\n    instantiator: ServiceInstantiator,\r\n    _cache: InstanceCache,\r\n    _parentResolver: DependencyResolver | null,\r\n    _scopeName: string\r\n  ): Result<T, ContainerError> {\r\n    // Transient services always create new instances\r\n    return instantiator.instantiate(token, registration);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../../interfaces\";\r\nimport type { ServiceRegistration } from \"../../types/core/serviceregistration\";\r\nimport type { DependencyResolver } from \"../dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"../service-instantiation.interface\";\r\nimport type { InstanceCache } from \"../../cache/InstanceCache\";\r\nimport type { LifecycleResolutionStrategy } from \"../lifecycle-resolution-strategy.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { castCachedServiceInstanceForResult } from \"../../types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Resolution strategy for Scoped services.\r\n *\r\n * ⚠️ IMPORTANT: Scoped services can ONLY be resolved in child containers.\r\n * Attempting to resolve a scoped service in the root container will return\r\n * a ScopeRequired error.\r\n *\r\n * Strategy:\r\n * - Must be in child scope (not root)\r\n * - One instance per scope (cached)\r\n * - Each child scope gets its own isolated instance\r\n */\r\nexport class ScopedResolutionStrategy implements LifecycleResolutionStrategy {\r\n  resolve<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>,\r\n    _dependencyResolver: DependencyResolver,\r\n    instantiator: ServiceInstantiator,\r\n    cache: InstanceCache,\r\n    parentResolver: DependencyResolver | null,\r\n    _scopeName: string\r\n  ): Result<T, ContainerError> {\r\n    // Scoped services require a child scope\r\n    if (parentResolver === null) {\r\n      return err({\r\n        code: \"ScopeRequired\",\r\n        message: `Scoped service ${String(token)} requires a scope container. Use createScope() to create a child container first.`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    // Check cache (one instance per scope)\r\n    if (!cache.has(token)) {\r\n      const instanceResult = instantiator.instantiate(token, registration);\r\n      if (!instanceResult.ok) {\r\n        return instanceResult; // Propagate error\r\n      }\r\n      cache.set(token, instanceResult.value);\r\n    }\r\n\r\n    const instanceResult = castCachedServiceInstanceForResult<T>(cache.get(token));\r\n    if (!instanceResult.ok) {\r\n      return instanceResult; // Propagate error\r\n    }\r\n    return ok(instanceResult.value);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport type { DependencyResolver } from \"./dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"./service-instantiation.interface\";\r\nimport type { InstanceCache } from \"../cache/InstanceCache\";\r\nimport type { LifecycleResolutionStrategy } from \"./lifecycle-resolution-strategy.interface\";\r\nimport { ServiceLifecycle } from \"../types/core/servicelifecycle\";\r\nimport { SingletonResolutionStrategy } from \"./strategies/singleton-resolution-strategy\";\r\nimport { TransientResolutionStrategy } from \"./strategies/transient-resolution-strategy\";\r\nimport { ScopedResolutionStrategy } from \"./strategies/scoped-resolution-strategy\";\r\nimport { err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Resolves services based on their lifecycle using strategy pattern.\r\n *\r\n * Responsibilities:\r\n * - Select appropriate lifecycle strategy\r\n * - Delegate resolution to strategy\r\n * - Handle invalid lifecycle errors\r\n *\r\n * This class separates lifecycle-specific resolution logic from ServiceResolver,\r\n * following the Single Responsibility Principle.\r\n *\r\n * Uses DependencyResolver and ServiceInstantiator interfaces instead of\r\n * ServiceResolver to break circular dependencies (Dependency Inversion Principle).\r\n */\r\nexport class LifecycleResolver {\r\n  private readonly strategies = new Map<ServiceLifecycle, LifecycleResolutionStrategy>();\r\n\r\n  constructor(\r\n    private readonly cache: InstanceCache,\r\n    private readonly parentResolver: DependencyResolver | null,\r\n    private readonly scopeName: string\r\n  ) {\r\n    // Initialize lifecycle strategies\r\n    this.strategies.set(ServiceLifecycle.SINGLETON, new SingletonResolutionStrategy());\r\n    this.strategies.set(ServiceLifecycle.TRANSIENT, new TransientResolutionStrategy());\r\n    this.strategies.set(ServiceLifecycle.SCOPED, new ScopedResolutionStrategy());\r\n  }\r\n\r\n  /**\r\n   * Resolves a service based on its lifecycle.\r\n   *\r\n   * @template T - The type of service to resolve\r\n   * @param token - The injection token identifying the service\r\n   * @param registration - The service registration metadata\r\n   * @param dependencyResolver - The DependencyResolver for dependency resolution\r\n   * @param instantiator - The ServiceInstantiator for service instantiation\r\n   * @returns Result with service instance or error\r\n   */\r\n  resolve<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>,\r\n    dependencyResolver: DependencyResolver,\r\n    instantiator: ServiceInstantiator\r\n  ): Result<T, ContainerError> {\r\n    const strategy = this.strategies.get(registration.lifecycle);\r\n    if (!strategy) {\r\n      return err({\r\n        code: \"InvalidLifecycle\",\r\n        message: `Invalid service lifecycle: ${String(registration.lifecycle)}`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n    return strategy.resolve(\r\n      token,\r\n      registration,\r\n      dependencyResolver,\r\n      instantiator,\r\n      this.cache,\r\n      this.parentResolver,\r\n      this.scopeName\r\n    );\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport type { DependencyResolver } from \"./dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"./service-instantiation.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Instantiates service instances based on registration type.\r\n *\r\n * Responsibilities:\r\n * - Handle class instantiation with dependency injection\r\n * - Handle factory function calls\r\n * - Handle value returns\r\n * - Wrap errors in ContainerError format\r\n *\r\n * This class separates service instantiation logic from ServiceResolver,\r\n * following the Single Responsibility Principle.\r\n *\r\n * Uses DependencyResolver interface instead of ServiceResolver to break\r\n * circular dependency (Dependency Inversion Principle).\r\n */\r\nexport class ServiceInstantiatorImpl implements ServiceInstantiator {\r\n  constructor(private readonly dependencyResolver: DependencyResolver) {}\r\n\r\n  /**\r\n   * Instantiates a service based on registration type.\r\n   *\r\n   * CRITICAL: Returns Result to preserve error context and avoid breaking Result-Contract.\r\n   * Handles dependency resolution for classes, direct factory calls, and value returns.\r\n   *\r\n   * @template T - The type of service to instantiate\r\n   * @param token - The injection token (used for error messages)\r\n   * @param registration - The service registration metadata\r\n   * @returns Result with instance or detailed error (DependencyResolveFailed, FactoryFailed, etc.)\r\n   */\r\n  instantiate<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>\r\n  ): Result<T, ContainerError> {\r\n    if (registration.serviceClass) {\r\n      // Class: Resolve all dependencies first\r\n      const resolvedDeps: unknown[] = [];\r\n\r\n      for (const dep of registration.dependencies) {\r\n        const depResult = this.dependencyResolver.resolve(dep);\r\n        if (!depResult.ok) {\r\n          // Return structured error with cause chain\r\n          return err({\r\n            code: \"DependencyResolveFailed\",\r\n            message: `Cannot resolve dependency ${String(dep)} for ${String(token)}`,\r\n            tokenDescription: String(dep),\r\n            cause: depResult.error,\r\n          });\r\n        }\r\n        resolvedDeps.push(depResult.value);\r\n      }\r\n\r\n      // Instantiate class with resolved dependencies\r\n      try {\r\n        return ok(new registration.serviceClass(...resolvedDeps));\r\n      } catch (constructorError) {\r\n        return err({\r\n          code: \"FactoryFailed\",\r\n          message: `Constructor failed for ${String(token)}: ${String(constructorError)}`,\r\n          tokenDescription: String(token),\r\n          cause: constructorError,\r\n        });\r\n      }\r\n    } else if (registration.factory) {\r\n      // Factory: Call directly\r\n      try {\r\n        return ok(registration.factory());\r\n      } catch (factoryError) {\r\n        return err({\r\n          code: \"FactoryFailed\",\r\n          message: `Factory failed for ${String(token)}: ${String(factoryError)}`,\r\n          tokenDescription: String(token),\r\n          cause: factoryError,\r\n        });\r\n      }\r\n    } else if (registration.value !== undefined) {\r\n      // Value: Return as-is\r\n      return ok(registration.value);\r\n    } else {\r\n      // Invalid registration\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: `Invalid registration for ${String(token)} - no class, factory, or value`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport type { ServiceRegistration } from \"../types/core/serviceregistration\";\r\nimport { InstanceCache } from \"../cache/InstanceCache\";\r\nimport { err } from \"@/domain/utils/result\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { PerformanceTracker } from \"@/infrastructure/observability/performance-tracker.interface\";\r\nimport { LifecycleResolver } from \"./lifecycle-resolver\";\r\nimport { ServiceInstantiatorImpl } from \"./service-instantiator\";\r\nimport type { DependencyResolver } from \"./dependency-resolver.interface\";\r\nimport type { ServiceInstantiator } from \"./service-instantiation.interface\";\r\n\r\n/**\r\n * Resolves service instances based on lifecycle and registration.\r\n *\r\n * Responsibilities:\r\n * - Resolve services by token\r\n * - Handle alias resolution\r\n * - Delegate lifecycle resolution to LifecycleResolver\r\n * - Delegate service instantiation to ServiceInstantiator\r\n *\r\n * Design:\r\n * - Works with Result pattern (no throws)\r\n * - Wraps factory errors in FactoryFailedError\r\n * - Parent resolver for Singleton sharing across scopes\r\n * - PerformanceTracker injected via constructor (avoids circular dependency)\r\n * - MetricsCollector injected after container validation for metrics recording\r\n * - Lifecycle-specific resolution delegated to LifecycleResolver (SRP)\r\n * - Service instantiation delegated to ServiceInstantiator (SRP)\r\n * - Implements DependencyResolver and ServiceInstantiator interfaces to break circular dependencies\r\n */\r\nexport class ServiceResolver implements DependencyResolver, ServiceInstantiator {\r\n  private metricsCollector: MetricsCollector | null = null;\r\n  private readonly lifecycleResolver: LifecycleResolver;\r\n  private readonly instantiator: ServiceInstantiatorImpl;\r\n\r\n  constructor(\r\n    private readonly registry: ServiceRegistry,\r\n    private readonly cache: InstanceCache,\r\n    private readonly parentResolver: ServiceResolver | null,\r\n    private readonly scopeName: string,\r\n    private readonly performanceTracker: PerformanceTracker\r\n  ) {\r\n    // Pass parentResolver as DependencyResolver to break circular dependency\r\n    this.lifecycleResolver = new LifecycleResolver(cache, parentResolver, scopeName);\r\n    // Pass this as DependencyResolver to break circular dependency\r\n    this.instantiator = new ServiceInstantiatorImpl(this);\r\n  }\r\n\r\n  /**\r\n   * Sets the MetricsCollector for metrics recording.\r\n   * Called by ServiceContainer after validation.\r\n   *\r\n   * @param collector - The metrics collector instance\r\n   */\r\n  setMetricsCollector(collector: MetricsCollector): void {\r\n    this.metricsCollector = collector;\r\n  }\r\n\r\n  /**\r\n   * Resolves a service by token.\r\n   *\r\n   * Handles:\r\n   * - Alias resolution (recursive)\r\n   * - Lifecycle-specific resolution (delegated to LifecycleResolver)\r\n   * - Performance tracking\r\n   * - Metrics recording\r\n   *\r\n   * Performance tracking is handled by the injected PerformanceTracker.\r\n   *\r\n   * @template T - The type of service to resolve\r\n   * @param token - The injection token identifying the service\r\n   * @returns Result with service instance or error\r\n   */\r\n  resolve<T>(token: InjectionToken<T>): Result<T, ContainerError> {\r\n    return this.performanceTracker.track(\r\n      () => {\r\n        // Check if service is registered\r\n        const registration = this.registry.getRegistration(token);\r\n        if (!registration) {\r\n          const stack = new Error().stack;\r\n          const error: ContainerError = {\r\n            code: \"TokenNotRegistered\",\r\n            message: `Service ${String(token)} not registered`,\r\n            tokenDescription: String(token),\r\n            ...(stack !== undefined && { stack }), // Only include stack if defined\r\n            timestamp: Date.now(),\r\n            containerScope: this.scopeName,\r\n          };\r\n          return err(error);\r\n        }\r\n\r\n        // Handle alias resolution\r\n        if (registration.providerType === \"alias\" && registration.aliasTarget) {\r\n          return this.resolve(registration.aliasTarget);\r\n        }\r\n\r\n        // Delegate to LifecycleResolver\r\n        return this.lifecycleResolver.resolve(token, registration, this, this);\r\n      },\r\n      (duration, result) => {\r\n        this.metricsCollector?.recordResolution(token, duration, result.ok);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Instantiates a service based on registration type.\r\n   *\r\n   * CRITICAL: Returns Result to preserve error context and avoid breaking Result-Contract.\r\n   * Delegates to ServiceInstantiatorImpl for actual instantiation logic.\r\n   *\r\n   * This method implements the ServiceInstantiator interface, allowing lifecycle\r\n   * strategies to instantiate services without depending on ServiceResolver directly.\r\n   *\r\n   * @template T - The type of service to instantiate\r\n   * @param token - The injection token (used for error messages)\r\n   * @param registration - The service registration metadata\r\n   * @returns Result with instance or detailed error (DependencyResolveFailed, FactoryFailed, etc.)\r\n   */\r\n  instantiate<T>(\r\n    token: InjectionToken<T>,\r\n    registration: ServiceRegistration<T>\r\n  ): Result<T, ContainerError> {\r\n    return this.instantiator.instantiate(token, registration);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { Disposable, AsyncDisposable } from \"../interfaces\";\r\nimport { InstanceCache } from \"../cache/InstanceCache\";\r\nimport { ok, err, tryCatch, isErr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Helper function to generate unique scope names.\r\n * Tries crypto.randomUUID(), falls back to timestamp + random.\r\n */\r\nfunction generateScopeId(): string {\r\n  try {\r\n    return crypto.randomUUID();\r\n  } catch {\r\n    return Date.now() + \"-\" + Math.random();\r\n  }\r\n}\r\n\r\n/**\r\n * Manages scope hierarchy and disposal lifecycle.\r\n *\r\n * Responsibilities:\r\n * - Track child scopes in hierarchy\r\n * - Generate scope names\r\n * - Dispose instances (supports both Disposable and AsyncDisposable patterns)\r\n * - Cascade disposal to children\r\n * - Enforce maximum scope depth (stack overflow protection)\r\n *\r\n * Design:\r\n * - NO dependency on ServiceResolver (avoids circular dependency)\r\n * - createChild() returns data for facade to build new container\r\n * - Disposal order: children first, then instances (critical!)\r\n * - Supports both sync (dispose()) and async (disposeAsync()) disposal modes\r\n *\r\n * Disposal Modes:\r\n * - dispose(): Synchronous disposal (for browser unload, emergency cleanup)\r\n * - disposeAsync(): Asynchronous disposal (preferred, handles async cleanup properly)\r\n */\r\nexport class ScopeManager {\r\n  private readonly MAX_SCOPE_DEPTH = 10; // Prevent deep nesting and potential stack overflow\r\n  private children = new Set<ScopeManager>();\r\n  private disposed = false;\r\n  private readonly depth: number;\r\n  private readonly scopeId: string; // Unique correlation ID for tracing\r\n\r\n  constructor(\r\n    private readonly scopeName: string,\r\n    private readonly parent: ScopeManager | null,\r\n    private readonly cache: InstanceCache,\r\n    depth: number = 0\r\n  ) {\r\n    this.depth = depth;\r\n    // Generate unique correlation ID for this scope (useful for logging/tracing)\r\n    this.scopeId = `${scopeName}-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Creates a child scope manager.\r\n   *\r\n   * Note: Returns data (scopeName, cache, childManager) instead of full container\r\n   * to avoid circular dependency with ServiceResolver.\r\n   *\r\n   * @param name - Optional custom name for the scope\r\n   * @returns Result with child scope data or error if disposed or max depth exceeded\r\n   */\r\n  createChild(\r\n    name?: string\r\n  ): Result<{ scopeName: string; cache: InstanceCache; manager: ScopeManager }, ContainerError> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot create child scope from disposed scope: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Check maximum scope depth (stack overflow protection)\r\n    if (this.depth >= this.MAX_SCOPE_DEPTH) {\r\n      return err({\r\n        code: \"MaxScopeDepthExceeded\",\r\n        message: `Maximum scope depth of ${this.MAX_SCOPE_DEPTH} exceeded. Current depth: ${this.depth}`,\r\n      });\r\n    }\r\n\r\n    // Build hierarchical scope name\r\n    const uniqueId = name ?? `scope-${generateScopeId()}`;\r\n    const childScopeName = `${this.scopeName}.${uniqueId}`;\r\n\r\n    // Create new cache for child\r\n    const childCache = new InstanceCache();\r\n\r\n    // Create child manager with incremented depth\r\n    const childManager = new ScopeManager(childScopeName, this, childCache, this.depth + 1);\r\n\r\n    // Only add to children set AFTER successful creation\r\n    this.children.add(childManager);\r\n\r\n    return ok({\r\n      scopeName: childScopeName,\r\n      cache: childCache,\r\n      manager: childManager,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Disposes this scope and all child scopes.\r\n   *\r\n   * Disposal order (critical):\r\n   * 1. Recursively dispose all children\r\n   * 2. Dispose instances in this scope (if Disposable)\r\n   * 3. Clear instance cache\r\n   * 4. Remove from parent's children set\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  dispose(): Result<void, ContainerError> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Scope already disposed: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Mark as disposed BEFORE disposing children to prevent concurrent operations\r\n    this.disposed = true;\r\n\r\n    // Collect disposal errors instead of logging\r\n    const childDisposalErrors: Array<{ scopeName: string; error: ContainerError }> = [];\r\n\r\n    // Step 1: Recursively dispose all child scopes (children first!)\r\n    for (const child of this.children) {\r\n      const childResult = child.dispose();\r\n\r\n      if (isErr(childResult)) {\r\n        // Collect error instead of logging\r\n        childDisposalErrors.push({\r\n          scopeName: child.scopeName,\r\n          error: childResult.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Step 2: Dispose instances in this scope\r\n    const disposeResult = this.disposeInstances();\r\n    if (!disposeResult.ok) {\r\n      return disposeResult;\r\n    }\r\n\r\n    // Step 3: Clear cache\r\n    this.cache.clear();\r\n\r\n    // Step 4: Remove from parent's children set\r\n    if (this.parent !== null) {\r\n      this.parent.children.delete(this);\r\n    }\r\n\r\n    // Return aggregated errors if any children failed\r\n    if (childDisposalErrors.length > 0) {\r\n      return err({\r\n        code: \"PartialDisposal\",\r\n        message: `Failed to dispose ${childDisposalErrors.length} child scope(s)`,\r\n        details: childDisposalErrors,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Asynchronously disposes this scope and all child scopes.\r\n   *\r\n   * Preferred method for cleanup as it properly handles async dispose operations.\r\n   * Falls back to sync dispose() for services that only implement Disposable.\r\n   *\r\n   * Disposal order (critical):\r\n   * 1. Recursively dispose all children (async)\r\n   * 2. Dispose instances in this scope (async or sync)\r\n   * 3. Clear instance cache\r\n   * 4. Remove from parent's children set\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   */\r\n  async disposeAsync(): Promise<Result<void, ContainerError>> {\r\n    if (this.disposed) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Scope already disposed: ${this.scopeName}`,\r\n      });\r\n    }\r\n\r\n    // Mark as disposed BEFORE disposing children to prevent concurrent operations\r\n    this.disposed = true;\r\n\r\n    // Collect disposal errors instead of logging\r\n    const childDisposalErrors: Array<{ scopeName: string; error: ContainerError }> = [];\r\n\r\n    // Step 1: Recursively dispose all child scopes (children first!)\r\n    for (const child of this.children) {\r\n      const childResult = await child.disposeAsync();\r\n\r\n      if (isErr(childResult)) {\r\n        // Collect error instead of logging\r\n        childDisposalErrors.push({\r\n          scopeName: child.scopeName,\r\n          error: childResult.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Step 2: Dispose instances in this scope (async)\r\n    const disposeResult = await this.disposeInstancesAsync();\r\n    if (!disposeResult.ok) {\r\n      return disposeResult;\r\n    }\r\n\r\n    // Step 3: Clear cache\r\n    this.cache.clear();\r\n\r\n    // Step 4: Remove from parent's children set\r\n    if (this.parent !== null) {\r\n      this.parent.children.delete(this);\r\n    }\r\n\r\n    // Return aggregated errors if any children failed\r\n    if (childDisposalErrors.length > 0) {\r\n      return err({\r\n        code: \"PartialDisposal\",\r\n        message: `Failed to dispose ${childDisposalErrors.length} child scope(s)`,\r\n        details: childDisposalErrors,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Disposes all instances in the cache that implement Disposable (sync).\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  private disposeInstances(): Result<void, ContainerError> {\r\n    const instances = this.cache.getAllInstances();\r\n\r\n    for (const [token, instance] of instances.entries()) {\r\n      if (this.isDisposable(instance)) {\r\n        const result = tryCatch(\r\n          () => instance.dispose(),\r\n          (error): ContainerError => ({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          })\r\n        );\r\n\r\n        if (isErr(result)) {\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Disposes all instances in the cache that implement Disposable or AsyncDisposable (async).\r\n   * Prefers async disposal when available, falls back to sync.\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   */\r\n  private async disposeInstancesAsync(): Promise<Result<void, ContainerError>> {\r\n    const instances = this.cache.getAllInstances();\r\n\r\n    for (const [token, instance] of instances.entries()) {\r\n      // Try async disposal first (preferred)\r\n      if (this.isAsyncDisposable(instance)) {\r\n        try {\r\n          await instance.disposeAsync();\r\n        } catch (error) {\r\n          return err({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          });\r\n        }\r\n      }\r\n      // Fallback to sync disposal\r\n      else if (this.isDisposable(instance)) {\r\n        const disposableInstance = instance;\r\n        const result = tryCatch(\r\n          () => disposableInstance.dispose(),\r\n          (error): ContainerError => ({\r\n            code: \"DisposalFailed\",\r\n            message: `Error disposing service ${String(token)}: ${String(error)}`,\r\n            tokenDescription: String(token),\r\n            cause: error,\r\n          })\r\n        );\r\n\r\n        if (isErr(result)) {\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Type guard to check if an instance implements the Disposable pattern.\r\n   *\r\n   * @param instance - The service instance to check\r\n   * @returns True if instance has dispose() method\r\n   */\r\n  private isDisposable(instance: unknown): instance is Disposable {\r\n    return (\r\n      instance !== null &&\r\n      typeof instance === \"object\" &&\r\n      \"dispose\" in instance &&\r\n      // Type-safe check: instance has 'dispose' property (checked above)\r\n      typeof (instance as Record<string, unknown>).dispose === \"function\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Type guard to check if an instance implements the AsyncDisposable pattern.\r\n   *\r\n   * @param instance - The service instance to check\r\n   * @returns True if instance has disposeAsync() method\r\n   */\r\n  private isAsyncDisposable(instance: unknown): instance is AsyncDisposable {\r\n    return (\r\n      instance !== null &&\r\n      typeof instance === \"object\" &&\r\n      \"disposeAsync\" in instance &&\r\n      // Type-safe check: instance has 'disposeAsync' property (checked above)\r\n      typeof (instance as Record<string, unknown>).disposeAsync === \"function\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Checks if this scope is disposed.\r\n   *\r\n   * @returns True if disposed, false otherwise\r\n   */\r\n  isDisposed(): boolean {\r\n    return this.disposed;\r\n  }\r\n\r\n  /**\r\n   * Gets the hierarchical scope name.\r\n   *\r\n   * @returns The scope name (e.g., \"root.child1.grandchild\")\r\n   */\r\n  getScopeName(): string {\r\n    return this.scopeName;\r\n  }\r\n\r\n  /**\r\n   * Gets the unique correlation ID for this scope.\r\n   *\r\n   * Useful for tracing and logging in distributed/concurrent scenarios.\r\n   * Each scope gets a unique ID combining name, timestamp, and random string.\r\n   *\r\n   * @returns The unique scope ID (e.g., \"root-1730761234567-abc123\")\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const scope = container.createScope(\"request\").value!;\r\n   * logger.info(`[${scope.getScopeId()}] Processing request`);\r\n   * ```\r\n   */\r\n  getScopeId(): string {\r\n    return this.scopeId;\r\n  }\r\n}\r\n","/**\r\n * Promise timeout utility.\r\n * Wraps a promise with a timeout, rejecting if the promise doesn't resolve in time.\r\n */\r\n\r\n/**\r\n * Error thrown when a promise times out.\r\n */\r\nexport class TimeoutError extends Error {\r\n  constructor(timeoutMs: number) {\r\n    super(`Operation timed out after ${timeoutMs}ms`);\r\n    this.name = \"TimeoutError\";\r\n  }\r\n}\r\n\r\n/**\r\n * Wraps a promise with a timeout.\r\n *\r\n * If the promise doesn't resolve/reject within the specified time,\r\n * it rejects with a TimeoutError.\r\n *\r\n * @template T - Type of the promise result\r\n * @param promise - Promise to wrap\r\n * @param timeoutMs - Timeout in milliseconds\r\n * @returns Promise that rejects with TimeoutError if timeout is exceeded\r\n *\r\n * @example\r\n * ```typescript\r\n * try {\r\n *   const result = await withTimeout(fetchData(), 5000);\r\n *   console.log(\"Got result:\", result);\r\n * } catch (error) {\r\n *   if (error instanceof TimeoutError) {\r\n *     console.error(\"Operation timed out\");\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport function withTimeout<T>(promise: Promise<T>, timeoutMs: number): Promise<T> {\r\n  let timeoutHandle: NodeJS.Timeout | null = null;\r\n\r\n  const timeoutPromise = new Promise<T>((_, reject) => {\r\n    timeoutHandle = setTimeout(() => {\r\n      reject(new TimeoutError(timeoutMs));\r\n    }, timeoutMs);\r\n  });\r\n\r\n  return Promise.race([\r\n    promise.finally(() => {\r\n      // Clear timeout when promise settles (either resolves or rejects)\r\n      // This prevents the timeout from firing after the promise is already settled\r\n      if (timeoutHandle !== null) {\r\n        clearTimeout(timeoutHandle);\r\n      }\r\n    }),\r\n    timeoutPromise,\r\n  ]);\r\n}\r\n","/**\r\n * Injection token for the MetricsCollector service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\n\r\n/**\r\n * Injection token for the MetricsCollector service.\r\n *\r\n * Provides observability and performance tracking for the DI container.\r\n * Collects metrics about service resolutions, port selections, and cache performance.\r\n *\r\n * @example\r\n * ```typescript\r\n * const metrics = container.resolve(metricsCollectorToken);\r\n * metrics.recordResolution(someToken, 2.5, true);\r\n * const snapshot = metrics.getSnapshot();\r\n * console.table(snapshot);\r\n * ```\r\n */\r\nexport const metricsCollectorToken = createInjectionToken<MetricsCollector>(\"MetricsCollector\");\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { ServiceClass } from \"../types/resolution/serviceclass\";\r\nimport type { FactoryFunction } from \"../types/resolution/servicefactory\";\r\nimport type { ServiceDependencies } from \"../types/resolution/servicedependencies\";\r\nimport type { ServiceLifecycle } from \"../types/core/servicelifecycle\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ContainerValidationState } from \"../types/errors/containervalidationstate\";\r\nimport { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport { err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Manages service registration operations.\r\n *\r\n * Responsibilities:\r\n * - Delegates registration to ServiceRegistry\r\n * - Validates disposal state before registration\r\n * - Validates validation state before registration\r\n *\r\n * Design:\r\n * - Pure delegation to ServiceRegistry\r\n * - State checks (disposal, validation) are responsibility of this manager\r\n */\r\nexport class ServiceRegistrationManager {\r\n  constructor(\r\n    private readonly registry: ServiceRegistry,\r\n    private readonly isDisposed: () => boolean,\r\n    private readonly getValidationState: () => ContainerValidationState\r\n  ) {}\r\n\r\n  /**\r\n   * Register a service class with automatic dependency injection.\r\n   */\r\n  registerClass<T>(\r\n    token: InjectionToken<T>,\r\n    serviceClass: ServiceClass<T>,\r\n    lifecycle: ServiceLifecycle\r\n  ): Result<void, ContainerError> {\r\n    if (this.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.getValidationState() === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerClass(token, serviceClass, lifecycle);\r\n  }\r\n\r\n  /**\r\n   * Register a factory function.\r\n   */\r\n  registerFactory<T>(\r\n    token: InjectionToken<T>,\r\n    factory: FactoryFunction<T>,\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: ServiceDependencies\r\n  ): Result<void, ContainerError> {\r\n    if (this.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.getValidationState() === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    // Validate factory parameter\r\n    if (!factory || typeof factory !== \"function\") {\r\n      return err({\r\n        code: \"InvalidFactory\",\r\n        message: \"Factory must be a function\",\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    return this.registry.registerFactory(token, factory, lifecycle, dependencies);\r\n  }\r\n\r\n  /**\r\n   * Register a constant value.\r\n   */\r\n  registerValue<T>(token: InjectionToken<T>, value: T): Result<void, ContainerError> {\r\n    if (this.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    if (this.getValidationState() === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerValue(token, value);\r\n  }\r\n\r\n  /**\r\n   * Register an alias.\r\n   */\r\n  registerAlias<T>(\r\n    aliasToken: InjectionToken<T>,\r\n    targetToken: InjectionToken<T>\r\n  ): Result<void, ContainerError> {\r\n    if (this.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot register service on disposed container`,\r\n        tokenDescription: String(aliasToken),\r\n      });\r\n    }\r\n\r\n    if (this.getValidationState() === \"validated\") {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message: \"Cannot register after validation\",\r\n      });\r\n    }\r\n\r\n    return this.registry.registerAlias(aliasToken, targetToken);\r\n  }\r\n\r\n  /**\r\n   * Get a registered value without requiring validation.\r\n   * Useful for bootstrap/static values.\r\n   */\r\n  getRegisteredValue<T>(token: InjectionToken<T>): T | null {\r\n    const registration = this.registry.getRegistration(token);\r\n    if (!registration) {\r\n      return null;\r\n    }\r\n    if (registration.providerType !== \"value\") {\r\n      return null;\r\n    }\r\n    const value = registration.value as T | undefined;\r\n    if (value === undefined) {\r\n      return null;\r\n    }\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Check if a service is registered.\r\n   */\r\n  isRegistered<T>(token: InjectionToken<T>): boolean {\r\n    return this.registry.has(token);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ContainerValidationState } from \"../types/errors/containervalidationstate\";\r\nimport type { ServiceRegistry } from \"../registry/ServiceRegistry\";\r\nimport { ContainerValidator } from \"./ContainerValidator\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Manages container validation and validation state.\r\n *\r\n * Responsibilities:\r\n * - Manages validation state (registering, validating, validated)\r\n * - Delegates validation to ContainerValidator\r\n * - Handles async validation with timeout\r\n * - Manages validation promise for concurrent access\r\n *\r\n * Design:\r\n * - State management is responsibility of this manager\r\n * - Validation logic is delegated to ContainerValidator\r\n */\r\nexport class ContainerValidationManager {\r\n  private validationState: ContainerValidationState;\r\n  private validationPromise: Promise<Result<void, ContainerError[]>> | null = null;\r\n\r\n  constructor(\r\n    private readonly validator: ContainerValidator,\r\n    private readonly registry: ServiceRegistry,\r\n    initialState: ContainerValidationState = \"registering\"\r\n  ) {\r\n    this.validationState = initialState;\r\n  }\r\n\r\n  /**\r\n   * Validate all registrations.\r\n   */\r\n  validate(): Result<void, ContainerError[]> {\r\n    if (this.validationState === \"validated\") {\r\n      return ok(undefined);\r\n    }\r\n\r\n    if (this.validationState === \"validating\") {\r\n      return err([\r\n        {\r\n          code: \"InvalidOperation\",\r\n          message: \"Validation already in progress\",\r\n        },\r\n      ]);\r\n    }\r\n\r\n    this.validationState = \"validating\";\r\n\r\n    const result = this.validator.validate(this.registry);\r\n\r\n    if (result.ok) {\r\n      this.validationState = \"validated\";\r\n    } else {\r\n      this.validationState = \"registering\";\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Async-safe validation for concurrent environments with timeout.\r\n   */\r\n  async validateAsync(\r\n    timeoutMs: number,\r\n    withTimeout: <T>(promise: Promise<T>, timeoutMs: number) => Promise<T>,\r\n    TimeoutErrorClass: new (timeoutMs: number) => Error\r\n  ): Promise<Result<void, ContainerError[]>> {\r\n    // Return immediately if already validated\r\n    if (this.validationState === \"validated\") {\r\n      return ok(undefined);\r\n    }\r\n\r\n    // Wait for ongoing validation\r\n    if (this.validationPromise !== null) {\r\n      return this.validationPromise;\r\n    }\r\n\r\n    // Validation already in progress (sync)\r\n    if (this.validationState === \"validating\") {\r\n      return err([\r\n        {\r\n          code: \"InvalidOperation\",\r\n          message: \"Validation already in progress\",\r\n        },\r\n      ]);\r\n    }\r\n\r\n    this.validationState = \"validating\";\r\n\r\n    // Track if timeout occurred to prevent state changes after timeout\r\n    let timedOut = false;\r\n\r\n    // Create validation task\r\n    const validationTask = Promise.resolve().then(() => {\r\n      const result = this.validator.validate(this.registry);\r\n\r\n      // Only update state if no timeout occurred\r\n      if (!timedOut) {\r\n        if (result.ok) {\r\n          this.validationState = \"validated\";\r\n        } else {\r\n          this.validationState = \"registering\";\r\n        }\r\n      }\r\n\r\n      return result;\r\n    });\r\n\r\n    // Wrap validation with timeout\r\n    try {\r\n      this.validationPromise = withTimeout(validationTask, timeoutMs);\r\n      const result = await this.validationPromise;\r\n      return result;\r\n    } catch (error) {\r\n      // Handle timeout\r\n      if (error instanceof TimeoutErrorClass) {\r\n        timedOut = true; // Mark timeout occurred\r\n        this.validationState = \"registering\"; // Reset deterministically\r\n        return err([\r\n          {\r\n            code: \"InvalidOperation\",\r\n            message: `Validation timed out after ${timeoutMs}ms`,\r\n          },\r\n        ]);\r\n      }\r\n      // Re-throw unexpected errors\r\n      throw error;\r\n    } finally {\r\n      this.validationPromise = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get validation state.\r\n   */\r\n  getValidationState(): ContainerValidationState {\r\n    return this.validationState;\r\n  }\r\n\r\n  /**\r\n   * Reset validation state (used after disposal or clear).\r\n   */\r\n  resetValidationState(): void {\r\n    this.validationState = \"registering\";\r\n  }\r\n}\r\n","import type { ContainerError } from \"../interfaces\";\r\nimport type { ContainerErrorCode } from \"../types/errors/containererrorcode\";\r\n\r\n/**\r\n * Concrete error class for container operations.\r\n *\r\n * Extends Error to ensure proper error behavior (stack traces, instanceof checks)\r\n * while implementing the ContainerError interface for type compatibility.\r\n *\r\n * **Design Rationale:**\r\n * - Follows Liskov Substitution Principle (LSP)\r\n * - Clients can rely on ContainerError contract being fulfilled\r\n * - Enables instanceof Error checks for compatibility\r\n * - Maintains all ContainerError fields for structured error handling\r\n *\r\n * @example\r\n * ```typescript\r\n * throw new ContainerErrorImpl({\r\n *   code: \"TokenNotRegistered\",\r\n *   message: \"Service not found\",\r\n *   tokenDescription: \"LoggerToken\"\r\n * });\r\n * ```\r\n */\r\nexport class ContainerErrorImpl extends Error implements ContainerError {\r\n  public readonly code: ContainerErrorCode;\r\n  public readonly cause?: unknown;\r\n  public readonly tokenDescription?: string;\r\n  public readonly details?: unknown;\r\n  public override readonly stack?: string;\r\n  public readonly timestamp?: number;\r\n  public readonly containerScope?: string;\r\n\r\n  constructor(error: ContainerError) {\r\n    super(error.message);\r\n    this.name = \"ContainerError\";\r\n    this.code = error.code;\r\n\r\n    // Handle optional properties correctly for exactOptionalPropertyTypes\r\n    // Only assign if defined (not undefined)\r\n    if (error.cause !== undefined) {\r\n      this.cause = error.cause;\r\n    }\r\n    if (error.tokenDescription !== undefined) {\r\n      this.tokenDescription = error.tokenDescription;\r\n    }\r\n    if (error.details !== undefined) {\r\n      this.details = error.details;\r\n    }\r\n    if (error.stack !== undefined) {\r\n      this.stack = error.stack;\r\n    }\r\n    if (error.timestamp !== undefined) {\r\n      this.timestamp = error.timestamp;\r\n    }\r\n    if (error.containerScope !== undefined) {\r\n      this.containerScope = error.containerScope;\r\n    }\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ContainerValidationState } from \"../types/errors/containervalidationstate\";\r\nimport type { ContainerError as DomainContainerError } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { ServiceResolver } from \"./ServiceResolver\";\r\nimport { err, isOk } from \"@/domain/utils/result\";\r\nimport { castResolvedService, castContainerErrorCode } from \"../types/utilities/runtime-safe-cast\";\r\nimport { ContainerErrorImpl } from \"../errors/ContainerErrorImpl\";\r\n\r\n/**\r\n * Manages service resolution operations.\r\n *\r\n * Responsibilities:\r\n * - Delegates resolution to ServiceResolver\r\n * - Validates disposal state before resolution\r\n * - Validates validation state before resolution\r\n * - Handles domain/infrastructure token type conversion\r\n *\r\n * Design:\r\n * - Pure delegation to ServiceResolver\r\n * - State checks (disposal, validation) are responsibility of this manager\r\n */\r\nexport class ServiceResolutionManager {\r\n  constructor(\r\n    private readonly resolver: ServiceResolver,\r\n    private readonly isDisposed: () => boolean,\r\n    private readonly getValidationState: () => ContainerValidationState\r\n  ) {}\r\n\r\n  /**\r\n   * Resolve service with Result return.\r\n   * Supports both infrastructure and domain tokens.\r\n   * PlatformContainerPort uses generic `symbol`, which is compatible with InjectionToken<T> (which extends symbol).\r\n   */\r\n  resolveWithError<T>(token: symbol): Result<T, DomainContainerError>;\r\n  resolveWithError<T>(token: InjectionToken<T>): Result<T, ContainerError>;\r\n  resolveWithError<T>(\r\n    token: InjectionToken<T> | symbol\r\n  ): Result<T, ContainerError> | Result<T, DomainContainerError> {\r\n    if (this.isDisposed()) {\r\n      const error: ContainerError = {\r\n        code: \"Disposed\",\r\n        message: `Cannot resolve from disposed container`,\r\n        tokenDescription: String(token),\r\n      };\r\n      const domainError: DomainContainerError = {\r\n        code: error.code,\r\n        message: error.message,\r\n        cause: error.cause,\r\n      };\r\n      return err(domainError);\r\n    }\r\n\r\n    if (this.getValidationState() !== \"validated\") {\r\n      const error: ContainerError = {\r\n        code: \"NotValidated\",\r\n        message: \"Container must be validated before resolving. Call validate() first.\",\r\n        tokenDescription: String(token),\r\n      };\r\n      const domainError: DomainContainerError = {\r\n        code: error.code,\r\n        message: error.message,\r\n        cause: error.cause,\r\n      };\r\n      return err(domainError);\r\n    }\r\n\r\n    const result = this.resolver.resolve(token as InjectionToken<T>);\r\n    if (!result.ok) {\r\n      // Convert ContainerError to DomainContainerError\r\n      const domainError: DomainContainerError = {\r\n        code: result.error.code,\r\n        message: result.error.message,\r\n        cause: result.error.cause,\r\n      };\r\n      return err(domainError);\r\n    }\r\n    return result as Result<T, ContainerError>;\r\n  }\r\n\r\n  /**\r\n   * Resolves a service instance (throws on failure).\r\n   * FOR EXTERNAL API USE ONLY - uses ApiSafeToken validation.\r\n   */\r\n  resolve<T>(token: InjectionToken<T>): T {\r\n    // Runtime validation is handled by ServiceContainer.resolve()\r\n    // This method is only called after runtime validation passes\r\n    const result = this.resolveWithError(token);\r\n\r\n    if (isOk(result)) {\r\n      return castResolvedService<T>(result.value);\r\n    }\r\n\r\n    // Convert DomainContainerError to ContainerError for throwing\r\n    const containerError: ContainerError = {\r\n      code: castContainerErrorCode(result.error.code),\r\n      message: `Cannot resolve ${String(token)}: ${result.error.message}`,\r\n      tokenDescription: String(token),\r\n      cause: result.error.cause,\r\n    };\r\n\r\n    // Throw ContainerError-compatible error (LSP compliance)\r\n    throw new ContainerErrorImpl(containerError);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { ContainerValidationState } from \"../types/errors/containervalidationstate\";\r\nimport { ScopeManager } from \"./ScopeManager\";\r\nimport { err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Facade for scope management operations.\r\n *\r\n * Responsibilities:\r\n * - Delegates scope creation to ScopeManager\r\n * - Validates disposal state before scope creation\r\n * - Validates validation state before scope creation\r\n *\r\n * Design:\r\n * - Pure delegation to ScopeManager for scope operations\r\n * - State checks (disposal, validation) are responsibility of this facade\r\n * - Child container creation is handled by ServiceContainer to avoid circular dependency\r\n */\r\nexport class ScopeManagementFacade {\r\n  constructor(\r\n    private readonly scopeManager: ScopeManager,\r\n    private readonly isDisposed: () => boolean,\r\n    private readonly getValidationState: () => ContainerValidationState\r\n  ) {}\r\n\r\n  /**\r\n   * Validates that a scope can be created.\r\n   * Returns the scope creation result if valid, or an error if not.\r\n   */\r\n  validateScopeCreation(\r\n    name?: string\r\n  ): Result<{ scopeName: string; cache: InstanceCache; manager: ScopeManager }, ContainerError> {\r\n    if (this.isDisposed()) {\r\n      return err({\r\n        code: \"Disposed\",\r\n        message: `Cannot create scope from disposed container`,\r\n      });\r\n    }\r\n\r\n    if (this.getValidationState() !== \"validated\") {\r\n      return err({\r\n        code: \"NotValidated\",\r\n        message: \"Parent must be validated before creating scopes. Call validate() first.\",\r\n      });\r\n    }\r\n\r\n    // Create child scope (pure Result, no throws)\r\n    return this.scopeManager.createChild(name);\r\n  }\r\n}\r\n\r\n// Import here to avoid circular dependency\r\nimport type { InstanceCache } from \"../cache/InstanceCache\";\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { ServiceResolver } from \"../resolution/ServiceResolver\";\r\nimport type { InstanceCache } from \"../cache/InstanceCache\";\r\nimport type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport { ok } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Manages metrics collector injection into resolver and cache.\r\n *\r\n * Responsibilities:\r\n * - Injects MetricsCollector into ServiceResolver after validation\r\n * - Injects MetricsCollector into InstanceCache after validation\r\n * - Resolves MetricsCollector from container\r\n *\r\n * Design:\r\n * - Called after successful validation\r\n * - Enables metrics recording without circular dependencies during bootstrap\r\n */\r\nexport class MetricsInjectionManager {\r\n  constructor(\r\n    private readonly resolver: ServiceResolver,\r\n    private readonly cache: InstanceCache,\r\n    private readonly resolveMetricsCollector: (\r\n      token: InjectionToken<MetricsCollector>\r\n    ) => Result<MetricsCollector, ContainerError>\r\n  ) {}\r\n\r\n  /**\r\n   * Injects MetricsCollector into resolver and cache after validation.\r\n   * This enables metrics recording without circular dependencies during bootstrap.\r\n   *\r\n   * Note: EnvironmentConfig is already injected via BootstrapPerformanceTracker\r\n   * during container creation, so only MetricsCollector needs to be injected here.\r\n   */\r\n  injectMetricsCollector(): Result<void, ContainerError> {\r\n    // This method is called after validation, so we can safely resolve\r\n    // The actual resolution is handled by the provided function\r\n    // We just need to call it and inject the result\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Internal method to perform the actual injection.\r\n   * Called by ServiceContainer after resolving the metrics collector.\r\n   */\r\n  performInjection(collector: MetricsCollector): void {\r\n    this.resolver.setMetricsCollector(collector);\r\n    this.cache.setMetricsCollector(collector);\r\n  }\r\n}\r\n","import type { InjectionToken } from \"../types/core/injectiontoken\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ContainerError } from \"../interfaces\";\r\nimport { isApiSafeTokenRuntime } from \"../types/utilities/api-safe-token\";\r\nimport { err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Manages API security validation for tokens.\r\n *\r\n * Responsibilities:\r\n * - Validates that tokens are API-safe before use in public API\r\n * - Enforces API boundary at runtime (defense-in-depth)\r\n *\r\n * Design:\r\n * - Runtime validation complements compile-time type checking\r\n * - Prevents misuse via type assertions or JavaScript consumers\r\n */\r\nexport class ApiSecurityManager {\r\n  /**\r\n   * Validates that a token is API-safe.\r\n   * Used by container.resolve() to enforce API boundary.\r\n   *\r\n   * @param token - The token to validate\r\n   * @returns Result indicating if token is API-safe\r\n   */\r\n  validateApiSafeToken<T>(token: InjectionToken<T>): Result<void, ContainerError> {\r\n    if (!isApiSafeTokenRuntime(token)) {\r\n      return err({\r\n        code: \"InvalidOperation\",\r\n        message:\r\n          `API Boundary Violation: resolve() called with non-API-safe token: ${String(token)}.\\n` +\r\n          `This token was not marked via markAsApiSafe().\\n` +\r\n          `\\n` +\r\n          `Internal code MUST use resolveWithError() instead:\\n` +\r\n          `  const result = container.resolveWithError(${String(token)});\\n` +\r\n          `  if (result.ok) { /* use result.value */ }\\n` +\r\n          `\\n` +\r\n          `Only the public ModuleApi should expose resolve() for external modules.`,\r\n        tokenDescription: String(token),\r\n      });\r\n    }\r\n\r\n    return { ok: true, value: undefined } as Result<void, ContainerError>;\r\n  }\r\n}\r\n","import type { InjectionToken } from \"./types/core/injectiontoken\";\r\nimport type { FactoryFunction } from \"./types/resolution/servicefactory\";\r\nimport type { ServiceClass } from \"./types/resolution/serviceclass\";\r\nimport type { ServiceDependencies } from \"./types/resolution/servicedependencies\";\r\nimport type { ContainerValidationState } from \"./types/errors/containervalidationstate\";\r\nimport type { ApiSafeToken } from \"./types/utilities/api-safe-token\";\r\nimport { isApiSafeTokenRuntime } from \"./types/utilities/api-safe-token\";\r\nimport { ServiceLifecycle } from \"./types/core/servicelifecycle\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { Container } from \"./interfaces\";\r\nimport type { ContainerError } from \"./interfaces\";\r\nimport type {\r\n  PlatformContainerPort,\r\n  ContainerError as DomainContainerError,\r\n} from \"@/domain/ports/platform-container-port.interface\";\r\nimport { castResolvedService, castContainerErrorCode } from \"./types/utilities/runtime-safe-cast\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { ServiceRegistry } from \"./registry/ServiceRegistry\";\r\nimport { ContainerValidator } from \"./validation/ContainerValidator\";\r\nimport { InstanceCache } from \"./cache/InstanceCache\";\r\nimport { ServiceResolver } from \"./resolution/ServiceResolver\";\r\nimport { ScopeManager } from \"./scope/ScopeManager\";\r\nimport { withTimeout, TimeoutError } from \"@/infrastructure/shared/utils/promise-timeout\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { BootstrapPerformanceTracker } from \"@/infrastructure/observability/bootstrap-performance-tracker\";\r\nimport { RuntimeConfigAdapter } from \"@/infrastructure/config/runtime-config-adapter\";\r\nimport type { PerformanceTracker } from \"@/infrastructure/observability/performance-tracker.interface\";\r\nimport { ServiceRegistrationManager } from \"./registration/ServiceRegistrationManager\";\r\nimport { ContainerValidationManager } from \"./validation/ContainerValidationManager\";\r\nimport { ServiceResolutionManager } from \"./resolution/ServiceResolutionManager\";\r\nimport { ScopeManagementFacade } from \"./scope/ScopeManagementFacade\";\r\nimport { MetricsInjectionManager } from \"./metrics/MetricsInjectionManager\";\r\nimport { ApiSecurityManager } from \"./security/ApiSecurityManager\";\r\nimport { ContainerErrorImpl } from \"./errors/ContainerErrorImpl\";\r\n\r\n/**\r\n * Dependency injection container (Facade pattern).\r\n *\r\n * Delegates to specialized manager components:\r\n * - ServiceRegistrationManager: manages service registrations\r\n * - ContainerValidationManager: manages validation and validation state\r\n * - ServiceResolutionManager: manages service resolution\r\n * - ScopeManagementFacade: manages scope creation\r\n * - MetricsInjectionManager: manages metrics collector injection\r\n * - ApiSecurityManager: manages API security validation\r\n *\r\n * **Scope Chain Behavior:**\r\n * When a parent container is disposed, all child containers are automatically disposed.\r\n * This ensures proper cleanup of resources across the container hierarchy.\r\n *\r\n * **Architecture:**\r\n * This is a Facade that coordinates specialized manager components, adhering to Single Responsibility Principle.\r\n * Each manager has a focused responsibility, making the system testable and maintainable.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Basic usage\r\n * const container = ServiceContainer.createRoot(ENV);\r\n * container.registerClass(LoggerToken, Logger, ServiceLifecycle.SINGLETON);\r\n * container.validate();\r\n * const logger = container.resolve(LoggerToken);\r\n * ```\r\n *\r\n * @example\r\n * ```typescript\r\n * // Scope chain with cascading disposal\r\n * const root = ServiceContainer.createRoot(ENV);\r\n * root.validate();\r\n * const child1 = root.createScope(\"child1\").value!;\r\n * const child2 = root.createScope(\"child2\").value!;\r\n *\r\n * // Disposing root automatically disposes all children\r\n * root.dispose();\r\n * ```\r\n */\r\nexport class ServiceContainer implements Container, PlatformContainerPort {\r\n  private registry: ServiceRegistry;\r\n  private validator: ContainerValidator;\r\n  private cache: InstanceCache;\r\n  private resolver: ServiceResolver;\r\n  private scopeManager: ScopeManager;\r\n  private readonly env: EnvironmentConfig;\r\n\r\n  // Manager components (SRP refactoring)\r\n  private registrationManager: ServiceRegistrationManager;\r\n  private validationManager: ContainerValidationManager;\r\n  private resolutionManager: ServiceResolutionManager;\r\n  private scopeFacade: ScopeManagementFacade;\r\n  private metricsInjectionManager: MetricsInjectionManager;\r\n  private apiSecurityManager: ApiSecurityManager;\r\n\r\n  /**\r\n   * Constructor for ServiceContainer.\r\n   *\r\n   * **Note:** This constructor is public to allow ContainerBootstrapFactory to create instances.\r\n   * External code should use ServiceContainer.createRoot() or ContainerBootstrapFactory.createRoot().\r\n   *\r\n   * @param registry - Service registry\r\n   * @param validator - Container validator (shared for parent/child)\r\n   * @param cache - Instance cache\r\n   * @param resolver - Service resolver\r\n   * @param scopeManager - Scope manager\r\n   * @param validationState - Initial validation state\r\n   * @param env - Environment configuration\r\n   */\r\n  constructor(\r\n    registry: ServiceRegistry,\r\n    validator: ContainerValidator,\r\n    cache: InstanceCache,\r\n    resolver: ServiceResolver,\r\n    scopeManager: ScopeManager,\r\n    validationState: ContainerValidationState,\r\n    env: EnvironmentConfig\r\n  ) {\r\n    this.registry = registry;\r\n    this.validator = validator;\r\n    this.cache = cache;\r\n    this.resolver = resolver;\r\n    this.scopeManager = scopeManager;\r\n    this.env = env;\r\n\r\n    // Initialize manager components\r\n    this.validationManager = new ContainerValidationManager(validator, registry, validationState);\r\n    this.registrationManager = new ServiceRegistrationManager(\r\n      registry,\r\n      () => this.scopeManager.isDisposed(),\r\n      () => this.validationManager.getValidationState()\r\n    );\r\n    this.resolutionManager = new ServiceResolutionManager(\r\n      resolver,\r\n      () => this.scopeManager.isDisposed(),\r\n      () => this.validationManager.getValidationState()\r\n    );\r\n    this.metricsInjectionManager = new MetricsInjectionManager(resolver, cache, (token) => {\r\n      const result = this.resolutionManager.resolveWithError(token);\r\n      // Convert DomainContainerError to ContainerError if needed\r\n      if (!result.ok) {\r\n        // DomainContainerError.code is string, but ContainerError.code is ContainerErrorCode\r\n        // Use castContainerErrorCode to safely convert\r\n        const containerError: ContainerError = {\r\n          code: castContainerErrorCode(result.error.code),\r\n          message: result.error.message,\r\n          cause: result.error.cause,\r\n          tokenDescription: String(token),\r\n        };\r\n        return err(containerError);\r\n      }\r\n      const metricsCollector = castResolvedService<MetricsCollector>(result.value);\r\n      return ok(metricsCollector);\r\n    });\r\n    this.apiSecurityManager = new ApiSecurityManager();\r\n    this.scopeFacade = new ScopeManagementFacade(\r\n      scopeManager,\r\n      () => this.scopeManager.isDisposed(),\r\n      () => this.validationManager.getValidationState()\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a new root container.\r\n   *\r\n   * **Note:** This method creates bootstrap dependencies (RuntimeConfig, PerformanceTracker) inline\r\n   * to avoid circular dependency with ContainerBootstrapFactory.\r\n   * The factory pattern is maintained via ContainerBootstrapFactory for external use (e.g., ContainerFactory).\r\n   *\r\n   * **Architecture:**\r\n   * Creates bootstrap dependencies directly (infrastructure -> infrastructure, no violation).\r\n   * This avoids circular dependency while maintaining the same functionality.\r\n   *\r\n   * @param env - Environment configuration\r\n   * @returns A new root ServiceContainer\r\n   */\r\n  static createRoot(env: EnvironmentConfig): ServiceContainer {\r\n    const registry = new ServiceRegistry();\r\n    const validator = new ContainerValidator();\r\n    const cache = new InstanceCache();\r\n    const scopeManager = new ScopeManager(\"root\", null, cache);\r\n\r\n    // Create bootstrap dependencies\r\n    const runtimeConfig = new RuntimeConfigAdapter(env);\r\n    const performanceTracker = new BootstrapPerformanceTracker(runtimeConfig, null);\r\n    const resolver = new ServiceResolver(registry, cache, null, \"root\", performanceTracker);\r\n\r\n    return new ServiceContainer(\r\n      registry,\r\n      validator,\r\n      cache,\r\n      resolver,\r\n      scopeManager,\r\n      \"registering\",\r\n      env\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Register a service class with automatic dependency injection.\r\n   */\r\n  registerClass<T>(\r\n    token: InjectionToken<T>,\r\n    serviceClass: ServiceClass<T>,\r\n    lifecycle: ServiceLifecycle\r\n  ): Result<void, ContainerError> {\r\n    return this.registrationManager.registerClass(token, serviceClass, lifecycle);\r\n  }\r\n\r\n  /**\r\n   * Register a factory function.\r\n   */\r\n  registerFactory<T>(\r\n    token: InjectionToken<T>,\r\n    factory: FactoryFunction<T>,\r\n    lifecycle: ServiceLifecycle,\r\n    dependencies: ServiceDependencies\r\n  ): Result<void, ContainerError> {\r\n    return this.registrationManager.registerFactory(token, factory, lifecycle, dependencies);\r\n  }\r\n\r\n  /**\r\n   * Register a constant value.\r\n   */\r\n  registerValue<T>(token: InjectionToken<T>, value: T): Result<void, ContainerError> {\r\n    return this.registrationManager.registerValue(token, value);\r\n  }\r\n\r\n  /**\r\n   * Register an already created instance.\r\n   * Internally treated the same as a value registration.\r\n   */\r\n  registerInstance<T>(token: InjectionToken<T>, instance: T): Result<void, ContainerError> {\r\n    return this.registerValue(token, instance);\r\n  }\r\n\r\n  /**\r\n   * Returns a previously registered constant value without requiring validation.\r\n   * Useful for bootstrap/static values that are needed while the container is still registering services.\r\n   */\r\n  getRegisteredValue<T>(token: InjectionToken<T>): T | null {\r\n    return this.registrationManager.getRegisteredValue(token);\r\n  }\r\n\r\n  /**\r\n   * Register an alias.\r\n   */\r\n  registerAlias<T>(\r\n    aliasToken: InjectionToken<T>,\r\n    targetToken: InjectionToken<T>\r\n  ): Result<void, ContainerError> {\r\n    return this.registrationManager.registerAlias(aliasToken, targetToken);\r\n  }\r\n\r\n  /**\r\n   * Validate all registrations.\r\n   */\r\n  validate(): Result<void, ContainerError[]> {\r\n    const result = this.validationManager.validate();\r\n\r\n    if (result.ok) {\r\n      // Inject MetricsCollector into resolver after validation (if available)\r\n      this.injectMetricsCollector();\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Injects MetricsCollector into resolver and cache after validation.\r\n   * This enables metrics recording without circular dependencies during bootstrap.\r\n   *\r\n   * Note: EnvironmentConfig is already injected via BootstrapPerformanceTracker\r\n   * during container creation, so only MetricsCollector needs to be injected here.\r\n   *\r\n   * Static import is safe here because:\r\n   * - tokenindex.ts only uses `import type { ServiceContainer }` (removed at runtime)\r\n   * - No circular runtime dependency exists\r\n   * - Container is already validated when this is called\r\n   */\r\n  private injectMetricsCollector(): void {\r\n    const metricsResult = this.resolutionManager.resolveWithError(metricsCollectorToken);\r\n    if (metricsResult.ok) {\r\n      const metricsCollector = castResolvedService<MetricsCollector>(metricsResult.value);\r\n      this.metricsInjectionManager.performInjection(metricsCollector);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get validation state.\r\n   * Implements both Container.getValidationState and PlatformContainerPort.getValidationState.\r\n   * Both interfaces use compatible types (ContainerValidationState is compatible with DomainContainerValidationState).\r\n   */\r\n  getValidationState(): ContainerValidationState {\r\n    return this.validationManager.getValidationState();\r\n  }\r\n\r\n  /**\r\n   * Async-safe validation for concurrent environments with timeout.\r\n   *\r\n   * Prevents race conditions when multiple callers validate simultaneously\r\n   * by ensuring only one validation runs at a time.\r\n   *\r\n   * @param timeoutMs - Timeout in milliseconds (default: 30000 = 30 seconds)\r\n   * @returns Promise resolving to validation result\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const container = ServiceContainer.createRoot(ENV);\r\n   * // ... register services\r\n   * await container.validateAsync(); // Safe for concurrent calls\r\n   * await container.validateAsync(5000); // With 5 second timeout\r\n   * ```\r\n   */\r\n  async validateAsync(timeoutMs: number = 30000): Promise<Result<void, ContainerError[]>> {\r\n    const result = await this.validationManager.validateAsync(timeoutMs, withTimeout, TimeoutError);\r\n\r\n    // Inject MetricsCollector if validation succeeded\r\n    if (result.ok) {\r\n      this.injectMetricsCollector();\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates a child scope container.\r\n   *\r\n   * Child containers:\r\n   * - Inherit parent registrations (cloned)\r\n   * - Can add their own registrations\r\n   * - Must call validate() before resolving\r\n   * - Share parent's singleton instances\r\n   * - Have isolated scoped instances\r\n   *\r\n   * @param name - Optional custom name for the scope\r\n   * @returns Result with child container or error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const parent = ServiceContainer.createRoot(ENV);\r\n   * parent.registerClass(LoggerToken, Logger, SINGLETON);\r\n   * parent.validate();\r\n   *\r\n   * const child = parent.createScope(\"request\").value!;\r\n   * child.registerClass(RequestToken, RequestContext, SCOPED);\r\n   * child.validate();\r\n   *\r\n   * const logger = child.resolve(LoggerToken);   // From parent (shared)\r\n   * const ctx = child.resolve(RequestToken);      // From child (isolated)\r\n   * ```\r\n   */\r\n  createScope(name?: string): Result<ServiceContainer, ContainerError> {\r\n    // Validate scope creation\r\n    const scopeResult = this.scopeFacade.validateScopeCreation(name);\r\n    if (!scopeResult.ok) {\r\n      return err(scopeResult.error);\r\n    }\r\n\r\n    // Build child container components\r\n    const childRegistry = this.registry.clone();\r\n    const childCache = scopeResult.value.cache;\r\n    const childManager = scopeResult.value.manager;\r\n\r\n    // Create bootstrap dependencies for child scope\r\n    // Delegate to helper method to maintain SRP (bootstrap logic separated)\r\n    const { resolver: childResolver } = this.createBootstrapDependencies(\r\n      childRegistry,\r\n      childCache,\r\n      this.resolver, // Parent resolver for singleton delegation\r\n      scopeResult.value.scopeName\r\n    );\r\n\r\n    // Create child using private constructor\r\n    // Child inherits ENV from parent\r\n    const child = new ServiceContainer(\r\n      childRegistry,\r\n      this.validator, // Shared (stateless)\r\n      childCache,\r\n      childResolver,\r\n      childManager,\r\n      \"registering\", // Child starts in registering state\r\n      this.env // Inherit ENV from parent\r\n    );\r\n\r\n    return ok(child);\r\n  }\r\n\r\n  /**\r\n   * Resolve service with Result return.\r\n   * Implements both Container.resolveWithError and PlatformContainerPort.resolveWithError.\r\n   * PlatformContainerPort uses generic `symbol`, which is compatible with InjectionToken<T> (which extends symbol).\r\n   */\r\n  resolveWithError<T>(token: symbol): Result<T, DomainContainerError>;\r\n  resolveWithError<T>(token: InjectionToken<T>): Result<T, ContainerError>;\r\n  resolveWithError<T>(\r\n    token: InjectionToken<T> | symbol\r\n  ): Result<T, ContainerError> | Result<T, DomainContainerError> {\r\n    return this.resolutionManager.resolveWithError(token as InjectionToken<T>);\r\n  }\r\n\r\n  /**\r\n   * Resolves a service instance (throws on failure).\r\n   *\r\n   * **🎯 FOR EXTERNAL API USE ONLY**\r\n   *\r\n   * This method is designed for the public ModuleApi to provide\r\n   * exception-based error handling for external Foundry VTT modules.\r\n   *\r\n   * **Enforcement (Defense-in-Depth):**\r\n   * - **Compile-Time:** Only accepts ApiSafeToken types\r\n   * - **Runtime:** Validates token has API_SAFE_RUNTIME_MARKER (always active)\r\n   *\r\n   * Internal code MUST use `resolveWithError()` for Result-based error handling.\r\n   *\r\n   * Implements both Container.resolve and PlatformContainerPort.resolve.\r\n   * PlatformContainerPort uses generic `symbol`, which is compatible with ApiSafeToken<T> (which extends symbol).\r\n   *\r\n   * @param token - An API-safe injection token (from api.tokens)\r\n   * @returns The resolved service instance\r\n   * @throws {Error} If token is not API-safe or resolution fails\r\n   *\r\n   * @example External Module Usage\r\n   * ```typescript\r\n   * const api = game.modules.get('fvtt_relationship_app_module').api;\r\n   *\r\n   * try {\r\n   *   const notifications = api.resolve(api.tokens.notificationCenterToken);\r\n   *   notifications.error(\"Success\", { code: \"API\", message: \"It works\" });\r\n   * } catch (error) {\r\n   *   console.error(\"Failed:\", error);\r\n   * }\r\n   * ```\r\n   *\r\n   * @example Internal Code (WRONG - Use resolveWithError)\r\n   * ```typescript\r\n   * // ❌ TypeScript Error + Runtime Error\r\n   * const notifications = container.resolve(notificationCenterToken);\r\n   *\r\n   * // ✅ CORRECT\r\n   * const result = container.resolveWithError(notificationCenterToken);\r\n   * if (result.ok) {\r\n   *   result.value.error(\"Success\", { code: \"API\", message: \"It works\" });\r\n   * }\r\n   * ```\r\n   */\r\n  resolve<T>(token: symbol): T;\r\n  resolve<T>(token: ApiSafeToken<T>): T;\r\n\r\n  /**\r\n   * @internal This overload prevents direct calls with non-branded tokens.\r\n   * Internal code should use resolveWithError() for Result-based error handling.\r\n   * This method is designed for Public API use (via ModuleApi) where exception-based\r\n   * error handling is expected by external developers.\r\n   */\r\n  resolve<T>(token: InjectionToken<T>): never;\r\n\r\n  // Implementation (unified for both overloads)\r\n  resolve<T>(token: InjectionToken<T> | ApiSafeToken<T> | symbol): T {\r\n    // 🛡️ RUNTIME GUARD (always active for defense-in-depth)\r\n    const securityResult = this.apiSecurityManager.validateApiSafeToken(token);\r\n    if (!securityResult.ok) {\r\n      // Throw ContainerError-compatible error (LSP compliance)\r\n      throw new ContainerErrorImpl(securityResult.error);\r\n    }\r\n\r\n    // Standard resolution via Result pattern\r\n    return this.resolutionManager.resolve(token);\r\n  }\r\n\r\n  /**\r\n   * Check if service is registered.\r\n   * Implements both Container.isRegistered and PlatformContainerPort.isRegistered.\r\n   * PlatformContainerPort uses generic `symbol`, which is compatible with InjectionToken<T> (which extends symbol).\r\n   */\r\n  isRegistered(token: symbol): Result<boolean, never>;\r\n  isRegistered<T>(token: InjectionToken<T>): Result<boolean, never>;\r\n  isRegistered<T>(token: InjectionToken<T> | symbol): Result<boolean, never> {\r\n    return ok(this.registrationManager.isRegistered(token as InjectionToken<T>));\r\n  }\r\n\r\n  /**\r\n   * Returns API-safe token metadata for external consumption.\r\n   */\r\n  getApiSafeToken<T>(\r\n    token: ApiSafeToken<T>\r\n  ): { description: string; isRegistered: boolean } | null {\r\n    if (!isApiSafeTokenRuntime(token)) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      description: String(token),\r\n      isRegistered: this.registrationManager.isRegistered(token),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Synchronously dispose container and all children.\r\n   *\r\n   * Use this for scenarios where async disposal is not possible (e.g., browser unload).\r\n   * For normal cleanup, prefer disposeAsync() which handles async disposal properly.\r\n   *\r\n   * @returns Result indicating success or disposal error\r\n   */\r\n  dispose(): Result<void, ContainerError> {\r\n    const result = this.scopeManager.dispose();\r\n\r\n    // Reset validation state after disposal (per review feedback)\r\n    if (result.ok) {\r\n      this.validationManager.resetValidationState();\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Asynchronously dispose container and all children.\r\n   *\r\n   * This is the preferred disposal method as it properly handles services that\r\n   * implement AsyncDisposable, allowing for proper cleanup of resources like\r\n   * database connections, file handles, or network sockets.\r\n   *\r\n   * Falls back to synchronous disposal for services implementing only Disposable.\r\n   *\r\n   * @returns Promise with Result indicating success or disposal error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // Preferred: async disposal\r\n   * const result = await container.disposeAsync();\r\n   * if (result.ok) {\r\n   *   console.log(\"Container disposed successfully\");\r\n   * }\r\n   *\r\n   * // Browser unload (sync required)\r\n   * window.addEventListener('beforeunload', () => {\r\n   *   container.dispose();  // Sync fallback\r\n   * });\r\n   * ```\r\n   */\r\n  async disposeAsync(): Promise<Result<void, ContainerError>> {\r\n    const result = await this.scopeManager.disposeAsync();\r\n\r\n    // Reset validation state after disposal (per review feedback)\r\n    if (result.ok) {\r\n      this.validationManager.resetValidationState();\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Clear all registrations and instances.\r\n   *\r\n   * IMPORTANT: Resets validation state (per review feedback).\r\n   */\r\n  clear(): Result<void, never> {\r\n    this.registry.clear();\r\n    this.cache.clear();\r\n    this.validationManager.resetValidationState(); // Critical: reset validation state\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Creates bootstrap dependencies for a scope (RuntimeConfig, PerformanceTracker, Resolver).\r\n   *\r\n   * **Responsibility:** Bootstrap dependency creation (extracted from createScope for SRP).\r\n   * This method encapsulates the creation of bootstrap-specific components to separate\r\n   * concerns from container logic.\r\n   *\r\n   * @private\r\n   * @param registry - Service registry for the scope\r\n   * @param cache - Instance cache for the scope\r\n   * @param parentResolver - Parent resolver for singleton delegation\r\n   * @param scopeName - Name of the scope\r\n   * @returns Object with resolver and performance tracker\r\n   */\r\n  /**\r\n   * Creates bootstrap dependencies for a scope (RuntimeConfig, PerformanceTracker, Resolver).\r\n   *\r\n   * **Responsibility:** Bootstrap dependency creation (extracted from createScope for SRP).\r\n   * This method encapsulates the creation of bootstrap-specific components to separate\r\n   * concerns from container logic.\r\n   *\r\n   * @private\r\n   * @param registry - Service registry for the scope\r\n   * @param cache - Instance cache for the scope\r\n   * @param parentResolver - Parent resolver for singleton delegation\r\n   * @param scopeName - Name of the scope\r\n   * @returns Object with resolver and performance tracker\r\n   */\r\n  private createBootstrapDependencies(\r\n    registry: ServiceRegistry,\r\n    cache: InstanceCache,\r\n    parentResolver: ServiceResolver | null,\r\n    scopeName: string\r\n  ): { resolver: ServiceResolver; performanceTracker: PerformanceTracker } {\r\n    // Create bootstrap dependencies\r\n    const runtimeConfig = new RuntimeConfigAdapter(this.env);\r\n    const performanceTracker = new BootstrapPerformanceTracker(runtimeConfig, null);\r\n    const resolver = new ServiceResolver(\r\n      registry,\r\n      cache,\r\n      parentResolver,\r\n      scopeName,\r\n      performanceTracker\r\n    );\r\n\r\n    return { resolver, performanceTracker };\r\n  }\r\n}\r\n","import type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { ServiceContainer as ServiceContainerImpl } from \"@/infrastructure/di/container\";\r\nimport { ServiceRegistry } from \"@/infrastructure/di/registry/ServiceRegistry\";\r\nimport { ContainerValidator } from \"@/infrastructure/di/validation/ContainerValidator\";\r\nimport { InstanceCache } from \"@/infrastructure/di/cache/InstanceCache\";\r\nimport { ServiceResolver } from \"@/infrastructure/di/resolution/ServiceResolver\";\r\nimport { ScopeManager } from \"@/infrastructure/di/scope/ScopeManager\";\r\nimport { BootstrapPerformanceTracker } from \"@/infrastructure/observability/bootstrap-performance-tracker\";\r\nimport { RuntimeConfigAdapter } from \"@/infrastructure/config/runtime-config-adapter\";\r\n\r\n/**\r\n * Factory for creating ServiceContainer instances with bootstrap dependencies.\r\n *\r\n * **Responsibility:** Bootstrap orchestration (SRP).\r\n * Encapsulates the creation of bootstrap-specific components:\r\n * - RuntimeConfig creation\r\n * - BootstrapPerformanceTracker creation\r\n * - ServiceResolver with performance tracking\r\n * - ServiceContainer assembly\r\n *\r\n * **Design Rationale:**\r\n * Separates bootstrap concerns from container logic, following Single Responsibility Principle.\r\n * ServiceContainer is now a pure DI container without bootstrap/observability knowledge.\r\n *\r\n * **Architecture:**\r\n * Located in infrastructure layer (can import from infrastructure, application, domain).\r\n * This factory creates infrastructure components and is used by both:\r\n * - ServiceContainer.createRoot() (infrastructure -> infrastructure, no violation)\r\n * - ContainerFactory (framework -> infrastructure, allowed)\r\n *\r\n * @example\r\n * ```typescript\r\n * const factory = new ContainerBootstrapFactory();\r\n * const container = factory.createRoot(ENV);\r\n * ```\r\n */\r\nexport class ContainerBootstrapFactory {\r\n  /**\r\n   * Creates a root ServiceContainer with bootstrap dependencies.\r\n   *\r\n   * Creates and wires:\r\n   * - RuntimeConfig from environment\r\n   * - BootstrapPerformanceTracker (no MetricsCollector during bootstrap)\r\n   * - ServiceResolver with performance tracking\r\n   * - ServiceContainer with all dependencies\r\n   *\r\n   * @param env - Environment configuration\r\n   * @returns A new root ServiceContainer\r\n   */\r\n  createRoot(env: EnvironmentConfig): ServiceContainer {\r\n    const registry = new ServiceRegistry();\r\n    const validator = new ContainerValidator();\r\n    const cache = new InstanceCache();\r\n    const scopeManager = new ScopeManager(\"root\", null, cache);\r\n\r\n    // Create bootstrap dependencies\r\n    const runtimeConfig = new RuntimeConfigAdapter(env);\r\n    const performanceTracker = new BootstrapPerformanceTracker(runtimeConfig, null);\r\n    const resolver = new ServiceResolver(registry, cache, null, \"root\", performanceTracker);\r\n\r\n    return new ServiceContainerImpl(\r\n      registry,\r\n      validator,\r\n      cache,\r\n      resolver,\r\n      scopeManager,\r\n      \"registering\",\r\n      env\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Creates a child scope container with bootstrap dependencies.\r\n   *\r\n   * Creates and wires:\r\n   * - RuntimeConfig from parent's environment\r\n   * - BootstrapPerformanceTracker for child scope\r\n   * - ServiceResolver with performance tracking\r\n   * - Child ServiceContainer with all dependencies\r\n   *\r\n   * @param parent - Parent container\r\n   * @param name - Optional custom name for the scope\r\n   * @returns Result with child container or error\r\n   */\r\n  createScope(\r\n    parent: ServiceContainer,\r\n    name?: string\r\n  ): ReturnType<ServiceContainer[\"createScope\"]> {\r\n    // Use internal createScope method (will be refactored to use this factory)\r\n    return parent.createScope(name);\r\n  }\r\n}\r\n","import type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { ContainerBootstrapFactory } from \"@/infrastructure/di/factory/ContainerBootstrapFactory\";\r\n\r\n/**\r\n * Interface for container factory.\r\n * Responsible for creating ServiceContainer instances.\r\n */\r\nexport interface IContainerFactory {\r\n  /**\r\n   * Creates a root ServiceContainer with the given environment configuration.\r\n   *\r\n   * @param env - Environment configuration\r\n   * @returns A new ServiceContainer instance\r\n   */\r\n  createRoot(env: EnvironmentConfig): ServiceContainer;\r\n}\r\n\r\n/**\r\n * Factory for creating ServiceContainer instances.\r\n *\r\n * **Responsibility:** Only container creation coordination.\r\n * Delegates to ContainerBootstrapFactory for bootstrap dependency creation (SRP).\r\n *\r\n * **Design:**\r\n * This factory acts as a thin wrapper around ContainerBootstrapFactory,\r\n * maintaining the IContainerFactory interface while delegating bootstrap concerns.\r\n *\r\n * @example\r\n * ```typescript\r\n * const factory = new ContainerFactory();\r\n * const container = factory.createRoot(ENV);\r\n * ```\r\n */\r\nexport class ContainerFactory implements IContainerFactory {\r\n  private readonly bootstrapFactory: ContainerBootstrapFactory;\r\n\r\n  /**\r\n   * Creates a new ContainerFactory instance.\r\n   *\r\n   * @param bootstrapFactory - Optional bootstrap factory (defaults to new instance)\r\n   */\r\n  constructor(bootstrapFactory?: ContainerBootstrapFactory) {\r\n    this.bootstrapFactory = bootstrapFactory ?? new ContainerBootstrapFactory();\r\n  }\r\n\r\n  /**\r\n   * Creates a root ServiceContainer with the given environment configuration.\r\n   *\r\n   * Delegates to ContainerBootstrapFactory to maintain SRP (bootstrap logic separated).\r\n   *\r\n   * @param env - Environment configuration\r\n   * @returns A new ServiceContainer instance\r\n   */\r\n  createRoot(env: EnvironmentConfig): ServiceContainer {\r\n    return this.bootstrapFactory.createRoot(env);\r\n  }\r\n}\r\n","/**\r\n * Injection token for the EnvironmentConfig.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\n\r\n/**\r\n * Injection token for the EnvironmentConfig.\r\n *\r\n * Provides access to environment configuration (development/production mode,\r\n * log levels, performance tracking settings, etc.).\r\n *\r\n * Injecting ENV as a service improves testability and follows DIP\r\n * (Dependency Inversion Principle) by depending on abstraction rather than\r\n * concrete global state.\r\n *\r\n * @example\r\n * ```typescript\r\n * export class MyService {\r\n *   static dependencies = [environmentConfigToken] as const;\r\n *\r\n *   constructor(private readonly env: EnvironmentConfig) {}\r\n *\r\n *   doSomething() {\r\n *     if (this.env.isDevelopment) {\r\n *       // Development-specific logic\r\n *     }\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const environmentConfigToken = createInjectionToken<EnvironmentConfig>(\"EnvironmentConfig\");\r\n","/**\r\n * Injection token for the ContainerHealthCheck.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ContainerHealthCheck } from \"@/application/health/ContainerHealthCheck\";\r\n\r\n/**\r\n * Injection token for the ContainerHealthCheck.\r\n *\r\n * Health check that validates the DI container state.\r\n *\r\n * @example\r\n * ```typescript\r\n * const check = container.resolve(containerHealthCheckToken);\r\n * const isHealthy = check.check(); // Returns true if container is validated\r\n * ```\r\n */\r\nexport const containerHealthCheckToken =\r\n  createInjectionToken<ContainerHealthCheck>(\"ContainerHealthCheck\");\r\n","/**\r\n * Injection token for the MetricsHealthCheck.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { HealthCheck } from \"@/application/health/health-check.interface\";\r\n\r\n/**\r\n * Injection token for the MetricsHealthCheck.\r\n *\r\n * Health check that validates metrics and port selection status.\r\n *\r\n * @example\r\n * ```typescript\r\n * const check = container.resolve(metricsHealthCheckToken);\r\n * const isHealthy = check.check(); // Returns true if no port failures\r\n * ```\r\n */\r\nexport const metricsHealthCheckToken = createInjectionToken<HealthCheck>(\"MetricsHealthCheck\");\r\n","import { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformHealthCheckPort } from \"@/domain/ports/platform-health-check-port.interface\";\r\n\r\n/**\r\n * DI Token for PlatformHealthCheckPort.\r\n *\r\n * Central registry for health checks that can be dynamically registered.\r\n */\r\nexport const healthCheckRegistryToken =\r\n  createInjectionToken<PlatformHealthCheckPort>(\"PlatformHealthCheckPort\");\r\n","/**\r\n * Injection token for accessing the ServiceContainer itself.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\n\r\n/**\r\n * Injection token for accessing the ServiceContainer itself.\r\n *\r\n * Primarily used for infrastructure services (e.g., health checks) that need\r\n * direct insight into the container state.\r\n */\r\nexport const serviceContainerToken = createInjectionToken<ServiceContainer>(\"ServiceContainer\");\r\n","import { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\n\r\n/**\r\n * DI Token for PlatformRuntimeConfigPort.\r\n *\r\n * Provides access to the merged configuration layer that combines build-time\r\n * environment defaults with runtime platform settings.\r\n */\r\nexport const runtimeConfigToken = createInjectionToken<PlatformRuntimeConfigPort>(\r\n  \"PlatformRuntimeConfigPort\"\r\n);\r\n","/**\r\n * Domain Port Tokens for Dependency Injection.\r\n *\r\n * These tokens define injection points for domain port interfaces,\r\n * keeping the Application layer decoupled from Infrastructure-specific implementations.\r\n */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformNotificationPort } from \"@/domain/ports/platform-notification-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { NotificationChannelRegistryPort } from \"@/domain/ports/notifications/notification-channel-registry-port.interface\";\r\nimport type { CacheReaderPort } from \"@/domain/ports/cache/cache-reader-port.interface\";\r\nimport type { CacheWriterPort } from \"@/domain/ports/cache/cache-writer-port.interface\";\r\nimport type { CacheInvalidationPort } from \"@/domain/ports/cache/cache-invalidation-port.interface\";\r\nimport type { CacheStatsPort } from \"@/domain/ports/cache/cache-stats-port.interface\";\r\nimport type { CacheComputePort } from \"@/domain/ports/cache/cache-compute-port.interface\";\r\nimport type { PlatformI18nPort } from \"@/domain/ports/platform-i18n-port.interface\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { PlatformJournalDirectoryUiPort } from \"@/domain/ports/platform-journal-directory-ui-port.interface\";\r\nimport type { PlatformUINotificationPort } from \"@/domain/ports/platform-ui-notification-port.interface\";\r\nimport type { PlatformSettingsPort } from \"@/domain/ports/platform-settings-port.interface\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { PlatformJournalUiEventPort } from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type { PlatformJournalCollectionPort } from \"@/domain/ports/collections/platform-journal-collection-port.interface\";\r\nimport type { PlatformJournalRepository } from \"@/domain/ports/repositories/platform-journal-repository.interface\";\r\nimport type { PlatformContextMenuRegistrationPort } from \"@/domain/ports/platform-context-menu-registration-port.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport type { PlatformMetricsSnapshotPort } from \"@/domain/ports/platform-metrics-snapshot-port.interface\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { PlatformSettingsRegistrationPort } from \"@/domain/ports/platform-settings-registration-port.interface\";\r\nimport type { PlatformModuleReadyPort } from \"@/domain/ports/platform-module-ready-port.interface\";\r\nimport type { PlatformChannelPort } from \"@/domain/ports/notifications/platform-channel-port.interface\";\r\nimport type { PlatformUINotificationChannelPort } from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\nimport type { PlatformConsoleChannelPort } from \"@/domain/ports/notifications/platform-console-channel-port.interface\";\r\nimport type { PlatformUIAvailabilityPort } from \"@/domain/ports/platform-ui-availability-port.interface\";\r\n\r\n/**\r\n * DI Token for PlatformNotificationPort.\r\n *\r\n * Platform-agnostic notification port (combines NotificationPublisherPort and NotificationChannelRegistryPort).\r\n * Use this when you need both notification publishing and channel management.\r\n *\r\n * For notification publishing only, use notificationPublisherPortToken.\r\n * For channel management only, use notificationChannelRegistryPortToken.\r\n */\r\nexport const platformNotificationPortToken = createInjectionToken<PlatformNotificationPort>(\r\n  \"PlatformNotificationPort\"\r\n);\r\n\r\n/**\r\n * DI Token for NotificationPublisherPort.\r\n *\r\n * Platform-agnostic port for publishing notifications (debug, info, warn, error).\r\n * Use this when you only need to send notifications and don't need channel management.\r\n *\r\n * Follows Interface Segregation Principle (ISP) by providing only notification publishing methods.\r\n */\r\nexport const notificationPublisherPortToken = createInjectionToken<NotificationPublisherPort>(\r\n  \"NotificationPublisherPort\"\r\n);\r\n\r\n/**\r\n * DI Token for NotificationChannelRegistryPort.\r\n *\r\n * Platform-agnostic port for managing notification channels (addChannel, removeChannel, getChannelNames).\r\n * Use this when you only need to manage channels and don't need to send notifications.\r\n *\r\n * Follows Interface Segregation Principle (ISP) by providing only channel management methods.\r\n */\r\nexport const notificationChannelRegistryPortToken =\r\n  createInjectionToken<NotificationChannelRegistryPort>(\"NotificationChannelRegistryPort\");\r\n\r\n/**\r\n * DI Token for CacheReaderPort.\r\n *\r\n * Platform-agnostic cache read operations port.\r\n * Use this when you only need to read from cache (get, has, getMetadata).\r\n */\r\nexport const cacheReaderPortToken = createInjectionToken<CacheReaderPort>(\"CacheReaderPort\");\r\n\r\n/**\r\n * DI Token for CacheWriterPort.\r\n *\r\n * Platform-agnostic cache write operations port.\r\n * Use this when you only need to write to cache (set, delete, clear).\r\n */\r\nexport const cacheWriterPortToken = createInjectionToken<CacheWriterPort>(\"CacheWriterPort\");\r\n\r\n/**\r\n * DI Token for CacheInvalidationPort.\r\n *\r\n * Platform-agnostic cache invalidation port.\r\n * Use this when you only need to invalidate cache entries (invalidateWhere).\r\n */\r\nexport const cacheInvalidationPortToken =\r\n  createInjectionToken<CacheInvalidationPort>(\"CacheInvalidationPort\");\r\n\r\n/**\r\n * DI Token for CacheStatsPort.\r\n *\r\n * Platform-agnostic cache statistics port.\r\n * Use this when you only need cache statistics (getStatistics, size, isEnabled).\r\n */\r\nexport const cacheStatsPortToken = createInjectionToken<CacheStatsPort>(\"CacheStatsPort\");\r\n\r\n/**\r\n * DI Token for CacheComputePort.\r\n *\r\n * Platform-agnostic cache compute port.\r\n * Use this when you only need the get-or-set pattern (getOrSet).\r\n */\r\nexport const cacheComputePortToken = createInjectionToken<CacheComputePort>(\"CacheComputePort\");\r\n\r\n/**\r\n * DI Token for PlatformI18nPort.\r\n *\r\n * Platform-agnostic i18n port.\r\n */\r\nexport const platformI18nPortToken = createInjectionToken<PlatformI18nPort>(\"PlatformI18nPort\");\r\n\r\n/**\r\n * DI Token for PlatformUIPort.\r\n *\r\n * Platform-agnostic UI operations port (convenience interface combining PlatformJournalDirectoryUiPort and PlatformUINotificationPort).\r\n * Use specific ports (platformJournalDirectoryUiPortToken, platformUINotificationPortToken) when only one capability is needed.\r\n */\r\nexport const platformUIPortToken = createInjectionToken<PlatformUIPort>(\"PlatformUIPort\");\r\n\r\n/**\r\n * DI Token for PlatformJournalDirectoryUiPort.\r\n *\r\n * Platform-agnostic port for journal directory DOM operations.\r\n * Use this when only DOM manipulation is needed, not notifications.\r\n */\r\nexport const platformJournalDirectoryUiPortToken =\r\n  createInjectionToken<PlatformJournalDirectoryUiPort>(\"PlatformJournalDirectoryUiPort\");\r\n\r\n/**\r\n * DI Token for PlatformUINotificationPort.\r\n *\r\n * Platform-agnostic port for user notifications.\r\n * Use this when only notifications are needed, not DOM manipulation.\r\n */\r\nexport const platformUINotificationPortToken = createInjectionToken<PlatformUINotificationPort>(\r\n  \"PlatformUINotificationPort\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformSettingsPort.\r\n *\r\n * Platform-agnostic settings port.\r\n */\r\nexport const platformSettingsPortToken =\r\n  createInjectionToken<PlatformSettingsPort>(\"PlatformSettingsPort\");\r\n\r\n/**\r\n * DI Token for PlatformJournalEventPort.\r\n *\r\n * Platform-agnostic journal lifecycle event port (created, updated, deleted).\r\n * For UI-specific events (directory render, context menu), use platformJournalUiEventPortToken.\r\n */\r\nexport const platformJournalEventPortToken = createInjectionToken<PlatformJournalEventPort>(\r\n  \"PlatformJournalEventPort\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformJournalUiEventPort.\r\n *\r\n * Platform-agnostic journal UI event port (directory render, context menu).\r\n * Separated from PlatformJournalEventPort to maintain DIP compliance (no DOM types in domain).\r\n */\r\nexport const platformJournalUiEventPortToken = createInjectionToken<PlatformJournalUiEventPort>(\r\n  \"PlatformJournalUiEventPort\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformJournalCollectionPort.\r\n *\r\n * Provides read-only access to journal entry collections.\r\n */\r\nexport const platformJournalCollectionPortToken =\r\n  createInjectionToken<PlatformJournalCollectionPort>(\"PlatformJournalCollectionPort\");\r\n\r\n/**\r\n * DI Token for PlatformJournalRepository.\r\n *\r\n * Provides full CRUD access to journal entries with batch operations and flag management.\r\n */\r\nexport const platformJournalRepositoryToken = createInjectionToken<PlatformJournalRepository>(\r\n  \"PlatformJournalRepository\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformContextMenuRegistrationPort.\r\n *\r\n * Platform-agnostic port for registering context menu callbacks.\r\n */\r\nexport const platformContextMenuRegistrationPortToken =\r\n  createInjectionToken<PlatformContextMenuRegistrationPort>(\"PlatformContextMenuRegistrationPort\");\r\n\r\n/**\r\n * DI Token for PlatformValidationPort.\r\n *\r\n * Platform-agnostic validation port.\r\n */\r\nexport const platformValidationPortToken =\r\n  createInjectionToken<PlatformValidationPort>(\"PlatformValidationPort\");\r\n\r\n/**\r\n * DI Token for PlatformLoggingPort.\r\n *\r\n * Platform-agnostic logging port.\r\n */\r\nexport const platformLoggingPortToken =\r\n  createInjectionToken<PlatformLoggingPort>(\"PlatformLoggingPort\");\r\n\r\n/**\r\n * DI Token for PlatformMetricsSnapshotPort.\r\n *\r\n * Platform-agnostic metrics snapshot port.\r\n */\r\nexport const platformMetricsSnapshotPortToken = createInjectionToken<PlatformMetricsSnapshotPort>(\r\n  \"PlatformMetricsSnapshotPort\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformContainerPort.\r\n *\r\n * Platform-agnostic container port for service resolution and validation state.\r\n */\r\nexport const platformContainerPortToken =\r\n  createInjectionToken<PlatformContainerPort>(\"PlatformContainerPort\");\r\n\r\n/**\r\n * DI Token for PlatformSettingsRegistrationPort.\r\n *\r\n * Domain-neutral settings port that doesn't expose Valibot schemas.\r\n * Uses validator functions instead of schemas for type safety.\r\n *\r\n * This port is preferred over PlatformSettingsPort when the caller\r\n * doesn't need Valibot schema validation (e.g., in application layer).\r\n */\r\nexport const platformSettingsRegistrationPortToken =\r\n  createInjectionToken<PlatformSettingsRegistrationPort>(\"PlatformSettingsRegistrationPort\");\r\n\r\n/**\r\n * DI Token for PlatformModuleReadyPort.\r\n *\r\n * Platform-agnostic port for managing module ready state.\r\n * Used to set module.ready = true when bootstrap is complete.\r\n */\r\nexport const platformModuleReadyPortToken =\r\n  createInjectionToken<PlatformModuleReadyPort>(\"PlatformModuleReadyPort\");\r\n\r\n/**\r\n * DI Token for PlatformChannelPort.\r\n *\r\n * Platform-agnostic port for notification channels.\r\n * Base interface for all channel types.\r\n */\r\nexport const platformChannelPortToken =\r\n  createInjectionToken<PlatformChannelPort>(\"PlatformChannelPort\");\r\n\r\n/**\r\n * DI Token for PlatformUINotificationChannelPort.\r\n *\r\n * Platform-agnostic port for UI notification channels.\r\n * Specialized channel port for user interface notifications.\r\n */\r\nexport const platformUINotificationChannelPortToken =\r\n  createInjectionToken<PlatformUINotificationChannelPort>(\"PlatformUINotificationChannelPort\");\r\n\r\n/**\r\n * DI Token for PlatformConsoleChannelPort.\r\n *\r\n * Platform-agnostic port for console logging channels.\r\n * Specialized channel port for console output.\r\n */\r\nexport const platformConsoleChannelPortToken = createInjectionToken<PlatformConsoleChannelPort>(\r\n  \"PlatformConsoleChannelPort\"\r\n);\r\n\r\n/**\r\n * DI Token for PlatformUIAvailabilityPort.\r\n *\r\n * Platform-agnostic port for checking UI availability.\r\n */\r\nexport const platformUIAvailabilityPortToken = createInjectionToken<PlatformUIAvailabilityPort>(\r\n  \"PlatformUIAvailabilityPort\"\r\n);\r\n","import type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { HealthCheck } from \"@/domain/types/health-check\";\r\nimport type { PlatformHealthCheckPort } from \"@/domain/ports/platform-health-check-port.interface\";\r\nimport { healthCheckRegistryToken } from \"@/application/tokens/health-check-registry.token\";\r\nimport { platformContainerPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Health check validating that the service container completed its bootstrap phase.\r\n */\r\nexport class ContainerHealthCheck implements HealthCheck {\r\n  readonly name = \"container\";\r\n  private readonly container: PlatformContainerPort;\r\n\r\n  constructor(container: PlatformContainerPort) {\r\n    this.container = container;\r\n  }\r\n\r\n  check(): boolean {\r\n    return this.container.getValidationState() === \"validated\";\r\n  }\r\n\r\n  getDetails(): string | null {\r\n    const state = this.container.getValidationState();\r\n    if (state !== \"validated\") {\r\n      return `Container state: ${state}`;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  dispose(): void {\r\n    // Nothing to clean up – the container owns its own lifecycle.\r\n  }\r\n}\r\n\r\nexport class DIContainerHealthCheck extends ContainerHealthCheck {\r\n  static dependencies = [platformContainerPortToken, healthCheckRegistryToken] as const;\r\n\r\n  constructor(container: PlatformContainerPort, registry: PlatformHealthCheckPort) {\r\n    super(container);\r\n    registry.register(this);\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function that returns the DIContainerHealthCheck class reference.\r\n *\r\n * Centralizes access to the DIContainerHealthCheck class to follow the Dependency Inversion Principle (DIP).\r\n * This allows the Framework layer to register the class without directly importing it,\r\n * improving testability and reducing coupling.\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { getDIContainerHealthCheckClass } from \"@/application/health/ContainerHealthCheck\";\r\n *\r\n * const healthCheckClass = getDIContainerHealthCheckClass();\r\n * container.registerClass(token, healthCheckClass, lifecycle);\r\n * ```\r\n *\r\n * @returns The DIContainerHealthCheck class constructor\r\n */\r\nexport function getDIContainerHealthCheckClass(): typeof DIContainerHealthCheck {\r\n  return DIContainerHealthCheck;\r\n}\r\n","import type { PlatformMetricsSnapshotPort } from \"@/domain/ports/platform-metrics-snapshot-port.interface\";\r\nimport { platformMetricsSnapshotPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { healthCheckRegistryToken } from \"@/application/tokens/health-check-registry.token\";\r\nimport type { HealthCheck } from \"@/domain/types/health-check\";\r\nimport type { PlatformHealthCheckPort } from \"@/domain/ports/platform-health-check-port.interface\";\r\n\r\n/**\r\n * Health check that surfaces critical issues from the metrics collector\r\n * (port selection failures and container resolution errors).\r\n */\r\nexport class MetricsHealthCheck implements HealthCheck {\r\n  readonly name = \"metrics\";\r\n  private readonly metricsSnapshotPort: PlatformMetricsSnapshotPort;\r\n\r\n  constructor(metricsSnapshotPort: PlatformMetricsSnapshotPort) {\r\n    this.metricsSnapshotPort = metricsSnapshotPort;\r\n  }\r\n\r\n  check(): boolean {\r\n    const snapshot = this.metricsSnapshotPort.getSnapshot();\r\n    const hasPortFailures = Object.keys(snapshot.portSelectionFailures).length > 0;\r\n    const hasResolutionErrors = snapshot.resolutionErrors > 0;\r\n    return !hasPortFailures && !hasResolutionErrors;\r\n  }\r\n\r\n  getDetails(): string | null {\r\n    const snapshot = this.metricsSnapshotPort.getSnapshot();\r\n    const failures = Object.keys(snapshot.portSelectionFailures);\r\n\r\n    if (failures.length > 0) {\r\n      return `Port selection failures: ${failures.join(\", \")}`;\r\n    }\r\n\r\n    if (snapshot.resolutionErrors > 0) {\r\n      return `Resolution errors: ${snapshot.resolutionErrors}`;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  dispose(): void {\r\n    // No resources to dispose – collector lives for the entire runtime.\r\n  }\r\n}\r\n\r\nexport class DIMetricsHealthCheck extends MetricsHealthCheck {\r\n  static dependencies = [platformMetricsSnapshotPortToken, healthCheckRegistryToken] as const;\r\n\r\n  constructor(metricsSnapshotPort: PlatformMetricsSnapshotPort, registry: PlatformHealthCheckPort) {\r\n    super(metricsSnapshotPort);\r\n    registry.register(this);\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function that returns the DIMetricsHealthCheck class reference.\r\n *\r\n * Centralizes access to the DIMetricsHealthCheck class to follow the Dependency Inversion Principle (DIP).\r\n * This allows the Framework layer to register the class without directly importing it,\r\n * improving testability and reducing coupling.\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * import { getDIMetricsHealthCheckClass } from \"@/application/health/MetricsHealthCheck\";\r\n *\r\n * const healthCheckClass = getDIMetricsHealthCheckClass();\r\n * container.registerClass(token, healthCheckClass, lifecycle);\r\n * ```\r\n *\r\n * @returns The DIMetricsHealthCheck class constructor\r\n */\r\nexport function getDIMetricsHealthCheckClass(): typeof DIMetricsHealthCheck {\r\n  return DIMetricsHealthCheck;\r\n}\r\n","/**\r\n * Injection token for the module ID.\r\n *\r\n * WICHTIG: Diese Datei importiert KEINE Service-Types!\r\n * Token-Generics werden erst beim resolve() aufgelöst.\r\n * Dies verhindert zirkuläre Dependencies strukturell.\r\n */\r\n\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\n\r\n/**\r\n * Injection token for the module ID.\r\n *\r\n * Provides the module identifier string for Infrastructure services.\r\n * Registered as a static value in static-values.config.ts to avoid\r\n * Infrastructure layer depending on Application layer constants.\r\n */\r\nexport const moduleIdToken = createInjectionToken<string>(\"ModuleId\");\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Represents a single step in the dependency registration process.\r\n * Steps are executed in priority order (lower priority = earlier execution).\r\n */\r\nexport interface DependencyRegistrationStep {\r\n  /** Human-readable name for logging and error messages */\r\n  name: string;\r\n  /** Priority determines execution order (lower = earlier). Use increments of 10 for flexibility. */\r\n  priority: number;\r\n  /** Function to execute for this registration step */\r\n  execute: (container: ServiceContainer) => Result<void, string>;\r\n}\r\n\r\n/**\r\n * Registry for dependency registration steps.\r\n * Allows adding new registration steps without modifying configureDependencies.\r\n *\r\n * DESIGN: Uses Registry Pattern to follow Open/Closed Principle:\r\n * - Open for extension: New steps can be added via register()\r\n * - Closed for modification: configureDependencies doesn't need to change\r\n */\r\nexport class DependencyRegistrationRegistry {\r\n  private steps: DependencyRegistrationStep[] = [];\r\n\r\n  /**\r\n   * Registers a new dependency registration step.\r\n   * Steps are automatically sorted by priority after registration.\r\n   * If a step with the same name already exists, it will be replaced.\r\n   *\r\n   * @param step - The registration step to add\r\n   */\r\n  register(step: DependencyRegistrationStep): void {\r\n    // Remove existing step with same name if present (allows re-registration)\r\n    this.steps = this.steps.filter((s) => s.name !== step.name);\r\n    this.steps.push(step);\r\n    this.steps.sort((a, b) => a.priority - b.priority);\r\n  }\r\n\r\n  /**\r\n   * Resets the registry by clearing all registered steps.\r\n   * This is primarily useful for testing scenarios where a clean state is needed.\r\n   */\r\n  reset(): void {\r\n    this.steps = [];\r\n  }\r\n\r\n  /**\r\n   * Executes all registered steps in priority order.\r\n   * Stops at first error and returns it.\r\n   *\r\n   * @param container - The service container to configure\r\n   * @returns Result indicating success or the first error encountered\r\n   */\r\n  configure(container: ServiceContainer): Result<void, string> {\r\n    for (const step of this.steps) {\r\n      const result = step.execute(container);\r\n      if (isErr(result)) {\r\n        return err(`Failed at step '${step.name}': ${result.error}`);\r\n      }\r\n    }\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\n/**\r\n * Global dependency registration registry instance.\r\n * Modules can register their dependency registration steps via registerDependencyStep().\r\n *\r\n * DESIGN: Singleton pattern for global extensibility.\r\n * Modules import this registry and register their steps at module load time.\r\n */\r\nexport const dependencyRegistry = new DependencyRegistrationRegistry();\r\n\r\n/**\r\n * Registers a dependency registration step in the global registry.\r\n *\r\n * This function allows modules to register their dependency registration steps\r\n * without modifying the core dependency configuration. This follows the\r\n * Open/Closed Principle - the system is open for extension but closed for modification.\r\n *\r\n * @param step - The registration step to add\r\n *\r\n * @example\r\n * ```typescript\r\n * import { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\n * import { registerMyServices } from \"./my-services.config\";\r\n *\r\n * // Module registers itself at import time\r\n * registerDependencyStep({\r\n *   name: \"MyServices\",\r\n *   priority: 50,\r\n *   execute: registerMyServices,\r\n * });\r\n * ```\r\n */\r\nexport function registerDependencyStep(step: DependencyRegistrationStep): void {\r\n  dependencyRegistry.register(step);\r\n}\r\n","/**\r\n * Injection token for PortSelector.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortSelector } from \"@/infrastructure/adapters/foundry/versioning/portselector\";\r\n\r\n/**\r\n * Injection token for PortSelector.\r\n *\r\n * Selects the appropriate port implementation based on the current\r\n * Foundry VTT version. Uses factory-based selection to prevent crashes\r\n * from incompatible port constructors.\r\n *\r\n * @remarks\r\n * This is a core infrastructure service used internally by Foundry services.\r\n * Typically not accessed directly by application code.\r\n */\r\nexport const portSelectorToken = createInjectionToken<PortSelector>(\"PortSelector\");\r\n","/**\r\n * Injection token for FoundryGame PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\n\r\n/**\r\n * Injection token for FoundryGame PortRegistry.\r\n */\r\nexport const foundryGamePortRegistryToken =\r\n  createInjectionToken<PortRegistry<FoundryGame>>(\"FoundryGamePortRegistry\");\r\n","/**\r\n * Injection token for FoundryHooks PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\n\r\n/**\r\n * Injection token for FoundryHooks PortRegistry.\r\n */\r\nexport const foundryHooksPortRegistryToken = createInjectionToken<PortRegistry<FoundryHooks>>(\r\n  \"FoundryHooksPortRegistry\"\r\n);\r\n","/**\r\n * Injection token for FoundryDocument PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\n\r\n/**\r\n * Injection token for FoundryDocument PortRegistry.\r\n */\r\nexport const foundryDocumentPortRegistryToken = createInjectionToken<PortRegistry<FoundryDocument>>(\r\n  \"FoundryDocumentPortRegistry\"\r\n);\r\n","/**\r\n * Injection token for FoundryUI PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\n\r\n/**\r\n * Injection token for FoundryUI PortRegistry.\r\n */\r\nexport const foundryUIPortRegistryToken =\r\n  createInjectionToken<PortRegistry<FoundryUI>>(\"FoundryUIPortRegistry\");\r\n","/**\r\n * Injection token for FoundrySettings PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\n\r\n/**\r\n * Injection token for FoundrySettings PortRegistry.\r\n */\r\nexport const foundrySettingsPortRegistryToken = createInjectionToken<PortRegistry<FoundrySettings>>(\r\n  \"FoundrySettingsPortRegistry\"\r\n);\r\n","/**\r\n * Injection token for FoundryI18n PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\n\r\n/**\r\n * Injection token for FoundryI18n PortRegistry.\r\n */\r\nexport const foundryI18nPortRegistryToken =\r\n  createInjectionToken<PortRegistry<FoundryI18n>>(\"FoundryI18nPortRegistry\");\r\n","/**\r\n * Injection token for FoundryModule PortRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { FoundryModule } from \"@/infrastructure/adapters/foundry/interfaces/FoundryModule\";\r\n\r\n/**\r\n * Injection token for FoundryModule PortRegistry.\r\n */\r\nexport const foundryModulePortRegistryToken = createInjectionToken<PortRegistry<FoundryModule>>(\r\n  \"FoundryModulePortRegistry\"\r\n);\r\n","/**\r\n * Error codes for Foundry API operations.\r\n * Provides type-safe classification of Foundry-related errors.\r\n */\r\nexport type FoundryErrorCode =\r\n  | \"API_NOT_AVAILABLE\" // Foundry API (game, Hooks, etc.) not available\r\n  | \"VALIDATION_FAILED\" // Runtime validation failed\r\n  | \"NOT_FOUND\" // Entity not found by ID\r\n  | \"ACCESS_DENIED\" // Permission denied\r\n  | \"PORT_SELECTION_FAILED\" // Port selection/instantiation failed\r\n  | \"PORT_REGISTRY_ERROR\" // Port registry duplicate registration\r\n  | \"PORT_NOT_FOUND\" // No compatible port found for version\r\n  | \"PORT_RESOLUTION_FAILED\" // Port resolution from container failed\r\n  | \"VERSION_DETECTION_FAILED\" // Foundry version detection failed\r\n  | \"DISPOSED\" // Port or service has been disposed\r\n  | \"OPERATION_FAILED\"; // General operation failure\r\n\r\n/**\r\n * Structured error for Foundry operations.\r\n * Provides detailed context for debugging and error handling.\r\n *\r\n * @example\r\n * ```typescript\r\n * const error: FoundryError = {\r\n *   code: \"API_NOT_AVAILABLE\",\r\n *   message: \"Foundry game API not available\",\r\n *   details: { api: \"game.journal\" }\r\n * };\r\n * ```\r\n */\r\nexport interface FoundryError {\r\n  /** Error code classifying the type of error */\r\n  code: FoundryErrorCode;\r\n\r\n  /** Human-readable error message */\r\n  message: string;\r\n\r\n  /** Optional additional context (IDs, names, etc.) */\r\n  details?: unknown;\r\n\r\n  /** Optional underlying error or exception that caused this error */\r\n  cause?: unknown;\r\n}\r\n\r\n/**\r\n * Factory for creating FoundryError instances.\r\n *\r\n * @param code - Error code\r\n * @param message - Error message\r\n * @param details - Optional additional context\r\n * @param cause - Optional underlying error\r\n * @returns FoundryError instance\r\n *\r\n * @example\r\n * ```typescript\r\n * const error = createFoundryError(\r\n *   \"NOT_FOUND\",\r\n *   \"Journal entry not found\",\r\n *   { journalId: \"abc123\" }\r\n * );\r\n * ```\r\n */\r\nexport function createFoundryError(\r\n  code: FoundryErrorCode,\r\n  message: string,\r\n  details?: unknown,\r\n  cause?: unknown\r\n): FoundryError {\r\n  return { code, message, details, cause };\r\n}\r\n\r\n/**\r\n * Type guard helper for error-like objects.\r\n */\r\ninterface ErrorLike {\r\n  code?: unknown;\r\n  message?: unknown;\r\n}\r\n\r\n/**\r\n * Checks if an object has error-like properties.\r\n */\r\nfunction isErrorLike(obj: unknown): obj is ErrorLike {\r\n  return typeof obj === \"object\" && obj !== null;\r\n}\r\n\r\n/**\r\n * Type guard to check if an error is a FoundryError.\r\n *\r\n * @param error - Error to check\r\n * @returns True if error is a FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * if (isFoundryError(error)) {\r\n *   console.log(error.code); // Type-safe access\r\n * }\r\n * ```\r\n */\r\nexport function isFoundryError(error: unknown): error is FoundryError {\r\n  if (!isErrorLike(error)) return false;\r\n\r\n  return (\r\n    \"code\" in error &&\r\n    \"message\" in error &&\r\n    typeof error.code === \"string\" &&\r\n    typeof error.message === \"string\"\r\n  );\r\n}\r\n","/**\r\n * Injection token for the PortSelectionEventEmitter.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortSelectionEventEmitter } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\n\r\n/**\r\n * Injection token for the PortSelectionEventEmitter.\r\n *\r\n * Provides event emission infrastructure for PortSelector observability.\r\n * Registered as TRANSIENT - each service gets its own instance.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(emitter: PortSelectionEventEmitter) {\r\n *     this.emitter = emitter;\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const portSelectionEventEmitterToken = createInjectionToken<PortSelectionEventEmitter>(\r\n  \"PortSelectionEventEmitter\"\r\n);\r\n","/**\r\n * Injection token for FoundryVersionDetector.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryVersionDetector } from \"@/infrastructure/adapters/foundry/versioning/foundry-version-detector\";\r\n\r\n/**\r\n * Injection token for FoundryVersionDetector.\r\n *\r\n * Service for detecting the current Foundry VTT version.\r\n * Encapsulates version detection logic following Single Responsibility Principle.\r\n *\r\n * @remarks\r\n * This is a core infrastructure service used by PortSelector and other services\r\n * that need to determine the Foundry version.\r\n */\r\nexport const foundryVersionDetectorToken =\r\n  createInjectionToken<FoundryVersionDetector>(\"FoundryVersionDetector\");\r\n","/**\r\n * Strategy for resolving ports from the DI container.\r\n *\r\n * Encapsulates container resolution logic to follow Single Responsibility Principle.\r\n * This separates port resolution concerns from port selection logic.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * Strategy for resolving ports from the DI container.\r\n *\r\n * Provides a clean abstraction for container resolution, making it easier\r\n * to test and maintain port selection logic.\r\n */\r\nexport class PortResolutionStrategy {\r\n  constructor(private readonly container: ServiceContainer) {}\r\n\r\n  /**\r\n   * Resolves a port from the DI container using the provided injection token.\r\n   *\r\n   * @template T - The port type\r\n   * @param token - The injection token for the port\r\n   * @returns Result with resolved port or FoundryError\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const strategy = new PortResolutionStrategy(container);\r\n   * const portResult = strategy.resolve(foundryV13GamePortToken);\r\n   * if (portResult.ok) {\r\n   *   const port = portResult.value;\r\n   * }\r\n   * ```\r\n   */\r\n  resolve<T>(token: InjectionToken<T>): Result<T, FoundryError> {\r\n    try {\r\n      const resolveResult = this.container.resolveWithError(token);\r\n      if (!resolveResult.ok) {\r\n        return err(\r\n          createFoundryError(\r\n            \"PORT_RESOLUTION_FAILED\",\r\n            `Failed to resolve port from container`,\r\n            { token: String(token) },\r\n            resolveResult.error\r\n          )\r\n        );\r\n      }\r\n      return ok(castResolvedService<T>(resolveResult.value));\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"PORT_RESOLUTION_FAILED\",\r\n          `Failed to resolve port from container`,\r\n          { token: String(token) },\r\n          error instanceof Error ? error : new Error(String(error))\r\n        )\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { IPortSelectionObservability } from \"@/infrastructure/adapters/foundry/versioning/port-selection-observability.interface\";\r\n\r\nexport const portSelectionObservabilityToken = createInjectionToken<IPortSelectionObservability>(\r\n  \"PortSelectionObservability\"\r\n);\r\n","import { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { IPortSelectionPerformanceTracker } from \"@/infrastructure/adapters/foundry/versioning/port-selection-performance-tracker.interface\";\r\n\r\nexport const portSelectionPerformanceTrackerToken =\r\n  createInjectionToken<IPortSelectionPerformanceTracker>(\"PortSelectionPerformanceTracker\");\r\n","import { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PortSelectionObserver } from \"@/infrastructure/adapters/foundry/versioning/port-selection-observer\";\r\n\r\nexport const portSelectionObserverToken =\r\n  createInjectionToken<PortSelectionObserver>(\"PortSelectionObserver\");\r\n","/**\r\n * Greedy port matching strategy.\r\n *\r\n * Implements the default \"greedy highest <= version\" algorithm:\r\n * - Never selects a port with version > current Foundry version\r\n * - Selects the highest port version that is <= Foundry version\r\n *\r\n * This is the default strategy used by PortSelector.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\nimport { APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\nimport type { PortMatchStrategy, PortMatch, MatchError } from \"./port-match-strategy.interface\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\n\r\n/**\r\n * Creates a MatchError for port selection failures.\r\n */\r\nfunction createMatchError(\r\n  message: string,\r\n  details?: { version: number; availableVersions: string }\r\n): MatchError {\r\n  return {\r\n    code: \"PORT_SELECTION_FAILED\",\r\n    message,\r\n    details,\r\n  };\r\n}\r\n\r\n/**\r\n * Greedy port matching strategy.\r\n *\r\n * Selects the highest compatible port version (highest version <= Foundry version).\r\n * This is the default strategy used by PortSelector.\r\n *\r\n * @template T - The port type\r\n */\r\nexport class GreedyPortMatchStrategy<T> implements PortMatchStrategy<T> {\r\n  /**\r\n   * Selects the highest compatible port version.\r\n   *\r\n   * Algorithm:\r\n   * 1. Never select a port with version > current Foundry version\r\n   *    (prevents using APIs that don't exist yet)\r\n   * 2. Select the highest port version that is <= Foundry version\r\n   *    (use the newest compatible implementation)\r\n   *\r\n   * Time Complexity: O(n) where n = number of registered ports\r\n   * Space Complexity: O(1)\r\n   *\r\n   * @param tokens - Map of version numbers to injection tokens\r\n   * @param foundryVersion - The current Foundry version to match against\r\n   * @returns Result with matched port token and version, or error if no match found\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const strategy = new GreedyPortMatchStrategy();\r\n   * const tokens = new Map([\r\n   *   [13, foundryV13GamePortToken],\r\n   *   [14, foundryV14GamePortToken]\r\n   * ]);\r\n   * // Foundry v14: selects v14\r\n   * // Foundry v13: selects v13\r\n   * // Foundry v15: selects v14 (fallback to highest available)\r\n   * const result = strategy.select(tokens, 14);\r\n   * ```\r\n   */\r\n  select(\r\n    tokens: Map<number, InjectionToken<T>>,\r\n    foundryVersion: number\r\n  ): Result<PortMatch<T>, MatchError> {\r\n    let selectedToken: InjectionToken<T> | undefined;\r\n    let selectedVersion: number = APP_DEFAULTS.NO_VERSION_SELECTED;\r\n\r\n    // Linear search for highest compatible version\r\n    // Could be optimized with sorted array + binary search, but n is typically small (2-5 ports)\r\n    for (const [portVersion, token] of tokens.entries()) {\r\n      // Rule 1: Skip ports newer than current Foundry version\r\n      // These ports may use APIs that don't exist yet → runtime crashes\r\n      if (portVersion > foundryVersion) {\r\n        continue; // Incompatible (too new)\r\n      }\r\n\r\n      // Rule 2: Greedy selection - always prefer higher version numbers\r\n      // Track the highest compatible version seen so far\r\n      if (portVersion > selectedVersion) {\r\n        selectedVersion = portVersion;\r\n        selectedToken = token;\r\n      }\r\n    }\r\n\r\n    if (selectedToken === undefined) {\r\n      const availableVersions = Array.from(tokens.keys())\r\n        .sort((a, b) => a - b)\r\n        .join(\", \");\r\n\r\n      return err(\r\n        createMatchError(`No compatible port found for Foundry version ${foundryVersion}`, {\r\n          version: foundryVersion,\r\n          availableVersions: availableVersions || \"none\",\r\n        })\r\n      );\r\n    }\r\n\r\n    return ok({\r\n      token: selectedToken,\r\n      version: selectedVersion,\r\n    });\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { PortSelectionEventEmitter } from \"./port-selection-events\";\r\nimport type { PortSelectionEventCallback } from \"./port-selection-events\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { portSelectionEventEmitterToken } from \"@/infrastructure/shared/tokens/observability/port-selection-event-emitter.token\";\r\nimport { serviceContainerToken } from \"@/infrastructure/shared/tokens/core/service-container.token\";\r\nimport { foundryVersionDetectorToken } from \"@/infrastructure/shared/tokens/foundry/foundry-version-detector.token\";\r\nimport type { FoundryVersionDetector } from \"./foundry-version-detector\";\r\nimport { PortResolutionStrategy } from \"./port-resolution-strategy\";\r\nimport type { PortSelectionObserver } from \"./port-selection-observer\";\r\nimport type { IPortSelectionObservability } from \"./port-selection-observability.interface\";\r\nimport type { IPortSelectionPerformanceTracker } from \"./port-selection-performance-tracker.interface\";\r\nimport { portSelectionObservabilityToken } from \"@/infrastructure/shared/tokens/observability/port-selection-observability.token\";\r\nimport { portSelectionPerformanceTrackerToken } from \"@/infrastructure/shared/tokens/observability/port-selection-performance-tracker.token\";\r\nimport { portSelectionObserverToken } from \"@/infrastructure/shared/tokens/observability/port-selection-observer.token\";\r\nimport type { PortMatchStrategy } from \"./port-match-strategy.interface\";\r\nimport { GreedyPortMatchStrategy } from \"./greedy-port-match-strategy\";\r\n\r\n/**\r\n * Selects the appropriate port implementation based on Foundry version.\r\n * Implements the logic:\r\n * - Foundry v13 → uses v13 ports\r\n * - Foundry v14 → uses v14 ports (if available), otherwise falls back to v13\r\n * - Never uses ports with version number higher than current Foundry version\r\n *\r\n * **Observability:**\r\n * - Delegates event emission to PortSelectionObserver\r\n * - Delegates observability setup to PortSelectionObservability\r\n * - Delegates performance tracking to PortSelectionPerformanceTracker\r\n * - Conforms to SRP: Only responsible for port selection orchestration\r\n *\r\n * **Strategy Pattern:**\r\n * - Delegates matching logic to injected PortMatchStrategy\r\n * - Default strategy: GreedyPortMatchStrategy (highest compatible version)\r\n * - Enables OCP: New matching strategies can be added without modifying PortSelector\r\n *\r\n * **Dependency Injection:**\r\n * - Resolves ports from the DI container using injection tokens\r\n * - Ensures DIP (Dependency Inversion Principle) compliance\r\n */\r\nexport class PortSelector {\r\n  private readonly resolutionStrategy: PortResolutionStrategy;\r\n  private readonly matchStrategy: PortMatchStrategy<unknown>;\r\n\r\n  constructor(\r\n    private readonly versionDetector: FoundryVersionDetector,\r\n    private readonly eventEmitter: PortSelectionEventEmitter,\r\n    private readonly observability: IPortSelectionObservability,\r\n    private readonly performanceTracker: IPortSelectionPerformanceTracker,\r\n    private readonly observer: PortSelectionObserver,\r\n    container: ServiceContainer,\r\n    matchStrategy?: PortMatchStrategy<unknown>\r\n  ) {\r\n    // Delegate observability registration\r\n    this.observability.registerWithObservabilityRegistry(this);\r\n    // Setup observability wiring\r\n    this.observability.setupObservability(this, this.observer);\r\n    // Create resolution strategy for container resolution\r\n    this.resolutionStrategy = new PortResolutionStrategy(container);\r\n    // Use provided strategy or default to greedy strategy\r\n    this.matchStrategy = matchStrategy ?? new GreedyPortMatchStrategy<unknown>();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to port selection events.\r\n   *\r\n   * Allows observers to be notified of port selection success/failure for\r\n   * logging, metrics, and other observability concerns.\r\n   *\r\n   * @param callback - Function to call when port selection events occur\r\n   * @returns Unsubscribe function\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const selector = new PortSelector();\r\n   * const unsubscribe = selector.onEvent((event) => {\r\n   *   if (event.type === 'success') {\r\n   *     console.log(`Port v${event.selectedVersion} selected`);\r\n   *   }\r\n   * });\r\n   * ```\r\n   */\r\n  onEvent(callback: PortSelectionEventCallback): () => void {\r\n    return this.eventEmitter.subscribe(callback);\r\n  }\r\n\r\n  /**\r\n   * Selects and resolves the appropriate port from injection tokens.\r\n   *\r\n   * CRITICAL: Works with token map to avoid eager instantiation.\r\n   * Only the selected token is resolved from the DI container, preventing crashes from\r\n   * incompatible constructors accessing unavailable APIs.\r\n   *\r\n   * @template T - The port type\r\n   * @param tokens - Map of version numbers to injection tokens\r\n   * @param foundryVersion - Optional version override (uses getFoundryVersion() if not provided)\r\n   * @param adapterName - Optional adapter name for observability\r\n   * @returns Result with resolved port or error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const tokens = new Map([\r\n   *   [13, foundryV13GamePortToken],\r\n   *   [14, foundryV14GamePortToken]\r\n   * ]);\r\n   * const selector = new PortSelector(eventEmitter, observability, container);\r\n   * const result = selector.selectPortFromTokens(tokens);\r\n   * // On Foundry v13: resolves only v13 port from container (v14 token never resolved)\r\n   * // On Foundry v14: resolves v14 port from container\r\n   * ```\r\n   */\r\n  selectPortFromTokens<T>(\r\n    tokens: Map<number, InjectionToken<T>>,\r\n    foundryVersion?: number,\r\n    adapterName?: string\r\n  ): Result<T, FoundryError> {\r\n    // Start performance tracking\r\n    this.performanceTracker.startTracking();\r\n\r\n    // Use version detector for version detection\r\n    let version: number;\r\n    if (foundryVersion !== undefined) {\r\n      version = foundryVersion;\r\n    } else {\r\n      const versionResult = this.versionDetector.getVersion();\r\n      if (!versionResult.ok) {\r\n        this.performanceTracker.endTracking(); // Track duration even on failure\r\n        // Emit failure event via observer\r\n        this.observer.handleEvent({\r\n          type: \"failure\",\r\n          foundryVersion: 0, // Unknown version\r\n          availableVersions: Array.from(tokens.keys())\r\n            .sort((a, b) => a - b)\r\n            .join(\", \"),\r\n          ...(adapterName !== undefined ? { adapterName } : {}),\r\n          error: createFoundryError(\r\n            \"PORT_SELECTION_FAILED\",\r\n            \"Could not determine Foundry version\",\r\n            undefined,\r\n            versionResult.error\r\n          ),\r\n        });\r\n        return err(\r\n          createFoundryError(\r\n            \"PORT_SELECTION_FAILED\",\r\n            \"Could not determine Foundry version\",\r\n            undefined,\r\n            versionResult.error\r\n          )\r\n        );\r\n      }\r\n      version = versionResult.value;\r\n    }\r\n\r\n    // Delegate matching to strategy\r\n    // Note: Strategy is typed as PortMatchStrategy<unknown> but we use it with generic T\r\n    // This is safe because the token type is preserved through the matching process\r\n    // We need to cast tokens to match the strategy's type signature, but the actual\r\n    // token types are preserved and will be correctly typed when we extract the result\r\n    const tokensForStrategy: Map<number, InjectionToken<unknown>> = tokens;\r\n    const matchResult = this.matchStrategy.select(tokensForStrategy, version);\r\n    if (!matchResult.ok) {\r\n      this.performanceTracker.endTracking(); // Track duration even on failure\r\n\r\n      // Extract available versions from error details for event emission\r\n      // MatchError.details is typed as unknown, so we need to check the structure\r\n      const errorDetails = matchResult.error.details;\r\n      let availableVersions: string;\r\n      if (\r\n        typeof errorDetails === \"object\" &&\r\n        errorDetails !== null &&\r\n        \"availableVersions\" in errorDetails &&\r\n        typeof errorDetails.availableVersions === \"string\"\r\n      ) {\r\n        availableVersions = errorDetails.availableVersions;\r\n      } else {\r\n        availableVersions = Array.from(tokens.keys())\r\n          .sort((a, b) => a - b)\r\n          .join(\", \");\r\n      }\r\n\r\n      // Emit failure event via observer\r\n      this.observer.handleEvent({\r\n        type: \"failure\",\r\n        foundryVersion: version,\r\n        availableVersions,\r\n        ...(adapterName !== undefined ? { adapterName } : {}),\r\n        error: matchResult.error,\r\n      });\r\n\r\n      return err(matchResult.error);\r\n    }\r\n\r\n    const { token: selectedToken, version: selectedVersion } = matchResult.value;\r\n\r\n    // CRITICAL: Only now resolve the selected port from the DI container\r\n    // Type assertion is necessary here because:\r\n    // 1. The strategy is typed as PortMatchStrategy<unknown> for flexibility (allows any port type)\r\n    // 2. selectedToken comes from the tokens Map<number, InjectionToken<T>> passed to select()\r\n    // 3. TypeScript cannot infer that selectedToken is InjectionToken<T> because of the strategy's unknown type\r\n    // 4. The assertion is safe because the token was originally from the tokens map with type T\r\n    // This is a known limitation when using generic strategies with type-erased implementations\r\n    /* type-coverage:ignore-next-line -- Type narrowing: selectedToken comes from tokens Map<number, InjectionToken<T>>, but strategy is typed as PortMatchStrategy<unknown> for flexibility. The cast is safe because the token was originally from the tokens map with type T. */\r\n    const typedToken = selectedToken as InjectionToken<T>;\r\n    const portResult = this.resolutionStrategy.resolve(typedToken);\r\n    if (!portResult.ok) {\r\n      this.performanceTracker.endTracking(); // Track duration even on failure\r\n\r\n      // Emit failure event via observer\r\n      this.observer.handleEvent({\r\n        type: \"failure\",\r\n        foundryVersion: version,\r\n        availableVersions: Array.from(tokens.keys())\r\n          .sort((a, b) => a - b)\r\n          .join(\", \"),\r\n        ...(adapterName !== undefined ? { adapterName } : {}),\r\n        error: portResult.error,\r\n      });\r\n\r\n      return err(portResult.error);\r\n    }\r\n\r\n    const durationMs = this.performanceTracker.endTracking();\r\n\r\n    // Emit success event via observer\r\n    // Observer will call eventEmitter.emit() internally and handle logging/metrics\r\n    this.observer.handleEvent({\r\n      type: \"success\",\r\n      selectedVersion,\r\n      foundryVersion: version,\r\n      ...(adapterName !== undefined ? { adapterName } : {}),\r\n      durationMs,\r\n    });\r\n\r\n    return ok(portResult.value);\r\n  }\r\n}\r\n\r\nexport class DIPortSelector extends PortSelector {\r\n  static dependencies = [\r\n    foundryVersionDetectorToken,\r\n    portSelectionEventEmitterToken,\r\n    portSelectionObservabilityToken,\r\n    portSelectionPerformanceTrackerToken,\r\n    portSelectionObserverToken,\r\n    serviceContainerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    versionDetector: FoundryVersionDetector,\r\n    eventEmitter: PortSelectionEventEmitter,\r\n    observability: IPortSelectionObservability,\r\n    performanceTracker: IPortSelectionPerformanceTracker,\r\n    observer: PortSelectionObserver,\r\n    container: ServiceContainer\r\n  ) {\r\n    // Use default GreedyPortMatchStrategy (injected via constructor default parameter)\r\n    super(versionDetector, eventEmitter, observability, performanceTracker, observer, container);\r\n  }\r\n}\r\n","/**\r\n * Version detection for Foundry VTT.\r\n * Extracts the major version number from Foundry's version string.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Cached version result to avoid repeated game.version access.\r\n * Improves performance when version is checked multiple times (e.g., during port selection).\r\n */\r\nlet cachedVersion: Result<number, string> | null = null;\r\n\r\n/**\r\n * Internal function to detect Foundry version without caching.\r\n * Called only once on first version check.\r\n */\r\nfunction detectFoundryVersion(): Result<number, string> {\r\n  if (typeof game === \"undefined\") {\r\n    return err(\"Foundry game object is not available or version cannot be determined\");\r\n  }\r\n\r\n  // game.version is typed as string by fvtt-types\r\n  // Format is \"{major}.{minor}\" (e.g., \"13.348\")\r\n  const versionString = game.version;\r\n  if (!versionString) {\r\n    return err(\"Foundry version is not available on the game object\");\r\n  }\r\n\r\n  const versionStr = versionString.match(/^(\\d+)/)?.[1];\r\n  if (!versionStr) {\r\n    return err(`Could not parse Foundry version from: ${versionString}`);\r\n  }\r\n\r\n  return ok(Number.parseInt(versionStr, 10));\r\n}\r\n\r\n/**\r\n * Gets the major version number of the currently running Foundry VTT instance.\r\n * Returns a Result for proper error handling.\r\n *\r\n * Performance: Version is cached after first detection to avoid repeated game.version access.\r\n *\r\n * @returns Result with major version number (e.g., 13 for \"13.348\") or error message\r\n *\r\n * @example\r\n * ```typescript\r\n * const versionResult = getFoundryVersionResult();\r\n * if (versionResult.ok) {\r\n *   console.log(`Foundry version: ${versionResult.value}`);\r\n * } else {\r\n *   console.error(`Version detection failed: ${versionResult.error}`);\r\n * }\r\n * ```\r\n */\r\nexport function getFoundryVersionResult(): Result<number, string> {\r\n  if (cachedVersion === null) {\r\n    cachedVersion = detectFoundryVersion();\r\n  }\r\n  return cachedVersion;\r\n}\r\n\r\n/**\r\n * Resets the version cache.\r\n *\r\n * @internal For testing purposes only.\r\n *\r\n * Should be called in test cleanup (afterEach) to ensure test isolation.\r\n * DO NOT use in production code - version detection is intentionally cached\r\n * for performance reasons.\r\n */\r\nexport function resetVersionCache(): void {\r\n  cachedVersion = null;\r\n}\r\n\r\n/**\r\n * Safely gets the Foundry version, returning undefined if it cannot be determined.\r\n * @returns The major version number or undefined if not available\r\n */\r\nexport function tryGetFoundryVersion(): number | undefined {\r\n  const result = getFoundryVersionResult();\r\n  return result.ok ? result.value : undefined;\r\n}\r\n","/**\r\n * Service for detecting the current Foundry VTT version.\r\n *\r\n * Encapsulates version detection logic to follow Single Responsibility Principle.\r\n * This service can be injected into other services that need to determine the\r\n * Foundry version, making it testable and reusable.\r\n *\r\n * **Performance:**\r\n * Version detection is cached after first detection to avoid repeated\r\n * `game.version` access. The cache is managed by the underlying `getFoundryVersionResult()` function.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { getFoundryVersionResult } from \"./versiondetector\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\n\r\n/**\r\n * Service for detecting the current Foundry VTT version.\r\n *\r\n * Provides a clean interface for version detection that can be injected\r\n * into other services, following Dependency Inversion Principle.\r\n */\r\nexport class FoundryVersionDetector {\r\n  /**\r\n   * Gets the major version number of the currently running Foundry VTT instance.\r\n   *\r\n   * @returns Result with major version number (e.g., 13 for \"13.348\") or FoundryError\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const detector = new FoundryVersionDetector();\r\n   * const versionResult = detector.getVersion();\r\n   * if (versionResult.ok) {\r\n   *   console.log(`Foundry version: ${versionResult.value}`);\r\n   * }\r\n   * ```\r\n   */\r\n  getVersion(): Result<number, FoundryError> {\r\n    const versionResult = getFoundryVersionResult();\r\n    if (!versionResult.ok) {\r\n      return err(\r\n        createFoundryError(\r\n          \"VERSION_DETECTION_FAILED\",\r\n          \"Could not determine Foundry version\",\r\n          undefined,\r\n          versionResult.error\r\n        )\r\n      );\r\n    }\r\n    return ok(versionResult.value);\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for FoundryVersionDetector.\r\n *\r\n * Implements the DI pattern by declaring static dependencies.\r\n * This allows the DI container to resolve and inject dependencies automatically.\r\n */\r\nexport class DIFoundryVersionDetector extends FoundryVersionDetector {\r\n  static dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","/**\r\n * Registry for managing available port implementations across different Foundry versions.\r\n * Centralizes port registration and discovery.\r\n *\r\n * Ports are registered via DI container tokens, ensuring DIP (Dependency Inversion Principle)\r\n * compliance. PortSelector resolves ports from the container using these tokens.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  createFoundryError,\r\n  type FoundryError,\r\n} from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\n\r\n/**\r\n * Registry that holds exactly one port injection token per version.\r\n * @template T - The port interface type\r\n */\r\nexport class PortRegistry<T> {\r\n  // Exactly one token per version\r\n  private readonly tokens = new Map<number, InjectionToken<T>>();\r\n\r\n  /**\r\n   * Registers a port injection token for a specific Foundry version.\r\n   * @param version - The Foundry version this port supports\r\n   * @param token - Injection token for resolving the port from the DI container\r\n   * @returns Result indicating success or duplicate registration error\r\n   */\r\n  register(version: number, token: InjectionToken<T>): Result<void, FoundryError> {\r\n    if (this.tokens.has(version)) {\r\n      return err(\r\n        createFoundryError(\r\n          \"PORT_REGISTRY_ERROR\",\r\n          `Port for version ${version} already registered`,\r\n          { version }\r\n        )\r\n      );\r\n    }\r\n    this.tokens.set(version, token);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Gets all registered port versions.\r\n   * @returns Array of registered version numbers, sorted ascending\r\n   */\r\n  getAvailableVersions(): number[] {\r\n    return Array.from(this.tokens.keys()).sort((a, b) => a - b);\r\n  }\r\n\r\n  /**\r\n   * Gets the token map without resolving ports.\r\n   * Use with PortSelector.selectPortFromTokens() for safe lazy instantiation via DI.\r\n   *\r\n   * @returns Map of version numbers to injection tokens (NOT instances)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const registry = new PortRegistry<FoundryGame>();\r\n   * registry.register(13, foundryV13GamePortToken);\r\n   * registry.register(14, foundryGamePortV14Token);\r\n   *\r\n   * const tokens = registry.getTokens();\r\n   * const selector = new PortSelector(container);\r\n   * const result = selector.selectPortFromTokens(tokens);\r\n   * // Only compatible port is resolved from container\r\n   * ```\r\n   */\r\n  getTokens(): Map<number, InjectionToken<T>> {\r\n    return new Map(this.tokens);\r\n  }\r\n\r\n  /**\r\n   * Checks if a port is registered for a specific version.\r\n   * @param version - The version to check\r\n   * @returns True if a port is registered for this version\r\n   */\r\n  hasVersion(version: number): boolean {\r\n    return this.tokens.has(version);\r\n  }\r\n\r\n  /**\r\n   * Gets the highest registered port version.\r\n   * @returns The highest version number or undefined if no ports are registered\r\n   */\r\n  getHighestVersion(): number | undefined {\r\n    const versions = this.getAvailableVersions();\r\n    return versions.at(-1);\r\n  }\r\n}\r\n","//#region src/storages/globalConfig/globalConfig.ts\nlet store$4;\n/**\n* Sets the global configuration.\n*\n* @param config The configuration.\n*/\nfunction setGlobalConfig(config$1) {\n\tstore$4 = {\n\t\t...store$4,\n\t\t...config$1\n\t};\n}\n/**\n* Returns the global configuration.\n*\n* @param config The config to merge.\n*\n* @returns The configuration.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getGlobalConfig(config$1) {\n\treturn {\n\t\tlang: config$1?.lang ?? store$4?.lang,\n\t\tmessage: config$1?.message,\n\t\tabortEarly: config$1?.abortEarly ?? store$4?.abortEarly,\n\t\tabortPipeEarly: config$1?.abortPipeEarly ?? store$4?.abortPipeEarly\n\t};\n}\n/**\n* Deletes the global configuration.\n*/\nfunction deleteGlobalConfig() {\n\tstore$4 = void 0;\n}\n\n//#endregion\n//#region src/storages/globalMessage/globalMessage.ts\nlet store$3;\n/**\n* Sets a global error message.\n*\n* @param message The error message.\n* @param lang The language of the message.\n*/\nfunction setGlobalMessage(message$1, lang) {\n\tif (!store$3) store$3 = /* @__PURE__ */ new Map();\n\tstore$3.set(lang, message$1);\n}\n/**\n* Returns a global error message.\n*\n* @param lang The language of the message.\n*\n* @returns The error message.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getGlobalMessage(lang) {\n\treturn store$3?.get(lang);\n}\n/**\n* Deletes a global error message.\n*\n* @param lang The language of the message.\n*/\nfunction deleteGlobalMessage(lang) {\n\tstore$3?.delete(lang);\n}\n\n//#endregion\n//#region src/storages/schemaMessage/schemaMessage.ts\nlet store$2;\n/**\n* Sets a schema error message.\n*\n* @param message The error message.\n* @param lang The language of the message.\n*/\nfunction setSchemaMessage(message$1, lang) {\n\tif (!store$2) store$2 = /* @__PURE__ */ new Map();\n\tstore$2.set(lang, message$1);\n}\n/**\n* Returns a schema error message.\n*\n* @param lang The language of the message.\n*\n* @returns The error message.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getSchemaMessage(lang) {\n\treturn store$2?.get(lang);\n}\n/**\n* Deletes a schema error message.\n*\n* @param lang The language of the message.\n*/\nfunction deleteSchemaMessage(lang) {\n\tstore$2?.delete(lang);\n}\n\n//#endregion\n//#region src/storages/specificMessage/specificMessage.ts\nlet store$1;\n/**\n* Sets a specific error message.\n*\n* @param reference The identifier reference.\n* @param message The error message.\n* @param lang The language of the message.\n*/\nfunction setSpecificMessage(reference, message$1, lang) {\n\tif (!store$1) store$1 = /* @__PURE__ */ new Map();\n\tif (!store$1.get(reference)) store$1.set(reference, /* @__PURE__ */ new Map());\n\tstore$1.get(reference).set(lang, message$1);\n}\n/**\n* Returns a specific error message.\n*\n* @param reference The identifier reference.\n* @param lang The language of the message.\n*\n* @returns The error message.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getSpecificMessage(reference, lang) {\n\treturn store$1?.get(reference)?.get(lang);\n}\n/**\n* Deletes a specific error message.\n*\n* @param reference The identifier reference.\n* @param lang The language of the message.\n*/\nfunction deleteSpecificMessage(reference, lang) {\n\tstore$1?.get(reference)?.delete(lang);\n}\n\n//#endregion\n//#region src/utils/_stringify/_stringify.ts\n/**\n* Stringifies an unknown input to a literal or type string.\n*\n* @param input The unknown input.\n*\n* @returns A literal or type string.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _stringify(input) {\n\tconst type = typeof input;\n\tif (type === \"string\") return `\"${input}\"`;\n\tif (type === \"number\" || type === \"bigint\" || type === \"boolean\") return `${input}`;\n\tif (type === \"object\" || type === \"function\") return (input && Object.getPrototypeOf(input)?.constructor?.name) ?? \"null\";\n\treturn type;\n}\n\n//#endregion\n//#region src/utils/_addIssue/_addIssue.ts\n/**\n* Adds an issue to the dataset.\n*\n* @param context The issue context.\n* @param label The issue label.\n* @param dataset The input dataset.\n* @param config The configuration.\n* @param other The optional props.\n*\n* @internal\n*/\nfunction _addIssue(context, label, dataset, config$1, other) {\n\tconst input = other && \"input\" in other ? other.input : dataset.value;\n\tconst expected = other?.expected ?? context.expects ?? null;\n\tconst received = other?.received ?? /* @__PURE__ */ _stringify(input);\n\tconst issue = {\n\t\tkind: context.kind,\n\t\ttype: context.type,\n\t\tinput,\n\t\texpected,\n\t\treceived,\n\t\tmessage: `Invalid ${label}: ${expected ? `Expected ${expected} but r` : \"R\"}eceived ${received}`,\n\t\trequirement: context.requirement,\n\t\tpath: other?.path,\n\t\tissues: other?.issues,\n\t\tlang: config$1.lang,\n\t\tabortEarly: config$1.abortEarly,\n\t\tabortPipeEarly: config$1.abortPipeEarly\n\t};\n\tconst isSchema = context.kind === \"schema\";\n\tconst message$1 = other?.message ?? context.message ?? /* @__PURE__ */ getSpecificMessage(context.reference, issue.lang) ?? (isSchema ? /* @__PURE__ */ getSchemaMessage(issue.lang) : null) ?? config$1.message ?? /* @__PURE__ */ getGlobalMessage(issue.lang);\n\tif (message$1 !== void 0) issue.message = typeof message$1 === \"function\" ? message$1(issue) : message$1;\n\tif (isSchema) dataset.typed = false;\n\tif (dataset.issues) dataset.issues.push(issue);\n\telse dataset.issues = [issue];\n}\n\n//#endregion\n//#region src/utils/_getByteCount/_getByteCount.ts\nlet textEncoder;\n/**\n* Returns the byte count of the input.\n*\n* @param input The input to be measured.\n*\n* @returns The byte count.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _getByteCount(input) {\n\tif (!textEncoder) textEncoder = new TextEncoder();\n\treturn textEncoder.encode(input).length;\n}\n\n//#endregion\n//#region src/utils/_getGraphemeCount/_getGraphemeCount.ts\nlet segmenter;\n/**\n* Returns the grapheme count of the input.\n*\n* @param input The input to be measured.\n*\n* @returns The grapheme count.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _getGraphemeCount(input) {\n\tif (!segmenter) segmenter = new Intl.Segmenter();\n\tconst segments = segmenter.segment(input);\n\tlet count = 0;\n\tfor (const _ of segments) count++;\n\treturn count;\n}\n\n//#endregion\n//#region src/utils/_getLastMetadata/_getLastMetadata.ts\n/**\n* Returns the last top-level value of a given metadata type from a schema\n* using a breadth-first search that starts with the last item in the pipeline.\n*\n* @param schema The schema to search.\n* @param type The metadata type.\n*\n* @returns The value, if any.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _getLastMetadata(schema, type) {\n\tif (\"pipe\" in schema) {\n\t\tconst nestedSchemas = [];\n\t\tfor (let index = schema.pipe.length - 1; index >= 0; index--) {\n\t\t\tconst item = schema.pipe[index];\n\t\t\tif (item.kind === \"schema\" && \"pipe\" in item) nestedSchemas.push(item);\n\t\t\telse if (item.kind === \"metadata\" && item.type === type) return item[type];\n\t\t}\n\t\tfor (const nestedSchema of nestedSchemas) {\n\t\t\tconst result = /* @__PURE__ */ _getLastMetadata(nestedSchema, type);\n\t\t\tif (result !== void 0) return result;\n\t\t}\n\t}\n}\n\n//#endregion\n//#region src/utils/_getStandardProps/_getStandardProps.ts\n/**\n* Returns the Standard Schema properties.\n*\n* @param context The schema context.\n*\n* @returns The Standard Schema properties.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _getStandardProps(context) {\n\treturn {\n\t\tversion: 1,\n\t\tvendor: \"valibot\",\n\t\tvalidate(value$1) {\n\t\t\treturn context[\"~run\"]({ value: value$1 }, /* @__PURE__ */ getGlobalConfig());\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/utils/_getWordCount/_getWordCount.ts\nlet store;\n/**\n* Returns the word count of the input.\n*\n* @param locales The locales to be used.\n* @param input The input to be measured.\n*\n* @returns The word count.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _getWordCount(locales, input) {\n\tif (!store) store = /* @__PURE__ */ new Map();\n\tif (!store.get(locales)) store.set(locales, new Intl.Segmenter(locales, { granularity: \"word\" }));\n\tconst segments = store.get(locales).segment(input);\n\tlet count = 0;\n\tfor (const segment of segments) if (segment.isWordLike) count++;\n\treturn count;\n}\n\n//#endregion\n//#region src/utils/_isLuhnAlgo/_isLuhnAlgo.ts\n/**\n* Non-digit regex.\n*/\nconst NON_DIGIT_REGEX = /\\D/gu;\n/**\n* Checks whether a string with numbers corresponds to the luhn algorithm.\n*\n* @param input The input to be checked.\n*\n* @returns Whether input is valid.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _isLuhnAlgo(input) {\n\tconst number$1 = input.replace(NON_DIGIT_REGEX, \"\");\n\tlet length$1 = number$1.length;\n\tlet bit = 1;\n\tlet sum = 0;\n\twhile (length$1) {\n\t\tconst value$1 = +number$1[--length$1];\n\t\tbit ^= 1;\n\t\tsum += bit ? [\n\t\t\t0,\n\t\t\t2,\n\t\t\t4,\n\t\t\t6,\n\t\t\t8,\n\t\t\t1,\n\t\t\t3,\n\t\t\t5,\n\t\t\t7,\n\t\t\t9\n\t\t][value$1] : value$1;\n\t}\n\treturn sum % 10 === 0;\n}\n\n//#endregion\n//#region src/utils/_isValidObjectKey/_isValidObjectKey.ts\n/**\n* Disallows inherited object properties and prevents object prototype\n* pollution by disallowing certain keys.\n*\n* @param object The object to check.\n* @param key The key to check.\n*\n* @returns Whether the key is allowed.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _isValidObjectKey(object$1, key) {\n\treturn Object.hasOwn(object$1, key) && key !== \"__proto__\" && key !== \"prototype\" && key !== \"constructor\";\n}\n\n//#endregion\n//#region src/utils/_joinExpects/_joinExpects.ts\n/**\n* Joins multiple `expects` values with the given separator.\n*\n* @param values The `expects` values.\n* @param separator The separator.\n*\n* @returns The joined `expects` property.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _joinExpects(values$1, separator) {\n\tconst list = [...new Set(values$1)];\n\tif (list.length > 1) return `(${list.join(` ${separator} `)})`;\n\treturn list[0] ?? \"never\";\n}\n\n//#endregion\n//#region src/utils/entriesFromList/entriesFromList.ts\n/**\n* Creates an object entries definition from a list of keys and a schema.\n*\n* @param list A list of keys.\n* @param schema The schema of the keys.\n*\n* @returns The object entries.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction entriesFromList(list, schema) {\n\tconst entries$1 = {};\n\tfor (const key of list) entries$1[key] = schema;\n\treturn entries$1;\n}\n\n//#endregion\n//#region src/utils/entriesFromObjects/entriesFromObjects.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction entriesFromObjects(schemas) {\n\tconst entries$1 = {};\n\tfor (const schema of schemas) Object.assign(entries$1, schema.entries);\n\treturn entries$1;\n}\n\n//#endregion\n//#region src/utils/getDotPath/getDotPath.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction getDotPath(issue) {\n\tif (issue.path) {\n\t\tlet key = \"\";\n\t\tfor (const item of issue.path) if (typeof item.key === \"string\" || typeof item.key === \"number\") if (key) key += `.${item.key}`;\n\t\telse key += item.key;\n\t\telse return null;\n\t\treturn key;\n\t}\n\treturn null;\n}\n\n//#endregion\n//#region src/utils/isOfKind/isOfKind.ts\n/**\n* A generic type guard to check the kind of an object.\n*\n* @param kind The kind to check for.\n* @param object The object to check.\n*\n* @returns Whether it matches.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction isOfKind(kind, object$1) {\n\treturn object$1.kind === kind;\n}\n\n//#endregion\n//#region src/utils/isOfType/isOfType.ts\n/**\n* A generic type guard to check the type of an object.\n*\n* @param type The type to check for.\n* @param object The object to check.\n*\n* @returns Whether it matches.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction isOfType(type, object$1) {\n\treturn object$1.type === type;\n}\n\n//#endregion\n//#region src/utils/isValiError/isValiError.ts\n/**\n* A type guard to check if an error is a ValiError.\n*\n* @param error The error to check.\n*\n* @returns Whether its a ValiError.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction isValiError(error) {\n\treturn error instanceof ValiError;\n}\n\n//#endregion\n//#region src/utils/ValiError/ValiError.ts\n/**\n* A Valibot error with useful information.\n*/\nvar ValiError = class extends Error {\n\t/**\n\t* Creates a Valibot error with useful information.\n\t*\n\t* @param issues The error issues.\n\t*/\n\tconstructor(issues) {\n\t\tsuper(issues[0].message);\n\t\tthis.name = \"ValiError\";\n\t\tthis.issues = issues;\n\t}\n};\n\n//#endregion\n//#region src/actions/args/args.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction args(schema) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"args\",\n\t\treference: args,\n\t\tasync: false,\n\t\tschema,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst func = dataset.value;\n\t\t\tdataset.value = (...args_) => {\n\t\t\t\tconst argsDataset = this.schema[\"~run\"]({ value: args_ }, config$1);\n\t\t\t\tif (argsDataset.issues) throw new ValiError(argsDataset.issues);\n\t\t\t\treturn func(...argsDataset.value);\n\t\t\t};\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/args/argsAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction argsAsync(schema) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"args\",\n\t\treference: argsAsync,\n\t\tasync: false,\n\t\tschema,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst func = dataset.value;\n\t\t\tdataset.value = async (...args$1) => {\n\t\t\t\tconst argsDataset = await schema[\"~run\"]({ value: args$1 }, config$1);\n\t\t\t\tif (argsDataset.issues) throw new ValiError(argsDataset.issues);\n\t\t\t\treturn func(...argsDataset.value);\n\t\t\t};\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/await/awaitAsync.ts\n/**\n* Creates an await transformation action.\n*\n* @returns An await action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction awaitAsync() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"await\",\n\t\treference: awaitAsync,\n\t\tasync: true,\n\t\tasync \"~run\"(dataset) {\n\t\t\tdataset.value = await dataset.value;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/regex.ts\n/**\n* [Base64](https://en.wikipedia.org/wiki/Base64) regex.\n*/\nconst BASE64_REGEX = /^(?:[\\da-z+/]{4})*(?:[\\da-z+/]{2}==|[\\da-z+/]{3}=)?$/iu;\n/**\n* [BIC](https://en.wikipedia.org/wiki/ISO_9362) regex.\n*/\nconst BIC_REGEX = /^[A-Z]{6}(?!00)[\\dA-Z]{2}(?:[\\dA-Z]{3})?$/u;\n/**\n* [Cuid2](https://github.com/paralleldrive/cuid2) regex.\n*/\nconst CUID2_REGEX = /^[a-z][\\da-z]*$/u;\n/**\n* [Decimal](https://en.wikipedia.org/wiki/Decimal) regex.\n*/\nconst DECIMAL_REGEX = /^[+-]?(?:\\d*\\.)?\\d+$/u;\n/**\n* [Digits](https://en.wikipedia.org/wiki/Numerical_digit) regex.\n*/\nconst DIGITS_REGEX = /^\\d+$/u;\n/**\n* [Email address](https://en.wikipedia.org/wiki/Email_address) regex.\n*/\nconst EMAIL_REGEX = /^[\\w+-]+(?:\\.[\\w+-]+)*@[\\da-z]+(?:[.-][\\da-z]+)*\\.[a-z]{2,}$/iu;\n/**\n* Emoji regex from [emoji-regex-xs](https://github.com/slevithan/emoji-regex-xs) v1.0.0 (MIT license).\n*\n* Hint: We decided against the newer `/^\\p{RGI_Emoji}+$/v` regex because it is\n* not supported in older runtimes and does not match all emoji.\n*/\nconst EMOJI_REGEX = /^(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|\\u{1F3F4}[\\u{E0061}-\\u{E007A}]{2}[\\u{E0030}-\\u{E0039}\\u{E0061}-\\u{E007A}]{1,3}\\u{E007F}|(?:\\p{Emoji}\\uFE0F\\u20E3?|\\p{Emoji_Modifier_Base}\\p{Emoji_Modifier}?|(?![\\p{Emoji_Modifier_Base}\\u{1F1E6}-\\u{1F1FF}])\\p{Emoji_Presentation})(?:\\u200D(?:\\p{Emoji}\\uFE0F\\u20E3?|\\p{Emoji_Modifier_Base}\\p{Emoji_Modifier}?|(?![\\p{Emoji_Modifier_Base}\\u{1F1E6}-\\u{1F1FF}])\\p{Emoji_Presentation}))*)+$/u;\n/**\n* [Hexadecimal](https://en.wikipedia.org/wiki/Hexadecimal) regex.\n*\n* Hint: We decided against the `i` flag for better JSON Schema compatibility.\n*/\nconst HEXADECIMAL_REGEX = /^(?:0[hx])?[\\da-fA-F]+$/u;\n/**\n* [Hex color](https://en.wikipedia.org/wiki/Web_colors#Hex_triplet) regex.\n*\n* Hint: We decided against the `i` flag for better JSON Schema compatibility.\n*/\nconst HEX_COLOR_REGEX = /^#(?:[\\da-fA-F]{3,4}|[\\da-fA-F]{6}|[\\da-fA-F]{8})$/u;\n/**\n* [IMEI](https://en.wikipedia.org/wiki/International_Mobile_Equipment_Identity) regex.\n*/\nconst IMEI_REGEX = /^\\d{15}$|^\\d{2}-\\d{6}-\\d{6}-\\d$/u;\n/**\n* [IPv4](https://en.wikipedia.org/wiki/IPv4) regex.\n*/\nconst IPV4_REGEX = /^(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])(?:\\.(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])){3}$/u;\n/**\n* [IPv6](https://en.wikipedia.org/wiki/IPv6) regex.\n*/\nconst IPV6_REGEX = /^(?:(?:[\\da-f]{1,4}:){7}[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,7}:|(?:[\\da-f]{1,4}:){1,6}:[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,5}(?::[\\da-f]{1,4}){1,2}|(?:[\\da-f]{1,4}:){1,4}(?::[\\da-f]{1,4}){1,3}|(?:[\\da-f]{1,4}:){1,3}(?::[\\da-f]{1,4}){1,4}|(?:[\\da-f]{1,4}:){1,2}(?::[\\da-f]{1,4}){1,5}|[\\da-f]{1,4}:(?::[\\da-f]{1,4}){1,6}|:(?:(?::[\\da-f]{1,4}){1,7}|:)|fe80:(?::[\\da-f]{0,4}){0,4}%[\\da-z]+|::(?:f{4}(?::0{1,4})?:)?(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)|(?:[\\da-f]{1,4}:){1,4}:(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d))$/iu;\n/**\n* [IP](https://en.wikipedia.org/wiki/IP_address) regex.\n*/\nconst IP_REGEX = /^(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])(?:\\.(?:(?:[1-9]|1\\d|2[0-4])?\\d|25[0-5])){3}$|^(?:(?:[\\da-f]{1,4}:){7}[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,7}:|(?:[\\da-f]{1,4}:){1,6}:[\\da-f]{1,4}|(?:[\\da-f]{1,4}:){1,5}(?::[\\da-f]{1,4}){1,2}|(?:[\\da-f]{1,4}:){1,4}(?::[\\da-f]{1,4}){1,3}|(?:[\\da-f]{1,4}:){1,3}(?::[\\da-f]{1,4}){1,4}|(?:[\\da-f]{1,4}:){1,2}(?::[\\da-f]{1,4}){1,5}|[\\da-f]{1,4}:(?::[\\da-f]{1,4}){1,6}|:(?:(?::[\\da-f]{1,4}){1,7}|:)|fe80:(?::[\\da-f]{0,4}){0,4}%[\\da-z]+|::(?:f{4}(?::0{1,4})?:)?(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)|(?:[\\da-f]{1,4}:){1,4}:(?:(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d)\\.){3}(?:25[0-5]|(?:2[0-4]|1?\\d)?\\d))$/iu;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) date regex.\n*/\nconst ISO_DATE_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])$/u;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) date-time regex.\n*/\nconst ISO_DATE_TIME_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])[T ](?:0\\d|1\\d|2[0-3]):[0-5]\\d$/u;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) time regex.\n*/\nconst ISO_TIME_REGEX = /^(?:0\\d|1\\d|2[0-3]):[0-5]\\d$/u;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) time with seconds regex.\n*/\nconst ISO_TIME_SECOND_REGEX = /^(?:0\\d|1\\d|2[0-3])(?::[0-5]\\d){2}$/u;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) timestamp regex.\n*/\nconst ISO_TIMESTAMP_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:[12]\\d|0[1-9]|3[01])[T ](?:0\\d|1\\d|2[0-3])(?::[0-5]\\d){2}(?:\\.\\d{1,9})?(?:Z|[+-](?:0\\d|1\\d|2[0-3])(?::?[0-5]\\d)?)$/u;\n/**\n* [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) week regex.\n*/\nconst ISO_WEEK_REGEX = /^\\d{4}-W(?:0[1-9]|[1-4]\\d|5[0-3])$/u;\n/**\n* [MAC](https://en.wikipedia.org/wiki/MAC_address) 48 bit regex.\n*/\nconst MAC48_REGEX = /^(?:[\\da-f]{2}:){5}[\\da-f]{2}$|^(?:[\\da-f]{2}-){5}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){2}[\\da-f]{4}$/iu;\n/**\n* [MAC](https://en.wikipedia.org/wiki/MAC_address) 64 bit regex.\n*/\nconst MAC64_REGEX = /^(?:[\\da-f]{2}:){7}[\\da-f]{2}$|^(?:[\\da-f]{2}-){7}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){3}[\\da-f]{4}$|^(?:[\\da-f]{4}:){3}[\\da-f]{4}$/iu;\n/**\n* [MAC](https://en.wikipedia.org/wiki/MAC_address) regex.\n*/\nconst MAC_REGEX = /^(?:[\\da-f]{2}:){5}[\\da-f]{2}$|^(?:[\\da-f]{2}-){5}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){2}[\\da-f]{4}$|^(?:[\\da-f]{2}:){7}[\\da-f]{2}$|^(?:[\\da-f]{2}-){7}[\\da-f]{2}$|^(?:[\\da-f]{4}\\.){3}[\\da-f]{4}$|^(?:[\\da-f]{4}:){3}[\\da-f]{4}$/iu;\n/**\n* [Nano ID](https://github.com/ai/nanoid) regex.\n*/\nconst NANO_ID_REGEX = /^[\\w-]+$/u;\n/**\n* [Octal](https://en.wikipedia.org/wiki/Octal) regex.\n*/\nconst OCTAL_REGEX = /^(?:0o)?[0-7]+$/u;\n/**\n* [RFC 5322 email address](https://datatracker.ietf.org/doc/html/rfc5322#section-3.4.1) regex.\n*\n* Hint: This regex was taken from the [HTML Living Standard Specification](https://html.spec.whatwg.org/multipage/input.html#valid-e-mail-address) and does not perfectly represent RFC 5322.\n*/\nconst RFC_EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n/**\n* [Slug](https://en.wikipedia.org/wiki/Clean_URL#Slug) regex.\n*/\nconst SLUG_REGEX = /^[\\da-z]+(?:[-_][\\da-z]+)*$/u;\n/**\n* [ULID](https://github.com/ulid/spec) regex.\n*\n* Hint: We decided against the `i` flag for better JSON Schema compatibility.\n*/\nconst ULID_REGEX = /^[\\da-hjkmnp-tv-zA-HJKMNP-TV-Z]{26}$/u;\n/**\n* [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier) regex.\n*/\nconst UUID_REGEX = /^[\\da-f]{8}(?:-[\\da-f]{4}){3}-[\\da-f]{12}$/iu;\n\n//#endregion\n//#region src/actions/base64/base64.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction base64(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"base64\",\n\t\treference: base64,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: BASE64_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"Base64\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/bic/bic.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction bic(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"bic\",\n\t\treference: bic,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: BIC_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"BIC\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/brand/brand.ts\n/**\n* Creates a brand transformation action.\n*\n* @param name The brand name.\n*\n* @returns A brand action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction brand(name) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"brand\",\n\t\treference: brand,\n\t\tasync: false,\n\t\tname,\n\t\t\"~run\"(dataset) {\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/bytes/bytes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction bytes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"bytes\",\n\t\treference: bytes,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst length$1 = /* @__PURE__ */ _getByteCount(dataset.value);\n\t\t\t\tif (length$1 !== this.requirement) _addIssue(this, \"bytes\", dataset, config$1, { received: `${length$1}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/check/check.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction check(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"check\",\n\t\treference: check,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"input\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/check/checkAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction checkAsync(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"check\",\n\t\treference: checkAsync,\n\t\tasync: true,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !await this.requirement(dataset.value)) _addIssue(this, \"input\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/checkItems/checkItems.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction checkItems(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"check_items\",\n\t\treference: checkItems,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) for (let index = 0; index < dataset.value.length; index++) {\n\t\t\t\tconst item = dataset.value[index];\n\t\t\t\tif (!this.requirement(item, index, dataset.value)) _addIssue(this, \"item\", dataset, config$1, {\n\t\t\t\t\tinput: item,\n\t\t\t\t\tpath: [{\n\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\tinput: dataset.value,\n\t\t\t\t\t\tkey: index,\n\t\t\t\t\t\tvalue: item\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/checkItems/checkItemsAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction checkItemsAsync(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"check_items\",\n\t\treference: checkItemsAsync,\n\t\tasync: true,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst requirementResults = await Promise.all(dataset.value.map(this.requirement));\n\t\t\t\tfor (let index = 0; index < dataset.value.length; index++) if (!requirementResults[index]) {\n\t\t\t\t\tconst item = dataset.value[index];\n\t\t\t\t\t_addIssue(this, \"item\", dataset, config$1, {\n\t\t\t\t\t\tinput: item,\n\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput: dataset.value,\n\t\t\t\t\t\t\tkey: index,\n\t\t\t\t\t\t\tvalue: item\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/creditCard/creditCard.ts\n/**\n* Credit card regex.\n*/\nconst CREDIT_CARD_REGEX = /^(?:\\d{14,19}|\\d{4}(?: \\d{3,6}){2,4}|\\d{4}(?:-\\d{3,6}){2,4})$/u;\n/**\n* Sanitize regex.\n*/\nconst SANITIZE_REGEX = /[- ]/gu;\n/**\n* Provider regex list.\n*/\nconst PROVIDER_REGEX_LIST = [\n\t/^3[47]\\d{13}$/u,\n\t/^3(?:0[0-5]|[68]\\d)\\d{11,13}$/u,\n\t/^6(?:011|5\\d{2})\\d{12,15}$/u,\n\t/^(?:2131|1800|35\\d{3})\\d{11}$/u,\n\t/^5[1-5]\\d{2}|(?:222\\d|22[3-9]\\d|2[3-6]\\d{2}|27[01]\\d|2720)\\d{12}$/u,\n\t/^(?:6[27]\\d{14,17}|81\\d{14,17})$/u,\n\t/^4\\d{12}(?:\\d{3,6})?$/u\n];\n/* @__NO_SIDE_EFFECTS__ */\nfunction creditCard(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"credit_card\",\n\t\treference: creditCard,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement(input) {\n\t\t\tlet sanitized;\n\t\t\treturn CREDIT_CARD_REGEX.test(input) && (sanitized = input.replace(SANITIZE_REGEX, \"\")) && PROVIDER_REGEX_LIST.some((regex$1) => regex$1.test(sanitized)) && /* @__PURE__ */ _isLuhnAlgo(sanitized);\n\t\t},\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"credit card\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/cuid2/cuid2.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction cuid2(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"cuid2\",\n\t\treference: cuid2,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: CUID2_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"Cuid2\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/decimal/decimal.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction decimal(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"decimal\",\n\t\treference: decimal,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: DECIMAL_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"decimal\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/description/description.ts\n/**\n* Creates a description metadata action.\n*\n* @param description_ The description text.\n*\n* @returns A description action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction description(description_) {\n\treturn {\n\t\tkind: \"metadata\",\n\t\ttype: \"description\",\n\t\treference: description,\n\t\tdescription: description_\n\t};\n}\n\n//#endregion\n//#region src/actions/digits/digits.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction digits(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"digits\",\n\t\treference: digits,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: DIGITS_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"digits\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/email/email.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction email(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"email\",\n\t\treference: email,\n\t\texpects: null,\n\t\tasync: false,\n\t\trequirement: EMAIL_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"email\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/emoji/emoji.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction emoji(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"emoji\",\n\t\treference: emoji,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: EMOJI_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"emoji\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/empty/empty.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction empty(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"empty\",\n\t\treference: empty,\n\t\tasync: false,\n\t\texpects: \"0\",\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length > 0) _addIssue(this, \"length\", dataset, config$1, { received: `${dataset.value.length}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/endsWith/endsWith.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction endsWith(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"ends_with\",\n\t\treference: endsWith,\n\t\tasync: false,\n\t\texpects: `\"${requirement}\"`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !dataset.value.endsWith(this.requirement)) _addIssue(this, \"end\", dataset, config$1, { received: `\"${dataset.value.slice(-this.requirement.length)}\"` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/entries/entries.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction entries(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"entries\",\n\t\treference: entries,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (!dataset.typed) return dataset;\n\t\t\tconst count = Object.keys(dataset.value).length;\n\t\t\tif (dataset.typed && count !== this.requirement) _addIssue(this, \"entries\", dataset, config$1, { received: `${count}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/everyItem/everyItem.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction everyItem(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"every_item\",\n\t\treference: everyItem,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !dataset.value.every(this.requirement)) _addIssue(this, \"item\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/examples/examples.ts\n/**\n* Creates an examples metadata action.\n*\n* @param examples_ The examples.\n*\n* @returns An examples action.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction examples(examples_) {\n\treturn {\n\t\tkind: \"metadata\",\n\t\ttype: \"examples\",\n\t\treference: examples,\n\t\texamples: examples_\n\t};\n}\n\n//#endregion\n//#region src/actions/excludes/excludes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction excludes(requirement, message$1) {\n\tconst received = /* @__PURE__ */ _stringify(requirement);\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"excludes\",\n\t\treference: excludes,\n\t\tasync: false,\n\t\texpects: `!${received}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.includes(this.requirement)) _addIssue(this, \"content\", dataset, config$1, { received });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/filterItems/filterItems.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction filterItems(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"filter_items\",\n\t\treference: filterItems,\n\t\tasync: false,\n\t\toperation,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.filter(this.operation);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/findItem/findItem.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction findItem(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"find_item\",\n\t\treference: findItem,\n\t\tasync: false,\n\t\toperation,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.find(this.operation);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/finite/finite.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction finite(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"finite\",\n\t\treference: finite,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: Number.isFinite,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"finite\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/flavor/flavor.ts\n/**\n* Creates a flavor transformation action.\n*\n* @param name The flavor name.\n*\n* @returns A flavor action.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction flavor(name) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"flavor\",\n\t\treference: flavor,\n\t\tasync: false,\n\t\tname,\n\t\t\"~run\"(dataset) {\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/graphemes/graphemes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction graphemes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"graphemes\",\n\t\treference: graphemes,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getGraphemeCount(dataset.value);\n\t\t\t\tif (count !== this.requirement) _addIssue(this, \"graphemes\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/gtValue/gtValue.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction gtValue(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"gt_value\",\n\t\treference: gtValue,\n\t\tasync: false,\n\t\texpects: `>${requirement instanceof Date ? requirement.toJSON() : /* @__PURE__ */ _stringify(requirement)}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !(dataset.value > this.requirement)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/hash/hash.ts\n/**\n* Hash lengths object.\n*/\nconst HASH_LENGTHS = {\n\tmd4: 32,\n\tmd5: 32,\n\tsha1: 40,\n\tsha256: 64,\n\tsha384: 96,\n\tsha512: 128,\n\tripemd128: 32,\n\tripemd160: 40,\n\ttiger128: 32,\n\ttiger160: 40,\n\ttiger192: 48,\n\tcrc32: 8,\n\tcrc32b: 8,\n\tadler32: 8\n};\n/* @__NO_SIDE_EFFECTS__ */\nfunction hash(types, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"hash\",\n\t\treference: hash,\n\t\texpects: null,\n\t\tasync: false,\n\t\trequirement: RegExp(types.map((type) => `^[a-f0-9]{${HASH_LENGTHS[type]}}$`).join(\"|\"), \"iu\"),\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"hash\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/hexadecimal/hexadecimal.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction hexadecimal(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"hexadecimal\",\n\t\treference: hexadecimal,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: HEXADECIMAL_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"hexadecimal\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/hexColor/hexColor.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction hexColor(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"hex_color\",\n\t\treference: hexColor,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: HEX_COLOR_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"hex color\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/imei/imei.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction imei(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"imei\",\n\t\treference: imei,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement(input) {\n\t\t\treturn IMEI_REGEX.test(input) && /* @__PURE__ */ _isLuhnAlgo(input);\n\t\t},\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"IMEI\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/includes/includes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction includes(requirement, message$1) {\n\tconst expects = /* @__PURE__ */ _stringify(requirement);\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"includes\",\n\t\treference: includes,\n\t\tasync: false,\n\t\texpects,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !dataset.value.includes(this.requirement)) _addIssue(this, \"content\", dataset, config$1, { received: `!${expects}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/integer/integer.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction integer(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"integer\",\n\t\treference: integer,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: Number.isInteger,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"integer\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/ip/ip.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction ip(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"ip\",\n\t\treference: ip,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: IP_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"IP\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/ipv4/ipv4.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction ipv4(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"ipv4\",\n\t\treference: ipv4,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: IPV4_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"IPv4\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/ipv6/ipv6.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction ipv6(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"ipv6\",\n\t\treference: ipv6,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: IPV6_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"IPv6\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoDate/isoDate.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoDate(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_date\",\n\t\treference: isoDate,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_DATE_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"date\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoDateTime/isoDateTime.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoDateTime(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_date_time\",\n\t\treference: isoDateTime,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_DATE_TIME_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"date-time\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoTime/isoTime.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoTime(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_time\",\n\t\treference: isoTime,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_TIME_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"time\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoTimeSecond/isoTimeSecond.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoTimeSecond(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_time_second\",\n\t\treference: isoTimeSecond,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_TIME_SECOND_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"time-second\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoTimestamp/isoTimestamp.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoTimestamp(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_timestamp\",\n\t\treference: isoTimestamp,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_TIMESTAMP_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"timestamp\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/isoWeek/isoWeek.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction isoWeek(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"iso_week\",\n\t\treference: isoWeek,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ISO_WEEK_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"week\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/length/length.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction length(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"length\",\n\t\treference: length,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length !== this.requirement) _addIssue(this, \"length\", dataset, config$1, { received: `${dataset.value.length}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/ltValue/ltValue.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction ltValue(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"lt_value\",\n\t\treference: ltValue,\n\t\tasync: false,\n\t\texpects: `<${requirement instanceof Date ? requirement.toJSON() : /* @__PURE__ */ _stringify(requirement)}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !(dataset.value < this.requirement)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/mac/mac.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mac(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"mac\",\n\t\treference: mac,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: MAC_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"MAC\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/mac48/mac48.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mac48(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"mac48\",\n\t\treference: mac48,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: MAC48_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"48-bit MAC\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/mac64/mac64.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mac64(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"mac64\",\n\t\treference: mac64,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: MAC64_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"64-bit MAC\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/mapItems/mapItems.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mapItems(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"map_items\",\n\t\treference: mapItems,\n\t\tasync: false,\n\t\toperation,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.map(this.operation);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxBytes/maxBytes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxBytes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_bytes\",\n\t\treference: maxBytes,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst length$1 = /* @__PURE__ */ _getByteCount(dataset.value);\n\t\t\t\tif (length$1 > this.requirement) _addIssue(this, \"bytes\", dataset, config$1, { received: `${length$1}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxEntries/maxEntries.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxEntries(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_entries\",\n\t\treference: maxEntries,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (!dataset.typed) return dataset;\n\t\t\tconst count = Object.keys(dataset.value).length;\n\t\t\tif (dataset.typed && count > this.requirement) _addIssue(this, \"entries\", dataset, config$1, { received: `${count}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxGraphemes/maxGraphemes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxGraphemes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_graphemes\",\n\t\treference: maxGraphemes,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getGraphemeCount(dataset.value);\n\t\t\t\tif (count > this.requirement) _addIssue(this, \"graphemes\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxLength/maxLength.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxLength(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_length\",\n\t\treference: maxLength,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length > this.requirement) _addIssue(this, \"length\", dataset, config$1, { received: `${dataset.value.length}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxSize/maxSize.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxSize(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_size\",\n\t\treference: maxSize,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.size > this.requirement) _addIssue(this, \"size\", dataset, config$1, { received: `${dataset.value.size}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxValue/maxValue.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxValue(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_value\",\n\t\treference: maxValue,\n\t\tasync: false,\n\t\texpects: `<=${requirement instanceof Date ? requirement.toJSON() : /* @__PURE__ */ _stringify(requirement)}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !(dataset.value <= this.requirement)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/maxWords/maxWords.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction maxWords(locales, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"max_words\",\n\t\treference: maxWords,\n\t\tasync: false,\n\t\texpects: `<=${requirement}`,\n\t\tlocales,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getWordCount(this.locales, dataset.value);\n\t\t\t\tif (count > this.requirement) _addIssue(this, \"words\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/metadata/metadata.ts\n/**\n* Creates a custom metadata action.\n*\n* @param metadata_ The metadata object.\n*\n* @returns A metadata action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction metadata(metadata_) {\n\treturn {\n\t\tkind: \"metadata\",\n\t\ttype: \"metadata\",\n\t\treference: metadata,\n\t\tmetadata: metadata_\n\t};\n}\n\n//#endregion\n//#region src/actions/mimeType/mimeType.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mimeType(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"mime_type\",\n\t\treference: mimeType,\n\t\tasync: false,\n\t\texpects: /* @__PURE__ */ _joinExpects(requirement.map((option) => `\"${option}\"`), \"|\"),\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.includes(dataset.value.type)) _addIssue(this, \"MIME type\", dataset, config$1, { received: `\"${dataset.value.type}\"` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minBytes/minBytes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minBytes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_bytes\",\n\t\treference: minBytes,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst length$1 = /* @__PURE__ */ _getByteCount(dataset.value);\n\t\t\t\tif (length$1 < this.requirement) _addIssue(this, \"bytes\", dataset, config$1, { received: `${length$1}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minEntries/minEntries.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minEntries(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_entries\",\n\t\treference: minEntries,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (!dataset.typed) return dataset;\n\t\t\tconst count = Object.keys(dataset.value).length;\n\t\t\tif (dataset.typed && count < this.requirement) _addIssue(this, \"entries\", dataset, config$1, { received: `${count}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minGraphemes/minGraphemes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minGraphemes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_graphemes\",\n\t\treference: minGraphemes,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getGraphemeCount(dataset.value);\n\t\t\t\tif (count < this.requirement) _addIssue(this, \"graphemes\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minLength/minLength.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minLength(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_length\",\n\t\treference: minLength,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length < this.requirement) _addIssue(this, \"length\", dataset, config$1, { received: `${dataset.value.length}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minSize/minSize.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minSize(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_size\",\n\t\treference: minSize,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.size < this.requirement) _addIssue(this, \"size\", dataset, config$1, { received: `${dataset.value.size}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minValue/minValue.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minValue(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_value\",\n\t\treference: minValue,\n\t\tasync: false,\n\t\texpects: `>=${requirement instanceof Date ? requirement.toJSON() : /* @__PURE__ */ _stringify(requirement)}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !(dataset.value >= this.requirement)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/minWords/minWords.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction minWords(locales, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"min_words\",\n\t\treference: minWords,\n\t\tasync: false,\n\t\texpects: `>=${requirement}`,\n\t\tlocales,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getWordCount(this.locales, dataset.value);\n\t\t\t\tif (count < this.requirement) _addIssue(this, \"words\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/multipleOf/multipleOf.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction multipleOf(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"multiple_of\",\n\t\treference: multipleOf,\n\t\tasync: false,\n\t\texpects: `%${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value % this.requirement != 0) _addIssue(this, \"multiple\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/nanoid/nanoid.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nanoid(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"nanoid\",\n\t\treference: nanoid,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: NANO_ID_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"Nano ID\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/nonEmpty/nonEmpty.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonEmpty(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"non_empty\",\n\t\treference: nonEmpty,\n\t\tasync: false,\n\t\texpects: \"!0\",\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length === 0) _addIssue(this, \"length\", dataset, config$1, { received: \"0\" });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/normalize/normalize.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction normalize(form) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"normalize\",\n\t\treference: normalize,\n\t\tasync: false,\n\t\tform,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.normalize(this.form);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notBytes/notBytes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notBytes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_bytes\",\n\t\treference: notBytes,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst length$1 = /* @__PURE__ */ _getByteCount(dataset.value);\n\t\t\t\tif (length$1 === this.requirement) _addIssue(this, \"bytes\", dataset, config$1, { received: `${length$1}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notEntries/notEntries.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notEntries(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_entries\",\n\t\treference: notEntries,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (!dataset.typed) return dataset;\n\t\t\tconst count = Object.keys(dataset.value).length;\n\t\t\tif (dataset.typed && count === this.requirement) _addIssue(this, \"entries\", dataset, config$1, { received: `${count}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notGraphemes/notGraphemes.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notGraphemes(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_graphemes\",\n\t\treference: notGraphemes,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getGraphemeCount(dataset.value);\n\t\t\t\tif (count === this.requirement) _addIssue(this, \"graphemes\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notLength/notLength.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notLength(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_length\",\n\t\treference: notLength,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.length === this.requirement) _addIssue(this, \"length\", dataset, config$1, { received: `${dataset.value.length}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notSize/notSize.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notSize(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_size\",\n\t\treference: notSize,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.size === this.requirement) _addIssue(this, \"size\", dataset, config$1, { received: `${dataset.value.size}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notValue/notValue.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notValue(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_value\",\n\t\treference: notValue,\n\t\tasync: false,\n\t\texpects: requirement instanceof Date ? `!${requirement.toJSON()}` : `!${/* @__PURE__ */ _stringify(requirement)}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && this.requirement <= dataset.value && this.requirement >= dataset.value) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notValues/notValues.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notValues(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_values\",\n\t\treference: notValues,\n\t\tasync: false,\n\t\texpects: `!${/* @__PURE__ */ _joinExpects(requirement.map((value$1) => value$1 instanceof Date ? value$1.toJSON() : /* @__PURE__ */ _stringify(value$1)), \"|\")}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && this.requirement.some((value$1) => value$1 <= dataset.value && value$1 >= dataset.value)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/notWords/notWords.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction notWords(locales, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"not_words\",\n\t\treference: notWords,\n\t\tasync: false,\n\t\texpects: `!${requirement}`,\n\t\tlocales,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getWordCount(this.locales, dataset.value);\n\t\t\t\tif (count === this.requirement) _addIssue(this, \"words\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/octal/octal.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction octal(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"octal\",\n\t\treference: octal,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: OCTAL_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"octal\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/parseJson/parseJson.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction parseJson(config$1, message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"parse_json\",\n\t\treference: parseJson,\n\t\tconfig: config$1,\n\t\tmessage: message$1,\n\t\tasync: false,\n\t\t\"~run\"(dataset, config$2) {\n\t\t\ttry {\n\t\t\t\tdataset.value = JSON.parse(dataset.value, this.config?.reviver);\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof Error) {\n\t\t\t\t\t_addIssue(this, \"JSON\", dataset, config$2, { received: `\"${error.message}\"` });\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t} else throw error;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/partialCheck/utils/_isPartiallyTyped/_isPartiallyTyped.ts\n/**\n* Checks if a dataset is partially typed.\n*\n* @param dataset The dataset to check.\n* @param paths The paths to check.\n*\n* @returns Whether it is partially typed.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _isPartiallyTyped(dataset, paths) {\n\tif (dataset.issues) for (const path of paths) for (const issue of dataset.issues) {\n\t\tlet typed = false;\n\t\tconst bound = Math.min(path.length, issue.path?.length ?? 0);\n\t\tfor (let index = 0; index < bound; index++) if (path[index] !== issue.path[index].key && (path[index] !== \"$\" || issue.path[index].type !== \"array\")) {\n\t\t\ttyped = true;\n\t\t\tbreak;\n\t\t}\n\t\tif (!typed) return false;\n\t}\n\treturn true;\n}\n\n//#endregion\n//#region src/actions/partialCheck/partialCheck.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction partialCheck(paths, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"partial_check\",\n\t\treference: partialCheck,\n\t\tasync: false,\n\t\texpects: null,\n\t\tpaths,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif ((dataset.typed || /* @__PURE__ */ _isPartiallyTyped(dataset, paths)) && !this.requirement(dataset.value)) _addIssue(this, \"input\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/partialCheck/partialCheckAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction partialCheckAsync(paths, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"partial_check\",\n\t\treference: partialCheckAsync,\n\t\tasync: true,\n\t\texpects: null,\n\t\tpaths,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif ((dataset.typed || /* @__PURE__ */ _isPartiallyTyped(dataset, paths)) && !await this.requirement(dataset.value)) _addIssue(this, \"input\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/rawCheck/rawCheck.ts\n/**\n* Creates a raw check validation action.\n*\n* @param action The validation action.\n*\n* @returns A raw check action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction rawCheck(action) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"raw_check\",\n\t\treference: rawCheck,\n\t\tasync: false,\n\t\texpects: null,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\taction({\n\t\t\t\tdataset,\n\t\t\t\tconfig: config$1,\n\t\t\t\taddIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config$1, info)\n\t\t\t});\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/rawCheck/rawCheckAsync.ts\n/**\n* Creates a raw check validation action.\n*\n* @param action The validation action.\n*\n* @returns A raw check action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction rawCheckAsync(action) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"raw_check\",\n\t\treference: rawCheckAsync,\n\t\tasync: true,\n\t\texpects: null,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tawait action({\n\t\t\t\tdataset,\n\t\t\t\tconfig: config$1,\n\t\t\t\taddIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config$1, info)\n\t\t\t});\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/rawTransform/rawTransform.ts\n/**\n* Creates a raw transformation action.\n*\n* @param action The transformation action.\n*\n* @returns A raw transform action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction rawTransform(action) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"raw_transform\",\n\t\treference: rawTransform,\n\t\tasync: false,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst output = action({\n\t\t\t\tdataset,\n\t\t\t\tconfig: config$1,\n\t\t\t\taddIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config$1, info),\n\t\t\t\tNEVER: null\n\t\t\t});\n\t\t\tif (dataset.issues) dataset.typed = false;\n\t\t\telse dataset.value = output;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/rawTransform/rawTransformAsync.ts\n/**\n* Creates a raw transformation action.\n*\n* @param action The transformation action.\n*\n* @returns A raw transform action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction rawTransformAsync(action) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"raw_transform\",\n\t\treference: rawTransformAsync,\n\t\tasync: true,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst output = await action({\n\t\t\t\tdataset,\n\t\t\t\tconfig: config$1,\n\t\t\t\taddIssue: (info) => _addIssue(this, info?.label ?? \"input\", dataset, config$1, info),\n\t\t\t\tNEVER: null\n\t\t\t});\n\t\t\tif (dataset.issues) dataset.typed = false;\n\t\t\telse dataset.value = output;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/readonly/readonly.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction readonly() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"readonly\",\n\t\treference: readonly,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/reduceItems/reduceItems.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction reduceItems(operation, initial) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"reduce_items\",\n\t\treference: reduceItems,\n\t\tasync: false,\n\t\toperation,\n\t\tinitial,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.reduce(this.operation, this.initial);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/regex/regex.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction regex(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"regex\",\n\t\treference: regex,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"format\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/returns/returns.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction returns(schema) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"returns\",\n\t\treference: returns,\n\t\tasync: false,\n\t\tschema,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst func = dataset.value;\n\t\t\tdataset.value = (...args_) => {\n\t\t\t\tconst returnsDataset = this.schema[\"~run\"]({ value: func(...args_) }, config$1);\n\t\t\t\tif (returnsDataset.issues) throw new ValiError(returnsDataset.issues);\n\t\t\t\treturn returnsDataset.value;\n\t\t\t};\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/returns/returnsAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction returnsAsync(schema) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"returns\",\n\t\treference: returnsAsync,\n\t\tasync: false,\n\t\tschema,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst func = dataset.value;\n\t\t\tdataset.value = async (...args_) => {\n\t\t\t\tconst returnsDataset = await this.schema[\"~run\"]({ value: await func(...args_) }, config$1);\n\t\t\t\tif (returnsDataset.issues) throw new ValiError(returnsDataset.issues);\n\t\t\t\treturn returnsDataset.value;\n\t\t\t};\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/rfcEmail/rfcEmail.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction rfcEmail(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"rfc_email\",\n\t\treference: rfcEmail,\n\t\texpects: null,\n\t\tasync: false,\n\t\trequirement: RFC_EMAIL_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"email\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/safeInteger/safeInteger.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction safeInteger(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"safe_integer\",\n\t\treference: safeInteger,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: Number.isSafeInteger,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"safe integer\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/size/size.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction size(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"size\",\n\t\treference: size,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && dataset.value.size !== this.requirement) _addIssue(this, \"size\", dataset, config$1, { received: `${dataset.value.size}` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/slug/slug.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction slug(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"slug\",\n\t\treference: slug,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: SLUG_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"slug\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/someItem/someItem.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction someItem(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"some_item\",\n\t\treference: someItem,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !dataset.value.some(this.requirement)) _addIssue(this, \"item\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/sortItems/sortItems.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction sortItems(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"sort_items\",\n\t\treference: sortItems,\n\t\tasync: false,\n\t\toperation,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.sort(this.operation);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/startsWith/startsWith.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction startsWith(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"starts_with\",\n\t\treference: startsWith,\n\t\tasync: false,\n\t\texpects: `\"${requirement}\"`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !dataset.value.startsWith(this.requirement)) _addIssue(this, \"start\", dataset, config$1, { received: `\"${dataset.value.slice(0, this.requirement.length)}\"` });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/stringifyJson/stringifyJson.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction stringifyJson(config$1, message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"stringify_json\",\n\t\treference: stringifyJson,\n\t\tmessage: message$1,\n\t\tconfig: config$1,\n\t\tasync: false,\n\t\t\"~run\"(dataset, config$2) {\n\t\t\ttry {\n\t\t\t\tconst output = JSON.stringify(dataset.value, this.config?.replacer, this.config?.space);\n\t\t\t\tif (output === void 0) {\n\t\t\t\t\t_addIssue(this, \"JSON\", dataset, config$2);\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t}\n\t\t\t\tdataset.value = output;\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof Error) {\n\t\t\t\t\t_addIssue(this, \"JSON\", dataset, config$2, { received: `\"${error.message}\"` });\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t} else throw error;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/title/title.ts\n/**\n* Creates a title metadata action.\n*\n* @param title_ The title text.\n*\n* @returns A title action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction title(title_) {\n\treturn {\n\t\tkind: \"metadata\",\n\t\ttype: \"title\",\n\t\treference: title,\n\t\ttitle: title_\n\t};\n}\n\n//#endregion\n//#region src/actions/toBigint/toBigint.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction toBigint(message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_bigint\",\n\t\treference: toBigint,\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\ttry {\n\t\t\t\tdataset.value = BigInt(dataset.value);\n\t\t\t} catch {\n\t\t\t\t_addIssue(this, \"bigint\", dataset, config$1);\n\t\t\t\tdataset.typed = false;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toBoolean/toBoolean.ts\n/**\n* Creates a to boolean transformation action.\n*\n* @returns A to boolean action.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction toBoolean() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_boolean\",\n\t\treference: toBoolean,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = Boolean(dataset.value);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toDate/toDate.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction toDate(message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_date\",\n\t\treference: toDate,\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\ttry {\n\t\t\t\tdataset.value = new Date(dataset.value);\n\t\t\t\tif (isNaN(dataset.value)) {\n\t\t\t\t\t_addIssue(this, \"date\", dataset, config$1, { received: \"\\\"Invalid Date\\\"\" });\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t_addIssue(this, \"date\", dataset, config$1);\n\t\t\t\tdataset.typed = false;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toLowerCase/toLowerCase.ts\n/**\n* Creates a to lower case transformation action.\n*\n* @returns A to lower case action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction toLowerCase() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_lower_case\",\n\t\treference: toLowerCase,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.toLowerCase();\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toMaxValue/toMaxValue.ts\n/**\n* Creates a to max value transformation action.\n*\n* @param requirement The maximum value.\n*\n* @returns A to max value action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction toMaxValue(requirement) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_max_value\",\n\t\treference: toMaxValue,\n\t\tasync: false,\n\t\trequirement,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value > this.requirement ? this.requirement : dataset.value;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toMinValue/toMinValue.ts\n/**\n* Creates a to min value transformation action.\n*\n* @param requirement The minimum value.\n*\n* @returns A to min value action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction toMinValue(requirement) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_min_value\",\n\t\treference: toMinValue,\n\t\tasync: false,\n\t\trequirement,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value < this.requirement ? this.requirement : dataset.value;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toNumber/toNumber.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction toNumber(message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_number\",\n\t\treference: toNumber,\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\ttry {\n\t\t\t\tdataset.value = Number(dataset.value);\n\t\t\t\tif (isNaN(dataset.value)) {\n\t\t\t\t\t_addIssue(this, \"number\", dataset, config$1);\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t_addIssue(this, \"number\", dataset, config$1);\n\t\t\t\tdataset.typed = false;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toString/toString.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction toString(message$1) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_string\",\n\t\treference: toString,\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\ttry {\n\t\t\t\tdataset.value = String(dataset.value);\n\t\t\t} catch {\n\t\t\t\t_addIssue(this, \"string\", dataset, config$1);\n\t\t\t\tdataset.typed = false;\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/toUpperCase/toUpperCase.ts\n/**\n* Creates a to upper case transformation action.\n*\n* @returns A to upper case action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction toUpperCase() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"to_upper_case\",\n\t\treference: toUpperCase,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.toUpperCase();\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/transform/transform.ts\n/**\n* Creates a custom transformation action.\n*\n* @param operation The transformation operation.\n*\n* @returns A transform action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction transform(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"transform\",\n\t\treference: transform,\n\t\tasync: false,\n\t\toperation,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = this.operation(dataset.value);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/transform/transformAsync.ts\n/**\n* Creates a custom transformation action.\n*\n* @param operation The transformation operation.\n*\n* @returns A transform action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction transformAsync(operation) {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"transform\",\n\t\treference: transformAsync,\n\t\tasync: true,\n\t\toperation,\n\t\tasync \"~run\"(dataset) {\n\t\t\tdataset.value = await this.operation(dataset.value);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/trim/trim.ts\n/**\n* Creates a trim transformation action.\n*\n* @returns A trim action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction trim() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"trim\",\n\t\treference: trim,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.trim();\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/trimEnd/trimEnd.ts\n/**\n* Creates a trim end transformation action.\n*\n* @returns A trim end action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction trimEnd() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"trim_end\",\n\t\treference: trimEnd,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.trimEnd();\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/trimStart/trimStart.ts\n/**\n* Creates a trim start transformation action.\n*\n* @returns A trim start action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction trimStart() {\n\treturn {\n\t\tkind: \"transformation\",\n\t\ttype: \"trim_start\",\n\t\treference: trimStart,\n\t\tasync: false,\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.value = dataset.value.trimStart();\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/ulid/ulid.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction ulid(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"ulid\",\n\t\treference: ulid,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: ULID_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"ULID\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/url/url.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction url(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"url\",\n\t\treference: url,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement(input) {\n\t\t\ttry {\n\t\t\t\tnew URL(input);\n\t\t\t\treturn true;\n\t\t\t} catch {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement(dataset.value)) _addIssue(this, \"URL\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/uuid/uuid.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction uuid(message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"uuid\",\n\t\treference: uuid,\n\t\tasync: false,\n\t\texpects: null,\n\t\trequirement: UUID_REGEX,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.test(dataset.value)) _addIssue(this, \"UUID\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/value/value.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction value(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"value\",\n\t\treference: value,\n\t\tasync: false,\n\t\texpects: requirement instanceof Date ? requirement.toJSON() : /* @__PURE__ */ _stringify(requirement),\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !(this.requirement <= dataset.value && this.requirement >= dataset.value)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/values/values.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction values(requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"values\",\n\t\treference: values,\n\t\tasync: false,\n\t\texpects: `${/* @__PURE__ */ _joinExpects(requirement.map((value$1) => value$1 instanceof Date ? value$1.toJSON() : /* @__PURE__ */ _stringify(value$1)), \"|\")}`,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed && !this.requirement.some((value$1) => value$1 <= dataset.value && value$1 >= dataset.value)) _addIssue(this, \"value\", dataset, config$1, { received: dataset.value instanceof Date ? dataset.value.toJSON() : /* @__PURE__ */ _stringify(dataset.value) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/actions/words/words.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction words(locales, requirement, message$1) {\n\treturn {\n\t\tkind: \"validation\",\n\t\ttype: \"words\",\n\t\treference: words,\n\t\tasync: false,\n\t\texpects: `${requirement}`,\n\t\tlocales,\n\t\trequirement,\n\t\tmessage: message$1,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.typed) {\n\t\t\t\tconst count = /* @__PURE__ */ _getWordCount(this.locales, dataset.value);\n\t\t\t\tif (count !== this.requirement) _addIssue(this, \"words\", dataset, config$1, { received: `${count}` });\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/assert/assert.ts\n/**\n* Checks if the input matches the schema. As this is an assertion function, it\n* can be used as a type guard.\n*\n* @param schema The schema to be used.\n* @param input The input to be tested.\n*/\nfunction assert(schema, input) {\n\tconst issues = schema[\"~run\"]({ value: input }, { abortEarly: true }).issues;\n\tif (issues) throw new ValiError(issues);\n}\n\n//#endregion\n//#region src/methods/config/config.ts\n/**\n* Changes the local configuration of a schema.\n*\n* @param schema The schema to configure.\n* @param config The parse configuration.\n*\n* @returns The configured schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction config(schema, config$1) {\n\treturn {\n\t\t...schema,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config_) {\n\t\t\treturn schema[\"~run\"](dataset, {\n\t\t\t\t...config_,\n\t\t\t\t...config$1\n\t\t\t});\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/getFallback/getFallback.ts\n/**\n* Returns the fallback value of the schema.\n*\n* @param schema The schema to get it from.\n* @param dataset The output dataset if available.\n* @param config The config if available.\n*\n* @returns The fallback value.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getFallback(schema, dataset, config$1) {\n\treturn typeof schema.fallback === \"function\" ? schema.fallback(dataset, config$1) : schema.fallback;\n}\n\n//#endregion\n//#region src/methods/fallback/fallback.ts\n/**\n* Returns a fallback value as output if the input does not match the schema.\n*\n* @param schema The schema to catch.\n* @param fallback The fallback value.\n*\n* @returns The passed schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction fallback(schema, fallback$1) {\n\treturn {\n\t\t...schema,\n\t\tfallback: fallback$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst outputDataset = schema[\"~run\"](dataset, config$1);\n\t\t\treturn outputDataset.issues ? {\n\t\t\t\ttyped: true,\n\t\t\t\tvalue: /* @__PURE__ */ getFallback(this, outputDataset, config$1)\n\t\t\t} : outputDataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/fallback/fallbackAsync.ts\n/**\n* Returns a fallback value as output if the input does not match the schema.\n*\n* @param schema The schema to catch.\n* @param fallback The fallback value.\n*\n* @returns The passed schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction fallbackAsync(schema, fallback$1) {\n\treturn {\n\t\t...schema,\n\t\tfallback: fallback$1,\n\t\tasync: true,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst outputDataset = await schema[\"~run\"](dataset, config$1);\n\t\t\treturn outputDataset.issues ? {\n\t\t\t\ttyped: true,\n\t\t\t\tvalue: await /* @__PURE__ */ getFallback(this, outputDataset, config$1)\n\t\t\t} : outputDataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/flatten/flatten.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction flatten(issues) {\n\tconst flatErrors = {};\n\tfor (const issue of issues) if (issue.path) {\n\t\tconst dotPath = /* @__PURE__ */ getDotPath(issue);\n\t\tif (dotPath) {\n\t\t\tif (!flatErrors.nested) flatErrors.nested = {};\n\t\t\tif (flatErrors.nested[dotPath]) flatErrors.nested[dotPath].push(issue.message);\n\t\t\telse flatErrors.nested[dotPath] = [issue.message];\n\t\t} else if (flatErrors.other) flatErrors.other.push(issue.message);\n\t\telse flatErrors.other = [issue.message];\n\t} else if (flatErrors.root) flatErrors.root.push(issue.message);\n\telse flatErrors.root = [issue.message];\n\treturn flatErrors;\n}\n\n//#endregion\n//#region src/methods/forward/forward.ts\n/**\n* Forwards the issues of the passed validation action.\n*\n* @param action The validation action.\n* @param path The path to forward the issues to.\n*\n* @returns The modified action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction forward(action, path) {\n\treturn {\n\t\t...action,\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst prevIssues = dataset.issues && [...dataset.issues];\n\t\t\tdataset = action[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.issues) {\n\t\t\t\tfor (const issue of dataset.issues) if (!prevIssues?.includes(issue)) {\n\t\t\t\t\tlet pathInput = dataset.value;\n\t\t\t\t\tfor (const key of path) {\n\t\t\t\t\t\tconst pathValue = pathInput[key];\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput: pathInput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: pathValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tif (issue.path) issue.path.push(pathItem);\n\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\tif (!pathValue) break;\n\t\t\t\t\t\tpathInput = pathValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/forward/forwardAsync.ts\n/**\n* Forwards the issues of the passed validation action.\n*\n* @param action The validation action.\n* @param path The path to forward the issues to.\n*\n* @returns The modified action.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction forwardAsync(action, path) {\n\treturn {\n\t\t...action,\n\t\tasync: true,\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst prevIssues = dataset.issues && [...dataset.issues];\n\t\t\tdataset = await action[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.issues) {\n\t\t\t\tfor (const issue of dataset.issues) if (!prevIssues?.includes(issue)) {\n\t\t\t\t\tlet pathInput = dataset.value;\n\t\t\t\t\tfor (const key of path) {\n\t\t\t\t\t\tconst pathValue = pathInput[key];\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput: pathInput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: pathValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tif (issue.path) issue.path.push(pathItem);\n\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\tif (!pathValue) break;\n\t\t\t\t\t\tpathInput = pathValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/getDefault/getDefault.ts\n/**\n* Returns the default value of the schema.\n*\n* @param schema The schema to get it from.\n* @param dataset The input dataset if available.\n* @param config The config if available.\n*\n* @returns The default value.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getDefault(schema, dataset, config$1) {\n\treturn typeof schema.default === \"function\" ? schema.default(dataset, config$1) : schema.default;\n}\n\n//#endregion\n//#region src/methods/getDefaults/getDefaults.ts\n/**\n* Returns the default values of the schema.\n*\n* Hint: The difference to `getDefault` is that for object and tuple schemas\n* this function recursively returns the default values of the subschemas\n* instead of `undefined`.\n*\n* @param schema The schema to get them from.\n*\n* @returns The default values.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getDefaults(schema) {\n\tif (\"entries\" in schema) {\n\t\tconst object$1 = {};\n\t\tfor (const key in schema.entries) object$1[key] = /* @__PURE__ */ getDefaults(schema.entries[key]);\n\t\treturn object$1;\n\t}\n\tif (\"items\" in schema) return schema.items.map(getDefaults);\n\treturn /* @__PURE__ */ getDefault(schema);\n}\n\n//#endregion\n//#region src/methods/getDefaults/getDefaultsAsync.ts\n/**\n* Returns the default values of the schema.\n*\n* Hint: The difference to `getDefault` is that for object and tuple schemas\n* this function recursively returns the default values of the subschemas\n* instead of `undefined`.\n*\n* @param schema The schema to get them from.\n*\n* @returns The default values.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nasync function getDefaultsAsync(schema) {\n\tif (\"entries\" in schema) return Object.fromEntries(await Promise.all(Object.entries(schema.entries).map(async ([key, value$1]) => [key, await /* @__PURE__ */ getDefaultsAsync(value$1)])));\n\tif (\"items\" in schema) return Promise.all(schema.items.map(getDefaultsAsync));\n\treturn /* @__PURE__ */ getDefault(schema);\n}\n\n//#endregion\n//#region src/methods/getDescription/getDescription.ts\n/**\n* Returns the description of the schema.\n*\n* If multiple descriptions are defined, the last one of the highest level is\n* returned. If no description is defined, `undefined` is returned.\n*\n* @param schema The schema to get the description from.\n*\n* @returns The description, if any.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getDescription(schema) {\n\treturn /* @__PURE__ */ _getLastMetadata(schema, \"description\");\n}\n\n//#endregion\n//#region src/methods/getExamples/getExamples.ts\n/**\n* Returns the examples of a schema.\n*\n* If multiple examples are defined, it concatenates them using depth-first\n* search. If no examples are defined, an empty array is returned.\n*\n* @param schema The schema to get the examples from.\n*\n* @returns The examples, if any.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getExamples(schema) {\n\tconst examples$1 = [];\n\tfunction depthFirstCollect(schema$1) {\n\t\tif (\"pipe\" in schema$1) {\n\t\t\tfor (const item of schema$1.pipe) if (item.kind === \"schema\" && \"pipe\" in item) depthFirstCollect(item);\n\t\t\telse if (item.kind === \"metadata\" && item.type === \"examples\") examples$1.push(...item.examples);\n\t\t}\n\t}\n\tdepthFirstCollect(schema);\n\treturn examples$1;\n}\n\n//#endregion\n//#region src/methods/getFallbacks/getFallbacks.ts\n/**\n* Returns the fallback values of the schema.\n*\n* Hint: The difference to `getFallback` is that for object and tuple schemas\n* this function recursively returns the fallback values of the subschemas\n* instead of `undefined`.\n*\n* @param schema The schema to get them from.\n*\n* @returns The fallback values.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getFallbacks(schema) {\n\tif (\"entries\" in schema) {\n\t\tconst object$1 = {};\n\t\tfor (const key in schema.entries) object$1[key] = /* @__PURE__ */ getFallbacks(schema.entries[key]);\n\t\treturn object$1;\n\t}\n\tif (\"items\" in schema) return schema.items.map(getFallbacks);\n\treturn /* @__PURE__ */ getFallback(schema);\n}\n\n//#endregion\n//#region src/methods/getFallbacks/getFallbacksAsync.ts\n/**\n* Returns the fallback values of the schema.\n*\n* Hint: The difference to `getFallback` is that for object and tuple schemas\n* this function recursively returns the fallback values of the subschemas\n* instead of `undefined`.\n*\n* @param schema The schema to get them from.\n*\n* @returns The fallback values.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nasync function getFallbacksAsync(schema) {\n\tif (\"entries\" in schema) return Object.fromEntries(await Promise.all(Object.entries(schema.entries).map(async ([key, value$1]) => [key, await /* @__PURE__ */ getFallbacksAsync(value$1)])));\n\tif (\"items\" in schema) return Promise.all(schema.items.map(getFallbacksAsync));\n\treturn /* @__PURE__ */ getFallback(schema);\n}\n\n//#endregion\n//#region src/methods/getMetadata/getMetadata.ts\n/**\n* Returns the metadata of a schema.\n*\n* If multiple metadata are defined, it shallowly merges them using depth-first\n* search. If no metadata is defined, an empty object is returned.\n*\n* @param schema Schema to get the metadata from.\n*\n* @returns The metadata, if any.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getMetadata(schema) {\n\tconst result = {};\n\tfunction depthFirstMerge(schema$1) {\n\t\tif (\"pipe\" in schema$1) {\n\t\t\tfor (const item of schema$1.pipe) if (item.kind === \"schema\" && \"pipe\" in item) depthFirstMerge(item);\n\t\t\telse if (item.kind === \"metadata\" && item.type === \"metadata\") Object.assign(result, item.metadata);\n\t\t}\n\t}\n\tdepthFirstMerge(schema);\n\treturn result;\n}\n\n//#endregion\n//#region src/methods/getTitle/getTitle.ts\n/**\n* Returns the title of the schema.\n*\n* If multiple titles are defined, the last one of the highest level is\n* returned. If no title is defined, `undefined` is returned.\n*\n* @param schema The schema to get the title from.\n*\n* @returns The title, if any.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction getTitle(schema) {\n\treturn /* @__PURE__ */ _getLastMetadata(schema, \"title\");\n}\n\n//#endregion\n//#region src/methods/is/is.ts\n/**\n* Checks if the input matches the schema. By using a type predicate, this\n* function can be used as a type guard.\n*\n* @param schema The schema to be used.\n* @param input The input to be tested.\n*\n* @returns Whether the input matches the schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction is(schema, input) {\n\treturn !schema[\"~run\"]({ value: input }, { abortEarly: true }).issues;\n}\n\n//#endregion\n//#region src/schemas/any/any.ts\n/**\n* Creates an any schema.\n*\n* Hint: This schema function exists only for completeness and is not\n* recommended in practice. Instead, `unknown` should be used to accept\n* unknown data.\n*\n* @returns An any schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction any() {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"any\",\n\t\treference: any,\n\t\texpects: \"any\",\n\t\tasync: false,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.typed = true;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/array/array.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction array(item, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"array\",\n\t\treference: array,\n\t\texpects: \"Array\",\n\t\tasync: false,\n\t\titem,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tfor (let key = 0; key < input.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.item[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/array/arrayAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction arrayAsync(item, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"array\",\n\t\treference: arrayAsync,\n\t\texpects: \"Array\",\n\t\tasync: true,\n\t\titem,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tconst itemDatasets = await Promise.all(input.map((value$1) => this.item[\"~run\"]({ value: value$1 }, config$1)));\n\t\t\t\tfor (let key = 0; key < itemDatasets.length; key++) {\n\t\t\t\t\tconst itemDataset = itemDatasets[key];\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/bigint/bigint.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction bigint(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"bigint\",\n\t\treference: bigint,\n\t\texpects: \"bigint\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"bigint\") dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/blob/blob.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction blob(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"blob\",\n\t\treference: blob,\n\t\texpects: \"Blob\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value instanceof Blob) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/boolean/boolean.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction boolean(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"boolean\",\n\t\treference: boolean,\n\t\texpects: \"boolean\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"boolean\") dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/custom/custom.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction custom(check$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"custom\",\n\t\treference: custom,\n\t\texpects: \"unknown\",\n\t\tasync: false,\n\t\tcheck: check$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (this.check(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/custom/customAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction customAsync(check$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"custom\",\n\t\treference: customAsync,\n\t\texpects: \"unknown\",\n\t\tasync: true,\n\t\tcheck: check$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (await this.check(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/date/date.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction date(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"date\",\n\t\treference: date,\n\t\texpects: \"Date\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value instanceof Date) if (!isNaN(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1, { received: \"\\\"Invalid Date\\\"\" });\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/enum/enum.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction enum_(enum__, message$1) {\n\tconst options = [];\n\tfor (const key in enum__) if (`${+key}` !== key || typeof enum__[key] !== \"string\" || !Object.is(enum__[enum__[key]], +key)) options.push(enum__[key]);\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"enum\",\n\t\treference: enum_,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map(_stringify), \"|\"),\n\t\tasync: false,\n\t\tenum: enum__,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (this.options.includes(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/exactOptional/exactOptional.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction exactOptional(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"exact_optional\",\n\t\treference: exactOptional,\n\t\texpects: wrapped.expects,\n\t\tasync: false,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/exactOptional/exactOptionalAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction exactOptionalAsync(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"exact_optional\",\n\t\treference: exactOptionalAsync,\n\t\texpects: wrapped.expects,\n\t\tasync: true,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/file/file.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction file(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"file\",\n\t\treference: file,\n\t\texpects: \"File\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value instanceof File) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/function/function.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction function_(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"function\",\n\t\treference: function_,\n\t\texpects: \"Function\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"function\") dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/instance/instance.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction instance(class_, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"instance\",\n\t\treference: instance,\n\t\texpects: class_.name,\n\t\tasync: false,\n\t\tclass: class_,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value instanceof this.class) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/intersect/utils/_merge/_merge.ts\n/**\n* Merges two values into one single output.\n*\n* @param value1 First value.\n* @param value2 Second value.\n*\n* @returns The merge dataset.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _merge(value1, value2) {\n\tif (typeof value1 === typeof value2) {\n\t\tif (value1 === value2 || value1 instanceof Date && value2 instanceof Date && +value1 === +value2) return { value: value1 };\n\t\tif (value1 && value2 && value1.constructor === Object && value2.constructor === Object) {\n\t\t\tfor (const key in value2) if (key in value1) {\n\t\t\t\tconst dataset = /* @__PURE__ */ _merge(value1[key], value2[key]);\n\t\t\t\tif (dataset.issue) return dataset;\n\t\t\t\tvalue1[key] = dataset.value;\n\t\t\t} else value1[key] = value2[key];\n\t\t\treturn { value: value1 };\n\t\t}\n\t\tif (Array.isArray(value1) && Array.isArray(value2)) {\n\t\t\tif (value1.length === value2.length) {\n\t\t\t\tfor (let index = 0; index < value1.length; index++) {\n\t\t\t\t\tconst dataset = /* @__PURE__ */ _merge(value1[index], value2[index]);\n\t\t\t\t\tif (dataset.issue) return dataset;\n\t\t\t\t\tvalue1[index] = dataset.value;\n\t\t\t\t}\n\t\t\t\treturn { value: value1 };\n\t\t\t}\n\t\t}\n\t}\n\treturn { issue: true };\n}\n\n//#endregion\n//#region src/schemas/intersect/intersect.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction intersect(options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"intersect\",\n\t\treference: intersect,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map((option) => option.expects), \"&\"),\n\t\tasync: false,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (this.options.length) {\n\t\t\t\tconst input = dataset.value;\n\t\t\t\tlet outputs;\n\t\t\t\tdataset.typed = true;\n\t\t\t\tfor (const schema of this.options) {\n\t\t\t\t\tconst optionDataset = schema[\"~run\"]({ value: input }, config$1);\n\t\t\t\t\tif (optionDataset.issues) {\n\t\t\t\t\t\tif (dataset.issues) dataset.issues.push(...optionDataset.issues);\n\t\t\t\t\t\telse dataset.issues = optionDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!optionDataset.typed) dataset.typed = false;\n\t\t\t\t\tif (dataset.typed) if (outputs) outputs.push(optionDataset.value);\n\t\t\t\t\telse outputs = [optionDataset.value];\n\t\t\t\t}\n\t\t\t\tif (dataset.typed) {\n\t\t\t\t\tdataset.value = outputs[0];\n\t\t\t\t\tfor (let index = 1; index < outputs.length; index++) {\n\t\t\t\t\t\tconst mergeDataset = /* @__PURE__ */ _merge(dataset.value, outputs[index]);\n\t\t\t\t\t\tif (mergeDataset.issue) {\n\t\t\t\t\t\t\t_addIssue(this, \"type\", dataset, config$1, { received: \"unknown\" });\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdataset.value = mergeDataset.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/intersect/intersectAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction intersectAsync(options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"intersect\",\n\t\treference: intersectAsync,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map((option) => option.expects), \"&\"),\n\t\tasync: true,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (this.options.length) {\n\t\t\t\tconst input = dataset.value;\n\t\t\t\tlet outputs;\n\t\t\t\tdataset.typed = true;\n\t\t\t\tconst optionDatasets = await Promise.all(this.options.map((schema) => schema[\"~run\"]({ value: input }, config$1)));\n\t\t\t\tfor (const optionDataset of optionDatasets) {\n\t\t\t\t\tif (optionDataset.issues) {\n\t\t\t\t\t\tif (dataset.issues) dataset.issues.push(...optionDataset.issues);\n\t\t\t\t\t\telse dataset.issues = optionDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!optionDataset.typed) dataset.typed = false;\n\t\t\t\t\tif (dataset.typed) if (outputs) outputs.push(optionDataset.value);\n\t\t\t\t\telse outputs = [optionDataset.value];\n\t\t\t\t}\n\t\t\t\tif (dataset.typed) {\n\t\t\t\t\tdataset.value = outputs[0];\n\t\t\t\t\tfor (let index = 1; index < outputs.length; index++) {\n\t\t\t\t\t\tconst mergeDataset = /* @__PURE__ */ _merge(dataset.value, outputs[index]);\n\t\t\t\t\t\tif (mergeDataset.issue) {\n\t\t\t\t\t\t\t_addIssue(this, \"type\", dataset, config$1, { received: \"unknown\" });\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdataset.value = mergeDataset.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/lazy/lazy.ts\n/**\n* Creates a lazy schema.\n*\n* @param getter The schema getter.\n*\n* @returns A lazy schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction lazy(getter) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"lazy\",\n\t\treference: lazy,\n\t\texpects: \"unknown\",\n\t\tasync: false,\n\t\tgetter,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\treturn this.getter(dataset.value)[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/lazy/lazyAsync.ts\n/**\n* Creates a lazy schema.\n*\n* @param getter The schema getter.\n*\n* @returns A lazy schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction lazyAsync(getter) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"lazy\",\n\t\treference: lazyAsync,\n\t\texpects: \"unknown\",\n\t\tasync: true,\n\t\tgetter,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\treturn (await this.getter(dataset.value))[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/literal/literal.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction literal(literal_, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"literal\",\n\t\treference: literal,\n\t\texpects: /* @__PURE__ */ _stringify(literal_),\n\t\tasync: false,\n\t\tliteral: literal_,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === this.literal) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/looseObject/looseObject.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction looseObject(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"loose_object\",\n\t\treference: looseObject,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tfor (const key in this.entries) {\n\t\t\t\t\tconst valueSchema = this.entries[key];\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\tconst valueDataset = valueSchema[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) {\n\t\t\t\t\tfor (const key in input) if (/* @__PURE__ */ _isValidObjectKey(input, key) && !(key in this.entries)) dataset.value[key] = input[key];\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/looseObject/looseObjectAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction looseObjectAsync(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"loose_object\",\n\t\treference: looseObjectAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tconst valueDatasets = await Promise.all(Object.entries(this.entries).map(async ([key, valueSchema]) => {\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : await /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\t\tawait valueSchema[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tinput[key],\n\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\tnull\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, valueSchema, valueDataset] of valueDatasets) if (valueDataset) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = await /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) {\n\t\t\t\t\tfor (const key in input) if (/* @__PURE__ */ _isValidObjectKey(input, key) && !(key in this.entries)) dataset.value[key] = input[key];\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/looseTuple/looseTuple.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction looseTuple(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"loose_tuple\",\n\t\treference: looseTuple,\n\t\texpects: \"Array\",\n\t\tasync: false,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tfor (let key = 0; key < this.items.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.items[key][\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) for (let key = this.items.length; key < input.length; key++) dataset.value.push(input[key]);\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/looseTuple/looseTupleAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction looseTupleAsync(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"loose_tuple\",\n\t\treference: looseTupleAsync,\n\t\texpects: \"Array\",\n\t\tasync: true,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tconst itemDatasets = await Promise.all(this.items.map(async (item, key) => {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\tawait item[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, itemDataset] of itemDatasets) {\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) for (let key = this.items.length; key < input.length; key++) dataset.value.push(input[key]);\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/map/map.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction map(key, value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"map\",\n\t\treference: map,\n\t\texpects: \"Map\",\n\t\tasync: false,\n\t\tkey,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input instanceof Map) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = /* @__PURE__ */ new Map();\n\t\t\t\tfor (const [inputKey, inputValue] of input) {\n\t\t\t\t\tconst keyDataset = this.key[\"~run\"]({ value: inputKey }, config$1);\n\t\t\t\t\tif (keyDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"map\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: inputKey,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of keyDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = keyDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst valueDataset = this.value[\"~run\"]({ value: inputValue }, config$1);\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"map\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: inputKey,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!keyDataset.typed || !valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.set(keyDataset.value, valueDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/map/mapAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction mapAsync(key, value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"map\",\n\t\treference: mapAsync,\n\t\texpects: \"Map\",\n\t\tasync: true,\n\t\tkey,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input instanceof Map) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = /* @__PURE__ */ new Map();\n\t\t\t\tconst datasets = await Promise.all([...input].map(([inputKey, inputValue]) => Promise.all([\n\t\t\t\t\tinputKey,\n\t\t\t\t\tinputValue,\n\t\t\t\t\tthis.key[\"~run\"]({ value: inputKey }, config$1),\n\t\t\t\t\tthis.value[\"~run\"]({ value: inputValue }, config$1)\n\t\t\t\t])));\n\t\t\t\tfor (const [inputKey, inputValue, keyDataset, valueDataset] of datasets) {\n\t\t\t\t\tif (keyDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"map\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: inputKey,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of keyDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = keyDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"map\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: inputKey,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!keyDataset.typed || !valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.set(keyDataset.value, valueDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nan/nan.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nan(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"nan\",\n\t\treference: nan,\n\t\texpects: \"NaN\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (Number.isNaN(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/never/never.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction never(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"never\",\n\t\treference: never,\n\t\texpects: \"never\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\t_addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonNullable/nonNullable.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonNullable(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_nullable\",\n\t\treference: nonNullable,\n\t\texpects: \"!null\",\n\t\tasync: false,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value !== null) dataset = this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === null) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonNullable/nonNullableAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonNullableAsync(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_nullable\",\n\t\treference: nonNullableAsync,\n\t\texpects: \"!null\",\n\t\tasync: true,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value !== null) dataset = await this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === null) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonNullish/nonNullish.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonNullish(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_nullish\",\n\t\treference: nonNullish,\n\t\texpects: \"(!null & !undefined)\",\n\t\tasync: false,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (!(dataset.value === null || dataset.value === void 0)) dataset = this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === null || dataset.value === void 0) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonNullish/nonNullishAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonNullishAsync(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_nullish\",\n\t\treference: nonNullishAsync,\n\t\texpects: \"(!null & !undefined)\",\n\t\tasync: true,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (!(dataset.value === null || dataset.value === void 0)) dataset = await this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === null || dataset.value === void 0) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonOptional/nonOptional.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonOptional(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_optional\",\n\t\treference: nonOptional,\n\t\texpects: \"!undefined\",\n\t\tasync: false,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value !== void 0) dataset = this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === void 0) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nonOptional/nonOptionalAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nonOptionalAsync(wrapped, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"non_optional\",\n\t\treference: nonOptionalAsync,\n\t\texpects: \"!undefined\",\n\t\tasync: true,\n\t\twrapped,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value !== void 0) dataset = await this.wrapped[\"~run\"](dataset, config$1);\n\t\t\tif (dataset.value === void 0) _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/null/null.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction null_(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"null\",\n\t\treference: null_,\n\t\texpects: \"null\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === null) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nullable/nullable.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nullable(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"nullable\",\n\t\treference: nullable,\n\t\texpects: `(${wrapped.expects} | null)`,\n\t\tasync: false,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === null) {\n\t\t\t\tif (this.default !== void 0) dataset.value = /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === null) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nullable/nullableAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nullableAsync(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"nullable\",\n\t\treference: nullableAsync,\n\t\texpects: `(${wrapped.expects} | null)`,\n\t\tasync: true,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === null) {\n\t\t\t\tif (this.default !== void 0) dataset.value = await /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === null) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nullish/nullish.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nullish(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"nullish\",\n\t\treference: nullish,\n\t\texpects: `(${wrapped.expects} | null | undefined)`,\n\t\tasync: false,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === null || dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === null || dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/nullish/nullishAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction nullishAsync(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"nullish\",\n\t\treference: nullishAsync,\n\t\texpects: `(${wrapped.expects} | null | undefined)`,\n\t\tasync: true,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === null || dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = await /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === null || dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/number/number.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction number(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"number\",\n\t\treference: number,\n\t\texpects: \"number\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"number\" && !isNaN(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/object/object.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction object(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"object\",\n\t\treference: object,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tfor (const key in this.entries) {\n\t\t\t\t\tconst valueSchema = this.entries[key];\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\tconst valueDataset = valueSchema[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/object/objectAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction objectAsync(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"object\",\n\t\treference: objectAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tconst valueDatasets = await Promise.all(Object.entries(this.entries).map(async ([key, valueSchema]) => {\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : await /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\t\tawait valueSchema[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tinput[key],\n\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\tnull\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, valueSchema, valueDataset] of valueDatasets) if (valueDataset) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = await /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/objectWithRest/objectWithRest.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction objectWithRest(entries$1, rest, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"object_with_rest\",\n\t\treference: objectWithRest,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tentries: entries$1,\n\t\trest,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tfor (const key in this.entries) {\n\t\t\t\t\tconst valueSchema = this.entries[key];\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\tconst valueDataset = valueSchema[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) {\n\t\t\t\t\tfor (const key in input) if (/* @__PURE__ */ _isValidObjectKey(input, key) && !(key in this.entries)) {\n\t\t\t\t\t\tconst valueDataset = this.rest[\"~run\"]({ value: input[key] }, config$1);\n\t\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/objectWithRest/objectWithRestAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction objectWithRestAsync(entries$1, rest, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"object_with_rest\",\n\t\treference: objectWithRestAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tentries: entries$1,\n\t\trest,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tconst [normalDatasets, restDatasets] = await Promise.all([Promise.all(Object.entries(this.entries).map(async ([key, valueSchema]) => {\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : await /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\t\tawait valueSchema[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tinput[key],\n\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\tnull\n\t\t\t\t\t];\n\t\t\t\t})), Promise.all(Object.entries(input).filter(([key]) => /* @__PURE__ */ _isValidObjectKey(input, key) && !(key in this.entries)).map(async ([key, value$1]) => [\n\t\t\t\t\tkey,\n\t\t\t\t\tvalue$1,\n\t\t\t\t\tawait this.rest[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t]))]);\n\t\t\t\tfor (const [key, value$1, valueSchema, valueDataset] of normalDatasets) if (valueDataset) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = await /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) for (const [key, value$1, valueDataset] of restDatasets) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/optional/optional.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction optional(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"optional\",\n\t\treference: optional,\n\t\texpects: `(${wrapped.expects} | undefined)`,\n\t\tasync: false,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/optional/optionalAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction optionalAsync(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"optional\",\n\t\treference: optionalAsync,\n\t\texpects: `(${wrapped.expects} | undefined)`,\n\t\tasync: true,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = await /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/picklist/picklist.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction picklist(options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"picklist\",\n\t\treference: picklist,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map(_stringify), \"|\"),\n\t\tasync: false,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (this.options.includes(dataset.value)) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/promise/promise.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction promise(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"promise\",\n\t\treference: promise,\n\t\texpects: \"Promise\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value instanceof Promise) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/record/record.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction record(key, value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"record\",\n\t\treference: record,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tkey,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tfor (const entryKey in input) if (/* @__PURE__ */ _isValidObjectKey(input, entryKey)) {\n\t\t\t\t\tconst entryValue = input[entryKey];\n\t\t\t\t\tconst keyDataset = this.key[\"~run\"]({ value: entryKey }, config$1);\n\t\t\t\t\tif (keyDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: entryKey,\n\t\t\t\t\t\t\tvalue: entryValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of keyDataset.issues) {\n\t\t\t\t\t\t\tissue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = keyDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tconst valueDataset = this.value[\"~run\"]({ value: entryValue }, config$1);\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: entryKey,\n\t\t\t\t\t\t\tvalue: entryValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!keyDataset.typed || !valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tif (keyDataset.typed) dataset.value[keyDataset.value] = valueDataset.value;\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/record/recordAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction recordAsync(key, value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"record\",\n\t\treference: recordAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tkey,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tconst datasets = await Promise.all(Object.entries(input).filter(([key$1]) => /* @__PURE__ */ _isValidObjectKey(input, key$1)).map(([entryKey, entryValue]) => Promise.all([\n\t\t\t\t\tentryKey,\n\t\t\t\t\tentryValue,\n\t\t\t\t\tthis.key[\"~run\"]({ value: entryKey }, config$1),\n\t\t\t\t\tthis.value[\"~run\"]({ value: entryValue }, config$1)\n\t\t\t\t])));\n\t\t\t\tfor (const [entryKey, entryValue, keyDataset, valueDataset] of datasets) {\n\t\t\t\t\tif (keyDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: entryKey,\n\t\t\t\t\t\t\tvalue: entryValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of keyDataset.issues) {\n\t\t\t\t\t\t\tissue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = keyDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: entryKey,\n\t\t\t\t\t\t\tvalue: entryValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!keyDataset.typed || !valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tif (keyDataset.typed) dataset.value[keyDataset.value] = valueDataset.value;\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/set/set.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction set(value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"set\",\n\t\treference: set,\n\t\texpects: \"Set\",\n\t\tasync: false,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input instanceof Set) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = /* @__PURE__ */ new Set();\n\t\t\t\tfor (const inputValue of input) {\n\t\t\t\t\tconst valueDataset = this.value[\"~run\"]({ value: inputValue }, config$1);\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"set\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: null,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.add(valueDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/set/setAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction setAsync(value$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"set\",\n\t\treference: setAsync,\n\t\texpects: \"Set\",\n\t\tasync: true,\n\t\tvalue: value$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input instanceof Set) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = /* @__PURE__ */ new Set();\n\t\t\t\tconst valueDatasets = await Promise.all([...input].map(async (inputValue) => [inputValue, await this.value[\"~run\"]({ value: inputValue }, config$1)]));\n\t\t\t\tfor (const [inputValue, valueDataset] of valueDatasets) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"set\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey: null,\n\t\t\t\t\t\t\tvalue: inputValue\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.add(valueDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/strictObject/strictObject.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction strictObject(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"strict_object\",\n\t\treference: strictObject,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tfor (const key in this.entries) {\n\t\t\t\t\tconst valueSchema = this.entries[key];\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\tconst valueDataset = valueSchema[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) {\n\t\t\t\t\tfor (const key in input) if (!(key in this.entries)) {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: key,\n\t\t\t\t\t\t\texpected: \"never\",\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/strictObject/strictObjectAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction strictObjectAsync(entries$1, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"strict_object\",\n\t\treference: strictObjectAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tentries: entries$1,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = {};\n\t\t\t\tconst valueDatasets = await Promise.all(Object.entries(this.entries).map(async ([key, valueSchema]) => {\n\t\t\t\t\tif (key in input || (valueSchema.type === \"exact_optional\" || valueSchema.type === \"optional\" || valueSchema.type === \"nullish\") && valueSchema.default !== void 0) {\n\t\t\t\t\t\tconst value$1 = key in input ? input[key] : await /* @__PURE__ */ getDefault(valueSchema);\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\t\tawait valueSchema[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tinput[key],\n\t\t\t\t\t\tvalueSchema,\n\t\t\t\t\t\tnull\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, valueSchema, valueDataset] of valueDatasets) if (valueDataset) {\n\t\t\t\t\tif (valueDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of valueDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = valueDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!valueDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value[key] = valueDataset.value;\n\t\t\t\t} else if (valueSchema.fallback !== void 0) dataset.value[key] = await /* @__PURE__ */ getFallback(valueSchema);\n\t\t\t\telse if (valueSchema.type !== \"exact_optional\" && valueSchema.type !== \"optional\" && valueSchema.type !== \"nullish\") {\n\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\texpected: `\"${key}\"`,\n\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t\tif (config$1.abortEarly) break;\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) {\n\t\t\t\t\tfor (const key in input) if (!(key in this.entries)) {\n\t\t\t\t\t\t_addIssue(this, \"key\", dataset, config$1, {\n\t\t\t\t\t\t\tinput: key,\n\t\t\t\t\t\t\texpected: \"never\",\n\t\t\t\t\t\t\tpath: [{\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\torigin: \"key\",\n\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\tvalue: input[key]\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/strictTuple/strictTuple.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction strictTuple(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"strict_tuple\",\n\t\treference: strictTuple,\n\t\texpects: \"Array\",\n\t\tasync: false,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tfor (let key = 0; key < this.items.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.items[key][\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!(dataset.issues && config$1.abortEarly) && this.items.length < input.length) _addIssue(this, \"type\", dataset, config$1, {\n\t\t\t\t\tinput: input[this.items.length],\n\t\t\t\t\texpected: \"never\",\n\t\t\t\t\tpath: [{\n\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tkey: this.items.length,\n\t\t\t\t\t\tvalue: input[this.items.length]\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/strictTuple/strictTupleAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction strictTupleAsync(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"strict_tuple\",\n\t\treference: strictTupleAsync,\n\t\texpects: \"Array\",\n\t\tasync: true,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tconst itemDatasets = await Promise.all(this.items.map(async (item, key) => {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\tawait item[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, itemDataset] of itemDatasets) {\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!(dataset.issues && config$1.abortEarly) && this.items.length < input.length) _addIssue(this, \"type\", dataset, config$1, {\n\t\t\t\t\tinput: input[this.items.length],\n\t\t\t\t\texpected: \"never\",\n\t\t\t\t\tpath: [{\n\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tkey: this.items.length,\n\t\t\t\t\t\tvalue: input[this.items.length]\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/string/string.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction string(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"string\",\n\t\treference: string,\n\t\texpects: \"string\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"string\") dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/symbol/symbol.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction symbol(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"symbol\",\n\t\treference: symbol,\n\t\texpects: \"symbol\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (typeof dataset.value === \"symbol\") dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/tuple/tuple.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction tuple(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"tuple\",\n\t\treference: tuple,\n\t\texpects: \"Array\",\n\t\tasync: false,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tfor (let key = 0; key < this.items.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.items[key][\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/tuple/tupleAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction tupleAsync(items, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"tuple\",\n\t\treference: tupleAsync,\n\t\texpects: \"Array\",\n\t\tasync: true,\n\t\titems,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tconst itemDatasets = await Promise.all(this.items.map(async (item, key) => {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\tawait item[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t];\n\t\t\t\t}));\n\t\t\t\tfor (const [key, value$1, itemDataset] of itemDatasets) {\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/tupleWithRest/tupleWithRest.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction tupleWithRest(items, rest, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"tuple_with_rest\",\n\t\treference: tupleWithRest,\n\t\texpects: \"Array\",\n\t\tasync: false,\n\t\titems,\n\t\trest,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tfor (let key = 0; key < this.items.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.items[key][\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) for (let key = this.items.length; key < input.length; key++) {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\tconst itemDataset = this.rest[\"~run\"]({ value: value$1 }, config$1);\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/tupleWithRest/tupleWithRestAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction tupleWithRestAsync(items, rest, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"tuple_with_rest\",\n\t\treference: tupleWithRestAsync,\n\t\texpects: \"Array\",\n\t\tasync: true,\n\t\titems,\n\t\trest,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (Array.isArray(input)) {\n\t\t\t\tdataset.typed = true;\n\t\t\t\tdataset.value = [];\n\t\t\t\tconst [normalDatasets, restDatasets] = await Promise.all([Promise.all(this.items.map(async (item, key) => {\n\t\t\t\t\tconst value$1 = input[key];\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\tawait item[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t];\n\t\t\t\t})), Promise.all(input.slice(this.items.length).map(async (value$1, key) => {\n\t\t\t\t\treturn [\n\t\t\t\t\t\tkey + this.items.length,\n\t\t\t\t\t\tvalue$1,\n\t\t\t\t\t\tawait this.rest[\"~run\"]({ value: value$1 }, config$1)\n\t\t\t\t\t];\n\t\t\t\t}))]);\n\t\t\t\tfor (const [key, value$1, itemDataset] of normalDatasets) {\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly) for (const [key, value$1, itemDataset] of restDatasets) {\n\t\t\t\t\tif (itemDataset.issues) {\n\t\t\t\t\t\tconst pathItem = {\n\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tvalue: value$1\n\t\t\t\t\t\t};\n\t\t\t\t\t\tfor (const issue of itemDataset.issues) {\n\t\t\t\t\t\t\tif (issue.path) issue.path.unshift(pathItem);\n\t\t\t\t\t\t\telse issue.path = [pathItem];\n\t\t\t\t\t\t\tdataset.issues?.push(issue);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!dataset.issues) dataset.issues = itemDataset.issues;\n\t\t\t\t\t\tif (config$1.abortEarly) {\n\t\t\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!itemDataset.typed) dataset.typed = false;\n\t\t\t\t\tdataset.value.push(itemDataset.value);\n\t\t\t\t}\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/undefined/undefined.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction undefined_(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"undefined\",\n\t\treference: undefined_,\n\t\texpects: \"undefined\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/undefinedable/undefinedable.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction undefinedable(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"undefinedable\",\n\t\treference: undefinedable,\n\t\texpects: `(${wrapped.expects} | undefined)`,\n\t\tasync: false,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/undefinedable/undefinedableAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction undefinedableAsync(wrapped, default_) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"undefinedable\",\n\t\treference: undefinedableAsync,\n\t\texpects: `(${wrapped.expects} | undefined)`,\n\t\tasync: true,\n\t\twrapped,\n\t\tdefault: default_,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) {\n\t\t\t\tif (this.default !== void 0) dataset.value = await /* @__PURE__ */ getDefault(this, dataset, config$1);\n\t\t\t\tif (dataset.value === void 0) {\n\t\t\t\t\tdataset.typed = true;\n\t\t\t\t\treturn dataset;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn this.wrapped[\"~run\"](dataset, config$1);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/union/utils/_subIssues/_subIssues.ts\n/**\n* Returns the sub issues of the provided datasets for the union issue.\n*\n* @param datasets The datasets.\n*\n* @returns The sub issues.\n*\n* @internal\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction _subIssues(datasets) {\n\tlet issues;\n\tif (datasets) for (const dataset of datasets) if (issues) issues.push(...dataset.issues);\n\telse issues = dataset.issues;\n\treturn issues;\n}\n\n//#endregion\n//#region src/schemas/union/union.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction union(options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"union\",\n\t\treference: union,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map((option) => option.expects), \"|\"),\n\t\tasync: false,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tlet validDataset;\n\t\t\tlet typedDatasets;\n\t\t\tlet untypedDatasets;\n\t\t\tfor (const schema of this.options) {\n\t\t\t\tconst optionDataset = schema[\"~run\"]({ value: dataset.value }, config$1);\n\t\t\t\tif (optionDataset.typed) if (optionDataset.issues) if (typedDatasets) typedDatasets.push(optionDataset);\n\t\t\t\telse typedDatasets = [optionDataset];\n\t\t\t\telse {\n\t\t\t\t\tvalidDataset = optionDataset;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\telse if (untypedDatasets) untypedDatasets.push(optionDataset);\n\t\t\t\telse untypedDatasets = [optionDataset];\n\t\t\t}\n\t\t\tif (validDataset) return validDataset;\n\t\t\tif (typedDatasets) {\n\t\t\t\tif (typedDatasets.length === 1) return typedDatasets[0];\n\t\t\t\t_addIssue(this, \"type\", dataset, config$1, { issues: /* @__PURE__ */ _subIssues(typedDatasets) });\n\t\t\t\tdataset.typed = true;\n\t\t\t} else if (untypedDatasets?.length === 1) return untypedDatasets[0];\n\t\t\telse _addIssue(this, \"type\", dataset, config$1, { issues: /* @__PURE__ */ _subIssues(untypedDatasets) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/union/unionAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction unionAsync(options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"union\",\n\t\treference: unionAsync,\n\t\texpects: /* @__PURE__ */ _joinExpects(options.map((option) => option.expects), \"|\"),\n\t\tasync: true,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tlet validDataset;\n\t\t\tlet typedDatasets;\n\t\t\tlet untypedDatasets;\n\t\t\tfor (const schema of this.options) {\n\t\t\t\tconst optionDataset = await schema[\"~run\"]({ value: dataset.value }, config$1);\n\t\t\t\tif (optionDataset.typed) if (optionDataset.issues) if (typedDatasets) typedDatasets.push(optionDataset);\n\t\t\t\telse typedDatasets = [optionDataset];\n\t\t\t\telse {\n\t\t\t\t\tvalidDataset = optionDataset;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\telse if (untypedDatasets) untypedDatasets.push(optionDataset);\n\t\t\t\telse untypedDatasets = [optionDataset];\n\t\t\t}\n\t\t\tif (validDataset) return validDataset;\n\t\t\tif (typedDatasets) {\n\t\t\t\tif (typedDatasets.length === 1) return typedDatasets[0];\n\t\t\t\t_addIssue(this, \"type\", dataset, config$1, { issues: /* @__PURE__ */ _subIssues(typedDatasets) });\n\t\t\t\tdataset.typed = true;\n\t\t\t} else if (untypedDatasets?.length === 1) return untypedDatasets[0];\n\t\t\telse _addIssue(this, \"type\", dataset, config$1, { issues: /* @__PURE__ */ _subIssues(untypedDatasets) });\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/unknown/unknown.ts\n/**\n* Creates a unknown schema.\n*\n* @returns A unknown schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction unknown() {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"unknown\",\n\t\treference: unknown,\n\t\texpects: \"unknown\",\n\t\tasync: false,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset) {\n\t\t\tdataset.typed = true;\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/variant/variant.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction variant(key, options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"variant\",\n\t\treference: variant,\n\t\texpects: \"Object\",\n\t\tasync: false,\n\t\tkey,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tlet outputDataset;\n\t\t\t\tlet maxDiscriminatorPriority = 0;\n\t\t\t\tlet invalidDiscriminatorKey = this.key;\n\t\t\t\tlet expectedDiscriminators = [];\n\t\t\t\tconst parseOptions = (variant$1, allKeys) => {\n\t\t\t\t\tfor (const schema of variant$1.options) {\n\t\t\t\t\t\tif (schema.type === \"variant\") parseOptions(schema, new Set(allKeys).add(schema.key));\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tlet keysAreValid = true;\n\t\t\t\t\t\t\tlet currentPriority = 0;\n\t\t\t\t\t\t\tfor (const currentKey of allKeys) {\n\t\t\t\t\t\t\t\tconst discriminatorSchema = schema.entries[currentKey];\n\t\t\t\t\t\t\t\tif (currentKey in input ? discriminatorSchema[\"~run\"]({\n\t\t\t\t\t\t\t\t\ttyped: false,\n\t\t\t\t\t\t\t\t\tvalue: input[currentKey]\n\t\t\t\t\t\t\t\t}, { abortEarly: true }).issues : discriminatorSchema.type !== \"exact_optional\" && discriminatorSchema.type !== \"optional\" && discriminatorSchema.type !== \"nullish\") {\n\t\t\t\t\t\t\t\t\tkeysAreValid = false;\n\t\t\t\t\t\t\t\t\tif (invalidDiscriminatorKey !== currentKey && (maxDiscriminatorPriority < currentPriority || maxDiscriminatorPriority === currentPriority && currentKey in input && !(invalidDiscriminatorKey in input))) {\n\t\t\t\t\t\t\t\t\t\tmaxDiscriminatorPriority = currentPriority;\n\t\t\t\t\t\t\t\t\t\tinvalidDiscriminatorKey = currentKey;\n\t\t\t\t\t\t\t\t\t\texpectedDiscriminators = [];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif (invalidDiscriminatorKey === currentKey) expectedDiscriminators.push(schema.entries[currentKey].expects);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tcurrentPriority++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (keysAreValid) {\n\t\t\t\t\t\t\t\tconst optionDataset = schema[\"~run\"]({ value: input }, config$1);\n\t\t\t\t\t\t\t\tif (!outputDataset || !outputDataset.typed && optionDataset.typed) outputDataset = optionDataset;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (outputDataset && !outputDataset.issues) break;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tparseOptions(this, new Set([this.key]));\n\t\t\t\tif (outputDataset) return outputDataset;\n\t\t\t\t_addIssue(this, \"type\", dataset, config$1, {\n\t\t\t\t\tinput: input[invalidDiscriminatorKey],\n\t\t\t\t\texpected: /* @__PURE__ */ _joinExpects(expectedDiscriminators, \"|\"),\n\t\t\t\t\tpath: [{\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tkey: invalidDiscriminatorKey,\n\t\t\t\t\t\tvalue: input[invalidDiscriminatorKey]\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/variant/variantAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction variantAsync(key, options, message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"variant\",\n\t\treference: variantAsync,\n\t\texpects: \"Object\",\n\t\tasync: true,\n\t\tkey,\n\t\toptions,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tconst input = dataset.value;\n\t\t\tif (input && typeof input === \"object\") {\n\t\t\t\tlet outputDataset;\n\t\t\t\tlet maxDiscriminatorPriority = 0;\n\t\t\t\tlet invalidDiscriminatorKey = this.key;\n\t\t\t\tlet expectedDiscriminators = [];\n\t\t\t\tconst parseOptions = async (variant$1, allKeys) => {\n\t\t\t\t\tfor (const schema of variant$1.options) {\n\t\t\t\t\t\tif (schema.type === \"variant\") await parseOptions(schema, new Set(allKeys).add(schema.key));\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tlet keysAreValid = true;\n\t\t\t\t\t\t\tlet currentPriority = 0;\n\t\t\t\t\t\t\tfor (const currentKey of allKeys) {\n\t\t\t\t\t\t\t\tconst discriminatorSchema = schema.entries[currentKey];\n\t\t\t\t\t\t\t\tif (currentKey in input ? (await discriminatorSchema[\"~run\"]({\n\t\t\t\t\t\t\t\t\ttyped: false,\n\t\t\t\t\t\t\t\t\tvalue: input[currentKey]\n\t\t\t\t\t\t\t\t}, { abortEarly: true })).issues : discriminatorSchema.type !== \"exact_optional\" && discriminatorSchema.type !== \"optional\" && discriminatorSchema.type !== \"nullish\") {\n\t\t\t\t\t\t\t\t\tkeysAreValid = false;\n\t\t\t\t\t\t\t\t\tif (invalidDiscriminatorKey !== currentKey && (maxDiscriminatorPriority < currentPriority || maxDiscriminatorPriority === currentPriority && currentKey in input && !(invalidDiscriminatorKey in input))) {\n\t\t\t\t\t\t\t\t\t\tmaxDiscriminatorPriority = currentPriority;\n\t\t\t\t\t\t\t\t\t\tinvalidDiscriminatorKey = currentKey;\n\t\t\t\t\t\t\t\t\t\texpectedDiscriminators = [];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif (invalidDiscriminatorKey === currentKey) expectedDiscriminators.push(schema.entries[currentKey].expects);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tcurrentPriority++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (keysAreValid) {\n\t\t\t\t\t\t\t\tconst optionDataset = await schema[\"~run\"]({ value: input }, config$1);\n\t\t\t\t\t\t\t\tif (!outputDataset || !outputDataset.typed && optionDataset.typed) outputDataset = optionDataset;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (outputDataset && !outputDataset.issues) break;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tawait parseOptions(this, new Set([this.key]));\n\t\t\t\tif (outputDataset) return outputDataset;\n\t\t\t\t_addIssue(this, \"type\", dataset, config$1, {\n\t\t\t\t\tinput: input[invalidDiscriminatorKey],\n\t\t\t\t\texpected: /* @__PURE__ */ _joinExpects(expectedDiscriminators, \"|\"),\n\t\t\t\t\tpath: [{\n\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\torigin: \"value\",\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tkey: invalidDiscriminatorKey,\n\t\t\t\t\t\tvalue: input[invalidDiscriminatorKey]\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t} else _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/schemas/void/void.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction void_(message$1) {\n\treturn {\n\t\tkind: \"schema\",\n\t\ttype: \"void\",\n\t\treference: void_,\n\t\texpects: \"void\",\n\t\tasync: false,\n\t\tmessage: message$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tif (dataset.value === void 0) dataset.typed = true;\n\t\t\telse _addIssue(this, \"type\", dataset, config$1);\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/keyof/keyof.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction keyof(schema, message$1) {\n\treturn /* @__PURE__ */ picklist(Object.keys(schema.entries), message$1);\n}\n\n//#endregion\n//#region src/methods/message/message.ts\n/**\n* Changes the local message configuration of a schema.\n*\n* @param schema The schema to configure.\n* @param message_ The error message.\n*\n* @returns The configured schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction message(schema, message_) {\n\treturn {\n\t\t...schema,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\treturn schema[\"~run\"](dataset, {\n\t\t\t\t...config$1,\n\t\t\t\tmessage: message_\n\t\t\t});\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/omit/omit.ts\n/**\n* Creates a modified copy of an object schema that does not contain the\n* selected entries.\n*\n* @param schema The schema to omit from.\n* @param keys The selected entries.\n*\n* @returns An object schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction omit(schema, keys) {\n\tconst entries$1 = { ...schema.entries };\n\tfor (const key of keys) delete entries$1[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/parse/parse.ts\n/**\n* Parses an unknown input based on a schema.\n*\n* @param schema The schema to be used.\n* @param input The input to be parsed.\n* @param config The parse configuration.\n*\n* @returns The parsed input.\n*/\nfunction parse(schema, input, config$1) {\n\tconst dataset = schema[\"~run\"]({ value: input }, /* @__PURE__ */ getGlobalConfig(config$1));\n\tif (dataset.issues) throw new ValiError(dataset.issues);\n\treturn dataset.value;\n}\n\n//#endregion\n//#region src/methods/parse/parseAsync.ts\n/**\n* Parses an unknown input based on a schema.\n*\n* @param schema The schema to be used.\n* @param input The input to be parsed.\n* @param config The parse configuration.\n*\n* @returns The parsed input.\n*/\nasync function parseAsync(schema, input, config$1) {\n\tconst dataset = await schema[\"~run\"]({ value: input }, /* @__PURE__ */ getGlobalConfig(config$1));\n\tif (dataset.issues) throw new ValiError(dataset.issues);\n\treturn dataset.value;\n}\n\n//#endregion\n//#region src/methods/parser/parser.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction parser(schema, config$1) {\n\tconst func = (input) => parse(schema, input, config$1);\n\tfunc.schema = schema;\n\tfunc.config = config$1;\n\treturn func;\n}\n\n//#endregion\n//#region src/methods/parser/parserAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction parserAsync(schema, config$1) {\n\tconst func = (input) => parseAsync(schema, input, config$1);\n\tfunc.schema = schema;\n\tfunc.config = config$1;\n\treturn func;\n}\n\n//#endregion\n//#region src/methods/partial/partial.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction partial(schema, keys) {\n\tconst entries$1 = {};\n\tfor (const key in schema.entries) entries$1[key] = !keys || keys.includes(key) ? /* @__PURE__ */ optional(schema.entries[key]) : schema.entries[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/partial/partialAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction partialAsync(schema, keys) {\n\tconst entries$1 = {};\n\tfor (const key in schema.entries) entries$1[key] = !keys || keys.includes(key) ? /* @__PURE__ */ optionalAsync(schema.entries[key]) : schema.entries[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/pick/pick.ts\n/**\n* Creates a modified copy of an object schema that contains only the selected\n* entries.\n*\n* @param schema The schema to pick from.\n* @param keys The selected entries.\n*\n* @returns An object schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction pick(schema, keys) {\n\tconst entries$1 = {};\n\tfor (const key of keys) entries$1[key] = schema.entries[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/pipe/pipe.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction pipe(...pipe$1) {\n\treturn {\n\t\t...pipe$1[0],\n\t\tpipe: pipe$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\t\"~run\"(dataset, config$1) {\n\t\t\tfor (const item of pipe$1) if (item.kind !== \"metadata\") {\n\t\t\t\tif (dataset.issues && (item.kind === \"schema\" || item.kind === \"transformation\")) {\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly && !config$1.abortPipeEarly) dataset = item[\"~run\"](dataset, config$1);\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/pipe/pipeAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction pipeAsync(...pipe$1) {\n\treturn {\n\t\t...pipe$1[0],\n\t\tpipe: pipe$1,\n\t\tasync: true,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t},\n\t\tasync \"~run\"(dataset, config$1) {\n\t\t\tfor (const item of pipe$1) if (item.kind !== \"metadata\") {\n\t\t\t\tif (dataset.issues && (item.kind === \"schema\" || item.kind === \"transformation\")) {\n\t\t\t\t\tdataset.typed = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (!dataset.issues || !config$1.abortEarly && !config$1.abortPipeEarly) dataset = await item[\"~run\"](dataset, config$1);\n\t\t\t}\n\t\t\treturn dataset;\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/required/required.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction required(schema, arg2, arg3) {\n\tconst keys = Array.isArray(arg2) ? arg2 : void 0;\n\tconst message$1 = Array.isArray(arg2) ? arg3 : arg2;\n\tconst entries$1 = {};\n\tfor (const key in schema.entries) entries$1[key] = !keys || keys.includes(key) ? /* @__PURE__ */ nonOptional(schema.entries[key], message$1) : schema.entries[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/required/requiredAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction requiredAsync(schema, arg2, arg3) {\n\tconst keys = Array.isArray(arg2) ? arg2 : void 0;\n\tconst message$1 = Array.isArray(arg2) ? arg3 : arg2;\n\tconst entries$1 = {};\n\tfor (const key in schema.entries) entries$1[key] = !keys || keys.includes(key) ? /* @__PURE__ */ nonOptionalAsync(schema.entries[key], message$1) : schema.entries[key];\n\treturn {\n\t\t...schema,\n\t\tentries: entries$1,\n\t\tget \"~standard\"() {\n\t\t\treturn /* @__PURE__ */ _getStandardProps(this);\n\t\t}\n\t};\n}\n\n//#endregion\n//#region src/methods/safeParse/safeParse.ts\n/**\n* Parses an unknown input based on a schema.\n*\n* @param schema The schema to be used.\n* @param input The input to be parsed.\n* @param config The parse configuration.\n*\n* @returns The parse result.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction safeParse(schema, input, config$1) {\n\tconst dataset = schema[\"~run\"]({ value: input }, /* @__PURE__ */ getGlobalConfig(config$1));\n\treturn {\n\t\ttyped: dataset.typed,\n\t\tsuccess: !dataset.issues,\n\t\toutput: dataset.value,\n\t\tissues: dataset.issues\n\t};\n}\n\n//#endregion\n//#region src/methods/safeParse/safeParseAsync.ts\n/**\n* Parses an unknown input based on a schema.\n*\n* @param schema The schema to be used.\n* @param input The input to be parsed.\n* @param config The parse configuration.\n*\n* @returns The parse result.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nasync function safeParseAsync(schema, input, config$1) {\n\tconst dataset = await schema[\"~run\"]({ value: input }, /* @__PURE__ */ getGlobalConfig(config$1));\n\treturn {\n\t\ttyped: dataset.typed,\n\t\tsuccess: !dataset.issues,\n\t\toutput: dataset.value,\n\t\tissues: dataset.issues\n\t};\n}\n\n//#endregion\n//#region src/methods/safeParser/safeParser.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction safeParser(schema, config$1) {\n\tconst func = (input) => /* @__PURE__ */ safeParse(schema, input, config$1);\n\tfunc.schema = schema;\n\tfunc.config = config$1;\n\treturn func;\n}\n\n//#endregion\n//#region src/methods/safeParser/safeParserAsync.ts\n/* @__NO_SIDE_EFFECTS__ */\nfunction safeParserAsync(schema, config$1) {\n\tconst func = (input) => /* @__PURE__ */ safeParseAsync(schema, input, config$1);\n\tfunc.schema = schema;\n\tfunc.config = config$1;\n\treturn func;\n}\n\n//#endregion\n//#region src/methods/summarize/summarize.ts\n/**\n* Summarize the error messages of issues in a pretty-printable multi-line string.\n*\n* @param issues The list of issues.\n*\n* @returns A summary of the issues.\n*\n* @beta\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction summarize(issues) {\n\tlet summary = \"\";\n\tfor (const issue of issues) {\n\t\tif (summary) summary += \"\\n\";\n\t\tsummary += `× ${issue.message}`;\n\t\tconst dotPath = /* @__PURE__ */ getDotPath(issue);\n\t\tif (dotPath) summary += `\\n  → at ${dotPath}`;\n\t}\n\treturn summary;\n}\n\n//#endregion\n//#region src/methods/unwrap/unwrap.ts\n/**\n* Unwraps the wrapped schema.\n*\n* @param schema The schema to be unwrapped.\n*\n* @returns The unwrapped schema.\n*/\n/* @__NO_SIDE_EFFECTS__ */\nfunction unwrap(schema) {\n\treturn schema.wrapped;\n}\n\n//#endregion\nexport { BASE64_REGEX, BIC_REGEX, CUID2_REGEX, DECIMAL_REGEX, DIGITS_REGEX, EMAIL_REGEX, EMOJI_REGEX, HEXADECIMAL_REGEX, HEX_COLOR_REGEX, IMEI_REGEX, IPV4_REGEX, IPV6_REGEX, IP_REGEX, ISO_DATE_REGEX, ISO_DATE_TIME_REGEX, ISO_TIMESTAMP_REGEX, ISO_TIME_REGEX, ISO_TIME_SECOND_REGEX, ISO_WEEK_REGEX, MAC48_REGEX, MAC64_REGEX, MAC_REGEX, NANO_ID_REGEX, OCTAL_REGEX, RFC_EMAIL_REGEX, SLUG_REGEX, ULID_REGEX, UUID_REGEX, ValiError, _addIssue, _getByteCount, _getGraphemeCount, _getLastMetadata, _getStandardProps, _getWordCount, _isLuhnAlgo, _isValidObjectKey, _joinExpects, _stringify, any, args, argsAsync, array, arrayAsync, assert, awaitAsync, base64, bic, bigint, blob, boolean, brand, bytes, check, checkAsync, checkItems, checkItemsAsync, config, creditCard, cuid2, custom, customAsync, date, decimal, deleteGlobalConfig, deleteGlobalMessage, deleteSchemaMessage, deleteSpecificMessage, description, digits, email, emoji, empty, endsWith, entries, entriesFromList, entriesFromObjects, enum_ as enum, enum_, everyItem, exactOptional, exactOptionalAsync, examples, excludes, fallback, fallbackAsync, file, filterItems, findItem, finite, flatten, flavor, forward, forwardAsync, function_ as function, function_, getDefault, getDefaults, getDefaultsAsync, getDescription, getDotPath, getExamples, getFallback, getFallbacks, getFallbacksAsync, getGlobalConfig, getGlobalMessage, getMetadata, getSchemaMessage, getSpecificMessage, getTitle, graphemes, gtValue, hash, hexColor, hexadecimal, imei, includes, instance, integer, intersect, intersectAsync, ip, ipv4, ipv6, is, isOfKind, isOfType, isValiError, isoDate, isoDateTime, isoTime, isoTimeSecond, isoTimestamp, isoWeek, keyof, lazy, lazyAsync, length, literal, looseObject, looseObjectAsync, looseTuple, looseTupleAsync, ltValue, mac, mac48, mac64, map, mapAsync, mapItems, maxBytes, maxEntries, maxGraphemes, maxLength, maxSize, maxValue, maxWords, message, metadata, mimeType, minBytes, minEntries, minGraphemes, minLength, minSize, minValue, minWords, multipleOf, nan, nanoid, never, nonEmpty, nonNullable, nonNullableAsync, nonNullish, nonNullishAsync, nonOptional, nonOptionalAsync, normalize, notBytes, notEntries, notGraphemes, notLength, notSize, notValue, notValues, notWords, null_ as null, null_, nullable, nullableAsync, nullish, nullishAsync, number, object, objectAsync, objectWithRest, objectWithRestAsync, octal, omit, optional, optionalAsync, parse, parseAsync, parseJson, parser, parserAsync, partial, partialAsync, partialCheck, partialCheckAsync, pick, picklist, pipe, pipeAsync, promise, rawCheck, rawCheckAsync, rawTransform, rawTransformAsync, readonly, record, recordAsync, reduceItems, regex, required, requiredAsync, returns, returnsAsync, rfcEmail, safeInteger, safeParse, safeParseAsync, safeParser, safeParserAsync, set, setAsync, setGlobalConfig, setGlobalMessage, setSchemaMessage, setSpecificMessage, size, slug, someItem, sortItems, startsWith, strictObject, strictObjectAsync, strictTuple, strictTupleAsync, string, stringifyJson, summarize, symbol, title, toBigint, toBoolean, toDate, toLowerCase, toMaxValue, toMinValue, toNumber, toString, toUpperCase, transform, transformAsync, trim, trimEnd, trimStart, tuple, tupleAsync, tupleWithRest, tupleWithRestAsync, ulid, undefined_ as undefined, undefined_, undefinedable, undefinedableAsync, union, unionAsync, unknown, unwrap, url, uuid, value, values, variant, variantAsync, void_ as void, void_, words };","import * as v from \"valibot\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\n\r\n/**\r\n * Type guard to check if value is string based on expectedType check.\r\n * Used after runtime type validation to narrow unknown to string.\r\n *\r\n * @param value - The value to check\r\n * @param expectedType - The expected type\r\n * @returns True if expectedType is \"string\" and value is actually a string\r\n */\r\nfunction isStringValue(value: unknown, expectedType: string): value is string {\r\n  return expectedType === \"string\" && typeof value === \"string\";\r\n}\r\n\r\n/**\r\n * Valibot schema for JournalEntry validation.\r\n * Validates that objects from Foundry API conform to expected structure.\r\n */\r\nexport const JournalEntrySchema = v.object({\r\n  id: v.string(),\r\n  name: v.optional(v.string()),\r\n  flags: v.optional(v.record(v.string(), v.unknown())),\r\n  getFlag: v.optional(\r\n    v.custom<(scope: string, key: string) => unknown>((val) => typeof val === \"function\")\r\n  ),\r\n  setFlag: v.optional(\r\n    v.custom<(scope: string, key: string, value: unknown) => Promise<unknown>>(\r\n      (val) => typeof val === \"function\"\r\n    )\r\n  ),\r\n});\r\n\r\n/**\r\n * Type for validated journal entries.\r\n */\r\nexport type ValidatedJournalEntry = v.InferOutput<typeof JournalEntrySchema>;\r\n\r\n/**\r\n * Validates an array of journal entries against the schema.\r\n *\r\n * @param entries - Array of unknown objects to validate\r\n * @returns Result with validated entries or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const entries = Array.from(game.journal.contents);\r\n * const result = validateJournalEntries(entries);\r\n * if (result.ok) {\r\n *   // entries are validated\r\n * }\r\n * ```\r\n */\r\nexport function validateJournalEntries(\r\n  entries: unknown[]\r\n): Result<ValidatedJournalEntry[], FoundryError> {\r\n  const result = v.safeParse(v.array(JournalEntrySchema), entries);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Journal entry validation failed\",\r\n        undefined,\r\n        result.issues\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n\r\n/**\r\n * Valibot schema for validating setting values based on their type.\r\n * Provides type-safe validation for Foundry settings.\r\n */\r\n\r\n/**\r\n * Validates a setting value against expected types and constraints.\r\n *\r\n * @param key - Setting key for error messages\r\n * @param value - Value to validate\r\n * @param expectedType - Expected type (string, number, boolean, or specific values)\r\n * @param choices - Optional array of allowed values\r\n * @returns Result with validated value or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * // Validate log level\r\n * const result = validateSettingValue(\"logLevel\", \"DEBUG\", \"string\", [\"DEBUG\", \"INFO\", \"WARN\", \"ERROR\"]);\r\n * if (result.ok) {\r\n *   // value is valid\r\n * }\r\n * ```\r\n */\r\nexport function validateSettingValue(\r\n  key: string,\r\n  value: unknown,\r\n  expectedType: \"string\" | \"number\" | \"boolean\",\r\n  choices?: readonly string[]\r\n): Result<unknown, FoundryError> {\r\n  // Type validation\r\n  if (expectedType === \"string\" && typeof value !== \"string\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected string, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  if (expectedType === \"number\" && typeof value !== \"number\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected number, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  if (expectedType === \"boolean\" && typeof value !== \"boolean\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting ${key}: Expected boolean, got ${typeof value}`,\r\n        { key, value, expectedType }\r\n      )\r\n    );\r\n  }\r\n\r\n  // Choice validation (only for strings)\r\n  if (choices && isStringValue(value, expectedType)) {\r\n    if (!choices.includes(value)) {\r\n      return err(\r\n        createFoundryError(\r\n          \"VALIDATION_FAILED\",\r\n          `Setting ${key}: Invalid value \"${value}\". Allowed: ${choices.join(\", \")}`,\r\n          { key, value, choices }\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  return ok(value);\r\n}\r\n\r\n/**\r\n * Valibot schema for Foundry setting configuration.\r\n * Validates the structure and types of setting registration config.\r\n */\r\nexport const SettingConfigSchema = v.object({\r\n  name: v.optional(v.string()),\r\n  hint: v.optional(v.string()),\r\n  scope: v.optional(v.picklist([\"world\", \"client\", \"user\"])),\r\n  config: v.optional(v.boolean()),\r\n  type: v.optional(v.any()), // typeof String, Number, Boolean - cannot validate constructors\r\n  default: v.optional(v.any()), // Default value depends on type\r\n  choices: v.optional(v.record(v.string(), v.string())), // Record keys must be string in TS\r\n  onChange: v.optional(v.custom<(value: unknown) => void>((val) => typeof val === \"function\")),\r\n});\r\n\r\n/**\r\n * Validates setting registration config using Valibot schema.\r\n *\r\n * @param namespace - Module namespace\r\n * @param key - Setting key\r\n * @param config - Setting configuration object\r\n * @returns Result with validated config or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateSettingConfig(\"my-module\", \"logLevel\", {\r\n *   name: \"Log Level\",\r\n *   scope: \"world\",\r\n *   config: true,\r\n *   type: Number,\r\n *   default: 1\r\n * });\r\n * ```\r\n */\r\nexport function validateSettingConfig(\r\n  namespace: string,\r\n  key: string,\r\n  config: unknown\r\n): Result<unknown, FoundryError> {\r\n  // Namespace validation\r\n  if (!namespace || typeof namespace !== \"string\") {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Invalid setting namespace: must be non-empty string\",\r\n        { namespace, key }\r\n      )\r\n    );\r\n  }\r\n\r\n  // Key validation\r\n  if (!key || typeof key !== \"string\") {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Invalid setting key: must be non-empty string\", {\r\n        namespace,\r\n        key,\r\n      })\r\n    );\r\n  }\r\n\r\n  // Config validation (must be object)\r\n  if (!config || typeof config !== \"object\") {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Invalid setting config: must be object\", {\r\n        namespace,\r\n        key,\r\n      })\r\n    );\r\n  }\r\n\r\n  // Validate config structure with Valibot\r\n  const result = v.safeParse(SettingConfigSchema, config);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `Setting config validation failed for ${namespace}.${key}: ${result.issues.map((i) => i.message).join(\", \")}`,\r\n        { namespace, key, config, issues: result.issues }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n\r\n// Re-export SettingConfig type for convenience\r\nexport type { SettingConfig } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\n\r\n/**\r\n * Sanitizes a string for use in HTML/CSS selectors.\r\n * Removes all characters except alphanumeric, hyphens, and underscores.\r\n * Prevents CSS injection attacks.\r\n *\r\n * @param id - The ID to sanitize\r\n * @returns Sanitized ID safe for use in selectors\r\n *\r\n * @example\r\n * ```typescript\r\n * sanitizeId(\"journal-123\");  // \"journal-123\"\r\n * sanitizeId(\"../../../etc/passwd\");  // \"etcpasswd\"\r\n * sanitizeId(\"<script>alert('xss')</script>\");  // \"scriptalertxssscript\"\r\n * ```\r\n */\r\nexport function sanitizeId(id: string): string {\r\n  return id.replace(/[^a-zA-Z0-9-_]/g, \"\");\r\n}\r\n\r\n/**\r\n * Sanitizes a string for display in HTML.\r\n * Escapes HTML entities to prevent XSS attacks.\r\n *\r\n * @param text - The text to sanitize\r\n * @returns HTML-safe text\r\n *\r\n * @example\r\n * ```typescript\r\n * sanitizeHtml(\"<script>alert('xss')</script>\");\r\n * // \"&lt;script&gt;alert('xss')&lt;/script&gt;\"\r\n *\r\n * sanitizeHtml(\"Normal text\");\r\n * // \"Normal text\"\r\n * ```\r\n */\r\nexport function sanitizeHtml(text: string): string {\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Valibot schema for validating Foundry Application objects in hooks.\r\n * Validates minimal required properties for safe hook processing.\r\n */\r\nexport const FoundryApplicationSchema = v.object({\r\n  // Application should have a string ID\r\n  id: v.string(),\r\n  // Application should have object property (typed as record instead of any)\r\n  object: v.optional(v.record(v.string(), v.unknown())),\r\n  // Application should have options property\r\n  options: v.optional(v.record(v.string(), v.unknown())),\r\n});\r\n\r\n/**\r\n * Type for validated Foundry Application.\r\n */\r\nexport type ValidatedFoundryApplication = v.InferOutput<typeof FoundryApplicationSchema>;\r\n\r\n/**\r\n * Validates a hook app parameter.\r\n *\r\n * @param app - Unknown app object to validate\r\n * @returns Result with validated app or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateHookApp(app);\r\n * if (result.ok) {\r\n *   // app is validated and safe to use\r\n * }\r\n * ```\r\n */\r\nexport function validateHookApp(app: unknown): Result<ValidatedFoundryApplication, FoundryError> {\r\n  // Null/undefined check\r\n  if (app === null || app === undefined) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Hook app parameter is null or undefined\",\r\n        undefined,\r\n        undefined\r\n      )\r\n    );\r\n  }\r\n\r\n  const result = v.safeParse(FoundryApplicationSchema, app);\r\n\r\n  if (!result.success) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Hook app parameter validation failed\",\r\n        undefined,\r\n        result.issues\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(result.output);\r\n}\r\n","/**\r\n * Infrastructure-layer constants.\r\n *\r\n * Diese Datei enthält Infrastructure-spezifische Konstanten.\r\n *\r\n * @constant\r\n *\r\n * @note ENCODING REQUIREMENT\r\n * All source files in this project MUST be saved as UTF-8 without BOM.\r\n * This ensures proper display of German text (ä, ö, ü, ß) and prevents mojibake.\r\n * Configure your editor to use UTF-8 encoding for all .ts, .js, and .svelte files.\r\n */\r\n/* v8 ignore file -- Reine Konstanten-Definition, keine ausführbare Logik -- @preserve */\r\n\r\n/**\r\n * Infrastructure-spezifische Konstanten\r\n */\r\n\r\n/**\r\n * Throttle window für Hook-Callbacks in Millisekunden.\r\n * Verhindert exzessive Verarbeitung bei schnell aufeinanderfolgenden Hook-Aufrufen.\r\n *\r\n * Auf 150ms gesetzt, um mehrere Journal-Einträge zu erfassen,\r\n * bevor Verarbeitung startet, während exzessive Aufrufe verhindert werden.\r\n */\r\nexport const HOOK_THROTTLE_WINDOW_MS = 150;\r\n\r\n/**\r\n * Validation constraints für Input-Daten.\r\n */\r\nexport const VALIDATION_CONSTRAINTS = {\r\n  /** Maximale Länge für IDs und Keys */\r\n  MAX_ID_LENGTH: 100,\r\n  /** Maximale Länge für Namen */\r\n  MAX_NAME_LENGTH: 100,\r\n  /** Maximale Länge für Flag-Keys */\r\n  MAX_FLAG_KEY_LENGTH: 100,\r\n} as const;\r\n\r\n/**\r\n * Metrics collection configuration.\r\n */\r\nexport const METRICS_CONFIG = {\r\n  /** Größe des Circular-Buffers für Resolution-Zeiten */\r\n  RESOLUTION_TIMES_BUFFER_SIZE: 100,\r\n} as const;\r\n\r\n// Deep freeze Infrastructure-Constants\r\nObject.freeze(VALIDATION_CONSTRAINTS);\r\nObject.freeze(METRICS_CONFIG);\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  createFoundryError,\r\n  type FoundryError,\r\n} from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { VALIDATION_CONSTRAINTS } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Validates a journal entry ID.\r\n *\r\n * Fast manual validation optimized for hot-path operations.\r\n * Validates format, length, and character constraints.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 100 characters (VALIDATION_CONSTRAINTS.MAX_ID_LENGTH)\r\n * - Only alphanumeric characters, hyphens, and underscores\r\n *\r\n * @param id - Journal entry ID to validate\r\n * @returns Result with validated ID or FoundryError\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = validateJournalId(\"journal-entry-123\");\r\n * if (result.ok) {\r\n *   // Safe to use result.value\r\n * }\r\n * ```\r\n */\r\nexport function validateJournalId(id: string): Result<string, FoundryError> {\r\n  if (id.length === 0) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"ID cannot be empty\"));\r\n  }\r\n\r\n  if (id.length > VALIDATION_CONSTRAINTS.MAX_ID_LENGTH) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        `ID too long (max ${VALIDATION_CONSTRAINTS.MAX_ID_LENGTH} characters)`\r\n      )\r\n    );\r\n  }\r\n\r\n  if (!/^[a-zA-Z0-9-_]+$/.test(id)) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"ID contains invalid characters (allowed: a-z, A-Z, 0-9, -, _)\",\r\n        { id }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(id);\r\n}\r\n\r\n/**\r\n * Validates a journal entry name.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 255 characters\r\n *\r\n * @param name - Journal entry name to validate\r\n * @returns Result with validated name or FoundryError\r\n */\r\nexport function validateJournalName(name: string): Result<string, FoundryError> {\r\n  if (typeof name !== \"string\" || name.length === 0) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Name cannot be empty\"));\r\n  }\r\n\r\n  if (name.length > 255) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Name too long (max 255 characters)\"));\r\n  }\r\n\r\n  return ok(name);\r\n}\r\n\r\n/**\r\n * Validates a module flag key.\r\n *\r\n * Rules:\r\n * - Must be a non-empty string\r\n * - Maximum 100 characters (VALIDATION_CONSTRAINTS.MAX_ID_LENGTH)\r\n * - Only alphanumeric characters and underscores\r\n *\r\n * @param key - Flag key to validate\r\n * @returns Result with validated key or FoundryError\r\n */\r\nexport function validateFlagKey(key: string): Result<string, FoundryError> {\r\n  if (\r\n    typeof key !== \"string\" ||\r\n    key.length === 0 ||\r\n    key.length > VALIDATION_CONSTRAINTS.MAX_FLAG_KEY_LENGTH\r\n  ) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Invalid flag key length\"));\r\n  }\r\n\r\n  if (!/^[a-zA-Z0-9_]+$/.test(key)) {\r\n    return err(createFoundryError(\"VALIDATION_FAILED\", \"Invalid flag key format\"));\r\n  }\r\n\r\n  return ok(key);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryGame } from \"../../interfaces/FoundryGame\";\r\nimport type { FoundryJournalEntry } from \"../../types\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport type { IFoundryGameAPI } from \"../../api/foundry-api.interface\";\r\nimport { tryCatch, err } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { validateJournalEntries } from \"../../validation/schemas\";\r\nimport { validateJournalId } from \"../../validation/input-validators\";\r\nimport { APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\n\r\n/**\r\n * v13 implementation of FoundryGame interface.\r\n * Encapsulates Foundry v13-specific game API access.\r\n *\r\n * Performance optimization: Caches validated journal entries with TTL-based invalidation\r\n * to avoid expensive Valibot validation on every call. Cache expires after 5 seconds.\r\n *\r\n * Uses dependency injection for Foundry APIs to improve testability.\r\n */\r\nexport class FoundryV13GamePort implements FoundryGame {\r\n  #disposed = false;\r\n  private cachedEntries: FoundryJournalEntry[] | null = null;\r\n  private lastCheckTimestamp = 0;\r\n  private readonly cacheTtlMs = APP_DEFAULTS.CACHE_TTL_MS;\r\n\r\n  constructor(private readonly foundryAPI: IFoundryGameAPI) {}\r\n\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot get journal entries on disposed port\"));\r\n    }\r\n    if (!this.foundryAPI?.journal) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry game API not available\"));\r\n    }\r\n\r\n    const now = Date.now();\r\n    const cacheAge = now - this.lastCheckTimestamp;\r\n\r\n    // Check TTL-based cache validity\r\n    if (this.cachedEntries !== null && cacheAge < this.cacheTtlMs) {\r\n      // Cache hit - return cached entries\r\n      return { ok: true, value: this.cachedEntries };\r\n    }\r\n\r\n    // Cache miss - fetch fresh entries\r\n\r\n    // game.journal is typed as DocumentCollection<JournalEntry> by fvtt-types\r\n    // DocumentCollection.contents is an array of the stored documents\r\n    const entries = tryCatch(\r\n      () => Array.from(this.foundryAPI.journal.contents),\r\n      (error) =>\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to access journal entries\", undefined, error)\r\n    );\r\n\r\n    if (!entries.ok) {\r\n      return entries;\r\n    }\r\n\r\n    // Validate entries to ensure they have expected structure (expensive, cached for TTL duration)\r\n    // IMPORTANT: Use validation as guard only, keep original Foundry objects with prototypes\r\n    const validationResult = validateJournalEntries(entries.value);\r\n    if (!validationResult.ok) {\r\n      // Return validation error directly (preserves VALIDATION_FAILED code and details)\r\n      return validationResult;\r\n    }\r\n\r\n    // Update cache with ORIGINAL entries (preserving Foundry prototypes like sheet.render, update, etc.)\r\n    // Do NOT cache validationResult.value as it strips prototypes\r\n    this.cachedEntries = entries.value;\r\n    this.lastCheckTimestamp = now;\r\n\r\n    return { ok: true, value: this.cachedEntries };\r\n  }\r\n\r\n  /**\r\n   * Invalidates the journal entries cache.\r\n   * Forces the next getJournalEntries() call to fetch and validate fresh data.\r\n   */\r\n  invalidateCache(): void {\r\n    this.cachedEntries = null;\r\n    this.lastCheckTimestamp = 0;\r\n  }\r\n\r\n  getJournalEntryById(id: string): Result<FoundryJournalEntry | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot get journal entry on disposed port\"));\r\n    }\r\n    // Validate input\r\n    const validationResult = validateJournalId(id);\r\n    if (!validationResult.ok) {\r\n      return validationResult;\r\n    }\r\n\r\n    if (!this.foundryAPI?.journal) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry game API not available\"));\r\n    }\r\n\r\n    return tryCatch(\r\n      () => {\r\n        // game.journal.get() is typed by fvtt-types and returns JournalEntry | undefined\r\n        const entry = this.foundryAPI.journal.get(validationResult.value);\r\n        return entry ?? null;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get journal entry by ID ${validationResult.value}`,\r\n          { id: validationResult.value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // Invalidate cache on disposal\r\n    this.cachedEntries = null;\r\n    this.lastCheckTimestamp = 0;\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13GamePort instance for production use.\r\n * Injects real Foundry game API.\r\n *\r\n * @returns FoundryV13GamePort instance\r\n */\r\nexport function createFoundryV13GamePort(): FoundryV13GamePort {\r\n  // Create port even if API is not available - port will return API_NOT_AVAILABLE errors\r\n  if (typeof game === \"undefined\" || !game?.journal) {\r\n    return new FoundryV13GamePort({\r\n      // type-coverage:ignore-next-line -- Required: null needed when API unavailable, but IFoundryGameAPI[\"journal\"] is non-nullable\r\n      journal: null as unknown as IFoundryGameAPI[\"journal\"],\r\n    });\r\n  }\r\n\r\n  return new FoundryV13GamePort({\r\n    journal: {\r\n      contents: Array.from(game.journal.contents),\r\n      get: (id: string) => game.journal.get(id),\r\n      ...(game.journal.directory && game.journal.directory.render\r\n        ? {\r\n            directory: {\r\n              render: () => {\r\n                game.journal.directory?.render();\r\n              },\r\n            },\r\n          }\r\n        : {}),\r\n    },\r\n  });\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHooks } from \"../../interfaces/FoundryHooks\";\r\nimport type { FoundryHookCallback } from \"../../types\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport type { IFoundryHooksAPI } from \"../../api/foundry-api.interface\";\r\nimport { tryCatch } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\n\r\n/**\r\n * v13 implementation of FoundryHooks interface.\r\n * Encapsulates Foundry v13-specific hook system access.\r\n *\r\n * Based on Foundry VTT v13 Hooks API:\r\n * https://foundryvtt.com/api/classes/foundry.helpers.Hooks.html\r\n *\r\n * Uses dependency injection for Foundry APIs to improve testability.\r\n */\r\nexport class FoundryV13HooksPort implements FoundryHooks {\r\n  #disposed = false;\r\n\r\n  constructor(private readonly foundryAPI: IFoundryHooksAPI) {}\r\n\r\n  on(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot register hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (!this.foundryAPI) {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        const hookId = this.foundryAPI.on(hookName, callback);\r\n        return hookId;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  once(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot register one-time hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (!this.foundryAPI) {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        const hookId = this.foundryAPI.once(hookName, callback);\r\n        return hookId;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register one-time hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  off(hookName: string, callbackOrId: FoundryHookCallback | number): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot unregister hook on disposed port\", {\r\n          hookName,\r\n        }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (!this.foundryAPI) {\r\n          throw new Error(\"Foundry Hooks API is not available\");\r\n        }\r\n        this.foundryAPI.off(hookName, callbackOrId);\r\n        return undefined;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to unregister hook ${hookName}`,\r\n          { hookName },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // Note: Hook cleanup is handled by FoundryHooksPort.dispose()\r\n    // Port remains stateless - it only wraps Foundry API\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13HooksPort instance for production use.\r\n * Injects real Foundry Hooks API.\r\n *\r\n * @returns FoundryV13HooksPort instance\r\n */\r\nexport function createFoundryV13HooksPort(): FoundryV13HooksPort {\r\n  if (typeof Hooks === \"undefined\") {\r\n    throw new Error(\"Foundry Hooks API is not available\");\r\n  }\r\n\r\n  // Type-safe cast for dynamic hook names\r\n  // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n  // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n  return new FoundryV13HooksPort({\r\n    on: (hookName: string, callback: FoundryHookCallback) => {\r\n      return (Hooks as { on: (name: string, cb: FoundryHookCallback) => number }).on(\r\n        hookName,\r\n        callback\r\n      );\r\n    },\r\n    once: (hookName: string, callback: FoundryHookCallback) => {\r\n      return (Hooks as { once: (name: string, cb: FoundryHookCallback) => number }).once(\r\n        hookName,\r\n        callback\r\n      );\r\n    },\r\n    off: (hookName: string, callbackOrId: FoundryHookCallback | number) => {\r\n      (Hooks as { off: (name: string, cbOrId: FoundryHookCallback | number) => void }).off(\r\n        hookName,\r\n        callbackOrId\r\n      );\r\n    },\r\n  });\r\n}\r\n","/**\r\n * Type-Guard-Utilities for runtime type checking.\r\n *\r\n * These utilities provide safe runtime validation for objects and their properties/methods,\r\n * used by runtime cast functions to ensure type safety at runtime.\r\n */\r\n\r\nimport type { Initializable } from \"@/domain/ports/initializable.interface\";\r\n\r\n/**\r\n * Checks if an object has a method with the given name.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param methodName - The name of the method to check for\r\n * @returns True if the object has the method, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { dispose: () => {} };\r\n * if (hasMethod(obj, \"dispose\")) {\r\n *   obj.dispose(); // Type-safe\r\n * }\r\n * ```\r\n */\r\nexport function hasMethod(obj: unknown, methodName: string): boolean {\r\n  return (\r\n    obj !== null &&\r\n    obj !== undefined &&\r\n    typeof obj === \"object\" &&\r\n    methodName in obj &&\r\n    // type-coverage:ignore-next-line - Runtime type guard requires cast to check method type\r\n    typeof (obj as Record<string, unknown>)[methodName] === \"function\"\r\n  );\r\n}\r\n\r\n/**\r\n * Checks if an object has a property with the given name.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param propertyName - The name of the property to check for\r\n * @returns True if the object has the property, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { name: \"test\" };\r\n * if (hasProperty(obj, \"name\")) {\r\n *   console.log(obj.name); // Type-safe\r\n * }\r\n * ```\r\n */\r\nexport function hasProperty(obj: unknown, propertyName: string): boolean {\r\n  return obj !== null && obj !== undefined && typeof obj === \"object\" && propertyName in obj;\r\n}\r\n\r\n/**\r\n * Checks if an object has all the required methods.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @param methodNames - Array of method names that must exist\r\n * @returns True if the object has all required methods, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const obj = { register: () => {}, get: () => {}, set: () => {} };\r\n * if (isObjectWithMethods(obj, [\"register\", \"get\", \"set\"])) {\r\n *   // obj has all required methods\r\n * }\r\n * ```\r\n */\r\nexport function isObjectWithMethods(obj: unknown, methodNames: string[]): boolean {\r\n  if (obj === null || obj === undefined || typeof obj !== \"object\") {\r\n    return false;\r\n  }\r\n\r\n  return methodNames.every((methodName) => hasMethod(obj, methodName));\r\n}\r\n\r\n/**\r\n * Type guard to check if an object implements the Initializable interface.\r\n *\r\n * This follows the Liskov Substitution Principle (LSP) by checking for behavior\r\n * (the presence of an initialize method) rather than concrete class types.\r\n *\r\n * @param obj - The object to check (unknown type)\r\n * @returns True if the object implements Initializable, false otherwise\r\n *\r\n * @example\r\n * ```typescript\r\n * const collector = container.resolve(metricsCollectorToken);\r\n * if (isInitializable(collector)) {\r\n *   collector.initialize(); // Type-safe\r\n * }\r\n * ```\r\n */\r\nexport function isInitializable(obj: unknown): obj is Initializable {\r\n  return hasMethod(obj, \"initialize\");\r\n}\r\n","/**\r\n * Centralized helpers for Foundry-specific runtime casts that are required by\r\n * the Foundry adapter layer (ports, services, facades).\r\n *\r\n * Diese Datei ist absichtlich von der Type-Coverage ausgenommen, damit\r\n * wir an wenigen wohldokumentierten Stellen mit Runtime-Casts arbeiten\r\n * können, ohne den 100%-Anspruch für den restlichen Code zu verletzen.\r\n *\r\n * Diese Datei ist getrennt von `runtime-safe-cast.ts` (DI-Infrastruktur),\r\n * da sie Foundry-spezifische Casts enthält und FoundryError statt ContainerError\r\n * verwendet. Die Trennung ermöglicht klare Abhängigkeiten und verhindert\r\n * Import-Zyklen zwischen Foundry-Adapter und DI-Infrastruktur.\r\n */\r\n\r\nimport type { SettingConfig } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { createFoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { isObjectWithMethods, hasMethod } from \"@/infrastructure/shared/utils/type-guards\";\r\n\r\n/**\r\n * Type-safe interface for Foundry Settings with dynamic namespaces.\r\n * Avoids 'any' while working around fvtt-types namespace restrictions.\r\n */\r\nexport interface DynamicSettingsApi {\r\n  register<T>(namespace: string, key: string, config: SettingConfig<T>): void;\r\n  get<T>(namespace: string, key: string): T;\r\n  set<T>(namespace: string, key: string, value: T): Promise<T>;\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für `game.settings` mit dynamischen Namespaces.\r\n * Foundry's Settings API unterstützt Modul-Namespaces, aber fvtt-types\r\n * beschränkt den Namespace-Typ auf \"core\" nur.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Settings-Objekt die erforderlichen Methoden hat. Bei Fehlern wird\r\n * ein FoundryError zurückgegeben statt einen Error zu werfen, um konsistent\r\n * mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param settings - Das game.settings Objekt (unknown, da game global ist)\r\n * @returns Result mit dem Settings-Objekt als DynamicSettingsApi oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methoden `register`, `get` und `set`\r\n * vorhanden sind. Dies stellt sicher, dass das Settings-Objekt die erwartete\r\n * API-Struktur hat.\r\n */\r\nexport function castFoundrySettingsApi(\r\n  settings: unknown\r\n): Result<DynamicSettingsApi, FoundryError> {\r\n  if (!isObjectWithMethods(settings, [\"register\", \"get\", \"set\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"game.settings does not have required methods (register, get, set)\",\r\n        {\r\n          missingMethods: [\"register\", \"get\", \"set\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n  return ok(settings as DynamicSettingsApi);\r\n}\r\n\r\n/**\r\n * Type definition for documents with flag methods.\r\n */\r\ntype DocumentWithFlags = {\r\n  getFlag: (scope: string, key: string) => unknown;\r\n  setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n};\r\n\r\n/**\r\n * Type definition for documents with update method.\r\n * Generic type allows for specific return types.\r\n */\r\ntype DocumentWithUpdate<TDocument extends { id: string } = { id: string; name?: string | null }> = {\r\n  update: (changes: unknown) => Promise<TDocument>;\r\n};\r\n\r\n/**\r\n * Type definition for Foundry JournalEntry class constructor.\r\n */\r\ntype JournalEntryConstructor = {\r\n  create: (data: unknown) => Promise<{ id: string; name?: string | null }>;\r\n};\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für JournalEntry.getFlag mit modul-spezifischen Scopes.\r\n * fvtt-types JournalEntry.getFlag hat einen restriktiven Scope-Typ (\"core\" nur),\r\n * aber Modul-Flags verwenden die Modul-ID als Scope.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Dokument die erforderlichen Methoden `getFlag` und `setFlag` hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param document - Das Foundry-Dokument (unknown, da Typen variieren)\r\n * @returns Result mit dem Dokument mit getFlag/setFlag-Methoden oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methoden `getFlag` und `setFlag`\r\n * vorhanden sind. Dies stellt sicher, dass das Dokument die erwartete\r\n * API-Struktur für Flag-Operationen hat.\r\n *\r\n * @see {@link DynamicSettingsApi} Für ähnliche Cast-Funktionen mit Runtime-Validierung\r\n */\r\nexport function castFoundryDocumentForFlag(\r\n  document: unknown\r\n): Result<DocumentWithFlags, FoundryError> {\r\n  if (!isObjectWithMethods(document, [\"getFlag\", \"setFlag\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"VALIDATION_FAILED\",\r\n        \"Document does not have required methods (getFlag, setFlag)\",\r\n        {\r\n          missingMethods: [\"getFlag\", \"setFlag\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n  return ok(document as DocumentWithFlags);\r\n}\r\n\r\n/**\r\n * Kapselt den Cast nach Runtime-Type-Check für FoundryError.\r\n * Wird verwendet, wenn bereits zur Laufzeit geprüft wurde, dass das Error-Objekt\r\n * die FoundryError-Struktur hat (code, message vorhanden).\r\n *\r\n * @param error - Das Error-Objekt (unknown, da es verschiedene Fehlerquellen gibt)\r\n * @returns Das Error als FoundryError gecastet\r\n */\r\nexport function castFoundryError(error: unknown): FoundryError {\r\n  return error as FoundryError;\r\n}\r\n\r\n/**\r\n * Kapselt den Cast für Disposable-Interface in FoundryServiceBase.\r\n * Ports sind als generischer unknown typisiert, aber zur Laufzeit\r\n * kann geprüft werden, ob sie das Disposable-Interface implementieren.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass der Port das `dispose`-Interface implementiert. Wenn nicht, wird `null`\r\n * zurückgegeben (analog zu `extractHtmlElement`), da dies ein optionales Feature ist.\r\n *\r\n * @param port - Der Port (unknown, da generischer unknown)\r\n * @returns Der Port als Disposable gecastet oder null, wenn nicht verfügbar\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob der Port eine `dispose`-Methode hat.\r\n * Dies ist konsistent mit anderen optionalen Type-Guards wie `extractHtmlElement`,\r\n * die ebenfalls `null` zurückgeben statt ein Result-Pattern zu verwenden.\r\n *\r\n * @see {@link extractHtmlElement} Für ähnliche optional Type-Guards mit null-Rückgabe\r\n */\r\nexport function castDisposablePort(port: unknown): Disposable | null {\r\n  if (!port || typeof port !== \"object\") {\r\n    return null;\r\n  }\r\n  if (hasMethod(port, \"dispose\")) {\r\n    return port as Disposable;\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Type-Guard für Non-Empty-Arrays mit Result-Pattern.\r\n * Stellt sicher, dass ein Array mindestens ein Element hat.\r\n * Ersetzt Non-Null-Assertions durch type-safe Guards.\r\n *\r\n * @template T - Der Element-Typ\r\n * @param arr - Das Array, das geprüft werden soll\r\n * @returns Result mit type-narrowed non-empty array oder FoundryError\r\n */\r\nexport function ensureNonEmptyArray<T>(arr: T[]): Result<[T, ...T[]], FoundryError> {\r\n  if (arr.length === 0) {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Array must not be empty\", { arrayLength: 0 })\r\n    );\r\n  }\r\n  return ok(arr as [T, ...T[]]);\r\n}\r\n\r\n/**\r\n * Extracts HTMLElement from hook argument.\r\n *\r\n * In Foundry VTT V13+, hooks receive native HTMLElement directly.\r\n * jQuery support has been deprecated and is no longer needed.\r\n *\r\n * @param html - The hook argument (unknown type)\r\n * @returns HTMLElement if the argument is an HTMLElement, null otherwise\r\n */\r\nexport function extractHtmlElement(html: unknown): HTMLElement | null {\r\n  return html instanceof HTMLElement ? html : null;\r\n}\r\n\r\n/**\r\n * Gets a factory from a Map or returns an error if not found.\r\n *\r\n * This is a defensive check: theoretically, if a version exists in the Map keys,\r\n * the factory should also exist. However, TypeScript's type system doesn't\r\n * guarantee this, so the check exists for type safety.\r\n *\r\n * @template T - The type that the factory creates\r\n * @param factories - Map of version numbers to factory functions\r\n * @param version - The version to look up\r\n * @returns Result with factory function or error\r\n */\r\nexport function getFactoryOrError<T>(\r\n  factories: Map<number, () => T>,\r\n  version: number\r\n): Result<() => T, FoundryError> {\r\n  const factory = factories.get(version);\r\n  if (!factory) {\r\n    return err(\r\n      createFoundryError(\"PORT_NOT_FOUND\", `Factory for version ${version} not found in registry`, {\r\n        version,\r\n      })\r\n    );\r\n  }\r\n  return ok(factory);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für Dokumente mit update-Methode.\r\n * Wird verwendet, wenn ein Dokument zur Laufzeit geprüft werden muss,\r\n * ob es eine update-Methode hat (z.B. als Fallback für unsetFlag).\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass das Dokument die erforderliche `update`-Methode hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @param document - Das Foundry-Dokument (unknown, da Typen variieren)\r\n * @returns Result mit dem Dokument mit update-Methode oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob die Methode `update` vorhanden ist.\r\n * Dies stellt sicher, dass das Dokument die erwartete API-Struktur für\r\n * Update-Operationen hat.\r\n *\r\n * @see {@link castFoundryDocumentForFlag} Für ähnliche Cast-Funktionen mit Runtime-Validierung\r\n */\r\nexport function castFoundryDocumentWithUpdate<\r\n  TDocument extends { id: string } = { id: string; name?: string | null },\r\n>(document: unknown): Result<DocumentWithUpdate<TDocument>, FoundryError> {\r\n  if (!isObjectWithMethods(document, [\"update\"])) {\r\n    return err(\r\n      createFoundryError(\"VALIDATION_FAILED\", \"Document does not have required method (update)\", {\r\n        missingMethods: [\"update\"],\r\n      })\r\n    );\r\n  }\r\n  // type-coverage:ignore-next-line - Runtime cast required for Foundry document update\r\n  return ok(document as DocumentWithUpdate<TDocument>);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für globalThis.JournalEntry.\r\n * Foundry VTT stellt JournalEntry als globale Klasse zur Verfügung,\r\n * aber TypeScript kann dies nicht statisch prüfen.\r\n *\r\n * Diese Funktion führt eine Runtime-Validierung durch, um sicherzustellen,\r\n * dass JournalEntry vorhanden ist und die erforderliche `create`-Methode hat.\r\n * Bei Fehlern wird ein FoundryError zurückgegeben statt einen Error zu werfen,\r\n * um konsistent mit dem Result-Pattern zu bleiben.\r\n *\r\n * @returns Result mit JournalEntry-Konstruktor oder FoundryError\r\n *\r\n * @remarks\r\n * Die Validierung prüft zur Laufzeit, ob JournalEntry im globalThis verfügbar ist\r\n * und die Methode `create` hat. Dies stellt sicher, dass die Foundry-API\r\n * korrekt geladen ist.\r\n */\r\nexport function castFoundryJournalEntryClass(): Result<JournalEntryConstructor, FoundryError> {\r\n  // Check if globalThis has JournalEntry property\r\n  /* c8 ignore next 2 -- typeof globalThis !== \"object\" is always false (globalThis is always an object), globalThis === null is always false (globalThis is never null) */\r\n  if (typeof globalThis !== \"object\" || globalThis === null || !(\"JournalEntry\" in globalThis)) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"Foundry JournalEntry class not available in globalThis\",\r\n        {}\r\n      )\r\n    );\r\n  }\r\n\r\n  const journalEntryClass = (globalThis as Record<string, unknown>).JournalEntry;\r\n\r\n  if (!isObjectWithMethods(journalEntryClass, [\"create\"])) {\r\n    return err(\r\n      createFoundryError(\r\n        \"API_NOT_AVAILABLE\",\r\n        \"Foundry JournalEntry class does not have required method (create)\",\r\n        {\r\n          missingMethods: [\"create\"],\r\n        }\r\n      )\r\n    );\r\n  }\r\n\r\n  return ok(journalEntryClass as JournalEntryConstructor);\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast für erstellte Foundry-Dokumente zu FoundryJournalEntry.\r\n * FoundryDocument.create() gibt einen generischen TDocument zurück, aber wir wissen,\r\n * dass es sich bei JournalEntry-Erstellungen um ein FoundryJournalEntry handelt.\r\n *\r\n * Diese Funktion kapselt den Type-Cast, der notwendig ist, weil TypeScript\r\n * den generischen Rückgabetyp von create() nicht automatisch zu FoundryJournalEntry\r\n * narrown kann.\r\n *\r\n * @param document - Das erstellte Dokument (generischer TDocument-Typ)\r\n * @returns Das Dokument als FoundryJournalEntry gecastet\r\n *\r\n * @remarks\r\n * Diese Funktion sollte nur verwendet werden, wenn sichergestellt ist, dass\r\n * das Dokument tatsächlich ein FoundryJournalEntry ist (z.B. nach create()\r\n * mit JournalEntry-Klasse).\r\n *\r\n * @see {@link castFoundryJournalEntryClass} Für das Casten der JournalEntry-Klasse\r\n */\r\nexport function castCreatedJournalEntry<TDocument extends { id: string }>(\r\n  document: TDocument\r\n): import(\"./types\").FoundryJournalEntry {\r\n  // type-coverage:ignore-next-line - Runtime cast required for generic TDocument to FoundryJournalEntry\r\n  return document as unknown as import(\"./types\").FoundryJournalEntry;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryDocument } from \"../../interfaces/FoundryDocument\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport { fromPromise, tryCatch, err } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { castFoundryError, castFoundryDocumentWithUpdate } from \"../../runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * v13 implementation of FoundryDocument interface.\r\n * Encapsulates Foundry v13-specific document operations.\r\n */\r\nexport class FoundryV13DocumentPort implements FoundryDocument {\r\n  #disposed = false;\r\n\r\n  async create<TDocument extends { id: string }>(\r\n    documentClass: { create: (data: unknown) => Promise<TDocument> },\r\n    data: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot create document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<TDocument, FoundryError>(documentClass.create(data), (error) =>\r\n      createFoundryError(\"OPERATION_FAILED\", \"Failed to create document\", { data }, error)\r\n    );\r\n  }\r\n\r\n  async update<TDocument extends { id: string }>(\r\n    document: { update: (changes: unknown) => Promise<TDocument> },\r\n    changes: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot update document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<TDocument, FoundryError>(document.update(changes), (error) =>\r\n      createFoundryError(\"OPERATION_FAILED\", \"Failed to update document\", { changes }, error)\r\n    );\r\n  }\r\n\r\n  async delete(document: { delete: () => Promise<unknown> }): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot delete document on disposed port\"));\r\n    }\r\n\r\n    return fromPromise<void, FoundryError>(\r\n      document.delete().then(() => undefined),\r\n      (error) =>\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to delete document\", undefined, error)\r\n    );\r\n  }\r\n\r\n  getFlag<T>(\r\n    document: { getFlag: (scope: string, key: string) => unknown },\r\n    scope: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot get flag on disposed port\", { scope, key }),\r\n      };\r\n    }\r\n    return tryCatch(\r\n      () => {\r\n        if (!document?.getFlag) {\r\n          throw new Error(\"Document does not have getFlag method\");\r\n        }\r\n\r\n        const rawValue = document.getFlag(scope, key);\r\n\r\n        // Handle null/undefined as valid \"not set\" state\r\n        if (rawValue === null || rawValue === undefined) {\r\n          return null;\r\n        }\r\n\r\n        // Runtime validation with Valibot\r\n        const parseResult = v.safeParse(schema, rawValue);\r\n\r\n        if (!parseResult.success) {\r\n          const error = createFoundryError(\r\n            \"VALIDATION_FAILED\",\r\n            `Flag ${scope}.${key} failed validation: ${parseResult.issues.map((i) => i.message).join(\", \")}`,\r\n            { scope, key, rawValue, issues: parseResult.issues }\r\n          );\r\n          throw error;\r\n        }\r\n\r\n        return parseResult.output;\r\n      },\r\n      (error) => {\r\n        // Check if it's already a FoundryError (from validation)\r\n        if (error && typeof error === \"object\" && \"code\" in error && \"message\" in error) {\r\n          return castFoundryError(error);\r\n        }\r\n        // Otherwise wrap as OPERATION_FAILED\r\n        return createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get flag ${scope}.${key}`,\r\n          { scope, key },\r\n          error\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  async setFlag<T = unknown>(\r\n    document: { setFlag: (scope: string, key: string, value: T) => Promise<unknown> },\r\n    scope: string,\r\n    key: string,\r\n    value: T\r\n  ): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot set flag on disposed port\", { scope, key }),\r\n      };\r\n    }\r\n    return fromPromise<void, FoundryError>(\r\n      (async () => {\r\n        if (!document?.setFlag) {\r\n          throw new Error(\"Document does not have setFlag method\");\r\n        }\r\n        await document.setFlag(scope, key, value);\r\n      })(),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to set flag ${scope}.${key}`,\r\n          { scope, key, value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  async unsetFlag(\r\n    document: {\r\n      unsetFlag?: (scope: string, key: string) => Promise<unknown>;\r\n      setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n    },\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot unset flag on disposed port\", { scope, key })\r\n      );\r\n    }\r\n\r\n    return fromPromise<void, FoundryError>(\r\n      (async () => {\r\n        // Use unsetFlag if available (recommended)\r\n        if (document.unsetFlag) {\r\n          await document.unsetFlag(scope, key);\r\n        } else {\r\n          // Fallback: Use update with \"-=\" syntax\r\n          // Document must have update method for fallback\r\n          const docWithUpdateResult = castFoundryDocumentWithUpdate(document);\r\n          if (!docWithUpdateResult.ok) {\r\n            throw new Error(\r\n              `Document does not support unsetFlag or update: ${docWithUpdateResult.error.message}`\r\n            );\r\n          }\r\n          await docWithUpdateResult.value.update({\r\n            [`flags.${scope}.-=${key}`]: null,\r\n          });\r\n        }\r\n      })(),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to unset flag ${scope}.${key}`,\r\n          { scope, key },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryUI, FoundryNotificationOptions } from \"../../interfaces/FoundryUI\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport type {\r\n  IFoundryUIAPI,\r\n  IFoundryGameJournalAPI,\r\n  IFoundryDocumentAPI,\r\n} from \"../../api/foundry-api.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { sanitizeId } from \"../../validation/schemas\";\r\n\r\n/**\r\n * v13 implementation of FoundryUI interface.\r\n * Encapsulates Foundry v13-specific UI manipulation.\r\n *\r\n * Uses dependency injection for Foundry APIs to improve testability.\r\n */\r\nexport class FoundryV13UIPort implements FoundryUI {\r\n  #disposed = false;\r\n\r\n  constructor(\r\n    private readonly foundryUIAPI: IFoundryUIAPI,\r\n    private readonly foundryGameJournalAPI: IFoundryGameJournalAPI,\r\n    private readonly foundryDocumentAPI: IFoundryDocumentAPI\r\n  ) {}\r\n\r\n  removeJournalDirectoryEntry(\r\n    directoryId: string,\r\n    journalId: string,\r\n    journalName: string\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot remove journal directory entry on disposed port\")\r\n      );\r\n    }\r\n\r\n    // Get directory element internally (DIP-compliant: Application layer doesn't need HTMLElement)\r\n    const elementResult = this.getDirectoryElement(directoryId);\r\n    if (!elementResult.ok) {\r\n      return err(elementResult.error);\r\n    }\r\n\r\n    const html = elementResult.value;\r\n    if (!html) {\r\n      return err(\r\n        createFoundryError(\r\n          \"NOT_FOUND\",\r\n          `Directory element not found for directory: ${directoryId}`,\r\n          { directoryId, journalId, journalName }\r\n        )\r\n      );\r\n    }\r\n\r\n    // Sanitize ID to prevent CSS injection\r\n    const safeId = sanitizeId(journalId);\r\n\r\n    // Support both selectors: Foundry v13 uses data-document-id, older versions used data-entry-id\r\n    // This finds the <li> element that represents the journal in the sidebar list (directory entry)\r\n    const element = html.querySelector(\r\n      `li.directory-item[data-document-id=\"${safeId}\"], li.directory-item[data-entry-id=\"${safeId}\"]`\r\n    ) as HTMLElement | null;\r\n\r\n    if (!element) {\r\n      return err(\r\n        createFoundryError(\r\n          \"NOT_FOUND\",\r\n          `Could not find directory entry for journal: ${journalName}`,\r\n          { journalName, journalId: safeId }\r\n        )\r\n      );\r\n    }\r\n\r\n    try {\r\n      element.remove();\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          \"Failed to remove element from DOM\",\r\n          { journalName, journalId: safeId },\r\n          error\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  findElement(container: HTMLElement, selector: string): Result<HTMLElement | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot find element on disposed port\"));\r\n    }\r\n    // Use container's querySelector directly (not injected API, as container is passed as parameter)\r\n    const element = container.querySelector(selector) as HTMLElement | null;\r\n    return ok(element);\r\n  }\r\n\r\n  notify(\r\n    message: string,\r\n    type: \"info\" | \"warning\" | \"error\",\r\n    options?: FoundryNotificationOptions\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot show notification on disposed port\"));\r\n    }\r\n    if (!this.foundryUIAPI?.notifications) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry UI notifications not available\"));\r\n    }\r\n\r\n    try {\r\n      switch (type) {\r\n        case \"info\":\r\n          this.foundryUIAPI.notifications.info(message, options);\r\n          break;\r\n        case \"warning\":\r\n          this.foundryUIAPI.notifications.warn(message, options);\r\n          break;\r\n        case \"error\":\r\n          this.foundryUIAPI.notifications.error(message, options);\r\n          break;\r\n      }\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          \"Failed to show notification\",\r\n          { message, type },\r\n          error\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  getDirectoryElement(directoryId: string): Result<HTMLElement | null, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(createFoundryError(\"DISPOSED\", \"Cannot get directory element on disposed port\"));\r\n    }\r\n\r\n    try {\r\n      // For Foundry, directoryId is typically \"journal\"\r\n      // The journal directory element is found via #journal selector\r\n      if (directoryId === \"journal\") {\r\n        const element = this.foundryDocumentAPI.querySelector(\"#journal\") as HTMLElement | null;\r\n        return ok(element);\r\n      }\r\n\r\n      // For other directory IDs, return null (not found)\r\n      return ok(null);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          \"Failed to get directory element\",\r\n          { directoryId },\r\n          error\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot rerender journal directory on disposed port\")\r\n      );\r\n    }\r\n\r\n    try {\r\n      const journalElement = this.foundryDocumentAPI.querySelector(\"#journal\");\r\n      if (!journalElement) {\r\n        return ok(false);\r\n      }\r\n\r\n      // Foundry v13: Use game.journal.directory.render() directly\r\n      // ui.sidebar.tabs.journal is not accessible via public API in v13\r\n      let rendered = false;\r\n      if (this.foundryGameJournalAPI.directory?.render) {\r\n        this.foundryGameJournalAPI.directory.render();\r\n        rendered = true;\r\n      }\r\n\r\n      return ok(rendered);\r\n    } catch (error) {\r\n      return err(\r\n        createFoundryError(\"OPERATION_FAILED\", \"Failed to re-render journal directory\", {}, error)\r\n      );\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13UIPort instance for production use.\r\n * Injects real Foundry UI and game APIs.\r\n *\r\n * @returns FoundryV13UIPort instance\r\n */\r\nexport function createFoundryV13UIPort(): FoundryV13UIPort {\r\n  if (typeof ui === \"undefined\" || !ui?.notifications) {\r\n    throw new Error(\"Foundry UI API not available\");\r\n  }\r\n\r\n  if (typeof game === \"undefined\" || !game?.journal) {\r\n    throw new Error(\"Foundry game API not available\");\r\n  }\r\n\r\n  const uiAPI: IFoundryUIAPI = {\r\n    notifications: {\r\n      info: (message: string, options?: FoundryNotificationOptions) => {\r\n        if (ui.notifications) {\r\n          ui.notifications.info(message, options);\r\n        }\r\n      },\r\n      warn: (message: string, options?: FoundryNotificationOptions) => {\r\n        if (ui.notifications) {\r\n          ui.notifications.warn(message, options);\r\n        }\r\n      },\r\n      error: (message: string, options?: FoundryNotificationOptions) => {\r\n        if (ui.notifications) {\r\n          ui.notifications.error(message, options);\r\n        }\r\n      },\r\n    },\r\n  };\r\n\r\n  // Note: Foundry v13's ui.sidebar.tabs.journal is not accessible via public API\r\n  // The rerenderJournalDirectory() method uses game.journal.directory.render() as fallback\r\n\r\n  return new FoundryV13UIPort(\r\n    uiAPI,\r\n    {\r\n      contents: Array.from(game.journal.contents),\r\n      get: (id: string) => game.journal.get(id),\r\n      ...(game.journal.directory && game.journal.directory.render\r\n        ? {\r\n            directory: {\r\n              render: () => {\r\n                game.journal.directory?.render();\r\n              },\r\n            },\r\n          }\r\n        : {}),\r\n    },\r\n    {\r\n      querySelector: (selector: string) => document.querySelector(selector),\r\n    }\r\n  );\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundrySettings, SettingConfig } from \"../../interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport type { IFoundrySettingsAPI } from \"../../api/foundry-api.interface\";\r\nimport { tryCatch, err, fromPromise } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\nimport { validateSettingConfig } from \"../../validation/schemas\";\r\nimport { castFoundrySettingsApi, castFoundryError } from \"../../runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * v13 implementation of FoundrySettings interface.\r\n * Encapsulates Foundry v13-specific settings API access.\r\n *\r\n * Supports all three setting scopes:\r\n * - world: Shared across all users in the world\r\n * - client: Browser/device-specific\r\n * - user: User-specific within a world (new in v13)\r\n *\r\n * Uses dependency injection for Foundry APIs to improve testability.\r\n */\r\nexport class FoundryV13SettingsPort implements FoundrySettings {\r\n  #disposed = false;\r\n\r\n  constructor(private readonly foundryAPI: IFoundrySettingsAPI | null) {}\r\n\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: SettingConfig<T>\r\n  ): Result<void, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot register setting on disposed port\", {\r\n          namespace,\r\n          key,\r\n        })\r\n      );\r\n    }\r\n    // Validate config before attempting registration\r\n    const configValidation = validateSettingConfig(namespace, key, config);\r\n    if (!configValidation.ok) {\r\n      return err(configValidation.error);\r\n    }\r\n\r\n    if (!this.foundryAPI) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    const api = this.foundryAPI;\r\n    return tryCatch(\r\n      () => {\r\n        api.register(namespace, key, config);\r\n        return undefined;\r\n      },\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to register setting ${namespace}.${key}`,\r\n          { namespace, key },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  get<T>(\r\n    namespace: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T, FoundryError> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot get setting on disposed port\", { namespace, key })\r\n      );\r\n    }\r\n    if (!this.foundryAPI) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    const api = this.foundryAPI;\r\n    return tryCatch(\r\n      () => {\r\n        const rawValue = api.get(namespace, key);\r\n\r\n        // Runtime validation with Valibot\r\n        const parseResult = v.safeParse(schema, rawValue);\r\n\r\n        if (!parseResult.success) {\r\n          const error = createFoundryError(\r\n            \"VALIDATION_FAILED\",\r\n            `Setting ${namespace}.${key} failed validation: ${parseResult.issues.map((i) => i.message).join(\", \")}`,\r\n            { namespace, key, rawValue, issues: parseResult.issues }\r\n          );\r\n          throw error;\r\n        }\r\n\r\n        return parseResult.output;\r\n      },\r\n      (error) => {\r\n        // Check if it's a VALIDATION_FAILED error (from our own validation)\r\n        // These should be preserved as-is\r\n        if (\r\n          error &&\r\n          typeof error === \"object\" &&\r\n          \"code\" in error &&\r\n          error.code === \"VALIDATION_FAILED\"\r\n        ) {\r\n          return castFoundryError(error);\r\n        }\r\n        // All other errors (including API errors) should be wrapped as OPERATION_FAILED\r\n        return createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to get setting ${namespace}.${key}`,\r\n          { namespace, key },\r\n          error\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, FoundryError>> {\r\n    if (this.#disposed) {\r\n      return err(\r\n        createFoundryError(\"DISPOSED\", \"Cannot set setting on disposed port\", { namespace, key })\r\n      );\r\n    }\r\n    if (!this.foundryAPI) {\r\n      return err(createFoundryError(\"API_NOT_AVAILABLE\", \"Foundry settings API not available\"));\r\n    }\r\n\r\n    return fromPromise(\r\n      this.foundryAPI.set(namespace, key, value).then(() => undefined),\r\n      (error) =>\r\n        createFoundryError(\r\n          \"OPERATION_FAILED\",\r\n          `Failed to set setting ${namespace}.${key}`,\r\n          { namespace, key, value },\r\n          error\r\n        )\r\n    );\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13SettingsPort instance for production use.\r\n * Injects real Foundry settings API.\r\n *\r\n * @returns FoundryV13SettingsPort instance\r\n */\r\nexport function createFoundryV13SettingsPort(): FoundryV13SettingsPort {\r\n  // Create port even if API is not available - port will return API_NOT_AVAILABLE errors\r\n  if (typeof game === \"undefined\" || game === null || game.settings === undefined) {\r\n    return new FoundryV13SettingsPort(null);\r\n  }\r\n\r\n  // Try to cast game.settings if it exists (even if it's null or invalid)\r\n  // This allows castFoundrySettingsApi to handle the validation and return appropriate errors\r\n  const settingsResult = castFoundrySettingsApi(game.settings);\r\n  if (!settingsResult.ok) {\r\n    // Return port with error-throwing API when cast fails - will return OPERATION_FAILED errors\r\n    const castError = settingsResult.error;\r\n    return new FoundryV13SettingsPort({\r\n      register: () => {\r\n        throw castError;\r\n      },\r\n      get: () => {\r\n        throw castError;\r\n      },\r\n      set: async () => {\r\n        throw castError;\r\n      },\r\n    });\r\n  }\r\n  const settings = settingsResult.value;\r\n\r\n  return new FoundryV13SettingsPort({\r\n    register: <T>(namespace: string, key: string, config: SettingConfig<T>) => {\r\n      settings.register(namespace, key, config);\r\n    },\r\n    get: <T>(namespace: string, key: string) => {\r\n      return settings.get<T>(namespace, key);\r\n    },\r\n    set: (namespace: string, key: string, value: unknown) => {\r\n      return settings.set(namespace, key, value).then(() => undefined);\r\n    },\r\n  });\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryI18n } from \"../../interfaces/FoundryI18n\";\r\nimport type { FoundryError } from \"../../errors/FoundryErrors\";\r\nimport type { IFoundryI18nAPI } from \"../../api/foundry-api.interface\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport { createFoundryError } from \"../../errors/FoundryErrors\";\r\n\r\n/**\r\n * Foundry VTT v13+ implementation of the i18n interface.\r\n *\r\n * Wraps `game.i18n` API with Result pattern for type-safe error handling.\r\n *\r\n * Uses dependency injection for Foundry APIs to improve testability.\r\n *\r\n * @implements {FoundryI18n}\r\n */\r\nexport class FoundryV13I18nPort implements FoundryI18n {\r\n  #disposed = false;\r\n  static dependencies = [] as const;\r\n\r\n  constructor(private readonly foundryAPI: IFoundryI18nAPI | null) {}\r\n\r\n  /**\r\n   * Localizes a translation key using Foundry's i18n system.\r\n   *\r\n   * @param key - Translation key\r\n   * @returns Result with translated string (returns key itself if not found)\r\n   */\r\n  localize(key: string): Result<string, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot localize on disposed port\", { key }),\r\n      };\r\n    }\r\n    try {\r\n      if (!this.foundryAPI) {\r\n        return ok(key); // Graceful degradation: return key as-is\r\n      }\r\n\r\n      const translated = this.foundryAPI.localize(key);\r\n      return ok(translated);\r\n    } catch {\r\n      return ok(key); // Fallback: return key on error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formats a translation key with placeholder values.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @returns Result with formatted string\r\n   */\r\n  format(key: string, data: Record<string, unknown>): Result<string, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot format translation on disposed port\", {\r\n          key,\r\n        }),\r\n      };\r\n    }\r\n    try {\r\n      if (!this.foundryAPI) {\r\n        return ok(key); // Graceful degradation\r\n      }\r\n\r\n      // Convert unknown values to strings for Foundry's type requirements\r\n      const stringData: Record<string, string> = {};\r\n      for (const [k, v] of Object.entries(data)) {\r\n        stringData[k] = String(v);\r\n      }\r\n\r\n      const formatted = this.foundryAPI.format(key, stringData);\r\n      return ok(formatted);\r\n    } catch {\r\n      return ok(key); // Fallback: return key on error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with boolean indicating existence\r\n   */\r\n  has(key: string): Result<boolean, FoundryError> {\r\n    if (this.#disposed) {\r\n      return {\r\n        ok: false,\r\n        error: createFoundryError(\"DISPOSED\", \"Cannot check translation key on disposed port\", {\r\n          key,\r\n        }),\r\n      };\r\n    }\r\n    try {\r\n      if (!this.foundryAPI) {\r\n        return ok(false); // No game.i18n available → key doesn't exist\r\n      }\r\n\r\n      const exists = this.foundryAPI.has(key);\r\n      return ok(exists);\r\n    } catch {\r\n      return ok(false); // Fallback: assume key doesn't exist on error\r\n    }\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.#disposed) return; // Idempotent\r\n    this.#disposed = true;\r\n    // No resources to clean up\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13I18nPort instance for production use.\r\n * Injects real Foundry i18n API.\r\n *\r\n * @returns FoundryV13I18nPort instance\r\n */\r\nexport function createFoundryV13I18nPort(): FoundryV13I18nPort {\r\n  if (typeof game === \"undefined\" || !game?.i18n) {\r\n    // Return port with null API for graceful degradation\r\n    return new FoundryV13I18nPort(null);\r\n  }\r\n\r\n  return new FoundryV13I18nPort({\r\n    localize: (key: string) => game.i18n.localize(key),\r\n    format: (key: string, data: Record<string, string>) => game.i18n.format(key, data),\r\n    has: (key: string) => game.i18n.has(key),\r\n  });\r\n}\r\n","import type { FoundryModule } from \"../../interfaces/FoundryModule\";\r\n\r\n/**\r\n * Foundry V13 implementation of FoundryModule.\r\n *\r\n * Uses game.modules.get(moduleId).ready to set module ready state.\r\n */\r\nexport class FoundryV13ModulePort implements FoundryModule {\r\n  setModuleReady(moduleId: string): boolean {\r\n    if (typeof game === \"undefined\" || !game?.modules) {\r\n      return false;\r\n    }\r\n\r\n    const mod = game.modules.get(moduleId);\r\n    if (!mod) {\r\n      return false;\r\n    }\r\n\r\n    // Type assertion: ready property is defined in global.d.ts\r\n    mod.ready = true;\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create FoundryV13ModulePort instance.\r\n * Used by PortRegistry for dependency injection.\r\n */\r\nexport function createFoundryV13ModulePort(): FoundryModule {\r\n  return new FoundryV13ModulePort();\r\n}\r\n","/**\r\n * Injection token for FoundryGame port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13GamePort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13GamePort\";\r\n\r\n/**\r\n * Injection token for FoundryGame port v13 implementation.\r\n *\r\n * These tokens are used to register and resolve version-specific port implementations\r\n * via the DI container, ensuring DIP (Dependency Inversion Principle) compliance.\r\n *\r\n * Ports are registered in the container during bootstrap and resolved by PortSelector\r\n * based on the current Foundry version.\r\n */\r\nexport const foundryV13GamePortToken =\r\n  createInjectionToken<FoundryV13GamePort>(\"FoundryV13GamePort\");\r\n","/**\r\n * Injection token for FoundryHooks port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13HooksPort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13HooksPort\";\r\n\r\n/**\r\n * Injection token for FoundryHooks port v13 implementation.\r\n */\r\nexport const foundryV13HooksPortToken =\r\n  createInjectionToken<FoundryV13HooksPort>(\"FoundryV13HooksPort\");\r\n","/**\r\n * Injection token for FoundryDocument port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13DocumentPort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13DocumentPort\";\r\n\r\n/**\r\n * Injection token for FoundryDocument port v13 implementation.\r\n */\r\nexport const foundryV13DocumentPortToken =\r\n  createInjectionToken<FoundryV13DocumentPort>(\"FoundryV13DocumentPort\");\r\n","/**\r\n * Injection token for FoundryUI port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13UIPort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13UIPort\";\r\n\r\n/**\r\n * Injection token for FoundryUI port v13 implementation.\r\n */\r\nexport const foundryV13UIPortToken = createInjectionToken<FoundryV13UIPort>(\"FoundryV13UIPort\");\r\n","/**\r\n * Injection token for FoundrySettings port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13SettingsPort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13SettingsPort\";\r\n\r\n/**\r\n * Injection token for FoundrySettings port v13 implementation.\r\n */\r\nexport const foundryV13SettingsPortToken =\r\n  createInjectionToken<FoundryV13SettingsPort>(\"FoundryV13SettingsPort\");\r\n","/**\r\n * Injection token for FoundryI18n port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13I18nPort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13I18nPort\";\r\n\r\n/**\r\n * Injection token for FoundryI18n port v13 implementation.\r\n */\r\nexport const foundryV13I18nPortToken =\r\n  createInjectionToken<FoundryV13I18nPort>(\"FoundryV13I18nPort\");\r\n","/**\r\n * Injection token for FoundryModule port v13 implementation.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryV13ModulePort } from \"@/infrastructure/adapters/foundry/ports/v13/FoundryV13ModulePort\";\r\n\r\n/**\r\n * Injection token for FoundryModule port v13 implementation.\r\n */\r\nexport const foundryV13ModulePortToken =\r\n  createInjectionToken<FoundryV13ModulePort>(\"FoundryV13ModulePort\");\r\n","/**\r\n * Port registration for Foundry VTT v13.\r\n * This file is part of the \"Concrete Platform Concrete Version\" layer.\r\n * It registers all v13 port implementations into the DI container and their respective registries.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\nimport type { FoundryModule } from \"@/infrastructure/adapters/foundry/interfaces/FoundryModule\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { createFoundryV13GamePort } from \"./FoundryV13GamePort\";\r\nimport { createFoundryV13HooksPort } from \"./FoundryV13HooksPort\";\r\nimport { FoundryV13DocumentPort } from \"./FoundryV13DocumentPort\";\r\nimport { createFoundryV13UIPort } from \"./FoundryV13UIPort\";\r\nimport { createFoundryV13SettingsPort } from \"./FoundryV13SettingsPort\";\r\nimport { createFoundryV13I18nPort } from \"./FoundryV13I18nPort\";\r\nimport { createFoundryV13ModulePort } from \"./FoundryV13ModulePort\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { foundryV13GamePortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-game-port.token\";\r\nimport { foundryV13HooksPortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-hooks-port.token\";\r\nimport { foundryV13DocumentPortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-document-port.token\";\r\nimport { foundryV13UIPortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-ui-port.token\";\r\nimport { foundryV13SettingsPortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-settings-port.token\";\r\nimport { foundryV13I18nPortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-i18n-port.token\";\r\nimport { foundryV13ModulePortToken } from \"@/infrastructure/shared/tokens/foundry/foundry-v13-module-port.token\";\r\n\r\n/**\r\n * Helper function for port registration.\r\n * Reduces duplication when registering multiple ports.\r\n */\r\nfunction registerPortToRegistry<T>(\r\n  registry: PortRegistry<T>,\r\n  version: number,\r\n  token: InjectionToken<T>,\r\n  portName: string,\r\n  errors: string[]\r\n): void {\r\n  const result = registry.register(version, token);\r\n  if (isErr(result)) {\r\n    errors.push(`${portName} v${version}: ${result.error}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Registers all v13 port implementations into the DI container and their respective registries.\r\n *\r\n * This function is called from the version-agnostic config layer to populate\r\n * port registries with v13-specific implementations. Ports are registered in the\r\n * DI container first, then their tokens are stored in the registries for later resolution.\r\n *\r\n * @param registries - Object containing all port registries to populate\r\n * @param container - Service container for dependency injection\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerV13Ports(\r\n  registries: {\r\n    gamePortRegistry: PortRegistry<FoundryGame>;\r\n    hooksPortRegistry: PortRegistry<FoundryHooks>;\r\n    documentPortRegistry: PortRegistry<FoundryDocument>;\r\n    uiPortRegistry: PortRegistry<FoundryUI>;\r\n    settingsPortRegistry: PortRegistry<FoundrySettings>;\r\n    i18nPortRegistry: PortRegistry<FoundryI18n>;\r\n    modulePortRegistry: PortRegistry<FoundryModule>;\r\n  },\r\n  container: ServiceContainer\r\n): Result<void, string> {\r\n  const portRegistrationErrors: string[] = [];\r\n\r\n  // Register all v13 port factories with the DI container (VOR PortRegistry-Registrierungen)\r\n  // Using factory functions to inject Foundry APIs for better testability\r\n  const gamePortResult = container.registerFactory(\r\n    foundryV13GamePortToken,\r\n    createFoundryV13GamePort,\r\n    ServiceLifecycle.SINGLETON,\r\n    [] // No dependencies\r\n  );\r\n  if (isErr(gamePortResult)) {\r\n    portRegistrationErrors.push(`FoundryGame: ${gamePortResult.error.message}`);\r\n  }\r\n\r\n  const hooksPortResult = container.registerFactory(\r\n    foundryV13HooksPortToken,\r\n    createFoundryV13HooksPort,\r\n    ServiceLifecycle.SINGLETON,\r\n    [] // No dependencies\r\n  );\r\n  if (isErr(hooksPortResult)) {\r\n    portRegistrationErrors.push(`FoundryHooks: ${hooksPortResult.error.message}`);\r\n  }\r\n\r\n  // FoundryV13DocumentPort doesn't use Foundry APIs directly, so it can stay as class registration\r\n  container.registerClass(\r\n    foundryV13DocumentPortToken,\r\n    FoundryV13DocumentPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  const uiPortResult = container.registerFactory(\r\n    foundryV13UIPortToken,\r\n    createFoundryV13UIPort,\r\n    ServiceLifecycle.SINGLETON,\r\n    [] // No dependencies\r\n  );\r\n  if (isErr(uiPortResult)) {\r\n    portRegistrationErrors.push(`FoundryUI: ${uiPortResult.error.message}`);\r\n  }\r\n\r\n  const settingsPortResult = container.registerFactory(\r\n    foundryV13SettingsPortToken,\r\n    createFoundryV13SettingsPort,\r\n    ServiceLifecycle.SINGLETON,\r\n    [] // No dependencies\r\n  );\r\n  if (isErr(settingsPortResult)) {\r\n    portRegistrationErrors.push(`FoundrySettings: ${settingsPortResult.error.message}`);\r\n  }\r\n\r\n  const i18nPortResult = container.registerFactory(\r\n    foundryV13I18nPortToken,\r\n    createFoundryV13I18nPort,\r\n    ServiceLifecycle.SINGLETON,\r\n    [] // No dependencies\r\n  );\r\n  if (isErr(i18nPortResult)) {\r\n    portRegistrationErrors.push(`FoundryI18n: ${i18nPortResult.error.message}`);\r\n  }\r\n\r\n  container.registerValue(foundryV13ModulePortToken, createFoundryV13ModulePort());\r\n\r\n  // Register FoundryGame port token in registry\r\n  registerPortToRegistry(\r\n    registries.gamePortRegistry,\r\n    13,\r\n    foundryV13GamePortToken,\r\n    \"FoundryGame\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryHooks port token in registry\r\n  registerPortToRegistry(\r\n    registries.hooksPortRegistry,\r\n    13,\r\n    foundryV13HooksPortToken,\r\n    \"FoundryHooks\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryDocument port token in registry\r\n  registerPortToRegistry(\r\n    registries.documentPortRegistry,\r\n    13,\r\n    foundryV13DocumentPortToken,\r\n    \"FoundryDocument\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryUI port token in registry\r\n  registerPortToRegistry(\r\n    registries.uiPortRegistry,\r\n    13,\r\n    foundryV13UIPortToken,\r\n    \"FoundryUI\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundrySettings port token in registry\r\n  registerPortToRegistry(\r\n    registries.settingsPortRegistry,\r\n    13,\r\n    foundryV13SettingsPortToken,\r\n    \"FoundrySettings\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryI18n port token in registry\r\n  registerPortToRegistry(\r\n    registries.i18nPortRegistry,\r\n    13,\r\n    foundryV13I18nPortToken,\r\n    \"FoundryI18n\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Register FoundryModule port token in registry\r\n  registerPortToRegistry(\r\n    registries.modulePortRegistry,\r\n    13,\r\n    foundryV13ModulePortToken,\r\n    \"FoundryModule\",\r\n    portRegistrationErrors\r\n  );\r\n\r\n  // Check for registration errors\r\n  if (portRegistrationErrors.length > 0) {\r\n    return err(`Port registration failed: ${portRegistrationErrors.join(\"; \")}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n","/**\r\n * Injection token for FoundryUI port.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryUIPort } from \"@/infrastructure/adapters/foundry/services/FoundryUIPort\";\r\n\r\n/**\r\n * Injection token for FoundryUI port.\r\n *\r\n * Provides access to Foundry's UI manipulation API for notifications\r\n * and DOM element management.\r\n *\r\n * @example\r\n * ```typescript\r\n * const ui = container.resolve(foundryUIToken);\r\n * ui.notify(\"Operation successful\", \"info\");\r\n * ```\r\n */\r\nexport const foundryUIToken = createInjectionToken<FoundryUIPort>(\"FoundryUI\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { PlatformUIError } from \"@/domain/ports/errors/platform-ui-error.interface\";\r\nimport type { FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui.token\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformUIPort.\r\n *\r\n * Adapts FoundryUI (Foundry-specific) to PlatformUIPort (platform-agnostic).\r\n * This allows domain/application layers to depend only on PlatformUIPort.\r\n */\r\nexport class FoundryUIAdapter implements PlatformUIPort {\r\n  constructor(private readonly foundryUI: FoundryUI) {}\r\n\r\n  removeJournalDirectoryEntry(\r\n    directoryId: string,\r\n    journalId: string,\r\n    journalName: string\r\n  ): Result<void, PlatformUIError> {\r\n    const result = this.foundryUI.removeJournalDirectoryEntry(directoryId, journalId, journalName);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"DOM_MANIPULATION_FAILED\",\r\n        message: `Failed to remove journal directory entry '${journalName}' (${journalId}) from directory '${directoryId}': ${result.error.message}`,\r\n        operation: \"removeJournalDirectoryEntry\",\r\n        details: { directoryId, journalId, journalName, cause: result.error },\r\n      });\r\n    }\r\n    return ok(undefined);\r\n  }\r\n\r\n  getDirectoryElement(directoryId: string): Result<HTMLElement | null, PlatformUIError> {\r\n    const result = this.foundryUI.getDirectoryElement(directoryId);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"DOM_ACCESS_FAILED\",\r\n        message: `Failed to get directory element for '${directoryId}': ${result.error.message}`,\r\n        operation: \"getDirectoryElement\",\r\n        details: { directoryId, cause: result.error },\r\n      });\r\n    }\r\n    return ok(result.value);\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, PlatformUIError> {\r\n    const result = this.foundryUI.rerenderJournalDirectory();\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"RERENDER_FAILED\",\r\n        message: `Failed to re-render journal directory: ${result.error.message}`,\r\n        operation: \"rerenderJournalDirectory\",\r\n        details: { cause: result.error },\r\n      });\r\n    }\r\n    return ok(result.value);\r\n  }\r\n\r\n  notify(message: string, type: \"info\" | \"warning\" | \"error\"): Result<void, PlatformUIError> {\r\n    const result = this.foundryUI.notify(message, type);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: result.error.code,\r\n        message: result.error.message,\r\n        operation: \"notify\",\r\n        details: { cause: result.error },\r\n      });\r\n    }\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryUIAdapter.\r\n */\r\nexport class DIFoundryUIAdapter extends FoundryUIAdapter {\r\n  static dependencies = [foundryUIToken] as const;\r\n\r\n  constructor(foundryUI: FoundryUI) {\r\n    super(foundryUI);\r\n  }\r\n}\r\n","import * as v from \"valibot\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\n\r\n/**\r\n * Schema for LogLevel setting values.\r\n * Validates that value is one of the defined LogLevel enum values.\r\n *\r\n * This schema is used for runtime validation of log level values.\r\n * It is defined in the infrastructure layer using valibot for validation,\r\n * following the Dependency Inversion Principle (Domain should not depend on Infrastructure).\r\n */\r\nexport const LOG_LEVEL_SCHEMA = v.picklist([\r\n  LogLevel.DEBUG,\r\n  LogLevel.INFO,\r\n  LogLevel.WARN,\r\n  LogLevel.ERROR,\r\n]);\r\n","import type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport type { ValidationError } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\nimport { LOG_LEVEL_SCHEMA } from \"@/infrastructure/validation/log-level-schema\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Valibot-based implementation of PlatformValidationPort.\r\n *\r\n * Uses Valibot for validation, but exposes a platform-agnostic interface\r\n * to maintain Clean Architecture dependency rules.\r\n */\r\nexport class ValibotValidationAdapter implements PlatformValidationPort {\r\n  /**\r\n   * Validates a log level value using Valibot schema.\r\n   *\r\n   * @param value - The value to validate\r\n   * @returns Result with validated LogLevel or validation error\r\n   */\r\n  validateLogLevel(value: unknown): Result<LogLevel, ValidationError> {\r\n    const validationResult = v.safeParse(LOG_LEVEL_SCHEMA, value);\r\n\r\n    if (!validationResult.success) {\r\n      return err({\r\n        code: \"VALIDATION_FAILED\",\r\n        message: `Invalid log level value: ${String(value)}. Must be one of: ${LogLevel.DEBUG}, ${LogLevel.INFO}, ${LogLevel.WARN}, ${LogLevel.ERROR}`,\r\n        details: validationResult.issues,\r\n      });\r\n    }\r\n\r\n    return ok(validationResult.output);\r\n  }\r\n}\r\n","import { ValibotValidationAdapter } from \"./valibot-validation-adapter\";\r\n\r\n/**\r\n * DI-enabled wrapper for ValibotValidationAdapter.\r\n * Resolves dependencies from container (currently none, but prepared for future dependencies).\r\n */\r\nexport class DIValibotValidationAdapter extends ValibotValidationAdapter {\r\n  static dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { PlatformMetricsSnapshotPort } from \"@/domain/ports/platform-metrics-snapshot-port.interface\";\r\nimport type { MetricsSnapshot } from \"@/domain/ports/platform-metrics-snapshot-port.interface\";\r\nimport type { MetricsCollector } from \"./metrics-collector\";\r\n\r\n/**\r\n * Adapter that wraps MetricsCollector to implement PlatformMetricsSnapshotPort.\r\n *\r\n * This adapter allows Application Layer to access metrics without directly\r\n * depending on Infrastructure Layer's MetricsCollector.\r\n */\r\nexport class MetricsSnapshotAdapter implements PlatformMetricsSnapshotPort {\r\n  constructor(private readonly metricsCollector: MetricsCollector) {}\r\n\r\n  getSnapshot(): MetricsSnapshot {\r\n    // MetricsCollector.getSnapshot() returns the same structure as MetricsSnapshot\r\n    return this.metricsCollector.getSnapshot() as MetricsSnapshot;\r\n  }\r\n}\r\n","import { MetricsSnapshotAdapter } from \"./metrics-snapshot-adapter\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport type { MetricsCollector } from \"./metrics-collector\";\r\n\r\n/**\r\n * DI-enabled wrapper for MetricsSnapshotAdapter.\r\n * Resolves MetricsCollector from container.\r\n */\r\nexport class DIMetricsSnapshotAdapter extends MetricsSnapshotAdapter {\r\n  static dependencies = [metricsCollectorToken] as const;\r\n\r\n  constructor(metricsCollector: MetricsCollector) {\r\n    super(metricsCollector);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryGamePortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game-port-registry.token\";\r\nimport { foundryHooksPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks-port-registry.token\";\r\nimport { foundryDocumentPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document-port-registry.token\";\r\nimport { foundryUIPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui-port-registry.token\";\r\nimport { foundrySettingsPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings-port-registry.token\";\r\nimport { foundryI18nPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-i18n-port-registry.token\";\r\nimport { foundryModulePortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-module-port-registry.token\";\r\nimport {\r\n  platformUIPortToken,\r\n  platformValidationPortToken,\r\n  platformLoggingPortToken,\r\n  platformMetricsSnapshotPortToken,\r\n  platformJournalDirectoryUiPortToken,\r\n  platformUINotificationPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { DIPortSelector } from \"@/infrastructure/adapters/foundry/versioning/portselector\";\r\nimport { DIFoundryVersionDetector } from \"@/infrastructure/adapters/foundry/versioning/foundry-version-detector\";\r\nimport { foundryVersionDetectorToken } from \"@/infrastructure/shared/tokens/foundry/foundry-version-detector.token\";\r\nimport { PortRegistry } from \"@/infrastructure/adapters/foundry/versioning/portregistry\";\r\nimport { registerV13Ports } from \"@/infrastructure/adapters/foundry/ports/v13/port-registration\";\r\nimport { DIFoundryUIAdapter } from \"@/infrastructure/adapters/foundry/adapters/foundry-ui-adapter\";\r\nimport { DIValibotValidationAdapter } from \"@/infrastructure/validation/di-valibot-validation-adapter\";\r\nimport { DIMetricsSnapshotAdapter } from \"@/infrastructure/observability/di-metrics-snapshot-adapter\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryHooks } from \"@/infrastructure/adapters/foundry/interfaces/FoundryHooks\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryI18n } from \"@/infrastructure/adapters/foundry/interfaces/FoundryI18n\";\r\nimport type { FoundryModule } from \"@/infrastructure/adapters/foundry/interfaces/FoundryModule\";\r\n\r\n/**\r\n * Creates and registers all port implementations to their respective registries.\r\n * Returns the populated registries for container registration.\r\n *\r\n * This function is version-agnostic and delegates to version-specific registration\r\n * functions (e.g., registerV13Ports) to populate the registries.\r\n *\r\n * @param container - Service container for dependency injection (passed to port registration functions)\r\n */\r\nfunction createPortRegistries(container: ServiceContainer): Result<\r\n  {\r\n    gamePortRegistry: PortRegistry<FoundryGame>;\r\n    hooksPortRegistry: PortRegistry<FoundryHooks>;\r\n    documentPortRegistry: PortRegistry<FoundryDocument>;\r\n    uiPortRegistry: PortRegistry<FoundryUI>;\r\n    settingsPortRegistry: PortRegistry<FoundrySettings>;\r\n    i18nPortRegistry: PortRegistry<FoundryI18n>;\r\n    modulePortRegistry: PortRegistry<FoundryModule>;\r\n  },\r\n  string\r\n> {\r\n  // Create empty port registries\r\n  const gamePortRegistry = new PortRegistry<FoundryGame>();\r\n  const hooksPortRegistry = new PortRegistry<FoundryHooks>();\r\n  const documentPortRegistry = new PortRegistry<FoundryDocument>();\r\n  const uiPortRegistry = new PortRegistry<FoundryUI>();\r\n  const settingsPortRegistry = new PortRegistry<FoundrySettings>();\r\n  const i18nPortRegistry = new PortRegistry<FoundryI18n>();\r\n  const modulePortRegistry = new PortRegistry<FoundryModule>();\r\n\r\n  // Register v13 ports (version-specific registration is delegated to v13 layer)\r\n  // Container is passed to allow future ports to use DI, even though current v13 ports don't need it\r\n  const v13RegistrationResult = registerV13Ports(\r\n    {\r\n      gamePortRegistry,\r\n      hooksPortRegistry,\r\n      documentPortRegistry,\r\n      uiPortRegistry,\r\n      settingsPortRegistry,\r\n      i18nPortRegistry,\r\n      modulePortRegistry,\r\n    },\r\n    container\r\n  );\r\n\r\n  if (isErr(v13RegistrationResult)) {\r\n    return v13RegistrationResult;\r\n  }\r\n\r\n  // Future: Add calls to registerV14Ports(), registerV15Ports(), etc. here\r\n  // Each version registers itself into the same registries\r\n\r\n  return ok({\r\n    gamePortRegistry,\r\n    hooksPortRegistry,\r\n    documentPortRegistry,\r\n    uiPortRegistry,\r\n    settingsPortRegistry,\r\n    i18nPortRegistry,\r\n    modulePortRegistry,\r\n  });\r\n}\r\n\r\n/**\r\n * Registers port infrastructure root services.\r\n *\r\n * Services registered:\r\n * - FoundryVersionDetector (singleton, no dependencies)\r\n * - PortSelector (singleton, with FoundryVersionDetector, EventEmitter, ObservabilityRegistry, and ServiceContainer dependencies)\r\n * - PlatformUIPort (singleton, via FoundryUIAdapter)\r\n *\r\n * OBSERVABILITY: PortSelector self-registers with ObservabilityRegistry for automatic\r\n * event observation (logging/metrics). No manual wiring needed.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerPortInfrastructure(container: ServiceContainer): Result<void, string> {\r\n  // Register FoundryVersionDetector (must be registered before PortSelector)\r\n  const versionDetectorResult = container.registerClass(\r\n    foundryVersionDetectorToken,\r\n    DIFoundryVersionDetector,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(versionDetectorResult)) {\r\n    return err(`Failed to register FoundryVersionDetector: ${versionDetectorResult.error.message}`);\r\n  }\r\n\r\n  // Register PortSelector\r\n  // Dependencies: [foundryVersionDetectorToken, portSelectionEventEmitterToken, observabilityRegistryToken, serviceContainerToken]\r\n  const portSelectorResult = container.registerClass(\r\n    portSelectorToken,\r\n    DIPortSelector,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(portSelectorResult)) {\r\n    return err(`Failed to register PortSelector: ${portSelectorResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformUIPort (Foundry implementation via adapter)\r\n  const platformUIPortResult = container.registerClass(\r\n    platformUIPortToken,\r\n    DIFoundryUIAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(platformUIPortResult)) {\r\n    return err(`Failed to register PlatformUIPort: ${platformUIPortResult.error.message}`);\r\n  }\r\n\r\n  // Register specialized ports as aliases to PlatformUIPort\r\n  // This allows services to depend on minimal interfaces (ISP)\r\n  const journalDirectoryUiAliasResult = container.registerAlias(\r\n    platformJournalDirectoryUiPortToken,\r\n    platformUIPortToken\r\n  );\r\n  if (isErr(journalDirectoryUiAliasResult)) {\r\n    return err(\r\n      `Failed to register PlatformJournalDirectoryUiPort alias: ${journalDirectoryUiAliasResult.error.message}`\r\n    );\r\n  }\r\n\r\n  const uiNotificationAliasResult = container.registerAlias(\r\n    platformUINotificationPortToken,\r\n    platformUIPortToken\r\n  );\r\n  if (isErr(uiNotificationAliasResult)) {\r\n    return err(\r\n      `Failed to register UINotificationPort alias: ${uiNotificationAliasResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformValidationPort (Valibot implementation via adapter)\r\n  const platformValidationPortResult = container.registerClass(\r\n    platformValidationPortToken,\r\n    DIValibotValidationAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(platformValidationPortResult)) {\r\n    return err(\r\n      `Failed to register PlatformValidationPort: ${platformValidationPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformLoggingPort as alias to loggerToken\r\n  // Logger is already a type alias for PlatformLoggingPort, so we can use an alias\r\n  // This allows Application Layer to use platformLoggingPortToken while Infrastructure\r\n  // continues to use loggerToken (backward compatibility)\r\n  const loggingPortAliasResult = container.registerAlias(platformLoggingPortToken, loggerToken);\r\n  if (isErr(loggingPortAliasResult)) {\r\n    return err(\r\n      `Failed to register PlatformLoggingPort alias: ${loggingPortAliasResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformMetricsSnapshotPort (adapter wrapping MetricsCollector)\r\n  const metricsSnapshotPortResult = container.registerClass(\r\n    platformMetricsSnapshotPortToken,\r\n    DIMetricsSnapshotAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(metricsSnapshotPortResult)) {\r\n    return err(\r\n      `Failed to register PlatformMetricsSnapshotPort: ${metricsSnapshotPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Note: Observability handled via self-registration pattern\r\n  // PortSelector registers itself at ObservabilityRegistry in constructor\r\n  // No manual wiring needed here\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers Foundry port registries (sub-container values).\r\n *\r\n * Each registry is pre-populated with versioned factories and stored as a singleton value.\r\n *\r\n * @param container - The service container to register registries in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerPortRegistries(container: ServiceContainer): Result<void, string> {\r\n  const portsResult = createPortRegistries(container);\r\n  if (isErr(portsResult)) return portsResult;\r\n\r\n  const {\r\n    gamePortRegistry,\r\n    hooksPortRegistry,\r\n    documentPortRegistry,\r\n    uiPortRegistry,\r\n    settingsPortRegistry,\r\n    i18nPortRegistry,\r\n    modulePortRegistry,\r\n  } = portsResult.value;\r\n\r\n  // Register FoundryGame PortRegistry\r\n  const gameRegistryResult = container.registerValue(\r\n    foundryGamePortRegistryToken,\r\n    gamePortRegistry\r\n  );\r\n  if (isErr(gameRegistryResult)) {\r\n    return err(`Failed to register FoundryGame PortRegistry: ${gameRegistryResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryHooks PortRegistry\r\n  const hooksRegistryResult = container.registerValue(\r\n    foundryHooksPortRegistryToken,\r\n    hooksPortRegistry\r\n  );\r\n  if (isErr(hooksRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundryHooks PortRegistry: ${hooksRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryDocument PortRegistry\r\n  const documentRegistryResult = container.registerValue(\r\n    foundryDocumentPortRegistryToken,\r\n    documentPortRegistry\r\n  );\r\n  if (isErr(documentRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundryDocument PortRegistry: ${documentRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryUI PortRegistry\r\n  const uiRegistryResult = container.registerValue(foundryUIPortRegistryToken, uiPortRegistry);\r\n  if (isErr(uiRegistryResult)) {\r\n    return err(`Failed to register FoundryUI PortRegistry: ${uiRegistryResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundrySettings PortRegistry\r\n  const settingsRegistryResult = container.registerValue(\r\n    foundrySettingsPortRegistryToken,\r\n    settingsPortRegistry\r\n  );\r\n  if (isErr(settingsRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundrySettings PortRegistry: ${settingsRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryI18n PortRegistry\r\n  const i18nRegistryResult = container.registerValue(\r\n    foundryI18nPortRegistryToken,\r\n    i18nPortRegistry\r\n  );\r\n  if (isErr(i18nRegistryResult)) {\r\n    return err(`Failed to register FoundryI18n PortRegistry: ${i18nRegistryResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryModule PortRegistry\r\n  const moduleRegistryResult = container.registerValue(\r\n    foundryModulePortRegistryToken,\r\n    modulePortRegistry\r\n  );\r\n  if (isErr(moduleRegistryResult)) {\r\n    return err(\r\n      `Failed to register FoundryModule PortRegistry: ${moduleRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"PortInfrastructure\",\r\n  priority: 60,\r\n  execute: registerPortInfrastructure,\r\n});\r\n// Note: registerPortRegistries is registered in dependencyconfig.ts as SubcontainerValues (internal step)\r\n","/**\r\n * Injection token for the CacheService configuration.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { CacheServiceConfig } from \"@/infrastructure/cache/cache.interface\";\r\n\r\n/**\r\n * Injection token for the CacheService configuration.\r\n */\r\nexport const cacheServiceConfigToken =\r\n  createInjectionToken<CacheServiceConfig>(\"CacheServiceConfig\");\r\n","/**\r\n * Injection token for the CacheService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { CacheService } from \"@/infrastructure/cache/cache.interface\";\r\n\r\n/**\r\n * Injection token for the CacheService.\r\n */\r\nexport const cacheServiceToken = createInjectionToken<CacheService>(\"CacheService\");\r\n","/**\r\n * Injection token for the CacheConfigSync.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { CacheConfigSync } from \"@/infrastructure/cache/CacheConfigSync\";\r\n\r\n/**\r\n * Injection token for the CacheConfigSync.\r\n */\r\nexport const cacheConfigSyncToken = createInjectionToken<CacheConfigSync>(\"CacheConfigSync\");\r\n","/**\r\n * Injection token for the CacheMaintenancePort.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { CacheMaintenancePort } from \"@/infrastructure/cache/cache.interface\";\r\n\r\n/**\r\n * Injection token for the CacheMaintenancePort.\r\n *\r\n * Provides access to cache internal components (config manager, store, policy)\r\n * for infrastructure components that need maintenance capabilities.\r\n *\r\n * Follows Interface Segregation Principle (ISP) by separating maintenance\r\n * operations from normal cache operations.\r\n */\r\nexport const cacheMaintenancePortToken =\r\n  createInjectionToken<CacheMaintenancePort>(\"CacheMaintenancePort\");\r\n","import type { CacheKey } from \"../cache.interface\";\r\nimport type { InternalCacheEntry } from \"../eviction-strategy.interface\";\r\nimport type { ICacheStore } from \"./cache-store.interface\";\r\n\r\n/**\r\n * Manages cache storage operations.\r\n * Responsible only for storing and retrieving cache entries.\r\n */\r\nexport class CacheStore implements ICacheStore {\r\n  private readonly store = new Map<CacheKey, InternalCacheEntry>();\r\n\r\n  get(key: CacheKey): InternalCacheEntry | undefined {\r\n    return this.store.get(key);\r\n  }\r\n\r\n  set(key: CacheKey, entry: InternalCacheEntry): void {\r\n    this.store.set(key, entry);\r\n  }\r\n\r\n  delete(key: CacheKey): boolean {\r\n    return this.store.delete(key);\r\n  }\r\n\r\n  has(key: CacheKey): boolean {\r\n    return this.store.has(key);\r\n  }\r\n\r\n  clear(): number {\r\n    const size = this.store.size;\r\n    this.store.clear();\r\n    return size;\r\n  }\r\n\r\n  get size(): number {\r\n    return this.store.size;\r\n  }\r\n\r\n  entries(): IterableIterator<[CacheKey, InternalCacheEntry]> {\r\n    return this.store.entries();\r\n  }\r\n}\r\n","import type { CacheKey, CacheEntryMetadata, CacheSetOptions } from \"../cache.interface\";\r\nimport type { InternalCacheEntry } from \"../eviction-strategy.interface\";\r\nimport type { ICacheExpirationManager } from \"./cache-expiration-manager.interface\";\r\nimport type { ICacheStore } from \"../store/cache-store.interface\";\r\n\r\nfunction clampTtl(ttl: number | undefined, fallback: number): number {\r\n  if (typeof ttl !== \"number\" || Number.isNaN(ttl)) {\r\n    return fallback;\r\n  }\r\n  return ttl < 0 ? 0 : ttl;\r\n}\r\n\r\n/**\r\n * Default clock function that returns current timestamp.\r\n * Exported for testing purposes.\r\n */\r\nexport function defaultClock(): number {\r\n  return Date.now();\r\n}\r\n\r\n/**\r\n * Manages cache expiration logic.\r\n * Responsible only for TTL/expiration handling.\r\n */\r\nexport class CacheExpirationManager implements ICacheExpirationManager {\r\n  private readonly clock: () => number;\r\n\r\n  constructor(clock?: () => number) {\r\n    this.clock = clock ?? defaultClock;\r\n  }\r\n\r\n  isExpired(entry: InternalCacheEntry, now: number): boolean {\r\n    return typeof entry.expiresAt === \"number\" && entry.expiresAt > 0 && entry.expiresAt <= now;\r\n  }\r\n\r\n  createMetadata(\r\n    key: CacheKey,\r\n    options: CacheSetOptions | undefined,\r\n    now: number,\r\n    defaultTtlMs: number\r\n  ): CacheEntryMetadata {\r\n    const ttlMs = clampTtl(options?.ttlMs, defaultTtlMs);\r\n    const expiresAt = ttlMs > 0 ? now + ttlMs : null;\r\n    const tags = options?.tags ? Array.from(new Set(options.tags.map((tag) => String(tag)))) : [];\r\n\r\n    return {\r\n      key,\r\n      createdAt: now,\r\n      expiresAt,\r\n      lastAccessedAt: now,\r\n      hits: 0,\r\n      tags,\r\n    };\r\n  }\r\n\r\n  handleExpiration(key: CacheKey, store: ICacheStore): boolean {\r\n    return store.delete(key);\r\n  }\r\n}\r\n","import type { CacheStatistics, CacheKey } from \"../cache.interface\";\r\nimport type { ICacheStatisticsCollector } from \"./cache-statistics-collector.interface\";\r\nimport type { CacheMetricsObserver } from \"../cache-metrics-observer.interface\";\r\n\r\n/**\r\n * Collects and tracks cache statistics.\r\n * Responsible only for statistics tracking.\r\n */\r\nexport class CacheStatisticsCollector implements ICacheStatisticsCollector {\r\n  private readonly stats = {\r\n    hits: 0,\r\n    misses: 0,\r\n    evictions: 0,\r\n  };\r\n\r\n  constructor(private readonly metricsObserver: CacheMetricsObserver) {}\r\n\r\n  recordHit(key: CacheKey): void {\r\n    this.metricsObserver.onCacheHit(key);\r\n    this.stats.hits++;\r\n  }\r\n\r\n  recordMiss(key: CacheKey): void {\r\n    this.metricsObserver.onCacheMiss(key);\r\n    this.stats.misses++;\r\n  }\r\n\r\n  recordEviction(key: CacheKey): void {\r\n    this.metricsObserver.onCacheEviction(key);\r\n    this.stats.evictions++;\r\n  }\r\n\r\n  getStatistics(size: number, enabled: boolean): CacheStatistics {\r\n    return {\r\n      hits: this.stats.hits,\r\n      misses: this.stats.misses,\r\n      evictions: this.stats.evictions,\r\n      size,\r\n      enabled,\r\n    };\r\n  }\r\n\r\n  reset(): void {\r\n    this.stats.hits = 0;\r\n    this.stats.misses = 0;\r\n    this.stats.evictions = 0;\r\n  }\r\n}\r\n","import type { CacheServiceConfig } from \"../cache.interface\";\r\nimport type { ICacheConfigManager } from \"./cache-config-manager.interface\";\r\nimport { APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\n\r\nconst DEFAULT_CACHE_SERVICE_CONFIG: CacheServiceConfig = {\r\n  enabled: true,\r\n  defaultTtlMs: APP_DEFAULTS.CACHE_TTL_MS,\r\n  namespace: \"global\",\r\n};\r\n\r\nfunction clampTtl(ttl: number | undefined, fallback: number): number {\r\n  if (typeof ttl !== \"number\" || Number.isNaN(ttl)) {\r\n    return fallback;\r\n  }\r\n  return ttl < 0 ? 0 : ttl;\r\n}\r\n\r\n/**\r\n * Manages cache configuration.\r\n * Responsible only for configuration management.\r\n */\r\nexport class CacheConfigManager implements ICacheConfigManager {\r\n  private config: CacheServiceConfig;\r\n\r\n  constructor(config: CacheServiceConfig = DEFAULT_CACHE_SERVICE_CONFIG) {\r\n    const resolvedMaxEntries =\r\n      typeof config?.maxEntries === \"number\" && config.maxEntries > 0\r\n        ? config.maxEntries\r\n        : undefined;\r\n\r\n    this.config = {\r\n      ...DEFAULT_CACHE_SERVICE_CONFIG,\r\n      ...config,\r\n      defaultTtlMs: clampTtl(config?.defaultTtlMs, DEFAULT_CACHE_SERVICE_CONFIG.defaultTtlMs),\r\n      ...(resolvedMaxEntries !== undefined ? { maxEntries: resolvedMaxEntries } : {}),\r\n    };\r\n  }\r\n\r\n  updateConfig(partial: Partial<CacheServiceConfig>): void {\r\n    const merged: CacheServiceConfig = {\r\n      ...this.config,\r\n      ...partial,\r\n    };\r\n\r\n    merged.defaultTtlMs = clampTtl(merged.defaultTtlMs, DEFAULT_CACHE_SERVICE_CONFIG.defaultTtlMs);\r\n\r\n    this.config = merged;\r\n  }\r\n\r\n  getConfig(): CacheServiceConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  isEnabled(): boolean {\r\n    return this.config.enabled;\r\n  }\r\n}\r\n","import type { CacheEvictionStrategy, InternalCacheEntry } from \"./eviction-strategy.interface\";\r\nimport type { CacheKey } from \"./cache.interface\";\r\nimport type { ICacheStore } from \"./store/cache-store.interface\";\r\n\r\n/**\r\n * Manages cache capacity by enforcing maxEntries limit through eviction.\r\n *\r\n * Delegates eviction logic to a CacheEvictionStrategy (e.g., LRU, FIFO, LFU).\r\n */\r\nexport class CacheCapacityManager {\r\n  constructor(\r\n    private readonly strategy: CacheEvictionStrategy,\r\n    private readonly store: ICacheStore\r\n  ) {}\r\n\r\n  /**\r\n   * Enforces capacity limit by evicting entries using the configured strategy.\r\n   *\r\n   * @param maxEntries - The maximum number of entries allowed\r\n   * @returns Array of cache keys that were evicted\r\n   */\r\n  enforceCapacity(maxEntries: number): CacheKey[] {\r\n    if (this.store.size <= maxEntries) {\r\n      return [];\r\n    }\r\n\r\n    // Build a Map from store entries for the eviction strategy\r\n    // (EvictionStrategy interface requires Map, but we use ICacheStore)\r\n    const entriesMap = new Map<CacheKey, InternalCacheEntry>();\r\n    for (const [key, entry] of this.store.entries()) {\r\n      entriesMap.set(key, entry);\r\n    }\r\n\r\n    const keysToEvict = this.strategy.selectForEviction(entriesMap, maxEntries);\r\n    for (const key of keysToEvict) {\r\n      this.store.delete(key);\r\n    }\r\n\r\n    return keysToEvict;\r\n  }\r\n}\r\n","import type { CacheEvictionStrategy, InternalCacheEntry } from \"./eviction-strategy.interface\";\r\nimport type { CacheKey } from \"./cache.interface\";\r\n\r\n/**\r\n * LRU (Least Recently Used) eviction strategy.\r\n *\r\n * Evicts entries that were accessed least recently based on lastAccessedAt timestamp.\r\n */\r\nexport class LRUEvictionStrategy implements CacheEvictionStrategy {\r\n  /**\r\n   * Selects entries for eviction using LRU algorithm.\r\n   *\r\n   * Sorts entries by lastAccessedAt (ascending) and selects the oldest entries\r\n   * until the cache size is within maxEntries limit.\r\n   *\r\n   * @param entries - The current cache entries\r\n   * @param maxEntries - The maximum number of entries allowed\r\n   * @returns Array of cache keys to evict (oldest first)\r\n   */\r\n  selectForEviction(entries: Map<CacheKey, InternalCacheEntry>, maxEntries: number): CacheKey[] {\r\n    const toRemove = entries.size - maxEntries;\r\n    if (toRemove <= 0) {\r\n      return [];\r\n    }\r\n\r\n    // Sort entries by lastAccessedAt (ascending - oldest first)\r\n    const sorted = Array.from(entries.entries()).sort(\r\n      (a, b) => a[1].metadata.lastAccessedAt - b[1].metadata.lastAccessedAt\r\n    );\r\n\r\n    // Return the oldest entries (first toRemove entries)\r\n    return sorted.slice(0, toRemove).map(([key]) => key);\r\n  }\r\n}\r\n","import type { CacheEvictionStrategy } from \"./eviction-strategy.interface\";\r\n\r\n/**\r\n * Registry for cache eviction strategies.\r\n *\r\n * OCP-compliant: New strategies can be registered without modifying existing code.\r\n * The registry is open for extension but closed for modification.\r\n *\r\n * @example\r\n * ```typescript\r\n * const registry = EvictionStrategyRegistry.getInstance();\r\n * registry.register(\"lru\", new LRUEvictionStrategy());\r\n * registry.register(\"fifo\", new FIFOEvictionStrategy());\r\n *\r\n * const strategy = registry.get(\"lru\"); // Returns LRU strategy\r\n * ```\r\n */\r\nexport class EvictionStrategyRegistry {\r\n  private static instance: EvictionStrategyRegistry | null = null;\r\n  private readonly strategies = new Map<string, CacheEvictionStrategy>();\r\n\r\n  private constructor() {\r\n    // Private constructor for singleton pattern\r\n  }\r\n\r\n  /**\r\n   * Gets the singleton instance of the registry.\r\n   *\r\n   * @returns The singleton registry instance\r\n   */\r\n  static getInstance(): EvictionStrategyRegistry {\r\n    if (!EvictionStrategyRegistry.instance) {\r\n      EvictionStrategyRegistry.instance = new EvictionStrategyRegistry();\r\n    }\r\n    return EvictionStrategyRegistry.instance;\r\n  }\r\n\r\n  /**\r\n   * Registers a strategy with the given key.\r\n   *\r\n   * If a strategy with the same key already exists, it will be replaced.\r\n   * This allows for runtime strategy updates.\r\n   *\r\n   * @param key - Unique identifier for the strategy (e.g., \"lru\", \"fifo\", \"lfu\")\r\n   * @param strategy - The strategy instance to register\r\n   * @returns true if a strategy was replaced, false if it's a new registration\r\n   */\r\n  register(key: string, strategy: CacheEvictionStrategy): boolean {\r\n    const wasReplaced = this.strategies.has(key);\r\n    this.strategies.set(key, strategy);\r\n    return wasReplaced;\r\n  }\r\n\r\n  /**\r\n   * Gets a strategy by key.\r\n   *\r\n   * @param key - The strategy key\r\n   * @returns The strategy if found, undefined otherwise\r\n   */\r\n  get(key: string): CacheEvictionStrategy | undefined {\r\n    return this.strategies.get(key);\r\n  }\r\n\r\n  /**\r\n   * Gets a strategy by key, or returns the default strategy if not found.\r\n   *\r\n   * @param key - The strategy key\r\n   * @param defaultKey - The key of the default strategy to use if key is not found\r\n   * @returns The strategy if found, the default strategy if defaultKey is found, undefined otherwise\r\n   */\r\n  getOrDefault(key: string | undefined, defaultKey: string): CacheEvictionStrategy | undefined {\r\n    if (!key) {\r\n      return this.get(defaultKey);\r\n    }\r\n    return this.get(key) ?? this.get(defaultKey);\r\n  }\r\n\r\n  /**\r\n   * Checks if a strategy is registered.\r\n   *\r\n   * @param key - The strategy key\r\n   * @returns true if the strategy is registered, false otherwise\r\n   */\r\n  has(key: string): boolean {\r\n    return this.strategies.has(key);\r\n  }\r\n\r\n  /**\r\n   * Unregisters a strategy.\r\n   *\r\n   * @param key - The strategy key to unregister\r\n   * @returns true if a strategy was removed, false if it didn't exist\r\n   */\r\n  unregister(key: string): boolean {\r\n    return this.strategies.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Gets all registered strategy keys.\r\n   *\r\n   * @returns Array of all registered strategy keys\r\n   */\r\n  getRegisteredKeys(): string[] {\r\n    return Array.from(this.strategies.keys());\r\n  }\r\n\r\n  /**\r\n   * Clears all registered strategies.\r\n   * Useful for testing or reset scenarios.\r\n   */\r\n  clear(): void {\r\n    this.strategies.clear();\r\n  }\r\n}\r\n","import type { CacheMetricsObserver } from \"./cache-metrics-observer.interface\";\r\nimport type { CacheKey } from \"./cache.interface\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\n\r\n/**\r\n * Collects cache metrics by observing cache events.\r\n *\r\n * Delegates to MetricsCollector for actual metric recording.\r\n */\r\nexport class CacheMetricsCollector implements CacheMetricsObserver {\r\n  constructor(private readonly metricsCollector?: MetricsCollector) {}\r\n\r\n  /**\r\n   * Records a cache hit.\r\n   *\r\n   * @param _key - The cache key that was hit\r\n   */\r\n  onCacheHit(_key: CacheKey): void {\r\n    this.metricsCollector?.recordCacheAccess(true);\r\n  }\r\n\r\n  /**\r\n   * Records a cache miss.\r\n   *\r\n   * @param _key - The cache key that was missed\r\n   */\r\n  onCacheMiss(_key: CacheKey): void {\r\n    this.metricsCollector?.recordCacheAccess(false);\r\n  }\r\n\r\n  /**\r\n   * Records a cache eviction.\r\n   *\r\n   * @param _key - The cache key that was evicted\r\n   */\r\n  onCacheEviction(_key: CacheKey): void {\r\n    // Optional: Future eviction-specific metrics could be added here\r\n    // For now, evictions are tracked via stats.evictions in CacheService\r\n  }\r\n}\r\n","/**\r\n * Generic type cast utilities.\r\n *\r\n * Diese Datei enthält KEINE Abhängigkeiten zu ServiceType oder spezifischen Services.\r\n * Nur rein generische Type-Level-Operationen.\r\n *\r\n * Unterschied zu runtime-safe-cast.ts:\r\n * - runtime-safe-cast.ts: DI-Container-spezifisch, nutzt spezifische Service-Types\r\n * - type-casts.ts: Generisch, keine Domain-Knowledge\r\n *\r\n * WICHTIG: CacheKey wird hier inline definiert, um Zyklus mit cache.interface.ts zu vermeiden!\r\n * cache.interface.ts re-exportiert dann CacheKey von hier.\r\n *\r\n * @ts-expect-error - Type coverage exclusion: This file intentionally uses type assertions\r\n * for runtime-safe casts that are necessary for infrastructure code.\r\n */\r\n\r\n/**\r\n * Normalized cache key used by CacheService.\r\n *\r\n * Inline definiert, um zirkuläre Dependency mit cache.interface.ts zu vermeiden.\r\n * Brand Type Pattern: Ein String mit einem eindeutigen Symbol-Brand.\r\n */\r\nexport type CacheKey = string & { readonly __cacheKeyBrand: unique symbol };\r\n\r\n/**\r\n * Hilfsfunktion für ReadOnly-Wrapper: konvertiert eine Schlüssel-Liste,\r\n * die als keyof T getypt ist, in ein string-Array für includes().\r\n */\r\nexport function toStringKeyArray<T extends Record<string, unknown>>(\r\n  allowed: readonly (keyof T)[]\r\n): readonly string[] {\r\n  return allowed as readonly string[];\r\n}\r\n\r\n/**\r\n * Kapselt den notwendigen Cast vom Cache-Wert (unknown) auf den\r\n * erwarteten TValue. Die Typsicherheit wird durch die Aufrufer\r\n * (strukturierte Nutzung von CacheKeys) gewährleistet.\r\n */\r\nexport function castCacheValue<TValue>(value: unknown): TValue {\r\n  return value as TValue;\r\n}\r\n\r\n/**\r\n * Safely gets the first element from an array that has been checked for length > 0.\r\n *\r\n * This helper encapsulates the non-null assertion for array access after a length check.\r\n * TypeScript requires this cast because it cannot infer that array[0] is defined\r\n * even when array.length > 0 has been verified.\r\n *\r\n * The caller must ensure that array.length > 0 before calling this function.\r\n *\r\n * @param array - Array that has been verified to have length > 0\r\n * @returns The first element of the array (guaranteed to be defined)\r\n */\r\nexport function getFirstArrayElement<T>(array: T[]): T {\r\n  // Type assertion is safe because caller must verify array.length > 0\r\n  return array[0] as T;\r\n}\r\n\r\n/**\r\n * Safely checks if a value is an array and returns its first element if it exists.\r\n *\r\n * This helper provides type-safe array access with a type guard check.\r\n * It returns null if the input is not an array or the array is empty.\r\n *\r\n * @param value - Unknown value that might be an array\r\n * @returns The first element of the array if it exists and is of type T, null otherwise\r\n */\r\nexport function getFirstElementIfArray<T>(\r\n  value: unknown,\r\n  typeGuard: (element: unknown) => element is T\r\n): T | null {\r\n  if (Array.isArray(value) && value.length > 0) {\r\n    const firstElement: unknown = value[0] as unknown;\r\n    if (typeGuard(firstElement)) {\r\n      return firstElement;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Safely casts an object to Record<string, unknown>.\r\n *\r\n * This function encapsulates the cast required when TypeScript cannot\r\n * narrow an object type to Record<string, unknown> even after runtime validation.\r\n * The caller must ensure that the value is an object before calling this function.\r\n *\r\n * @param value - The object value that has been validated as an object\r\n * @returns The value as Record<string, unknown>\r\n */\r\nexport function castToRecord(value: unknown): Record<string, unknown> {\r\n  return value as Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Safely normalizes an object to Record<string, unknown>.\r\n *\r\n * This function creates a new Record from an object, ensuring type safety.\r\n * The caller must ensure that the value is an object before calling this function.\r\n *\r\n * @param value - The object value that has been validated as an object\r\n * @returns A new Record<string, unknown> with the object's properties\r\n */\r\nexport function normalizeToRecord(value: unknown): Record<string, unknown> {\r\n  return Object.assign({}, value as Record<string, unknown>);\r\n}\r\n\r\n/**\r\n * Type-safe assertion for CacheKey brand.\r\n *\r\n * This function encapsulates the brand assertion required for CacheKey.\r\n * The type safety is guaranteed by the structured usage of CacheKey creation\r\n * through createCacheKey() and the normalization process.\r\n *\r\n * @param value - The normalized string value to assert as CacheKey\r\n * @returns The value branded as CacheKey\r\n *\r\n * @example\r\n * ```typescript\r\n * const key = assertCacheKey(\"namespace:resource:id\");\r\n * ```\r\n */\r\nexport function assertCacheKey(value: string): CacheKey {\r\n  return value as CacheKey;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, fromPromise } from \"@/domain/utils/result\";\r\nimport { castCacheValue } from \"@/infrastructure/di/types/utilities/type-casts\";\r\nimport type {\r\n  CacheEntryMetadata,\r\n  CacheKey,\r\n  CacheLookupResult,\r\n  CacheSetOptions,\r\n} from \"../cache.interface\";\r\nimport type { CacheRuntime as ICacheRuntime } from \"./cache-runtime.interface\";\r\nimport type { ICacheStore } from \"../store/cache-store.interface\";\r\nimport type { ICacheExpirationManager } from \"../expiration/cache-expiration-manager.interface\";\r\nimport type { ICacheConfigManager } from \"../config/cache-config-manager.interface\";\r\nimport type { CacheTelemetry } from \"../telemetry/cache-telemetry.interface\";\r\nimport type { CachePolicy } from \"../policy/cache-policy.interface\";\r\nimport type { InternalCacheEntry } from \"../eviction-strategy.interface\";\r\n\r\n/**\r\n * Core cache runtime implementation.\r\n * Handles get/set/getOrSet operations.\r\n */\r\nexport class CacheRuntime implements ICacheRuntime {\r\n  constructor(\r\n    private readonly store: ICacheStore,\r\n    private readonly expirationManager: ICacheExpirationManager,\r\n    private readonly configManager: ICacheConfigManager,\r\n    private readonly telemetry: CacheTelemetry,\r\n    private readonly policy: CachePolicy,\r\n    private readonly clock: () => number\r\n  ) {}\r\n\r\n  get<T>(key: CacheKey): CacheLookupResult<T> | null {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) {\r\n      return null;\r\n    }\r\n\r\n    const entry = this.store.get(key);\r\n    if (!entry) {\r\n      this.telemetry.recordMiss(key);\r\n      return null;\r\n    }\r\n\r\n    const now = this.clock();\r\n    if (this.policy.shouldExpire(entry.expiresAt, now)) {\r\n      this.handleExpiration(key, entry);\r\n      this.telemetry.recordEviction(key);\r\n      this.telemetry.recordMiss(key);\r\n      return null;\r\n    }\r\n\r\n    // Update access metadata\r\n    entry.metadata.hits += 1;\r\n    entry.metadata.lastAccessedAt = now;\r\n\r\n    this.telemetry.recordHit(key);\r\n\r\n    return {\r\n      hit: true,\r\n      value: castCacheValue<T>(entry.value),\r\n      metadata: this.cloneMetadata(entry.metadata),\r\n    };\r\n  }\r\n\r\n  set<T>(key: CacheKey, value: T, options?: CacheSetOptions): CacheEntryMetadata {\r\n    const now = this.clock();\r\n    const config = this.configManager.getConfig();\r\n    const metadata = this.expirationManager.createMetadata(key, options, now, config.defaultTtlMs);\r\n\r\n    if (!config.enabled) {\r\n      return metadata;\r\n    }\r\n\r\n    const entry: InternalCacheEntry = {\r\n      value,\r\n      expiresAt: metadata.expiresAt,\r\n      metadata,\r\n    };\r\n\r\n    this.store.set(key, entry);\r\n    const evictedKeys = this.policy.enforceCapacity(this.store.size, config);\r\n    for (const evictedKey of evictedKeys) {\r\n      this.telemetry.recordEviction(evictedKey);\r\n    }\r\n\r\n    return { ...metadata, tags: [...metadata.tags] };\r\n  }\r\n\r\n  async getOrSet<T>(\r\n    key: CacheKey,\r\n    factory: () => T | Promise<T>,\r\n    options?: CacheSetOptions\r\n  ): Promise<Result<CacheLookupResult<T>, string>> {\r\n    const existing = this.get<T>(key);\r\n    if (existing) {\r\n      return ok(existing);\r\n    }\r\n\r\n    // Wrap factory() to handle both sync and async errors\r\n    let factoryValue: T;\r\n    try {\r\n      const factoryResult = factory();\r\n      // If factory returns a Promise, use fromPromise\r\n      if (factoryResult instanceof Promise) {\r\n        const asyncResult = await fromPromise(\r\n          factoryResult,\r\n          (error) => `Factory failed for cache key ${String(key)}: ${String(error)}`\r\n        );\r\n        if (!asyncResult.ok) {\r\n          return asyncResult;\r\n        }\r\n        factoryValue = asyncResult.value;\r\n      } else {\r\n        // Synchronous result\r\n        factoryValue = factoryResult;\r\n      }\r\n    } catch (error) {\r\n      // Synchronous error from factory()\r\n      return err(`Factory failed for cache key ${String(key)}: ${String(error)}`);\r\n    }\r\n\r\n    const metadata = this.set(key, factoryValue, options);\r\n    return ok({\r\n      hit: false,\r\n      value: factoryValue,\r\n      metadata,\r\n    });\r\n  }\r\n\r\n  private handleExpiration(key: CacheKey, entry: InternalCacheEntry): void {\r\n    const now = this.clock();\r\n    if (this.expirationManager.isExpired(entry, now)) {\r\n      this.expirationManager.handleExpiration(key, this.store);\r\n    }\r\n  }\r\n\r\n  private cloneMetadata(metadata: CacheEntryMetadata): CacheEntryMetadata {\r\n    return {\r\n      ...metadata,\r\n      tags: [...metadata.tags],\r\n    };\r\n  }\r\n}\r\n","import type { CacheKey } from \"@/infrastructure/di/types/utilities/type-casts\";\r\nimport type { CacheServiceConfig } from \"../cache-config.interface\";\r\nimport type { CachePolicy as ICachePolicy } from \"./cache-policy.interface\";\r\nimport { CacheCapacityManager } from \"../cache-capacity-manager\";\r\n\r\n/**\r\n * Cache policy implementation.\r\n * Handles capacity enforcement and expiration checks.\r\n */\r\nexport class CachePolicy implements ICachePolicy {\r\n  constructor(private readonly capacityManager: CacheCapacityManager) {}\r\n\r\n  enforceCapacity(currentSize: number, config: CacheServiceConfig): CacheKey[] {\r\n    if (!config.maxEntries || currentSize <= config.maxEntries) {\r\n      return [];\r\n    }\r\n\r\n    return this.capacityManager.enforceCapacity(config.maxEntries);\r\n  }\r\n\r\n  shouldExpire(expiresAt: number | null, now: number): boolean {\r\n    if (expiresAt === null) {\r\n      return false;\r\n    }\r\n    return now >= expiresAt;\r\n  }\r\n}\r\n","import type { CacheKey, CacheStatistics } from \"../cache.interface\";\r\nimport type { CacheTelemetry as ICacheTelemetry } from \"./cache-telemetry.interface\";\r\nimport type { ICacheStatisticsCollector } from \"../statistics/cache-statistics-collector.interface\";\r\n\r\n/**\r\n * Cache telemetry implementation.\r\n * Delegates to ICacheStatisticsCollector for statistics tracking.\r\n */\r\nexport class CacheTelemetry implements ICacheTelemetry {\r\n  constructor(private readonly statisticsCollector: ICacheStatisticsCollector) {}\r\n\r\n  recordHit(key: CacheKey): void {\r\n    this.statisticsCollector.recordHit(key);\r\n  }\r\n\r\n  recordMiss(key: CacheKey): void {\r\n    this.statisticsCollector.recordMiss(key);\r\n  }\r\n\r\n  recordEviction(key: CacheKey): void {\r\n    this.statisticsCollector.recordEviction(key);\r\n  }\r\n\r\n  getStatistics(currentSize: number, enabled: boolean): CacheStatistics {\r\n    return this.statisticsCollector.getStatistics(currentSize, enabled);\r\n  }\r\n}\r\n","import type { CacheServiceConfig } from \"../cache-config.interface\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { CacheMetricsObserver } from \"../cache-metrics-observer.interface\";\r\nimport { CacheStore } from \"../store/CacheStore\";\r\nimport { CacheExpirationManager } from \"../expiration/CacheExpirationManager\";\r\nimport { CacheStatisticsCollector } from \"../statistics/CacheStatisticsCollector\";\r\nimport { CacheConfigManager } from \"../config/CacheConfigManager\";\r\nimport { CacheCapacityManager } from \"../cache-capacity-manager\";\r\nimport { LRUEvictionStrategy } from \"../lru-eviction-strategy\";\r\nimport { EvictionStrategyRegistry } from \"../eviction-strategy-registry\";\r\nimport { CacheMetricsCollector } from \"../cache-metrics-collector\";\r\nimport { CacheRuntime } from \"../runtime/CacheRuntime\";\r\nimport { CachePolicy } from \"../policy/CachePolicy\";\r\nimport { CacheTelemetry } from \"../telemetry/CacheTelemetry\";\r\nimport type { ICacheStore } from \"../store/cache-store.interface\";\r\nimport type { ICacheExpirationManager } from \"../expiration/cache-expiration-manager.interface\";\r\nimport type { ICacheStatisticsCollector } from \"../statistics/cache-statistics-collector.interface\";\r\nimport type { ICacheConfigManager } from \"../config/cache-config-manager.interface\";\r\nimport type { CacheRuntime as ICacheRuntime } from \"../runtime/cache-runtime.interface\";\r\nimport type { CachePolicy as ICachePolicy } from \"../policy/cache-policy.interface\";\r\nimport type { CacheTelemetry as ICacheTelemetry } from \"../telemetry/cache-telemetry.interface\";\r\n\r\n/**\r\n * Composition of cache components.\r\n * Contains all components needed by CacheService.\r\n */\r\nexport interface CacheComposition {\r\n  runtime: ICacheRuntime;\r\n  policy: ICachePolicy;\r\n  telemetry: ICacheTelemetry;\r\n  store: ICacheStore;\r\n  configManager: ICacheConfigManager;\r\n  expirationManager: ICacheExpirationManager;\r\n}\r\n\r\n/**\r\n * Factory for creating cache component compositions.\r\n * Separates component creation from CacheService to follow SRP.\r\n *\r\n * **Responsibilities:**\r\n * - Creates and wires all cache subcomponents\r\n * - Handles dependency resolution (capacity manager, metrics observer, etc.)\r\n * - Provides testable composition logic\r\n *\r\n * **Design Benefits:**\r\n * - Single Responsibility: Only handles composition\r\n * - Testable: Can be mocked or replaced\r\n * - Maintainable: Clear separation of concerns\r\n */\r\nexport class CacheCompositionFactory {\r\n  /**\r\n   * Creates a complete cache composition from configuration.\r\n   *\r\n   * @param config - Cache service configuration\r\n   * @param metricsCollector - Optional metrics collector\r\n   * @param clock - Clock function (defaults to Date.now)\r\n   * @param capacityManager - Optional capacity manager (created if not provided)\r\n   * @param metricsObserver - Optional metrics observer (created if not provided)\r\n   * @param store - Optional store (created if not provided)\r\n   * @param expirationManager - Optional expiration manager (created if not provided)\r\n   * @param statisticsCollector - Optional statistics collector (created if not provided)\r\n   * @param configManager - Optional config manager (created if not provided)\r\n   * @param runtime - Optional runtime (created if not provided)\r\n   * @param policy - Optional policy (created if not provided)\r\n   * @param telemetry - Optional telemetry (created if not provided)\r\n   * @returns Complete cache composition\r\n   */\r\n  create(\r\n    config: CacheServiceConfig,\r\n    metricsCollector?: MetricsCollector,\r\n    clock: () => number = () => Date.now(),\r\n    capacityManager?: CacheCapacityManager,\r\n    metricsObserver?: CacheMetricsObserver,\r\n    store?: ICacheStore,\r\n    expirationManager?: ICacheExpirationManager,\r\n    statisticsCollector?: ICacheStatisticsCollector,\r\n    configManager?: ICacheConfigManager,\r\n    runtime?: ICacheRuntime,\r\n    policy?: ICachePolicy,\r\n    telemetry?: ICacheTelemetry\r\n  ): CacheComposition {\r\n    // Initialize core dependencies\r\n    const resolvedStore = store ?? new CacheStore();\r\n    const resolvedConfigManager = configManager ?? new CacheConfigManager(config);\r\n    const resolvedExpirationManager = expirationManager ?? new CacheExpirationManager(clock);\r\n\r\n    // Initialize capacity manager if not provided\r\n    let resolvedCapacityManager = capacityManager;\r\n    if (!resolvedCapacityManager) {\r\n      const registry = EvictionStrategyRegistry.getInstance();\r\n      // Ensure default LRU strategy is registered\r\n      if (!registry.has(\"lru\")) {\r\n        registry.register(\"lru\", new LRUEvictionStrategy());\r\n      }\r\n      // Get strategy from registry (defaults to \"lru\" if not specified)\r\n      const strategyKey = config.evictionStrategyKey ?? \"lru\";\r\n      const strategy = registry.getOrDefault(strategyKey, \"lru\");\r\n      if (!strategy) {\r\n        // Fallback to LRU if strategy not found (should not happen if \"lru\" is registered)\r\n        resolvedCapacityManager = new CacheCapacityManager(\r\n          new LRUEvictionStrategy(),\r\n          resolvedStore\r\n        );\r\n      } else {\r\n        resolvedCapacityManager = new CacheCapacityManager(strategy, resolvedStore);\r\n      }\r\n    }\r\n\r\n    // Initialize statistics collector\r\n    const resolvedMetricsObserver = metricsObserver ?? new CacheMetricsCollector(metricsCollector);\r\n    const resolvedStatisticsCollector =\r\n      statisticsCollector ?? new CacheStatisticsCollector(resolvedMetricsObserver);\r\n\r\n    // Initialize specialized components\r\n    const resolvedTelemetry = telemetry ?? new CacheTelemetry(resolvedStatisticsCollector);\r\n    const resolvedPolicy = policy ?? new CachePolicy(resolvedCapacityManager);\r\n    const resolvedRuntime =\r\n      runtime ??\r\n      new CacheRuntime(\r\n        resolvedStore,\r\n        resolvedExpirationManager,\r\n        resolvedConfigManager,\r\n        resolvedTelemetry,\r\n        resolvedPolicy,\r\n        clock\r\n      );\r\n\r\n    return {\r\n      runtime: resolvedRuntime,\r\n      policy: resolvedPolicy,\r\n      telemetry: resolvedTelemetry,\r\n      store: resolvedStore,\r\n      configManager: resolvedConfigManager,\r\n      expirationManager: resolvedExpirationManager,\r\n    };\r\n  }\r\n}\r\n","import { APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\nimport type {\r\n  CacheEntryMetadata,\r\n  CacheInvalidationPredicate,\r\n  CacheKey,\r\n  CacheLookupResult,\r\n  CacheService as CacheServiceContract,\r\n  CacheServiceConfig,\r\n  CacheSetOptions,\r\n  CacheStatistics,\r\n} from \"./cache.interface\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { cacheServiceConfigToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-service-config.token\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ICacheStore } from \"./store/cache-store.interface\";\r\nimport type { ICacheExpirationManager } from \"./expiration/cache-expiration-manager.interface\";\r\nimport type { ICacheConfigManager } from \"./config/cache-config-manager.interface\";\r\nimport type { CacheRuntime as ICacheRuntime } from \"./runtime/cache-runtime.interface\";\r\nimport type { CachePolicy as ICachePolicy } from \"./policy/cache-policy.interface\";\r\nimport type { CacheTelemetry as ICacheTelemetry } from \"./telemetry/cache-telemetry.interface\";\r\nimport { CacheCompositionFactory } from \"./factory/CacheCompositionFactory\";\r\n\r\nexport const DEFAULT_CACHE_SERVICE_CONFIG: CacheServiceConfig = {\r\n  enabled: true,\r\n  defaultTtlMs: APP_DEFAULTS.CACHE_TTL_MS,\r\n  namespace: \"global\",\r\n};\r\n\r\n/**\r\n * CacheService facade implementation.\r\n * Delegates to specialized components (Runtime, Policy, Telemetry) following SRP.\r\n *\r\n * **Responsibilities:**\r\n * - Coordinates cache operations\r\n * - Provides unified public API\r\n * - Delegates to specialized components\r\n *\r\n * **Design Benefits:**\r\n * - Single Responsibility: Only coordinates, doesn't implement logic\r\n * - Testable: Components can be mocked\r\n * - Maintainable: Clear separation of concerns\r\n * - No composition logic: Components are injected, not created\r\n */\r\nexport class CacheService implements CacheServiceContract {\r\n  private readonly runtime: ICacheRuntime;\r\n  private readonly policy: ICachePolicy;\r\n  private readonly telemetry: ICacheTelemetry;\r\n  private readonly store: ICacheStore;\r\n  private readonly configManager: ICacheConfigManager;\r\n  private readonly expirationManager: ICacheExpirationManager;\r\n  private readonly clock: () => number;\r\n\r\n  constructor(\r\n    runtime: ICacheRuntime,\r\n    policy: ICachePolicy,\r\n    telemetry: ICacheTelemetry,\r\n    store: ICacheStore,\r\n    configManager: ICacheConfigManager,\r\n    expirationManager: ICacheExpirationManager,\r\n    clock: () => number = () => Date.now()\r\n  ) {\r\n    this.runtime = runtime;\r\n    this.policy = policy;\r\n    this.telemetry = telemetry;\r\n    this.store = store;\r\n    this.configManager = configManager;\r\n    this.expirationManager = expirationManager;\r\n    this.clock = clock;\r\n  }\r\n\r\n  get isEnabled(): boolean {\r\n    return this.configManager.isEnabled();\r\n  }\r\n\r\n  get size(): number {\r\n    return this.store.size;\r\n  }\r\n\r\n  get<TValue>(key: CacheKey): CacheLookupResult<TValue> | null {\r\n    return this.runtime.get<TValue>(key);\r\n  }\r\n\r\n  async getOrSet<TValue>(\r\n    key: CacheKey,\r\n    factory: () => TValue | Promise<TValue>,\r\n    options?: CacheSetOptions\r\n  ): Promise<Result<CacheLookupResult<TValue>, string>> {\r\n    return this.runtime.getOrSet(key, factory, options);\r\n  }\r\n\r\n  set<TValue>(key: CacheKey, value: TValue, options?: CacheSetOptions): CacheEntryMetadata {\r\n    return this.runtime.set(key, value, options);\r\n  }\r\n\r\n  delete(key: CacheKey): boolean {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) return false;\r\n    const removed = this.store.delete(key);\r\n    if (removed) {\r\n      this.telemetry.recordEviction(key);\r\n    }\r\n    return removed;\r\n  }\r\n\r\n  has(key: CacheKey): boolean {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) return false;\r\n\r\n    const entry = this.store.get(key);\r\n    if (!entry) {\r\n      return false;\r\n    }\r\n\r\n    const now = this.clock();\r\n    if (this.policy.shouldExpire(entry.expiresAt, now)) {\r\n      this.expirationManager.handleExpiration(key, this.store);\r\n      this.telemetry.recordEviction(key);\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  clear(): number {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) return 0;\r\n\r\n    const keysToEvict: CacheKey[] = [];\r\n    for (const [key] of this.store.entries()) {\r\n      keysToEvict.push(key);\r\n    }\r\n    const removed = this.store.clear();\r\n    if (removed > 0) {\r\n      // Notify about each evicted key\r\n      for (const key of keysToEvict) {\r\n        this.telemetry.recordEviction(key);\r\n      }\r\n    }\r\n    return removed;\r\n  }\r\n\r\n  invalidateWhere(predicate: CacheInvalidationPredicate): number {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) return 0;\r\n\r\n    let removed = 0;\r\n    const keysToEvict: CacheKey[] = [];\r\n    for (const [key, entry] of this.store.entries()) {\r\n      if (predicate(entry.metadata)) {\r\n        keysToEvict.push(key);\r\n      }\r\n    }\r\n\r\n    for (const key of keysToEvict) {\r\n      if (this.store.delete(key)) {\r\n        removed++;\r\n        this.telemetry.recordEviction(key);\r\n      }\r\n    }\r\n\r\n    return removed;\r\n  }\r\n\r\n  getMetadata(key: CacheKey): CacheEntryMetadata | null {\r\n    const config = this.configManager.getConfig();\r\n    if (!config.enabled) return null;\r\n\r\n    const entry = this.store.get(key);\r\n    if (!entry) return null;\r\n\r\n    const now = this.clock();\r\n    if (this.policy.shouldExpire(entry.expiresAt, now)) {\r\n      const wasRemoved = this.expirationManager.handleExpiration(key, this.store);\r\n      if (wasRemoved) {\r\n        this.telemetry.recordEviction(key);\r\n      }\r\n      return null;\r\n    }\r\n    return this.cloneMetadata(entry.metadata);\r\n  }\r\n\r\n  getStatistics(): CacheStatistics {\r\n    return this.telemetry.getStatistics(this.store.size, this.isEnabled);\r\n  }\r\n\r\n  getConfigManager(): ICacheConfigManager {\r\n    return this.configManager;\r\n  }\r\n\r\n  getStore(): ICacheStore {\r\n    return this.store;\r\n  }\r\n\r\n  getPolicy(): ICachePolicy {\r\n    return this.policy;\r\n  }\r\n\r\n  private cloneMetadata(metadata: CacheEntryMetadata): CacheEntryMetadata {\r\n    return {\r\n      ...metadata,\r\n      tags: [...metadata.tags],\r\n    };\r\n  }\r\n}\r\n\r\nexport class DICacheService extends CacheService {\r\n  static dependencies = [cacheServiceConfigToken, metricsCollectorToken] as const;\r\n\r\n  constructor(_config: CacheServiceConfig, _metrics: MetricsCollector) {\r\n    // DICacheService will be created via factory in DI registration\r\n    // This constructor signature is kept for backward compatibility but should not be used directly\r\n    // The actual composition is handled by CacheCompositionFactory in cache-services.config.ts\r\n    // We create a minimal composition here to satisfy the super() call requirement\r\n    const factory = new CacheCompositionFactory();\r\n    const composition = factory.create(_config, _metrics);\r\n    super(\r\n      composition.runtime,\r\n      composition.policy,\r\n      composition.telemetry,\r\n      composition.store,\r\n      composition.configManager,\r\n      composition.expirationManager\r\n    );\r\n  }\r\n}\r\n","import type { CacheServiceConfig } from \"../cache.interface\";\r\nimport type { CacheConfigObserver } from \"../cache-config-observer.interface\";\r\nimport type { ICacheStore } from \"../store/cache-store.interface\";\r\nimport type { CachePolicy } from \"../policy/cache-policy.interface\";\r\nimport type { ICacheConfigManager } from \"./cache-config-manager.interface\";\r\n\r\n/**\r\n * Observer for cache configuration updates.\r\n * Handles cache clearing and capacity enforcement when config changes.\r\n *\r\n * **Single Responsibility:**\r\n * - Reacts to configuration changes\r\n * - Clears cache when disabled\r\n * - Enforces capacity when maxEntries changes\r\n *\r\n * **Design Benefits:**\r\n * - Separated from CacheService\r\n * - Can be used by CacheConfigSync\r\n * - Testable in isolation\r\n */\r\nexport class CacheConfigSyncObserver implements CacheConfigObserver {\r\n  constructor(\r\n    private readonly store: ICacheStore,\r\n    private readonly policy: CachePolicy,\r\n    private readonly configManager: ICacheConfigManager\r\n  ) {}\r\n\r\n  /**\r\n   * Called when cache configuration is updated.\r\n   * Implements CacheConfigObserver to react to configuration changes.\r\n   *\r\n   * @param config - The updated cache configuration\r\n   */\r\n  onConfigUpdated(config: CacheServiceConfig): void {\r\n    if (!config.enabled) {\r\n      this.clearStore();\r\n      return;\r\n    }\r\n\r\n    const currentConfig = this.configManager.getConfig();\r\n    if (typeof config.maxEntries === \"number\" && config.maxEntries !== currentConfig.maxEntries) {\r\n      this.enforceCapacity(config);\r\n    }\r\n  }\r\n\r\n  private clearStore(): void {\r\n    this.store.clear();\r\n  }\r\n\r\n  private enforceCapacity(config: CacheServiceConfig): void {\r\n    if (!config.maxEntries) {\r\n      return;\r\n    }\r\n    this.policy.enforceCapacity(this.store.size, config);\r\n  }\r\n}\r\n","import type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { CacheConfigSyncObserver } from \"./config/CacheConfigSyncObserver\";\r\nimport type { CacheMaintenancePort } from \"./cache.interface\";\r\n\r\n/**\r\n * Handles synchronization between RuntimeConfig and CacheService.\r\n * Separated from CacheService to follow Single Responsibility Principle.\r\n *\r\n * **Responsibilities:**\r\n * - Bind RuntimeConfig changes to CacheService config updates\r\n * - Manage subscription lifecycle\r\n *\r\n * **Design Benefits:**\r\n * - Single Responsibility: Only handles RuntimeConfig synchronization\r\n * - Reusable: Can be extended for additional config sources\r\n * - Testable: Isolated from CacheService implementation\r\n * - Observer Pattern: Uses CacheConfigSyncObserver to notify about config changes\r\n * - Interface Segregation: Depends only on CacheMaintenancePort, not full CacheService\r\n */\r\nexport class CacheConfigSync {\r\n  private unsubscribe: (() => void) | null = null;\r\n  private readonly observer: CacheConfigSyncObserver;\r\n\r\n  constructor(\r\n    private readonly runtimeConfig: PlatformRuntimeConfigPort,\r\n    private readonly cacheMaintenance: CacheMaintenancePort\r\n  ) {\r\n    // Create observer with components from maintenance port\r\n    this.observer = new CacheConfigSyncObserver(\r\n      cacheMaintenance.getStore(),\r\n      cacheMaintenance.getPolicy(),\r\n      cacheMaintenance.getConfigManager()\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Binds RuntimeConfig changes to CacheService.\r\n   * Returns unsubscribe function for cleanup.\r\n   *\r\n   * @returns Unsubscribe function to clean up all subscriptions\r\n   */\r\n  bind(): () => void {\r\n    if (this.unsubscribe) {\r\n      this.unsubscribe();\r\n    }\r\n\r\n    const unsubscribers: Array<() => void> = [];\r\n\r\n    unsubscribers.push(\r\n      this.runtimeConfig.onChange(\"enableCacheService\", (enabled) => {\r\n        const configManager = this.cacheMaintenance.getConfigManager();\r\n        configManager.updateConfig({ enabled });\r\n        this.observer.onConfigUpdated(configManager.getConfig());\r\n      })\r\n    );\r\n\r\n    unsubscribers.push(\r\n      this.runtimeConfig.onChange(\"cacheDefaultTtlMs\", (ttl) => {\r\n        const configManager = this.cacheMaintenance.getConfigManager();\r\n        configManager.updateConfig({ defaultTtlMs: ttl });\r\n        this.observer.onConfigUpdated(configManager.getConfig());\r\n      })\r\n    );\r\n\r\n    unsubscribers.push(\r\n      this.runtimeConfig.onChange(\"cacheMaxEntries\", (maxEntries) => {\r\n        const configManager = this.cacheMaintenance.getConfigManager();\r\n        configManager.updateConfig({\r\n          maxEntries: typeof maxEntries === \"number\" && maxEntries > 0 ? maxEntries : undefined,\r\n        });\r\n        this.observer.onConfigUpdated(configManager.getConfig());\r\n      })\r\n    );\r\n\r\n    this.unsubscribe = () => {\r\n      for (const unsubscribe of unsubscribers) {\r\n        unsubscribe();\r\n      }\r\n      this.unsubscribe = null;\r\n    };\r\n\r\n    return this.unsubscribe;\r\n  }\r\n\r\n  /**\r\n   * Unbinds RuntimeConfig synchronization.\r\n   */\r\n  unbind(): void {\r\n    this.unsubscribe?.();\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for CacheConfigSync.\r\n * Note: This will be created via factory in DI registration.\r\n * The actual dependency (CacheMaintenancePort) is resolved from CacheService.\r\n */\r\nexport class DICacheConfigSync extends CacheConfigSync {\r\n  static dependencies = [runtimeConfigToken] as const;\r\n\r\n  constructor(runtimeConfig: PlatformRuntimeConfigPort, cacheMaintenance: CacheMaintenancePort) {\r\n    super(runtimeConfig, cacheMaintenance);\r\n  }\r\n}\r\n","import type { CacheReaderPort } from \"@/domain/ports/cache/cache-reader-port.interface\";\r\nimport type { CacheWriterPort } from \"@/domain/ports/cache/cache-writer-port.interface\";\r\nimport type { CacheInvalidationPort } from \"@/domain/ports/cache/cache-invalidation-port.interface\";\r\nimport type { CacheStatsPort } from \"@/domain/ports/cache/cache-stats-port.interface\";\r\nimport type { CacheComputePort } from \"@/domain/ports/cache/cache-compute-port.interface\";\r\nimport type { CacheService } from \"@/infrastructure/cache/cache.interface\";\r\nimport type {\r\n  CacheKey,\r\n  CacheSetOptions,\r\n  CacheEntryMetadata,\r\n  CacheLookupResult,\r\n  CacheStatistics,\r\n  CacheInvalidationPredicate,\r\n} from \"@/infrastructure/cache/cache.interface\";\r\nimport type {\r\n  DomainCacheKey,\r\n  DomainCacheSetOptions,\r\n  DomainCacheEntryMetadata,\r\n  DomainCacheLookupResult,\r\n  DomainCacheStatistics,\r\n  DomainCacheInvalidationPredicate,\r\n} from \"@/domain/types/cache/cache-types\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { cacheServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-service.token\";\r\nimport { assertCacheKey } from \"@/infrastructure/di/types/utilities/type-casts\";\r\n\r\n/**\r\n * Adapter that implements all cache ports by wrapping CacheService.\r\n *\r\n * Implements the segregated cache ports (CacheReaderPort, CacheWriterPort, etc.) to allow clients\r\n * to depend only on the capabilities they need (Interface Segregation Principle).\r\n *\r\n * Maps between Domain cache types (domain-agnostic) and Infrastructure cache types\r\n * (Infrastructure-specific implementation details like branded keys).\r\n */\r\nexport class CachePortAdapter\r\n  implements\r\n    CacheReaderPort,\r\n    CacheWriterPort,\r\n    CacheInvalidationPort,\r\n    CacheStatsPort,\r\n    CacheComputePort\r\n{\r\n  constructor(private readonly cacheService: CacheService) {}\r\n\r\n  /**\r\n   * Maps Domain cache key (plain string) to Infrastructure cache key (branded type).\r\n   */\r\n  private mapDomainKeyToInfrastructure(key: DomainCacheKey): CacheKey {\r\n    return assertCacheKey(key);\r\n  }\r\n\r\n  /**\r\n   * Maps Infrastructure cache key (branded type) to Domain cache key (plain string).\r\n   */\r\n  private mapInfrastructureKeyToDomain(key: CacheKey): DomainCacheKey {\r\n    return key as DomainCacheKey;\r\n  }\r\n\r\n  /**\r\n   * Maps Domain cache options to Infrastructure cache options.\r\n   */\r\n  private mapDomainOptionsToInfrastructure(\r\n    options?: DomainCacheSetOptions\r\n  ): CacheSetOptions | undefined {\r\n    if (!options) return undefined;\r\n    const result: CacheSetOptions = {};\r\n    if (options.ttlMs !== undefined) {\r\n      result.ttlMs = options.ttlMs;\r\n    }\r\n    if (options.tags !== undefined) {\r\n      result.tags = options.tags;\r\n    }\r\n    return Object.keys(result).length > 0 ? result : undefined;\r\n  }\r\n\r\n  /**\r\n   * Maps Infrastructure cache metadata to Domain cache metadata.\r\n   */\r\n  private mapInfrastructureMetadataToDomain(\r\n    metadata: CacheEntryMetadata\r\n  ): DomainCacheEntryMetadata {\r\n    return {\r\n      key: this.mapInfrastructureKeyToDomain(metadata.key),\r\n      createdAt: metadata.createdAt,\r\n      expiresAt: metadata.expiresAt,\r\n      lastAccessedAt: metadata.lastAccessedAt,\r\n      hits: metadata.hits,\r\n      tags: metadata.tags,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Maps Infrastructure cache lookup result to Domain cache lookup result.\r\n   */\r\n  private mapInfrastructureLookupResultToDomain<T>(\r\n    result: CacheLookupResult<T>\r\n  ): DomainCacheLookupResult<T> {\r\n    const domainResult: DomainCacheLookupResult<T> = {\r\n      hit: result.hit,\r\n      metadata: this.mapInfrastructureMetadataToDomain(result.metadata),\r\n    };\r\n    if (result.value !== undefined) {\r\n      domainResult.value = result.value;\r\n    }\r\n    return domainResult;\r\n  }\r\n\r\n  /**\r\n   * Maps Infrastructure cache statistics to Domain cache statistics.\r\n   */\r\n  private mapInfrastructureStatisticsToDomain(statistics: CacheStatistics): DomainCacheStatistics {\r\n    return {\r\n      hits: statistics.hits,\r\n      misses: statistics.misses,\r\n      evictions: statistics.evictions,\r\n      size: statistics.size,\r\n      enabled: statistics.enabled,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Maps Domain invalidation predicate to Infrastructure invalidation predicate.\r\n   */\r\n  private mapDomainPredicateToInfrastructure(\r\n    predicate: DomainCacheInvalidationPredicate\r\n  ): CacheInvalidationPredicate {\r\n    return (entry: CacheEntryMetadata) => {\r\n      const domainEntry = this.mapInfrastructureMetadataToDomain(entry);\r\n      return predicate(domainEntry);\r\n    };\r\n  }\r\n\r\n  get isEnabled(): boolean {\r\n    return this.cacheService.isEnabled;\r\n  }\r\n\r\n  get size(): number {\r\n    return this.cacheService.size;\r\n  }\r\n\r\n  get<TValue>(key: DomainCacheKey): DomainCacheLookupResult<TValue> | null {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    const result = this.cacheService.get<TValue>(infraKey);\r\n    if (!result) return null;\r\n    return this.mapInfrastructureLookupResultToDomain(result);\r\n  }\r\n\r\n  set<TValue>(\r\n    key: DomainCacheKey,\r\n    value: TValue,\r\n    options?: DomainCacheSetOptions\r\n  ): DomainCacheEntryMetadata {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    const infraOptions = this.mapDomainOptionsToInfrastructure(options);\r\n    const metadata = this.cacheService.set(infraKey, value, infraOptions);\r\n    return this.mapInfrastructureMetadataToDomain(metadata);\r\n  }\r\n\r\n  delete(key: DomainCacheKey): boolean {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    return this.cacheService.delete(infraKey);\r\n  }\r\n\r\n  has(key: DomainCacheKey): boolean {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    return this.cacheService.has(infraKey);\r\n  }\r\n\r\n  clear(): number {\r\n    return this.cacheService.clear();\r\n  }\r\n\r\n  invalidateWhere(predicate: DomainCacheInvalidationPredicate): number {\r\n    const infraPredicate = this.mapDomainPredicateToInfrastructure(predicate);\r\n    return this.cacheService.invalidateWhere(infraPredicate);\r\n  }\r\n\r\n  getMetadata(key: DomainCacheKey): DomainCacheEntryMetadata | null {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    const metadata = this.cacheService.getMetadata(infraKey);\r\n    if (!metadata) return null;\r\n    return this.mapInfrastructureMetadataToDomain(metadata);\r\n  }\r\n\r\n  getStatistics(): DomainCacheStatistics {\r\n    const statistics = this.cacheService.getStatistics();\r\n    return this.mapInfrastructureStatisticsToDomain(statistics);\r\n  }\r\n\r\n  async getOrSet<TValue>(\r\n    key: DomainCacheKey,\r\n    factory: () => TValue | Promise<TValue>,\r\n    options?: DomainCacheSetOptions\r\n  ): Promise<Result<DomainCacheLookupResult<TValue>, string>> {\r\n    const infraKey = this.mapDomainKeyToInfrastructure(key);\r\n    const infraOptions = this.mapDomainOptionsToInfrastructure(options);\r\n    const result = await this.cacheService.getOrSet(infraKey, factory, infraOptions);\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n    return {\r\n      ok: true,\r\n      value: this.mapInfrastructureLookupResultToDomain(result.value),\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for CachePortAdapter.\r\n */\r\nexport class DICachePortAdapter extends CachePortAdapter {\r\n  static dependencies = [cacheServiceToken] as const;\r\n\r\n  constructor(cacheService: CacheService) {\r\n    super(cacheService);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  cacheReaderPortToken,\r\n  cacheWriterPortToken,\r\n  cacheInvalidationPortToken,\r\n  cacheStatsPortToken,\r\n  cacheComputePortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { cacheServiceConfigToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-service-config.token\";\r\nimport { cacheServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-service.token\";\r\nimport { cacheConfigSyncToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-config-sync.token\";\r\nimport { cacheMaintenancePortToken } from \"@/infrastructure/shared/tokens/infrastructure/cache-maintenance-port.token\";\r\nimport type { CacheMaintenancePort } from \"@/infrastructure/cache/cache.interface\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport type { CacheServiceConfig } from \"@/infrastructure/cache/cache.interface\";\r\nimport { CacheService } from \"@/infrastructure/cache/CacheService\";\r\nimport { CacheCompositionFactory } from \"@/infrastructure/cache/factory/CacheCompositionFactory\";\r\nimport { DICacheConfigSync, type CacheConfigSync } from \"@/infrastructure/cache/CacheConfigSync\";\r\nimport { DICachePortAdapter } from \"@/infrastructure/adapters/cache/platform-cache-port-adapter\";\r\nimport { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\n\r\n/**\r\n * Registers CacheService and its configuration.\r\n *\r\n * Reads defaults from PlatformRuntimeConfigPort to make cache tuning possible\r\n * through build-time variables and Foundry settings instead of code changes.\r\n *\r\n * @param container - Root service container used during bootstrap\r\n * @returns Result with `void` on success or error message if registration fails\r\n */\r\nexport function registerCacheServices(container: ServiceContainer): Result<void, string> {\r\n  const runtimeConfig: PlatformRuntimeConfigPort | null =\r\n    container.getRegisteredValue(runtimeConfigToken);\r\n  if (!runtimeConfig) {\r\n    return err(\"PlatformRuntimeConfigPort not registered\");\r\n  }\r\n\r\n  const maxEntries = runtimeConfig.get(\"cacheMaxEntries\");\r\n  const config: CacheServiceConfig = {\r\n    enabled: runtimeConfig.get(\"enableCacheService\"),\r\n    defaultTtlMs: runtimeConfig.get(\"cacheDefaultTtlMs\"),\r\n    namespace: MODULE_METADATA.ID,\r\n    ...(typeof maxEntries === \"number\" && maxEntries > 0 ? { maxEntries } : {}),\r\n  };\r\n\r\n  const configResult = container.registerValue(cacheServiceConfigToken, config);\r\n  if (isErr(configResult)) {\r\n    return err(`Failed to register CacheServiceConfig: ${configResult.error.message}`);\r\n  }\r\n\r\n  // Register CacheService using factory to create composition\r\n  const serviceResult = container.registerFactory(\r\n    cacheServiceToken,\r\n    () => {\r\n      const configResult = container.resolveWithError<CacheServiceConfig>(cacheServiceConfigToken);\r\n      if (!configResult.ok) {\r\n        throw new Error(`Failed to resolve CacheServiceConfig: ${configResult.error.message}`);\r\n      }\r\n      const metricsResult = container.resolveWithError<MetricsCollector | undefined>(\r\n        metricsCollectorToken\r\n      );\r\n      const metricsCollector = metricsResult.ok ? metricsResult.value : undefined;\r\n      const factory = new CacheCompositionFactory();\r\n      const composition = factory.create(configResult.value, metricsCollector);\r\n      return new CacheService(\r\n        composition.runtime,\r\n        composition.policy,\r\n        composition.telemetry,\r\n        composition.store,\r\n        composition.configManager,\r\n        composition.expirationManager\r\n      );\r\n    },\r\n    ServiceLifecycle.SINGLETON,\r\n    [cacheServiceConfigToken, metricsCollectorToken]\r\n  );\r\n  if (isErr(serviceResult)) {\r\n    return err(`Failed to register CacheService: ${serviceResult.error.message}`);\r\n  }\r\n\r\n  // Register CacheMaintenancePort (same instance as CacheService)\r\n  // This allows infrastructure components to depend only on maintenance capabilities (ISP)\r\n  const maintenancePortResult = container.registerFactory(\r\n    cacheMaintenancePortToken,\r\n    () => {\r\n      const serviceResult = container.resolveWithError<CacheService>(cacheServiceToken);\r\n      if (!serviceResult.ok) {\r\n        throw new Error(`Failed to resolve CacheService: ${serviceResult.error.message}`);\r\n      }\r\n      // CacheService implements CacheMaintenancePort, so we can return it directly\r\n      return serviceResult.value as CacheMaintenancePort;\r\n    },\r\n    ServiceLifecycle.SINGLETON,\r\n    [cacheServiceToken]\r\n  );\r\n  if (isErr(maintenancePortResult)) {\r\n    return err(`Failed to register CacheMaintenancePort: ${maintenancePortResult.error.message}`);\r\n  }\r\n\r\n  // Register segregated cache ports (same instance, different tokens)\r\n  // This allows clients to depend only on the capabilities they need (ISP)\r\n  const readerPortResult = container.registerClass(\r\n    cacheReaderPortToken,\r\n    DICachePortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(readerPortResult)) {\r\n    return err(`Failed to register CacheReaderPort: ${readerPortResult.error.message}`);\r\n  }\r\n\r\n  const writerPortResult = container.registerClass(\r\n    cacheWriterPortToken,\r\n    DICachePortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(writerPortResult)) {\r\n    return err(`Failed to register CacheWriterPort: ${writerPortResult.error.message}`);\r\n  }\r\n\r\n  const invalidationPortResult = container.registerClass(\r\n    cacheInvalidationPortToken,\r\n    DICachePortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(invalidationPortResult)) {\r\n    return err(`Failed to register CacheInvalidationPort: ${invalidationPortResult.error.message}`);\r\n  }\r\n\r\n  const statsPortResult = container.registerClass(\r\n    cacheStatsPortToken,\r\n    DICachePortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(statsPortResult)) {\r\n    return err(`Failed to register CacheStatsPort: ${statsPortResult.error.message}`);\r\n  }\r\n\r\n  const computePortResult = container.registerClass(\r\n    cacheComputePortToken,\r\n    DICachePortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(computePortResult)) {\r\n    return err(`Failed to register CacheComputePort: ${computePortResult.error.message}`);\r\n  }\r\n\r\n  // Register CacheConfigSync using factory with CacheMaintenancePort\r\n  const configSyncResult = container.registerFactory(\r\n    cacheConfigSyncToken,\r\n    () => {\r\n      const runtimeConfigResult =\r\n        container.resolveWithError<PlatformRuntimeConfigPort>(runtimeConfigToken);\r\n      if (!runtimeConfigResult.ok) {\r\n        throw new Error(\r\n          `Failed to resolve PlatformRuntimeConfigPort: ${runtimeConfigResult.error.message}`\r\n        );\r\n      }\r\n      const maintenancePortResult =\r\n        container.resolveWithError<CacheMaintenancePort>(cacheMaintenancePortToken);\r\n      if (!maintenancePortResult.ok) {\r\n        throw new Error(\r\n          `Failed to resolve CacheMaintenancePort: ${maintenancePortResult.error.message}`\r\n        );\r\n      }\r\n      return new DICacheConfigSync(runtimeConfigResult.value, maintenancePortResult.value);\r\n    },\r\n    ServiceLifecycle.SINGLETON,\r\n    [runtimeConfigToken, cacheMaintenancePortToken]\r\n  );\r\n  if (isErr(configSyncResult)) {\r\n    return err(`Failed to register CacheConfigSync: ${configSyncResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Initializes CacheConfigSync binding after container validation.\r\n * This ensures all dependencies are resolved before activating the binding.\r\n *\r\n * @param container - Service container with validated dependencies\r\n * @returns Result indicating success or initialization errors\r\n */\r\nexport function initializeCacheConfigSync(container: ServiceContainer): Result<void, string> {\r\n  const configSyncResult = container.resolveWithError<CacheConfigSync>(cacheConfigSyncToken);\r\n  if (!configSyncResult.ok) {\r\n    // If CacheConfigSync is not available, it's not critical - binding will be skipped\r\n    // This allows the system to work without RuntimeConfig synchronization\r\n    return ok(undefined);\r\n  }\r\n\r\n  const configSync = configSyncResult.value;\r\n  configSync.bind();\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"CacheServices\",\r\n  priority: 50,\r\n  execute: registerCacheServices,\r\n});\r\n// Note: initializeCacheConfigSync is registered in dependencyconfig.ts as an internal step\r\n","/**\r\n * DI Token for PlatformBootstrapEventPort.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PlatformBootstrapEventPort } from \"@/domain/ports/platform-bootstrap-event-port.interface\";\r\n\r\n/**\r\n * DI Token for PlatformBootstrapEventPort.\r\n *\r\n * Platform-agnostic bootstrap lifecycle events port.\r\n * Used for registering init/ready callbacks during module bootstrap.\r\n *\r\n * CRITICAL: This port uses direct platform APIs (e.g., Foundry Hooks.on())\r\n * because the full event system requires version detection which may not\r\n * be available before the init event runs.\r\n *\r\n * Default implementation: FoundryBootstrapEventAdapter (for Foundry VTT)\r\n */\r\nexport const platformBootstrapEventPortToken = createInjectionToken<PlatformBootstrapEventPort>(\r\n  \"PlatformBootstrapEventPort\"\r\n);\r\n","/**\r\n * Injection token for the MetricsRecorder interface.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { MetricsRecorder } from \"@/infrastructure/observability/interfaces/metrics-recorder\";\r\n\r\n/**\r\n * Injection token for the MetricsRecorder interface.\r\n *\r\n * Provides minimal recording capability without full MetricsCollector features.\r\n * Use this token when you only need to record metrics, not query or sample them.\r\n *\r\n * **Design:** Implements Interface Segregation Principle - depend on minimal interface.\r\n *\r\n * @example\r\n * ```typescript\r\n * class MyService {\r\n *   static dependencies = [metricsRecorderToken] as const;\r\n *   constructor(private recorder: MetricsRecorder) {}\r\n *   // Can record but not query metrics\r\n * }\r\n * ```\r\n */\r\nexport const metricsRecorderToken = createInjectionToken<MetricsRecorder>(\"MetricsRecorder\");\r\n","/**\r\n * Injection token for the MetricsSampler interface.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { MetricsSampler } from \"@/infrastructure/observability/interfaces/metrics-sampler\";\r\n\r\n/**\r\n * Injection token for the MetricsSampler interface.\r\n *\r\n * Provides sampling decision capability without full MetricsCollector features.\r\n * Use this token when you only need to check if sampling should occur.\r\n *\r\n * **Design:** Implements Interface Segregation Principle - depend on minimal interface.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PerformanceTracker {\r\n *   static dependencies = [metricsSamplerToken] as const;\r\n *   constructor(private sampler: MetricsSampler) {}\r\n *   // Can check sampling but not record or query\r\n * }\r\n * ```\r\n */\r\nexport const metricsSamplerToken = createInjectionToken<MetricsSampler>(\"MetricsSampler\");\r\n","/**\r\n * Injection token for the MetricsReporter service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { MetricsReporter } from \"@/infrastructure/observability/metrics-reporter\";\r\n\r\n/**\r\n * Injection token for the MetricsReporter service.\r\n *\r\n * Provides metrics reporting and logging capability without full MetricsCollector features.\r\n * Use this token when you need to format or log metrics, not collect them.\r\n *\r\n * **Design:** Implements Interface Segregation Principle - separate reporting from collection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const reporter = container.resolve(metricsReporterToken);\r\n * reporter.logSummary();\r\n * const json = reporter.toJSON();\r\n * ```\r\n */\r\nexport const metricsReporterToken = createInjectionToken<MetricsReporter>(\"MetricsReporter\");\r\n","/**\r\n * Injection token for the TraceContext service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\n\r\n/**\r\n * Injection token for the TraceContext service.\r\n *\r\n * Provides automatic trace ID propagation across nested function calls.\r\n * Eliminates the need to manually pass trace IDs through function parameters.\r\n *\r\n * **Key Features:**\r\n * - Automatic trace ID generation\r\n * - Context stacking for nested traces\r\n * - Support for both sync and async operations\r\n * - Integration with Logger for automatic trace ID injection\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceContext = container.resolve(traceContextToken);\r\n *\r\n * // Automatic trace propagation\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Starting operation\"); // Automatically traced\r\n *   doSomething(); // Nested calls see the same trace ID\r\n * });\r\n *\r\n * // Async operation\r\n * await traceContext.traceAsync(async () => {\r\n *   const result = await fetchData();\r\n *   return result;\r\n * });\r\n * ```\r\n */\r\nexport const traceContextToken = createInjectionToken<TraceContext>(\"TraceContext\");\r\n","/**\r\n * Injection token for metrics persistence storage.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { MetricsStorage } from \"@/infrastructure/observability/metrics-persistence/metrics-storage\";\r\n\r\n/**\r\n * Injection token for metrics persistence storage.\r\n */\r\nexport const metricsStorageToken = createInjectionToken<MetricsStorage>(\"MetricsStorage\");\r\n","/**\r\n * Injection token for the MetricsAggregator service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { IMetricsAggregator } from \"@/infrastructure/observability/interfaces/metrics-aggregator.interface\";\r\n\r\n/**\r\n * Injection token for the MetricsAggregator service.\r\n *\r\n * Provides aggregation of raw metrics into snapshots.\r\n *\r\n * @example\r\n * ```typescript\r\n * const aggregator = container.resolve(metricsAggregatorToken);\r\n * const snapshot = aggregator.aggregate(rawMetrics);\r\n * ```\r\n */\r\nexport const metricsAggregatorToken = createInjectionToken<IMetricsAggregator>(\"MetricsAggregator\");\r\n","/**\r\n * Injection token for the MetricsPersistenceManager service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { IMetricsPersistenceManager } from \"@/infrastructure/observability/interfaces/metrics-persistence-manager.interface\";\r\n\r\n/**\r\n * Injection token for the MetricsPersistenceManager service.\r\n *\r\n * Provides serialization and deserialization of metrics state.\r\n *\r\n * @example\r\n * ```typescript\r\n * const persistenceManager = container.resolve(metricsPersistenceManagerToken);\r\n * const state = persistenceManager.serialize(rawMetrics);\r\n * const restored = persistenceManager.deserialize(state);\r\n * ```\r\n */\r\nexport const metricsPersistenceManagerToken = createInjectionToken<IMetricsPersistenceManager>(\r\n  \"MetricsPersistenceManager\"\r\n);\r\n","/**\r\n * Injection token for the MetricsStateManager service.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { IMetricsStateManager } from \"@/infrastructure/observability/interfaces/metrics-state-manager.interface\";\r\n\r\n/**\r\n * Injection token for the MetricsStateManager service.\r\n *\r\n * Provides state change management for metrics with observer pattern.\r\n *\r\n * @example\r\n * ```typescript\r\n * const stateManager = container.resolve(metricsStateManagerToken);\r\n * stateManager.onStateChanged(() => console.log(\"State changed\"));\r\n * stateManager.notifyStateChanged();\r\n * ```\r\n */\r\nexport const metricsStateManagerToken =\r\n  createInjectionToken<IMetricsStateManager>(\"MetricsStateManager\");\r\n","/**\r\n * Injection token for the ModuleApiInitializer.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ModuleApiInitializer } from \"@/infrastructure/shared/types/module-api-initializer.interface\";\r\n\r\n/**\r\n * Injection token for the ModuleApiInitializer.\r\n *\r\n * Initializes and exposes the public module API to external consumers.\r\n * Manages API-safe tokens and provides health status.\r\n */\r\nexport const moduleApiInitializerToken =\r\n  createInjectionToken<ModuleApiInitializer>(\"ModuleApiInitializer\");\r\n","/**\r\n * Injection token for the ModuleHealthService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ModuleHealthService } from \"@/application/services/ModuleHealthService\";\r\n\r\n/**\r\n * Injection token for the ModuleHealthService.\r\n *\r\n * Provides module health monitoring and diagnostics.\r\n * Checks container validation, port selection, and metrics for health assessment.\r\n *\r\n * @example\r\n * ```typescript\r\n * const healthService = container.resolve(moduleHealthServiceToken);\r\n * const health = healthService.getHealth();\r\n * console.log(`Module status: ${health.status}`);\r\n * ```\r\n */\r\nexport const moduleHealthServiceToken =\r\n  createInjectionToken<ModuleHealthService>(\"ModuleHealthService\");\r\n","/**\r\n * Runtime-safe cast utilities for metric type conversions.\r\n *\r\n * Diese Datei kapselt Type-Assertions für Metrics-Implementierungen,\r\n * die aufgrund von TypeScript's generischen Typen und Type-Erasure notwendig sind.\r\n *\r\n * MetricDefinition<T> und MetricState<T> werden zur Laufzeit als MetricDefinition<unknown>\r\n * bzw. MetricState<unknown> gespeichert, da verschiedene Metriken verschiedene Typen haben.\r\n * Die Type-Assertions sind sicher, weil:\r\n * 1. Die Metriken mit korrekten Typen initialisiert werden\r\n * 2. Die Registry die Typkonsistenz sicherstellt\r\n * 3. Die generischen Typen zur Laufzeit gelöscht werden (Type Erasure)\r\n *\r\n * @ts-expect-error - Type coverage exclusion: This file intentionally uses type assertions\r\n * for runtime-safe casts that are necessary for metric type variance handling.\r\n */\r\n\r\nimport type { MetricDefinition } from \"./metric-definition.interface\";\r\n\r\n/**\r\n * Runtime-safe type guard to validate a MetricDefinition structure.\r\n * Checks that all required properties are present and have correct types.\r\n *\r\n * @param value - Value to check\r\n * @returns True if value is a valid MetricDefinition\r\n */\r\nexport function isValidMetricDefinition(value: unknown): value is MetricDefinition {\r\n  if (typeof value !== \"object\" || value === null) {\r\n    return false;\r\n  }\r\n\r\n  // Access properties without type assertion by using 'in' operator and property access\r\n  return (\r\n    \"key\" in value &&\r\n    typeof (value as { key?: unknown }).key === \"string\" &&\r\n    \"initialValue\" in value &&\r\n    typeof (value as { initialValue?: unknown }).initialValue !== \"undefined\" &&\r\n    \"reducer\" in value &&\r\n    typeof (value as { reducer?: unknown }).reducer === \"function\" &&\r\n    \"serializer\" in value &&\r\n    typeof (value as { serializer?: unknown }).serializer === \"function\"\r\n  );\r\n}\r\n\r\n/**\r\n * Runtime-safe cast from MetricDefinition<T> to MetricDefinition.\r\n * Validates the structure at runtime before casting.\r\n *\r\n * MetricDefinition<T> is structurally compatible with MetricDefinition<unknown>\r\n * because the generic type parameter T is erased at runtime. The cast is safe\r\n * because all MetricDefinition instances have the same structure regardless of T.\r\n *\r\n * @template T - The specific metric value type\r\n * @param definition - Metric definition to cast\r\n * @returns The definition as MetricDefinition\r\n * @throws Error if the definition is not valid\r\n */\r\nexport function castToMetricDefinition<T = unknown>(\r\n  definition: MetricDefinition<T>\r\n): MetricDefinition {\r\n  if (!isValidMetricDefinition(definition)) {\r\n    throw new Error(`Invalid metric definition structure for key \"${definition.key}\"`);\r\n  }\r\n  // Safe cast: MetricDefinition<T> is structurally compatible with MetricDefinition<unknown>, generic type T is erased at runtime\r\n  return definition as MetricDefinition;\r\n}\r\n\r\n/**\r\n * Runtime-safe cast from unknown to type T for metric values.\r\n * Validates that the value exists and returns it with the correct type.\r\n *\r\n * The type safety is guaranteed by the metric registry initialization,\r\n * which ensures that metric states are initialized with matching types.\r\n * The cast is safe because:\r\n * 1. Metric states are initialized from definitions with matching types\r\n * 2. The registry ensures type consistency\r\n * 3. The generic type parameter T is known at the call site\r\n *\r\n * @template T - The specific metric value type\r\n * @param value - Value to cast\r\n * @param key - Metric key for error reporting\r\n * @returns The value as type T\r\n * @throws Error if value is undefined (should not happen in normal operation)\r\n */\r\nexport function castMetricValue<T>(value: unknown, key: string): T {\r\n  if (value === undefined) {\r\n    throw new Error(\r\n      `Metric value for key \"${key}\" is undefined. This indicates a registry initialization issue.`\r\n    );\r\n  }\r\n  // Safe cast: value is guaranteed to be of type T by the metric registry initialization, which ensures type consistency\r\n  return value as T;\r\n}\r\n","import type { MetricDefinition } from \"./metric-definition.interface\";\r\nimport { castToMetricDefinition } from \"./metric-casts\";\r\n\r\n/**\r\n * Registry for metric definitions.\r\n *\r\n * Manages all available metric definitions and prevents key collisions.\r\n * Follows Open/Closed Principle: New metrics can be registered without\r\n * modifying the MetricsCollector.\r\n */\r\nexport class MetricDefinitionRegistry {\r\n  private readonly definitions = new Map<string, MetricDefinition>();\r\n\r\n  /**\r\n   * Registers a metric definition.\r\n   *\r\n   * @param definition - Metric definition to register\r\n   * @throws Error if a definition with the same key already exists or if the definition is invalid\r\n   */\r\n  register<T = unknown>(definition: MetricDefinition<T>): void {\r\n    if (this.definitions.has(definition.key)) {\r\n      throw new Error(\r\n        `Metric definition with key \"${definition.key}\" already exists. Use a different key or remove the existing definition first.`\r\n      );\r\n    }\r\n    // Runtime-safe cast: validates structure before storing\r\n    this.definitions.set(definition.key, castToMetricDefinition(definition));\r\n  }\r\n\r\n  /**\r\n   * Gets a metric definition by key.\r\n   *\r\n   * @param key - Metric key\r\n   * @returns Metric definition or undefined if not found\r\n   */\r\n  get(key: string): MetricDefinition | undefined {\r\n    return this.definitions.get(key);\r\n  }\r\n\r\n  /**\r\n   * Gets all registered metric definitions.\r\n   *\r\n   * @returns Array of all metric definitions\r\n   */\r\n  getAll(): readonly MetricDefinition[] {\r\n    return Array.from(this.definitions.values());\r\n  }\r\n\r\n  /**\r\n   * Checks if a metric definition exists.\r\n   *\r\n   * @param key - Metric key\r\n   * @returns True if definition exists\r\n   */\r\n  has(key: string): boolean {\r\n    return this.definitions.has(key);\r\n  }\r\n\r\n  /**\r\n   * Removes a metric definition.\r\n   *\r\n   * @param key - Metric key to remove\r\n   * @returns True if definition was removed, false if it didn't exist\r\n   */\r\n  remove(key: string): boolean {\r\n    return this.definitions.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Clears all registered definitions.\r\n   */\r\n  clear(): void {\r\n    this.definitions.clear();\r\n  }\r\n\r\n  /**\r\n   * Gets the number of registered definitions.\r\n   *\r\n   * @returns Number of registered definitions\r\n   */\r\n  size(): number {\r\n    return this.definitions.size;\r\n  }\r\n}\r\n","import { METRICS_CONFIG } from \"@/infrastructure/shared/constants\";\r\nimport type { MetricDefinition } from \"./metric-definition.interface\";\r\nimport type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\n\r\n/**\r\n * Default metric definitions for the MetricsCollector.\r\n *\r\n * These definitions represent the built-in metrics that are always available.\r\n * New metrics can be added by creating additional definitions and registering them.\r\n */\r\n\r\n/**\r\n * Resolution event data structure.\r\n */\r\ninterface ResolutionEvent {\r\n  token: InjectionToken<unknown>;\r\n  durationMs: number;\r\n  success: boolean;\r\n}\r\n\r\n/**\r\n * Port selection event data structure.\r\n */\r\ninterface PortSelectionEvent {\r\n  version: number;\r\n}\r\n\r\n/**\r\n * Cache access event data structure.\r\n */\r\ninterface CacheAccessEvent {\r\n  hit: boolean;\r\n}\r\n\r\n/**\r\n * Type guard for ResolutionEvent.\r\n */\r\nfunction isResolutionEvent(event: unknown): event is ResolutionEvent {\r\n  return (\r\n    typeof event === \"object\" &&\r\n    event !== null &&\r\n    \"durationMs\" in event &&\r\n    typeof (event as { durationMs: unknown }).durationMs === \"number\" &&\r\n    \"success\" in event &&\r\n    typeof (event as { success: unknown }).success === \"boolean\"\r\n  );\r\n}\r\n\r\n/**\r\n * Type guard for PortSelectionEvent.\r\n */\r\nfunction isPortSelectionEvent(event: unknown): event is PortSelectionEvent {\r\n  return (\r\n    typeof event === \"object\" &&\r\n    event !== null &&\r\n    \"version\" in event &&\r\n    typeof (event as { version: unknown }).version === \"number\"\r\n  );\r\n}\r\n\r\n/**\r\n * Type guard for CacheAccessEvent.\r\n */\r\nfunction isCacheAccessEvent(event: unknown): event is CacheAccessEvent {\r\n  return (\r\n    typeof event === \"object\" &&\r\n    event !== null &&\r\n    \"hit\" in event &&\r\n    typeof (event as { hit: unknown }).hit === \"boolean\"\r\n  );\r\n}\r\n\r\n/**\r\n * Resolution times state structure.\r\n */\r\ninterface ResolutionTimesState {\r\n  buffer: Float64Array;\r\n  index: number;\r\n  count: number;\r\n}\r\n\r\n/**\r\n * Container resolutions metric definition.\r\n */\r\nexport const containerResolutionsDefinition: MetricDefinition<number> = {\r\n  key: \"containerResolutions\",\r\n  initialValue: 0,\r\n  reducer: (current: number, _event: unknown) => current + 1,\r\n  serializer: (value: number) => value,\r\n};\r\n\r\n/**\r\n * Resolution errors metric definition.\r\n */\r\nexport const resolutionErrorsDefinition: MetricDefinition<number> = {\r\n  key: \"resolutionErrors\",\r\n  initialValue: 0,\r\n  reducer: (current: number, event: unknown) => {\r\n    if (!isResolutionEvent(event)) {\r\n      return current;\r\n    }\r\n    return event.success ? current : current + 1;\r\n  },\r\n  serializer: (value: number) => value,\r\n};\r\n\r\n/**\r\n * Cache hits metric definition.\r\n */\r\nexport const cacheHitsDefinition: MetricDefinition<number> = {\r\n  key: \"cacheHits\",\r\n  initialValue: 0,\r\n  reducer: (current: number, event: unknown) => {\r\n    if (!isCacheAccessEvent(event)) {\r\n      return current;\r\n    }\r\n    return event.hit ? current + 1 : current;\r\n  },\r\n  serializer: (value: number) => value,\r\n};\r\n\r\n/**\r\n * Cache misses metric definition.\r\n */\r\nexport const cacheMissesDefinition: MetricDefinition<number> = {\r\n  key: \"cacheMisses\",\r\n  initialValue: 0,\r\n  reducer: (current: number, event: unknown) => {\r\n    if (!isCacheAccessEvent(event)) {\r\n      return current;\r\n    }\r\n    return event.hit ? current : current + 1;\r\n  },\r\n  serializer: (value: number) => value,\r\n};\r\n\r\n/**\r\n * Port selections metric definition.\r\n */\r\nexport const portSelectionsDefinition: MetricDefinition<Map<number, number>> = {\r\n  key: \"portSelections\",\r\n  initialValue: new Map<number, number>(),\r\n  reducer: (current: Map<number, number>, event: unknown) => {\r\n    if (!isPortSelectionEvent(event)) {\r\n      return current;\r\n    }\r\n    const count = current.get(event.version) ?? 0;\r\n    const updated = new Map(current);\r\n    updated.set(event.version, count + 1);\r\n    return updated;\r\n  },\r\n  serializer: (value: Map<number, number>) => Object.fromEntries(value),\r\n};\r\n\r\n/**\r\n * Port selection failures metric definition.\r\n */\r\nexport const portSelectionFailuresDefinition: MetricDefinition<Map<number, number>> = {\r\n  key: \"portSelectionFailures\",\r\n  initialValue: new Map<number, number>(),\r\n  reducer: (current: Map<number, number>, event: unknown) => {\r\n    if (!isPortSelectionEvent(event)) {\r\n      return current;\r\n    }\r\n    const count = current.get(event.version) ?? 0;\r\n    const updated = new Map(current);\r\n    updated.set(event.version, count + 1);\r\n    return updated;\r\n  },\r\n  serializer: (value: Map<number, number>) => Object.fromEntries(value),\r\n};\r\n\r\n/**\r\n * Resolution times metric definition.\r\n * Uses a circular buffer for efficient storage.\r\n */\r\nexport const resolutionTimesDefinition: MetricDefinition<ResolutionTimesState> = {\r\n  key: \"resolutionTimes\",\r\n  initialValue: {\r\n    buffer: new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE),\r\n    index: 0,\r\n    count: 0,\r\n  },\r\n  reducer: (current: ResolutionTimesState, event: unknown) => {\r\n    if (!isResolutionEvent(event)) {\r\n      return current;\r\n    }\r\n    const buffer = new Float64Array(current.buffer);\r\n    const maxSize = METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE;\r\n\r\n    // Set value at current index position (circular buffer)\r\n    buffer[current.index] = event.durationMs;\r\n\r\n    // Update index for next write (circular)\r\n    const newIndex = (current.index + 1) % maxSize;\r\n    const newCount = Math.min(current.count + 1, maxSize);\r\n\r\n    return {\r\n      buffer,\r\n      index: newIndex,\r\n      count: newCount,\r\n    };\r\n  },\r\n  serializer: (value: ResolutionTimesState) => ({\r\n    buffer: Array.from(value.buffer),\r\n    index: value.index,\r\n    count: value.count,\r\n  }),\r\n};\r\n\r\nimport { MetricDefinitionRegistry } from \"./metric-definition-registry\";\r\n\r\n/**\r\n * Creates a default metric definition registry with all built-in metrics.\r\n *\r\n * @returns Registry with all default metric definitions registered\r\n */\r\nexport function createDefaultMetricDefinitionRegistry(): MetricDefinitionRegistry {\r\n  const registry = new MetricDefinitionRegistry();\r\n\r\n  registry.register(containerResolutionsDefinition);\r\n  registry.register(resolutionErrorsDefinition);\r\n  registry.register(cacheHitsDefinition);\r\n  registry.register(cacheMissesDefinition);\r\n  registry.register(portSelectionsDefinition);\r\n  registry.register(portSelectionFailuresDefinition);\r\n  registry.register(resolutionTimesDefinition);\r\n\r\n  return registry;\r\n}\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport { METRICS_CONFIG } from \"@/infrastructure/shared/constants\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport type { MetricsRecorder } from \"./interfaces/metrics-recorder\";\r\nimport type { IRawMetrics } from \"./interfaces/raw-metrics.interface\";\r\nimport type { IMetricsAggregator } from \"./interfaces/metrics-aggregator.interface\";\r\nimport type { IMetricsPersistenceManager } from \"./interfaces/metrics-persistence-manager.interface\";\r\nimport type { IMetricsStateManager } from \"./interfaces/metrics-state-manager.interface\";\r\nimport type { MetricsSnapshot, MetricsPersistenceState } from \"./metrics-types\";\r\nimport type { MetricState } from \"./metrics-definition/metric-definition.interface\";\r\nimport type { MetricDefinitionRegistry } from \"./metrics-definition/metric-definition-registry\";\r\nimport { createDefaultMetricDefinitionRegistry } from \"./metrics-definition/default-metric-definitions\";\r\nimport { metricsAggregatorToken } from \"@/infrastructure/shared/tokens/observability/metrics-aggregator.token\";\r\nimport { metricsPersistenceManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-persistence-manager.token\";\r\nimport { metricsStateManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-state-manager.token\";\r\n\r\n// Re-export for backward compatibility\r\nexport type { MetricsSnapshot, MetricsPersistenceState } from \"./metrics-types\";\r\nimport { castMetricValue } from \"./metrics-definition/metric-casts\";\r\n\r\n/**\r\n * Metrics collector for observability and performance tracking.\r\n *\r\n * Implements MetricsRecorder interface to provide\r\n * segregated access for recording metrics (Interface Segregation Principle).\r\n *\r\n * Collects performance metrics for:\r\n * - Container service resolutions\r\n * - Port selections\r\n * - Cache hit/miss rates\r\n *\r\n * Metrics are only collected when ENV.enablePerformanceTracking is true.\r\n *\r\n * Now managed via Dependency Injection as a Singleton service.\r\n *\r\n * **Design:** Follows Single Responsibility Principle:\r\n * - Metrics collection only (this class)\r\n * - Aggregation: MetricsAggregator\r\n * - Persistence: MetricsPersistenceManager\r\n * - State management: MetricsStateManager\r\n * - Sampling decisions: MetricsSampler\r\n * - Reporting/logging: MetricsReporter\r\n *\r\n * **OCP Design:** Follows Open/Closed Principle:\r\n * - Uses MetricDefinitionRegistry for dynamic metric registration\r\n * - New metrics can be added via registry without modifying this class\r\n * - Internal state managed via generic Map<string, MetricState>\r\n *\r\n * @example\r\n * ```typescript\r\n * const collector = container.resolve(metricsCollectorToken);\r\n * collector.recordResolution(token, 2.5, true);\r\n *\r\n * const snapshot = collector.getSnapshot();\r\n * console.log(`Avg resolution time: ${snapshot.avgResolutionTimeMs}ms`);\r\n * ```\r\n */\r\nexport class MetricsCollector implements MetricsRecorder {\r\n  static dependencies: readonly InjectionToken<unknown>[] = [runtimeConfigToken];\r\n\r\n  /**\r\n   * Generic map of metric states keyed by metric key.\r\n   * Follows OCP: New metrics can be added via registry without code changes.\r\n   */\r\n  private readonly metricStates = new Map<string, MetricState>();\r\n\r\n  // SRP: Delegation to specialized components\r\n  // DIP: Depend on interfaces, not concrete implementations\r\n  private readonly aggregator: IMetricsAggregator;\r\n  private readonly persistenceManager: IMetricsPersistenceManager;\r\n  private readonly stateManager: IMetricsStateManager;\r\n  private readonly registry: MetricDefinitionRegistry;\r\n\r\n  constructor(\r\n    private readonly config: PlatformRuntimeConfigPort,\r\n    aggregator: IMetricsAggregator,\r\n    persistenceManager: IMetricsPersistenceManager,\r\n    stateManager: IMetricsStateManager,\r\n    registry?: MetricDefinitionRegistry\r\n  ) {\r\n    // Use provided registry or create default one\r\n    this.registry = registry ?? createDefaultMetricDefinitionRegistry();\r\n\r\n    // Initialize metric states from registry\r\n    this.initializeMetricStates();\r\n\r\n    // DIP: All dependencies must be injected - no fallback\r\n    this.aggregator = aggregator;\r\n    this.persistenceManager = persistenceManager;\r\n    this.stateManager = stateManager;\r\n  }\r\n\r\n  /**\r\n   * Initializes metric states from registry definitions.\r\n   * Private method called during construction.\r\n   */\r\n  private initializeMetricStates(): void {\r\n    for (const definition of this.registry.getAll()) {\r\n      this.metricStates.set(definition.key, {\r\n        value: definition.initialValue,\r\n        definition,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates a metric using its reducer function.\r\n   *\r\n   * @param key - Metric key\r\n   * @param event - Event data for the reducer\r\n   */\r\n  private updateMetric(key: string, event: unknown): void {\r\n    const state = this.metricStates.get(key);\r\n    if (!state) {\r\n      // Metric not registered - ignore silently (could log warning in future)\r\n      return;\r\n    }\r\n\r\n    const newValue = state.definition.reducer(state.value, event);\r\n    this.metricStates.set(key, {\r\n      value: newValue,\r\n      definition: state.definition,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Records a service resolution attempt.\r\n   *\r\n   * @param token - The injection token that was resolved\r\n   * @param durationMs - Time taken to resolve in milliseconds\r\n   * @param success - Whether resolution succeeded\r\n   */\r\n  recordResolution(token: InjectionToken<unknown>, durationMs: number, success: boolean): void {\r\n    const event = { token, durationMs, success };\r\n\r\n    // Update container resolutions (always increments)\r\n    this.updateMetric(\"containerResolutions\", event);\r\n\r\n    // Update resolution errors (only if failed)\r\n    this.updateMetric(\"resolutionErrors\", event);\r\n\r\n    // Update resolution times (circular buffer handled by reducer)\r\n    this.updateMetric(\"resolutionTimes\", event);\r\n\r\n    this.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a port selection event.\r\n   *\r\n   * @param version - The Foundry version for which a port was selected\r\n   */\r\n  recordPortSelection(version: number): void {\r\n    this.updateMetric(\"portSelections\", { version });\r\n    this.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a port selection failure.\r\n   *\r\n   * Useful for tracking when no compatible port is available for a version.\r\n   *\r\n   * @param version - The Foundry version for which port selection failed\r\n   */\r\n  recordPortSelectionFailure(version: number): void {\r\n    this.updateMetric(\"portSelectionFailures\", { version });\r\n    this.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Records a cache access (hit or miss).\r\n   *\r\n   * @param hit - True if cache hit, false if cache miss\r\n   */\r\n  recordCacheAccess(hit: boolean): void {\r\n    const event = { hit };\r\n    this.updateMetric(\"cacheHits\", event);\r\n    this.updateMetric(\"cacheMisses\", event);\r\n    this.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Gets a snapshot of current metrics.\r\n   * Delegates aggregation to MetricsAggregator.\r\n   *\r\n   * @returns Immutable snapshot of metrics data\r\n   */\r\n  getSnapshot(): MetricsSnapshot {\r\n    return this.aggregator.aggregate(this.getRawMetrics());\r\n  }\r\n\r\n  /**\r\n   * Gets raw metrics data without aggregation.\r\n   * Used internally by aggregator and persistence manager.\r\n   *\r\n   * Converts from generic Map structure to IRawMetrics for backward compatibility.\r\n   *\r\n   * @returns Raw metrics data\r\n   */\r\n  getRawMetrics(): IRawMetrics {\r\n    // Extract values from metric states\r\n    const containerResolutions = this.getMetricValue<number>(\"containerResolutions\") ?? 0;\r\n    const resolutionErrors = this.getMetricValue<number>(\"resolutionErrors\") ?? 0;\r\n    const cacheHits = this.getMetricValue<number>(\"cacheHits\") ?? 0;\r\n    const cacheMisses = this.getMetricValue<number>(\"cacheMisses\") ?? 0;\r\n    const portSelectionsRaw = this.getMetricValue<Map<number, number>>(\"portSelections\");\r\n    const portSelections: Map<number, number> =\r\n      portSelectionsRaw instanceof Map ? portSelectionsRaw : new Map();\r\n    const portSelectionFailuresRaw =\r\n      this.getMetricValue<Map<number, number>>(\"portSelectionFailures\");\r\n    const portSelectionFailures: Map<number, number> =\r\n      portSelectionFailuresRaw instanceof Map ? portSelectionFailuresRaw : new Map();\r\n\r\n    // Extract resolution times state\r\n    const resolutionTimesState = this.getMetricValue<{\r\n      buffer: Float64Array;\r\n      index: number;\r\n      count: number;\r\n    }>(\"resolutionTimes\");\r\n\r\n    return {\r\n      containerResolutions,\r\n      resolutionErrors,\r\n      cacheHits,\r\n      cacheMisses,\r\n      portSelections,\r\n      portSelectionFailures,\r\n      resolutionTimes:\r\n        resolutionTimesState?.buffer ??\r\n        new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE),\r\n      resolutionTimesIndex: resolutionTimesState?.index ?? 0,\r\n      resolutionTimesCount: resolutionTimesState?.count ?? 0,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets a metric value by key.\r\n   *\r\n   * @param key - Metric key\r\n   * @returns Metric value or undefined if not found\r\n   */\r\n  private getMetricValue<T>(key: string): T | undefined {\r\n    const state = this.metricStates.get(key);\r\n    if (!state) {\r\n      return undefined;\r\n    }\r\n    // Runtime-safe cast: validates that value exists and casts to type T\r\n    // Type safety is guaranteed by the metric registry initialization\r\n    return castMetricValue<T>(state.value, key);\r\n  }\r\n\r\n  /**\r\n   * Resets all collected metrics.\r\n   * Useful for testing or starting fresh measurements.\r\n   */\r\n  reset(): void {\r\n    // Reset all metric states to their initial values\r\n    for (const definition of this.registry.getAll()) {\r\n      this.metricStates.set(definition.key, {\r\n        value: definition.initialValue,\r\n        definition,\r\n      });\r\n    }\r\n    this.stateManager.reset();\r\n    this.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Hook invoked after state mutations. Subclasses can override to react\r\n   * (e.g., persist metrics).\r\n   */\r\n  protected onStateChanged(): void {\r\n    // Default implementation: notify state manager\r\n    this.stateManager.notifyStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Notifies state manager of state changes.\r\n   * Internal method that can be overridden by subclasses.\r\n   */\r\n  protected notifyStateChanged(): void {\r\n    this.onStateChanged();\r\n  }\r\n\r\n  /**\r\n   * Captures the internal state for persistence.\r\n   * Delegates to MetricsPersistenceManager.\r\n   *\r\n   * @returns Serializable metrics state\r\n   */\r\n  protected getPersistenceState(): MetricsPersistenceState {\r\n    return this.persistenceManager.serialize(this.getRawMetrics());\r\n  }\r\n\r\n  /**\r\n   * Restores internal state from a persisted snapshot.\r\n   * Delegates to MetricsPersistenceManager.\r\n   *\r\n   * @param state - Persisted metrics state\r\n   */\r\n  protected restoreFromPersistenceState(state: MetricsPersistenceState | null | undefined): void {\r\n    const rawMetrics = this.persistenceManager.deserialize(state);\r\n    this.applyRawMetrics(rawMetrics);\r\n  }\r\n\r\n  /**\r\n   * Applies raw metrics to internal state.\r\n   * Internal method used by restoreFromPersistenceState.\r\n   * Converts from IRawMetrics to generic Map structure.\r\n   *\r\n   * @param rawMetrics - Raw metrics to apply\r\n   */\r\n  private applyRawMetrics(rawMetrics: IRawMetrics): void {\r\n    // Update metric states from raw metrics\r\n    this.setMetricValue(\"containerResolutions\", rawMetrics.containerResolutions);\r\n    this.setMetricValue(\"resolutionErrors\", rawMetrics.resolutionErrors);\r\n    this.setMetricValue(\"cacheHits\", rawMetrics.cacheHits);\r\n    this.setMetricValue(\"cacheMisses\", rawMetrics.cacheMisses);\r\n    this.setMetricValue(\"portSelections\", rawMetrics.portSelections);\r\n    this.setMetricValue(\"portSelectionFailures\", rawMetrics.portSelectionFailures);\r\n\r\n    // Restore resolution times state\r\n    const resolutionTimesState = this.metricStates.get(\"resolutionTimes\");\r\n    if (resolutionTimesState) {\r\n      const buffer = new Float64Array(rawMetrics.resolutionTimes);\r\n      this.setMetricValue(\"resolutionTimes\", {\r\n        buffer,\r\n        index: rawMetrics.resolutionTimesIndex,\r\n        count: rawMetrics.resolutionTimesCount,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets a metric value by key.\r\n   *\r\n   * @param key - Metric key\r\n   * @param value - New metric value\r\n   */\r\n  private setMetricValue<T>(key: string, value: T): void {\r\n    const state = this.metricStates.get(key);\r\n    if (state) {\r\n      this.metricStates.set(key, {\r\n        value: value as unknown,\r\n        definition: state.definition,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIMetricsCollector extends MetricsCollector {\r\n  static override dependencies: readonly InjectionToken<unknown>[] = [\r\n    runtimeConfigToken,\r\n    metricsAggregatorToken,\r\n    metricsPersistenceManagerToken,\r\n    metricsStateManagerToken,\r\n  ];\r\n\r\n  constructor(\r\n    config: PlatformRuntimeConfigPort,\r\n    aggregator: IMetricsAggregator,\r\n    persistenceManager: IMetricsPersistenceManager,\r\n    stateManager: IMetricsStateManager,\r\n    registry?: MetricDefinitionRegistry\r\n  ) {\r\n    super(config, aggregator, persistenceManager, stateManager, registry);\r\n  }\r\n}\r\n","import type { InjectionToken } from \"@/infrastructure/di/types/core/injectiontoken\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport { metricsStorageToken } from \"@/infrastructure/shared/tokens/observability/metrics-storage.token\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { metricsAggregatorToken } from \"@/infrastructure/shared/tokens/observability/metrics-aggregator.token\";\r\nimport { metricsPersistenceManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-persistence-manager.token\";\r\nimport { metricsStateManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-state-manager.token\";\r\nimport type { IMetricsAggregator } from \"@/infrastructure/observability/interfaces/metrics-aggregator.interface\";\r\nimport type { IMetricsPersistenceManager } from \"@/infrastructure/observability/interfaces/metrics-persistence-manager.interface\";\r\nimport type { IMetricsStateManager } from \"@/infrastructure/observability/interfaces/metrics-state-manager.interface\";\r\nimport type { MetricsPersistenceState } from \"@/infrastructure/observability/metrics-types\";\r\nimport { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { MetricsStorage } from \"./metrics-storage\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { MetricDefinitionRegistry } from \"@/infrastructure/observability/metrics-definition/metric-definition-registry\";\r\nimport type { Initializable } from \"@/domain/ports/initializable.interface\";\r\n\r\n/**\r\n * MetricsCollector variant that persists state via MetricsStorage.\r\n *\r\n * Implements Initializable interface to support explicit initialization\r\n * after construction, following the Liskov Substitution Principle (LSP).\r\n */\r\nexport class PersistentMetricsCollector extends MetricsCollector implements Initializable {\r\n  static override dependencies: readonly InjectionToken<unknown>[] = [\r\n    runtimeConfigToken,\r\n    metricsStorageToken,\r\n  ];\r\n\r\n  private suppressPersistence = false;\r\n  private initialized = false;\r\n\r\n  constructor(\r\n    config: PlatformRuntimeConfigPort,\r\n    private readonly metricsStorage: MetricsStorage,\r\n    aggregator: IMetricsAggregator,\r\n    persistenceManager: IMetricsPersistenceManager,\r\n    stateManager: IMetricsStateManager,\r\n    registry?: MetricDefinitionRegistry\r\n  ) {\r\n    super(config, aggregator, persistenceManager, stateManager, registry);\r\n    // I/O removed from constructor - use initialize() instead\r\n  }\r\n\r\n  /**\r\n   * Initializes the collector by restoring state from storage.\r\n   * Must be called explicitly after construction.\r\n   *\r\n   * @returns Result indicating success or error\r\n   */\r\n  initialize(): Result<void, string> {\r\n    if (this.initialized) {\r\n      return ok(undefined);\r\n    }\r\n\r\n    try {\r\n      this.restoreFromStorage();\r\n      this.initialized = true;\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : String(error);\r\n      return err(`Failed to initialize PersistentMetricsCollector: ${errorMessage}`);\r\n    }\r\n  }\r\n\r\n  clearPersistentState(): void {\r\n    this.metricsStorage.clear?.();\r\n    this.suppressPersistence = true;\r\n    try {\r\n      super.reset();\r\n    } finally {\r\n      this.suppressPersistence = false;\r\n    }\r\n  }\r\n\r\n  protected override onStateChanged(): void {\r\n    // Call parent to notify state manager\r\n    super.onStateChanged();\r\n\r\n    if (this.suppressPersistence) {\r\n      return;\r\n    }\r\n    this.persist();\r\n  }\r\n\r\n  private restoreFromStorage(): void {\r\n    let state: MetricsPersistenceState | null = null;\r\n    try {\r\n      state = this.metricsStorage.load();\r\n    } catch {\r\n      state = null;\r\n    }\r\n\r\n    if (!state) {\r\n      return;\r\n    }\r\n\r\n    this.suppressPersistence = true;\r\n    try {\r\n      this.restoreFromPersistenceState(state);\r\n    } finally {\r\n      this.suppressPersistence = false;\r\n    }\r\n  }\r\n\r\n  private persist(): void {\r\n    try {\r\n      this.metricsStorage.save(this.getPersistenceState());\r\n    } catch {\r\n      // Persistence failures are non-critical; ignore\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIPersistentMetricsCollector extends PersistentMetricsCollector {\r\n  static override dependencies: readonly InjectionToken<unknown>[] = [\r\n    runtimeConfigToken,\r\n    metricsStorageToken,\r\n    metricsAggregatorToken,\r\n    metricsPersistenceManagerToken,\r\n    metricsStateManagerToken,\r\n  ];\r\n\r\n  constructor(\r\n    config: PlatformRuntimeConfigPort,\r\n    metricsStorage: MetricsStorage,\r\n    aggregator: IMetricsAggregator,\r\n    persistenceManager: IMetricsPersistenceManager,\r\n    stateManager: IMetricsStateManager,\r\n    registry?: MetricDefinitionRegistry\r\n  ) {\r\n    super(config, metricsStorage, aggregator, persistenceManager, stateManager, registry);\r\n  }\r\n}\r\n","import type { IRawMetrics } from \"./interfaces/raw-metrics.interface\";\r\nimport type { IMetricsAggregator } from \"./interfaces/metrics-aggregator.interface\";\r\nimport type { MetricsSnapshot } from \"./metrics-types\";\r\n\r\n/**\r\n * Aggregates raw metrics into snapshots.\r\n *\r\n * Follows Single Responsibility Principle: Only responsible for aggregation.\r\n */\r\nexport class MetricsAggregator implements IMetricsAggregator {\r\n  /**\r\n   * Aggregates raw metrics into a snapshot.\r\n   *\r\n   * @param metrics - Raw metrics data\r\n   * @returns Aggregated metrics snapshot\r\n   */\r\n  aggregate(metrics: IRawMetrics): MetricsSnapshot {\r\n    const avgTime = this.calculateAverage(metrics.resolutionTimes, metrics.resolutionTimesCount);\r\n    const cacheHitRate = this.calculateCacheHitRate(metrics.cacheHits, metrics.cacheMisses);\r\n\r\n    return {\r\n      containerResolutions: metrics.containerResolutions,\r\n      resolutionErrors: metrics.resolutionErrors,\r\n      avgResolutionTimeMs: avgTime,\r\n      portSelections: Object.fromEntries(metrics.portSelections),\r\n      portSelectionFailures: Object.fromEntries(metrics.portSelectionFailures),\r\n      cacheHitRate,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculates the average of resolution times.\r\n   *\r\n   * @param times - Array of resolution times\r\n   * @param count - Number of valid entries in the array\r\n   * @returns Average time in milliseconds\r\n   */\r\n  calculateAverage(times: Float64Array, count: number): number {\r\n    if (count === 0) {\r\n      return 0;\r\n    }\r\n\r\n    const slice = times.slice(0, count);\r\n    const sum = slice.reduce((acc, time) => acc + time, 0);\r\n    return sum / count;\r\n  }\r\n\r\n  /**\r\n   * Calculates the cache hit rate as a percentage.\r\n   *\r\n   * @param hits - Number of cache hits\r\n   * @param misses - Number of cache misses\r\n   * @returns Cache hit rate (0-100)\r\n   */\r\n  calculateCacheHitRate(hits: number, misses: number): number {\r\n    const totalAccess = hits + misses;\r\n    if (totalAccess === 0) {\r\n      return 0;\r\n    }\r\n    return (hits / totalAccess) * 100;\r\n  }\r\n}\r\n","import type { IRawMetrics } from \"../interfaces/raw-metrics.interface\";\r\nimport type { IMetricsPersistenceManager } from \"../interfaces/metrics-persistence-manager.interface\";\r\nimport type { MetricsPersistenceState } from \"../metrics-types\";\r\nimport { METRICS_CONFIG } from \"@/infrastructure/shared/constants\";\r\n\r\n/**\r\n * Manages serialization and deserialization of metrics state.\r\n *\r\n * Follows Single Responsibility Principle: Only responsible for persistence operations.\r\n */\r\nexport class MetricsPersistenceManager implements IMetricsPersistenceManager {\r\n  /**\r\n   * Serializes raw metrics into a persistence state.\r\n   *\r\n   * @param metrics - Raw metrics data\r\n   * @returns Serializable persistence state\r\n   */\r\n  serialize(metrics: IRawMetrics): MetricsPersistenceState {\r\n    return {\r\n      metrics: {\r\n        containerResolutions: metrics.containerResolutions,\r\n        resolutionErrors: metrics.resolutionErrors,\r\n        cacheHits: metrics.cacheHits,\r\n        cacheMisses: metrics.cacheMisses,\r\n        portSelections: Object.fromEntries(metrics.portSelections),\r\n        portSelectionFailures: Object.fromEntries(metrics.portSelectionFailures),\r\n      },\r\n      resolutionTimes: Array.from(metrics.resolutionTimes),\r\n      resolutionTimesIndex: metrics.resolutionTimesIndex,\r\n      resolutionTimesCount: metrics.resolutionTimesCount,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Deserializes a persistence state into raw metrics.\r\n   *\r\n   * @param state - Persisted state (can be null or undefined)\r\n   * @returns Raw metrics data\r\n   */\r\n  deserialize(state: MetricsPersistenceState | null | undefined): IRawMetrics {\r\n    if (!state) {\r\n      return this.createEmptyRawMetrics();\r\n    }\r\n\r\n    const { metrics, resolutionTimes, resolutionTimesCount, resolutionTimesIndex } = state;\r\n\r\n    const rawMetrics: IRawMetrics = {\r\n      containerResolutions: Math.max(0, metrics?.containerResolutions ?? 0),\r\n      resolutionErrors: Math.max(0, metrics?.resolutionErrors ?? 0),\r\n      cacheHits: Math.max(0, metrics?.cacheHits ?? 0),\r\n      cacheMisses: Math.max(0, metrics?.cacheMisses ?? 0),\r\n      portSelections: new Map<number, number>(\r\n        Object.entries(metrics?.portSelections ?? {}).map(([key, value]) => [\r\n          Number(key),\r\n          Number.isFinite(Number(value)) ? Number(value) : 0,\r\n        ])\r\n      ),\r\n      portSelectionFailures: new Map<number, number>(\r\n        Object.entries(metrics?.portSelectionFailures ?? {}).map(([key, value]) => [\r\n          Number(key),\r\n          Number.isFinite(Number(value)) ? Number(value) : 0,\r\n        ])\r\n      ),\r\n      resolutionTimes: new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE),\r\n      resolutionTimesIndex: 0,\r\n      resolutionTimesCount: 0,\r\n    };\r\n\r\n    if (Array.isArray(resolutionTimes)) {\r\n      const maxLength = Math.min(resolutionTimes.length, rawMetrics.resolutionTimes.length);\r\n      for (let index = 0; index < maxLength; index++) {\r\n        const value = Number(resolutionTimes[index]);\r\n        rawMetrics.resolutionTimes[index] = Number.isFinite(value) ? value : 0;\r\n      }\r\n\r\n      const safeIndex = Number.isFinite(resolutionTimesIndex) ? Number(resolutionTimesIndex) : 0;\r\n      const safeCount = Number.isFinite(resolutionTimesCount) ? Number(resolutionTimesCount) : 0;\r\n\r\n      rawMetrics.resolutionTimesIndex = Math.min(\r\n        Math.max(0, safeIndex),\r\n        METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE - 1\r\n      );\r\n      rawMetrics.resolutionTimesCount = Math.min(\r\n        Math.max(0, safeCount),\r\n        METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE\r\n      );\r\n    } else {\r\n      // If resolutionTimes is not an array, reset index and count\r\n      rawMetrics.resolutionTimesIndex = 0;\r\n      rawMetrics.resolutionTimesCount = 0;\r\n    }\r\n\r\n    return rawMetrics;\r\n  }\r\n\r\n  /**\r\n   * Creates an empty raw metrics structure.\r\n   *\r\n   * @returns Empty raw metrics\r\n   */\r\n  private createEmptyRawMetrics(): IRawMetrics {\r\n    return {\r\n      containerResolutions: 0,\r\n      resolutionErrors: 0,\r\n      cacheHits: 0,\r\n      cacheMisses: 0,\r\n      portSelections: new Map<number, number>(),\r\n      portSelectionFailures: new Map<number, number>(),\r\n      resolutionTimes: new Float64Array(METRICS_CONFIG.RESOLUTION_TIMES_BUFFER_SIZE),\r\n      resolutionTimesIndex: 0,\r\n      resolutionTimesCount: 0,\r\n    };\r\n  }\r\n}\r\n","import type { IMetricsStateManager } from \"../interfaces/metrics-state-manager.interface\";\r\n\r\n/**\r\n * Manages state change notifications for metrics.\r\n *\r\n * Follows Single Responsibility Principle: Only responsible for state change management.\r\n */\r\nexport class MetricsStateManager implements IMetricsStateManager {\r\n  private callbacks: Set<() => void> = new Set();\r\n\r\n  /**\r\n   * Resets the state manager.\r\n   * Clears all registered callbacks.\r\n   */\r\n  reset(): void {\r\n    this.callbacks.clear();\r\n  }\r\n\r\n  /**\r\n   * Subscribes to state changes.\r\n   *\r\n   * @param callback - Callback to invoke on state changes\r\n   */\r\n  onStateChanged(callback: () => void): void {\r\n    this.callbacks.add(callback);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribes from state changes.\r\n   *\r\n   * @param callback - Callback to remove\r\n   */\r\n  unsubscribe(callback: () => void): void {\r\n    this.callbacks.delete(callback);\r\n  }\r\n\r\n  /**\r\n   * Notifies all registered callbacks of a state change.\r\n   * Internal method used by MetricsCollector.\r\n   */\r\n  notifyStateChanged(): void {\r\n    for (const callback of this.callbacks) {\r\n      try {\r\n        callback();\r\n      } catch (error) {\r\n        // Ignore errors in callbacks to prevent one failing callback from breaking others\r\n\r\n        console.error(\"Error in metrics state change callback:\", error);\r\n      }\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Metrics sampler for performance tracking decisions.\r\n *\r\n * Separated from MetricsCollector to follow Single Responsibility Principle.\r\n * This class is responsible only for sampling decisions, not metric collection.\r\n *\r\n * @see MetricsCollector for metric collection\r\n * @see MetricsReporter for metric reporting\r\n */\r\n\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { MetricsSampler as MetricsSamplerInterface } from \"./interfaces/metrics-sampler\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\n\r\n/**\r\n * Metrics sampler implementation.\r\n *\r\n * Determines if a performance operation should be sampled based on\r\n * configured sampling rates and environment mode.\r\n *\r\n * @example\r\n * ```typescript\r\n * const sampler = container.resolve(metricsSamplerToken);\r\n * if (sampler.shouldSample()) {\r\n *   // Measure performance\r\n * }\r\n * ```\r\n */\r\nexport class MetricsSampler implements MetricsSamplerInterface {\r\n  constructor(private readonly config: PlatformRuntimeConfigPort) {}\r\n\r\n  /**\r\n   * Determines if a performance operation should be sampled based on sampling rate.\r\n   *\r\n   * In production mode, uses probabilistic sampling to reduce overhead.\r\n   * In development mode, always samples (returns true).\r\n   *\r\n   * @returns True if the operation should be measured/recorded\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const sampler = container.resolve(metricsSamplerToken);\r\n   * if (sampler.shouldSample()) {\r\n   *   performance.mark('operation-start');\r\n   *   // ... operation ...\r\n   *   performance.mark('operation-end');\r\n   *   performance.measure('operation', 'operation-start', 'operation-end');\r\n   * }\r\n   * ```\r\n   */\r\n  shouldSample(): boolean {\r\n    // Always sample in development mode\r\n    if (this.config.get(\"isDevelopment\")) {\r\n      return true;\r\n    }\r\n\r\n    // Probabilistic sampling in production based on configured rate\r\n    return Math.random() < this.config.get(\"performanceSamplingRate\");\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for MetricsSampler.\r\n */\r\nexport class DIMetricsSampler extends MetricsSampler {\r\n  static dependencies = [runtimeConfigToken] as const;\r\n\r\n  constructor(config: PlatformRuntimeConfigPort) {\r\n    super(config);\r\n  }\r\n}\r\n","/**\r\n * Metrics reporter for formatting and logging metrics.\r\n *\r\n * Separated from MetricsCollector to follow Single Responsibility Principle.\r\n * This class is responsible only for reporting/logging metrics, not collection.\r\n *\r\n * @see MetricsCollector for metric collection\r\n * @see MetricsSampler for sampling decisions\r\n */\r\n\r\nimport type { MetricsCollector } from \"./metrics-collector\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\n\r\n/**\r\n * Table data structure for console.table() output in logSummary().\r\n * Uses string keys to match console.table() expectations.\r\n * Naming convention disabled for console.table() compatibility.\r\n */\r\n/* eslint-disable @typescript-eslint/naming-convention */\r\ninterface MetricsTableData {\r\n  \"Total Resolutions\": number;\r\n  Errors: number;\r\n  \"Avg Time (ms)\": string;\r\n  \"Cache Hit Rate\": string;\r\n}\r\n/* eslint-enable @typescript-eslint/naming-convention */\r\n\r\n/**\r\n * Metrics reporter for formatting and logging metrics.\r\n *\r\n * Provides methods to format and log metrics data collected by MetricsCollector.\r\n * Separated from MetricsCollector to follow Single Responsibility Principle.\r\n *\r\n * @example\r\n * ```typescript\r\n * const reporter = container.resolve(metricsReporterToken);\r\n * reporter.logSummary();\r\n * const json = reporter.toJSON();\r\n * ```\r\n */\r\nexport class MetricsReporter {\r\n  constructor(\r\n    private readonly collector: MetricsCollector,\r\n    private readonly logger?: Logger\r\n  ) {}\r\n\r\n  /**\r\n   * Logs a formatted metrics summary to the console.\r\n   * Uses console.table() for easy-to-read tabular output.\r\n   */\r\n  logSummary(): void {\r\n    const snapshot = this.collector.getSnapshot();\r\n\r\n    /* eslint-disable @typescript-eslint/naming-convention */\r\n    const tableData: MetricsTableData = {\r\n      \"Total Resolutions\": snapshot.containerResolutions,\r\n      Errors: snapshot.resolutionErrors,\r\n      \"Avg Time (ms)\": snapshot.avgResolutionTimeMs.toFixed(2),\r\n      \"Cache Hit Rate\": `${snapshot.cacheHitRate.toFixed(1)}%`,\r\n    };\r\n    /* eslint-enable @typescript-eslint/naming-convention */\r\n    console.table(tableData);\r\n  }\r\n\r\n  /**\r\n   * Gibt Metrics als JSON zurück.\r\n   *\r\n   * @returns JSON string representation of metrics snapshot\r\n   */\r\n  toJSON(): string {\r\n    return JSON.stringify(this.collector.getSnapshot(), null, 2);\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for MetricsReporter.\r\n */\r\nexport class DIMetricsReporter extends MetricsReporter {\r\n  static dependencies = [metricsCollectorToken, loggerToken] as const;\r\n\r\n  constructor(collector: MetricsCollector, logger: Logger) {\r\n    super(collector, logger);\r\n  }\r\n}\r\n","import type { MetricsPersistenceState } from \"@/infrastructure/observability/metrics-types\";\r\nimport type { MetricsStorage } from \"./metrics-storage\";\r\n\r\n/**\r\n * LocalStorage-based metrics persistence.\r\n *\r\n * Gracefully degrades when localStorage is unavailable (e.g., in private mode\r\n * or server-side rendering) by behaving like a no-op storage.\r\n */\r\nexport class LocalStorageMetricsStorage implements MetricsStorage {\r\n  constructor(\r\n    private readonly storageKey: string,\r\n    private readonly storage: Storage | null = getStorage()\r\n  ) {}\r\n\r\n  load(): MetricsPersistenceState | null {\r\n    if (!this.storage) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const raw = this.storage.getItem(this.storageKey);\r\n      if (!raw) {\r\n        return null;\r\n      }\r\n      return JSON.parse(raw) as MetricsPersistenceState;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  save(state: MetricsPersistenceState): void {\r\n    if (!this.storage) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.storage.setItem(this.storageKey, JSON.stringify(state));\r\n    } catch {\r\n      // Storage quota exceeded or serialization failed → ignore silently\r\n    }\r\n  }\r\n\r\n  clear(): void {\r\n    if (!this.storage) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.storage.removeItem(this.storageKey);\r\n    } catch {\r\n      // Ignore storage errors\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the localStorage object if available in the current environment.\r\n * Returns null if localStorage is not available (e.g., server-side, private mode).\r\n * Exported for testing purposes.\r\n */\r\nexport function getStorage(): Storage | null {\r\n  try {\r\n    if (typeof globalThis !== \"undefined\" && \"localStorage\" in globalThis) {\r\n      return globalThis.localStorage;\r\n    }\r\n  } catch {\r\n    // Accessing localStorage can throw in some environments\r\n  }\r\n  return null;\r\n}\r\n","import type { MetricsPersistenceState } from \"@/infrastructure/observability/metrics-types\";\r\nimport type { MetricsStorage } from \"./metrics-storage\";\r\nimport { LocalStorageMetricsStorage } from \"./local-storage-metrics-storage\";\r\n\r\n/**\r\n * Factory function for creating MetricsStorage instances.\r\n *\r\n * Abstracts the concrete implementation from the DI configuration.\r\n * This allows easy swapping of storage backends without changing the config.\r\n *\r\n * @param key - Storage key for persisting metrics\r\n * @returns MetricsStorage instance\r\n *\r\n * @example\r\n * ```typescript\r\n * // Production: Use localStorage\r\n * const storage = createMetricsStorage(\"my-app.metrics\");\r\n *\r\n * // Testing: Use in-memory storage\r\n * const storage = createInMemoryMetricsStorage();\r\n * ```\r\n */\r\nexport function createMetricsStorage(key: string): MetricsStorage {\r\n  return new LocalStorageMetricsStorage(key);\r\n}\r\n\r\n/**\r\n * Creates an in-memory MetricsStorage for testing.\r\n * Data is not persisted and is lost when the instance is garbage collected.\r\n *\r\n * @returns MetricsStorage instance that stores data only in memory\r\n */\r\nexport function createInMemoryMetricsStorage(): MetricsStorage {\r\n  let state: MetricsPersistenceState | null = null;\r\n\r\n  return {\r\n    load(): MetricsPersistenceState | null {\r\n      return state;\r\n    },\r\n    save(newState: MetricsPersistenceState): void {\r\n      state = newState;\r\n    },\r\n    clear(): void {\r\n      state = null;\r\n    },\r\n  };\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\n\r\n/**\r\n * Decorator that adds a specific trace ID to all log messages.\r\n * Used by withTraceId() to create a logger with a fixed trace ID.\r\n */\r\nexport class TracedLogger implements Logger {\r\n  constructor(\r\n    private readonly baseLogger: Logger,\r\n    private readonly traceId: string\r\n  ) {}\r\n\r\n  setMinLevel?(level: LogLevel): void {\r\n    this.baseLogger.setMinLevel?.(level);\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.log(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.error(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.warn(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.info(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.debug(this.formatMessage(message), ...optionalParams);\r\n  }\r\n\r\n  withTraceId?(newTraceId: string): Logger {\r\n    return new TracedLogger(this.baseLogger, `${this.traceId}/${newTraceId}`);\r\n  }\r\n\r\n  private formatMessage(message: string): string {\r\n    return `[${this.traceId}] ${message}`;\r\n  }\r\n}\r\n","import { LOG_PREFIX } from \"@/application/constants/app-constants\";\r\nimport type { Logger } from \"./logger.interface\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\nimport { TracedLogger } from \"./TracedLogger\";\r\n\r\n/**\r\n * Base console logger without configuration or trace concerns.\r\n * Single Responsibility: Only writes to console.\r\n */\r\nexport class BaseConsoleLogger implements Logger {\r\n  constructor(private minLevel: LogLevel) {}\r\n\r\n  setMinLevel(level: LogLevel): void {\r\n    this.minLevel = level;\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    console.log(`${LOG_PREFIX} ${message}`, ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.ERROR < this.minLevel) return;\r\n    console.error(`${LOG_PREFIX} ${message}`, ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.WARN < this.minLevel) return;\r\n    console.warn(`${LOG_PREFIX} ${message}`, ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.INFO < this.minLevel) return;\r\n    console.info(`${LOG_PREFIX} ${message}`, ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    if (LogLevel.DEBUG < this.minLevel) return;\r\n    console.debug(`${LOG_PREFIX} ${message}`, ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    return new TracedLogger(this, traceId);\r\n  }\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\n\r\n/**\r\n * Decorator that syncs log level with RuntimeConfig.\r\n * Single Responsibility: Only handles RuntimeConfig subscription.\r\n */\r\nexport class RuntimeConfigLoggerDecorator implements Logger {\r\n  private unsubscribe: (() => void) | null = null;\r\n\r\n  constructor(\r\n    private readonly baseLogger: Logger,\r\n    private readonly runtimeConfig: PlatformRuntimeConfigPort\r\n  ) {\r\n    this.syncLogLevel();\r\n  }\r\n\r\n  private syncLogLevel(): void {\r\n    this.baseLogger.setMinLevel?.(this.runtimeConfig.get(\"logLevel\"));\r\n    this.unsubscribe?.();\r\n    this.unsubscribe = this.runtimeConfig.onChange(\"logLevel\", (level) => {\r\n      this.baseLogger.setMinLevel?.(level);\r\n    });\r\n  }\r\n\r\n  setMinLevel(level: LogLevel): void {\r\n    this.baseLogger.setMinLevel?.(level);\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.log(message, ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.error(message, ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.warn(message, ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.info(message, ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.debug(message, ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    return this.baseLogger.withTraceId?.(traceId) ?? this.baseLogger;\r\n  }\r\n\r\n  dispose(): void {\r\n    this.unsubscribe?.();\r\n  }\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport { LogLevel as LogLevelEnum } from \"@/domain/types/log-level\";\r\n\r\n/**\r\n * Decorator that adds stack trace information to log messages when debug mode is enabled.\r\n * Single Responsibility: Only handles caller information extraction and formatting.\r\n *\r\n * Compatible with other logger decorators (RuntimeConfigLoggerDecorator, TraceContextLoggerDecorator).\r\n * The caller info is appended to the message, allowing other decorators to prepend their information.\r\n *\r\n * @example\r\n * When LogLevel is DEBUG:\r\n * - Input: \"Warning: Something went wrong\"\r\n * - Output: \"Warning: Something went wrong [foundry-ports.ts:42]\"\r\n *\r\n * When LogLevel is not DEBUG:\r\n * - Input: \"Warning: Something went wrong\"\r\n * - Output: \"Warning: Something went wrong\" (no caller info)\r\n */\r\nexport class StackTraceLoggerDecorator implements Logger {\r\n  constructor(\r\n    private readonly baseLogger: Logger,\r\n    private readonly runtimeConfig: PlatformRuntimeConfigPort\r\n  ) {}\r\n\r\n  setMinLevel(level: LogLevel): void {\r\n    this.baseLogger.setMinLevel?.(level);\r\n  }\r\n\r\n  /**\r\n   * Extracts the caller information from stack trace when debug mode is enabled.\r\n   * Filters out logger-related frames to show the actual source of the log call.\r\n   *\r\n   * @returns Caller info in format \"filename:line\" or undefined if not in debug mode or extraction fails\r\n   */\r\n  private getCallerInfo(): string | undefined {\r\n    const currentLogLevel = this.runtimeConfig.get(\"logLevel\");\r\n    if (currentLogLevel !== LogLevelEnum.DEBUG) {\r\n      return undefined;\r\n    }\r\n\r\n    try {\r\n      const stack = new Error().stack;\r\n      if (!stack) return undefined;\r\n\r\n      const lines = stack.split(\"\\n\");\r\n      // Skip: Error constructor (line 0), this method (line 1-2), and logger methods\r\n      // Look for first frame that's not from logging infrastructure\r\n      const loggerPatterns = [\r\n        /StackTraceLoggerDecorator/,\r\n        /BaseConsoleLogger/,\r\n        /ConsoleLoggerService/,\r\n        /RuntimeConfigLoggerDecorator/,\r\n        /TraceContextLoggerDecorator/,\r\n        /TracedLogger/,\r\n        /at Object\\./,\r\n      ];\r\n\r\n      for (let i = 3; i < lines.length; i++) {\r\n        const line = lines[i];\r\n        if (!line) continue;\r\n\r\n        const isLoggerFrame = loggerPatterns.some((pattern) => pattern.test(line));\r\n        if (!isLoggerFrame && line.trim()) {\r\n          // Extract file and line info, clean up the format\r\n          // Match: \"at functionName (file.ts:42:10)\" or \"at file.ts:42:10\"\r\n          const match =\r\n            line.match(/at\\s+(.+?)\\s+\\((.+?):(\\d+):(\\d+)\\)/) ||\r\n            line.match(/at\\s+(.+?):(\\d+):(\\d+)/);\r\n          if (match) {\r\n            // Return simplified caller info: filename:line\r\n            const filePath = match[2] || match[1];\r\n            const lineNum = match[3] || match[2];\r\n            if (filePath && lineNum) {\r\n              // Extract just the filename if it's a full path\r\n              const fileName = filePath.split(/[/\\\\]/).pop() || filePath;\r\n              return `${fileName}:${lineNum}`;\r\n            }\r\n          }\r\n          // Fallback: return the cleaned line\r\n          return line.trim().replace(/^at\\s+/, \"\");\r\n        }\r\n      }\r\n    } catch {\r\n      // Silently fail if stack trace is not available\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private formatWithCallerInfo(message: string): string {\r\n    const callerInfo = this.getCallerInfo();\r\n    return callerInfo ? `${message} [${callerInfo}]` : message;\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.log(this.formatWithCallerInfo(message), ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.error(this.formatWithCallerInfo(message), ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.warn(this.formatWithCallerInfo(message), ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.info(this.formatWithCallerInfo(message), ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.debug(this.formatWithCallerInfo(message), ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    return this.baseLogger.withTraceId?.(traceId) ?? this.baseLogger;\r\n  }\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\nimport { TracedLogger } from \"./TracedLogger\";\r\n\r\n/**\r\n * Decorator that adds trace context to log messages.\r\n * Single Responsibility: Only handles trace ID formatting.\r\n */\r\nexport class TraceContextLoggerDecorator implements Logger {\r\n  constructor(\r\n    private readonly baseLogger: Logger,\r\n    private readonly traceContext: TraceContext | null\r\n  ) {}\r\n\r\n  setMinLevel(level: LogLevel): void {\r\n    this.baseLogger.setMinLevel?.(level);\r\n  }\r\n\r\n  private formatWithTrace(message: string): string {\r\n    const traceId = this.traceContext?.getCurrentTraceId();\r\n    return traceId ? `[${traceId}] ${message}` : message;\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.log(this.formatWithTrace(message), ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.error(this.formatWithTrace(message), ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.warn(this.formatWithTrace(message), ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.info(this.formatWithTrace(message), ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.baseLogger.debug(this.formatWithTrace(message), ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    // Wrap this decorator (not the base logger) so that context trace is preserved\r\n    return new TracedLogger(this, traceId);\r\n  }\r\n}\r\n","import type { Logger } from \"../logger.interface\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport { BaseConsoleLogger } from \"../BaseConsoleLogger\";\r\nimport { RuntimeConfigLoggerDecorator } from \"../RuntimeConfigLoggerDecorator\";\r\nimport { StackTraceLoggerDecorator } from \"../StackTraceLoggerDecorator\";\r\nimport { TraceContextLoggerDecorator } from \"../TraceContextLoggerDecorator\";\r\n\r\n/**\r\n * Interface for logger composition factory.\r\n * Single Responsibility: Defines contract for logger composition.\r\n */\r\nexport interface ILoggerCompositionFactory {\r\n  /**\r\n   * Creates a composed logger with all necessary decorators.\r\n   *\r\n   * @param config - Runtime configuration port\r\n   * @param traceContext - Optional trace context for trace ID injection\r\n   * @returns Composed logger instance\r\n   */\r\n  createLogger(config: PlatformRuntimeConfigPort, traceContext?: TraceContext): Logger;\r\n}\r\n\r\n/**\r\n * Factory for composing logger instances with decorators.\r\n * Single Responsibility: Only handles logger composition logic.\r\n *\r\n * Composes logger in the following order:\r\n * 1. BaseConsoleLogger (base logging)\r\n * 2. RuntimeConfigLoggerDecorator (runtime config integration)\r\n * 3. StackTraceLoggerDecorator (stack trace integration)\r\n * 4. TraceContextLoggerDecorator (trace context integration, if provided)\r\n */\r\nexport class LoggerCompositionFactory implements ILoggerCompositionFactory {\r\n  /**\r\n   * Creates a composed logger with all necessary decorators.\r\n   *\r\n   * @param config - Runtime configuration port\r\n   * @param traceContext - Optional trace context for trace ID injection\r\n   * @returns Composed logger instance\r\n   */\r\n  createLogger(config: PlatformRuntimeConfigPort, traceContext?: TraceContext): Logger {\r\n    const baseLogger = new BaseConsoleLogger(config.get(\"logLevel\"));\r\n    const withConfig = new RuntimeConfigLoggerDecorator(baseLogger, config);\r\n    const withStackTrace = new StackTraceLoggerDecorator(withConfig, config);\r\n    return traceContext\r\n      ? new TraceContextLoggerDecorator(withStackTrace, traceContext)\r\n      : withStackTrace;\r\n  }\r\n}\r\n","import type { Logger } from \"./logger.interface\";\r\nimport type { TraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport { traceContextToken } from \"@/infrastructure/shared/tokens/observability/trace-context.token\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\nimport {\r\n  LoggerCompositionFactory,\r\n  type ILoggerCompositionFactory,\r\n} from \"./factory/logger-composition-factory\";\r\n\r\n/**\r\n * Console logger with RuntimeConfig and TraceContext support.\r\n * Single Responsibility: Only provides Logger interface, delegates to composed logger.\r\n *\r\n * Logger composition is handled by LoggerCompositionFactory.\r\n */\r\nexport class ConsoleLoggerService implements Logger {\r\n  private readonly logger: Logger;\r\n\r\n  constructor(\r\n    config: PlatformRuntimeConfigPort,\r\n    traceContext?: TraceContext,\r\n    factory?: ILoggerCompositionFactory\r\n  ) {\r\n    const compositionFactory = factory ?? new LoggerCompositionFactory();\r\n    this.logger = compositionFactory.createLogger(config, traceContext);\r\n  }\r\n\r\n  // Delegate all methods to composed logger\r\n  setMinLevel(level: LogLevel): void {\r\n    this.logger.setMinLevel?.(level);\r\n  }\r\n\r\n  log(message: string, ...optionalParams: unknown[]): void {\r\n    this.logger.log(message, ...optionalParams);\r\n  }\r\n\r\n  error(message: string, ...optionalParams: unknown[]): void {\r\n    this.logger.error(message, ...optionalParams);\r\n  }\r\n\r\n  warn(message: string, ...optionalParams: unknown[]): void {\r\n    this.logger.warn(message, ...optionalParams);\r\n  }\r\n\r\n  info(message: string, ...optionalParams: unknown[]): void {\r\n    this.logger.info(message, ...optionalParams);\r\n  }\r\n\r\n  debug(message: string, ...optionalParams: unknown[]): void {\r\n    this.logger.debug(message, ...optionalParams);\r\n  }\r\n\r\n  withTraceId(traceId: string): Logger {\r\n    return this.logger.withTraceId?.(traceId) ?? this.logger;\r\n  }\r\n}\r\n\r\nexport class DIConsoleLoggerService extends ConsoleLoggerService {\r\n  static dependencies = [runtimeConfigToken, traceContextToken] as const;\r\n\r\n  constructor(config: PlatformRuntimeConfigPort, traceContext?: TraceContext) {\r\n    super(config, traceContext);\r\n  }\r\n}\r\n","/**\r\n * Utilities for distributed tracing and request correlation.\r\n * Provides unique trace IDs to correlate log messages across operations.\r\n */\r\n\r\n/**\r\n * Generates a unique trace ID for correlating related log entries.\r\n *\r\n * Format: {timestamp}-{random}\r\n * - timestamp: Unix timestamp in milliseconds (for chronological ordering)\r\n * - random: Random hex string for uniqueness\r\n *\r\n * @returns A unique trace ID string\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceId = generateTraceId();\r\n * logger.withTraceId(traceId).info('Starting operation');\r\n * // ... nested operations can use the same traceId ...\r\n * logger.withTraceId(traceId).info('Operation completed');\r\n * ```\r\n */\r\nexport function generateTraceId(): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 10);\r\n  return `${timestamp}-${random}`;\r\n}\r\n\r\n/**\r\n * Extracts timestamp from a trace ID (if available).\r\n * Useful for debugging and metrics correlation.\r\n *\r\n * @param traceId - The trace ID to parse\r\n * @returns The timestamp in milliseconds, or null if invalid format\r\n */\r\nexport function getTraceTimestamp(traceId: string): number | null {\r\n  const parts = traceId.split(\"-\");\r\n  if (parts.length !== 2) {\r\n    return null;\r\n  }\r\n\r\n  const [timestampStr, randomStr] = parts;\r\n  if (!timestampStr || !randomStr) {\r\n    return null;\r\n  }\r\n\r\n  const timestamp = parseInt(timestampStr, 10);\r\n  return isNaN(timestamp) ? null : timestamp;\r\n}\r\n","/**\r\n * TraceContext service for automatic trace ID propagation.\r\n *\r\n * Provides automatic trace ID management across nested function calls,\r\n * eliminating the need to manually pass trace IDs through function parameters.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Automatic trace propagation\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Starting operation\"); // Automatically traced!\r\n *   doSomething(); // Nested calls see the same trace ID\r\n *   logger.info(\"Completed\"); // Same trace ID\r\n * });\r\n *\r\n * // Custom trace ID\r\n * traceContext.trace(() => {\r\n *   // ...\r\n * }, { traceId: \"custom-trace-123\" });\r\n *\r\n * // Nested traces\r\n * traceContext.trace(() => {\r\n *   logger.info(\"Outer trace\");\r\n *   traceContext.trace(() => {\r\n *     logger.info(\"Inner trace\"); // Different trace ID\r\n *   });\r\n *   logger.info(\"Back to outer trace\");\r\n * });\r\n * ```\r\n */\r\n\r\nimport { generateTraceId } from \"@/infrastructure/shared/utils/trace\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\n\r\n/**\r\n * Options for trace operations.\r\n */\r\nexport interface TraceOptions {\r\n  /**\r\n   * Custom trace ID to use instead of auto-generating.\r\n   * If not provided, a new trace ID will be generated.\r\n   */\r\n  traceId?: string;\r\n\r\n  /**\r\n   * Optional operation name for logging purposes.\r\n   */\r\n  operationName?: string;\r\n\r\n  /**\r\n   * Optional metadata to attach to the trace context.\r\n   */\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Service for managing trace context across function calls.\r\n *\r\n * Provides automatic trace ID propagation through a call stack,\r\n * eliminating the need to manually pass trace IDs as parameters.\r\n *\r\n * Key features:\r\n * - Automatic trace ID generation\r\n * - Context stacking for nested traces\r\n * - Proper cleanup via try/finally\r\n * - Support for both sync and async operations\r\n *\r\n * Note: TraceContext has no dependencies to avoid circular dependency with Logger.\r\n * Logger can optionally use TraceContext.getCurrentTraceId() for automatic trace injection.\r\n *\r\n * @example\r\n * ```typescript\r\n * const traceContext = container.resolve(traceContextToken);\r\n *\r\n * // Sync operation\r\n * const result = traceContext.trace(() => {\r\n *   return performOperation();\r\n * });\r\n *\r\n * // Async operation\r\n * const result = await traceContext.traceAsync(async () => {\r\n *   return await fetchData();\r\n * });\r\n *\r\n * // Check current trace ID\r\n * const currentTraceId = traceContext.getCurrentTraceId();\r\n * ```\r\n */\r\nexport class TraceContext implements Disposable {\r\n  static dependencies = [] as const;\r\n\r\n  /**\r\n   * Current trace ID in the context stack.\r\n   * Null when not in a traced context.\r\n   */\r\n  private currentTraceId: string | null = null;\r\n\r\n  /**\r\n   * Executes a synchronous function with trace context.\r\n   *\r\n   * Automatically generates a trace ID if not provided.\r\n   * Maintains a context stack for nested traces.\r\n   * Ensures proper cleanup via try/finally.\r\n   *\r\n   * @template T - The return type of the function\r\n   * @param fn - Function to execute with trace context\r\n   * @param options - Trace options (trace ID, operation name, metadata)\r\n   * @returns The result of the function execution\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = traceContext.trace(() => {\r\n   *   logger.info(\"Processing\"); // Automatically traced\r\n   *   return processData();\r\n   * });\r\n   * ```\r\n   */\r\n  trace<T>(fn: () => T, options?: string | TraceOptions): T {\r\n    // Normalize options\r\n    const opts = typeof options === \"string\" ? { traceId: options } : options;\r\n    const traceId = opts?.traceId ?? generateTraceId();\r\n\r\n    // Save previous trace ID for context restoration\r\n    const previousTraceId = this.currentTraceId;\r\n\r\n    // Set new trace ID\r\n    this.currentTraceId = traceId;\r\n\r\n    try {\r\n      // Execute function in trace context\r\n      return fn();\r\n    } finally {\r\n      // Always restore previous trace ID (even on exception)\r\n      this.currentTraceId = previousTraceId;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes an asynchronous function with trace context.\r\n   *\r\n   * Similar to trace() but for async operations.\r\n   * Automatically generates a trace ID if not provided.\r\n   * Maintains a context stack for nested traces.\r\n   * Ensures proper cleanup via try/finally.\r\n   *\r\n   * @template T - The return type of the async function\r\n   * @param fn - Async function to execute with trace context\r\n   * @param options - Trace options (trace ID, operation name, metadata)\r\n   * @returns Promise resolving to the result of the function execution\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await traceContext.traceAsync(async () => {\r\n   *   logger.info(\"Fetching data\"); // Automatically traced\r\n   *   return await fetchData();\r\n   * });\r\n   * ```\r\n   */\r\n  async traceAsync<T>(fn: () => Promise<T>, options?: string | TraceOptions): Promise<T> {\r\n    // Normalize options\r\n    const opts = typeof options === \"string\" ? { traceId: options } : options;\r\n    const traceId = opts?.traceId ?? generateTraceId();\r\n\r\n    // Save previous trace ID for context restoration\r\n    const previousTraceId = this.currentTraceId;\r\n\r\n    // Set new trace ID\r\n    this.currentTraceId = traceId;\r\n\r\n    try {\r\n      // Execute async function in trace context\r\n      return await fn();\r\n    } finally {\r\n      // Always restore previous trace ID (even on exception)\r\n      this.currentTraceId = previousTraceId;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the current trace ID from the context stack.\r\n   *\r\n   * Returns null if not currently in a traced context.\r\n   * Useful for services that need to access the current trace ID\r\n   * without having it passed as a parameter.\r\n   *\r\n   * @returns Current trace ID or null if not in traced context\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const traceId = traceContext.getCurrentTraceId();\r\n   * if (traceId) {\r\n   *   console.log(`Current trace: ${traceId}`);\r\n   * }\r\n   * ```\r\n   */\r\n  getCurrentTraceId(): string | null {\r\n    return this.currentTraceId;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * For TraceContext, this resets the current trace ID.\r\n   */\r\n  dispose(): void {\r\n    this.currentTraceId = null;\r\n  }\r\n}\r\n\r\nexport class DITraceContext extends TraceContext {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { HealthStatus } from \"@/domain/types/health-status\";\r\nimport type { PlatformHealthCheckPort } from \"@/domain/ports/platform-health-check-port.interface\";\r\nimport { healthCheckRegistryToken } from \"@/application/tokens/health-check-registry.token\";\r\n\r\n/**\r\n * Service for monitoring module health and diagnostics.\r\n *\r\n * Uses Health-Check-Registry Pattern for extensible health monitoring.\r\n *\r\n * Responsibilities:\r\n * - Aggregate health checks from registry\r\n * - Determine overall health status\r\n * - Provide structured health status with details\r\n *\r\n * Extracted from CompositionRoot to follow Single Responsibility Principle.\r\n */\r\nexport class ModuleHealthService {\r\n  private healthChecksInitialized = false;\r\n\r\n  constructor(private readonly registry: PlatformHealthCheckPort) {}\r\n\r\n  /**\r\n   * Gets the current health status of the module.\r\n   *\r\n   * Health is determined by running all registered health checks.\r\n   * Overall status:\r\n   * - \"healthy\": All checks pass\r\n   * - \"unhealthy\": Container check fails\r\n   * - \"degraded\": Other checks fail\r\n   *\r\n   * @returns HealthStatus with overall status, individual checks, and timestamp\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const healthService = container.resolve(moduleHealthServiceToken);\r\n   * const health = healthService.getHealth();\r\n   *\r\n   * if (health.status !== 'healthy') {\r\n   *   console.warn('Module is not healthy:', health.checks);\r\n   * }\r\n   * ```\r\n   */\r\n  getHealth(): HealthStatus {\r\n    // Lazy initialization: Ensure health checks are registered on first call\r\n    // This is done lazily because health checks need to be resolved after container validation\r\n    if (!this.healthChecksInitialized) {\r\n      this.healthChecksInitialized = true;\r\n      // Note: Health checks will be registered when their factories execute\r\n      // This happens automatically when they are resolved for the first time\r\n    }\r\n\r\n    const results = this.registry.runAll();\r\n\r\n    // Determine overall status\r\n    const allHealthy = Array.from(results.values()).every((result) => result);\r\n\r\n    // Determine health status based on results\r\n    const status: \"healthy\" | \"degraded\" | \"unhealthy\" = allHealthy\r\n      ? \"healthy\"\r\n      : results.get(\"container\") === false\r\n        ? \"unhealthy\"\r\n        : \"degraded\";\r\n\r\n    // Collect details from unhealthy checks\r\n    const checks = this.registry.getAllChecks();\r\n    let lastError: string | null = null;\r\n\r\n    for (const check of checks) {\r\n      const result = results.get(check.name);\r\n      if (!result && check.getDetails) {\r\n        lastError = check.getDetails();\r\n      }\r\n    }\r\n\r\n    return {\r\n      status,\r\n      checks: {\r\n        containerValidated: results.get(\"container\") ?? true,\r\n        portsSelected: results.get(\"metrics\") ?? true,\r\n        lastError,\r\n      },\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n}\r\n\r\nexport class DIModuleHealthService extends ModuleHealthService {\r\n  static dependencies = [healthCheckRegistryToken] as const;\r\n\r\n  constructor(registry: PlatformHealthCheckPort) {\r\n    super(registry);\r\n  }\r\n}\r\n","/**\r\n * Injection token for the NotificationCenter.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { NotificationService } from \"@/application/services/notification-center.interface\";\r\n\r\n/**\r\n * Injection token for the NotificationCenter.\r\n *\r\n * Central message bus for all application notifications (debug, info, warn, error).\r\n * Routes notifications to registered channels (Console, UI, Sentry, etc.).\r\n *\r\n * @example\r\n * ```typescript\r\n * const notifications = container.resolve(notificationCenterToken);\r\n * notifications.debug(\"Processing data\");\r\n * notifications.error(\"Operation failed\", error);\r\n * ```\r\n */\r\nexport const notificationCenterToken =\r\n  createInjectionToken<NotificationService>(\"NotificationCenter\");\r\n","/**\r\n * Application Service Tokens for Dependency Injection.\r\n *\r\n * WICHTIG: Diese Datei importiert KEINE Service-Types mehr!\r\n * Token-Generics werden erst beim resolve() aufgelöst.\r\n * Dies verhindert zirkuläre Dependencies zwischen Tokens und Services.\r\n *\r\n * These tokens define injection points for Application layer services.\r\n */\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\n\r\n/**\r\n * Injection token for the JournalVisibilityService.\r\n *\r\n * Manages visibility of journal entries based on module flags.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const journalVisibilityServiceToken = createInjectionToken<any>(\"JournalVisibilityService\");\r\n\r\n/**\r\n * Injection token for the JournalVisibilityConfig.\r\n *\r\n * Configuration object for JournalVisibilityService.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const journalVisibilityConfigToken = createInjectionToken<any>(\"JournalVisibilityConfig\");\r\n\r\n/**\r\n * DI Token for HideJournalContextMenuHandler.\r\n *\r\n * Handler that adds \"Journal ausblenden\" menu item to journal context menus.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const hideJournalContextMenuHandlerToken = createInjectionToken<any>(\r\n  \"HideJournalContextMenuHandler\"\r\n);\r\n\r\n/**\r\n * DI Token for array of JournalContextMenuHandler instances.\r\n *\r\n * Allows multiple handlers to be registered and composed via DI.\r\n * Handlers are executed in the order they appear in the array.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const journalContextMenuHandlersToken = createInjectionToken<any>(\r\n  \"JournalContextMenuHandlers\"\r\n);\r\n\r\n/**\r\n * Injection token for the JournalDirectoryProcessor.\r\n *\r\n * Processes journal directory DOM to hide flagged entries.\r\n * Handles DOM manipulation and UI coordination.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const journalDirectoryProcessorToken = createInjectionToken<any>(\r\n  \"JournalDirectoryProcessor\"\r\n);\r\n\r\n/**\r\n * Injection token for the RuntimeConfigSync.\r\n *\r\n * Handles synchronization between Foundry Settings and RuntimeConfigService.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const runtimeConfigSyncToken = createInjectionToken<any>(\"RuntimeConfigSync\");\r\n\r\n/**\r\n * Injection token for the RuntimeConfigSettingsSync.\r\n *\r\n * Encapsulates RuntimeConfig synchronization for Settings registration.\r\n * Separated from ModuleSettingsRegistrar to follow Single Responsibility Principle.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const runtimeConfigSettingsSyncToken = createInjectionToken<any>(\r\n  \"RuntimeConfigSettingsSync\"\r\n);\r\n\r\n/**\r\n * Injection token for the SettingRegistrationErrorMapper.\r\n *\r\n * Maps DomainSettingsError to notification format.\r\n * Single Responsibility: Only handles error format conversion and notification.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const settingRegistrationErrorMapperToken = createInjectionToken<any>(\r\n  \"SettingRegistrationErrorMapper\"\r\n);\r\n\r\n/**\r\n * Injection token for the SettingDefinitionRegistry.\r\n *\r\n * Registry that provides setting definitions for registration.\r\n * Enables Open/Closed Principle: new settings can be added via registry extension\r\n * without modifying ModuleSettingsRegistrar.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const settingDefinitionRegistryToken = createInjectionToken<any>(\r\n  \"SettingDefinitionRegistry\"\r\n);\r\n\r\n/**\r\n * Injection token for the RuntimeConfigBindingRegistry.\r\n *\r\n * Registry that provides runtime config bindings for settings.\r\n * Enables Open/Closed Principle: new bindings can be added via registry extension\r\n * without modifying ModuleSettingsRegistrar.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const runtimeConfigBindingRegistryToken = createInjectionToken<any>(\r\n  \"RuntimeConfigBindingRegistry\"\r\n);\r\n\r\n/**\r\n * Injection token for the BatchUpdateContextService.\r\n *\r\n * Service for tracking journal IDs during batch update operations.\r\n * Allows use-cases to mark multiple journal IDs as part of a batch operation,\r\n * which can be checked by event handlers to optimize behavior (e.g., skip individual re-renders).\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const batchUpdateContextServiceToken = createInjectionToken<any>(\r\n  \"BatchUpdateContextService\"\r\n);\r\n","/**\r\n * Injection token for the I18nFacadeService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\n\r\n/**\r\n * Injection token for the I18nFacadeService.\r\n *\r\n * Combines Foundry's i18n and local translations with intelligent fallback.\r\n * This is the recommended token to use for all internationalization needs.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(i18nFacadeToken);\r\n * const text = i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\");\r\n * console.log(text);\r\n * ```\r\n */\r\nexport const i18nFacadeToken = createInjectionToken<I18nFacadeService>(\"I18nFacadeService\");\r\n","/**\r\n * Injection token for FoundryGame port.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryGamePort } from \"@/infrastructure/adapters/foundry/services/FoundryGamePort\";\r\n\r\n/**\r\n * Injection token for FoundryGame port.\r\n *\r\n * Provides access to Foundry's game API, specifically journal entries.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const game = container.resolve(foundryGameToken);\r\n * const entries = game.getJournalEntries();\r\n * if (entries.ok) {\r\n *   console.log(`Found ${entries.value.length} journal entries`);\r\n * }\r\n * ```\r\n */\r\nexport const foundryGameToken = createInjectionToken<FoundryGamePort>(\"FoundryGame\");\r\n","/**\r\n * Injection token for FoundryHooks port.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\n\r\n/**\r\n * Injection token for FoundryHooks port.\r\n *\r\n * Provides access to Foundry's hook system for event registration.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const hooks = container.resolve(foundryHooksToken);\r\n * hooks.on(\"renderJournalDirectory\", (app, html) => {\r\n *   console.log(\"Journal directory rendered\");\r\n * });\r\n * ```\r\n */\r\nexport const foundryHooksToken = createInjectionToken<FoundryHooksPort>(\"FoundryHooks\");\r\n","/**\r\n * Injection token for FoundryDocument port.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryDocumentPort } from \"@/infrastructure/adapters/foundry/services/FoundryDocumentPort\";\r\n\r\n/**\r\n * Injection token for FoundryDocument port.\r\n *\r\n * Provides access to Foundry's document API for flag management.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const doc = container.resolve(foundryDocumentToken);\r\n * const flag = doc.getFlag(journal, \"my-module\", \"my-flag\");\r\n * if (flag.ok) {\r\n *   console.log(\"Flag value:\", flag.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundryDocumentToken = createInjectionToken<FoundryDocumentPort>(\"FoundryDocument\");\r\n","/**\r\n * Injection token for FoundrySettings port.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundrySettingsPort } from \"@/infrastructure/adapters/foundry/services/FoundrySettingsPort\";\r\n\r\n/**\r\n * Injection token for FoundrySettings port.\r\n *\r\n * Provides access to Foundry's settings system for module configuration.\r\n * Automatically selects version-appropriate port implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const settings = container.resolve(foundrySettingsToken);\r\n * const logLevel = settings.get(\"my-module\", \"logLevel\");\r\n * if (logLevel.ok) {\r\n *   console.log(\"Current log level:\", logLevel.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundrySettingsToken = createInjectionToken<FoundrySettingsPort>(\"FoundrySettings\");\r\n","/**\r\n * Injection token for FoundryJournalFacade.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryJournalFacade } from \"@/infrastructure/adapters/foundry/facades/foundry-journal-facade.interface\";\r\n\r\n/**\r\n * Injection token for FoundryJournalFacade.\r\n *\r\n * Facade that combines FoundryGame, FoundryDocument, and FoundryUI\r\n * for journal-specific operations.\r\n *\r\n * **Benefits:**\r\n * - Reduces dependency count from 3 services to 1 facade\r\n * - Provides cohesive journal-specific API\r\n * - Easier to test and mock\r\n *\r\n * @example\r\n * ```typescript\r\n * const facade = container.resolve(foundryJournalFacadeToken);\r\n * const entries = facade.getJournalEntries();\r\n * if (entries.ok) {\r\n *   // Process entries\r\n * }\r\n * ```\r\n */\r\nexport const foundryJournalFacadeToken =\r\n  createInjectionToken<FoundryJournalFacade>(\"FoundryJournalFacade\");\r\n","import { markAsApiSafe } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport { notificationCenterToken } from \"@/application/tokens/notifications/notification-center.token\";\r\nimport {\r\n  journalVisibilityServiceToken,\r\n  journalDirectoryProcessorToken,\r\n} from \"@/application/tokens/application.tokens\";\r\nimport { i18nFacadeToken } from \"@/infrastructure/shared/tokens/i18n/i18n-facade.token\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport { foundryDocumentToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document.token\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui.token\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport { foundryJournalFacadeToken } from \"@/infrastructure/shared/tokens/foundry/foundry-journal-facade.token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\n\r\n/**\r\n * Creates the well-known API tokens collection.\r\n *\r\n * All internal tokens are marked as API-safe for external consumption.\r\n * This factory is called during API initialization phase.\r\n *\r\n * @returns Type-safe token collection for external modules\r\n */\r\nexport function createApiTokens(): ModuleApiTokens {\r\n  return {\r\n    notificationCenterToken: markAsApiSafe(notificationCenterToken),\r\n    journalVisibilityServiceToken: markAsApiSafe(journalVisibilityServiceToken),\r\n    journalDirectoryProcessorToken: markAsApiSafe(journalDirectoryProcessorToken),\r\n    foundryGameToken: markAsApiSafe(foundryGameToken),\r\n    foundryHooksToken: markAsApiSafe(foundryHooksToken),\r\n    foundryDocumentToken: markAsApiSafe(foundryDocumentToken),\r\n    foundryUIToken: markAsApiSafe(foundryUIToken),\r\n    foundrySettingsToken: markAsApiSafe(foundrySettingsToken),\r\n    i18nFacadeToken: markAsApiSafe(i18nFacadeToken),\r\n    foundryJournalFacadeToken: markAsApiSafe(foundryJournalFacadeToken),\r\n  };\r\n}\r\n","import { PUBLIC_API_VERSION } from \"@/application/constants/app-constants\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { InjectionToken } from \"@/application/di/injection-token\";\r\nimport type { ModuleApi, TokenInfo, ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { IModuleApiBuilder } from \"../interfaces/api-component-interfaces\";\r\nimport { createApiTokens } from \"../api-token-config\";\r\nimport { getRegistrationStatus } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport { journalVisibilityServiceToken } from \"@/application/tokens/application.tokens\";\r\nimport { journalDirectoryProcessorToken } from \"@/application/tokens/application.tokens\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport { foundryDocumentToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document.token\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui.token\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport { i18nFacadeToken } from \"@/infrastructure/shared/tokens/i18n/i18n-facade.token\";\r\nimport { foundryJournalFacadeToken } from \"@/infrastructure/shared/tokens/foundry/foundry-journal-facade.token\";\r\nimport { notificationCenterToken } from \"@/application/tokens/notifications/notification-center.token\";\r\nimport type { IApiServiceResolver } from \"../interfaces/api-component-interfaces\";\r\nimport type { IApiHealthMetricsProvider } from \"../interfaces/api-component-interfaces\";\r\n\r\n/**\r\n * ModuleApiBuilder\r\n *\r\n * Responsible for creating API objects and token collections.\r\n * Separated from ModuleApiInitializer for Single Responsibility Principle.\r\n */\r\nexport class ModuleApiBuilder implements IModuleApiBuilder {\r\n  constructor(\r\n    private readonly serviceResolver: IApiServiceResolver,\r\n    private readonly healthMetricsProvider: IApiHealthMetricsProvider\r\n  ) {}\r\n\r\n  /**\r\n   * Creates the well-known API tokens collection.\r\n   *\r\n   * @returns Type-safe token collection for external modules\r\n   */\r\n  createApiTokens(): ModuleApiTokens {\r\n    return createApiTokens();\r\n  }\r\n\r\n  /**\r\n   * Creates the complete ModuleApi object with all methods.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Complete ModuleApi object\r\n   */\r\n  createApi(container: PlatformContainerPort, wellKnownTokens: ModuleApiTokens): ModuleApi {\r\n    return {\r\n      version: PUBLIC_API_VERSION,\r\n\r\n      // Overloaded resolve method (throws on error)\r\n      resolve: this.serviceResolver.createResolveFunction(container, wellKnownTokens),\r\n\r\n      // Result-Pattern method (safe, never throws)\r\n      resolveWithError: this.serviceResolver.createResolveWithErrorFunction(\r\n        container,\r\n        wellKnownTokens\r\n      ),\r\n\r\n      getAvailableTokens: (): Map<symbol, TokenInfo> => {\r\n        const tokenMap = new Map<symbol, TokenInfo>();\r\n\r\n        // Add well-known tokens with their registration status\r\n        const tokenEntries: Array<[string, InjectionToken<unknown>]> = [\r\n          [\"journalVisibilityServiceToken\", journalVisibilityServiceToken],\r\n          [\"journalDirectoryProcessorToken\", journalDirectoryProcessorToken],\r\n          [\"foundryGameToken\", foundryGameToken],\r\n          [\"foundryHooksToken\", foundryHooksToken],\r\n          [\"foundryDocumentToken\", foundryDocumentToken],\r\n          [\"foundryUIToken\", foundryUIToken],\r\n          [\"foundrySettingsToken\", foundrySettingsToken],\r\n          [\"i18nFacadeToken\", i18nFacadeToken],\r\n          [\"foundryJournalFacadeToken\", foundryJournalFacadeToken],\r\n          [\"notificationCenterToken\", notificationCenterToken],\r\n        ];\r\n\r\n        for (const [, token] of tokenEntries) {\r\n          const isRegisteredResult = container.isRegistered(token);\r\n          tokenMap.set(token, {\r\n            description: String(token).replace(\"Symbol(\", \"\").replace(\")\", \"\"),\r\n            isRegistered: getRegistrationStatus(isRegisteredResult),\r\n          });\r\n        }\r\n\r\n        return tokenMap;\r\n      },\r\n\r\n      tokens: wellKnownTokens,\r\n\r\n      getMetrics: () => this.healthMetricsProvider.getMetrics(container),\r\n\r\n      getHealth: () => this.healthMetricsProvider.getHealth(container),\r\n    };\r\n  }\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ApiWrapperStrategy } from \"./api-wrapper-strategy.interface\";\r\n\r\n/**\r\n * ApiWrapperStrategyRegistry\r\n *\r\n * Manages registered wrapper strategies and their priorities.\r\n * Provides a centralized way to find and apply the appropriate strategy\r\n * for wrapping sensitive services.\r\n */\r\nexport class ApiWrapperStrategyRegistry {\r\n  private readonly strategies: ApiWrapperStrategy[] = [];\r\n\r\n  /**\r\n   * Registers a wrapper strategy.\r\n   *\r\n   * @param strategy - Strategy to register\r\n   */\r\n  register(strategy: ApiWrapperStrategy): void {\r\n    this.strategies.push(strategy);\r\n  }\r\n\r\n  /**\r\n   * Registers multiple wrapper strategies.\r\n   *\r\n   * @param strategies - Array of strategies to register\r\n   */\r\n  registerAll(strategies: ApiWrapperStrategy[]): void {\r\n    for (const strategy of strategies) {\r\n      this.register(strategy);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets all registered strategies, sorted by priority (lower = higher priority).\r\n   *\r\n   * @returns Array of strategies in priority order\r\n   */\r\n  getAll(): ApiWrapperStrategy[] {\r\n    return [...this.strategies].sort((a, b) => {\r\n      const priorityA = a.getPriority?.() ?? 100;\r\n      const priorityB = b.getPriority?.() ?? 100;\r\n      return priorityA - priorityB;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Finds the first strategy that supports the given token.\r\n   *\r\n   * @param token - API token to find strategy for\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Strategy that supports the token, or null if none found\r\n   */\r\n  findStrategy<TServiceType>(\r\n    token: ApiSafeToken<TServiceType>,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): ApiWrapperStrategy<TServiceType> | null {\r\n    const sortedStrategies = this.getAll();\r\n\r\n    for (const strategy of sortedStrategies) {\r\n      if (strategy.supports(token, wellKnownTokens)) {\r\n        // Type narrowing: strategy.supports() guarantees compatibility with TServiceType,\r\n        // but TypeScript cannot infer the generic type from runtime checks.\r\n        /* type-coverage:ignore-next-line -- Generic type narrowing: supports() guarantees TServiceType compatibility */\r\n        return strategy as ApiWrapperStrategy<TServiceType>;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Clears all registered strategies.\r\n   * Useful for testing or reset scenarios.\r\n   */\r\n  clear(): void {\r\n    this.strategies.length = 0;\r\n  }\r\n}\r\n","/**\r\n * Checks if a property key is in the allowed methods list.\r\n *\r\n * @param prop - The property key to check\r\n * @param allowed - Array of allowed method keys\r\n * @returns True if prop is a string and in the allowed list\r\n */\r\nfunction isAllowedKey(prop: string | symbol, allowed: readonly string[]): boolean {\r\n  if (typeof prop !== \"string\") {\r\n    return false;\r\n  }\r\n  return allowed.includes(prop);\r\n}\r\n\r\n/**\r\n * Creates a read-only proxy wrapper for a service.\r\n *\r\n * Only allows access to whitelisted methods. Property access and\r\n * modifications are blocked to prevent external modules from\r\n * changing internal state.\r\n *\r\n * @param service - The service instance to wrap\r\n * @param allowedMethods - Array of method names that are allowed to be called\r\n * @returns Proxied service that only allows whitelisted methods\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicLogger = createReadOnlyWrapper(logger, [\r\n *   \"debug\", \"info\", \"warn\", \"error\"\r\n * ]);\r\n *\r\n * publicLogger.info(\"Hello\");  // ✅ OK\r\n * publicLogger.setMinLevel(0); // ❌ Error: \"setMinLevel is not accessible\"\r\n * publicLogger.minLevel = 0;   // ❌ Error: \"Cannot modify service\"\r\n * ```\r\n */\r\nexport function createReadOnlyWrapper<T extends object>(\r\n  service: T,\r\n  allowedMethods: readonly string[]\r\n): T {\r\n  return new Proxy(service, {\r\n    get(target, prop, receiver: unknown) {\r\n      // Allow whitelisted methods only\r\n      if (isAllowedKey(prop, allowedMethods)) {\r\n        const value: unknown = Reflect.get(target, prop, receiver);\r\n\r\n        // Bind 'this' context for methods\r\n        if (typeof value === \"function\") {\r\n          return value.bind(target);\r\n        }\r\n\r\n        return value;\r\n      }\r\n\r\n      // Block non-whitelisted property access\r\n      throw new Error(\r\n        `Property \"${String(prop)}\" is not accessible via Public API. ` +\r\n          `Only these methods are allowed: ${allowedMethods.map(String).join(\", \")}`\r\n      );\r\n    },\r\n\r\n    set() {\r\n      // Block all property modifications\r\n      throw new Error(\"Cannot modify services via Public API (read-only)\");\r\n    },\r\n\r\n    deleteProperty() {\r\n      // Block property deletion\r\n      throw new Error(\"Cannot delete properties via Public API (read-only)\");\r\n    },\r\n  });\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { NotificationService } from \"@/application/services/notification-center.interface\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport { createReadOnlyWrapper } from \"./readonly-wrapper\";\r\n\r\n/**\r\n * Creates a read-only wrapper for Logger service.\r\n *\r\n * Only allows logging methods, blocks configuration methods like setMinLevel().\r\n * This prevents external modules from changing the global logger configuration.\r\n *\r\n * @param logger - Logger service instance\r\n * @returns Read-only logger proxy\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicLogger = createPublicLogger(logger);\r\n * publicLogger.info(\"Hello\");  // ✅ OK\r\n * publicLogger.setMinLevel(0); // ❌ Error\r\n * ```\r\n */\r\nexport function createPublicLogger(logger: Logger): Logger {\r\n  return createReadOnlyWrapper(logger, [\r\n    \"log\",\r\n    \"debug\",\r\n    \"info\",\r\n    \"warn\",\r\n    \"error\",\r\n    \"withTraceId\", // Decorator pattern for trace context\r\n  ]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for I18nFacadeService.\r\n *\r\n * Only allows read operations (translate, format, has).\r\n * Prevents modification of internal translation state.\r\n *\r\n * @param i18n - I18nFacadeService instance\r\n * @returns Read-only i18n proxy\r\n *\r\n * @example\r\n * ```typescript\r\n * const publicI18n = createPublicI18n(i18n);\r\n * publicI18n.translate(\"key\"); // ✅ OK\r\n * publicI18n.internalState = {}; // ❌ Error\r\n * ```\r\n */\r\nexport function createPublicI18n(i18n: I18nFacadeService): I18nFacadeService {\r\n  return createReadOnlyWrapper(i18n, [\"translate\", \"format\", \"has\"]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for NotificationCenter.\r\n *\r\n * Allows routing notifications while preventing external modules from\r\n * mutating registered channels.\r\n *\r\n * @param notificationCenter - NotificationCenter instance\r\n * @returns Read-only notification proxy\r\n */\r\nexport function createPublicNotificationCenter(\r\n  notificationCenter: NotificationService\r\n): NotificationService {\r\n  return createReadOnlyWrapper(notificationCenter, [\r\n    \"debug\",\r\n    \"info\",\r\n    \"warn\",\r\n    \"error\",\r\n    \"getChannelNames\",\r\n  ]);\r\n}\r\n\r\n/**\r\n * Creates a read-only wrapper for FoundrySettings service.\r\n *\r\n * Allows validated reads of settings while blocking registration and mutation\r\n * operations that could impact module configuration.\r\n *\r\n * @param foundrySettings - FoundrySettings service instance\r\n * @returns Read-only settings proxy\r\n */\r\nexport function createPublicFoundrySettings(foundrySettings: FoundrySettings): FoundrySettings {\r\n  return createReadOnlyWrapper(foundrySettings, [\"get\"]);\r\n}\r\n","/**\r\n * Cast utilities für API und Module-Initialization.\r\n *\r\n * Separate Datei für API-spezifische Wrapper-Funktionen.\r\n * Diese Funktionen sind nur für den Module-API-Kontext gedacht.\r\n *\r\n * Diese Datei enthält KEINE Type-Imports - alle Parameter verwenden 'any'\r\n * um zirkuläre Dependencies zu vermeiden!\r\n *\r\n * @ts-expect-error - Type coverage exclusion\r\n */\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\n\r\n/**\r\n * Wrapper für I18nFacadeService im Module-API-Kontext.\r\n * Kapselt die notwendige Umwandlung von unknown → I18nFacadeService\r\n * und wieder zurück zu generischem T.\r\n */\r\nexport function wrapI18nService<T>(service: T, create: (i18n: any) => any): T {\r\n  return create(service as any) as T;\r\n}\r\n\r\n/**\r\n * Wrapper für NotificationCenter.\r\n * Entspricht wrapI18nService, aber für NotificationCenter.\r\n */\r\nexport function wrapNotificationCenterService<T>(service: T, create: (center: any) => any): T {\r\n  return create(service as any) as T;\r\n}\r\n\r\n/**\r\n * Wrapper für FoundrySettings.\r\n * Entspricht wrapI18nService, aber für FoundrySettings.\r\n */\r\nexport function wrapFoundrySettingsPort<T>(service: T, create: (settings: any) => any): T {\r\n  return create(service as any) as T;\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ApiWrapperStrategy } from \"./api-wrapper-strategy.interface\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport { createPublicI18n } from \"../../public-api-wrappers\";\r\nimport { wrapI18nService } from \"@/infrastructure/di/types/utilities/api-casts\";\r\n\r\n/**\r\n * I18nWrapperStrategy\r\n *\r\n * Strategy for wrapping I18nFacadeService with read-only wrapper.\r\n * Only allows translate, format, and has methods.\r\n */\r\nexport class I18nWrapperStrategy implements ApiWrapperStrategy<I18nFacadeService> {\r\n  supports(token: ApiSafeToken<I18nFacadeService>, wellKnownTokens: ModuleApiTokens): boolean {\r\n    return token === wellKnownTokens.i18nFacadeToken;\r\n  }\r\n\r\n  wrap(\r\n    service: I18nFacadeService,\r\n    _token: ApiSafeToken<I18nFacadeService>,\r\n    _wellKnownTokens: ModuleApiTokens\r\n  ): I18nFacadeService {\r\n    return wrapI18nService(service, createPublicI18n);\r\n  }\r\n\r\n  getPriority(): number {\r\n    return 10; // High priority for specific token match\r\n  }\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ApiWrapperStrategy } from \"./api-wrapper-strategy.interface\";\r\nimport type { NotificationService } from \"@/application/services/notification-center.interface\";\r\nimport { createPublicNotificationCenter } from \"../../public-api-wrappers\";\r\nimport { wrapNotificationCenterService } from \"@/infrastructure/di/types/utilities/api-casts\";\r\n\r\n/**\r\n * NotificationWrapperStrategy\r\n *\r\n * Strategy for wrapping NotificationCenter with read-only wrapper.\r\n * Only allows debug, info, warn, error, and getChannelNames methods.\r\n */\r\nexport class NotificationWrapperStrategy implements ApiWrapperStrategy<NotificationService> {\r\n  supports(token: ApiSafeToken<NotificationService>, wellKnownTokens: ModuleApiTokens): boolean {\r\n    return token === wellKnownTokens.notificationCenterToken;\r\n  }\r\n\r\n  wrap(\r\n    service: NotificationService,\r\n    _token: ApiSafeToken<NotificationService>,\r\n    _wellKnownTokens: ModuleApiTokens\r\n  ): NotificationService {\r\n    return wrapNotificationCenterService(service, createPublicNotificationCenter);\r\n  }\r\n\r\n  getPriority(): number {\r\n    return 10; // High priority for specific token match\r\n  }\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ApiWrapperStrategy } from \"./api-wrapper-strategy.interface\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport { createPublicFoundrySettings } from \"../../public-api-wrappers\";\r\nimport { wrapFoundrySettingsPort } from \"@/infrastructure/di/types/utilities/api-casts\";\r\n\r\n/**\r\n * SettingsWrapperStrategy\r\n *\r\n * Strategy for wrapping FoundrySettings with read-only wrapper.\r\n * Only allows get method, blocks register and set operations.\r\n */\r\nexport class SettingsWrapperStrategy implements ApiWrapperStrategy<FoundrySettings> {\r\n  supports(token: ApiSafeToken<FoundrySettings>, wellKnownTokens: ModuleApiTokens): boolean {\r\n    return token === wellKnownTokens.foundrySettingsToken;\r\n  }\r\n\r\n  wrap(\r\n    service: FoundrySettings,\r\n    _token: ApiSafeToken<FoundrySettings>,\r\n    _wellKnownTokens: ModuleApiTokens\r\n  ): FoundrySettings {\r\n    return wrapFoundrySettingsPort(service, createPublicFoundrySettings);\r\n  }\r\n\r\n  getPriority(): number {\r\n    return 10; // High priority for specific token match\r\n  }\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ApiWrapperStrategy } from \"./api-wrapper-strategy.interface\";\r\n\r\n/**\r\n * NoopWrapperStrategy\r\n *\r\n * Fallback strategy that returns the service unchanged.\r\n * Used for services that don't require wrapping.\r\n * This strategy should have the lowest priority to only match when no other strategy applies.\r\n */\r\nexport class NoopWrapperStrategy implements ApiWrapperStrategy {\r\n  supports<TServiceType>(\r\n    _token: ApiSafeToken<TServiceType>,\r\n    _wellKnownTokens: ModuleApiTokens\r\n  ): boolean {\r\n    return true; // Always matches (fallback)\r\n  }\r\n\r\n  wrap<TServiceType>(\r\n    service: TServiceType,\r\n    _token: ApiSafeToken<TServiceType>,\r\n    _wellKnownTokens: ModuleApiTokens\r\n  ): TServiceType {\r\n    return service; // Return unchanged\r\n  }\r\n\r\n  getPriority(): number {\r\n    return 1000; // Lowest priority - only used as fallback\r\n  }\r\n}\r\n","import type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { IServiceWrapperFactory } from \"../interfaces/api-component-interfaces\";\r\nimport { ApiWrapperStrategyRegistry } from \"./strategies/api-wrapper-strategy-registry\";\r\nimport { I18nWrapperStrategy } from \"./strategies/i18n-wrapper-strategy\";\r\nimport { NotificationWrapperStrategy } from \"./strategies/notification-wrapper-strategy\";\r\nimport { SettingsWrapperStrategy } from \"./strategies/settings-wrapper-strategy\";\r\nimport { NoopWrapperStrategy } from \"./strategies/noop-wrapper-strategy\";\r\n\r\n/**\r\n * ServiceWrapperFactory\r\n *\r\n * Responsible for wrapping sensitive services with read-only wrappers.\r\n * Separated from ModuleApiInitializer for Single Responsibility Principle.\r\n *\r\n * Uses Strategy Pattern to follow Open/Closed Principle:\r\n * - New services can be wrapped by adding new strategies\r\n * - No modifications needed to this class or ModuleApiInitializer\r\n */\r\nexport class ServiceWrapperFactory implements IServiceWrapperFactory {\r\n  private readonly strategyRegistry: ApiWrapperStrategyRegistry;\r\n\r\n  constructor(strategyRegistry?: ApiWrapperStrategyRegistry) {\r\n    this.strategyRegistry = strategyRegistry ?? this.createDefaultRegistry();\r\n  }\r\n\r\n  /**\r\n   * Creates the default strategy registry with standard wrapper strategies.\r\n   *\r\n   * @returns Registry with I18n, Notification, Settings, and Noop strategies\r\n   */\r\n  private createDefaultRegistry(): ApiWrapperStrategyRegistry {\r\n    const registry = new ApiWrapperStrategyRegistry();\r\n    registry.registerAll([\r\n      new I18nWrapperStrategy(),\r\n      new NotificationWrapperStrategy(),\r\n      new SettingsWrapperStrategy(),\r\n      new NoopWrapperStrategy(), // Fallback strategy\r\n    ]);\r\n    return registry;\r\n  }\r\n\r\n  /**\r\n   * Applies read-only wrappers when API consumers resolve sensitive services.\r\n   *\r\n   * Delegates to registered strategies following Open/Closed Principle.\r\n   * No token-specific if/else chains - all logic is in strategies.\r\n   *\r\n   * @param token - API token used for resolution\r\n   * @param service - Service resolved from the container\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Wrapped service when applicable\r\n   */\r\n  wrapSensitiveService<TServiceType>(\r\n    token: ApiSafeToken<TServiceType>,\r\n    service: TServiceType,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): TServiceType {\r\n    const strategy = this.strategyRegistry.findStrategy(token, wellKnownTokens);\r\n\r\n    if (strategy) {\r\n      return strategy.wrap(service, token, wellKnownTokens);\r\n    }\r\n\r\n    // Fallback: return service unchanged if no strategy found\r\n    // (should not happen if NoopWrapperStrategy is registered)\r\n    return service;\r\n  }\r\n}\r\n","/**\r\n * Formats deprecation replacement information for console warnings.\r\n *\r\n * @param replacement - The replacement token name, or null if no replacement is available\r\n * @returns Formatted replacement message, or empty string if no replacement\r\n */\r\nexport function formatReplacementInfo(replacement: string | null): string {\r\n  return replacement ? `Use \"${replacement}\" instead.\\n` : \"\";\r\n}\r\n","import type { InjectionToken } from \"../core/injectiontoken\";\r\nimport type { ApiSafeToken } from \"./api-safe-token\";\r\nimport { markAsApiSafe } from \"./api-safe-token\";\r\n\r\n/**\r\n * Deprecation metadata attached to deprecated tokens.\r\n * Stores information about why the token is deprecated and what to use instead.\r\n */\r\nexport interface DeprecationInfo {\r\n  /** Reason why the token is deprecated */\r\n  reason: string;\r\n  /** Replacement token description (if available) */\r\n  replacement: string | null;\r\n  /** Version in which the token will be removed */\r\n  removedInVersion: string;\r\n  /** Whether the deprecation warning has been shown (prevents spam) */\r\n  warningShown: boolean;\r\n}\r\n\r\n/**\r\n * Map to store deprecation metadata for tokens.\r\n * Symbols are used as keys directly (Map supports symbol keys natively).\r\n *\r\n * Memory: Tokens are singletons (defined once in tokenindex.ts), so no memory leak risk.\r\n * Using Map instead of WeakMap for 100% type-coverage (no any-casts needed).\r\n */\r\nconst deprecationMetadata = new Map<symbol, DeprecationInfo>();\r\n\r\n/**\r\n * Marks an injection token as deprecated with metadata.\r\n *\r\n * The token remains functional but will emit a console warning when resolved.\r\n * This allows for graceful migration periods before breaking changes.\r\n *\r\n * @param token - The injection token to deprecate\r\n * @param reason - Human-readable reason for deprecation\r\n * @param replacement - Optional replacement token (for migration guidance)\r\n * @param removedInVersion - Version in which the token will be removed\r\n * @returns API-safe token with deprecation metadata attached\r\n *\r\n * @example\r\n * ```typescript\r\n * // Deprecate oldLoggerToken in favor of loggerToken\r\n * const wellKnownTokens = {\r\n *   oldLoggerToken: markAsDeprecated(\r\n *     oldLoggerInternalToken,\r\n *     \"Use enhanced logger v2 with better performance\",\r\n *     loggerToken,\r\n *     \"2.0.0\"\r\n *   ),\r\n *   loggerToken: markAsApiSafe(loggerToken)\r\n * };\r\n *\r\n * // User code will see:\r\n * // ⚠️ DEPRECATED: Token \"oldLoggerToken\" is deprecated.\r\n * // Reason: Use enhanced logger v2 with better performance\r\n * // Use \"Symbol(Logger)\" instead.\r\n * // This token will be removed in version 2.0.0.\r\n * ```\r\n */\r\nexport function markAsDeprecated<T>(\r\n  token: InjectionToken<T>,\r\n  reason: string,\r\n  replacement: InjectionToken<T> | null,\r\n  removedInVersion: string\r\n): ApiSafeToken<T> {\r\n  const apiSafeToken = markAsApiSafe(token);\r\n\r\n  // Store deprecation metadata in Map (symbols are valid keys)\r\n  deprecationMetadata.set(apiSafeToken, {\r\n    reason,\r\n    replacement: replacement ? String(replacement) : null,\r\n    removedInVersion,\r\n    warningShown: false,\r\n  });\r\n\r\n  return apiSafeToken;\r\n}\r\n\r\n/**\r\n * Checks if a token has deprecation metadata attached.\r\n *\r\n * @param token - Token to check\r\n * @returns Deprecation info if token is deprecated, null otherwise\r\n * @internal\r\n */\r\nexport function getDeprecationInfo(token: unknown): DeprecationInfo | null {\r\n  if (!token || typeof token !== \"symbol\") {\r\n    return null;\r\n  }\r\n  return deprecationMetadata.get(token) || null;\r\n}\r\n","import { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport { formatReplacementInfo } from \"@/infrastructure/shared/utils/format-deprecation-info\";\r\nimport type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport { getDeprecationInfo } from \"@/infrastructure/di/types/utilities/deprecated-token\";\r\nimport type { DeprecationInfo } from \"@/framework/core/api/module-api\";\r\nimport type { IDeprecationHandler } from \"../interfaces/api-component-interfaces\";\r\n\r\n/**\r\n * DeprecationHandler\r\n *\r\n * Responsible for handling deprecation warnings for tokens.\r\n * Separated from ModuleApiInitializer for Single Responsibility Principle.\r\n */\r\nexport class DeprecationHandler implements IDeprecationHandler {\r\n  /**\r\n   * Checks if a token is deprecated.\r\n   *\r\n   * @param token - Token to check\r\n   * @returns DeprecationInfo if deprecated, null otherwise\r\n   */\r\n  checkDeprecation<TServiceType>(token: ApiSafeToken<TServiceType>): DeprecationInfo | null {\r\n    return getDeprecationInfo(token) ?? null;\r\n  }\r\n\r\n  /**\r\n   * Handles deprecation warnings for tokens.\r\n   * Logs warning to console if token is deprecated and warning hasn't been shown yet.\r\n   *\r\n   * Uses console.warn instead of Logger because:\r\n   * - Deprecation warnings are for external API consumers (not internal logs)\r\n   * - Should be visible even if Logger is disabled/configured differently\r\n   * - Follows npm/Node.js convention for deprecation warnings\r\n   *\r\n   * @param token - Token to check for deprecation\r\n   */\r\n  handleDeprecationWarning<TServiceType>(token: ApiSafeToken<TServiceType>): void {\r\n    const deprecationInfo = getDeprecationInfo(token);\r\n    if (deprecationInfo && !deprecationInfo.warningShown) {\r\n      const replacementInfo = formatReplacementInfo(deprecationInfo.replacement);\r\n      console.warn(\r\n        `[${MODULE_METADATA.ID}] DEPRECATED: Token \"${String(token)}\" is deprecated.\\n` +\r\n          `Reason: ${deprecationInfo.reason}\\n` +\r\n          replacementInfo +\r\n          `This token will be removed in version ${deprecationInfo.removedInVersion}.`\r\n      );\r\n      deprecationInfo.warningShown = true; // Only warn once per session\r\n    }\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { ApiSafeToken } from \"@/infrastructure/di/types/utilities/api-safe-token\";\r\nimport type { ModuleApiTokens } from \"@/framework/core/api/module-api\";\r\nimport type { ContainerError } from \"@/infrastructure/di/interfaces\";\r\nimport type { IApiServiceResolver } from \"../interfaces/api-component-interfaces\";\r\nimport type { IDeprecationHandler } from \"../interfaces/api-component-interfaces\";\r\nimport type { IServiceWrapperFactory } from \"../interfaces/api-component-interfaces\";\r\nimport {\r\n  castResolvedService,\r\n  castContainerErrorCode,\r\n} from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\n\r\n/**\r\n * ApiServiceResolver\r\n *\r\n * Responsible for creating resolve functions for the public API.\r\n * Separated from ModuleApiInitializer for Single Responsibility Principle.\r\n */\r\nexport class ApiServiceResolver implements IApiServiceResolver {\r\n  constructor(\r\n    private readonly deprecationHandler: IDeprecationHandler,\r\n    private readonly serviceWrapperFactory: IServiceWrapperFactory\r\n  ) {}\r\n\r\n  /**\r\n   * Creates the resolve() function for the public API.\r\n   * Resolves services and applies wrappers (throws on error).\r\n   *\r\n   * @param container - PlatformContainerPort for resolution\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns Resolve function for ModuleApi\r\n   */\r\n  createResolveFunction(\r\n    container: PlatformContainerPort,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): <TServiceType>(token: ApiSafeToken<TServiceType>) => TServiceType {\r\n    return <TServiceType>(token: ApiSafeToken<TServiceType>): TServiceType => {\r\n      // Handle deprecation warnings\r\n      this.deprecationHandler.handleDeprecationWarning(token);\r\n\r\n      // Resolve service from container\r\n      const service: TServiceType = container.resolve(token);\r\n\r\n      return this.serviceWrapperFactory.wrapSensitiveService(token, service, wellKnownTokens);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Creates the resolveWithError() function for the public API.\r\n   * Resolves services with Result pattern (never throws).\r\n   *\r\n   * @param container - PlatformContainerPort for resolution\r\n   * @param wellKnownTokens - Collection of API-safe tokens\r\n   * @returns ResolveWithError function for ModuleApi\r\n   */\r\n  createResolveWithErrorFunction(\r\n    container: PlatformContainerPort,\r\n    wellKnownTokens: ModuleApiTokens\r\n  ): <TServiceType>(token: ApiSafeToken<TServiceType>) => Result<TServiceType, ContainerError> {\r\n    return <TServiceType>(\r\n      token: ApiSafeToken<TServiceType>\r\n    ): Result<TServiceType, ContainerError> => {\r\n      // Handle deprecation warnings\r\n      this.deprecationHandler.handleDeprecationWarning(token);\r\n\r\n      // Resolve with Result-Pattern (never throws)\r\n      const result = container.resolveWithError(token);\r\n\r\n      // Apply wrappers if resolution succeeded\r\n      if (!result.ok) {\r\n        // Convert DomainContainerError to ContainerError\r\n        const containerError: ContainerError = {\r\n          code: castContainerErrorCode(result.error.code),\r\n          message: result.error.message,\r\n          cause: result.error.cause,\r\n          tokenDescription: result.error.message,\r\n        };\r\n        return err(containerError);\r\n      }\r\n\r\n      const service = castResolvedService<TServiceType>(result.value);\r\n\r\n      const wrappedService = this.serviceWrapperFactory.wrapSensitiveService(\r\n        token,\r\n        service,\r\n        wellKnownTokens\r\n      );\r\n      return ok(wrappedService);\r\n    };\r\n  }\r\n}\r\n","import type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { HealthStatus } from \"@/domain/types/health-status\";\r\nimport type { MetricsSnapshot } from \"@/infrastructure/observability/metrics-types\";\r\nimport type { IApiHealthMetricsProvider } from \"../interfaces/api-component-interfaces\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport type { MetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport type { ModuleHealthService } from \"@/application/services/ModuleHealthService\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { moduleHealthServiceToken } from \"@/infrastructure/shared/tokens/core/module-health-service.token\";\r\n\r\n/**\r\n * ApiHealthMetricsProvider\r\n *\r\n * Responsible for providing health and metrics information.\r\n * Separated from ModuleApiInitializer for Single Responsibility Principle.\r\n */\r\nexport class ApiHealthMetricsProvider implements IApiHealthMetricsProvider {\r\n  /**\r\n   * Gets a snapshot of performance metrics.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Current metrics snapshot\r\n   */\r\n  getMetrics(container: PlatformContainerPort): MetricsSnapshot {\r\n    const metricsResult = container.resolveWithError(metricsCollectorToken);\r\n    if (!metricsResult.ok) {\r\n      return {\r\n        containerResolutions: 0,\r\n        resolutionErrors: 0,\r\n        avgResolutionTimeMs: 0,\r\n        portSelections: {},\r\n        portSelectionFailures: {},\r\n        cacheHitRate: 0,\r\n      };\r\n    }\r\n    const metricsCollector = castResolvedService<MetricsCollector>(metricsResult.value);\r\n    return metricsCollector.getSnapshot();\r\n  }\r\n\r\n  /**\r\n   * Gets module health status.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Health status with checks and overall status\r\n   */\r\n  getHealth(container: PlatformContainerPort): HealthStatus {\r\n    // Delegate to ModuleHealthService for health checks\r\n    const healthServiceResult = container.resolveWithError(moduleHealthServiceToken);\r\n    if (!healthServiceResult.ok) {\r\n      // Fallback health status if service cannot be resolved\r\n      return {\r\n        status: \"unhealthy\",\r\n        checks: {\r\n          containerValidated: false,\r\n          portsSelected: false,\r\n          lastError: \"ModuleHealthService not available\",\r\n        },\r\n        timestamp: new Date().toISOString(),\r\n      };\r\n    }\r\n    const healthService = castResolvedService<ModuleHealthService>(healthServiceResult.value);\r\n    return healthService.getHealth();\r\n  }\r\n}\r\n","import { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { ModuleApiInitializer as IModuleApiInitializer } from \"@/infrastructure/shared/types/module-api-initializer.interface\";\r\nimport { ModuleApiBuilder } from \"./builder/module-api-builder\";\r\nimport { ServiceWrapperFactory } from \"./wrappers/service-wrapper-factory\";\r\nimport { DeprecationHandler } from \"./deprecation/deprecation-handler\";\r\nimport { ApiServiceResolver } from \"./resolution/api-service-resolver\";\r\nimport { ApiHealthMetricsProvider } from \"./health/api-health-metrics-provider\";\r\n\r\n/**\r\n * ModuleApiInitializer\r\n *\r\n * Facade for exposing the module's public API to external consumers.\r\n * Coordinates all API-related components following Single Responsibility Principle.\r\n *\r\n * Responsibilities (delegated to specialized components):\r\n * - ModuleApiBuilder: Creates API objects and token collections\r\n * - ServiceWrapperFactory: Applies read-only wrappers for sensitive services\r\n * - DeprecationHandler: Handles deprecation warnings\r\n * - ApiServiceResolver: Creates resolve functions\r\n * - ApiHealthMetricsProvider: Provides health and metrics information\r\n *\r\n * This class acts as a pure Facade - it only coordinates the components\r\n * and exposes the API to game.modules.get(MODULE_ID).api\r\n *\r\n * Design: Uses dependency injection for all components, uses Result-Pattern for error handling.\r\n */\r\nexport class ModuleApiInitializer implements IModuleApiInitializer {\r\n  static dependencies = [] as const;\r\n\r\n  private readonly deprecationHandler: DeprecationHandler;\r\n  private readonly serviceWrapperFactory: ServiceWrapperFactory;\r\n  private readonly apiServiceResolver: ApiServiceResolver;\r\n  private readonly healthMetricsProvider: ApiHealthMetricsProvider;\r\n  private readonly apiBuilder: ModuleApiBuilder;\r\n\r\n  constructor(\r\n    deprecationHandler?: DeprecationHandler,\r\n    serviceWrapperFactory?: ServiceWrapperFactory,\r\n    apiServiceResolver?: ApiServiceResolver,\r\n    healthMetricsProvider?: ApiHealthMetricsProvider,\r\n    apiBuilder?: ModuleApiBuilder\r\n  ) {\r\n    // Initialize components with dependency injection or create defaults\r\n    this.deprecationHandler = deprecationHandler ?? new DeprecationHandler();\r\n    this.serviceWrapperFactory = serviceWrapperFactory ?? new ServiceWrapperFactory();\r\n    this.apiServiceResolver =\r\n      apiServiceResolver ??\r\n      new ApiServiceResolver(this.deprecationHandler, this.serviceWrapperFactory);\r\n    this.healthMetricsProvider = healthMetricsProvider ?? new ApiHealthMetricsProvider();\r\n    this.apiBuilder =\r\n      apiBuilder ?? new ModuleApiBuilder(this.apiServiceResolver, this.healthMetricsProvider);\r\n  }\r\n\r\n  /**\r\n   * Exposes the module's public API to game.modules.get(MODULE_ID).api\r\n   *\r\n   * This method coordinates all components to create and expose the API.\r\n   * It acts as a Facade, delegating to specialized components.\r\n   *\r\n   * @param container - Initialized and validated PlatformContainerPort\r\n   * @returns Result<void, string> - Ok if successful, Err with error message\r\n   */\r\n  expose(container: PlatformContainerPort): Result<void, string> {\r\n    // Guard: Foundry game object available?\r\n    if (typeof game === \"undefined\" || !game?.modules) {\r\n      return err(\"Game modules not available - API cannot be exposed\");\r\n    }\r\n\r\n    const mod = game.modules.get(MODULE_METADATA.ID);\r\n    if (!mod) {\r\n      return err(`Module '${MODULE_METADATA.ID}' not found in game.modules`);\r\n    }\r\n\r\n    // Create well-known tokens collection (delegated to builder)\r\n    const wellKnownTokens = this.apiBuilder.createApiTokens();\r\n\r\n    // Create complete API object (delegated to builder)\r\n    const api = this.apiBuilder.createApi(container, wellKnownTokens);\r\n\r\n    // Expose API to Foundry module\r\n    mod.api = api;\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\nexport class DIModuleApiInitializer extends ModuleApiInitializer {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","/**\r\n * Registry for health checks.\r\n * Services can register themselves for health monitoring.\r\n */\r\n\r\nimport type { ApplicationDisposable } from \"@/application/interfaces/application-disposable.interface\";\r\nimport type { HealthCheck } from \"@/domain/types/health-check\";\r\n\r\nexport class HealthCheckRegistry implements ApplicationDisposable {\r\n  static dependencies = [] as const;\r\n\r\n  private checks = new Map<string, HealthCheck>();\r\n\r\n  register(check: HealthCheck): void {\r\n    this.checks.set(check.name, check);\r\n  }\r\n\r\n  unregister(name: string): void {\r\n    this.checks.delete(name);\r\n  }\r\n\r\n  runAll(): Map<string, boolean> {\r\n    const results = new Map<string, boolean>();\r\n    for (const [name, check] of this.checks) {\r\n      results.set(name, check.check());\r\n    }\r\n    return results;\r\n  }\r\n\r\n  getCheck(name: string): HealthCheck | undefined {\r\n    return this.checks.get(name);\r\n  }\r\n\r\n  getAllChecks(): HealthCheck[] {\r\n    return Array.from(this.checks.values());\r\n  }\r\n\r\n  dispose(): void {\r\n    for (const check of this.checks.values()) {\r\n      check.dispose();\r\n    }\r\n    this.checks.clear();\r\n  }\r\n}\r\n\r\nexport class DIHealthCheckRegistry extends HealthCheckRegistry {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { PlatformHealthCheckPort } from \"@/domain/ports/platform-health-check-port.interface\";\r\nimport type { HealthCheck } from \"@/domain/types/health-check\";\r\nimport { HealthCheckRegistry } from \"@/application/health/HealthCheckRegistry\";\r\n\r\n/**\r\n * Infrastructure adapter that wraps HealthCheckRegistry as PlatformHealthCheckPort.\r\n */\r\nexport class HealthCheckRegistryAdapter implements PlatformHealthCheckPort {\r\n  private readonly registry: HealthCheckRegistry;\r\n\r\n  constructor() {\r\n    this.registry = new HealthCheckRegistry();\r\n  }\r\n\r\n  register(check: HealthCheck): void {\r\n    this.registry.register(check);\r\n  }\r\n\r\n  unregister(name: string): void {\r\n    this.registry.unregister(name);\r\n  }\r\n\r\n  runAll(): Map<string, boolean> {\r\n    return this.registry.runAll();\r\n  }\r\n\r\n  getCheck(name: string): HealthCheck | undefined {\r\n    return this.registry.getCheck(name);\r\n  }\r\n\r\n  getAllChecks(): HealthCheck[] {\r\n    return this.registry.getAllChecks();\r\n  }\r\n}\r\n","import type { InitPhase } from \"./init-phase.interface\";\r\n\r\n/**\r\n * Registry for initialization phases.\r\n *\r\n * Responsibilities:\r\n * - Maintain ordered list of init phases\r\n * - Provide sorted phases for orchestrator consumption\r\n * - Support extension without modifying orchestrator code\r\n */\r\nexport class InitPhaseRegistry {\r\n  private readonly phases: InitPhase[] = [];\r\n\r\n  /**\r\n   * Creates a new registry with the provided phases.\r\n   *\r\n   * @param phases - Array of init phases (will be sorted by priority)\r\n   */\r\n  constructor(phases: InitPhase[] = []) {\r\n    this.phases = [...phases];\r\n    this.sortPhases();\r\n  }\r\n\r\n  /**\r\n   * Returns all phases sorted by priority (ascending).\r\n   *\r\n   * @returns Sorted array of init phases\r\n   */\r\n  getAll(): InitPhase[] {\r\n    return [...this.phases];\r\n  }\r\n\r\n  /**\r\n   * Adds a phase to the registry and re-sorts.\r\n   *\r\n   * @param phase - Phase to add\r\n   */\r\n  add(phase: InitPhase): void {\r\n    this.phases.push(phase);\r\n    this.sortPhases();\r\n  }\r\n\r\n  /**\r\n   * Sorts phases by priority (ascending).\r\n   */\r\n  private sortPhases(): void {\r\n    this.phases.sort((a, b) => a.priority - b.priority);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\n\r\n/**\r\n * Error handling strategy for init phases.\r\n */\r\nexport enum InitPhaseCriticality {\r\n  /**\r\n   * Phase must succeed - failure stops the entire bootstrap process.\r\n   */\r\n  HALT_ON_ERROR = \"haltOnError\",\r\n  /**\r\n   * Phase is optional - failure is logged as warning but bootstrap continues.\r\n   */\r\n  WARN_AND_CONTINUE = \"warnAndContinue\",\r\n}\r\n\r\n/**\r\n * Context passed to init phase execution.\r\n */\r\nexport interface InitPhaseContext {\r\n  container: PlatformContainerPort;\r\n  logger: Logger;\r\n}\r\n\r\n/**\r\n * Interface for initialization phases in the bootstrap process.\r\n *\r\n * Each phase represents a single initialization step that can be executed\r\n * independently. Phases are ordered by priority and can have different\r\n * error handling strategies.\r\n */\r\nexport interface InitPhase {\r\n  /**\r\n   * Unique identifier for this phase.\r\n   */\r\n  readonly id: string;\r\n\r\n  /**\r\n   * Priority for ordering phases (lower numbers execute first).\r\n   */\r\n  readonly priority: number;\r\n\r\n  /**\r\n   * Error handling strategy for this phase.\r\n   */\r\n  readonly criticality: InitPhaseCriticality;\r\n\r\n  /**\r\n   * Executes the initialization phase.\r\n   *\r\n   * @param ctx - Context containing container and logger\r\n   * @returns Result indicating success or error message\r\n   */\r\n  execute(ctx: InitPhaseContext): Result<void, string>;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { isInitializable } from \"@/infrastructure/shared/utils/type-guards\";\r\n\r\n/**\r\n * Orchestrator for initializing metrics persistence during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve MetricsCollector\r\n * - Check if it implements Initializable interface\r\n * - Call initialize() if needed\r\n *\r\n * Follows Liskov Substitution Principle (LSP) by using interface-based\r\n * type checking instead of concrete class checks.\r\n */\r\nexport class MetricsBootstrapper {\r\n  /**\r\n   * Initializes metrics collector if it supports persistence.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success (warnings logged but don't fail bootstrap)\r\n   */\r\n  static initializeMetrics(container: PlatformContainerPort): Result<void, string> {\r\n    const metricsResult = container.resolveWithError(metricsCollectorToken);\r\n    if (!metricsResult.ok) {\r\n      // Metrics collector not available - return success (optional)\r\n      return ok(undefined);\r\n    }\r\n\r\n    // Check if collector implements Initializable interface\r\n    const collector = metricsResult.value;\r\n    if (isInitializable(collector)) {\r\n      const initResult = collector.initialize();\r\n      if (!initResult.ok) {\r\n        // Log warning but don't fail bootstrap\r\n        return ok(undefined);\r\n      }\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { MetricsBootstrapper } from \"../orchestrators/metrics-bootstrapper\";\r\n\r\n/**\r\n * Init phase for metrics initialization.\r\n */\r\nexport class MetricsInitPhase implements InitPhase {\r\n  readonly id = \"metrics-initialization\";\r\n  readonly priority = 1;\r\n  readonly criticality = InitPhaseCriticality.WARN_AND_CONTINUE;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof MetricsBootstrapper.initializeMetrics> {\r\n    return MetricsBootstrapper.initializeMetrics(ctx.container);\r\n  }\r\n}\r\n","/**\r\n * Injection token for QueuedUIChannel.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformUINotificationChannelPort } from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\n\r\n/**\r\n * Injection token for QueuedUIChannel.\r\n * QueuedUIChannel wraps UIChannel and adds queue functionality for notifications before UI is available.\r\n */\r\nexport const queuedUIChannelToken =\r\n  createInjectionToken<PlatformUINotificationChannelPort>(\"QueuedUIChannel\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { notificationCenterToken } from \"@/application/tokens/notifications/notification-center.token\";\r\nimport { queuedUIChannelToken } from \"@/application/tokens/notifications/queued-ui-channel.token\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { NotificationService } from \"@/application/services/notification-center.interface\";\r\nimport type { PlatformChannelPort } from \"@/domain/ports/notifications/platform-channel-port.interface\";\r\n\r\n/**\r\n * Orchestrator for attaching notification channels during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve NotificationCenter and QueuedUIChannel\r\n * - Attach QueuedUIChannel to NotificationCenter\r\n * - Handle errors gracefully (warnings, not failures - this phase is optional)\r\n */\r\nexport class NotificationBootstrapper {\r\n  /**\r\n   * Attaches UI notification channel to NotificationCenter.\r\n   *\r\n   * Uses QueuedUIChannel which queues notifications before UI is available\r\n   * and flushes them when UI becomes available.\r\n   *\r\n   * This phase is optional - failures are logged as warnings but don't fail bootstrap.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error (errors are logged as warnings but don't fail bootstrap)\r\n   */\r\n  static attachNotificationChannels(container: PlatformContainerPort): Result<void, string> {\r\n    const notificationCenterResult = container.resolveWithError(notificationCenterToken);\r\n    if (!notificationCenterResult.ok) {\r\n      // NotificationCenter resolution failure - return error so orchestrator can log warning\r\n      return err(\r\n        `NotificationCenter could not be resolved: ${notificationCenterResult.error.message}`\r\n      );\r\n    }\r\n\r\n    const queuedUIChannelResult = container.resolveWithError(queuedUIChannelToken);\r\n    if (!queuedUIChannelResult.ok) {\r\n      // UI channel is optional - return error so orchestrator can log warning\r\n      return err(`QueuedUIChannel could not be resolved: ${queuedUIChannelResult.error.message}`);\r\n    }\r\n\r\n    const notificationCenter = castResolvedService<NotificationService>(\r\n      notificationCenterResult.value\r\n    );\r\n    const queuedUIChannel = castResolvedService<PlatformChannelPort>(queuedUIChannelResult.value);\r\n    notificationCenter.addChannel(queuedUIChannel);\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { NotificationBootstrapper } from \"../orchestrators/notification-bootstrapper\";\r\n\r\n/**\r\n * Init phase for notification channels attachment.\r\n */\r\nexport class NotificationInitPhase implements InitPhase {\r\n  readonly id = \"notification-channels\";\r\n  readonly priority = 2;\r\n  readonly criticality = InitPhaseCriticality.WARN_AND_CONTINUE;\r\n\r\n  execute(\r\n    ctx: InitPhaseContext\r\n  ): ReturnType<typeof NotificationBootstrapper.attachNotificationChannels> {\r\n    return NotificationBootstrapper.attachNotificationChannels(ctx.container);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { moduleApiInitializerToken } from \"@/infrastructure/shared/tokens/infrastructure/module-api-initializer.token\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { ModuleApiInitializer } from \"@/framework/core/api/module-api-initializer\";\r\n\r\n/**\r\n * Orchestrator for exposing module API during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve ModuleApiInitializer\r\n * - Expose API to game.modules.get(MODULE_ID).api\r\n */\r\nexport class ApiBootstrapper {\r\n  /**\r\n   * Exposes the module's public API.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error\r\n   */\r\n  static exposeApi(container: PlatformContainerPort): Result<void, string> {\r\n    const apiInitializerResult = container.resolveWithError(moduleApiInitializerToken);\r\n    if (!apiInitializerResult.ok) {\r\n      return err(`Failed to resolve ModuleApiInitializer: ${apiInitializerResult.error.message}`);\r\n    }\r\n\r\n    const apiInitializer = castResolvedService<ModuleApiInitializer>(apiInitializerResult.value);\r\n    const exposeResult = apiInitializer.expose(container);\r\n    if (!exposeResult.ok) {\r\n      return err(`Failed to expose API: ${exposeResult.error}`);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { ApiBootstrapper } from \"../orchestrators/api-bootstrapper\";\r\n\r\n/**\r\n * Init phase for API exposure.\r\n */\r\nexport class ApiInitPhase implements InitPhase {\r\n  readonly id = \"api-exposure\";\r\n  readonly priority = 3;\r\n  readonly criticality = InitPhaseCriticality.HALT_ON_ERROR;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof ApiBootstrapper.exposeApi> {\r\n    return ApiBootstrapper.exposeApi(ctx.container);\r\n  }\r\n}\r\n","/**\r\n * Injection token for the ModuleSettingsRegistrar.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ModuleSettingsRegistrar } from \"@/application/services/ModuleSettingsRegistrar\";\r\n\r\n/**\r\n * Injection token for the ModuleSettingsRegistrar.\r\n *\r\n * Manages registration of all Foundry module settings.\r\n * Must be called during or after the 'init' hook.\r\n *\r\n * @example\r\n * ```typescript\r\n * const settingsRegistrar = container.resolve(moduleSettingsRegistrarToken);\r\n * settingsRegistrar.registerAll(container);\r\n * ```\r\n */\r\nexport const moduleSettingsRegistrarToken =\r\n  createInjectionToken<ModuleSettingsRegistrar>(\"ModuleSettingsRegistrar\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { moduleSettingsRegistrarToken } from \"@/infrastructure/shared/tokens/core/module-settings-registrar.token\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { ModuleSettingsRegistrar } from \"@/application/services/ModuleSettingsRegistrar\";\r\n\r\n/**\r\n * Orchestrator for registering module settings during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve ModuleSettingsRegistrar\r\n * - Register all module settings\r\n */\r\nexport class SettingsBootstrapper {\r\n  /**\r\n   * Registers all module settings.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error\r\n   */\r\n  static registerSettings(container: PlatformContainerPort): Result<void, string> {\r\n    const settingsRegistrarResult = container.resolveWithError(moduleSettingsRegistrarToken);\r\n    if (!settingsRegistrarResult.ok) {\r\n      return err(\r\n        `Failed to resolve ModuleSettingsRegistrar: ${settingsRegistrarResult.error.message}`\r\n      );\r\n    }\r\n\r\n    // Container parameter removed - all dependencies injected via constructor\r\n    const settingsRegistrar = castResolvedService<ModuleSettingsRegistrar>(\r\n      settingsRegistrarResult.value\r\n    );\r\n    settingsRegistrar.registerAll();\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { SettingsBootstrapper } from \"../orchestrators/settings-bootstrapper\";\r\n\r\n/**\r\n * Init phase for settings registration.\r\n */\r\nexport class SettingsInitPhase implements InitPhase {\r\n  readonly id = \"settings-registration\";\r\n  readonly priority = 4;\r\n  readonly criticality = InitPhaseCriticality.HALT_ON_ERROR;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof SettingsBootstrapper.registerSettings> {\r\n    return SettingsBootstrapper.registerSettings(ctx.container);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport { MODULE_METADATA, SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\nimport { LOG_LEVEL_SCHEMA } from \"@/infrastructure/validation/log-level-schema\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\n\r\n/**\r\n * Orchestrator for configuring logger during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve FoundrySettings\r\n * - Read log level setting\r\n * - Configure logger with user setting\r\n */\r\nexport class LoggingBootstrapper {\r\n  /**\r\n   * Configures logger with current setting value.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @param logger - Logger instance to configure\r\n   * @returns Result indicating success (always succeeds, settings are optional)\r\n   */\r\n  static configureLogging(container: PlatformContainerPort, logger: Logger): Result<void, string> {\r\n    const settingsResult = container.resolveWithError(foundrySettingsToken);\r\n    if (!settingsResult.ok) {\r\n      // Settings are optional - return success\r\n      return ok(undefined);\r\n    }\r\n\r\n    const settings = castResolvedService<FoundrySettings>(settingsResult.value);\r\n    // Note: FoundrySettings uses valibot directly (Foundry-specific infrastructure)\r\n    // This is OK since FoundrySettings is not a domain interface\r\n    const logLevelResult = settings.get(\r\n      MODULE_METADATA.ID,\r\n      SETTING_KEYS.LOG_LEVEL,\r\n      LOG_LEVEL_SCHEMA\r\n    );\r\n\r\n    if (logLevelResult.ok && logger.setMinLevel) {\r\n      logger.setMinLevel(logLevelResult.value);\r\n      logger.debug(`Logger configured with level: ${LogLevel[logLevelResult.value]}`);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { LoggingBootstrapper } from \"../orchestrators/logging-bootstrapper\";\r\n\r\n/**\r\n * Init phase for logging configuration.\r\n */\r\nexport class LoggingInitPhase implements InitPhase {\r\n  readonly id = \"logging-configuration\";\r\n  readonly priority = 5;\r\n  readonly criticality = InitPhaseCriticality.WARN_AND_CONTINUE;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof LoggingBootstrapper.configureLogging> {\r\n    return LoggingBootstrapper.configureLogging(ctx.container, ctx.logger);\r\n  }\r\n}\r\n","/**\r\n * Application layer tokens for event-related use cases.\r\n *\r\n * These tokens define injection points for event use cases,\r\n * keeping the Application layer decoupled from Infrastructure-specific implementations.\r\n */\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\n\r\n/**\r\n * DI Token for InvalidateJournalCacheOnChangeUseCase.\r\n *\r\n * Use-case that invalidates journal cache when journal entries change.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const invalidateJournalCacheOnChangeUseCaseToken = createInjectionToken<any>(\r\n  \"InvalidateJournalCacheOnChangeUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for ProcessJournalDirectoryOnRenderUseCase.\r\n *\r\n * Use-case that processes journal directory when it's rendered.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const processJournalDirectoryOnRenderUseCaseToken = createInjectionToken<any>(\r\n  \"ProcessJournalDirectoryOnRenderUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for TriggerJournalDirectoryReRenderUseCase.\r\n *\r\n * Use-case that triggers journal directory re-render when hidden flag changes.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const triggerJournalDirectoryReRenderUseCaseToken = createInjectionToken<any>(\r\n  \"TriggerJournalDirectoryReRenderUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for RegisterContextMenuUseCase.\r\n *\r\n * Use-case that registers custom context menu entries for journal entries.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const registerContextMenuUseCaseToken = createInjectionToken<any>(\r\n  \"RegisterContextMenuUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for ShowAllHiddenJournalsUseCase.\r\n *\r\n * Use-case that shows all hidden journals by setting their hidden flag to false.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const showAllHiddenJournalsUseCaseToken = createInjectionToken<any>(\r\n  \"ShowAllHiddenJournalsUseCase\"\r\n);\r\n\r\n/**\r\n * DI Token for SidebarButtonBootstrapper.\r\n *\r\n * Bootstrapper that registers sidebar button for showing all hidden journals.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const sidebarButtonBootstrapperToken = createInjectionToken<any>(\r\n  \"SidebarButtonBootstrapper\"\r\n);\r\n\r\n/**\r\n * DI Token for ModuleEventRegistrar.\r\n *\r\n * Manages registration of all platform-agnostic event listeners.\r\n *\r\n * Generic Type wird beim resolve() aufgelöst - kein Import nötig!\r\n */\r\nexport const moduleEventRegistrarToken = createInjectionToken<any>(\"ModuleEventRegistrar\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { moduleEventRegistrarToken } from \"@/application/tokens/event.tokens\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { ModuleEventRegistrar } from \"@/application/services/ModuleEventRegistrar\";\r\n\r\n/**\r\n * Orchestrator for registering event listeners during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve ModuleEventRegistrar\r\n * - Register all event listeners\r\n */\r\nexport class EventsBootstrapper {\r\n  /**\r\n   * Registers all event listeners.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error\r\n   */\r\n  static registerEvents(container: PlatformContainerPort): Result<void, string> {\r\n    const eventRegistrarResult = container.resolveWithError(moduleEventRegistrarToken);\r\n    if (!eventRegistrarResult.ok) {\r\n      return err(`Failed to resolve ModuleEventRegistrar: ${eventRegistrarResult.error.message}`);\r\n    }\r\n\r\n    // Container parameter removed - all dependencies injected via constructor\r\n    const eventRegistrar = castResolvedService<ModuleEventRegistrar>(eventRegistrarResult.value);\r\n    const eventRegistrationResult = eventRegistrar.registerAll();\r\n    if (!eventRegistrationResult.ok) {\r\n      const errorMessages = eventRegistrationResult.error.map((e: Error) => e.message).join(\", \");\r\n      return err(`Failed to register one or more event listeners: ${errorMessages}`);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { EventsBootstrapper } from \"../orchestrators/events-bootstrapper\";\r\n\r\n/**\r\n * Init phase for event registration.\r\n */\r\nexport class EventsInitPhase implements InitPhase {\r\n  readonly id = \"event-registration\";\r\n  readonly priority = 6;\r\n  readonly criticality = InitPhaseCriticality.HALT_ON_ERROR;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof EventsBootstrapper.registerEvents> {\r\n    return EventsBootstrapper.registerEvents(ctx.container);\r\n  }\r\n}\r\n","/**\r\n * Injection token for JournalContextMenuLibWrapperService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { JournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\n\r\n/**\r\n * Injection token for JournalContextMenuLibWrapperService.\r\n *\r\n * Service for managing libWrapper registration for journal context menu.\r\n * Handles the registration of the libWrapper wrapper function for the Foundry\r\n * ContextMenu.render method and manages callbacks that can modify context menu options.\r\n *\r\n * NOTE: This is NOT an event system. The libWrapper is registered once during init,\r\n * and callbacks are registered separately.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = container.resolve(journalContextMenuLibWrapperServiceToken);\r\n *\r\n * // Register libWrapper (called during init)\r\n * const result = service.register();\r\n *\r\n * // Add callback for handling context menu\r\n * service.addCallback((event) => {\r\n *   event.options.push({\r\n *     name: \"Custom Option\",\r\n *     icon: '<i class=\"fas fa-star\"></i>',\r\n *     callback: () => { /* ... *\\/ }\r\n *   });\r\n * });\r\n * ```\r\n */\r\nexport const journalContextMenuLibWrapperServiceToken =\r\n  createInjectionToken<JournalContextMenuLibWrapperService>(\"JournalContextMenuLibWrapperService\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { journalContextMenuLibWrapperServiceToken } from \"@/infrastructure/shared/tokens/foundry/journal-context-menu-lib-wrapper-service.token\";\r\nimport { registerContextMenuUseCaseToken } from \"@/application/tokens/event.tokens\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { JournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\nimport type { RegisterContextMenuUseCase } from \"@/application/use-cases/register-context-menu.use-case\";\r\n\r\n/**\r\n * Orchestrator for registering context menu during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve JournalContextMenuLibWrapperService\r\n * - Register libWrapper hook\r\n * - Register context menu callbacks\r\n */\r\nexport class ContextMenuBootstrapper {\r\n  /**\r\n   * Registers context menu libWrapper and callbacks.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error (errors are logged as warnings but don't fail bootstrap)\r\n   */\r\n  static registerContextMenu(container: PlatformContainerPort): Result<void, string> {\r\n    const contextMenuLibWrapperResult = container.resolveWithError(\r\n      journalContextMenuLibWrapperServiceToken\r\n    );\r\n    if (!contextMenuLibWrapperResult.ok) {\r\n      // Context menu is optional - return error so orchestrator can log warning\r\n      return err(\r\n        `JournalContextMenuLibWrapperService could not be resolved: ${contextMenuLibWrapperResult.error.message}`\r\n      );\r\n    }\r\n\r\n    const contextMenuLibWrapper = castResolvedService<JournalContextMenuLibWrapperService>(\r\n      contextMenuLibWrapperResult.value\r\n    );\r\n    const registerResult = contextMenuLibWrapper.register();\r\n    if (!registerResult.ok) {\r\n      // Registration failure - return error so orchestrator can log warning\r\n      return err(`Context menu libWrapper registration failed: ${registerResult.error.message}`);\r\n    }\r\n\r\n    // Register context menu callbacks (after libWrapper is registered)\r\n    const contextMenuUseCaseResult = container.resolveWithError(registerContextMenuUseCaseToken);\r\n    if (!contextMenuUseCaseResult.ok) {\r\n      // Use case resolution failure - return error so orchestrator can log warning\r\n      return err(\r\n        `RegisterContextMenuUseCase could not be resolved: ${contextMenuUseCaseResult.error.message}`\r\n      );\r\n    }\r\n\r\n    const contextMenuUseCase = castResolvedService<RegisterContextMenuUseCase>(\r\n      contextMenuUseCaseResult.value\r\n    );\r\n    const callbackRegisterResult = contextMenuUseCase.register();\r\n    if (!callbackRegisterResult.ok) {\r\n      // Callback registration failure - return error so orchestrator can log warning\r\n      return err(\r\n        `Context menu callback registration failed: ${callbackRegisterResult.error.message}`\r\n      );\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { ContextMenuBootstrapper } from \"../orchestrators/context-menu-bootstrapper\";\r\n\r\n/**\r\n * Init phase for context menu registration.\r\n */\r\nexport class ContextMenuInitPhase implements InitPhase {\r\n  readonly id = \"context-menu-registration\";\r\n  readonly priority = 7;\r\n  readonly criticality = InitPhaseCriticality.WARN_AND_CONTINUE;\r\n\r\n  execute(ctx: InitPhaseContext): ReturnType<typeof ContextMenuBootstrapper.registerContextMenu> {\r\n    return ContextMenuBootstrapper.registerContextMenu(ctx.container);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { showAllHiddenJournalsUseCaseToken } from \"@/application/tokens/event.tokens\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { ShowAllHiddenJournalsUseCase } from \"@/application/use-cases/show-all-hidden-journals.use-case\";\r\nimport type { FoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\n\r\n/**\r\n * Orchestrator for registering sidebar button during bootstrap.\r\n *\r\n * Responsibilities:\r\n * - Resolve ShowAllHiddenJournalsUseCase\r\n * - Register renderSidebarTab hook\r\n * - Add button to journal sidebar that calls the use-case\r\n */\r\nexport class SidebarButtonBootstrapper {\r\n  /**\r\n   * Registers sidebar button for journal tab.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @returns Result indicating success or error (errors are logged as warnings but don't fail bootstrap)\r\n   */\r\n  static registerSidebarButton(container: PlatformContainerPort): Result<void, string> {\r\n    const useCaseResult = container.resolveWithError(showAllHiddenJournalsUseCaseToken);\r\n    if (!useCaseResult.ok) {\r\n      // Sidebar button is optional - return error so orchestrator can log warning\r\n      return err(\r\n        `ShowAllHiddenJournalsUseCase could not be resolved: ${useCaseResult.error.message}`\r\n      );\r\n    }\r\n\r\n    const useCase = castResolvedService<ShowAllHiddenJournalsUseCase>(useCaseResult.value);\r\n\r\n    const hooksResult = container.resolveWithError(foundryHooksToken);\r\n    if (!hooksResult.ok) {\r\n      return err(`FoundryHooksPort could not be resolved: ${hooksResult.error.message}`);\r\n    }\r\n\r\n    const hooks = castResolvedService<FoundryHooksPort>(hooksResult.value);\r\n\r\n    // Register renderJournalDirectory hook (same hook as ProcessJournalDirectoryOnRenderUseCase uses)\r\n    // This is a Foundry-specific hook, so we use FoundryHooksPort\r\n    // The button handler has full control over DI (normal case, not edge case)\r\n    // NOTE: renderJournalDirectory is specifically for the journal directory,\r\n    // so we don't need to check tabName - this hook only fires for journal directory\r\n    const hookRegistrationResult = hooks.on(\"renderJournalDirectory\", (...args: unknown[]) => {\r\n      // Type-safe extraction of hook parameters\r\n      if (args.length < 2) {\r\n        return;\r\n      }\r\n      const htmlArg = args[1];\r\n\r\n      // Type guard for html parameter\r\n      if (!(htmlArg instanceof HTMLElement)) {\r\n        return;\r\n      }\r\n\r\n      const html = htmlArg;\r\n\r\n      // Check if button already exists (prevent duplicates on re-render)\r\n      const existingButton = html.querySelector(\".show-all-hidden-journals-button\");\r\n      if (existingButton) {\r\n        return;\r\n      }\r\n\r\n      // Create button element\r\n      const button = document.createElement(\"button\");\r\n      button.className = \"show-all-hidden-journals-button\";\r\n      button.type = \"button\";\r\n      button.title = \"Alle versteckten Journale wieder einblenden\";\r\n      button.innerHTML = '<i class=\"fas fa-eye\"></i> Alle Journale einblenden';\r\n\r\n      // Add click handler\r\n      button.addEventListener(\"click\", async () => {\r\n        const result = await useCase.execute();\r\n        if (result.ok) {\r\n          // Success notification is already shown by the use-case\r\n          // No additional action needed\r\n        } else {\r\n          // Error notification is already shown by the use-case\r\n          // No additional action needed\r\n        }\r\n      });\r\n\r\n      // Add button to action-buttons container in directory header\r\n      const actionButtons = html.querySelector(\".header-actions.action-buttons\");\r\n      if (actionButtons) {\r\n        actionButtons.appendChild(button);\r\n      } else {\r\n        // Fallback: try directory-header if action-buttons not found\r\n        const directoryHeader = html.querySelector(\".directory-header\");\r\n        if (directoryHeader) {\r\n          directoryHeader.appendChild(button);\r\n        } else {\r\n          // Last resort: add to top of sidebar\r\n          html.insertBefore(button, html.firstChild);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!hookRegistrationResult.ok) {\r\n      return err(`Failed to register sidebar button hook: ${hookRegistrationResult.error.message}`);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n","import type { InitPhase, InitPhaseContext } from \"../init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"../init-phase.interface\";\r\nimport { SidebarButtonBootstrapper } from \"../orchestrators/sidebar-button-bootstrapper\";\r\n\r\n/**\r\n * Init phase for sidebar button registration.\r\n */\r\nexport class SidebarButtonInitPhase implements InitPhase {\r\n  readonly id = \"sidebar-button-registration\";\r\n  readonly priority = 8;\r\n  readonly criticality = InitPhaseCriticality.WARN_AND_CONTINUE;\r\n\r\n  execute(\r\n    ctx: InitPhaseContext\r\n  ): ReturnType<typeof SidebarButtonBootstrapper.registerSidebarButton> {\r\n    return SidebarButtonBootstrapper.registerSidebarButton(ctx.container);\r\n  }\r\n}\r\n","import { InitPhaseRegistry } from \"./init-phase-registry\";\r\nimport { MetricsInitPhase } from \"./phases/metrics-init-phase\";\r\nimport { NotificationInitPhase } from \"./phases/notification-init-phase\";\r\nimport { ApiInitPhase } from \"./phases/api-init-phase\";\r\nimport { SettingsInitPhase } from \"./phases/settings-init-phase\";\r\nimport { LoggingInitPhase } from \"./phases/logging-init-phase\";\r\nimport { EventsInitPhase } from \"./phases/events-init-phase\";\r\nimport { ContextMenuInitPhase } from \"./phases/context-menu-init-phase\";\r\nimport { SidebarButtonInitPhase } from \"./phases/sidebar-button-init-phase\";\r\n\r\n/**\r\n * Creates the default init phase registry with all standard phases.\r\n *\r\n * This factory function provides the default configuration of init phases\r\n * in the correct order. The registry can be extended or replaced for\r\n * testing or custom configurations.\r\n *\r\n * @returns InitPhaseRegistry with all default phases\r\n */\r\nexport function createDefaultInitPhaseRegistry(): InitPhaseRegistry {\r\n  return new InitPhaseRegistry([\r\n    new MetricsInitPhase(),\r\n    new NotificationInitPhase(),\r\n    new ApiInitPhase(),\r\n    new SettingsInitPhase(),\r\n    new LoggingInitPhase(),\r\n    new EventsInitPhase(),\r\n    new ContextMenuInitPhase(),\r\n    new SidebarButtonInitPhase(),\r\n  ]);\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { InitPhase } from \"./init-phase.interface\";\r\nimport { InitPhaseCriticality } from \"./init-phase.interface\";\r\nimport type { InitError } from \"./init-error\";\r\n\r\n/**\r\n * Handles errors for init phases based on their criticality.\r\n *\r\n * Responsibilities:\r\n * - Determine error handling strategy based on phase criticality\r\n * - Log errors appropriately (error vs. warn)\r\n * - Aggregate critical errors for reporting\r\n *\r\n * This class separates error handling concerns from orchestration logic,\r\n * improving testability and maintainability (SRP compliance).\r\n */\r\nexport class InitPhaseErrorHandler {\r\n  /**\r\n   * Handles an error from a phase execution.\r\n   *\r\n   * @param phase - The phase that failed\r\n   * @param error - The error message from the phase\r\n   * @param errors - Array to collect critical errors (mutated if phase is critical)\r\n   * @param logger - Logger for error reporting\r\n   */\r\n  handlePhaseError(phase: InitPhase, error: string, errors: InitError[], logger: Logger): void {\r\n    if (phase.criticality === InitPhaseCriticality.HALT_ON_ERROR) {\r\n      errors.push({\r\n        phase: phase.id,\r\n        message: error,\r\n      });\r\n      logger.error(`Failed to execute phase '${phase.id}': ${error}`);\r\n    } else {\r\n      logger.warn(`Phase '${phase.id}' failed: ${error}`);\r\n    }\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { InitPhaseContext } from \"./init-phase.interface\";\r\nimport { InitPhaseRegistry } from \"./init-phase-registry\";\r\nimport { createDefaultInitPhaseRegistry } from \"./default-init-phase-registry\";\r\nimport { InitPhaseErrorHandler } from \"./init-phase-error-handler\";\r\nimport type { InitError } from \"./init-error\";\r\n\r\nexport type { InitError };\r\n\r\n/**\r\n * Orchestrator for the complete bootstrap initialization sequence.\r\n *\r\n * Responsibilities:\r\n * - Execute all bootstrap phases in order from registry\r\n * - Coordinate phase execution and context creation\r\n *\r\n * Design:\r\n * - Phases are provided via InitPhaseRegistry (OCP-compliant)\r\n * - Each phase is isolated and can be tested independently\r\n * - Error handling is delegated to InitPhaseErrorHandler (SRP compliance)\r\n * - New phases can be added via registry extension without modifying orchestrator\r\n */\r\nexport class InitOrchestrator {\r\n  private readonly registry: InitPhaseRegistry;\r\n\r\n  /**\r\n   * Creates a new InitOrchestrator instance.\r\n   *\r\n   * @param registry - Registry providing init phases (defaults to standard phases)\r\n   */\r\n  constructor(registry?: InitPhaseRegistry) {\r\n    this.registry = registry ?? createDefaultInitPhaseRegistry();\r\n  }\r\n\r\n  /**\r\n   * Executes the complete initialization sequence.\r\n   *\r\n   * Phases are executed in priority order (ascending). Error handling\r\n   * follows each phase's criticality setting:\r\n   * - HALT_ON_ERROR: Errors are collected and returned, stopping bootstrap\r\n   * - WARN_AND_CONTINUE: Errors are logged as warnings but don't stop bootstrap\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @param logger - Logger for error reporting\r\n   * @returns Result indicating success or aggregated errors\r\n   */\r\n  execute(container: PlatformContainerPort, logger: Logger): Result<void, InitError[]> {\r\n    const errors: InitError[] = [];\r\n    const phases = this.registry.getAll();\r\n    const ctx: InitPhaseContext = { container, logger };\r\n    const errorHandler = new InitPhaseErrorHandler();\r\n\r\n    for (const phase of phases) {\r\n      const result = phase.execute(ctx);\r\n\r\n      if (!result.ok) {\r\n        errorHandler.handlePhaseError(phase, result.error, errors, logger);\r\n      }\r\n    }\r\n\r\n    // If any critical phases failed, return errors\r\n    if (errors.length > 0) {\r\n      return err(errors);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Static convenience method for backward compatibility.\r\n   *\r\n   * Creates a new orchestrator with default registry and executes.\r\n   *\r\n   * @param container - PlatformContainerPort for service resolution\r\n   * @param logger - Logger for error reporting\r\n   * @returns Result indicating success or aggregated errors\r\n   */\r\n  static execute(container: PlatformContainerPort, logger: Logger): Result<void, InitError[]> {\r\n    const orchestrator = new InitOrchestrator();\r\n    return orchestrator.execute(container, logger);\r\n  }\r\n}\r\n","/**\r\n * Bootstrap init hook registration service.\r\n *\r\n * DIP-Compliant: Uses PlatformBootstrapEventPort instead of direct Hooks.on().\r\n * The port abstracts the platform-specific hook registration while still\r\n * allowing the adapter to use direct APIs to avoid the chicken-egg problem.\r\n *\r\n * All other hooks (registered inside init) can use PlatformEventPort normally.\r\n */\r\n\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport type { PlatformBootstrapEventPort } from \"@/domain/ports/platform-bootstrap-event-port.interface\";\r\nimport { platformBootstrapEventPortToken } from \"@/infrastructure/shared/tokens/ports/platform-bootstrap-event-port.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { platformContainerPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { InitOrchestrator } from \"./bootstrap/init-orchestrator\";\r\nimport type { BootstrapInitHookService as IBootstrapInitHookService } from \"@/infrastructure/shared/types/bootstrap-init-hook-service.interface\";\r\n\r\n/**\r\n * Service responsible for registering the Foundry 'init' hook.\r\n * Handles all initialization logic when the init hook fires.\r\n *\r\n * DIP-Compliant: Uses PlatformBootstrapEventPort for event registration instead of\r\n * direct platform API access.\r\n */\r\nexport class BootstrapInitHookService implements IBootstrapInitHookService {\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly container: PlatformContainerPort,\r\n    private readonly bootstrapEvents: PlatformBootstrapEventPort\r\n  ) {}\r\n\r\n  /**\r\n   * Registers the init event via PlatformBootstrapEventPort.\r\n   * Must be called before the platform's init hook fires.\r\n   */\r\n  register(): void {\r\n    const result = this.bootstrapEvents.onInit(() => this.handleInit());\r\n\r\n    if (!result.ok) {\r\n      this.logger.warn(\r\n        `Init hook registration failed: ${result.error.message}`,\r\n        result.error.details\r\n      );\r\n    }\r\n  }\r\n\r\n  /* v8 ignore start -- @preserve */\r\n  /* Foundry-Hooks und UI-spezifische Pfade hängen stark von der Laufzeitumgebung ab\r\n   * und werden primär über Integrations-/E2E-Tests abgesichert. Für das aktuelle Quality-Gateway\r\n   * blenden wir diese verzweigten Pfade temporär aus und reduzieren die Ignores später gezielt. */\r\n  private handleInit(): void {\r\n    this.logger.info(\"init-phase\");\r\n\r\n    // Delegate to InitOrchestrator for all initialization phases\r\n    const result = InitOrchestrator.execute(this.container, this.logger);\r\n\r\n    if (!result.ok) {\r\n      // Log aggregated errors\r\n      const errorMessages = result.error.map((e) => `${e.phase}: ${e.message}`).join(\"; \");\r\n      this.logger.error(`Init phase completed with errors: ${errorMessages}`);\r\n    } else {\r\n      this.logger.info(\"init-phase completed\");\r\n    }\r\n  }\r\n  /* v8 ignore stop -- @preserve */\r\n}\r\n\r\n/**\r\n * DI wrapper for BootstrapInitHookService.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIBootstrapInitHookService extends BootstrapInitHookService {\r\n  static dependencies = [\r\n    loggerToken,\r\n    platformContainerPortToken,\r\n    platformBootstrapEventPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    logger: Logger,\r\n    container: PlatformContainerPort,\r\n    bootstrapEvents: PlatformBootstrapEventPort\r\n  ) {\r\n    super(logger, container, bootstrapEvents);\r\n  }\r\n}\r\n","/**\r\n * Service for managing module ready state.\r\n *\r\n * Uses PlatformModuleReadyPort to set module.ready = true when bootstrap is complete.\r\n * Follows the platform port pattern for architecture compliance.\r\n */\r\n\r\nimport type { PlatformModuleReadyPort } from \"@/domain/ports/platform-module-ready-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport { platformModuleReadyPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { platformLoggingPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { InjectionToken } from \"@/application/di/injection-token\";\r\n\r\n/**\r\n * Service responsible for managing module.ready state.\r\n *\r\n * Uses PlatformModuleReadyPort to set module.ready = true when bootstrap-ready-hook completes.\r\n * Does NOT set module.ready = false initially - if it's not set, it's undefined/false anyway.\r\n */\r\nexport class ModuleReadyService {\r\n  constructor(\r\n    private readonly moduleReadyPort: PlatformModuleReadyPort,\r\n    private readonly loggingPort: PlatformLoggingPort\r\n  ) {}\r\n\r\n  /**\r\n   * Sets module.ready to true (ready state).\r\n   * Should be called when bootstrap-ready-hook completes.\r\n   */\r\n  setReady(): void {\r\n    const result = this.moduleReadyPort.setReady();\r\n    if (!result.ok) {\r\n      this.loggingPort.warn(\r\n        `Failed to set module.ready: ${result.error.message}`,\r\n        result.error.details\r\n      );\r\n    } else {\r\n      this.loggingPort.info(\"module.ready set to true\");\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for ModuleReadyService.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIModuleReadyService extends ModuleReadyService {\r\n  static dependencies = [platformModuleReadyPortToken, platformLoggingPortToken] as const;\r\n\r\n  constructor(moduleReadyPort: PlatformModuleReadyPort, loggingPort: PlatformLoggingPort) {\r\n    super(moduleReadyPort, loggingPort);\r\n  }\r\n}\r\n\r\n/**\r\n * Injection token for ModuleReadyService.\r\n */\r\nexport const moduleReadyServiceToken: InjectionToken<ModuleReadyService> =\r\n  createInjectionToken<ModuleReadyService>(\"ModuleReadyService\");\r\n","/**\r\n * Bootstrap ready hook registration service.\r\n *\r\n * DIP-Compliant: Uses PlatformBootstrapEventPort instead of direct Hooks.on().\r\n * The port abstracts the platform-specific hook registration while still\r\n * allowing the adapter to use direct APIs to avoid the chicken-egg problem.\r\n *\r\n * All other hooks (registered inside init) can use PlatformEventPort normally.\r\n */\r\n\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { PlatformBootstrapEventPort } from \"@/domain/ports/platform-bootstrap-event-port.interface\";\r\nimport { platformBootstrapEventPortToken } from \"@/infrastructure/shared/tokens/ports/platform-bootstrap-event-port.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport type { ModuleReadyService } from \"@/application/services/module-ready-service\";\r\nimport { moduleReadyServiceToken } from \"@/application/services/module-ready-service\";\r\nimport type { BootstrapReadyHookService as IBootstrapReadyHookService } from \"@/infrastructure/shared/types/bootstrap-ready-hook-service.interface\";\r\n\r\n/**\r\n * Service responsible for registering the Foundry 'ready' hook.\r\n * Handles ready-phase logic when the ready hook fires.\r\n *\r\n * DIP-Compliant: Uses PlatformBootstrapEventPort for event registration instead of\r\n * direct platform API access.\r\n */\r\nexport class BootstrapReadyHookService implements IBootstrapReadyHookService {\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly bootstrapEvents: PlatformBootstrapEventPort,\r\n    private readonly moduleReadyService: ModuleReadyService\r\n  ) {}\r\n\r\n  /**\r\n   * Registers the ready event via PlatformBootstrapEventPort.\r\n   * Must be called before the platform's ready hook fires.\r\n   */\r\n  register(): void {\r\n    const result = this.bootstrapEvents.onReady(() => this.handleReady());\r\n\r\n    if (!result.ok) {\r\n      this.logger.warn(\r\n        `Ready hook registration failed: ${result.error.message}`,\r\n        result.error.details\r\n      );\r\n    }\r\n  }\r\n\r\n  /* v8 ignore start -- @preserve */\r\n  /* Foundry-Hooks und UI-spezifische Pfade hängen stark von der Laufzeitumgebung ab\r\n   * und werden primär über Integrations-/E2E-Tests abgesichert. Für das aktuelle Quality-Gateway\r\n   * blenden wir diese verzweigten Pfade temporär aus und reduzieren die Ignores später gezielt. */\r\n  private handleReady(): void {\r\n    this.logger.info(\"ready-phase\");\r\n\r\n    // Setze module.ready = true, sobald Bootstrap-Ready-Hook fertig ist\r\n    // Ähnlich wie game.ready, aber für unser Modul\r\n    this.moduleReadyService.setReady();\r\n\r\n    this.logger.info(\"ready-phase completed\");\r\n  }\r\n  /* v8 ignore stop -- @preserve */\r\n}\r\n\r\n/**\r\n * DI wrapper for BootstrapReadyHookService.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIBootstrapReadyHookService extends BootstrapReadyHookService {\r\n  static dependencies = [\r\n    loggerToken,\r\n    platformBootstrapEventPortToken,\r\n    moduleReadyServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    logger: Logger,\r\n    bootstrapEvents: PlatformBootstrapEventPort,\r\n    moduleReadyService: ModuleReadyService\r\n  ) {\r\n    super(logger, bootstrapEvents, moduleReadyService);\r\n  }\r\n}\r\n","import type {\r\n  PlatformBootstrapEventPort,\r\n  PlatformBootstrapEventError,\r\n} from \"@/domain/ports/platform-bootstrap-event-port.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry-specific adapter for PlatformBootstrapEventPort.\r\n *\r\n * CRITICAL: This adapter uses direct Hooks.on() instead of the versioned\r\n * FoundryHooksService to avoid a chicken-egg problem. The PlatformEventPort\r\n * system requires version detection (game.version), but game.version might\r\n * not be available before the init event runs.\r\n *\r\n * This is a documented exception to the normal DIP pattern. All other events\r\n * (registered inside init) should use PlatformEventPort normally.\r\n */\r\nexport class FoundryBootstrapEventAdapter implements PlatformBootstrapEventPort {\r\n  onInit(callback: () => void): Result<void, PlatformBootstrapEventError> {\r\n    if (typeof Hooks === \"undefined\") {\r\n      return err({\r\n        code: \"PLATFORM_NOT_AVAILABLE\",\r\n        message: \"Foundry Hooks API not available\",\r\n      });\r\n    }\r\n\r\n    try {\r\n      Hooks.on(\"init\", callback);\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err({\r\n        code: \"EVENT_REGISTRATION_FAILED\",\r\n        message: `Failed to register init event: ${error instanceof Error ? error.message : String(error)}`,\r\n        details: error,\r\n      });\r\n    }\r\n  }\r\n\r\n  onReady(callback: () => void): Result<void, PlatformBootstrapEventError> {\r\n    if (typeof Hooks === \"undefined\") {\r\n      return err({\r\n        code: \"PLATFORM_NOT_AVAILABLE\",\r\n        message: \"Foundry Hooks API not available\",\r\n      });\r\n    }\r\n\r\n    try {\r\n      Hooks.on(\"ready\", callback);\r\n      return ok(undefined);\r\n    } catch (error) {\r\n      return err({\r\n        code: \"EVENT_REGISTRATION_FAILED\",\r\n        message: `Failed to register ready event: ${error instanceof Error ? error.message : String(error)}`,\r\n        details: error,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for FoundryBootstrapEventAdapter.\r\n * No dependencies - uses global Foundry Hooks API directly.\r\n */\r\nexport class DIFoundryBootstrapEventAdapter extends FoundryBootstrapEventAdapter {\r\n  static dependencies = [] as const;\r\n}\r\n","/**\r\n * Injection token for the RetryService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\n\r\n/**\r\n * Injection token for the RetryService.\r\n *\r\n * Provides retry operations with exponential backoff and automatic logging.\r\n * Automatically injects Logger and MetricsCollector.\r\n *\r\n * @example\r\n * ```typescript\r\n * const retryService = container.resolve(retryServiceToken);\r\n * const result = await retryService.retry(\r\n *   () => fetchData(),\r\n *   { maxAttempts: 3, operationName: \"fetchData\" }\r\n * );\r\n * ```\r\n */\r\nexport const retryServiceToken = createInjectionToken<RetryService>(\"RetryService\");\r\n","/**\r\n * Port Loading Concern - Single Responsibility: Lazy loading and versioning of Foundry ports.\r\n *\r\n * This class extracts the port loading logic from FoundryServiceBase to follow SRP.\r\n * It handles:\r\n * - Lazy initialization of ports\r\n * - Version-based port selection via PortSelector\r\n * - Port caching after first load\r\n *\r\n * @template TPort - The port interface type (e.g., FoundryGame, FoundryHooks)\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\n\r\n/**\r\n * Loads and caches Foundry ports based on version selection.\r\n * Implements lazy loading: ports are only loaded when first requested.\r\n *\r\n * @template TPort - The port interface type\r\n */\r\nexport class PortLoader<TPort> {\r\n  private port: TPort | null = null;\r\n  private readonly portSelector: PortSelector;\r\n  private readonly portRegistry: PortRegistry<TPort>;\r\n\r\n  constructor(portSelector: PortSelector, portRegistry: PortRegistry<TPort>) {\r\n    this.portSelector = portSelector;\r\n    this.portRegistry = portRegistry;\r\n  }\r\n\r\n  /**\r\n   * Lazy-loads the appropriate port based on Foundry version.\r\n   * Uses PortSelector with token-based selection to resolve ports from the DI container.\r\n   *\r\n   * CRITICAL: This prevents crashes when newer port constructors access\r\n   * APIs not available in the current Foundry version. Ports are resolved\r\n   * from the DI container, ensuring DIP (Dependency Inversion Principle) compliance.\r\n   *\r\n   * @param adapterName - Name for logging purposes (e.g., \"FoundryGame\")\r\n   * @returns Result containing the port or a FoundryError if no compatible port can be selected\r\n   */\r\n  loadPort(adapterName: string): Result<TPort, FoundryError> {\r\n    if (this.port === null) {\r\n      const tokens = this.portRegistry.getTokens();\r\n      const portResult = this.portSelector.selectPortFromTokens(tokens, undefined, adapterName);\r\n      if (!portResult.ok) {\r\n        return portResult;\r\n      }\r\n      this.port = portResult.value;\r\n    }\r\n    // At this point, this.port is guaranteed to be non-null\r\n    return { ok: true, value: this.port as TPort };\r\n  }\r\n\r\n  /**\r\n   * Gets the currently loaded port without triggering lazy loading.\r\n   * Useful for operations that don't need retry logic but need to check if port is loaded.\r\n   *\r\n   * @returns The loaded port or null if not yet loaded\r\n   */\r\n  getLoadedPort(): TPort | null {\r\n    return this.port;\r\n  }\r\n\r\n  /**\r\n   * Clears the cached port.\r\n   * This forces the next loadPort() call to reload the port.\r\n   * Useful for testing or when ports need to be refreshed.\r\n   */\r\n  clearCache(): void {\r\n    this.port = null;\r\n  }\r\n}\r\n","/**\r\n * Retry Concern - Single Responsibility: Retry logic for Foundry API operations.\r\n *\r\n * This class extracts the retry logic from FoundryServiceBase to follow SRP.\r\n * It handles:\r\n * - Retry logic for synchronous operations\r\n * - Retry logic for asynchronous operations\r\n * - Automatic error mapping to FoundryError\r\n *\r\n * WHY RETRY FOR FOUNDRY API?\r\n * Foundry VTT APIs can have transient failures:\r\n * - Race conditions (game.journal not yet initialized)\r\n * - Timing issues (DOM not ready, settings not loaded)\r\n * - Port selection failures (version detection glitches)\r\n *\r\n * A single retry (maxAttempts: 2) catches 90% of transient errors\r\n * without performance impact.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\n\r\n/**\r\n * Wrapper for executing Foundry API operations with automatic retry on transient failures.\r\n *\r\n * Provides a clean API for retry logic, mapping exceptions to FoundryError.\r\n * Use this for any port method call to handle transient failures.\r\n */\r\nexport class RetryableOperation {\r\n  private readonly retryService: RetryService;\r\n\r\n  constructor(retryService: RetryService) {\r\n    this.retryService = retryService;\r\n  }\r\n\r\n  /**\r\n   * Executes a Foundry API operation with automatic retry on transient failures.\r\n   *\r\n   * Use this for any port method call to handle:\r\n   * - Race conditions (Foundry not fully initialized)\r\n   * - Timing issues (DOM/Settings not ready)\r\n   * - Transient port selection failures\r\n   *\r\n   * @template T - The success type\r\n   * @param fn - Function to execute (should call port methods)\r\n   * @param operationName - Operation name for logging (e.g., \"FoundryGame.getJournalEntries\")\r\n   * @param maxAttempts - Max retry attempts (default: 2 = 1 retry)\r\n   * @returns Result from operation or mapped error\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = retryable.execute(\r\n   *   () => {\r\n   *     const portResult = portLoader.loadPort(\"FoundryGame\");\r\n   *     if (!portResult.ok) return portResult;\r\n   *     return portResult.value.getJournalEntries();\r\n   *   },\r\n   *   \"FoundryGame.getJournalEntries\"\r\n   * );\r\n   * ```\r\n   */\r\n  execute<T>(\r\n    fn: () => Result<T, FoundryError>,\r\n    operationName: string,\r\n    maxAttempts: number = 2\r\n  ): Result<T, FoundryError> {\r\n    return this.retryService.retrySync(fn, {\r\n      maxAttempts,\r\n      operationName,\r\n      mapException: (error, _attempt) => ({\r\n        code: \"OPERATION_FAILED\" as const,\r\n        message: `${operationName} failed: ${String(error)}`,\r\n        cause: error instanceof Error ? error : undefined,\r\n      }),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Async variant of execute for async operations.\r\n   *\r\n   * @template T - The success type\r\n   * @param fn - Async function to execute\r\n   * @param operationName - Operation name for logging\r\n   * @param maxAttempts - Max retry attempts (default: 2)\r\n   * @returns Promise resolving to Result\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await retryable.executeAsync(\r\n   *   async () => {\r\n   *     const portResult = portLoader.loadPort(\"FoundryDocument\");\r\n   *     if (!portResult.ok) return portResult;\r\n   *     return await portResult.value.setFlag(doc, scope, key, value);\r\n   *   },\r\n   *   \"FoundryDocument.setFlag\"\r\n   * );\r\n   * ```\r\n   */\r\n  async executeAsync<T>(\r\n    fn: () => Promise<Result<T, FoundryError>>,\r\n    operationName: string,\r\n    maxAttempts: number = 2\r\n  ): Promise<Result<T, FoundryError>> {\r\n    return this.retryService.retry(fn, {\r\n      maxAttempts,\r\n      delayMs: 100, // 100ms delay between retries\r\n      operationName,\r\n      mapException: (error, _attempt) => ({\r\n        code: \"OPERATION_FAILED\" as const,\r\n        message: `${operationName} failed: ${String(error)}`,\r\n        cause: error instanceof Error ? error : undefined,\r\n      }),\r\n    });\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformModuleReadyPort,\r\n  PlatformModuleReadyError,\r\n} from \"@/domain/ports/platform-module-ready-port.interface\";\r\nimport type { FoundryModule } from \"../interfaces/FoundryModule\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport { createFoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryModulePortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-module-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { moduleIdToken } from \"@/infrastructure/shared/tokens/infrastructure/module-id.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\n\r\n/**\r\n * Port wrapper for FoundryModule that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundryModuleReadyPort implements PlatformModuleReadyPort, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryModule>;\r\n  private readonly retryable: RetryableOperation;\r\n  private readonly moduleId: string;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryModule>,\r\n    retryService: RetryService,\r\n    moduleId: string\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n    this.moduleId = moduleId;\r\n  }\r\n\r\n  setReady(): Result<void, PlatformModuleReadyError> {\r\n    const result = this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryModule\");\r\n      if (!portResult.ok) {\r\n        return {\r\n          ok: false,\r\n          error: createFoundryError(\r\n            \"PORT_SELECTION_FAILED\",\r\n            portResult.error.message,\r\n            portResult.error.details\r\n          ),\r\n        } as Result<void, FoundryError>;\r\n      }\r\n\r\n      const success = portResult.value.setModuleReady(this.moduleId);\r\n      if (!success) {\r\n        return {\r\n          ok: false,\r\n          error: createFoundryError(\"OPERATION_FAILED\", `Module ${this.moduleId} not found`),\r\n        } as Result<void, FoundryError>;\r\n      }\r\n\r\n      return { ok: true, value: undefined };\r\n    }, \"FoundryModule.setReady\");\r\n\r\n    // Map FoundryError to PlatformModuleReadyError\r\n    if (!result.ok) {\r\n      let errorCode: PlatformModuleReadyError[\"code\"];\r\n      if (\r\n        result.error.code === \"PORT_SELECTION_FAILED\" ||\r\n        result.error.code === \"API_NOT_AVAILABLE\"\r\n      ) {\r\n        errorCode = \"PLATFORM_NOT_AVAILABLE\";\r\n      } else if (result.error.code === \"OPERATION_FAILED\") {\r\n        errorCode = \"OPERATION_FAILED\";\r\n      } else {\r\n        errorCode = \"OPERATION_FAILED\";\r\n      }\r\n\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: errorCode,\r\n          message: result.error.message,\r\n          details: result.error.details,\r\n        },\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for FoundryModuleReadyPort.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIFoundryModuleReadyPort extends FoundryModuleReadyPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryModulePortRegistryToken,\r\n    retryServiceToken,\r\n    moduleIdToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryModule>,\r\n    retryService: RetryService,\r\n    moduleId: string\r\n  ) {\r\n    super(portSelector, portRegistry, retryService, moduleId);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { platformBootstrapEventPortToken } from \"@/infrastructure/shared/tokens/ports/platform-bootstrap-event-port.token\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { metricsRecorderToken } from \"@/infrastructure/shared/tokens/observability/metrics-recorder.token\";\r\nimport { metricsSamplerToken } from \"@/infrastructure/shared/tokens/observability/metrics-sampler.token\";\r\nimport { metricsReporterToken } from \"@/infrastructure/shared/tokens/observability/metrics-reporter.token\";\r\nimport { traceContextToken } from \"@/infrastructure/shared/tokens/observability/trace-context.token\";\r\nimport { metricsStorageToken } from \"@/infrastructure/shared/tokens/observability/metrics-storage.token\";\r\nimport { metricsAggregatorToken } from \"@/infrastructure/shared/tokens/observability/metrics-aggregator.token\";\r\nimport { metricsPersistenceManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-persistence-manager.token\";\r\nimport { metricsStateManagerToken } from \"@/infrastructure/shared/tokens/observability/metrics-state-manager.token\";\r\nimport { moduleApiInitializerToken } from \"@/infrastructure/shared/tokens/infrastructure/module-api-initializer.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { moduleHealthServiceToken } from \"@/infrastructure/shared/tokens/core/module-health-service.token\";\r\nimport { healthCheckRegistryToken } from \"@/application/tokens/health-check-registry.token\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { bootstrapInitHookServiceToken } from \"@/infrastructure/shared/tokens/core/bootstrap-init-hook-service.token\";\r\nimport { bootstrapReadyHookServiceToken } from \"@/infrastructure/shared/tokens/core/bootstrap-ready-hook-service.token\";\r\nimport { DIMetricsCollector } from \"@/infrastructure/observability/metrics-collector\";\r\nimport { DIPersistentMetricsCollector } from \"@/infrastructure/observability/metrics-persistence/persistent-metrics-collector\";\r\nimport { MetricsAggregator } from \"@/infrastructure/observability/metrics-aggregator\";\r\nimport { MetricsPersistenceManager } from \"@/infrastructure/observability/metrics-persistence/metrics-persistence-manager\";\r\nimport { MetricsStateManager } from \"@/infrastructure/observability/metrics-state/metrics-state-manager\";\r\nimport { DIMetricsSampler } from \"@/infrastructure/observability/metrics-sampler\";\r\nimport { DIMetricsReporter } from \"@/infrastructure/observability/metrics-reporter\";\r\nimport { createMetricsStorage } from \"@/infrastructure/observability/metrics-persistence/metrics-storage-factory\";\r\nimport { DIConsoleLoggerService } from \"@/infrastructure/logging/ConsoleLoggerService\";\r\nimport { DITraceContext } from \"@/infrastructure/observability/trace/TraceContext\";\r\nimport { DIModuleHealthService } from \"@/application/services/ModuleHealthService\";\r\nimport { DIModuleApiInitializer } from \"@/framework/core/api/module-api-initializer\";\r\nimport { HealthCheckRegistryAdapter } from \"@/infrastructure/health/health-check-registry-adapter\";\r\nimport { DIBootstrapInitHookService } from \"@/framework/core/bootstrap-init-hook\";\r\nimport { DIBootstrapReadyHookService } from \"@/framework/core/bootstrap-ready-hook\";\r\nimport { DIFoundryBootstrapEventAdapter } from \"@/infrastructure/adapters/foundry/bootstrap-hooks-adapter\";\r\nimport {\r\n  DIModuleReadyService,\r\n  moduleReadyServiceToken,\r\n} from \"@/application/services/module-ready-service\";\r\nimport { platformModuleReadyPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { DIFoundryModuleReadyPort } from \"@/infrastructure/adapters/foundry/services/FoundryModuleReadyPort\";\r\n\r\n/**\r\n * Registers core infrastructure services.\r\n *\r\n * Services registered:\r\n * - MetricsAggregator (singleton, no dependencies) - DIP: injected into MetricsCollector\r\n * - MetricsPersistenceManager (singleton, no dependencies) - DIP: injected into MetricsCollector\r\n * - MetricsStateManager (singleton, no dependencies) - DIP: injected into MetricsCollector\r\n * - MetricsCollector (singleton, deps: [runtimeConfigToken, metricsAggregatorToken, metricsPersistenceManagerToken, metricsStateManagerToken])\r\n * - MetricsSampler (singleton, deps: [runtimeConfigToken]) - separate service for SRP\r\n * - MetricsReporter (singleton, deps: [metricsCollectorToken, loggerToken]) - separate service for SRP\r\n * - MetricsRecorder (alias to MetricsCollector) - for backward compatibility\r\n * - Logger (singleton, self-configuring via RuntimeConfigService, optional TraceContext)\r\n * - TraceContext (singleton, deps: [loggerToken])\r\n * - HealthCheckRegistry (singleton)\r\n * - ContainerHealthCheck (singleton, auto-registered)\r\n * - MetricsHealthCheck (singleton, auto-registered)\r\n * - ModuleHealthService (singleton, uses HealthCheckRegistry)\r\n * - ModuleApiInitializer (singleton, handles API exposition)\r\n *\r\n * INITIALIZATION ORDER:\r\n * 1. MetricsAggregator (no dependencies)\r\n * 2. MetricsPersistenceManager (no dependencies)\r\n * 3. MetricsStateManager (no dependencies)\r\n * 4. MetricsCollector (deps: [runtimeConfigToken, metricsAggregatorToken, metricsPersistenceManagerToken, metricsStateManagerToken])\r\n * 5. MetricsSampler (deps: [runtimeConfigToken])\r\n * 6. TraceContext (no dependencies)\r\n * 7. Logger (klassische DI mit deps: [runtimeConfigToken, traceContextToken])\r\n * 8. MetricsReporter (deps: [metricsCollectorToken, loggerToken])\r\n * 9. HealthCheckRegistry (no dependencies)\r\n * 10. ContainerHealthCheck & MetricsHealthCheck (auto-register to registry)\r\n * 11. ModuleHealthService (deps: [healthCheckRegistryToken])\r\n * 12. ModuleApiInitializer (no dependencies)\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerCoreServices(container: ServiceContainer): Result<void, string> {\r\n  const runtimeConfig = container.getRegisteredValue(runtimeConfigToken);\r\n  if (!runtimeConfig) {\r\n    return err(\"RuntimeConfigService not registered\");\r\n  }\r\n  const enablePersistence = runtimeConfig.get(\"enableMetricsPersistence\") === true;\r\n\r\n  // Register MetricsAggregator (DIP: dependency for MetricsCollector)\r\n  const aggregatorResult = container.registerClass(\r\n    metricsAggregatorToken,\r\n    MetricsAggregator,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(aggregatorResult)) {\r\n    return err(`Failed to register MetricsAggregator: ${aggregatorResult.error.message}`);\r\n  }\r\n\r\n  // Register MetricsPersistenceManager (DIP: dependency for MetricsCollector)\r\n  const persistenceManagerResult = container.registerClass(\r\n    metricsPersistenceManagerToken,\r\n    MetricsPersistenceManager,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(persistenceManagerResult)) {\r\n    return err(\r\n      `Failed to register MetricsPersistenceManager: ${persistenceManagerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register MetricsStateManager (DIP: dependency for MetricsCollector)\r\n  const stateManagerResult = container.registerClass(\r\n    metricsStateManagerToken,\r\n    MetricsStateManager,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(stateManagerResult)) {\r\n    return err(`Failed to register MetricsStateManager: ${stateManagerResult.error.message}`);\r\n  }\r\n\r\n  if (enablePersistence) {\r\n    const metricsKey =\r\n      runtimeConfig.get(\"metricsPersistenceKey\") ?? \"fvtt_relationship_app_module.metrics\";\r\n    const storageInstance = createMetricsStorage(metricsKey);\r\n    const storageResult = container.registerValue(metricsStorageToken, storageInstance);\r\n    if (isErr(storageResult)) {\r\n      return err(`Failed to register MetricsStorage: ${storageResult.error.message}`);\r\n    }\r\n\r\n    const persistentResult = container.registerClass(\r\n      metricsCollectorToken,\r\n      DIPersistentMetricsCollector,\r\n      ServiceLifecycle.SINGLETON\r\n    );\r\n    if (isErr(persistentResult)) {\r\n      return err(\r\n        `Failed to register PersistentMetricsCollector: ${persistentResult.error.message}`\r\n      );\r\n    }\r\n  } else {\r\n    const metricsResult = container.registerClass(\r\n      metricsCollectorToken,\r\n      DIMetricsCollector,\r\n      ServiceLifecycle.SINGLETON\r\n    );\r\n    if (isErr(metricsResult)) {\r\n      return err(`Failed to register MetricsCollector: ${metricsResult.error.message}`);\r\n    }\r\n  }\r\n\r\n  // Register MetricsSampler (separate service for SRP - Single Responsibility Principle)\r\n  const samplerResult = container.registerClass(\r\n    metricsSamplerToken,\r\n    DIMetricsSampler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(samplerResult)) {\r\n    return err(`Failed to register MetricsSampler: ${samplerResult.error.message}`);\r\n  }\r\n\r\n  // Register MetricsRecorder as alias to MetricsCollector (for backward compatibility)\r\n  // MetricsSampler is now a separate service, not an alias\r\n  container.registerAlias(metricsRecorderToken, metricsCollectorToken);\r\n\r\n  // Register TraceContext first (no dependencies)\r\n  // TraceContext must be registered before Logger to avoid circular dependency\r\n  const traceContextResult = container.registerClass(\r\n    traceContextToken,\r\n    DITraceContext,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(traceContextResult)) {\r\n    return err(`Failed to register TraceContext: ${traceContextResult.error.message}`);\r\n  }\r\n\r\n  // Register Logger with class injection (EnvironmentConfig + TraceContext)\r\n  const loggerResult = container.registerClass(\r\n    loggerToken,\r\n    DIConsoleLoggerService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(loggerResult)) {\r\n    return err(`Failed to register Logger: ${loggerResult.error.message}`);\r\n  }\r\n\r\n  // Register MetricsReporter (separate service for SRP - Single Responsibility Principle)\r\n  // Must be registered after Logger (depends on loggerToken)\r\n  const reporterResult = container.registerClass(\r\n    metricsReporterToken,\r\n    DIMetricsReporter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(reporterResult)) {\r\n    return err(`Failed to register MetricsReporter: ${reporterResult.error.message}`);\r\n  }\r\n\r\n  // Register HealthCheckRegistry (but don't resolve yet - needs container validation first)\r\n  const registryResult = container.registerClass(\r\n    healthCheckRegistryToken,\r\n    HealthCheckRegistryAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(registryResult)) {\r\n    return err(`Failed to register HealthCheckRegistry: ${registryResult.error.message}`);\r\n  }\r\n\r\n  // Register ModuleHealthService (uses HealthCheckRegistry)\r\n  const healthResult = container.registerClass(\r\n    moduleHealthServiceToken,\r\n    DIModuleHealthService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(healthResult)) {\r\n    return err(`Failed to register ModuleHealthService: ${healthResult.error.message}`);\r\n  }\r\n\r\n  // Register ModuleApiInitializer (no dependencies, handles API exposition)\r\n  const apiInitResult = container.registerClass(\r\n    moduleApiInitializerToken,\r\n    DIModuleApiInitializer,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(apiInitResult)) {\r\n    return err(`Failed to register ModuleApiInitializer: ${apiInitResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformBootstrapEventPort (no dependencies, uses direct platform API)\r\n  // Must be registered before Bootstrap services that depend on it\r\n  const bootstrapEventsResult = container.registerClass(\r\n    platformBootstrapEventPortToken,\r\n    DIFoundryBootstrapEventAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(bootstrapEventsResult)) {\r\n    return err(\r\n      `Failed to register PlatformBootstrapEventPort: ${bootstrapEventsResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register BootstrapInitHookService (deps: [loggerToken, serviceContainerToken, platformBootstrapEventPortToken])\r\n  const initHookResult = container.registerClass(\r\n    bootstrapInitHookServiceToken,\r\n    DIBootstrapInitHookService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(initHookResult)) {\r\n    return err(`Failed to register BootstrapInitHookService: ${initHookResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformModuleReadyPort (must be before ModuleReadyService)\r\n  // NOTE: This is a Foundry-specific port, but we register it here because ModuleReadyService needs it\r\n  const moduleReadyPortResult = container.registerClass(\r\n    platformModuleReadyPortToken,\r\n    DIFoundryModuleReadyPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(moduleReadyPortResult)) {\r\n    return err(\r\n      `Failed to register PlatformModuleReadyPort: ${moduleReadyPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ModuleReadyService (deps: [platformModuleReadyPortToken, loggerToken])\r\n  // Must be registered before BootstrapReadyHookService which depends on it\r\n  const moduleReadyResult = container.registerClass(\r\n    moduleReadyServiceToken,\r\n    DIModuleReadyService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(moduleReadyResult)) {\r\n    return err(`Failed to register ModuleReadyService: ${moduleReadyResult.error.message}`);\r\n  }\r\n\r\n  // Register BootstrapReadyHookService (deps: [loggerToken, platformBootstrapEventPortToken, moduleReadyServiceToken])\r\n  const readyHookResult = container.registerClass(\r\n    bootstrapReadyHookServiceToken,\r\n    DIBootstrapReadyHookService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(readyHookResult)) {\r\n    return err(`Failed to register BootstrapReadyHookService: ${readyHookResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"CoreServices\",\r\n  priority: 20,\r\n  execute: registerCoreServices,\r\n});\r\n","/**\r\n * Injection token for the ObservabilityRegistry.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { ObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\n\r\n/**\r\n * Injection token for the ObservabilityRegistry.\r\n *\r\n * Central registry for self-registering observable services.\r\n * Services register themselves at construction time for automatic observability.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(observability: ObservabilityRegistry) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport const observabilityRegistryToken =\r\n  createInjectionToken<ObservabilityRegistry>(\"ObservabilityRegistry\");\r\n","/**\r\n * Event system for PortSelector observability.\r\n *\r\n * **Design Rationale:**\r\n * - Decouples PortSelector from logging and metrics concerns\r\n * - Follows Observer Pattern for extensible observability\r\n * - Reduces PortSelector dependencies from 3 to 0\r\n * - Allows multiple observers without modifying PortSelector\r\n *\r\n * @see PortSelector for event emission\r\n * @see PortSelectionObserver for event consumption\r\n */\r\n\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\n\r\nexport type PortSelectionSuccessEvent = {\r\n  type: \"success\";\r\n  selectedVersion: number;\r\n  foundryVersion: number;\r\n  durationMs: number;\r\n  adapterName?: string;\r\n};\r\n\r\nexport type PortSelectionFailureEvent = {\r\n  type: \"failure\";\r\n  foundryVersion: number;\r\n  availableVersions: string;\r\n  adapterName?: string;\r\n  error: FoundryError;\r\n};\r\n\r\nexport type PortSelectionEvent = PortSelectionSuccessEvent | PortSelectionFailureEvent;\r\nexport type PortSelectionEventCallback = (event: PortSelectionEvent) => void;\r\n\r\n/**\r\n * Simple observable emitter used by the PortSelector to notify interested\r\n * observers about success/failure outcomes.\r\n */\r\nexport class PortSelectionEventEmitter {\r\n  private readonly subscribers = new Set<PortSelectionEventCallback>();\r\n\r\n  subscribe(callback: PortSelectionEventCallback): () => void {\r\n    this.subscribers.add(callback);\r\n    let active = true;\r\n\r\n    return () => {\r\n      if (!active) {\r\n        return;\r\n      }\r\n      active = false;\r\n      this.subscribers.delete(callback);\r\n    };\r\n  }\r\n\r\n  emit(event: PortSelectionEvent): void {\r\n    for (const callback of this.subscribers) {\r\n      try {\r\n        callback(event);\r\n      } catch (error) {\r\n        console.error(\"PortSelectionEventEmitter subscriber error\", error);\r\n      }\r\n    }\r\n  }\r\n\r\n  clear(): void {\r\n    this.subscribers.clear();\r\n  }\r\n\r\n  getSubscriberCount(): number {\r\n    return this.subscribers.size;\r\n  }\r\n}\r\n\r\nexport class DIPortSelectionEventEmitter extends PortSelectionEventEmitter {\r\n  static dependencies = [] as const;\r\n}\r\n","import type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { MetricsRecorder } from \"./interfaces/metrics-recorder\";\r\nimport type { PortSelectionEvent } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\nimport { metricsRecorderToken } from \"@/infrastructure/shared/tokens/observability/metrics-recorder.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\n\r\n/**\r\n * Observable service interface.\r\n * Services implementing this can be registered for observability.\r\n */\r\nexport interface ObservableService<TEvent = unknown> {\r\n  onEvent(callback: (event: TEvent) => void): () => void;\r\n}\r\n\r\n/**\r\n * ObservabilityRegistry\r\n *\r\n * Central registry for self-registering observable services.\r\n * Routes events to appropriate observers based on event type.\r\n *\r\n * DESIGN: Services register themselves via constructor injection.\r\n *\r\n * @example\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(observability: ObservabilityRegistry) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport class ObservabilityRegistry {\r\n  private readonly subscriptions: Array<() => void> = [];\r\n\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly metrics: MetricsRecorder\r\n  ) {}\r\n\r\n  /**\r\n   * Register a PortSelector for observability.\r\n   * Wires event emission to logging and metrics.\r\n   *\r\n   * @param service - Observable service that emits PortSelectionEvents\r\n   */\r\n  registerPortSelector(service: ObservableService<PortSelectionEvent>): void {\r\n    const unsubscribe = service.onEvent((event) => {\r\n      if (event.type === \"success\") {\r\n        const adapterSuffix = event.adapterName ? ` for ${event.adapterName}` : \"\";\r\n        this.logger.debug(\r\n          `Port v${event.selectedVersion} selected in ${event.durationMs.toFixed(2)}ms${adapterSuffix}`\r\n        );\r\n        this.metrics.recordPortSelection(event.selectedVersion);\r\n      } else {\r\n        this.logger.error(\"Port selection failed\", {\r\n          foundryVersion: event.foundryVersion,\r\n          availableVersions: event.availableVersions,\r\n          adapterName: event.adapterName,\r\n        });\r\n        this.metrics.recordPortSelectionFailure(event.foundryVersion);\r\n      }\r\n    });\r\n\r\n    this.subscriptions.push(unsubscribe);\r\n  }\r\n\r\n  /**\r\n   * Disposes all registered observers and clears internal state.\r\n   * Intended to be called when the DI container is disposed.\r\n   */\r\n  dispose(): void {\r\n    while (this.subscriptions.length > 0) {\r\n      const unsubscribe = this.subscriptions.pop();\r\n      try {\r\n        unsubscribe?.();\r\n      } catch {\r\n        // Swallow errors during dispose to avoid masking shutdown failures\r\n      }\r\n    }\r\n  }\r\n\r\n  // Future: Add more registration methods for other observable services\r\n  // registerSomeOtherService(service: ObservableService<OtherEvent>): void { ... }\r\n}\r\n\r\nexport class DIObservabilityRegistry extends ObservabilityRegistry {\r\n  static dependencies = [loggerToken, metricsRecorderToken] as const;\r\n\r\n  constructor(logger: Logger, metrics: MetricsRecorder) {\r\n    super(logger, metrics);\r\n  }\r\n}\r\n","import type { ObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\nimport type { PortSelector } from \"./portselector\";\r\nimport type { PortSelectionObserver } from \"./port-selection-observer\";\r\nimport type { IPortSelectionObservability } from \"./port-selection-observability.interface\";\r\n\r\n/**\r\n * Handles observability setup for PortSelector.\r\n * Manages self-registration with ObservabilityRegistry.\r\n *\r\n * **Responsibilities:**\r\n * - Register PortSelector with ObservabilityRegistry\r\n * - Setup observability wiring (selector → observer)\r\n * - No business logic, pure observability setup\r\n */\r\nexport class PortSelectionObservability implements IPortSelectionObservability {\r\n  constructor(private readonly observabilityRegistry: ObservabilityRegistry) {}\r\n\r\n  /**\r\n   * Register PortSelector with ObservabilityRegistry.\r\n   * This enables automatic logging and metrics collection.\r\n   */\r\n  registerWithObservabilityRegistry(selector: PortSelector): void {\r\n    this.observabilityRegistry.registerPortSelector(selector);\r\n  }\r\n\r\n  /**\r\n   * Setup observability for PortSelector.\r\n   * Wires PortSelector events to PortSelectionObserver.\r\n   */\r\n  setupObservability(selector: PortSelector, observer: PortSelectionObserver): void {\r\n    // Subscribe to PortSelector events and forward to observer\r\n    selector.onEvent((event) => {\r\n      observer.handleEvent(event);\r\n    });\r\n  }\r\n}\r\n\r\n// DI-Wrapper-Klasse - Import am Ende, um zirkuläre Abhängigkeiten zu vermeiden\r\nimport { observabilityRegistryToken } from \"@/infrastructure/shared/tokens/observability/observability-registry.token\";\r\n\r\nexport class DIPortSelectionObservability extends PortSelectionObservability {\r\n  static dependencies = [observabilityRegistryToken] as const;\r\n\r\n  constructor(observabilityRegistry: ObservabilityRegistry) {\r\n    super(observabilityRegistry);\r\n  }\r\n}\r\n","import type { IPortSelectionPerformanceTracker } from \"./port-selection-performance-tracker.interface\";\r\n\r\n/**\r\n * Handles performance tracking for PortSelector operations.\r\n * Uses performance.now() for high-resolution timing.\r\n *\r\n * **Responsibilities:**\r\n * - Start performance tracking\r\n * - End performance tracking and calculate duration\r\n * - No business logic, pure performance measurement\r\n */\r\nexport class PortSelectionPerformanceTracker implements IPortSelectionPerformanceTracker {\r\n  private startTime: number | undefined;\r\n\r\n  /**\r\n   * Start performance tracking.\r\n   * Records the current high-resolution timestamp.\r\n   */\r\n  startTracking(): void {\r\n    this.startTime = performance.now();\r\n  }\r\n\r\n  /**\r\n   * End performance tracking and return duration in milliseconds.\r\n   * @returns Duration in milliseconds, or 0 if tracking was not started\r\n   */\r\n  endTracking(): number {\r\n    if (this.startTime === undefined) {\r\n      return 0;\r\n    }\r\n    const durationMs = performance.now() - this.startTime;\r\n    this.startTime = undefined; // Reset for next tracking\r\n    return durationMs;\r\n  }\r\n}\r\n\r\n// DI-Wrapper-Klasse - Import am Ende, um zirkuläre Abhängigkeiten zu vermeiden\r\n// Keine Token-Imports nötig, da keine Dependencies\r\n\r\nexport class DIPortSelectionPerformanceTracker extends PortSelectionPerformanceTracker {\r\n  static dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","/**\r\n * Observer for PortSelector events that handles observability concerns.\r\n *\r\n * **Design Rationale:**\r\n * - Separates observability logic from port selection logic\r\n * - PortSelector remains focused on its core responsibility\r\n * - Observability can be easily extended without modifying PortSelector\r\n * - Testable in isolation\r\n *\r\n * @see PortSelector for event emission\r\n * @see PortSelectionEventEmitter for event infrastructure\r\n */\r\n\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { MetricsRecorder } from \"@/infrastructure/observability/interfaces/metrics-recorder\";\r\nimport type { PortSelectionEvent } from \"./port-selection-events\";\r\nimport type { PortSelectionEventEmitter } from \"./port-selection-events\";\r\n\r\n/**\r\n * Observes port selection events and handles logging and metrics.\r\n *\r\n * **Responsibilities:**\r\n * - Log port selection success/failure\r\n * - Record port selection metrics\r\n * - Emit events via EventEmitter (for other listeners)\r\n * - No business logic, pure observability\r\n *\r\n * @example\r\n * ```typescript\r\n * const observer = new PortSelectionObserver(logger, metricsRecorder, eventEmitter);\r\n * portSelector.onEvent((event) => observer.handleEvent(event));\r\n * ```\r\n */\r\nexport class PortSelectionObserver {\r\n  constructor(\r\n    private readonly logger: Logger,\r\n    private readonly metrics: MetricsRecorder,\r\n    private readonly eventEmitter: PortSelectionEventEmitter\r\n  ) {}\r\n\r\n  /**\r\n   * Handle a port selection event.\r\n   *\r\n   * Performs appropriate logging, metrics recording, and event emission.\r\n   *\r\n   * @param event - The port selection event to handle\r\n   */\r\n  handleEvent(event: PortSelectionEvent): void {\r\n    // Emit event via EventEmitter for other listeners (e.g., ObservabilityRegistry)\r\n    this.eventEmitter.emit(event);\r\n\r\n    // Handle observability concerns\r\n    if (event.type === \"success\") {\r\n      this.handleSuccess(event);\r\n    } else {\r\n      this.handleFailure(event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle successful port selection.\r\n   *\r\n   * Logs debug message and records metrics.\r\n   */\r\n  private handleSuccess(event: PortSelectionEvent & { type: \"success\" }): void {\r\n    // Log success with detailed information\r\n    this.logger.debug(\r\n      `Port selection completed in ${event.durationMs.toFixed(2)}ms (selected: v${event.selectedVersion}${event.adapterName ? ` for ${event.adapterName}` : \"\"})`\r\n    );\r\n\r\n    // Record successful port selection in metrics\r\n    this.metrics.recordPortSelection(event.selectedVersion);\r\n  }\r\n\r\n  /**\r\n   * Handle failed port selection.\r\n   *\r\n   * Logs error and records failure metrics.\r\n   */\r\n  private handleFailure(event: PortSelectionEvent & { type: \"failure\" }): void {\r\n    // Log failure with diagnostic information\r\n    this.logger.error(\"No compatible port found\", {\r\n      foundryVersion: event.foundryVersion,\r\n      availableVersions: event.availableVersions,\r\n      adapterName: event.adapterName,\r\n    });\r\n\r\n    // Record port selection failure in metrics\r\n    this.metrics.recordPortSelectionFailure(event.foundryVersion);\r\n  }\r\n}\r\n\r\n// DI-Wrapper-Klasse - Import am Ende, um zirkuläre Abhängigkeiten zu vermeiden\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { metricsRecorderToken } from \"@/infrastructure/shared/tokens/observability/metrics-recorder.token\";\r\nimport { portSelectionEventEmitterToken } from \"@/infrastructure/shared/tokens/observability/port-selection-event-emitter.token\";\r\n\r\nexport class DIPortSelectionObserver extends PortSelectionObserver {\r\n  static dependencies = [\r\n    loggerToken,\r\n    metricsRecorderToken,\r\n    portSelectionEventEmitterToken,\r\n  ] as const;\r\n\r\n  constructor(logger: Logger, metrics: MetricsRecorder, eventEmitter: PortSelectionEventEmitter) {\r\n    super(logger, metrics, eventEmitter);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { portSelectionEventEmitterToken } from \"@/infrastructure/shared/tokens/observability/port-selection-event-emitter.token\";\r\nimport { observabilityRegistryToken } from \"@/infrastructure/shared/tokens/observability/observability-registry.token\";\r\nimport { portSelectionObservabilityToken } from \"@/infrastructure/shared/tokens/observability/port-selection-observability.token\";\r\nimport { portSelectionPerformanceTrackerToken } from \"@/infrastructure/shared/tokens/observability/port-selection-performance-tracker.token\";\r\nimport { portSelectionObserverToken } from \"@/infrastructure/shared/tokens/observability/port-selection-observer.token\";\r\nimport { DIPortSelectionEventEmitter } from \"@/infrastructure/adapters/foundry/versioning/port-selection-events\";\r\nimport { DIObservabilityRegistry } from \"@/infrastructure/observability/observability-registry\";\r\nimport { DIPortSelectionObservability } from \"@/infrastructure/adapters/foundry/versioning/port-selection-observability\";\r\nimport { DIPortSelectionPerformanceTracker } from \"@/infrastructure/adapters/foundry/versioning/port-selection-performance-tracker\";\r\nimport { DIPortSelectionObserver } from \"@/infrastructure/adapters/foundry/versioning/port-selection-observer\";\r\n\r\n/**\r\n * Registers observability infrastructure.\r\n *\r\n * Services registered:\r\n * - PortSelectionEventEmitter (TRANSIENT - new instance per service)\r\n * - ObservabilityRegistry (SINGLETON - central registry)\r\n * - PortSelectionObservability (SINGLETON - handles observability setup)\r\n * - PortSelectionPerformanceTracker (SINGLETON - handles performance tracking)\r\n * - PortSelectionObserver (SINGLETON - handles event observation)\r\n *\r\n * DESIGN PATTERN: Self-Registration\r\n * Services register themselves with ObservabilityRegistry in their constructor.\r\n * Example:\r\n * ```typescript\r\n * class PortSelector {\r\n *   constructor(observability: IPortSelectionObservability, ...) {\r\n *     observability.registerPortSelector(this);\r\n *   }\r\n * }\r\n * ```\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerObservability(container: ServiceContainer): Result<void, string> {\r\n  // Register PortSelectionEventEmitter as TRANSIENT\r\n  // Each service that needs event emission gets its own instance\r\n  const emitterResult = container.registerClass(\r\n    portSelectionEventEmitterToken,\r\n    DIPortSelectionEventEmitter,\r\n    ServiceLifecycle.TRANSIENT\r\n  );\r\n\r\n  if (isErr(emitterResult)) {\r\n    return err(`Failed to register PortSelectionEventEmitter: ${emitterResult.error.message}`);\r\n  }\r\n\r\n  // Register ObservabilityRegistry as SINGLETON\r\n  // Central registry for all observable services\r\n  const registryResult = container.registerClass(\r\n    observabilityRegistryToken,\r\n    DIObservabilityRegistry,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(registryResult)) {\r\n    return err(`Failed to register ObservabilityRegistry: ${registryResult.error.message}`);\r\n  }\r\n\r\n  // Register PortSelectionObservability as SINGLETON\r\n  // Handles observability setup for PortSelector\r\n  const observabilityResult = container.registerClass(\r\n    portSelectionObservabilityToken,\r\n    DIPortSelectionObservability,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(observabilityResult)) {\r\n    return err(\r\n      `Failed to register PortSelectionObservability: ${observabilityResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PortSelectionPerformanceTracker as SINGLETON\r\n  // Handles performance tracking for PortSelector\r\n  const performanceTrackerResult = container.registerClass(\r\n    portSelectionPerformanceTrackerToken,\r\n    DIPortSelectionPerformanceTracker,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(performanceTrackerResult)) {\r\n    return err(\r\n      `Failed to register PortSelectionPerformanceTracker: ${performanceTrackerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PortSelectionObserver as SINGLETON\r\n  // Handles event observation for PortSelector\r\n  const observerResult = container.registerClass(\r\n    portSelectionObserverToken,\r\n    DIPortSelectionObserver,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(observerResult)) {\r\n    return err(`Failed to register PortSelectionObserver: ${observerResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"Observability\",\r\n  priority: 30,\r\n  execute: registerObservability,\r\n});\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryGame } from \"../interfaces/FoundryGame\";\r\nimport type { FoundryJournalEntry } from \"../types\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryGamePortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\n\r\n/**\r\n * Port wrapper for FoundryGame that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundryGamePort implements FoundryGame, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryGame>;\r\n  private readonly retryable: RetryableOperation;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryGame>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n  }\r\n\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryGame\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getJournalEntries();\r\n    }, \"FoundryGame.getJournalEntries\");\r\n  }\r\n\r\n  getJournalEntryById(id: string): Result<FoundryJournalEntry | null, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryGame\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getJournalEntryById(id);\r\n    }, \"FoundryGame.getJournalEntryById\");\r\n  }\r\n\r\n  invalidateCache(): void {\r\n    const portResult = this.portLoader.loadPort(\"FoundryGame\");\r\n    if (portResult.ok) {\r\n      portResult.value.invalidateCache();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\nexport class DIFoundryGamePort extends FoundryGamePort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryGamePortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryGame>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryHooks } from \"../interfaces/FoundryHooks\";\r\nimport type { FoundryHookCallback } from \"../types\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type {\r\n  PlatformEventPort,\r\n  EventRegistrationId,\r\n  PlatformEventError,\r\n} from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryHooksPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Type-safe interface for Foundry Hooks with dynamic hook names.\r\n * Allows calling Hooks.off() with runtime-determined hook names without using 'any'.\r\n */\r\ninterface DynamicHooksApi {\r\n  off(hookName: string, callback: (...args: unknown[]) => unknown): void;\r\n  on(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n  once(hookName: string, callback: (...args: unknown[]) => unknown): number;\r\n}\r\n\r\n/**\r\n * Port wrapper for FoundryHooks that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n * Implements both FoundryHooks (Foundry-specific) and PlatformEventPort (platform-agnostic).\r\n */\r\nexport class FoundryHooksPort implements FoundryHooks, PlatformEventPort<unknown>, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryHooks>;\r\n  private readonly retryable: RetryableOperation;\r\n  private readonly logger: Logger;\r\n  private registeredHooks = new Map<string, Map<number, FoundryHookCallback>>();\r\n  // Bidirectional mapping: callback function -> array of hook registrations (supports reused callbacks)\r\n  private callbackToIdMap = new Map<FoundryHookCallback, Array<{ hookName: string; id: number }>>();\r\n  // Mapping from registration ID to hook name for unregisterListener()\r\n  private idToHookNameMap = new Map<number, string>();\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryHooks>,\r\n    retryService: RetryService,\r\n    logger: Logger\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n    this.logger = logger;\r\n  }\r\n\r\n  on(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    const result = this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.on(hookName, callback);\r\n    }, \"FoundryHooks.on\");\r\n\r\n    if (result.ok) {\r\n      // Track registered hook for cleanup (both directions)\r\n      let hookMap = this.registeredHooks.get(hookName);\r\n      if (!hookMap) {\r\n        hookMap = new Map();\r\n        this.registeredHooks.set(hookName, hookMap);\r\n      }\r\n      hookMap.set(result.value, callback);\r\n\r\n      // Support multiple registrations of the same callback\r\n      const existing = this.callbackToIdMap.get(callback) || [];\r\n      existing.push({ hookName, id: result.value });\r\n      this.callbackToIdMap.set(callback, existing);\r\n\r\n      // Track ID to hook name for unregisterListener()\r\n      this.idToHookNameMap.set(result.value, hookName);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  once(hookName: string, callback: FoundryHookCallback): Result<number, FoundryError> {\r\n    // once() hooks are automatically deregistered by Foundry after firing\r\n    // No tracking needed - they clean themselves up\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.once(hookName, callback);\r\n    }, \"FoundryHooks.once\");\r\n  }\r\n\r\n  off(hookName: string, callbackOrId: FoundryHookCallback | number): Result<void, FoundryError> {\r\n    const result = this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryHooks\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.off(hookName, callbackOrId);\r\n    }, \"FoundryHooks.off\");\r\n\r\n    if (result.ok) {\r\n      // Remove from tracked hooks (handle both ID and callback variants)\r\n      if (typeof callbackOrId === \"number\") {\r\n        // ID variant: remove by ID\r\n        const hooks = this.registeredHooks.get(hookName);\r\n        if (hooks) {\r\n          const callback = hooks.get(callbackOrId);\r\n          hooks.delete(callbackOrId);\r\n          // Clean up bidirectional mapping - remove only this specific registration\r\n          if (callback) {\r\n            const hookInfos = this.callbackToIdMap.get(callback);\r\n            if (hookInfos) {\r\n              const filtered = hookInfos.filter(\r\n                (info) => !(info.hookName === hookName && info.id === callbackOrId)\r\n              );\r\n              if (filtered.length === 0) {\r\n                this.callbackToIdMap.delete(callback);\r\n              } else {\r\n                this.callbackToIdMap.set(callback, filtered);\r\n              }\r\n            }\r\n          }\r\n          // Remove from ID to hook name mapping\r\n          this.idToHookNameMap.delete(callbackOrId);\r\n        }\r\n      } else {\r\n        // Callback variant: lookup all registrations for this hookName via callbackToIdMap\r\n        const hookInfos = this.callbackToIdMap.get(callbackOrId);\r\n        if (hookInfos) {\r\n          // Find all registrations for this specific hookName\r\n          const matchingInfos = hookInfos.filter((info) => info.hookName === hookName);\r\n\r\n          // Remove from registeredHooks\r\n          const hooks = this.registeredHooks.get(hookName);\r\n          if (hooks) {\r\n            for (const info of matchingInfos) {\r\n              hooks.delete(info.id);\r\n            }\r\n          }\r\n\r\n          // Update callbackToIdMap - keep registrations for other hooks\r\n          const filtered = hookInfos.filter((info) => info.hookName !== hookName);\r\n          if (filtered.length === 0) {\r\n            this.callbackToIdMap.delete(callbackOrId);\r\n          } else {\r\n            this.callbackToIdMap.set(callbackOrId, filtered);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Cleans up all registered hooks.\r\n   * Called automatically when the container is disposed.\r\n   */\r\n  dispose(): void {\r\n    // Iterate through all callbacks and their registrations\r\n    for (const [callback, hookInfos] of this.callbackToIdMap) {\r\n      for (const info of hookInfos) {\r\n        try {\r\n          if (typeof Hooks !== \"undefined\") {\r\n            // Type-safe cast for dynamic hook names\r\n            // Foundry's Hooks API supports dynamic hook names, but fvtt-types\r\n            // has strict keyof HookConfig typing that doesn't allow runtime strings\r\n            (Hooks as DynamicHooksApi).off(info.hookName, callback);\r\n          }\r\n        } catch (error) {\r\n          this.logger.warn(\"Failed to unregister hook\", {\r\n            hookName: info.hookName,\r\n            hookId: info.id,\r\n            error,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    this.registeredHooks.clear();\r\n    this.callbackToIdMap.clear();\r\n    this.idToHookNameMap.clear();\r\n\r\n    // Dispose port if it implements Disposable, then clear cache\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n\r\n  // ===== PlatformEventPort Implementation =====\r\n\r\n  /**\r\n   * Register a listener for platform events.\r\n   * Delegates to FoundryHooks.on() for Foundry-specific implementation.\r\n   * Wraps the PlatformEventPort callback to receive Foundry hook arguments as an array.\r\n   */\r\n  registerListener(\r\n    eventType: string,\r\n    callback: (event: unknown) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Wrap callback: Foundry hooks pass multiple arguments, but PlatformEventPort expects single event\r\n    // We pass the arguments as an array to preserve the original Foundry hook signature\r\n    const foundryCallback: FoundryHookCallback = (...args: unknown[]): void => {\r\n      // Pass arguments as array to PlatformEventPort callback\r\n      callback(args);\r\n    };\r\n    const result = this.on(eventType, foundryCallback);\r\n\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"EVENT_REGISTRATION_FAILED\",\r\n        message: `Failed to register listener for event \"${eventType}\": ${result.error.message}`,\r\n        details: result.error,\r\n      });\r\n    }\r\n\r\n    return ok(result.value);\r\n  }\r\n\r\n  /**\r\n   * Unregister a previously registered listener.\r\n   * Requires mapping from registration ID to hook name.\r\n   */\r\n  unregisterListener(registrationId: EventRegistrationId): Result<void, PlatformEventError> {\r\n    // Convert to number if it's a string\r\n    const id =\r\n      typeof registrationId === \"string\" ? Number.parseInt(registrationId, 10) : registrationId;\r\n\r\n    if (Number.isNaN(id)) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `Invalid registration ID: ${String(registrationId)}`,\r\n      });\r\n    }\r\n\r\n    // Look up hook name from ID\r\n    const hookName = this.idToHookNameMap.get(id);\r\n    if (!hookName) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `No registration found for ID ${id}`,\r\n      });\r\n    }\r\n\r\n    // Use off() with ID\r\n    const result = this.off(hookName, id);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"EVENT_UNREGISTRATION_FAILED\",\r\n        message: `Failed to unregister listener for event \"${hookName}\": ${result.error.message}`,\r\n        details: result.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\nexport class DIFoundryHooksPort extends FoundryHooksPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryHooksPortRegistryToken,\r\n    retryServiceToken,\r\n    loggerToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryHooks>,\r\n    retryService: RetryService,\r\n    logger: Logger\r\n  ) {\r\n    super(portSelector, portRegistry, retryService, logger);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryDocument } from \"../interfaces/FoundryDocument\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryDocumentPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\nimport type * as v from \"valibot\";\r\n\r\n/**\r\n * Port wrapper for FoundryDocument that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundryDocumentPort implements FoundryDocument, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryDocument>;\r\n  private readonly retryable: RetryableOperation;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryDocument>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n  }\r\n\r\n  async create<TDocument extends { id: string }>(\r\n    documentClass: { create: (data: unknown) => Promise<TDocument> },\r\n    data: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.create(documentClass, data);\r\n    }, \"FoundryDocument.create\");\r\n  }\r\n\r\n  async update<TDocument extends { id: string }>(\r\n    document: { update: (changes: unknown) => Promise<TDocument> },\r\n    changes: unknown\r\n  ): Promise<Result<TDocument, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.update(document, changes);\r\n    }, \"FoundryDocument.update\");\r\n  }\r\n\r\n  async delete(document: { delete: () => Promise<unknown> }): Promise<Result<void, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.delete(document);\r\n    }, \"FoundryDocument.delete\");\r\n  }\r\n\r\n  getFlag<T>(\r\n    document: { getFlag: (scope: string, key: string) => unknown },\r\n    scope: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getFlag<T>(document, scope, key, schema);\r\n    }, \"FoundryDocument.getFlag\");\r\n  }\r\n\r\n  async setFlag<T = unknown>(\r\n    document: { setFlag: (scope: string, key: string, value: T) => Promise<unknown> },\r\n    scope: string,\r\n    key: string,\r\n    value: T\r\n  ): Promise<Result<void, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.setFlag(document, scope, key, value);\r\n    }, \"FoundryDocument.setFlag\");\r\n  }\r\n\r\n  async unsetFlag(\r\n    document: {\r\n      unsetFlag?: (scope: string, key: string) => Promise<unknown>;\r\n      setFlag: (scope: string, key: string, value: unknown) => Promise<unknown>;\r\n    },\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryDocument\");\r\n      if (!portResult.ok) return portResult;\r\n      return await portResult.value.unsetFlag(document, scope, key);\r\n    }, \"FoundryDocument.unsetFlag\");\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\nexport class DIFoundryDocumentPort extends FoundryDocumentPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryDocumentPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryDocument>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryNotificationOptions, FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryUIPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\n\r\n/**\r\n * Port wrapper for FoundryUI that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundryUIPort implements FoundryUI, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryUI>;\r\n  private readonly retryable: RetryableOperation;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryUI>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n  }\r\n\r\n  removeJournalDirectoryEntry(\r\n    directoryId: string,\r\n    journalId: string,\r\n    journalName: string\r\n  ): Result<void, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.removeJournalDirectoryEntry(directoryId, journalId, journalName);\r\n    }, \"FoundryUI.removeJournalDirectoryEntry\");\r\n  }\r\n\r\n  findElement(container: HTMLElement, selector: string): Result<HTMLElement | null, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.findElement(container, selector);\r\n    }, \"FoundryUI.findElement\");\r\n  }\r\n\r\n  notify(\r\n    message: string,\r\n    type: \"info\" | \"warning\" | \"error\",\r\n    options?: FoundryNotificationOptions\r\n  ): Result<void, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.notify(message, type, options);\r\n    }, \"FoundryUI.notify\");\r\n  }\r\n\r\n  getDirectoryElement(directoryId: string): Result<HTMLElement | null, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.getDirectoryElement(directoryId);\r\n    }, \"FoundryUI.getDirectoryElement\");\r\n  }\r\n\r\n  rerenderJournalDirectory(): Result<boolean, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryUI\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.rerenderJournalDirectory();\r\n    }, \"FoundryUI.rerenderJournalDirectory\");\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\nexport class DIFoundryUIPort extends FoundryUIPort {\r\n  static dependencies = [portSelectorToken, foundryUIPortRegistryToken, retryServiceToken] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryUI>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundrySettings, SettingConfig } from \"../interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundrySettingsPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\nimport type * as v from \"valibot\";\r\n\r\n/**\r\n * Port wrapper for FoundrySettings that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundrySettingsPort implements FoundrySettings, Disposable {\r\n  private readonly portLoader: PortLoader<FoundrySettings>;\r\n  private readonly retryable: RetryableOperation;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundrySettings>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n  }\r\n\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: SettingConfig<T>\r\n  ): Result<void, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.register(namespace, key, config);\r\n    }, \"FoundrySettings.register\");\r\n  }\r\n\r\n  get<T>(\r\n    namespace: string,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.get(namespace, key, schema);\r\n    }, \"FoundrySettings.get\");\r\n  }\r\n\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, FoundryError>> {\r\n    return this.retryable.executeAsync(async () => {\r\n      const portResult = this.portLoader.loadPort(\"FoundrySettings\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.set(namespace, key, value);\r\n    }, \"FoundrySettings.set\");\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\nexport class DIFoundrySettingsPort extends FoundrySettingsPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundrySettingsPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundrySettings>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","/**\r\n * Implementation of FoundryJournalFacade.\r\n *\r\n * Combines FoundryGame, FoundryDocument, and FoundryUI services\r\n * into a unified facade for journal operations.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { FoundryJournalEntry } from \"../types\";\r\nimport type { FoundryGame } from \"../interfaces/FoundryGame\";\r\nimport type { FoundryDocument } from \"../interfaces/FoundryDocument\";\r\nimport type { FoundryUI } from \"../interfaces/FoundryUI\";\r\nimport type { FoundryJournalFacade as IFoundryJournalFacade } from \"./foundry-journal-facade.interface\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { foundryDocumentToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document.token\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui.token\";\r\nimport { moduleIdToken } from \"@/infrastructure/shared/tokens/infrastructure/module-id.token\";\r\nimport { castFoundryDocumentForFlag } from \"@/infrastructure/adapters/foundry/runtime-casts\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Facade for journal-related Foundry operations.\r\n *\r\n * **Benefits:**\r\n * - Reduces JournalVisibilityService dependencies from 4 to 2 (facade + logger)\r\n * - Provides cohesive journal-specific API\r\n * - Easier to test (single facade mock instead of 3 service mocks)\r\n * - Clear boundary for journal-related operations\r\n */\r\nexport class FoundryJournalFacade implements IFoundryJournalFacade {\r\n  constructor(\r\n    private readonly game: FoundryGame,\r\n    private readonly document: FoundryDocument,\r\n    private readonly ui: FoundryUI,\r\n    private readonly moduleId: string\r\n  ) {}\r\n\r\n  /**\r\n   * Get all journal entries from Foundry.\r\n   *\r\n   * Delegates to FoundryGame.getJournalEntries().\r\n   */\r\n  getJournalEntries(): Result<FoundryJournalEntry[], FoundryError> {\r\n    return this.game.getJournalEntries();\r\n  }\r\n\r\n  /**\r\n   * Get a module flag from a journal entry with runtime validation.\r\n   *\r\n   * Delegates to FoundryDocument.getFlag() with module scope and schema.\r\n   *\r\n   * @template T - The flag value type\r\n   * @param entry - The Foundry journal entry\r\n   * @param key - The flag key\r\n   * @param schema - Valibot schema for validation\r\n   */\r\n  getEntryFlag<T>(\r\n    entry: FoundryJournalEntry,\r\n    key: string,\r\n    schema: v.BaseSchema<unknown, T, v.BaseIssue<unknown>>\r\n  ): Result<T | null, FoundryError> {\r\n    // Type widening: fvtt-types JournalEntry.getFlag has overly restrictive scope type (\"core\" only),\r\n    // but module flags use module ID as scope. Cast to generic interface is safe.\r\n    const documentResult = castFoundryDocumentForFlag(entry);\r\n    if (!documentResult.ok) {\r\n      return documentResult; // Propagate error\r\n    }\r\n    return this.document.getFlag<T>(documentResult.value, this.moduleId, key, schema);\r\n  }\r\n\r\n  /**\r\n   * Set a module flag on a journal entry.\r\n   *\r\n   * Delegates to FoundryDocument.setFlag() with module scope.\r\n   *\r\n   * @param entry - The Foundry journal entry\r\n   * @param key - The flag key\r\n   * @param value - The boolean value to set\r\n   * @returns Result indicating success or error\r\n   */\r\n  async setEntryFlag(\r\n    entry: FoundryJournalEntry,\r\n    key: string,\r\n    value: boolean\r\n  ): Promise<Result<void, FoundryError>> {\r\n    const documentResult = castFoundryDocumentForFlag(entry);\r\n    if (!documentResult.ok) {\r\n      return documentResult; // Propagate error\r\n    }\r\n    return await this.document.setFlag(documentResult.value, this.moduleId, key, value);\r\n  }\r\n}\r\n\r\nexport class DIFoundryJournalFacade extends FoundryJournalFacade {\r\n  static dependencies = [\r\n    foundryGameToken,\r\n    foundryDocumentToken,\r\n    foundryUIToken,\r\n    moduleIdToken,\r\n  ] as const;\r\n\r\n  constructor(game: FoundryGame, document: FoundryDocument, ui: FoundryUI, moduleId: string) {\r\n    super(game, document, ui, moduleId);\r\n  }\r\n}\r\n","/**\r\n * Application-layer string sanitization utilities.\r\n *\r\n * These functions provide safe string handling for HTML contexts,\r\n * preventing XSS attacks and ensuring safe display of user-provided content.\r\n */\r\n\r\n/**\r\n * Sanitizes a string for display in HTML or logs.\r\n * Escapes HTML entities to prevent XSS attacks and log injection.\r\n *\r\n * Uses DOM-based sanitization for robust handling of all edge cases.\r\n *\r\n * @param text - The text to sanitize\r\n * @returns HTML-safe text with escaped entities\r\n *\r\n * @example\r\n * ```typescript\r\n * sanitizeHtml(\"<script>alert('xss')</script>\");\r\n * // \"&lt;script&gt;alert('xss')&lt;/script&gt;\"\r\n *\r\n * sanitizeHtml(\"Normal text\");\r\n * // \"Normal text\"\r\n * ```\r\n */\r\nexport function sanitizeHtml(text: string): string {\r\n  const div = document.createElement(\"div\");\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalCollectionPort } from \"@/domain/ports/collections/platform-journal-collection-port.interface\";\r\nimport type { PlatformJournalRepository } from \"@/domain/ports/repositories/platform-journal-repository.interface\";\r\nimport type { JournalVisibilityError } from \"@/domain/entities/journal-entry\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { CacheReaderPort } from \"@/domain/ports/cache/cache-reader-port.interface\";\r\nimport type { CacheWriterPort } from \"@/domain/ports/cache/cache-writer-port.interface\";\r\nimport type { JournalVisibilityConfig } from \"./JournalVisibilityConfig\";\r\nimport { journalVisibilityConfigToken } from \"@/application/tokens/application.tokens\";\r\nimport {\r\n  platformJournalCollectionPortToken,\r\n  platformJournalRepositoryToken,\r\n  cacheReaderPortToken,\r\n  cacheWriterPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { sanitizeHtml } from \"@/application/utils/sanitize-utils\";\r\n\r\nexport const HIDDEN_JOURNAL_CACHE_TAG = \"journal:hidden\";\r\n\r\n/**\r\n * Service for managing journal entry visibility based on module flags.\r\n * Handles business logic for hiding/showing journal entries.\r\n *\r\n * **Responsibilities:**\r\n * - Business logic for journal visibility (flag checking, caching)\r\n * - Does NOT handle DOM manipulation (delegated to JournalDirectoryProcessor)\r\n *\r\n * **Dependencies:**\r\n * - PlatformJournalCollectionPort: Platform-agnostic port for journal collection queries\r\n * - PlatformJournalRepository: Platform-agnostic port for journal CRUD and flag operations\r\n * - PlatformNotificationPort: Platform-agnostic port for logging and notifications\r\n * - CacheReaderPort: Platform-agnostic port for reading from cache\r\n * - CacheWriterPort: Platform-agnostic port for writing to cache\r\n *\r\n * **DIP-Compliance:**\r\n * - Depends on domain-neutral ports, not Foundry-specific types\r\n * - Platform-specific adapters implement the ports\r\n * - Follows Interface Segregation Principle (ISP) by depending only on needed cache operations\r\n */\r\nexport class JournalVisibilityService {\r\n  constructor(\r\n    private readonly journalCollection: PlatformJournalCollectionPort,\r\n    private readonly journalRepository: PlatformJournalRepository,\r\n    private readonly notifications: NotificationPublisherPort,\r\n    private readonly cacheReader: CacheReaderPort,\r\n    private readonly cacheWriter: CacheWriterPort,\r\n    private readonly config: JournalVisibilityConfig\r\n  ) {}\r\n\r\n  /**\r\n   * Gets journal entries marked as hidden via module flag.\r\n   * Logs warnings for entries where flag reading fails to aid diagnosis.\r\n   */\r\n  getHiddenJournalEntries(): Result<JournalEntry[], JournalVisibilityError> {\r\n    const cacheKey = this.config.cacheKeyFactory(\"hidden-directory\");\r\n    const cached = this.cacheReader.get<JournalEntry[]>(cacheKey);\r\n    if (cached?.hit && cached.value) {\r\n      this.notifications.debug(\r\n        `Serving ${cached.value.length} hidden journal entries from cache (ttl=${\r\n          cached.metadata.expiresAt ?? \"∞\"\r\n        })`,\r\n        { context: { cached } },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n      return { ok: true, value: cached.value };\r\n    }\r\n\r\n    const allEntriesResult = this.journalCollection.getAll();\r\n    if (!allEntriesResult.ok) {\r\n      // Map EntityCollectionError to JournalVisibilityError\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"PLATFORM_ERROR\",\r\n          message: allEntriesResult.error.message,\r\n        },\r\n      };\r\n    }\r\n\r\n    const hidden: JournalEntry[] = [];\r\n\r\n    for (const journal of allEntriesResult.value) {\r\n      const flagResult = this.journalRepository.getFlag(\r\n        journal.id,\r\n        this.config.moduleNamespace,\r\n        this.config.hiddenFlagKey\r\n      );\r\n\r\n      if (flagResult.ok) {\r\n        if (flagResult.value === true) {\r\n          hidden.push(journal);\r\n        }\r\n      } else {\r\n        // Log flag read errors for diagnosis without interrupting processing\r\n        const journalIdentifier = journal.name ?? journal.id;\r\n        this.notifications.warn(\r\n          `Failed to read hidden flag for journal \"${sanitizeHtml(journalIdentifier)}\"`,\r\n          {\r\n            errorCode: flagResult.error.code,\r\n            errorMessage: flagResult.error.message,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n\r\n        // Continue processing other entries\r\n      }\r\n    }\r\n\r\n    this.cacheWriter.set(cacheKey, hidden.slice(), {\r\n      tags: [HIDDEN_JOURNAL_CACHE_TAG],\r\n    });\r\n\r\n    return { ok: true, value: hidden };\r\n  }\r\n}\r\n\r\nexport class DIJournalVisibilityService extends JournalVisibilityService {\r\n  static dependencies = [\r\n    platformJournalCollectionPortToken,\r\n    platformJournalRepositoryToken,\r\n    notificationPublisherPortToken,\r\n    cacheReaderPortToken,\r\n    cacheWriterPortToken,\r\n    journalVisibilityConfigToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalCollection: PlatformJournalCollectionPort,\r\n    journalRepository: PlatformJournalRepository,\r\n    notifications: NotificationPublisherPort,\r\n    cacheReader: CacheReaderPort,\r\n    cacheWriter: CacheWriterPort,\r\n    config: JournalVisibilityConfig\r\n  ) {\r\n    super(journalCollection, journalRepository, notifications, cacheReader, cacheWriter, config);\r\n  }\r\n}\r\n","/**\r\n * Application-layer array utility functions.\r\n *\r\n * These functions provide type-safe array operations for use in application services.\r\n */\r\n\r\n/**\r\n * Type guard to check if an array is non-empty.\r\n * Narrows the type to ensure at least one element exists.\r\n *\r\n * @template T - The type of array elements\r\n * @param array - Array to check\r\n * @returns True if array has at least one element\r\n */\r\nexport function isNonEmptyArray<T>(array: T[]): array is [T, ...T[]] {\r\n  return array.length > 0;\r\n}\r\n\r\n/**\r\n * Gets the first element from a VERIFIED non-empty array.\r\n *\r\n * ⚠️ PRECONDITION: Caller MUST verify array.length > 0 before calling.\r\n *\r\n * This is a type-level helper for situations where TypeScript cannot infer\r\n * that array[0] is defined after a length check. Use this ONLY when you\r\n * already have a guard like: if (errors.length > 0) { ... }\r\n *\r\n * For cases without a guard, use getFirstArrayElementSafe() instead.\r\n *\r\n * The function uses an internal type guard to satisfy TypeScript's type system\r\n * without requiring a type assertion. If the precondition is violated,\r\n * it throws an error (this should never happen if caller follows contract).\r\n *\r\n * @template T - The type of array elements\r\n * @param array - Array that has been verified to have length > 0\r\n * @returns The first element of the array\r\n *\r\n * @example\r\n * ```typescript\r\n * const errors: Error[] = [new Error(\"test\")];\r\n * if (errors.length > 0) {\r\n *   const firstError = getFirstArrayElement(errors);\r\n *   console.log(firstError.message);\r\n * }\r\n * ```\r\n */\r\nexport function getFirstArrayElement<T>(array: T[]): T {\r\n  // Use type guard internally so TypeScript can narrow the type\r\n  // This allows TypeScript to infer that array[0] is safe without type assertions\r\n  if (!isNonEmptyArray(array)) {\r\n    // This should never happen if caller follows the precondition\r\n    // But we need this check for TypeScript to narrow the type correctly\r\n    throw new Error(\"Array must have length > 0 (caller violated precondition)\");\r\n  }\r\n  // TypeScript now knows array is [T, ...T[]], so array[0] is safe\r\n  return array[0];\r\n}\r\n\r\n/**\r\n * Safely gets the first element from an array WITH built-in empty check.\r\n *\r\n * Returns null if the array is empty. Use this when you don't have a\r\n * length guard and want the function to handle the empty case for you.\r\n *\r\n * For cases where you already have a guard, use getFirstArrayElement() instead.\r\n *\r\n * @template T - The type of array elements\r\n * @param array - Array to get the first element from\r\n * @returns The first element or null if array is empty\r\n *\r\n * @example\r\n * ```typescript\r\n * const errors: Error[] = getErrors();\r\n * const firstError = getFirstArrayElementSafe(errors);\r\n * if (firstError !== null) {\r\n *   console.log(firstError.message);\r\n * }\r\n * ```\r\n */\r\nexport function getFirstArrayElementSafe<T>(array: T[]): T | null {\r\n  return isNonEmptyArray(array) ? array[0] : null;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { JournalEntry, JournalVisibilityError } from \"@/domain/entities/journal-entry\";\r\nimport type { PlatformJournalDirectoryUiPort } from \"@/domain/ports/platform-journal-directory-ui-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { JournalVisibilityConfig } from \"./JournalVisibilityConfig\";\r\nimport { getFirstArrayElement } from \"@/application/utils/array-utils\";\r\nimport { sanitizeHtml } from \"@/application/utils/sanitize-utils\";\r\nimport {\r\n  platformJournalDirectoryUiPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { journalVisibilityConfigToken } from \"@/application/tokens/application.tokens\";\r\n\r\n/**\r\n * Service for processing journal directory to hide flagged entries.\r\n * Handles UI coordination via ports (DIP-compliant).\r\n *\r\n * **Responsibilities:**\r\n * - Orchestrates hiding of journal entries via PlatformJournalDirectoryUiPort\r\n * - Error handling and logging for UI operations\r\n *\r\n * **Dependencies:**\r\n * - PlatformJournalDirectoryUiPort: Platform-agnostic port for journal directory UI operations\r\n * - PlatformNotificationPort: Platform-agnostic port for logging and notifications\r\n * - JournalVisibilityConfig: Configuration for default names and cache keys\r\n *\r\n * **DIP-Compliance:**\r\n * - Depends on domain-neutral ports, not Foundry-specific types\r\n * - Does not depend on HTMLElement or other DOM types\r\n * - Platform-specific adapters implement the ports and handle DOM operations\r\n */\r\nexport class JournalDirectoryProcessor {\r\n  constructor(\r\n    private readonly journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    private readonly notifications: NotificationPublisherPort,\r\n    private readonly config: JournalVisibilityConfig\r\n  ) {}\r\n\r\n  /**\r\n   * Processes journal directory to hide flagged journal directory entries.\r\n   *\r\n   * A journal directory entry is the list position in the sidebar that displays a journal.\r\n   * This is NOT a journal entry (which is a page within a journal).\r\n   *\r\n   * DIP-compliant: Works with directoryId instead of HTMLElement.\r\n   * @param directoryId - The identifier for the directory (e.g., \"journal\" for Foundry)\r\n   * @param hiddenEntries - Array of journals whose directory entries should be hidden\r\n   * @returns Result indicating success or failure with aggregated errors\r\n   */\r\n  processDirectory(\r\n    directoryId: string,\r\n    hiddenEntries: JournalEntry[]\r\n  ): Result<void, JournalVisibilityError> {\r\n    this.notifications.debug(\r\n      \"Processing journal directory for hidden entries\",\r\n      { context: { directoryId, hiddenCount: hiddenEntries.length } },\r\n      {\r\n        channels: [\"ConsoleChannel\"],\r\n      }\r\n    );\r\n\r\n    if (hiddenEntries.length === 0) {\r\n      this.notifications.debug(\r\n        \"No hidden entries to process\",\r\n        { context: {} },\r\n        {\r\n          channels: [\"ConsoleChannel\"],\r\n        }\r\n      );\r\n      return { ok: true, value: undefined };\r\n    }\r\n\r\n    this.notifications.debug(\r\n      `Found ${hiddenEntries.length} hidden journal entries`,\r\n      { context: { hidden: hiddenEntries } },\r\n      {\r\n        channels: [\"ConsoleChannel\"],\r\n      }\r\n    );\r\n\r\n    return this.hideEntries(directoryId, hiddenEntries);\r\n  }\r\n\r\n  /**\r\n   * Hides multiple journal directory entries in the directory.\r\n   *\r\n   * A journal directory entry is the list position in the sidebar that displays a journal.\r\n   * This is NOT a journal entry (which is a page within a journal).\r\n   *\r\n   * DIP-compliant: Uses directoryId instead of HTMLElement.\r\n   * @param directoryId - The identifier for the directory\r\n   * @param entries - Array of journals whose directory entries should be hidden\r\n   * @returns Result indicating success or failure with aggregated errors\r\n   */\r\n  private hideEntries(\r\n    directoryId: string,\r\n    entries: JournalEntry[]\r\n  ): Result<void, JournalVisibilityError> {\r\n    const errors: JournalVisibilityError[] = [];\r\n\r\n    for (const journal of entries) {\r\n      const journalName = journal.name ?? this.config.unknownName;\r\n      const removeResult = this.journalDirectoryUI.removeJournalDirectoryEntry(\r\n        directoryId,\r\n        journal.id,\r\n        journalName\r\n      );\r\n\r\n      // Map PlatformUIError to JournalVisibilityError\r\n      if (!removeResult.ok) {\r\n        const journalError: JournalVisibilityError = {\r\n          code: \"DOM_MANIPULATION_FAILED\",\r\n          entryId: journal.id,\r\n          message: removeResult.error.message,\r\n        };\r\n        errors.push(journalError);\r\n        this.notifications.warn(\"Error removing journal directory entry\", journalError, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n      } else {\r\n        this.notifications.debug(\r\n          `Removing journal directory entry: ${sanitizeHtml(journalName)}`,\r\n          { context: { journal } },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    // If any errors occurred, return the first one\r\n    // In future, could aggregate multiple errors into a single error\r\n    if (errors.length > 0) {\r\n      // errors[0] is always defined when errors.length > 0\r\n      // Use helper from runtime-safe-cast to maintain type coverage\r\n      const firstError = getFirstArrayElement(errors);\r\n      return { ok: false, error: firstError };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for JournalDirectoryProcessor.\r\n */\r\nexport class DIJournalDirectoryProcessor extends JournalDirectoryProcessor {\r\n  static dependencies = [\r\n    platformJournalDirectoryUiPortToken,\r\n    notificationPublisherPortToken,\r\n    journalVisibilityConfigToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    notifications: NotificationPublisherPort,\r\n    config: JournalVisibilityConfig\r\n  ) {\r\n    super(journalDirectoryUI, notifications, config);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  LibWrapperService,\r\n  LibWrapperFunction,\r\n  LibWrapperType,\r\n  LibWrapperRegistrationId,\r\n  LibWrapperError,\r\n} from \"@/infrastructure/adapters/foundry/interfaces/lib-wrapper-service.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { moduleIdToken } from \"@/infrastructure/shared/tokens/infrastructure/module-id.token\";\r\nimport { tryCatch } from \"@/domain/utils/result\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Type for libWrapper global (provided by lib-wrapper module in Foundry).\r\n */\r\ndeclare global {\r\n  var libWrapper:\r\n    | {\r\n        register: (\r\n          moduleId: string,\r\n          target: string,\r\n          fn: LibWrapperFunction,\r\n          type: LibWrapperType\r\n        ) => void;\r\n        unregister: (moduleId: string, target: string) => void;\r\n      }\r\n    | undefined;\r\n}\r\n\r\n/**\r\n * Foundry-specific implementation of LibWrapperService.\r\n *\r\n * Provides a facade over libWrapper that handles registration and unregistration\r\n * of method wrappers. Tracks all registrations for proper cleanup.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = new FoundryLibWrapperService(\"my-module-id\", logger);\r\n *\r\n * const result = service.register(\r\n *   \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n *   (wrapped, ...args) => {\r\n *     // Custom logic\r\n *     return wrapped(...args);\r\n *   },\r\n *   \"WRAPPER\"\r\n * );\r\n *\r\n * // Later: Cleanup\r\n * service.dispose();\r\n * ```\r\n */\r\nexport class FoundryLibWrapperService implements LibWrapperService {\r\n  private registeredTargets = new Map<string, boolean>();\r\n  private nextId = 1;\r\n\r\n  constructor(\r\n    private readonly moduleId: string,\r\n    private readonly logger: Logger\r\n  ) {}\r\n\r\n  register(\r\n    target: string,\r\n    wrapperFn: LibWrapperFunction,\r\n    type: LibWrapperType\r\n  ): Result<LibWrapperRegistrationId, LibWrapperError> {\r\n    // Prüfe libWrapper Verfügbarkeit\r\n    if (typeof globalThis.libWrapper === \"undefined\") {\r\n      return err({\r\n        code: \"LIBWRAPPER_NOT_AVAILABLE\",\r\n        message: \"libWrapper is not available\",\r\n      });\r\n    }\r\n\r\n    // Prüfe, ob Target bereits registriert ist\r\n    if (this.registeredTargets.has(target)) {\r\n      return err({\r\n        code: \"REGISTRATION_FAILED\",\r\n        message: `Target \"${target}\" is already registered`,\r\n        details: { target },\r\n      });\r\n    }\r\n\r\n    const result = tryCatch(\r\n      () => {\r\n        const libWrapperInstance = globalThis.libWrapper;\r\n        if (typeof libWrapperInstance === \"undefined\") {\r\n          throw new Error(\"libWrapper is not available\");\r\n        }\r\n\r\n        libWrapperInstance.register(this.moduleId, target, wrapperFn, type);\r\n\r\n        // Track registration\r\n        this.registeredTargets.set(target, true);\r\n        const registrationId = this.nextId++;\r\n\r\n        return registrationId;\r\n      },\r\n      (error): LibWrapperError => ({\r\n        code: \"REGISTRATION_FAILED\",\r\n        message: `Failed to register wrapper for target \"${target}\": ${String(error)}`,\r\n        details: { target, error },\r\n      })\r\n    );\r\n\r\n    if (result.ok) {\r\n      return ok(result.value);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  unregister(target: string): Result<void, LibWrapperError> {\r\n    // Prüfe, ob Target registriert ist\r\n    if (!this.registeredTargets.has(target)) {\r\n      return err({\r\n        code: \"TARGET_NOT_REGISTERED\",\r\n        message: `Target \"${target}\" is not registered`,\r\n        details: { target },\r\n      });\r\n    }\r\n\r\n    // Prüfe libWrapper Verfügbarkeit\r\n    if (typeof globalThis.libWrapper === \"undefined\") {\r\n      return err({\r\n        code: \"LIBWRAPPER_NOT_AVAILABLE\",\r\n        message: \"libWrapper is not available\",\r\n      });\r\n    }\r\n\r\n    const result = tryCatch(\r\n      () => {\r\n        const libWrapperInstance = globalThis.libWrapper;\r\n        if (typeof libWrapperInstance === \"undefined\") {\r\n          throw new Error(\"libWrapper is not available\");\r\n        }\r\n\r\n        libWrapperInstance.unregister(this.moduleId, target);\r\n\r\n        // Remove from tracking\r\n        this.registeredTargets.delete(target);\r\n      },\r\n      (error): LibWrapperError => ({\r\n        code: \"UNREGISTRATION_FAILED\",\r\n        message: `Failed to unregister wrapper for target \"${target}\": ${String(error)}`,\r\n        details: { target, error },\r\n      })\r\n    );\r\n\r\n    if (result.ok) {\r\n      return ok(undefined);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Cleanup all registered wrappers.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    // Unregister all tracked targets\r\n    const targets = Array.from(this.registeredTargets.keys());\r\n    for (const target of targets) {\r\n      const result = this.unregister(target);\r\n      if (!result.ok) {\r\n        this.logger.warn(\"Failed to unregister libWrapper target during dispose\", {\r\n          target,\r\n          error: result.error,\r\n        });\r\n      }\r\n    }\r\n\r\n    this.registeredTargets.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryLibWrapperService.\r\n *\r\n * Injects moduleId via DI to avoid Infrastructure layer depending on Application layer.\r\n */\r\nexport class DIFoundryLibWrapperService extends FoundryLibWrapperService {\r\n  static dependencies = [moduleIdToken, loggerToken] as const;\r\n\r\n  constructor(moduleId: string, logger: Logger) {\r\n    super(moduleId, logger);\r\n  }\r\n}\r\n","/**\r\n * Injection token for LibWrapperService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { LibWrapperService } from \"@/infrastructure/adapters/foundry/interfaces/lib-wrapper-service.interface\";\r\n\r\n/**\r\n * Injection token for LibWrapperService.\r\n *\r\n * Provides a facade over libWrapper for registering and unregistering method wrappers.\r\n * Handles tracking of registrations and cleanup.\r\n *\r\n * @example\r\n * ```typescript\r\n * const libWrapper = container.resolve(libWrapperServiceToken);\r\n * const result = libWrapper.register(\r\n *   \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n *   (wrapped, ...args) => {\r\n *     // Custom logic\r\n *     return wrapped(...args);\r\n *   },\r\n *   \"WRAPPER\"\r\n * );\r\n * ```\r\n */\r\nexport const libWrapperServiceToken = createInjectionToken<LibWrapperService>(\"LibWrapperService\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  LibWrapperService,\r\n  LibWrapperFunction,\r\n  LibWrapperRegistrationId,\r\n} from \"@/infrastructure/adapters/foundry/interfaces/lib-wrapper-service.interface\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type { PlatformContextMenuRegistrationPort } from \"@/domain/ports/platform-context-menu-registration-port.interface\";\r\nimport { libWrapperServiceToken } from \"@/infrastructure/shared/tokens/foundry/lib-wrapper-service.token\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { err, ok } from \"@/domain/utils/result\";\r\n\r\n// Type for Foundry ContextMenu instance (used by libWrapper)\r\ntype FoundryContextMenu = {\r\n  menuItems?: Array<{ name: string; icon: string; callback: () => void }>;\r\n};\r\n\r\n/**\r\n * Service for managing libWrapper registration for journal context menu.\r\n *\r\n * This service handles the registration of the libWrapper wrapper function\r\n * for the Foundry ContextMenu.render method. It manages callbacks that can\r\n * modify the context menu options for journal entries.\r\n *\r\n * NOTE: This is NOT an event system. The libWrapper is registered once during\r\n * init, and callbacks are registered separately.\r\n *\r\n * Implements PlatformContextMenuRegistrationPort for DIP compliance.\r\n *\r\n * @example\r\n * ```typescript\r\n * const service = new JournalContextMenuLibWrapperService(\r\n *   libWrapperService,\r\n *   logger\r\n * );\r\n *\r\n * // Register libWrapper (called during init)\r\n * const result = service.register();\r\n *\r\n * // Add callback for handling context menu\r\n * service.addCallback((event) => {\r\n *   event.options.push({\r\n *     name: \"Custom Option\",\r\n *     icon: '<i class=\"fas fa-star\"></i>',\r\n *     callback: () => { /* ... *\\/ }\r\n *   });\r\n * });\r\n * ```\r\n */\r\nexport class JournalContextMenuLibWrapperService implements PlatformContextMenuRegistrationPort {\r\n  private libWrapperRegistered = false;\r\n  private callbacks: Array<(event: JournalContextMenuEvent) => void> = [];\r\n  private registrationId: LibWrapperRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly libWrapperService: LibWrapperService,\r\n    private readonly logger: Logger\r\n  ) {}\r\n\r\n  /**\r\n   * Register libWrapper for ContextMenu.render.\r\n   * Should be called once during module initialization.\r\n   *\r\n   * @returns Success or error if registration failed\r\n   */\r\n  register(): Result<void, Error> {\r\n    if (this.libWrapperRegistered) {\r\n      return ok(undefined);\r\n    }\r\n\r\n    // Prüfe ContextMenu Verfügbarkeit\r\n    const contextMenuClass = globalThis.foundry?.applications?.ux?.ContextMenu?.implementation;\r\n    if (!contextMenuClass) {\r\n      return err(new Error(\"ContextMenu is not available\"));\r\n    }\r\n\r\n    // Erstelle Wrapper-Funktion\r\n    const wrapperFn = this.createWrapperFunction();\r\n\r\n    // Registriere via LibWrapperService\r\n    const result = this.libWrapperService.register(\r\n      \"foundry.applications.ux.ContextMenu.implementation.prototype.render\",\r\n      wrapperFn,\r\n      \"WRAPPER\"\r\n    );\r\n\r\n    if (!result.ok) {\r\n      return err(new Error(result.error.message));\r\n    }\r\n\r\n    this.registrationId = result.value;\r\n    this.libWrapperRegistered = true;\r\n    this.logger.debug(\"Journal context menu libWrapper registered\");\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Add a callback that will be called when a journal context menu is rendered.\r\n   *\r\n   * @param callback - Callback function that receives the context menu event\r\n   */\r\n  addCallback(callback: (event: JournalContextMenuEvent) => void): void {\r\n    this.callbacks.push(callback);\r\n  }\r\n\r\n  /**\r\n   * Remove a previously registered callback.\r\n   *\r\n   * @param callback - The callback function to remove\r\n   */\r\n  removeCallback(callback: (event: JournalContextMenuEvent) => void): void {\r\n    const index = this.callbacks.indexOf(callback);\r\n    if (index > -1) {\r\n      this.callbacks.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister libWrapper.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    if (this.libWrapperRegistered) {\r\n      const result = this.libWrapperService.unregister(\r\n        \"foundry.applications.ux.ContextMenu.implementation.prototype.render\"\r\n      );\r\n      if (!result.ok) {\r\n        this.logger.warn(\"Failed to unregister context menu libWrapper\", {\r\n          error: result.error,\r\n        });\r\n      }\r\n      this.libWrapperRegistered = false;\r\n      this.registrationId = undefined;\r\n    }\r\n    this.callbacks = [];\r\n  }\r\n\r\n  /**\r\n   * Create the wrapper function for libWrapper.\r\n   * This function intercepts ContextMenu.render calls and allows\r\n   * registered callbacks to modify the menu options.\r\n   */\r\n  private createWrapperFunction(): LibWrapperFunction {\r\n    // Closure für Callbacks-Array (damit libWrapper-Wrapper darauf zugreifen kann)\r\n    const callbacksRef = this.callbacks;\r\n\r\n    return function (\r\n      this: FoundryContextMenu,\r\n      wrapped: (...args: unknown[]) => unknown,\r\n      ...args: unknown[]\r\n    ): unknown {\r\n      // Extract target from args (first argument)\r\n      const firstArg = args[0];\r\n      const target: HTMLElement | undefined =\r\n        firstArg instanceof HTMLElement ? firstArg : undefined;\r\n\r\n      if (!target) {\r\n        return wrapped.call(this, ...args);\r\n      }\r\n\r\n      // `this` ist hier das ContextMenu-Objekt (libWrapper ruft die Funktion mit dem ContextMenu als this auf)\r\n      const menuItemsRaw = this.menuItems;\r\n      if (!menuItemsRaw) {\r\n        return wrapped.call(this, ...args);\r\n      }\r\n      // Type guard: menuItems ist jetzt definitiv definiert\r\n      const menuItems: Array<{ name: string; icon: string; callback: () => void }> = menuItemsRaw;\r\n\r\n      // Prüfe, ob es ein Journal-Eintrag ist (target zuerst)\r\n      const journalId =\r\n        target.getAttribute?.(\"data-entry-id\") || target.getAttribute?.(\"data-document-id\");\r\n\r\n      if (journalId) {\r\n        // Erstelle Event-Objekt (DIP-compliant: journalId statt htmlElement)\r\n        const event: JournalContextMenuEvent = {\r\n          journalId,\r\n          options: menuItems.map((item: { name: string; icon: string; callback: () => void }) => ({\r\n            name: item.name,\r\n            icon: item.icon,\r\n            // ContextMenuOption.callback erwartet jetzt journalId statt HTMLElement\r\n            callback: (_id: string) => {\r\n              // Foundry menuItems callback hat keine Parameter, aber wir rufen es trotzdem auf\r\n              // Der Handler wird die journalId aus dem Event erhalten\r\n              item.callback();\r\n              // Return void (nicht Promise) für Foundry-Kompatibilität\r\n            },\r\n          })),\r\n          timestamp: Date.now(),\r\n        };\r\n\r\n        // Rufe alle registrierten Callbacks auf (via Closure)\r\n        // Handler können event.options modifizieren (z.B. neue Menü-Einträge hinzufügen)\r\n        for (const cb of callbacksRef) {\r\n          cb(event);\r\n        }\r\n\r\n        // Kopiere die modifizierten options zurück in this.menuItems\r\n        // Wichtig: Nur neue Einträge hinzufügen, nicht alle ersetzen (um andere Modifikationen zu erhalten)\r\n        const existingNames = new Set(menuItems.map((item) => item.name));\r\n        for (const newOption of event.options) {\r\n          if (!existingNames.has(newOption.name)) {\r\n            // Konvertiere ContextMenuOption zu menuItems-Format\r\n            menuItems.push({\r\n              name: newOption.name,\r\n              icon: newOption.icon,\r\n              callback: () => {\r\n                // ContextMenuOption callback erwartet jetzt journalId statt HTMLElement\r\n                const result = newOption.callback(journalId);\r\n                // Handle Promise falls vorhanden\r\n                if (result instanceof Promise) {\r\n                  result.catch(() => {\r\n                    // Ignore errors\r\n                  });\r\n                }\r\n              },\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      return wrapped.call(this, ...args);\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for JournalContextMenuLibWrapperService.\r\n */\r\nexport class DIJournalContextMenuLibWrapperService extends JournalContextMenuLibWrapperService {\r\n  static dependencies = [libWrapperServiceToken, loggerToken] as const;\r\n\r\n  constructor(libWrapperService: LibWrapperService, logger: Logger) {\r\n    super(libWrapperService, logger);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformSettingsRegistrationPort } from \"@/domain/ports/platform-settings-registration-port.interface\";\r\nimport type { DomainSettingConfig, DomainSettingsError } from \"@/domain/types/settings\";\r\nimport type { SettingValidator } from \"@/domain/types/setting-validator\";\r\nimport type { FoundrySettings } from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Foundry-specific adapter for PlatformSettingsRegistrationPort.\r\n *\r\n * Translates between domain types (DomainSettingConfig, SettingValidator) and\r\n * Foundry types (SettingConfig, Valibot schemas).\r\n *\r\n * This adapter encapsulates all Valibot usage, keeping the domain layer\r\n * free from validation library dependencies.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundrySettingsRegistrationAdapter(foundrySettings);\r\n *\r\n * adapter.registerSetting(\"my-module\", \"enabled\", {\r\n *   name: \"Enable Feature\",\r\n *   scope: \"world\",\r\n *   config: true,\r\n *   type: Boolean,\r\n *   default: true,\r\n * });\r\n *\r\n * const result = adapter.getSettingValue(\r\n *   \"my-module\",\r\n *   \"enabled\",\r\n *   (v): v is boolean => typeof v === \"boolean\"\r\n * );\r\n * ```\r\n */\r\nexport class FoundrySettingsRegistrationAdapter implements PlatformSettingsRegistrationPort {\r\n  constructor(private readonly foundrySettings: FoundrySettings) {}\r\n\r\n  registerSetting<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: DomainSettingConfig<T>\r\n  ): Result<void, DomainSettingsError> {\r\n    // Map domain config to Foundry config\r\n    const foundryConfig = {\r\n      name: config.name,\r\n      ...(config.hint !== undefined && { hint: config.hint }),\r\n      scope: config.scope,\r\n      config: config.config,\r\n      type: config.type,\r\n      ...(config.choices !== undefined && { choices: config.choices }),\r\n      default: config.default,\r\n      ...(config.onChange !== undefined && { onChange: config.onChange }),\r\n    };\r\n\r\n    const result = this.foundrySettings.register(namespace, key, foundryConfig);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryError(result.error, \"register\", key),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  getSettingValue<T>(\r\n    namespace: string,\r\n    key: string,\r\n    validator: SettingValidator<T>\r\n  ): Result<T, DomainSettingsError> {\r\n    // Use a permissive Valibot schema to get the raw value\r\n    // Then validate with the provided validator function\r\n    const permissiveSchema = v.unknown();\r\n\r\n    const result = this.foundrySettings.get(namespace, key, permissiveSchema);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryError(result.error, \"get\", key),\r\n      };\r\n    }\r\n\r\n    // Validate with provided validator\r\n    if (!validator(result.value)) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"INVALID_SETTING_VALUE\",\r\n          message: `Setting \"${namespace}.${key}\" has invalid value type`,\r\n          details: { value: result.value },\r\n        },\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: result.value };\r\n  }\r\n\r\n  async setSettingValue<T>(\r\n    namespace: string,\r\n    key: string,\r\n    value: T\r\n  ): Promise<Result<void, DomainSettingsError>> {\r\n    const result = await this.foundrySettings.set(namespace, key, value);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: this.mapFoundryError(result.error, \"set\", key),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  private mapFoundryError(\r\n    foundryError: FoundryError,\r\n    operation: \"register\" | \"get\" | \"set\",\r\n    key: string\r\n  ): DomainSettingsError {\r\n    let code: DomainSettingsError[\"code\"];\r\n\r\n    switch (foundryError.code) {\r\n      case \"API_NOT_AVAILABLE\":\r\n        code = \"PLATFORM_NOT_AVAILABLE\";\r\n        break;\r\n      case \"VALIDATION_FAILED\":\r\n        code = \"INVALID_SETTING_VALUE\";\r\n        break;\r\n      case \"OPERATION_FAILED\":\r\n        if (operation === \"register\") {\r\n          code = \"SETTING_REGISTRATION_FAILED\";\r\n        } else if (operation === \"get\") {\r\n          code = \"SETTING_READ_FAILED\";\r\n        } else {\r\n          code = \"SETTING_WRITE_FAILED\";\r\n        }\r\n        break;\r\n      default:\r\n        code =\r\n          operation === \"register\"\r\n            ? \"SETTING_REGISTRATION_FAILED\"\r\n            : operation === \"get\"\r\n              ? \"SETTING_READ_FAILED\"\r\n              : \"SETTING_WRITE_FAILED\";\r\n    }\r\n\r\n    return {\r\n      code,\r\n      message: `Failed to ${operation} setting \"${key}\": ${foundryError.message}`,\r\n      details: foundryError,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundrySettingsRegistrationAdapter.\r\n */\r\nexport class DIFoundrySettingsRegistrationAdapter extends FoundrySettingsRegistrationAdapter {\r\n  static dependencies = [foundrySettingsToken] as const;\r\n\r\n  constructor(foundrySettings: FoundrySettings) {\r\n    super(foundrySettings);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport { foundryDocumentToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document.token\";\r\nimport { foundryUIToken } from \"@/infrastructure/shared/tokens/foundry/foundry-ui.token\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport { foundryJournalFacadeToken } from \"@/infrastructure/shared/tokens/foundry/foundry-journal-facade.token\";\r\nimport { platformSettingsRegistrationPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport {\r\n  journalVisibilityServiceToken,\r\n  journalDirectoryProcessorToken,\r\n} from \"@/application/tokens/application.tokens\";\r\nimport { DIFoundryGamePort } from \"@/infrastructure/adapters/foundry/services/FoundryGamePort\";\r\nimport { DIFoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\nimport { DIFoundryDocumentPort } from \"@/infrastructure/adapters/foundry/services/FoundryDocumentPort\";\r\nimport { DIFoundryUIPort } from \"@/infrastructure/adapters/foundry/services/FoundryUIPort\";\r\nimport { DIFoundrySettingsPort } from \"@/infrastructure/adapters/foundry/services/FoundrySettingsPort\";\r\nimport { DIFoundryJournalFacade } from \"@/infrastructure/adapters/foundry/facades/foundry-journal-facade\";\r\nimport { DIJournalVisibilityService } from \"@/application/services/JournalVisibilityService\";\r\nimport { DIJournalDirectoryProcessor } from \"@/application/services/JournalDirectoryProcessor\";\r\nimport { DIFoundryLibWrapperService } from \"@/infrastructure/adapters/foundry/services/FoundryLibWrapperService\";\r\nimport { DIJournalContextMenuLibWrapperService } from \"@/infrastructure/adapters/foundry/services/JournalContextMenuLibWrapperService\";\r\nimport { DIFoundrySettingsRegistrationAdapter } from \"@/infrastructure/adapters/foundry/settings-adapters/foundry-settings-registration-adapter\";\r\nimport { libWrapperServiceToken } from \"@/infrastructure/shared/tokens/foundry/lib-wrapper-service.token\";\r\nimport { journalContextMenuLibWrapperServiceToken } from \"@/infrastructure/shared/tokens/foundry/journal-context-menu-lib-wrapper-service.token\";\r\nimport { platformContextMenuRegistrationPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Registers Foundry service wrappers.\r\n *\r\n * Services registered:\r\n * - FoundryGamePort (singleton)\r\n * - FoundryHooksPort (singleton)\r\n * - FoundryDocumentPort (singleton)\r\n * - FoundryUIPort (singleton)\r\n * - FoundrySettingsPort (singleton)\r\n * - FoundryJournalFacade (singleton)\r\n * - JournalVisibilityService (singleton)\r\n * - JournalDirectoryProcessor (singleton) - Processes journal directory DOM\r\n * - FoundryLibWrapperService (singleton) - Facade for libWrapper\r\n * - JournalContextMenuLibWrapperService (singleton) - Manages libWrapper for journal context menu\r\n *\r\n * All services use port-based adapter pattern for Foundry version compatibility.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerFoundryServices(container: ServiceContainer): Result<void, string> {\r\n  // Register FoundryGamePort\r\n  const gameServiceResult = container.registerClass(\r\n    foundryGameToken,\r\n    DIFoundryGamePort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(gameServiceResult)) {\r\n    return err(`Failed to register FoundryGame service: ${gameServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryHooksPort\r\n  const hooksServiceResult = container.registerClass(\r\n    foundryHooksToken,\r\n    DIFoundryHooksPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(hooksServiceResult)) {\r\n    return err(`Failed to register FoundryHooks service: ${hooksServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundryDocumentPort\r\n  const documentServiceResult = container.registerClass(\r\n    foundryDocumentToken,\r\n    DIFoundryDocumentPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(documentServiceResult)) {\r\n    return err(\r\n      `Failed to register FoundryDocument service: ${documentServiceResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryUIPort\r\n  const uiServiceResult = container.registerClass(\r\n    foundryUIToken,\r\n    DIFoundryUIPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiServiceResult)) {\r\n    return err(`Failed to register FoundryUI service: ${uiServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register FoundrySettingsPort\r\n  const settingsServiceResult = container.registerClass(\r\n    foundrySettingsToken,\r\n    DIFoundrySettingsPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsServiceResult)) {\r\n    return err(\r\n      `Failed to register FoundrySettings service: ${settingsServiceResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformSettingsRegistrationPort (domain-neutral adapter)\r\n  // Uses FoundrySettingsPort internally but exposes domain-neutral interface\r\n  const settingsRegistrationResult = container.registerClass(\r\n    platformSettingsRegistrationPortToken,\r\n    DIFoundrySettingsRegistrationAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsRegistrationResult)) {\r\n    return err(\r\n      `Failed to register PlatformSettingsRegistrationPort: ${settingsRegistrationResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryJournalFacade\r\n  // Combines Game, Document, UI for journal operations\r\n  const journalFacadeResult = container.registerClass(\r\n    foundryJournalFacadeToken,\r\n    DIFoundryJournalFacade,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(journalFacadeResult)) {\r\n    return err(`Failed to register FoundryJournalFacade: ${journalFacadeResult.error.message}`);\r\n  }\r\n\r\n  // Register JournalVisibilityService\r\n  // Uses PlatformJournalCollectionPort and PlatformJournalRepository (registered in entity-ports.config.ts)\r\n  const journalVisibilityResult = container.registerClass(\r\n    journalVisibilityServiceToken,\r\n    DIJournalVisibilityService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(journalVisibilityResult)) {\r\n    return err(\r\n      `Failed to register JournalVisibility service: ${journalVisibilityResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register JournalDirectoryProcessor\r\n  // Processes journal directory DOM to hide flagged entries\r\n  const journalDirectoryProcessorResult = container.registerClass(\r\n    journalDirectoryProcessorToken,\r\n    DIJournalDirectoryProcessor,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(journalDirectoryProcessorResult)) {\r\n    return err(\r\n      `Failed to register JournalDirectoryProcessor: ${journalDirectoryProcessorResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register FoundryLibWrapperService\r\n  const libWrapperServiceResult = container.registerClass(\r\n    libWrapperServiceToken,\r\n    DIFoundryLibWrapperService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(libWrapperServiceResult)) {\r\n    return err(`Failed to register LibWrapperService: ${libWrapperServiceResult.error.message}`);\r\n  }\r\n\r\n  // Register JournalContextMenuLibWrapperService\r\n  const contextMenuLibWrapperResult = container.registerClass(\r\n    journalContextMenuLibWrapperServiceToken,\r\n    DIJournalContextMenuLibWrapperService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(contextMenuLibWrapperResult)) {\r\n    return err(\r\n      `Failed to register JournalContextMenuLibWrapperService: ${contextMenuLibWrapperResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformContextMenuRegistrationPort (alias to JournalContextMenuLibWrapperService)\r\n  // This provides the domain-neutral port interface for context menu registration\r\n  const contextMenuPortResult = container.registerAlias(\r\n    platformContextMenuRegistrationPortToken,\r\n    journalContextMenuLibWrapperServiceToken\r\n  );\r\n  if (isErr(contextMenuPortResult)) {\r\n    return err(\r\n      `Failed to register PlatformContextMenuRegistrationPort: ${contextMenuPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"FoundryServices\",\r\n  priority: 80,\r\n  execute: registerFoundryServices,\r\n});\r\n","/**\r\n * Injection token for the PerformanceTrackingService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { PerformanceTrackingService } from \"@/infrastructure/performance/PerformanceTrackingService\";\r\n\r\n/**\r\n * Injection token for the PerformanceTrackingService.\r\n *\r\n * Provides centralized performance tracking with sampling support.\r\n * Automatically injects EnvironmentConfig and MetricsCollector.\r\n *\r\n * @example\r\n * ```typescript\r\n * const perfService = container.resolve(performanceTrackingServiceToken);\r\n * const result = perfService.track(() => expensiveOperation());\r\n * ```\r\n */\r\nexport const performanceTrackingServiceToken = createInjectionToken<PerformanceTrackingService>(\r\n  \"PerformanceTrackingService\"\r\n);\r\n","/**\r\n * Service for performance tracking with sampling support.\r\n * Provides centralized performance measurement with configurable sampling rates.\r\n *\r\n * This service wraps the performance tracking logic that was previously\r\n * implemented as utility functions, making it easier to:\r\n * - Inject via DI instead of passing ENV and MetricsCollector as parameters\r\n * - Test with mocks\r\n * - Configure centrally\r\n * - Add logging and metrics without modifying call sites\r\n *\r\n * **Design:**\r\n * Extends the shared PerformanceTrackerImpl base class to enable polymorphic usage\r\n * alongside BootstrapPerformanceTracker. This allows the same interface\r\n * to be used during bootstrap (no DI) and production (with DI).\r\n */\r\n\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { MetricsSampler } from \"@/infrastructure/observability/interfaces/metrics-sampler\";\r\nimport { metricsSamplerToken } from \"@/infrastructure/shared/tokens/observability/metrics-sampler.token\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { PerformanceTrackerImpl } from \"@/infrastructure/observability/performance-tracker-impl\";\r\n\r\n/**\r\n * Service for tracking performance of operations.\r\n *\r\n * Extends the shared PerformanceTrackerImpl base class to eliminate code duplication\r\n * with BootstrapPerformanceTracker.\r\n *\r\n * @example\r\n * ```typescript\r\n * const perfService = container.resolve(performanceTrackingServiceToken);\r\n *\r\n * // Track sync operation\r\n * const result = perfService.track(\r\n *   () => expensiveOperation(),\r\n *   (duration, result) => {\r\n *     console.log(`Operation took ${duration}ms`);\r\n *   }\r\n * );\r\n *\r\n * // Track async operation\r\n * const result = await perfService.trackAsync(\r\n *   async () => await fetchData(),\r\n *   (duration, result) => {\r\n *     metricsCollector.recordOperation(duration, result.ok);\r\n *   }\r\n * );\r\n * ```\r\n */\r\nexport class PerformanceTrackingService extends PerformanceTrackerImpl {\r\n  constructor(config: PlatformRuntimeConfigPort, sampler: MetricsSampler) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n\r\nexport class DIPerformanceTrackingService extends PerformanceTrackingService {\r\n  static dependencies = [runtimeConfigToken, metricsSamplerToken] as const;\r\n\r\n  constructor(config: PlatformRuntimeConfigPort, sampler: MetricsSampler) {\r\n    super(config, sampler);\r\n  }\r\n}\r\n","/**\r\n * Base retry service without observability concerns.\r\n * Single Responsibility: Only handles retry algorithm.\r\n *\r\n * This service provides the core retry logic with exponential backoff,\r\n * without any logging or timing measurements. Use RetryObservabilityDecorator\r\n * to add observability features.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Options for retry operations.\r\n * Allows customization of retry behavior and error handling.\r\n */\r\nexport interface RetryOptions<ErrorType> {\r\n  /**\r\n   * Maximum number of retry attempts.\r\n   * Must be >= 1.\r\n   * @default 3\r\n   */\r\n  maxAttempts?: number;\r\n\r\n  /**\r\n   * Base delay in milliseconds between retry attempts.\r\n   * With exponential backoff: delayMs * attempt (100ms, 200ms, 300ms, ...)\r\n   * @default 100\r\n   */\r\n  delayMs?: number;\r\n\r\n  /**\r\n   * Exponential backoff factor.\r\n   * Delay = delayMs * (attempt ^ backoffFactor)\r\n   * @default 1 (linear backoff)\r\n   */\r\n  backoffFactor?: number;\r\n\r\n  /**\r\n   * Maps exceptions (thrown errors or unknown errors) to the expected ErrorType.\r\n   *\r\n   * REQUIRED for type safety. Prevents unsafe 'as ErrorType' casts that violate type guarantees.\r\n   *\r\n   * @param error - The caught exception (unknown type)\r\n   * @param attempt - The current attempt number (1-based)\r\n   * @returns A valid ErrorType instance\r\n   */\r\n  mapException: (error: unknown, attempt: number) => ErrorType;\r\n}\r\n\r\n/**\r\n * Base retry service that provides core retry functionality\r\n * without observability (logging, timing).\r\n *\r\n * @example\r\n * ```typescript\r\n * const baseService = new BaseRetryService();\r\n * const result = await baseService.retry(\r\n *   () => fetchData(),\r\n *   {\r\n *     maxAttempts: 3,\r\n *     mapException: (error, attempt) => ({ code: 'FAILED', message: String(error) })\r\n *   }\r\n * );\r\n * ```\r\n */\r\nexport class BaseRetryService {\r\n  /**\r\n   * Retries an async operation with exponential backoff.\r\n   *\r\n   * @template SuccessType - The success type of the operation\r\n   * @template ErrorType - The error type of the operation\r\n   * @param fn - Async function that returns a Result\r\n   * @param options - Retry configuration options\r\n   * @returns Promise resolving to the Result (success or last error)\r\n   */\r\n  async retry<SuccessType, ErrorType>(\r\n    fn: () => Promise<Result<SuccessType, ErrorType>>,\r\n    options: RetryOptions<ErrorType>\r\n  ): Promise<Result<SuccessType, ErrorType>> {\r\n    const maxAttempts = options.maxAttempts ?? 3;\r\n    const delayMs = options.delayMs ?? 100;\r\n    const backoffFactor = options.backoffFactor ?? 1;\r\n    const { mapException } = options;\r\n\r\n    // Validate maxAttempts to prevent undefined errors\r\n    if (maxAttempts < 1) {\r\n      return err(mapException(\"maxAttempts must be >= 1\", 0));\r\n    }\r\n\r\n    // Sentinel-Wert, damit lastError auch in theoretisch unerreichbaren Pfaden\r\n    // niemals undefined ist. Die eigentlichen Fehler werden in der Schleife gesetzt.\r\n    let lastError: ErrorType = mapException(\"Initial retry error\", 0);\r\n\r\n    for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n      try {\r\n        // Wrap fn() in try/catch to handle thrown errors (breaks Result-Pattern)\r\n        const result = await fn();\r\n\r\n        if (result.ok) {\r\n          return result;\r\n        }\r\n\r\n        lastError = result.error;\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        // Exponential backoff: delay * (attempt ^ backoffFactor)\r\n        const delay = delayMs * Math.pow(attempt, backoffFactor);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n      } catch (error) {\r\n        // Handle exception-based code that breaks Result-Pattern\r\n        // Use mapException to convert unknown error to ErrorType\r\n        lastError = mapException(error, attempt);\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n\r\n        const delay = delayMs * Math.pow(attempt, backoffFactor);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n      }\r\n    }\r\n\r\n    return err(lastError);\r\n  }\r\n\r\n  /**\r\n   * Retries a synchronous operation.\r\n   * Similar to retry but for sync functions.\r\n   *\r\n   * @template SuccessType - The success type\r\n   * @template ErrorType - The error type\r\n   * @param fn - Function that returns a Result\r\n   * @param options - Retry configuration options (without delayMs and backoffFactor)\r\n   * @returns The Result (success or last error)\r\n   */\r\n  retrySync<SuccessType, ErrorType>(\r\n    fn: () => Result<SuccessType, ErrorType>,\r\n    options: Omit<RetryOptions<ErrorType>, \"delayMs\" | \"backoffFactor\">\r\n  ): Result<SuccessType, ErrorType> {\r\n    const maxAttempts = options.maxAttempts ?? 3;\r\n    const { mapException } = options;\r\n\r\n    // Validate maxAttempts to prevent undefined errors\r\n    if (maxAttempts < 1) {\r\n      return err(mapException(\"maxAttempts must be >= 1\", 0));\r\n    }\r\n\r\n    // Sentinel-Wert, damit lastError auch in theoretisch unerreichbaren Pfaden\r\n    // niemals undefined ist. Die eigentlichen Fehler werden in der Schleife gesetzt.\r\n    let lastError: ErrorType = mapException(\"Initial retry error\", 0);\r\n\r\n    for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n      try {\r\n        // Wrap fn() in try/catch to handle thrown errors (breaks Result-Pattern)\r\n        const result = fn();\r\n\r\n        if (result.ok) {\r\n          return result;\r\n        }\r\n\r\n        lastError = result.error;\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n      } catch (error) {\r\n        // Handle exception-based code that breaks Result-Pattern\r\n        // Use mapException to convert unknown error to ErrorType\r\n        lastError = mapException(error, attempt);\r\n\r\n        // Last attempt? Return error immediately\r\n        if (attempt === maxAttempts) {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return err(lastError);\r\n  }\r\n}\r\n","/**\r\n * Decorator that adds observability (logging, timing) to retry operations.\r\n * Single Responsibility: Only handles observability concerns.\r\n *\r\n * This decorator extends BaseRetryService to add logging and performance timing\r\n * without modifying the core retry algorithm.\r\n */\r\n\r\nimport { BaseRetryService, type RetryOptions } from \"./BaseRetryService\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\n\r\n/**\r\n * Options for retry operations with observability support.\r\n * Extends base RetryOptions with optional operation name for logging.\r\n */\r\nexport interface ObservableRetryOptions<ErrorType> extends RetryOptions<ErrorType> {\r\n  /**\r\n   * Optional operation name for logging purposes.\r\n   * If provided, retry attempts will be logged.\r\n   */\r\n  operationName?: string;\r\n}\r\n\r\n/**\r\n * Decorator that adds observability (logging, timing) to retry operations.\r\n *\r\n * @example\r\n * ```typescript\r\n * const decorator = new RetryObservabilityDecorator(logger);\r\n * const result = await decorator.retry(\r\n *   () => fetchData(),\r\n *   {\r\n *     maxAttempts: 3,\r\n *     operationName: \"fetchData\",\r\n *     mapException: (error, attempt) => ({ code: 'FAILED', message: String(error) })\r\n *   }\r\n * );\r\n * ```\r\n */\r\nexport class RetryObservabilityDecorator extends BaseRetryService {\r\n  constructor(private readonly logger: Logger) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Retries an async operation with exponential backoff and observability.\r\n   *\r\n   * @template SuccessType - The success type of the operation\r\n   * @template ErrorType - The error type of the operation\r\n   * @param fn - Async function that returns a Result\r\n   * @param options - Retry configuration options with optional observability\r\n   * @returns Promise resolving to the Result (success or last error)\r\n   */\r\n  override async retry<SuccessType, ErrorType>(\r\n    fn: () => Promise<Result<SuccessType, ErrorType>>,\r\n    options: ObservableRetryOptions<ErrorType>\r\n  ): Promise<Result<SuccessType, ErrorType>> {\r\n    const { operationName, ...baseOptions } = options;\r\n    const startTime = performance.now();\r\n\r\n    // Wrap fn to track attempts\r\n    let attemptCount = 0;\r\n    const wrappedFn = async (): Promise<Result<SuccessType, ErrorType>> => {\r\n      attemptCount++;\r\n      try {\r\n        const result = await fn();\r\n\r\n        if (!result.ok && attemptCount < (baseOptions.maxAttempts ?? 3)) {\r\n          // Log retry attempt for Result errors\r\n          if (operationName) {\r\n            this.logger.debug(\r\n              `Retry attempt ${attemptCount}/${baseOptions.maxAttempts ?? 3} failed for \"${operationName}\"`,\r\n              { error: result.error }\r\n            );\r\n          }\r\n        }\r\n\r\n        return result;\r\n      } catch (error) {\r\n        // Handle thrown exceptions - log with warn level\r\n        if (attemptCount < (baseOptions.maxAttempts ?? 3) && operationName) {\r\n          this.logger.warn(\r\n            `Retry attempt ${attemptCount}/${baseOptions.maxAttempts ?? 3} threw exception for \"${operationName}\"`,\r\n            { error }\r\n          );\r\n        }\r\n        // Re-throw to let BaseRetryService handle it\r\n        throw error;\r\n      }\r\n    };\r\n\r\n    const result = await super.retry(wrappedFn, baseOptions);\r\n    const duration = performance.now() - startTime;\r\n\r\n    if (operationName) {\r\n      if (result.ok && attemptCount > 1) {\r\n        // Log success if this wasn't the first attempt\r\n        this.logger.debug(\r\n          `Retry succeeded for \"${operationName}\" after ${attemptCount} attempts (${duration.toFixed(2)}ms)`\r\n        );\r\n      } else if (!result.ok) {\r\n        // Log failure after all attempts exhausted\r\n        this.logger.warn(\r\n          `All retry attempts exhausted for \"${operationName}\" after ${baseOptions.maxAttempts ?? 3} attempts (${duration.toFixed(2)}ms)`\r\n        );\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Retries a synchronous operation with observability.\r\n   *\r\n   * @template SuccessType - The success type\r\n   * @template ErrorType - The error type\r\n   * @param fn - Function that returns a Result\r\n   * @param options - Retry configuration options (without delayMs and backoffFactor)\r\n   * @returns The Result (success or last error)\r\n   */\r\n  override retrySync<SuccessType, ErrorType>(\r\n    fn: () => Result<SuccessType, ErrorType>,\r\n    options: Omit<ObservableRetryOptions<ErrorType>, \"delayMs\" | \"backoffFactor\">\r\n  ): Result<SuccessType, ErrorType> {\r\n    const { operationName, ...baseOptions } = options;\r\n    let attemptCount = 0;\r\n\r\n    const wrappedFn = (): Result<SuccessType, ErrorType> => {\r\n      attemptCount++;\r\n      try {\r\n        const result = fn();\r\n\r\n        if (!result.ok && attemptCount < (baseOptions.maxAttempts ?? 3)) {\r\n          // Log retry attempt for Result errors\r\n          if (operationName) {\r\n            this.logger.debug(\r\n              `Retry attempt ${attemptCount}/${baseOptions.maxAttempts ?? 3} failed for \"${operationName}\"`,\r\n              { error: result.error }\r\n            );\r\n          }\r\n        }\r\n\r\n        return result;\r\n      } catch (error) {\r\n        // Handle thrown exceptions - log with warn level\r\n        if (attemptCount < (baseOptions.maxAttempts ?? 3) && operationName) {\r\n          this.logger.warn(\r\n            `Retry attempt ${attemptCount}/${baseOptions.maxAttempts ?? 3} threw exception for \"${operationName}\"`,\r\n            { error }\r\n          );\r\n        }\r\n        // Re-throw to let BaseRetryService handle it\r\n        throw error;\r\n      }\r\n    };\r\n\r\n    const result = super.retrySync(wrappedFn, baseOptions);\r\n\r\n    if (operationName && !result.ok) {\r\n      // Log failure after all attempts exhausted\r\n      this.logger.warn(\r\n        `All retry attempts exhausted for \"${operationName}\" after ${baseOptions.maxAttempts ?? 3} attempts`\r\n      );\r\n    } else if (operationName && result.ok && attemptCount > 1) {\r\n      // Log success if this wasn't the first attempt\r\n      this.logger.debug(`Retry succeeded for \"${operationName}\" after ${attemptCount} attempts`);\r\n    }\r\n\r\n    return result;\r\n  }\r\n}\r\n","/**\r\n * Service for handling transient failures with automatic retry logic.\r\n * Provides retry operations with exponential backoff and optional logging.\r\n *\r\n * This service is composed from BaseRetryService (core retry algorithm) and\r\n * RetryObservabilityDecorator (logging and timing). This separation follows\r\n * the Single Responsibility Principle, making it easier to:\r\n * - Test retry logic without observability concerns\r\n * - Use retry logic without logging in performance-critical paths\r\n * - Modify observability without affecting retry algorithm\r\n *\r\n * Single Responsibility: Only provides the Retry-Interface.\r\n * Delegates all operations to the composed RetryObservabilityDecorator.\r\n */\r\n\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { BaseRetryService } from \"./BaseRetryService\";\r\nimport {\r\n  RetryObservabilityDecorator,\r\n  type ObservableRetryOptions,\r\n} from \"./RetryObservabilityDecorator\";\r\n\r\n/**\r\n * Options for retry operations.\r\n * Allows customization of retry behavior and error handling.\r\n *\r\n * This is an alias for ObservableRetryOptions to maintain backward compatibility.\r\n * The operationName field is optional, so existing code continues to work.\r\n */\r\nexport type RetryOptions<ErrorType> = ObservableRetryOptions<ErrorType>;\r\n\r\n/**\r\n * Type guard to check if a value is a Logger instance.\r\n * Used to narrow the type in constructor overloads.\r\n */\r\nfunction isLogger(value: Logger | BaseRetryService): value is Logger {\r\n  return !(value instanceof BaseRetryService);\r\n}\r\n\r\n/**\r\n * Service for retrying operations with exponential backoff.\r\n *\r\n * Composed from BaseRetryService (core retry algorithm) and\r\n * RetryObservabilityDecorator (logging and timing).\r\n * Uses composition instead of inheritance to follow SRP.\r\n *\r\n * @example\r\n * ```typescript\r\n * const retryService = container.resolve(retryServiceToken);\r\n *\r\n * // Retry async operation\r\n * const result = await retryService.retry(\r\n *   () => foundryApi.fetchData(),\r\n *   {\r\n *     maxAttempts: 3,\r\n *     delayMs: 100,\r\n *     operationName: \"fetchData\",\r\n *     mapException: (error, attempt) => ({\r\n *       code: 'OPERATION_FAILED' as const,\r\n *       message: `Attempt ${attempt} failed: ${String(error)}`\r\n *     })\r\n *   }\r\n * );\r\n *\r\n * // Retry sync operation\r\n * const result = retryService.retrySync(\r\n *   () => parseData(input),\r\n *   { maxAttempts: 3 }\r\n * );\r\n * ```\r\n */\r\nexport class RetryService {\r\n  private readonly composedService: RetryObservabilityDecorator;\r\n\r\n  /**\r\n   * Creates a new RetryService instance.\r\n   * Composes BaseRetryService and RetryObservabilityDecorator.\r\n   *\r\n   * @param logger - Logger instance for observability\r\n   */\r\n  constructor(logger: Logger);\r\n  /**\r\n   * Creates a new RetryService instance with explicit dependencies.\r\n   * Used internally by RetryServiceCompositionFactory for composition.\r\n   *\r\n   * @param baseRetryService - Base retry service (core algorithm)\r\n   * @param observabilityDecorator - Observability decorator (logging and timing)\r\n   */\r\n  constructor(\r\n    baseRetryService: BaseRetryService,\r\n    observabilityDecorator: RetryObservabilityDecorator\r\n  );\r\n  constructor(\r\n    loggerOrBaseService: Logger | BaseRetryService,\r\n    observabilityDecorator?: RetryObservabilityDecorator\r\n  ) {\r\n    if (observabilityDecorator) {\r\n      // Factory-based construction: use provided decorator\r\n      this.composedService = observabilityDecorator;\r\n    } else {\r\n      // Backward-compatible construction: create decorator with logger\r\n      // Use type guard to narrow the type without type assertion\r\n      if (!isLogger(loggerOrBaseService)) {\r\n        // This should never happen due to overload signature, but provides type safety\r\n        throw new Error(\"BaseRetryService cannot be used without RetryObservabilityDecorator\");\r\n      }\r\n      // TypeScript now knows loggerOrBaseService is Logger\r\n      this.composedService = new RetryObservabilityDecorator(loggerOrBaseService);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retries an async operation with exponential backoff.\r\n   *\r\n   * Useful for handling transient failures in external APIs (e.g., Foundry API calls).\r\n   *\r\n   * @template SuccessType - The success type of the operation\r\n   * @template ErrorType - The error type of the operation\r\n   * @param fn - Async function that returns a Result\r\n   * @param options - Retry configuration options\r\n   * @returns Promise resolving to the Result (success or last error)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = await retryService.retry(\r\n   *   () => foundryApi.fetchData(),\r\n   *   {\r\n   *     maxAttempts: 3,\r\n   *     delayMs: 100,\r\n   *     operationName: \"fetchData\",\r\n   *     mapException: (error, attempt) => ({\r\n   *       code: 'OPERATION_FAILED' as const,\r\n   *       message: `Attempt ${attempt} failed: ${String(error)}`\r\n   *     })\r\n   *   }\r\n   * );\r\n   * ```\r\n   */\r\n  async retry<SuccessType, ErrorType>(\r\n    fn: () => Promise<Result<SuccessType, ErrorType>>,\r\n    options: RetryOptions<ErrorType>\r\n  ): Promise<Result<SuccessType, ErrorType>> {\r\n    return this.composedService.retry(fn, options);\r\n  }\r\n\r\n  /**\r\n   * Retries a synchronous operation.\r\n   * Similar to retry but for sync functions.\r\n   *\r\n   * @template SuccessType - The success type\r\n   * @template ErrorType - The error type\r\n   * @param fn - Function that returns a Result\r\n   * @param options - Retry configuration options\r\n   * @returns The Result (success or last error)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = retryService.retrySync(\r\n   *   () => parseData(input),\r\n   *   {\r\n   *     maxAttempts: 3,\r\n   *     operationName: \"parseData\",\r\n   *     mapException: (error, attempt) => ({\r\n   *       code: 'PARSE_FAILED' as const,\r\n   *       message: `Parse attempt ${attempt} failed: ${String(error)}`\r\n   *     })\r\n   *   }\r\n   * );\r\n   * ```\r\n   */\r\n  retrySync<SuccessType, ErrorType>(\r\n    fn: () => Result<SuccessType, ErrorType>,\r\n    options: Omit<RetryOptions<ErrorType>, \"delayMs\" | \"backoffFactor\">\r\n  ): Result<SuccessType, ErrorType> {\r\n    return this.composedService.retrySync(fn, options);\r\n  }\r\n}\r\n\r\nexport class DIRetryService extends RetryService {\r\n  static dependencies = [loggerToken] as const;\r\n\r\n  constructor(logger: Logger) {\r\n    super(logger);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { performanceTrackingServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/performance-tracking-service.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { DIPerformanceTrackingService } from \"@/infrastructure/performance/PerformanceTrackingService\";\r\nimport { DIRetryService } from \"@/infrastructure/retry/RetryService\";\r\n\r\n/**\r\n * Registers utility services.\r\n *\r\n * Services registered:\r\n * - PerformanceTrackingService (singleton)\r\n * - RetryService (singleton)\r\n *\r\n * These services provide cross-cutting concerns like performance tracking\r\n * and retry logic with exponential backoff.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerUtilityServices(container: ServiceContainer): Result<void, string> {\r\n  // Register PerformanceTrackingService\r\n  const perfTrackingResult = container.registerClass(\r\n    performanceTrackingServiceToken,\r\n    DIPerformanceTrackingService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(perfTrackingResult)) {\r\n    return err(\r\n      `Failed to register PerformanceTrackingService: ${perfTrackingResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register RetryService\r\n  const retryServiceResult = container.registerClass(\r\n    retryServiceToken,\r\n    DIRetryService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(retryServiceResult)) {\r\n    return err(`Failed to register RetryService: ${retryServiceResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"UtilityServices\",\r\n  priority: 40,\r\n  execute: registerUtilityServices,\r\n});\r\n","/**\r\n * Injection token for the FoundryI18nPort.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { FoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\n\r\n/**\r\n * Injection token for the FoundryI18nPort.\r\n *\r\n * Provides access to Foundry VTT's i18n API via Port-Adapter pattern.\r\n * Automatically selects the correct port based on Foundry version.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(foundryI18nToken);\r\n * const result = i18n.localize(\"MODULE.SETTINGS.logLevel.name\");\r\n * if (result.ok) {\r\n *   console.log(result.value);\r\n * }\r\n * ```\r\n */\r\nexport const foundryI18nToken = createInjectionToken<FoundryI18nPort>(\"FoundryI18nPort\");\r\n","/**\r\n * Injection token for the LocalI18nService.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { LocalI18nService } from \"@/infrastructure/i18n/LocalI18nService\";\r\n\r\n/**\r\n * Injection token for the LocalI18nService.\r\n *\r\n * Provides Foundry-independent JSON-based translations.\r\n * Used as fallback when Foundry's i18n is unavailable.\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(localI18nToken);\r\n * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\");\r\n * console.log(result.value);\r\n * ```\r\n */\r\nexport const localI18nToken = createInjectionToken<LocalI18nService>(\"LocalI18nService\");\r\n","/**\r\n * Injection token for the FoundryTranslationHandler.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for the FoundryTranslationHandler.\r\n *\r\n * First handler in the translation chain: tries Foundry's i18n first.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const foundryTranslationHandlerToken = createInjectionToken<TranslationHandler>(\r\n  \"FoundryTranslationHandler\"\r\n);\r\n","/**\r\n * Injection token for the LocalTranslationHandler.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for the LocalTranslationHandler.\r\n *\r\n * Second handler in the translation chain: provides local JSON-based translations.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const localTranslationHandlerToken =\r\n  createInjectionToken<TranslationHandler>(\"LocalTranslationHandler\");\r\n","/**\r\n * Injection token for the FallbackTranslationHandler.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for the FallbackTranslationHandler.\r\n *\r\n * Final handler in the translation chain: returns fallback or key itself.\r\n * Part of the Chain of Responsibility pattern for i18n.\r\n */\r\nexport const fallbackTranslationHandlerToken = createInjectionToken<TranslationHandler>(\r\n  \"FallbackTranslationHandler\"\r\n);\r\n","/**\r\n * Injection token for the TranslationHandlerChain.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for the TranslationHandlerChain.\r\n *\r\n * Fully configured chain: Foundry → Local → Fallback.\r\n * Built via factory in DI container.\r\n */\r\nexport const translationHandlerChainToken =\r\n  createInjectionToken<TranslationHandler>(\"TranslationHandlerChain\");\r\n","/**\r\n * Injection token for array of TranslationHandler instances.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\n\r\n/**\r\n * Injection token for array of TranslationHandler instances.\r\n *\r\n * Allows multiple handlers to be registered and composed via DI.\r\n * Handlers are chained in the order they appear in the array.\r\n */\r\nexport const translationHandlersToken =\r\n  createInjectionToken<TranslationHandler[]>(\"TranslationHandlers\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { FoundryI18n } from \"../interfaces/FoundryI18n\";\r\nimport type { FoundryError } from \"../errors/FoundryErrors\";\r\nimport type { PortSelector } from \"../versioning/portselector\";\r\nimport type { PortRegistry } from \"../versioning/portregistry\";\r\nimport type { RetryService } from \"@/infrastructure/retry/RetryService\";\r\nimport type { Disposable } from \"@/infrastructure/di/interfaces\";\r\nimport { portSelectorToken } from \"@/infrastructure/shared/tokens/foundry/port-selector.token\";\r\nimport { foundryI18nPortRegistryToken } from \"@/infrastructure/shared/tokens/foundry/foundry-i18n-port-registry.token\";\r\nimport { retryServiceToken } from \"@/infrastructure/shared/tokens/infrastructure/retry-service.token\";\r\nimport { PortLoader } from \"./PortLoader\";\r\nimport { RetryableOperation } from \"./RetryableOperation\";\r\nimport { castDisposablePort } from \"../runtime-casts\";\r\n\r\n/**\r\n * Port wrapper for FoundryI18n that automatically selects the appropriate version\r\n * based on the current Foundry version.\r\n *\r\n * Uses composition instead of inheritance (PortLoader + RetryableOperation) to follow SRP.\r\n * This refactoring extracts concerns from FoundryServiceBase for better separation of responsibilities.\r\n */\r\nexport class FoundryI18nPort implements FoundryI18n, Disposable {\r\n  private readonly portLoader: PortLoader<FoundryI18n>;\r\n  private readonly retryable: RetryableOperation;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryI18n>,\r\n    retryService: RetryService\r\n  ) {\r\n    this.portLoader = new PortLoader(portSelector, portRegistry);\r\n    this.retryable = new RetryableOperation(retryService);\r\n  }\r\n\r\n  localize(key: string): Result<string, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.localize(key);\r\n    }, \"FoundryI18n.localize\");\r\n  }\r\n\r\n  format(key: string, data: Record<string, unknown>): Result<string, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.format(key, data);\r\n    }, \"FoundryI18n.format\");\r\n  }\r\n\r\n  has(key: string): Result<boolean, FoundryError> {\r\n    return this.retryable.execute(() => {\r\n      const portResult = this.portLoader.loadPort(\"FoundryI18n\");\r\n      if (!portResult.ok) return portResult;\r\n      return portResult.value.has(key);\r\n    }, \"FoundryI18n.has\");\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources.\r\n   * Disposes the port if it implements Disposable, then clears the cache.\r\n   */\r\n  dispose(): void {\r\n    const port = this.portLoader.getLoadedPort();\r\n    const disposable = castDisposablePort(port);\r\n    if (disposable) {\r\n      disposable.dispose();\r\n    }\r\n    this.portLoader.clearCache();\r\n  }\r\n}\r\n\r\nexport class DIFoundryI18nPort extends FoundryI18nPort {\r\n  static dependencies = [\r\n    portSelectorToken,\r\n    foundryI18nPortRegistryToken,\r\n    retryServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    portSelector: PortSelector,\r\n    portRegistry: PortRegistry<FoundryI18n>,\r\n    retryService: RetryService\r\n  ) {\r\n    super(portSelector, portRegistry, retryService);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Escapes special regex characters in a string.\r\n * Prevents regex injection when using user-provided strings in RegExp.\r\n *\r\n * @param str - String to escape\r\n * @returns Escaped string safe for use in RegExp\r\n */\r\nfunction escapeRegex(str: string): string {\r\n  return str.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n}\r\n\r\n/**\r\n * Local, Foundry-independent internationalization service.\r\n *\r\n * Provides fallback translations from JSON files when Foundry's i18n is unavailable.\r\n * Uses browser's locale detection for automatic language selection.\r\n *\r\n * **Design:**\r\n * - No Foundry dependency (can be used outside Foundry VTT)\r\n * - JSON-based translations loaded from `lang/` directory\r\n * - Browser locale detection via `navigator.language`\r\n * - Simple key-value lookup with fallback to key itself\r\n */\r\nexport class LocalI18nService {\r\n  static dependencies = [] as const;\r\n\r\n  private translations: Map<string, string> = new Map();\r\n  private currentLocale: string = \"en\";\r\n\r\n  constructor() {\r\n    this.detectLocale();\r\n  }\r\n\r\n  /**\r\n   * Detects browser locale and sets current language.\r\n   * Falls back to 'en' if detection fails.\r\n   */\r\n  private detectLocale(): void {\r\n    if (typeof navigator !== \"undefined\" && navigator.language) {\r\n      // Extract base language from locale (e.g., \"de-DE\" → \"de\")\r\n      const lang = navigator.language.split(\"-\")[0];\r\n      this.currentLocale = lang ?? \"en\";\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads translations from a JSON object.\r\n   * Useful for testing or pre-loaded translation data.\r\n   *\r\n   * @param translations - Object with key-value pairs\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const i18n = new LocalI18nService();\r\n   * i18n.loadTranslations({\r\n   *   \"MODULE.SETTINGS.logLevel.name\": \"Log Level\",\r\n   *   \"MODULE.WELCOME\": \"Welcome, {name}!\"\r\n   * });\r\n   * ```\r\n   */\r\n  loadTranslations(translations: Record<string, string>): void {\r\n    for (const [key, value] of Object.entries(translations)) {\r\n      this.translations.set(key, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Translates a key using local translations.\r\n   *\r\n   * @param key - Translation key\r\n   * @returns Result with translated string (or key itself if not found)\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Enable Feature\" or key if not found\r\n   * }\r\n   * ```\r\n   */\r\n  translate(key: string): Result<string, string> {\r\n    const value = this.translations.get(key);\r\n    return ok(value ?? key); // Fallback to key itself if not found\r\n  }\r\n\r\n  /**\r\n   * Formats a string with placeholders.\r\n   * Simple implementation: replaces `{key}` with values from data object.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @returns Result with formatted string\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // Translation: \"Welcome, {name}!\"\r\n   * const result = i18n.format(\"MODULE.WELCOME\", { name: \"Alice\" });\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Welcome, Alice!\"\r\n   * }\r\n   * ```\r\n   */\r\n  format(key: string, data: Record<string, unknown>): Result<string, string> {\r\n    const template = this.translations.get(key) ?? key;\r\n    let formatted = template;\r\n\r\n    // Simple placeholder replacement: {key} → value\r\n    // Escape placeholder to prevent regex injection with special characters\r\n    for (const [placeholder, value] of Object.entries(data)) {\r\n      const escapedPlaceholder = escapeRegex(placeholder);\r\n      const regex = new RegExp(`\\\\{${escapedPlaceholder}\\\\}`, \"g\");\r\n      formatted = formatted.replace(regex, String(value));\r\n    }\r\n\r\n    return ok(formatted);\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with boolean\r\n   */\r\n  has(key: string): Result<boolean, string> {\r\n    return ok(this.translations.has(key));\r\n  }\r\n\r\n  /**\r\n   * Gets the current locale.\r\n   *\r\n   * @returns Current locale string (e.g., \"en\", \"de\")\r\n   */\r\n  getCurrentLocale(): string {\r\n    return this.currentLocale;\r\n  }\r\n\r\n  /**\r\n   * Sets the current locale.\r\n   * Note: Changing locale requires reloading translations for the new language.\r\n   *\r\n   * @param locale - Locale code (e.g., \"en\", \"de\", \"fr\")\r\n   */\r\n  setLocale(locale: string): void {\r\n    this.currentLocale = locale;\r\n  }\r\n}\r\n\r\nexport class DILocalI18nService extends LocalI18nService {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { LocalI18nService } from \"./LocalI18nService\";\r\nimport { localI18nToken } from \"@/infrastructure/shared/tokens/i18n/local-i18n.token\";\r\nimport { translationHandlerChainToken } from \"@/infrastructure/shared/tokens/i18n/translation-handler-chain.token\";\r\nimport type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Facade service that combines Foundry's i18n and local fallback translations.\r\n *\r\n * **Pattern: Chain of Responsibility (via DI)**\r\n * 1. FoundryTranslationHandler → Try Foundry's `game.i18n`\r\n * 2. LocalTranslationHandler → Try local JSON-based translations\r\n * 3. FallbackTranslationHandler → Return key itself or provided fallback string\r\n *\r\n * Each handler tries to provide a translation. If it can't, it delegates to the next.\r\n *\r\n * **Dependency Injection:**\r\n * The handler chain is injected via DI, maintaining SOLID principles.\r\n * No `new` in application code - handlers are registered in DI container.\r\n *\r\n * **Use Cases:**\r\n * - Development/testing without Foundry runtime (uses LocalI18nService)\r\n * - Production with Foundry VTT (uses FoundryI18nPort)\r\n * - Graceful degradation when translations are missing\r\n *\r\n * @example\r\n * ```typescript\r\n * const i18n = container.resolve(i18nFacadeToken);\r\n *\r\n * // Try Foundry first, then local, then fallback\r\n * const result = i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\");\r\n * if (result.ok) {\r\n *   console.log(result.value); // Translated or fallback\r\n * }\r\n * ```\r\n */\r\nexport class I18nFacadeService {\r\n  constructor(\r\n    private readonly handlerChain: TranslationHandler,\r\n    private readonly localI18n: LocalI18nService\r\n  ) {}\r\n\r\n  /**\r\n   * Translates a key using the handler chain: Foundry → Local → Fallback.\r\n   *\r\n   * @param key - Translation key\r\n   * @param fallback - Optional fallback string (defaults to key itself)\r\n   * @returns Result with translated string or fallback\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * // With fallback\r\n   * const result = i18n.translate(\"MODULE.UNKNOWN_KEY\", \"Default Text\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Default Text\"\r\n   * }\r\n   *\r\n   * // Without fallback (returns key as fallback)\r\n   * const result2 = i18n.translate(\"MODULE.UNKNOWN_KEY\");\r\n   * if (result2.ok) {\r\n   *   console.log(result2.value); // \"MODULE.UNKNOWN_KEY\"\r\n   * }\r\n   * ```\r\n   */\r\n  translate(key: string, fallback?: string): Result<string, string> {\r\n    // Delegate to chain - it will try Foundry → Local → Fallback\r\n    return this.handlerChain.handle(key, undefined, fallback);\r\n  }\r\n\r\n  /**\r\n   * Formats a string with placeholders using the handler chain.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Object with placeholder values\r\n   * @param fallback - Optional fallback string\r\n   * @returns Result with formatted string or fallback\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const result = i18n.format(\"MODULE.WELCOME\", { name: \"Alice\" }, \"Welcome!\");\r\n   * if (result.ok) {\r\n   *   console.log(result.value); // \"Welcome, Alice!\" or \"Welcome!\"\r\n   * }\r\n   * ```\r\n   */\r\n  format(key: string, data: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    // Delegate to chain - it will try Foundry → Local → Fallback\r\n    return this.handlerChain.handle(key, data, fallback);\r\n  }\r\n\r\n  /**\r\n   * Checks if a translation key exists in the handler chain.\r\n   * Checks Foundry → Local (Fallback always returns false for has()).\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with true if key exists in Foundry or local i18n\r\n   */\r\n  has(key: string): Result<boolean, string> {\r\n    // Delegate to chain\r\n    return this.handlerChain.has(key);\r\n  }\r\n\r\n  /**\r\n   * Loads local translations from a JSON object.\r\n   * Useful for initializing translations on module startup.\r\n   *\r\n   * @param translations - Object with key-value pairs\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * i18n.loadLocalTranslations({\r\n   *   \"MODULE.SETTINGS.logLevel.name\": \"Log Level\",\r\n   *   \"MODULE.WELCOME\": \"Welcome, {name}!\"\r\n   * });\r\n   * ```\r\n   */\r\n  loadLocalTranslations(translations: Record<string, string>): void {\r\n    this.localI18n.loadTranslations(translations);\r\n  }\r\n}\r\n\r\nexport class DII18nFacadeService extends I18nFacadeService {\r\n  static dependencies = [translationHandlerChainToken, localI18nToken] as const;\r\n\r\n  constructor(handlerChain: TranslationHandler, localI18n: LocalI18nService) {\r\n    super(handlerChain, localI18n);\r\n  }\r\n}\r\n","import type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Abstract base class for translation handlers.\r\n * Implements the Chain of Responsibility pattern.\r\n *\r\n * Concrete handlers only need to implement:\r\n * - doHandle() - the actual translation logic\r\n * - doHas() - the key existence check\r\n */\r\nexport abstract class AbstractTranslationHandler implements TranslationHandler {\r\n  private nextHandler: TranslationHandler | null = null;\r\n\r\n  setNext(handler: TranslationHandler): TranslationHandler {\r\n    this.nextHandler = handler;\r\n    return handler; // Return handler for fluent chaining: a.setNext(b).setNext(c)\r\n  }\r\n\r\n  handle(key: string, data?: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    // Try to handle the request ourselves\r\n    const result = this.doHandle(key, data, fallback);\r\n    if (result.ok) {\r\n      return result;\r\n    }\r\n\r\n    // Delegate to next handler if available\r\n    if (this.nextHandler) {\r\n      return this.nextHandler.handle(key, data, fallback);\r\n    }\r\n\r\n    // No handler in chain could provide translation\r\n    // If fallback provided, use it; otherwise return error\r\n    if (fallback !== undefined) {\r\n      return ok(fallback);\r\n    }\r\n    return err(`Translation key not found: ${key}`);\r\n  }\r\n\r\n  has(key: string): Result<boolean, string> {\r\n    // Check our own source first\r\n    const ourResult = this.doHas(key);\r\n    if (!ourResult.ok) {\r\n      // Propagate error from doHas()\r\n      return ourResult;\r\n    }\r\n    if (ourResult.value) {\r\n      return ok(true);\r\n    }\r\n\r\n    // Check next handler if available\r\n    if (this.nextHandler) {\r\n      return this.nextHandler.has(key);\r\n    }\r\n\r\n    // No handler found the key\r\n    return ok(false);\r\n  }\r\n\r\n  /**\r\n   * Concrete implementation of translation logic.\r\n   * Should return Result with translated string, or error if this handler can't provide it.\r\n   *\r\n   * @param key - Translation key\r\n   * @param data - Optional data for placeholder replacement\r\n   * @param fallback - Optional fallback string\r\n   * @returns Result with translated string or error\r\n   */\r\n  protected abstract doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    fallback?: string\r\n  ): Result<string, string>;\r\n\r\n  /**\r\n   * Concrete implementation of key existence check.\r\n   * Should return Result with true if this handler's source contains the key.\r\n   *\r\n   * @param key - Translation key to check\r\n   * @returns Result with true if key exists in this handler's source, false otherwise, or error\r\n   */\r\n  protected abstract doHas(key: string): Result<boolean, string>;\r\n}\r\n","import type { FoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\nimport { foundryI18nToken } from \"@/infrastructure/shared/tokens/i18n/foundry-i18n.token\";\r\nimport { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Translation handler that uses Foundry's i18n system.\r\n *\r\n * First handler in the chain: tries Foundry's game.i18n first.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n */\r\nexport class FoundryTranslationHandler extends AbstractTranslationHandler {\r\n  constructor(private readonly foundryI18n: FoundryI18nPort) {\r\n    super();\r\n  }\r\n\r\n  protected doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    _fallback?: string\r\n  ): Result<string, string> {\r\n    // Use format() if data is provided, otherwise localize()\r\n    const result = data ? this.foundryI18n.format(key, data) : this.foundryI18n.localize(key);\r\n\r\n    if (result.ok && result.value !== key) {\r\n      // Foundry has a translation (not just returning the key)\r\n      return ok(result.value);\r\n    }\r\n\r\n    // Can't handle - return error to delegate to next handler\r\n    return err(`Foundry i18n could not translate key: ${key}`);\r\n  }\r\n\r\n  protected doHas(key: string): Result<boolean, string> {\r\n    const result = this.foundryI18n.has(key);\r\n    if (!result.ok) {\r\n      return err(`Failed to check Foundry i18n for key: ${key}`);\r\n    }\r\n    return ok(result.value);\r\n  }\r\n}\r\n\r\nexport class DIFoundryTranslationHandler extends FoundryTranslationHandler {\r\n  static dependencies = [foundryI18nToken] as const;\r\n\r\n  constructor(foundryI18n: FoundryI18nPort) {\r\n    super(foundryI18n);\r\n  }\r\n}\r\n","import type { LocalI18nService } from \"./LocalI18nService\";\r\nimport { localI18nToken } from \"@/infrastructure/shared/tokens/i18n/local-i18n.token\";\r\nimport { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Translation handler that uses local JSON-based translations.\r\n *\r\n * Second handler in the chain: provides fallback when Foundry i18n unavailable.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n */\r\nexport class LocalTranslationHandler extends AbstractTranslationHandler {\r\n  constructor(private readonly localI18n: LocalI18nService) {\r\n    super();\r\n  }\r\n\r\n  protected doHandle(\r\n    key: string,\r\n    data?: Record<string, unknown>,\r\n    _fallback?: string\r\n  ): Result<string, string> {\r\n    // Use format() if data is provided, otherwise translate()\r\n    const result = data ? this.localI18n.format(key, data) : this.localI18n.translate(key);\r\n\r\n    if (result.ok && result.value !== key) {\r\n      // Local i18n has a translation (not just returning the key)\r\n      return ok(result.value);\r\n    }\r\n\r\n    // Can't handle - return error to delegate to next handler\r\n    return err(`Local i18n could not translate key: ${key}`);\r\n  }\r\n\r\n  protected doHas(key: string): Result<boolean, string> {\r\n    const result = this.localI18n.has(key);\r\n    if (!result.ok) {\r\n      return err(`Failed to check local i18n for key: ${key}`);\r\n    }\r\n    return ok(result.value);\r\n  }\r\n}\r\n\r\nexport class DILocalTranslationHandler extends LocalTranslationHandler {\r\n  static dependencies = [localI18nToken] as const;\r\n\r\n  constructor(localI18n: LocalI18nService) {\r\n    super(localI18n);\r\n  }\r\n}\r\n","import { AbstractTranslationHandler } from \"./AbstractTranslationHandler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Final fallback handler in the translation chain.\r\n *\r\n * Always succeeds by returning the fallback string or the key itself.\r\n * Should be the last handler in the chain.\r\n *\r\n * **Dependency Injection:**\r\n * Registered as SINGLETON in DI container.\r\n * Has no dependencies (stateless).\r\n */\r\nexport class FallbackTranslationHandler extends AbstractTranslationHandler {\r\n  static dependencies = [] as const;\r\n  protected doHandle(\r\n    key: string,\r\n    _data?: Record<string, unknown>,\r\n    fallback?: string\r\n  ): Result<string, string> {\r\n    // Always return something: fallback or key\r\n    return ok(fallback ?? key);\r\n  }\r\n\r\n  protected doHas(_key: string): Result<boolean, string> {\r\n    // Fallback handler doesn't \"have\" any keys\r\n    // It just provides the fallback, so return false\r\n    return ok(false);\r\n  }\r\n}\r\n\r\nexport class DIFallbackTranslationHandler extends FallbackTranslationHandler {\r\n  static override dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import { translationHandlersToken } from \"@/infrastructure/shared/tokens/i18n/translation-handlers.token\";\r\nimport type { TranslationHandler } from \"./TranslationHandler.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\n\r\n/**\r\n * Small façade that wires the translation handlers into a chain of responsibility.\r\n * Handlers are chained in the order they appear in the array.\r\n */\r\nexport class TranslationHandlerChain implements TranslationHandler {\r\n  private readonly head: TranslationHandler;\r\n\r\n  constructor(handlers: TranslationHandler[]) {\r\n    assertNonEmptyHandlers(handlers);\r\n    const [head, ...rest] = handlers;\r\n    this.head = head;\r\n\r\n    // Chain handlers in order: each handler gets the next one as its successor\r\n    let current: TranslationHandler = head;\r\n    for (const handler of rest) {\r\n      current = current.setNext(handler);\r\n    }\r\n  }\r\n\r\n  setNext(handler: TranslationHandler): TranslationHandler {\r\n    return this.head.setNext(handler);\r\n  }\r\n\r\n  handle(key: string, data?: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    return this.head.handle(key, data, fallback);\r\n  }\r\n\r\n  has(key: string): Result<boolean, string> {\r\n    return this.head.has(key);\r\n  }\r\n}\r\n\r\nexport class DITranslationHandlerChain extends TranslationHandlerChain {\r\n  static dependencies = [translationHandlersToken] as const;\r\n\r\n  constructor(handlers: TranslationHandler[]) {\r\n    super(handlers);\r\n  }\r\n}\r\n\r\ntype NonEmptyHandlerList = [TranslationHandler, ...TranslationHandler[]];\r\n\r\nfunction assertNonEmptyHandlers(\r\n  handlers: TranslationHandler[]\r\n): asserts handlers is NonEmptyHandlerList {\r\n  if (handlers.length === 0) {\r\n    throw new Error(\"TranslationHandlerChain requires at least one handler\");\r\n  }\r\n}\r\n","import type { PlatformI18nPort } from \"@/domain/ports/platform-i18n-port.interface\";\r\nimport type { I18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { i18nFacadeToken } from \"@/infrastructure/shared/tokens/i18n/i18n-facade.token\";\r\n\r\n/**\r\n * Adapter that implements PlatformI18nPort by wrapping I18nFacadeService.\r\n *\r\n * Simple 1:1 mapping since I18nFacadeService is already platform-agnostic.\r\n */\r\nexport class I18nPortAdapter implements PlatformI18nPort {\r\n  constructor(private readonly i18nFacade: I18nFacadeService) {}\r\n\r\n  translate(key: string, fallback?: string): Result<string, string> {\r\n    return this.i18nFacade.translate(key, fallback);\r\n  }\r\n\r\n  format(key: string, data: Record<string, unknown>, fallback?: string): Result<string, string> {\r\n    return this.i18nFacade.format(key, data, fallback);\r\n  }\r\n\r\n  has(key: string): Result<boolean, string> {\r\n    return this.i18nFacade.has(key);\r\n  }\r\n\r\n  loadLocalTranslations(translations: Record<string, string>): void {\r\n    this.i18nFacade.loadLocalTranslations(translations);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for I18nPortAdapter.\r\n */\r\nexport class DII18nPortAdapter extends I18nPortAdapter {\r\n  static dependencies = [i18nFacadeToken] as const;\r\n\r\n  constructor(i18nFacade: I18nFacadeService) {\r\n    super(i18nFacade);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { platformI18nPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { foundryI18nToken } from \"@/infrastructure/shared/tokens/i18n/foundry-i18n.token\";\r\nimport { localI18nToken } from \"@/infrastructure/shared/tokens/i18n/local-i18n.token\";\r\nimport { i18nFacadeToken } from \"@/infrastructure/shared/tokens/i18n/i18n-facade.token\";\r\nimport { foundryTranslationHandlerToken } from \"@/infrastructure/shared/tokens/i18n/foundry-translation-handler.token\";\r\nimport { localTranslationHandlerToken } from \"@/infrastructure/shared/tokens/i18n/local-translation-handler.token\";\r\nimport { fallbackTranslationHandlerToken } from \"@/infrastructure/shared/tokens/i18n/fallback-translation-handler.token\";\r\nimport { translationHandlerChainToken } from \"@/infrastructure/shared/tokens/i18n/translation-handler-chain.token\";\r\nimport { translationHandlersToken } from \"@/infrastructure/shared/tokens/i18n/translation-handlers.token\";\r\nimport { DIFoundryI18nPort } from \"@/infrastructure/adapters/foundry/services/FoundryI18nPort\";\r\nimport { DILocalI18nService } from \"@/infrastructure/i18n/LocalI18nService\";\r\nimport { DII18nFacadeService } from \"@/infrastructure/i18n/I18nFacadeService\";\r\nimport { DIFoundryTranslationHandler } from \"@/infrastructure/i18n/FoundryTranslationHandler\";\r\nimport { DILocalTranslationHandler } from \"@/infrastructure/i18n/LocalTranslationHandler\";\r\nimport { DIFallbackTranslationHandler } from \"@/infrastructure/i18n/FallbackTranslationHandler\";\r\nimport { DITranslationHandlerChain } from \"@/infrastructure/i18n/TranslationHandlerChain\";\r\nimport type { TranslationHandler } from \"@/infrastructure/i18n/TranslationHandler.interface\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport { DII18nPortAdapter } from \"@/infrastructure/adapters/i18n/platform-i18n-port-adapter\";\r\n\r\n/**\r\n * Helper function to resolve multiple services and extract their values.\r\n * This function respects the Result-Pattern by propagating errors through Results\r\n * before converting to an exception (which is required by FactoryFunction<T>).\r\n *\r\n * @template T - The type of service to resolve\r\n * @param container - The service container\r\n * @param tokens - Array of tokens to resolve\r\n * @returns Array of resolved service instances\r\n * @throws Error if any service resolution fails\r\n */\r\nfunction resolveMultipleServices<T>(\r\n  container: ServiceContainer,\r\n  tokens: Array<{ token: symbol; name: string }>\r\n): T[] {\r\n  const results: T[] = [];\r\n  for (const { token, name } of tokens) {\r\n    const result = container.resolveWithError(token);\r\n    if (!result.ok) {\r\n      throw new Error(`Failed to resolve ${name}: ${result.error.message}`);\r\n    }\r\n    results.push(castResolvedService<T>(result.value));\r\n  }\r\n  return results;\r\n}\r\n\r\n/**\r\n * Registers internationalization (i18n) services.\r\n *\r\n * Services registered:\r\n * - FoundryI18nPort (singleton) - Wraps Foundry's i18n system\r\n * - LocalI18nService (singleton) - Local translations\r\n * - Translation Handlers (singleton) - Chain of Responsibility pattern\r\n *   - FoundryTranslationHandler\r\n *   - LocalTranslationHandler\r\n *   - FallbackTranslationHandler\r\n * - TranslationHandlerChain (singleton) - Builds die Handler-Kette im Konstruktor\r\n * - I18nFacadeService (singleton) - Facade combining all sources\r\n *\r\n * I18nFacadeService provides a unified interface for translations,\r\n * falling back from Foundry → Local → Fallback using Chain of Responsibility.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerI18nServices(container: ServiceContainer): Result<void, string> {\r\n  // Register FoundryI18nPort\r\n  const foundryI18nResult = container.registerClass(\r\n    foundryI18nToken,\r\n    DIFoundryI18nPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(foundryI18nResult)) {\r\n    return err(`Failed to register FoundryI18nPort: ${foundryI18nResult.error.message}`);\r\n  }\r\n\r\n  // Register LocalI18nService\r\n  const localI18nResult = container.registerClass(\r\n    localI18nToken,\r\n    DILocalI18nService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(localI18nResult)) {\r\n    return err(`Failed to register LocalI18nService: ${localI18nResult.error.message}`);\r\n  }\r\n\r\n  // Register Translation Handlers\r\n  const foundryHandlerResult = container.registerClass(\r\n    foundryTranslationHandlerToken,\r\n    DIFoundryTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(foundryHandlerResult)) {\r\n    return err(\r\n      `Failed to register FoundryTranslationHandler: ${foundryHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  const localHandlerResult = container.registerClass(\r\n    localTranslationHandlerToken,\r\n    DILocalTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(localHandlerResult)) {\r\n    return err(`Failed to register LocalTranslationHandler: ${localHandlerResult.error.message}`);\r\n  }\r\n\r\n  const fallbackHandlerResult = container.registerClass(\r\n    fallbackTranslationHandlerToken,\r\n    DIFallbackTranslationHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(fallbackHandlerResult)) {\r\n    return err(\r\n      `Failed to register FallbackTranslationHandler: ${fallbackHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register array of translation handlers using a factory function\r\n  // This allows handlers to be resolved after container validation\r\n  // NOTE: Factory functions must return T, not Result<T, E>, so we use a helper\r\n  // that respects the Result-Pattern by propagating Results before converting to exception\r\n  const handlersArrayResult = container.registerFactory(\r\n    translationHandlersToken,\r\n    (): TranslationHandler[] => {\r\n      return resolveMultipleServices<TranslationHandler>(container, [\r\n        { token: foundryTranslationHandlerToken, name: \"FoundryTranslationHandler\" },\r\n        { token: localTranslationHandlerToken, name: \"LocalTranslationHandler\" },\r\n        { token: fallbackTranslationHandlerToken, name: \"FallbackTranslationHandler\" },\r\n      ]);\r\n    },\r\n    ServiceLifecycle.SINGLETON,\r\n    [foundryTranslationHandlerToken, localTranslationHandlerToken, fallbackTranslationHandlerToken]\r\n  );\r\n  if (isErr(handlersArrayResult)) {\r\n    return err(\r\n      `Failed to register TranslationHandlers array: ${handlersArrayResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register Translation Handler Chain (uses array from DI)\r\n  const chainResult = container.registerClass(\r\n    translationHandlerChainToken,\r\n    DITranslationHandlerChain,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(chainResult)) {\r\n    return err(`Failed to register TranslationHandlerChain: ${chainResult.error.message}`);\r\n  }\r\n\r\n  // Register I18nFacadeService\r\n  const facadeResult = container.registerClass(\r\n    i18nFacadeToken,\r\n    DII18nFacadeService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(facadeResult)) {\r\n    return err(`Failed to register I18nFacadeService: ${facadeResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformI18nPort\r\n  const i18nPortResult = container.registerClass(\r\n    platformI18nPortToken,\r\n    DII18nPortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(i18nPortResult)) {\r\n    return err(`Failed to register PlatformI18nPort: ${i18nPortResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"I18nServices\",\r\n  priority: 120,\r\n  execute: registerI18nServices,\r\n});\r\n","/**\r\n * Injection token for ConsoleChannel.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformConsoleChannelPort } from \"@/domain/ports/notifications/platform-console-channel-port.interface\";\r\n\r\n/**\r\n * Injection token for ConsoleChannel.\r\n */\r\nexport const consoleChannelToken =\r\n  createInjectionToken<PlatformConsoleChannelPort>(\"ConsoleChannel\");\r\n","/**\r\n * Injection token for UIChannel.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/application/utils/token-factory\";\r\nimport type { PlatformUINotificationChannelPort } from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\n\r\n/**\r\n * Injection token for UIChannel.\r\n */\r\nexport const uiChannelToken = createInjectionToken<PlatformUINotificationChannelPort>(\"UIChannel\");\r\n","/**\r\n * Injection token for NotificationQueue.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { NotificationQueue } from \"@/infrastructure/notifications/NotificationQueue\";\r\n\r\n/**\r\n * Injection token for NotificationQueue.\r\n */\r\nexport const notificationQueueToken = createInjectionToken<NotificationQueue>(\"NotificationQueue\");\r\n","/**\r\n * NotificationCenter - Central Message Bus for all application notifications.\r\n *\r\n * **Responsibilities:**\r\n * - Route notifications to registered channels\r\n * - Support dynamic channel registration/removal\r\n * - Provide convenience methods for each log level\r\n * - Provide a single point to route notifications across channels\r\n *\r\n * **Architecture:**\r\n * - Uses only Domain-Ports (PlatformChannelPort)\r\n * - Application-Layer (Business-Logic: Routing-Entscheidungen)\r\n * - Platform-agnostic\r\n *\r\n * **Channel Flow:**\r\n * ```\r\n * Service → NotificationCenter → [ConsoleChannel, UIChannel, SentryChannel, ...]\r\n * ```\r\n *\r\n * @example\r\n * ```typescript\r\n * class MyService {\r\n *   static dependencies = [notificationCenterToken];\r\n *   constructor(private notifications: NotificationCenter) {}\r\n *\r\n *   doSomething() {\r\n *     this.notifications.debug(\"Processing data\");\r\n *     this.notifications.info(\"Completed\", { count: 10 });\r\n *     this.notifications.warn(\"Deprecated API used\");\r\n *     this.notifications.error(\"Operation failed\", error);\r\n *   }\r\n * }\r\n * ```\r\n */\r\n\r\nimport { err, ok } from \"@/domain/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformChannelPort,\r\n  PlatformNotification,\r\n} from \"@/domain/ports/notifications/platform-channel-port.interface\";\r\nimport type {\r\n  NotificationService,\r\n  NotificationCenterOptions,\r\n} from \"./notification-center.interface\";\r\nimport { consoleChannelToken } from \"@/application/tokens/notifications/console-channel.token\";\r\nimport { uiChannelToken } from \"@/application/tokens/notifications/ui-channel.token\";\r\n\r\n/**\r\n * Central hub for module notifications. Routes notifications to registered channels\r\n * (console, UI, remote logging, ...), performs channel filtering, and aggregates\r\n * errors when deliveries fail.\r\n */\r\nexport class NotificationCenter implements NotificationService {\r\n  private readonly channels: PlatformChannelPort[];\r\n\r\n  constructor(initialChannels: PlatformChannelPort[]) {\r\n    this.channels = [...initialChannels];\r\n  }\r\n\r\n  debug(\r\n    context: string,\r\n    data?: unknown,\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"debug\", context, payload, options);\r\n  }\r\n\r\n  info(context: string, data?: unknown, options?: NotificationCenterOptions): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"info\", context, payload, options);\r\n  }\r\n\r\n  warn(context: string, data?: unknown, options?: NotificationCenterOptions): Result<void, string> {\r\n    const payload = data === undefined ? {} : { data };\r\n    return this.notify(\"warn\", context, payload, options);\r\n  }\r\n\r\n  error(\r\n    context: string,\r\n    error?: PlatformNotification[\"error\"],\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const payload = error === undefined ? {} : { error };\r\n    return this.notify(\"error\", context, payload, options);\r\n  }\r\n\r\n  addChannel(channel: PlatformChannelPort): void {\r\n    const alreadyRegistered = this.channels.some((existing) => existing.name === channel.name);\r\n    if (!alreadyRegistered) {\r\n      this.channels.push(channel);\r\n    }\r\n  }\r\n\r\n  removeChannel(name: string): boolean {\r\n    const index = this.channels.findIndex((channel) => channel.name === name);\r\n    if (index === -1) {\r\n      return false;\r\n    }\r\n\r\n    this.channels.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  getChannelNames(): string[] {\r\n    return this.channels.map((channel) => channel.name);\r\n  }\r\n\r\n  private notify(\r\n    level: PlatformNotification[\"level\"],\r\n    context: string,\r\n    payload: Partial<Pick<PlatformNotification, \"data\" | \"error\">>,\r\n    options?: NotificationCenterOptions\r\n  ): Result<void, string> {\r\n    const notification: PlatformNotification = {\r\n      level,\r\n      context,\r\n      timestamp: new Date(),\r\n      ...(payload.data !== undefined ? { data: payload.data } : {}),\r\n      ...(payload.error !== undefined ? { error: payload.error } : {}),\r\n      ...(options?.traceId !== undefined ? { traceId: options.traceId } : {}),\r\n      ...(options?.uiOptions !== undefined ? { uiOptions: options.uiOptions } : {}),\r\n    };\r\n\r\n    const targetChannels = this.selectChannels(options?.channels);\r\n    let attempted = false;\r\n    let succeeded = false;\r\n    const failures: string[] = [];\r\n\r\n    for (const channel of targetChannels) {\r\n      if (!channel.canHandle(notification)) {\r\n        continue;\r\n      }\r\n\r\n      attempted = true;\r\n      const result = channel.send(notification);\r\n      if (result.ok) {\r\n        succeeded = true;\r\n      } else {\r\n        failures.push(`${channel.name}: ${result.error.message}`);\r\n      }\r\n    }\r\n\r\n    if (!attempted) {\r\n      // No channel attempted to handle this notification.\r\n      // If explicit channel names were provided, treat this as configuration error.\r\n      if (options?.channels && options.channels.length > 0) {\r\n        return err(\r\n          `No channels attempted to handle notification (requested: ${options.channels.join(\", \")})`\r\n        );\r\n      }\r\n\r\n      // Otherwise treat as no-op: nothing was able to handle the notification.\r\n      return ok(undefined);\r\n    }\r\n\r\n    if (succeeded) {\r\n      return ok(undefined);\r\n    }\r\n\r\n    return err(`All channels failed: ${failures.join(\"; \")}`);\r\n  }\r\n\r\n  private selectChannels(channelNames?: string[]): PlatformChannelPort[] {\r\n    if (!channelNames || channelNames.length === 0) {\r\n      return this.channels;\r\n    }\r\n\r\n    return this.channels.filter((channel) => channelNames.includes(channel.name));\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for NotificationCenter.\r\n * Injects channels via constructor.\r\n */\r\nexport class DINotificationCenter extends NotificationCenter {\r\n  static dependencies = [consoleChannelToken, uiChannelToken] as const;\r\n\r\n  constructor(consoleChannel: PlatformChannelPort, uiChannel: PlatformChannelPort) {\r\n    super([consoleChannel, uiChannel]);\r\n  }\r\n}\r\n","/**\r\n * Console Channel - Routes notifications to console.\r\n *\r\n * **Platform-Agnostic:**\r\n * - Uses PlatformLoggingPort (Domain-Port)\r\n * - Works with Foundry, Roll20, Headless\r\n *\r\n * **Responsibilities:**\r\n * - Send all notification levels to console\r\n * - Delegate to PlatformLoggingPort (debug, info, warn, error methods)\r\n * - No filtering - handles all notifications\r\n */\r\n\r\nimport type {\r\n  PlatformConsoleChannelPort,\r\n  PlatformNotification,\r\n  PlatformChannelError,\r\n} from \"@/domain/ports/notifications/platform-console-channel-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport { platformLoggingPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\nexport class ConsoleChannel implements PlatformConsoleChannelPort {\r\n  readonly name = \"ConsoleChannel\";\r\n\r\n  constructor(private readonly logger: PlatformLoggingPort) {}\r\n\r\n  canHandle(): boolean {\r\n    // Console accepts all notification levels\r\n    return true;\r\n  }\r\n\r\n  send(notification: PlatformNotification): Result<void, PlatformChannelError> {\r\n    const { level, context, data, error } = notification;\r\n    // For error level, prefer error over data; for other levels, prefer data over error\r\n    const payload = level === \"error\" ? (error ?? data) : (data ?? error);\r\n    this.log(level, context, payload);\r\n    return ok(undefined);\r\n  }\r\n\r\n  log(level: \"debug\" | \"info\" | \"warn\" | \"error\", message: string, data?: unknown): void {\r\n    switch (level) {\r\n      case \"debug\":\r\n        this.logger.debug(message, data);\r\n        break;\r\n      case \"info\":\r\n        this.logger.info(message, data);\r\n        break;\r\n      case \"warn\":\r\n        this.logger.warn(message, data);\r\n        break;\r\n      case \"error\":\r\n        this.logger.error(message, data);\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIConsoleChannel extends ConsoleChannel {\r\n  static dependencies = [platformLoggingPortToken] as const;\r\n\r\n  constructor(logger: PlatformLoggingPort) {\r\n    super(logger);\r\n  }\r\n}\r\n","/**\r\n * UI Channel - Routes notifications to platform UI.\r\n *\r\n * **Platform-Agnostic:**\r\n * - Uses PlatformUINotificationPort (Domain-Port)\r\n * - Works with Foundry, Roll20, Headless\r\n *\r\n * **Responsibilities:**\r\n * - Filter out debug messages (not relevant for end-users)\r\n * - Sanitize messages in production mode\r\n * - Map notification levels to UI notification types\r\n */\r\n\r\nimport type {\r\n  PlatformUINotificationChannelPort,\r\n  PlatformNotification,\r\n  PlatformChannelError,\r\n} from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\nimport type { PlatformUINotificationPort } from \"@/domain/ports/platform-ui-notification-port.interface\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { platformUINotificationPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\n\r\nexport class UIChannel implements PlatformUINotificationChannelPort {\r\n  readonly name = \"UIChannel\";\r\n\r\n  constructor(\r\n    private readonly platformUI: PlatformUINotificationPort,\r\n    private readonly config: PlatformRuntimeConfigPort\r\n  ) {}\r\n\r\n  canHandle(notification: PlatformNotification): boolean {\r\n    // Debug messages are too technical for UI\r\n    return notification.level !== \"debug\";\r\n  }\r\n\r\n  send(notification: PlatformNotification): Result<void, PlatformChannelError> {\r\n    const sanitizedMessage = this.sanitizeForUI(notification);\r\n    const uiTypeResult = this.mapLevelToUIType(notification.level);\r\n    if (!uiTypeResult.ok) {\r\n      return err({\r\n        code: \"MAPPING_FAILED\",\r\n        message: uiTypeResult.error,\r\n        channelName: this.name,\r\n      });\r\n    }\r\n\r\n    const result = this.platformUI.notify(sanitizedMessage, uiTypeResult.value);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"UI_NOTIFICATION_FAILED\",\r\n        message: result.error.message,\r\n        channelName: this.name,\r\n        details: result.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  notify(message: string, type: \"info\" | \"warning\" | \"error\"): Result<void, PlatformChannelError> {\r\n    const result = this.platformUI.notify(message, type);\r\n    if (!result.ok) {\r\n      return err({\r\n        code: \"UI_NOTIFICATION_FAILED\",\r\n        message: result.error.message,\r\n        channelName: this.name,\r\n        details: result.error,\r\n      });\r\n    }\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Sanitizes notification message for UI display.\r\n   *\r\n   * Development: Shows detailed messages\r\n   * Production: Shows generic messages to prevent information leakage\r\n   */\r\n  private sanitizeForUI(notification: PlatformNotification): string {\r\n    const { level, context, data, error } = notification;\r\n\r\n    if (this.config.get(\"isDevelopment\")) {\r\n      // Development: Show meaningful details\r\n      if (level === \"error\" && error) {\r\n        return `${context}: ${error.message}`;\r\n      }\r\n      if (data && typeof data === \"object\" && \"message\" in data) {\r\n        return `${context}: ${String(data.message)}`;\r\n      }\r\n      return context;\r\n    }\r\n\r\n    // Production: Generic messages\r\n    if (level === \"error\" && error) {\r\n      // Show error code (not sensitive) for support debugging\r\n      return `${context}. Please try again or contact support. (Error: ${error.code})`;\r\n    }\r\n\r\n    // Info/Warn: Show context only (assume context is already user-friendly)\r\n    return context;\r\n  }\r\n\r\n  /**\r\n   * Maps notification level to UI notification type.\r\n   * Protected to allow testing of exhaustive type check.\r\n   */\r\n  protected mapLevelToUIType(\r\n    level: PlatformNotification[\"level\"]\r\n  ): Result<\"info\" | \"warning\" | \"error\", string> {\r\n    switch (level) {\r\n      case \"info\":\r\n        return ok(\"info\");\r\n      case \"warn\":\r\n        return ok(\"warning\");\r\n      case \"error\":\r\n        return ok(\"error\");\r\n      case \"debug\": {\r\n        // TypeScript-Compiler sollte hier warnen, wenn debug nicht mehr im Union ist\r\n        // This should never be called because canHandle() filters out debug level\r\n        // Return error to satisfy exhaustive check without type assertion\r\n        return err(`Debug level should be filtered by canHandle(). Received: ${level}`);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIUIChannel extends UIChannel {\r\n  static dependencies = [platformUINotificationPortToken, runtimeConfigToken] as const;\r\n\r\n  constructor(platformUI: PlatformUINotificationPort, config: PlatformRuntimeConfigPort) {\r\n    super(platformUI, config);\r\n  }\r\n}\r\n","/**\r\n * QueuedUIChannel - Decorator for UIChannel that queues notifications before UI is available.\r\n *\r\n * **Responsibilities:**\r\n * - Queue notifications when UI is not available\r\n * - Flush queue when UI becomes available\r\n * - Delegate to real UIChannel when UI is available\r\n *\r\n * **Design:**\r\n * - Decorator Pattern: Wraps UIChannel\r\n * - Uses NotificationQueue for storage\r\n * - Uses PlatformUIAvailabilityPort for availability checks\r\n * - Implements PlatformUINotificationChannelPort (same interface as UIChannel)\r\n */\r\n\r\nimport type {\r\n  PlatformUINotificationChannelPort,\r\n  PlatformNotification,\r\n  PlatformChannelError,\r\n} from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\nimport type { PlatformUIAvailabilityPort } from \"@/domain/ports/platform-ui-availability-port.interface\";\r\nimport type { NotificationQueue } from \"@/infrastructure/notifications/NotificationQueue\";\r\nimport type { PlatformUINotificationChannelPort as UIChannelType } from \"@/domain/ports/notifications/platform-ui-notification-channel-port.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { notificationQueueToken } from \"@/infrastructure/shared/tokens/notifications/notification-queue.token\";\r\nimport { platformUIAvailabilityPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { uiChannelToken } from \"@/application/tokens/notifications/ui-channel.token\";\r\nimport type { PlatformContainerPort } from \"@/domain/ports/platform-container-port.interface\";\r\nimport { platformContainerPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * QueuedUIChannel decorates UIChannel with queue functionality.\r\n */\r\nexport class QueuedUIChannel implements PlatformUINotificationChannelPort {\r\n  readonly name = \"UIChannel\";\r\n\r\n  private realChannel: UIChannelType | null = null;\r\n  private hasFlushed = false;\r\n\r\n  constructor(\r\n    private readonly queue: NotificationQueue,\r\n    private readonly uiAvailability: PlatformUIAvailabilityPort,\r\n    private readonly container: PlatformContainerPort\r\n  ) {}\r\n\r\n  /**\r\n   * Gets or creates the real UIChannel.\r\n   * Uses lazy initialization to avoid creating channel before UI is available.\r\n   */\r\n  private getRealChannel(): UIChannelType | null {\r\n    if (this.realChannel) {\r\n      return this.realChannel;\r\n    }\r\n\r\n    // Try to resolve UIChannel from container\r\n    const channelResult = this.container.resolveWithError<UIChannelType>(uiChannelToken);\r\n    if (!channelResult.ok) {\r\n      return null;\r\n    }\r\n\r\n    this.realChannel = channelResult.value;\r\n    return this.realChannel;\r\n  }\r\n\r\n  /**\r\n   * Determines if this channel should handle the notification.\r\n   * Delegates to real channel if available, otherwise uses same logic as UIChannel.\r\n   */\r\n  canHandle(notification: PlatformNotification): boolean {\r\n    // Debug messages are too technical for UI (same as UIChannel)\r\n    if (notification.level === \"debug\") {\r\n      return false;\r\n    }\r\n\r\n    // If real channel is available, delegate\r\n    const realChannel = this.getRealChannel();\r\n    if (realChannel) {\r\n      return realChannel.canHandle(notification);\r\n    }\r\n\r\n    // Otherwise, use same logic (non-debug messages)\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Sends notification to UI or queues it if UI is not available.\r\n   */\r\n  send(notification: PlatformNotification): Result<void, PlatformChannelError> {\r\n    // Check if UI is available\r\n    if (this.uiAvailability.isAvailable()) {\r\n      // Flush queue if not already flushed\r\n      if (!this.hasFlushed && this.queue.size > 0) {\r\n        const realChannel = this.getRealChannel();\r\n        if (realChannel) {\r\n          this.queue.flush((n) => {\r\n            // Ignore errors during flush (best effort)\r\n            realChannel.send(n);\r\n          });\r\n        }\r\n        this.hasFlushed = true;\r\n      }\r\n\r\n      // Send immediately via real channel\r\n      const realChannel = this.getRealChannel();\r\n      if (!realChannel) {\r\n        // UI is available but channel can't be resolved - queue it\r\n        this.queue.enqueue(notification);\r\n        return ok(undefined);\r\n      }\r\n\r\n      return realChannel.send(notification);\r\n    }\r\n\r\n    // UI not available - queue notification\r\n    // Debug messages should not be queued (same as UIChannel logic)\r\n    if (notification.level === \"debug\") {\r\n      return ok(undefined); // Silently ignore debug messages\r\n    }\r\n\r\n    this.queue.enqueue(notification);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Sends notification directly to UI (bypasses queue).\r\n   * Used for immediate notifications when UI is available.\r\n   */\r\n  notify(message: string, type: \"info\" | \"warning\" | \"error\"): Result<void, PlatformChannelError> {\r\n    // If UI is available, use real channel\r\n    if (this.uiAvailability.isAvailable()) {\r\n      const realChannel = this.getRealChannel();\r\n      if (!realChannel) {\r\n        return err({\r\n          code: \"CHANNEL_NOT_AVAILABLE\",\r\n          message: \"UIChannel could not be resolved\",\r\n          channelName: this.name,\r\n        });\r\n      }\r\n\r\n      return realChannel.notify(message, type);\r\n    }\r\n\r\n    // UI not available - cannot send immediate notification\r\n    return err({\r\n      code: \"UI_NOT_AVAILABLE\",\r\n      message: \"UI is not available for immediate notifications\",\r\n      channelName: this.name,\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for QueuedUIChannel.\r\n */\r\nexport class DIQueuedUIChannel extends QueuedUIChannel {\r\n  static dependencies = [\r\n    notificationQueueToken,\r\n    platformUIAvailabilityPortToken,\r\n    platformContainerPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    queue: NotificationQueue,\r\n    uiAvailability: PlatformUIAvailabilityPort,\r\n    container: PlatformContainerPort\r\n  ) {\r\n    super(queue, uiAvailability, container);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformNotificationPort,\r\n  PlatformNotificationError,\r\n  PlatformNotificationOptions,\r\n} from \"@/domain/ports/platform-notification-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { NotificationChannelRegistryPort } from \"@/domain/ports/notifications/notification-channel-registry-port.interface\";\r\nimport type {\r\n  NotificationService,\r\n  NotificationCenterOptions,\r\n} from \"@/application/services/notification-center.interface\";\r\nimport type { FoundryNotificationOptions } from \"@/infrastructure/adapters/foundry/interfaces/FoundryUI\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { notificationCenterToken } from \"@/application/tokens/notifications/notification-center.token\";\r\n\r\n/**\r\n * Adapter that implements PlatformNotificationPort by wrapping NotificationCenter.\r\n *\r\n * This adapter implements both NotificationPublisherPort and NotificationChannelRegistryPort,\r\n * following the Interface Segregation Principle (ISP) by providing separate interfaces\r\n * for different responsibilities.\r\n *\r\n * Translates platform-agnostic options to NotificationCenter options.\r\n * Handles Foundry-specific options via type guards internally.\r\n */\r\nexport class NotificationPortAdapter\r\n  implements PlatformNotificationPort, NotificationPublisherPort, NotificationChannelRegistryPort\r\n{\r\n  constructor(private readonly notificationCenter: NotificationService) {}\r\n\r\n  debug(\r\n    context: string,\r\n    data?: unknown,\r\n    options?: PlatformNotificationOptions\r\n  ): Result<void, PlatformNotificationError> {\r\n    const centerOptions = this.mapToCenterOptions(options);\r\n    const result = this.notificationCenter.debug(context, data, centerOptions);\r\n    return this.mapResult(result);\r\n  }\r\n\r\n  info(\r\n    context: string,\r\n    data?: unknown,\r\n    options?: PlatformNotificationOptions\r\n  ): Result<void, PlatformNotificationError> {\r\n    const centerOptions = this.mapToCenterOptions(options);\r\n    const result = this.notificationCenter.info(context, data, centerOptions);\r\n    return this.mapResult(result);\r\n  }\r\n\r\n  warn(\r\n    context: string,\r\n    data?: unknown,\r\n    options?: PlatformNotificationOptions\r\n  ): Result<void, PlatformNotificationError> {\r\n    const centerOptions = this.mapToCenterOptions(options);\r\n    const result = this.notificationCenter.warn(context, data, centerOptions);\r\n    return this.mapResult(result);\r\n  }\r\n\r\n  error(\r\n    context: string,\r\n    error?: { code?: string; message: string; details?: unknown },\r\n    options?: PlatformNotificationOptions\r\n  ): Result<void, PlatformNotificationError> {\r\n    const centerOptions = this.mapToCenterOptions(options);\r\n    const result = this.notificationCenter.error(context, error, centerOptions);\r\n    return this.mapResult(result);\r\n  }\r\n\r\n  addChannel(_channelName: string): Result<void, PlatformNotificationError> {\r\n    // NotificationCenter uses channel objects, not names\r\n    // This would need to be implemented via a channel registry or similar\r\n    return err({\r\n      code: \"OPERATION_NOT_SUPPORTED\",\r\n      message:\r\n        \"Dynamic channel addition via name not supported. Use NotificationCenter.addChannel() directly.\",\r\n      operation: \"addChannel\",\r\n    });\r\n  }\r\n\r\n  removeChannel(channelName: string): Result<boolean, PlatformNotificationError> {\r\n    const removed = this.notificationCenter.removeChannel(channelName);\r\n    return ok(removed);\r\n  }\r\n\r\n  getChannelNames(): Result<string[], PlatformNotificationError> {\r\n    const names = this.notificationCenter.getChannelNames();\r\n    return ok(names);\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  /**\r\n   * Maps platform-agnostic options to NotificationCenter options.\r\n   * Handles Foundry-specific options via type guard if present.\r\n   */\r\n  private mapToCenterOptions(\r\n    options?: PlatformNotificationOptions\r\n  ): NotificationCenterOptions | undefined {\r\n    if (!options) return undefined;\r\n\r\n    const centerOptions: NotificationCenterOptions = {\r\n      ...(options.channels !== undefined && { channels: options.channels }),\r\n      ...(options.traceId !== undefined && { traceId: options.traceId }),\r\n    };\r\n\r\n    // Type guard: Check if options contain Foundry-specific properties\r\n    // This allows adapters to pass Foundry options without exposing them in the domain\r\n    if (this.isFoundryNotificationOptions(options)) {\r\n      // Extract Foundry-specific options safely\r\n      const foundryOptions: FoundryNotificationOptions = {\r\n        ...(options.permanent !== undefined && { permanent: options.permanent }),\r\n        ...(options.console !== undefined && { console: options.console }),\r\n        ...(options.localize !== undefined && { localize: options.localize }),\r\n        ...(options.progress !== undefined && { progress: options.progress }),\r\n        ...(options.clean !== undefined && { clean: options.clean }),\r\n        ...(options.escape !== undefined && { escape: options.escape }),\r\n        ...(options.format !== undefined && { format: options.format }),\r\n      };\r\n      centerOptions.uiOptions = foundryOptions;\r\n    }\r\n\r\n    return centerOptions;\r\n  }\r\n\r\n  /**\r\n   * Type guard to detect Foundry-specific notification options.\r\n   * This allows adapters to pass Foundry options without exposing them in the domain interface.\r\n   */\r\n  private isFoundryNotificationOptions(\r\n    options: unknown\r\n  ): options is PlatformNotificationOptions & Partial<FoundryNotificationOptions> {\r\n    return (\r\n      typeof options === \"object\" &&\r\n      options !== null &&\r\n      (\"permanent\" in options ||\r\n        \"console\" in options ||\r\n        \"localize\" in options ||\r\n        \"progress\" in options ||\r\n        \"clean\" in options ||\r\n        \"escape\" in options ||\r\n        \"format\" in options)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Maps NotificationCenter Result to PlatformNotificationPort Result.\r\n   */\r\n  private mapResult(result: Result<void, string>): Result<void, PlatformNotificationError> {\r\n    if (result.ok) {\r\n      return ok(undefined);\r\n    }\r\n    return err({\r\n      code: \"NOTIFICATION_FAILED\",\r\n      message: result.error,\r\n      operation: \"notify\",\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for NotificationPortAdapter.\r\n */\r\nexport class DINotificationPortAdapter extends NotificationPortAdapter {\r\n  static dependencies = [notificationCenterToken] as const;\r\n\r\n  constructor(notificationCenter: NotificationService) {\r\n    super(notificationCenter);\r\n  }\r\n}\r\n","/**\r\n * NotificationQueue - Manages a queue of notifications for delayed delivery.\r\n *\r\n * **Responsibilities:**\r\n * - Store notifications until UI becomes available\r\n * - Enforce max size limit (removes oldest when limit reached)\r\n * - Flush all queued notifications when UI becomes available\r\n * - Clear queue on demand\r\n *\r\n * **Design:**\r\n * - Uses FIFO (First In, First Out) queue\r\n * - Max size is configurable via RuntimeConfig (with ENV fallback)\r\n * - When queue is full, oldest notifications are removed\r\n */\r\n\r\nimport type { PlatformNotification } from \"@/domain/ports/notifications/platform-channel-port.interface\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { EnvironmentConfig } from \"@/domain/types/environment-config\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { environmentConfigToken } from \"@/infrastructure/shared/tokens/core/environment-config.token\";\r\n\r\n/**\r\n * NotificationQueue manages a queue of notifications for delayed delivery.\r\n */\r\nexport class NotificationQueue {\r\n  private readonly queue: PlatformNotification[] = [];\r\n\r\n  constructor(\r\n    private readonly runtimeConfig: PlatformRuntimeConfigPort,\r\n    private readonly env: EnvironmentConfig\r\n  ) {}\r\n\r\n  /**\r\n   * Gets the maximum queue size from RuntimeConfig, with ENV fallback.\r\n   */\r\n  private getMaxSize(): number {\r\n    const value = this.runtimeConfig.get(\"notificationQueueMaxSize\");\r\n    // Fallback: ENV default (should always be set, but safety check)\r\n    return value ?? this.env.notificationQueueDefaultSize;\r\n  }\r\n\r\n  /**\r\n   * Adds a notification to the queue.\r\n   * If the queue is full, removes the oldest notification.\r\n   */\r\n  enqueue(notification: PlatformNotification): void {\r\n    const maxSize = this.getMaxSize();\r\n\r\n    // Remove oldest if queue is full\r\n    if (this.queue.length >= maxSize) {\r\n      this.queue.shift(); // Remove first (oldest) element\r\n    }\r\n\r\n    this.queue.push(notification);\r\n  }\r\n\r\n  /**\r\n   * Flushes all queued notifications by calling the handler for each.\r\n   * Queue is cleared after flushing.\r\n   */\r\n  flush(handler: (notification: PlatformNotification) => void): void {\r\n    // Process all notifications\r\n    for (const notification of this.queue) {\r\n      try {\r\n        handler(notification);\r\n      } catch (_error) {\r\n        // Ignore errors during flush (best effort)\r\n        // Errors are logged by the handler if it's a channel\r\n      }\r\n    }\r\n\r\n    // Clear queue after flushing\r\n    this.queue.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Clears all queued notifications without processing them.\r\n   */\r\n  clear(): void {\r\n    this.queue.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Gets the current number of queued notifications.\r\n   */\r\n  get size(): number {\r\n    return this.queue.length;\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for NotificationQueue.\r\n */\r\nexport class DINotificationQueue extends NotificationQueue {\r\n  static dependencies = [runtimeConfigToken, environmentConfigToken] as const;\r\n\r\n  constructor(runtimeConfig: PlatformRuntimeConfigPort, env: EnvironmentConfig) {\r\n    super(runtimeConfig, env);\r\n  }\r\n}\r\n","/**\r\n * Foundry-specific implementation of PlatformUIAvailabilityPort.\r\n *\r\n * Checks if Foundry UI (ui.notifications) is available.\r\n * In Foundry, UI becomes available during the 'init' hook.\r\n */\r\n\r\nimport type { PlatformUIAvailabilityPort } from \"@/domain/ports/platform-ui-availability-port.interface\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformUIAvailabilityPort.\r\n */\r\nexport class FoundryUIAvailabilityPort implements PlatformUIAvailabilityPort {\r\n  /**\r\n   * Checks if Foundry UI is available.\r\n   * UI is available when `ui` is defined and `ui.notifications` exists.\r\n   */\r\n  isAvailable(): boolean {\r\n    return typeof ui !== \"undefined\" && ui?.notifications !== undefined;\r\n  }\r\n\r\n  /**\r\n   * Optional callback registration for when UI becomes available.\r\n   * Not implemented for now - can be extended with event-based approach later.\r\n   */\r\n  onAvailable?(_callback: () => void): void {\r\n    // Not implemented - polling via isAvailable() is sufficient for now\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for FoundryUIAvailabilityPort.\r\n */\r\nexport class DIFoundryUIAvailabilityPort extends FoundryUIAvailabilityPort {\r\n  static dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { notificationCenterToken } from \"@/application/tokens/notifications/notification-center.token\";\r\nimport { consoleChannelToken } from \"@/application/tokens/notifications/console-channel.token\";\r\nimport { uiChannelToken } from \"@/application/tokens/notifications/ui-channel.token\";\r\nimport { queuedUIChannelToken } from \"@/application/tokens/notifications/queued-ui-channel.token\";\r\nimport {\r\n  platformNotificationPortToken,\r\n  notificationPublisherPortToken,\r\n  notificationChannelRegistryPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { platformUIAvailabilityPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { notificationQueueToken } from \"@/infrastructure/shared/tokens/notifications/notification-queue.token\";\r\nimport { DINotificationCenter } from \"@/application/services/NotificationCenter\";\r\nimport { DIConsoleChannel } from \"@/infrastructure/notifications/channels/ConsoleChannel\";\r\nimport { DIUIChannel } from \"@/infrastructure/notifications/channels/UIChannel\";\r\nimport { DIQueuedUIChannel } from \"@/infrastructure/notifications/channels/QueuedUIChannel\";\r\nimport { DINotificationPortAdapter } from \"@/infrastructure/adapters/notifications/platform-notification-port-adapter\";\r\nimport { DINotificationQueue } from \"@/infrastructure/notifications/NotificationQueue\";\r\nimport { DIFoundryUIAvailabilityPort } from \"@/infrastructure/adapters/foundry/services/FoundryUIAvailabilityPort\";\r\n\r\n/**\r\n * Registers notification services and channels.\r\n *\r\n * **Architecture:**\r\n * 1. Register NotificationQueue (for queuing notifications before UI is available)\r\n * 2. Register PlatformUIAvailabilityPort (for checking UI availability)\r\n * 3. Register Channels (ConsoleChannel, UIChannel, QueuedUIChannel) als Singletons\r\n * 4. Register NotificationCenter via DI-Wrapper (erhält Channels injiziert)\r\n *\r\n * **Channel Flow:**\r\n * NotificationCenter → [ConsoleChannel, QueuedUIChannel, ...]\r\n * QueuedUIChannel → [Queue] → UIChannel (when UI available)\r\n *\r\n * **Extensibility:**\r\n * Add new channels by:\r\n * 1. Creating a new class implementing NotificationChannel\r\n * 2. Registering it here as singleton\r\n * 3. Adding it to the NotificationCenter factory array\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerNotifications(container: ServiceContainer): Result<void, string> {\r\n  // Register NotificationQueue (required by QueuedUIChannel)\r\n  const notificationQueueResult = container.registerClass(\r\n    notificationQueueToken,\r\n    DINotificationQueue,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(notificationQueueResult)) {\r\n    return err(`Failed to register NotificationQueue: ${notificationQueueResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformUIAvailabilityPort (required by QueuedUIChannel)\r\n  const uiAvailabilityResult = container.registerClass(\r\n    platformUIAvailabilityPortToken,\r\n    DIFoundryUIAvailabilityPort,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiAvailabilityResult)) {\r\n    return err(\r\n      `Failed to register PlatformUIAvailabilityPort: ${uiAvailabilityResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ConsoleChannel\r\n  const consoleChannelResult = container.registerClass(\r\n    consoleChannelToken,\r\n    DIConsoleChannel,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(consoleChannelResult)) {\r\n    return err(`Failed to register ConsoleChannel: ${consoleChannelResult.error.message}`);\r\n  }\r\n\r\n  // Register UIChannel (required by QueuedUIChannel)\r\n  const uiChannelResult = container.registerClass(\r\n    uiChannelToken,\r\n    DIUIChannel,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiChannelResult)) {\r\n    return err(`Failed to register UIChannel: ${uiChannelResult.error.message}`);\r\n  }\r\n\r\n  // Register QueuedUIChannel (wraps UIChannel with queue functionality)\r\n  const queuedUIChannelResult = container.registerClass(\r\n    queuedUIChannelToken,\r\n    DIQueuedUIChannel,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(queuedUIChannelResult)) {\r\n    return err(`Failed to register QueuedUIChannel: ${queuedUIChannelResult.error.message}`);\r\n  }\r\n\r\n  // Register NotificationCenter as singleton (with ConsoleChannel and UIChannel)\r\n  const notificationCenterResult = container.registerClass(\r\n    notificationCenterToken,\r\n    DINotificationCenter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n\r\n  if (isErr(notificationCenterResult)) {\r\n    return err(`Failed to register NotificationCenter: ${notificationCenterResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformNotificationPort (full interface)\r\n  const notificationPortResult = container.registerClass(\r\n    platformNotificationPortToken,\r\n    DINotificationPortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(notificationPortResult)) {\r\n    return err(\r\n      `Failed to register PlatformNotificationPort: ${notificationPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register NotificationPublisherPort (ISP-compliant: only publishing methods)\r\n  // Binds to the same adapter class as PlatformNotificationPort\r\n  // Since PlatformNotificationPort extends NotificationPublisherPort, the adapter implements both\r\n  const publisherPortResult = container.registerClass(\r\n    notificationPublisherPortToken,\r\n    DINotificationPortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(publisherPortResult)) {\r\n    return err(\r\n      `Failed to register NotificationPublisherPort: ${publisherPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register NotificationChannelRegistryPort (ISP-compliant: only channel management methods)\r\n  // Binds to the same adapter class as PlatformNotificationPort\r\n  // Since PlatformNotificationPort extends NotificationChannelRegistryPort, the adapter implements both\r\n  const channelRegistryPortResult = container.registerClass(\r\n    notificationChannelRegistryPortToken,\r\n    DINotificationPortAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(channelRegistryPortResult)) {\r\n    return err(\r\n      `Failed to register NotificationChannelRegistryPort: ${channelRegistryPortResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"Notifications\",\r\n  priority: 130,\r\n  execute: registerNotifications,\r\n});\r\n","import { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"@/application/settings/setting-definition.interface\";\r\nimport type { RuntimeConfigKey } from \"@/domain/types/runtime-config\";\r\nimport type { PlatformSettingsRegistrationPort } from \"@/domain/ports/platform-settings-registration-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { PlatformI18nPort } from \"@/domain/ports/platform-i18n-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport {\r\n  runtimeConfigSettingsSyncToken,\r\n  settingRegistrationErrorMapperToken,\r\n} from \"@/application/tokens/application.tokens\";\r\nimport { platformSettingsRegistrationPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport {\r\n  notificationPublisherPortToken,\r\n  platformI18nPortToken,\r\n  platformValidationPortToken,\r\n  platformLoggingPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport type { RuntimeConfigBinding } from \"@/application/services/RuntimeConfigSync\";\r\nimport type { SettingRegistrationErrorMapper } from \"./SettingRegistrationErrorMapper\";\r\nimport type { IRuntimeConfigSettingsSync } from \"./runtime-config-settings-sync\";\r\nimport type { SettingDefinitionRegistry } from \"./registries/setting-definition-registry.interface\";\r\nimport type { RuntimeConfigBindingRegistry } from \"./registries/runtime-config-binding-registry.interface\";\r\nimport {\r\n  settingDefinitionRegistryToken,\r\n  runtimeConfigBindingRegistryToken,\r\n} from \"@/application/tokens/application.tokens\";\r\n\r\n/**\r\n * ModuleSettingsRegistrar\r\n *\r\n * Registers all Foundry module settings using definition-based approach.\r\n * Each setting is defined separately for better organization and testability.\r\n *\r\n * **Design Benefits:**\r\n * - Easy to add new settings without modifying this class (Open/Closed Principle)\r\n * - Each setting definition can be tested in isolation\r\n * - Clear separation between registration logic and setting configuration\r\n * - Full DI: All dependencies injected via constructor (no Service Locator)\r\n * - Registry-based: Settings and bindings provided via registries, enabling extension without modification\r\n *\r\n * **OCP-Compliant:**\r\n * - New settings can be added by extending SettingDefinitionRegistry\r\n * - New bindings can be added by extending RuntimeConfigBindingRegistry\r\n * - No code changes needed in ModuleSettingsRegistrar for new settings/bindings\r\n *\r\n * **DIP-Compliant:**\r\n * - Uses PlatformSettingsRegistrationPort instead of PlatformSettingsPort\r\n * - Uses domain-neutral SettingValidators instead of Valibot schemas\r\n * - No infrastructure layer imports for validation\r\n * - Depends on registry abstractions, not concrete implementations\r\n */\r\nexport class ModuleSettingsRegistrar {\r\n  constructor(\r\n    private readonly settings: PlatformSettingsRegistrationPort,\r\n    private readonly runtimeConfigSettingsSync: IRuntimeConfigSettingsSync,\r\n    private readonly errorMapper: SettingRegistrationErrorMapper,\r\n    private readonly notifications: NotificationPublisherPort,\r\n    private readonly i18n: PlatformI18nPort,\r\n    private readonly logger: PlatformLoggingPort,\r\n    private readonly validator: PlatformValidationPort,\r\n    private readonly settingDefinitionRegistry: SettingDefinitionRegistry,\r\n    private readonly runtimeConfigBindingRegistry: RuntimeConfigBindingRegistry\r\n  ) {}\r\n\r\n  /**\r\n   * Registers all module settings.\r\n   * Must be called during or after the 'init' hook.\r\n   *\r\n   * Iterates over settings from SettingDefinitionRegistry and applies\r\n   * corresponding bindings from RuntimeConfigBindingRegistry.\r\n   *\r\n   * Implements Open/Closed Principle: New settings can be added via registry\r\n   * extension without modifying this method.\r\n   */\r\n  registerAll(): void {\r\n    const definitions = this.settingDefinitionRegistry.getAll();\r\n    const bindings = this.runtimeConfigBindingRegistry.getAll();\r\n\r\n    for (const definition of definitions) {\r\n      const binding = bindings.get(definition.key);\r\n      this.registerDefinition(\r\n        definition,\r\n        binding,\r\n        this.settings,\r\n        this.runtimeConfigSettingsSync,\r\n        this.errorMapper,\r\n        this.i18n,\r\n        this.logger,\r\n        this.validator\r\n      );\r\n    }\r\n  }\r\n\r\n  private registerDefinition<TSchema, K extends RuntimeConfigKey>(\r\n    definition: SettingDefinition<TSchema>,\r\n    binding: RuntimeConfigBinding<TSchema, K> | undefined,\r\n    settings: PlatformSettingsRegistrationPort,\r\n    runtimeConfigSettingsSync: IRuntimeConfigSettingsSync,\r\n    errorMapper: SettingRegistrationErrorMapper,\r\n    i18n: PlatformI18nPort,\r\n    logger: PlatformLoggingPort,\r\n    validator: PlatformValidationPort\r\n  ): void {\r\n    const config = definition.createConfig(i18n, logger, validator);\r\n    const configWithRuntimeBridge = binding\r\n      ? runtimeConfigSettingsSync.attachBinding(config, binding)\r\n      : config;\r\n\r\n    const result = settings.registerSetting(\r\n      MODULE_METADATA.ID,\r\n      definition.key,\r\n      configWithRuntimeBridge\r\n    );\r\n\r\n    if (!result.ok) {\r\n      errorMapper.mapAndNotify(result.error, definition.key);\r\n      return;\r\n    }\r\n\r\n    if (binding) {\r\n      runtimeConfigSettingsSync.syncInitialValue(settings, binding, definition.key);\r\n    }\r\n  }\r\n}\r\n\r\nexport class DIModuleSettingsRegistrar extends ModuleSettingsRegistrar {\r\n  static dependencies = [\r\n    platformSettingsRegistrationPortToken,\r\n    runtimeConfigSettingsSyncToken,\r\n    settingRegistrationErrorMapperToken,\r\n    notificationPublisherPortToken,\r\n    platformI18nPortToken,\r\n    platformLoggingPortToken,\r\n    platformValidationPortToken,\r\n    settingDefinitionRegistryToken,\r\n    runtimeConfigBindingRegistryToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    settings: PlatformSettingsRegistrationPort,\r\n    runtimeConfigSettingsSync: IRuntimeConfigSettingsSync,\r\n    errorMapper: SettingRegistrationErrorMapper,\r\n    notifications: NotificationPublisherPort,\r\n    i18n: PlatformI18nPort,\r\n    logger: PlatformLoggingPort,\r\n    validator: PlatformValidationPort,\r\n    settingDefinitionRegistry: SettingDefinitionRegistry,\r\n    runtimeConfigBindingRegistry: RuntimeConfigBindingRegistry\r\n  ) {\r\n    super(\r\n      settings,\r\n      runtimeConfigSettingsSync,\r\n      errorMapper,\r\n      notifications,\r\n      i18n,\r\n      logger,\r\n      validator,\r\n      settingDefinitionRegistry,\r\n      runtimeConfigBindingRegistry\r\n    );\r\n  }\r\n}\r\n","import { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport type { RuntimeConfigKey, RuntimeConfigValues } from \"@/domain/types/runtime-config\";\r\nimport type { PlatformRuntimeConfigPort } from \"@/domain/ports/platform-runtime-config-port.interface\";\r\nimport type { SettingConfig as ModuleSettingConfig } from \"@/application/settings/setting-definition.interface\";\r\nimport type { PlatformSettingsRegistrationPort } from \"@/domain/ports/platform-settings-registration-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { SettingValidator } from \"@/domain/types/setting-validator\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { notificationPublisherPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Binding configuration for syncing a setting with RuntimeConfig.\r\n *\r\n * Uses domain-neutral SettingValidator instead of Valibot schemas.\r\n */\r\nexport interface RuntimeConfigBinding<TSchema, K extends RuntimeConfigKey> {\r\n  runtimeKey: K;\r\n  validator: SettingValidator<TSchema>;\r\n  normalize: (value: TSchema) => RuntimeConfigValues[K];\r\n}\r\n\r\n/**\r\n * RuntimeConfigSync\r\n *\r\n * Handles synchronization between Foundry Settings and RuntimeConfigService.\r\n * Separated from ModuleSettingsRegistrar to follow Single Responsibility Principle.\r\n *\r\n * **Responsibilities:**\r\n * - Bind RuntimeConfig synchronization to Setting onChange callbacks\r\n * - Synchronize initial Setting values to RuntimeConfig on registration\r\n *\r\n * **Design Benefits:**\r\n * - Single Responsibility: Only handles RuntimeConfig synchronization\r\n * - Reusable: Can be used for any Setting-to-RuntimeConfig binding\r\n * - Testable: Isolated from Settings registration logic\r\n */\r\nexport class RuntimeConfigSync {\r\n  constructor(\r\n    private readonly runtimeConfig: PlatformRuntimeConfigPort,\r\n    private readonly notifications: NotificationPublisherPort\r\n  ) {}\r\n\r\n  /**\r\n   * Bindet RuntimeConfig-Synchronisation an ein Setting.\r\n   *\r\n   * Wraps the original onChange callback and adds RuntimeConfig synchronization.\r\n   *\r\n   * @param config - The Setting configuration\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @returns Modified config with RuntimeConfig bridge attached\r\n   */\r\n  attachBinding<TSchema, K extends RuntimeConfigKey>(\r\n    config: ModuleSettingConfig<TSchema>,\r\n    binding: RuntimeConfigBinding<TSchema, K>\r\n  ): ModuleSettingConfig<TSchema> {\r\n    const originalOnChange = config.onChange;\r\n    return {\r\n      ...config,\r\n      onChange: (value: TSchema) => {\r\n        const normalized = binding.normalize(value);\r\n        this.runtimeConfig.setFromPlatform(binding.runtimeKey, normalized);\r\n        originalOnChange?.(value);\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Synchronisiert initialen Setting-Wert zu RuntimeConfig.\r\n   *\r\n   * Reads the current Setting value and updates RuntimeConfig accordingly.\r\n   *\r\n   * @param settings - Settings port for reading values\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @param settingKey - The Setting key to read\r\n   */\r\n  syncInitialValue<TSchema, K extends RuntimeConfigKey>(\r\n    settings: PlatformSettingsRegistrationPort,\r\n    binding: RuntimeConfigBinding<TSchema, K>,\r\n    settingKey: string\r\n  ): void {\r\n    const currentValue = settings.getSettingValue(\r\n      MODULE_METADATA.ID,\r\n      settingKey,\r\n      binding.validator\r\n    );\r\n\r\n    if (!currentValue.ok) {\r\n      this.notifications.warn(\r\n        `Failed to read initial value for ${settingKey}`,\r\n        currentValue.error,\r\n        {\r\n          channels: [\"ConsoleChannel\"],\r\n        }\r\n      );\r\n      return;\r\n    }\r\n\r\n    this.runtimeConfig.setFromPlatform(binding.runtimeKey, binding.normalize(currentValue.value));\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for RuntimeConfigSync.\r\n */\r\nexport class DIRuntimeConfigSync extends RuntimeConfigSync {\r\n  static dependencies = [runtimeConfigToken, notificationPublisherPortToken] as const;\r\n\r\n  constructor(runtimeConfig: PlatformRuntimeConfigPort, notifications: NotificationPublisherPort) {\r\n    super(runtimeConfig, notifications);\r\n  }\r\n}\r\n","import type { RuntimeConfigKey } from \"@/domain/types/runtime-config\";\r\nimport type { SettingConfig as ModuleSettingConfig } from \"@/application/settings/setting-definition.interface\";\r\nimport type { PlatformSettingsRegistrationPort } from \"@/domain/ports/platform-settings-registration-port.interface\";\r\nimport {\r\n  RuntimeConfigSync,\r\n  type RuntimeConfigBinding,\r\n} from \"@/application/services/RuntimeConfigSync\";\r\nimport { runtimeConfigSyncToken } from \"@/application/tokens/application.tokens\";\r\n\r\n/**\r\n * Interface for RuntimeConfig settings synchronization.\r\n *\r\n * Encapsulates the responsibility of synchronizing Foundry Settings with RuntimeConfig.\r\n * Separated from ModuleSettingsRegistrar to follow Single Responsibility Principle.\r\n */\r\nexport interface IRuntimeConfigSettingsSync {\r\n  /**\r\n   * Attaches RuntimeConfig synchronization binding to a setting configuration.\r\n   *\r\n   * @param config - The Setting configuration\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @returns Modified config with RuntimeConfig bridge attached\r\n   */\r\n  attachBinding<TSchema, K extends RuntimeConfigKey>(\r\n    config: ModuleSettingConfig<TSchema>,\r\n    binding: RuntimeConfigBinding<TSchema, K>\r\n  ): ModuleSettingConfig<TSchema>;\r\n\r\n  /**\r\n   * Synchronizes initial Setting value to RuntimeConfig.\r\n   *\r\n   * @param settings - Settings port for reading values\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @param settingKey - The Setting key to read\r\n   */\r\n  syncInitialValue<TSchema, K extends RuntimeConfigKey>(\r\n    settings: PlatformSettingsRegistrationPort,\r\n    binding: RuntimeConfigBinding<TSchema, K>,\r\n    settingKey: string\r\n  ): void;\r\n}\r\n\r\n/**\r\n * RuntimeConfigSettingsSync\r\n *\r\n * Handles synchronization between Foundry Settings and RuntimeConfigService.\r\n * This class encapsulates the synchronization responsibility, delegating to RuntimeConfigSync\r\n * for the actual implementation.\r\n *\r\n * **Responsibilities:**\r\n * - Bind RuntimeConfig synchronization to Setting onChange callbacks\r\n * - Synchronize initial Setting values to RuntimeConfig on registration\r\n *\r\n * **Design Benefits:**\r\n * - Single Responsibility: Only handles RuntimeConfig synchronization for Settings\r\n * - Separation of Concerns: Settings registration is separate from synchronization\r\n * - Delegation: Uses RuntimeConfigSync for actual implementation\r\n * - Testable: Isolated from Settings registration logic\r\n */\r\nexport class RuntimeConfigSettingsSync implements IRuntimeConfigSettingsSync {\r\n  constructor(private readonly runtimeConfigSync: RuntimeConfigSync) {}\r\n\r\n  /**\r\n   * Attaches RuntimeConfig synchronization binding to a setting configuration.\r\n   *\r\n   * Delegates to RuntimeConfigSync.attachBinding().\r\n   *\r\n   * @param config - The Setting configuration\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @returns Modified config with RuntimeConfig bridge attached\r\n   */\r\n  attachBinding<TSchema, K extends RuntimeConfigKey>(\r\n    config: ModuleSettingConfig<TSchema>,\r\n    binding: RuntimeConfigBinding<TSchema, K>\r\n  ): ModuleSettingConfig<TSchema> {\r\n    return this.runtimeConfigSync.attachBinding(config, binding);\r\n  }\r\n\r\n  /**\r\n   * Synchronizes initial Setting value to RuntimeConfig.\r\n   *\r\n   * Delegates to RuntimeConfigSync.syncInitialValue().\r\n   *\r\n   * @param settings - Settings port for reading values\r\n   * @param binding - Binding configuration for RuntimeConfig sync\r\n   * @param settingKey - The Setting key to read\r\n   */\r\n  syncInitialValue<TSchema, K extends RuntimeConfigKey>(\r\n    settings: PlatformSettingsRegistrationPort,\r\n    binding: RuntimeConfigBinding<TSchema, K>,\r\n    settingKey: string\r\n  ): void {\r\n    this.runtimeConfigSync.syncInitialValue(settings, binding, settingKey);\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for RuntimeConfigSettingsSync.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DIRuntimeConfigSettingsSync extends RuntimeConfigSettingsSync {\r\n  static dependencies = [runtimeConfigSyncToken] as const;\r\n\r\n  constructor(runtimeConfigSync: RuntimeConfigSync) {\r\n    super(runtimeConfigSync);\r\n  }\r\n}\r\n","import type { DomainSettingsError } from \"@/domain/types/settings\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport { notificationPublisherPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Maps DomainSettingsError to notification format.\r\n * Single Responsibility: Only handles error format conversion and notification.\r\n */\r\nexport class SettingRegistrationErrorMapper {\r\n  constructor(private readonly notifications: NotificationPublisherPort) {}\r\n\r\n  mapAndNotify(error: DomainSettingsError, settingKey: string): void {\r\n    const notificationError: { code: string; message: string; [key: string]: unknown } = {\r\n      code: error.code,\r\n      message: error.message,\r\n      ...(error.details !== undefined && { details: error.details }),\r\n    };\r\n\r\n    this.notifications.error(`Failed to register ${settingKey} setting`, notificationError, {\r\n      channels: [\"ConsoleChannel\"],\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * DI wrapper for SettingRegistrationErrorMapper.\r\n * Injects dependencies via constructor.\r\n */\r\nexport class DISettingRegistrationErrorMapper extends SettingRegistrationErrorMapper {\r\n  static dependencies = [notificationPublisherPortToken] as const;\r\n\r\n  constructor(notifications: NotificationPublisherPort) {\r\n    super(notifications);\r\n  }\r\n}\r\n","/**\r\n * Runtime-safe cast utilities for registry type conversions.\r\n *\r\n * Diese Datei kapselt Type-Assertions für Registry-Implementierungen,\r\n * die aufgrund von TypeScript's Varianzregeln notwendig sind.\r\n *\r\n * SettingDefinition und RuntimeConfigBinding sind invariant aufgrund\r\n * von Callbacks, aber zur Laufzeit sind die Werte kompatibel mit\r\n * den generischen Typen (unknown, RuntimeConfigKey).\r\n *\r\n * @ts-expect-error - Type coverage exclusion: This file intentionally uses type assertions\r\n * for runtime-safe casts that are necessary for registry type variance handling.\r\n */\r\n\r\nimport type { SettingDefinition } from \"@/application/settings/setting-definition.interface\";\r\nimport type { RuntimeConfigKey } from \"@/domain/types/runtime-config\";\r\nimport type { RuntimeConfigBinding } from \"@/application/services/RuntimeConfigSync\";\r\n\r\n/**\r\n * Converts a SettingDefinition<T> to SettingDefinition<unknown>.\r\n *\r\n * SettingDefinition is invariant due to the onChange callback, but at runtime\r\n * all definitions are compatible with SettingDefinition<unknown> because Foundry\r\n * calls onChange with the validated type T.\r\n *\r\n * @template T - The specific setting value type\r\n * @param definition - The setting definition with specific type\r\n * @returns The definition as SettingDefinition<unknown>\r\n */\r\nexport function castSettingDefinitionToUnknown<T>(\r\n  definition: SettingDefinition<T>\r\n): SettingDefinition<unknown> {\r\n  return definition as SettingDefinition<unknown>;\r\n}\r\n\r\n/**\r\n * Converts a RuntimeConfigBinding<TSchema, K> to RuntimeConfigBinding<unknown, RuntimeConfigKey>.\r\n *\r\n * RuntimeConfigBinding has specific types per key, but we need a generic type\r\n * for Map iteration in registry implementations. The cast is safe because:\r\n * 1. The validator will check the value at runtime\r\n * 2. The normalize function receives values that have already been validated\r\n * 3. At runtime, the value will be of the specific type when used\r\n *\r\n * This function accepts the binding as unknown first to handle union types from Object.entries(),\r\n * then casts it to the generic type needed for the registry.\r\n *\r\n * @param binding - The binding (can be a union of specific binding types from Object.entries())\r\n * @returns The binding as RuntimeConfigBinding<unknown, RuntimeConfigKey>\r\n */\r\nexport function castBindingToUnknown(\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  binding: any\r\n): RuntimeConfigBinding<unknown, RuntimeConfigKey> {\r\n  return binding as RuntimeConfigBinding<unknown, RuntimeConfigKey>;\r\n}\r\n","import type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\n\r\n/**\r\n * Validates and sets log level on logger.\r\n *\r\n * This function validates the log level value before applying it to the logger.\r\n * If validation fails, it falls back to INFO level and logs a warning.\r\n *\r\n * Uses PlatformValidationPort to maintain Clean Architecture dependency rules.\r\n * The validation port abstracts away the specific validation library (e.g., Valibot).\r\n *\r\n * @param value - The log level value to validate and set\r\n * @param logger - The logger instance to configure\r\n * @param validator - The validation port for validating the log level value\r\n */\r\nexport function validateAndSetLogLevel(\r\n  value: number,\r\n  logger: PlatformLoggingPort,\r\n  validator: PlatformValidationPort\r\n): void {\r\n  // Validate value before using it (security!)\r\n  const validationResult = validator.validateLogLevel(value);\r\n\r\n  if (!validationResult.ok) {\r\n    logger.warn(`Invalid log level value received: ${value}, using default INFO`);\r\n    if (logger.setMinLevel) {\r\n      logger.setMinLevel(LogLevel.INFO);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Dynamically reconfigure logger when setting changes\r\n  if (logger.setMinLevel) {\r\n    logger.setMinLevel(validationResult.value);\r\n    logger.info(`Log level changed to: ${LogLevel[validationResult.value]}`);\r\n  }\r\n}\r\n","/**\r\n * Log level setting definition.\r\n *\r\n * Configures the minimum log level for the module's console output.\r\n */\r\n\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport { LogLevel } from \"@/domain/types/log-level\";\r\nimport type { PlatformI18nPort } from \"@/domain/ports/platform-i18n-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { validateAndSetLogLevel } from \"@/application/utils/validate-log-level\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Log level setting definition.\r\n *\r\n * Provides dropdown with DEBUG/INFO/WARN/ERROR options.\r\n * OnChange handler dynamically reconfigures the logger.\r\n */\r\nexport const logLevelSetting: SettingDefinition<LogLevel> = {\r\n  key: SETTING_KEYS.LOG_LEVEL,\r\n\r\n  createConfig(\r\n    i18n: PlatformI18nPort,\r\n    logger: PlatformLoggingPort,\r\n    validator: PlatformValidationPort\r\n  ) {\r\n    return {\r\n      name: unwrapOr(i18n.translate(\"MODULE.SETTINGS.logLevel.name\", \"Log Level\"), \"Log Level\"),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.logLevel.hint\",\r\n          \"Minimum log level for module output. DEBUG shows all logs, ERROR only critical errors.\"\r\n        ),\r\n        \"Minimum log level for module output. DEBUG shows all logs, ERROR only critical errors.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      choices: {\r\n        [LogLevel.DEBUG]: unwrapOr(\r\n          i18n.translate(\r\n            \"MODULE.SETTINGS.logLevel.choices.debug\",\r\n            \"DEBUG (All logs - for debugging)\"\r\n          ),\r\n          \"DEBUG (All logs - for debugging)\"\r\n        ),\r\n        [LogLevel.INFO]: unwrapOr(\r\n          i18n.translate(\"MODULE.SETTINGS.logLevel.choices.info\", \"INFO (Standard)\"),\r\n          \"INFO (Standard)\"\r\n        ),\r\n        [LogLevel.WARN]: unwrapOr(\r\n          i18n.translate(\r\n            \"MODULE.SETTINGS.logLevel.choices.warn\",\r\n            \"WARN (Warnings and errors only)\"\r\n          ),\r\n          \"WARN (Warnings and errors only)\"\r\n        ),\r\n        [LogLevel.ERROR]: unwrapOr(\r\n          i18n.translate(\"MODULE.SETTINGS.logLevel.choices.error\", \"ERROR (Critical errors only)\"),\r\n          \"ERROR (Critical errors only)\"\r\n        ),\r\n      },\r\n      default: LogLevel.INFO,\r\n      onChange: (value: number) => {\r\n        validateAndSetLogLevel(value, logger, validator);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting that toggles the CacheService globally.\r\n */\r\nexport const cacheEnabledSetting: SettingDefinition<boolean> = {\r\n  key: SETTING_KEYS.CACHE_ENABLED,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheEnabled.name\", \"Enable Cache Service\"),\r\n        \"Enable Cache Service\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheEnabled.hint\",\r\n          \"Toggle the global CacheService. When disabled, all cache interactions bypass the cache layer.\"\r\n        ),\r\n        \"Toggle the global CacheService. When disabled, all cache interactions bypass the cache layer.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: true,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`CacheService ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS, APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting for configuring the default cache TTL (in milliseconds).\r\n */\r\nexport const cacheDefaultTtlSetting: SettingDefinition<number> = {\r\n  key: SETTING_KEYS.CACHE_TTL_MS,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheDefaultTtlMs.name\", \"Cache TTL (ms)\"),\r\n        \"Cache TTL (ms)\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheDefaultTtlMs.hint\",\r\n          \"Default lifetime for cache entries in milliseconds. Use 0 to disable TTL (entries live until invalidated).\"\r\n        ),\r\n        \"Default lifetime for cache entries in milliseconds. Use 0 to disable TTL (entries live until invalidated).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: APP_DEFAULTS.CACHE_TTL_MS,\r\n      onChange: (value: number) => {\r\n        const numericValue = Number(value);\r\n        const sanitized = Number.isFinite(numericValue) && numericValue >= 0 ? numericValue : 0;\r\n        logger.info(`Cache TTL updated via settings: ${sanitized}ms`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting for configuring the optional CacheService max entries (LRU limit).\r\n */\r\nexport const cacheMaxEntriesSetting: SettingDefinition<number> = {\r\n  key: SETTING_KEYS.CACHE_MAX_ENTRIES,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.cacheMaxEntries.name\", \"Cache Max Entries\"),\r\n        \"Cache Max Entries\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.cacheMaxEntries.hint\",\r\n          \"Optional LRU limit. Use 0 to allow unlimited cache entries.\"\r\n        ),\r\n        \"Optional LRU limit. Use 0 to allow unlimited cache entries.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: 0,\r\n      onChange: (value: number) => {\r\n        const numericValue = Number(value);\r\n        const sanitized =\r\n          Number.isFinite(numericValue) && numericValue > 0 ? Math.floor(numericValue) : 0;\r\n        if (sanitized === 0) {\r\n          logger.info(\"Cache max entries reset to unlimited via settings.\");\r\n        } else {\r\n          logger.info(`Cache max entries updated via settings: ${sanitized}`);\r\n        }\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting to toggle performance tracking at runtime.\r\n */\r\nexport const performanceTrackingSetting: SettingDefinition<boolean> = {\r\n  key: SETTING_KEYS.PERFORMANCE_TRACKING_ENABLED,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.performanceTracking.name\", \"Performance Tracking\"),\r\n        \"Performance Tracking\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.performanceTracking.hint\",\r\n          \"Enables internal performance instrumentation (requires sampling).\"\r\n        ),\r\n        \"Enables internal performance instrumentation (requires sampling).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: false,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`Performance tracking ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting to adjust performance sampling rate (0.0 - 1.0).\r\n */\r\nexport const performanceSamplingSetting: SettingDefinition<number> = {\r\n  key: SETTING_KEYS.PERFORMANCE_SAMPLING_RATE,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.performanceSamplingRate.name\", \"Performance Sampling Rate\"),\r\n        \"Performance Sampling Rate\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.performanceSamplingRate.hint\",\r\n          \"Fraction of operations to instrument (0 = 0%, 1 = 100%).\"\r\n        ),\r\n        \"Fraction of operations to instrument (0 = 0%, 1 = 100%).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: 1,\r\n      onChange: (value: number) => {\r\n        const clamped = Math.max(0, Math.min(1, Number(value) || 0));\r\n        logger.info(\r\n          `Performance sampling rate updated via settings: ${(clamped * 100).toFixed(1)}%`\r\n        );\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting to toggle metrics persistence between sessions.\r\n */\r\nexport const metricsPersistenceEnabledSetting: SettingDefinition<boolean> = {\r\n  key: SETTING_KEYS.METRICS_PERSISTENCE_ENABLED,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.metricsPersistenceEnabled.name\", \"Persist Metrics\"),\r\n        \"Persist Metrics\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.metricsPersistenceEnabled.hint\",\r\n          \"Keeps observability metrics across Foundry restarts (uses LocalStorage).\"\r\n        ),\r\n        \"Keeps observability metrics across Foundry restarts (uses LocalStorage).\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Boolean,\r\n      default: false,\r\n      onChange: (value: boolean) => {\r\n        const action = value ? \"enabled\" : \"disabled\";\r\n        logger.info(`Metrics persistence ${action} via module setting.`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS, MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Foundry setting to configure the LocalStorage key for persisted metrics.\r\n */\r\nexport const metricsPersistenceKeySetting: SettingDefinition<string> = {\r\n  key: SETTING_KEYS.METRICS_PERSISTENCE_KEY,\r\n\r\n  createConfig(i18n, logger, _validator: PlatformValidationPort) {\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\"MODULE.SETTINGS.metricsPersistenceKey.name\", \"Metrics Storage Key\"),\r\n        \"Metrics Storage Key\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.metricsPersistenceKey.hint\",\r\n          \"LocalStorage key used when metrics persistence is enabled.\"\r\n        ),\r\n        \"LocalStorage key used when metrics persistence is enabled.\"\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: String,\r\n      default: `${MODULE_METADATA.ID}.metrics`,\r\n      onChange: (value: string) => {\r\n        logger.info(`Metrics persistence key set to: ${value || \"(empty)\"}`);\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { SettingDefinition } from \"./setting-definition.interface\";\r\nimport type { PlatformValidationPort } from \"@/domain/ports/platform-validation-port.interface\";\r\nimport type { PlatformI18nPort } from \"@/domain/ports/platform-i18n-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport { unwrapOr } from \"@/domain/utils/result\";\r\n\r\n/**\r\n * Notification queue size constants.\r\n * These values are configured at build-time via VITE_* environment variables.\r\n *\r\n * MIN/MAX are fixed after build (security boundaries).\r\n * DEFAULT can be overridden at runtime via Foundry settings.\r\n *\r\n * Note: These values are hardcoded here to avoid importing from framework layer.\r\n * They match the values defined in VITE_NOTIFICATION_QUEUE_* environment variables.\r\n */\r\nconst NOTIFICATION_QUEUE_CONSTANTS = {\r\n  minSize: 10,\r\n  maxSize: 1000,\r\n  defaultSize: 50,\r\n} as const;\r\n\r\n/**\r\n * Gets notification queue size constants.\r\n * These values are configured at build-time via VITE_* environment variables.\r\n *\r\n * MIN/MAX are fixed after build (security boundaries).\r\n * DEFAULT can be overridden at runtime via Foundry settings.\r\n */\r\nexport function getNotificationQueueConstants(): {\r\n  minSize: number;\r\n  maxSize: number;\r\n  defaultSize: number;\r\n} {\r\n  return NOTIFICATION_QUEUE_CONSTANTS;\r\n}\r\n\r\n/**\r\n * Foundry setting for configuring the notification queue max size.\r\n *\r\n * This setting controls the maximum number of notifications that can be queued\r\n * before the UI becomes available. When the queue reaches this limit, oldest\r\n * notifications are removed to make room for new ones.\r\n *\r\n * **Build-Time Configuration:**\r\n * - MIN/MAX values are configured via VITE_NOTIFICATION_QUEUE_MIN_SIZE and\r\n *   VITE_NOTIFICATION_QUEUE_MAX_SIZE environment variables\r\n * - These values are compiled into the build and cannot be changed at runtime\r\n *\r\n * **Runtime Configuration:**\r\n * - DEFAULT value can be overridden via this setting\r\n * - Values are clamped to MIN/MAX boundaries\r\n */\r\nexport const notificationQueueMaxSizeSetting: SettingDefinition<number> = {\r\n  key: SETTING_KEYS.NOTIFICATION_QUEUE_MAX_SIZE,\r\n\r\n  createConfig(\r\n    i18n: PlatformI18nPort,\r\n    logger: PlatformLoggingPort,\r\n    _validator: PlatformValidationPort\r\n  ) {\r\n    const constants = getNotificationQueueConstants();\r\n\r\n    return {\r\n      name: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.notificationQueueMaxSize.name\",\r\n          \"Notification Queue Max Size\"\r\n        ),\r\n        \"Notification Queue Max Size\"\r\n      ),\r\n      hint: unwrapOr(\r\n        i18n.translate(\r\n          \"MODULE.SETTINGS.notificationQueueMaxSize.hint\",\r\n          `Maximum number of notifications queued before UI is available. Range: ${constants.minSize}-${constants.maxSize}.`\r\n        ),\r\n        `Maximum number of notifications queued before UI is available. Range: ${constants.minSize}-${constants.maxSize}.`\r\n      ),\r\n      scope: \"world\",\r\n      config: true,\r\n      type: Number,\r\n      default: constants.defaultSize,\r\n      onChange: (value: number) => {\r\n        const numericValue = Number(value);\r\n        const clamped = Math.max(\r\n          constants.minSize,\r\n          Math.min(constants.maxSize, Math.floor(numericValue))\r\n        );\r\n        if (clamped !== numericValue) {\r\n          logger.info(\r\n            `Notification queue max size clamped from ${numericValue} to ${clamped} (range: ${constants.minSize}-${constants.maxSize})`\r\n          );\r\n        } else {\r\n          logger.info(`Notification queue max size updated via settings: ${clamped}`);\r\n        }\r\n      },\r\n    };\r\n  },\r\n};\r\n","/**\r\n * Default implementation of SettingDefinitionRegistry.\r\n *\r\n * Provides all module setting definitions for registration.\r\n * This is the migration path from the hardcoded list in ModuleSettingsRegistrar.\r\n */\r\n\r\nimport type { SettingDefinitionRegistry } from \"./setting-definition-registry.interface\";\r\nimport type { SettingDefinition } from \"@/application/settings/setting-definition.interface\";\r\nimport { castSettingDefinitionToUnknown } from \"@/application/utils/registry-casts\";\r\nimport { logLevelSetting } from \"@/application/settings/log-level-setting\";\r\nimport { cacheEnabledSetting } from \"@/application/settings/cache-enabled-setting\";\r\nimport { cacheDefaultTtlSetting } from \"@/application/settings/cache-default-ttl-setting\";\r\nimport { cacheMaxEntriesSetting } from \"@/application/settings/cache-max-entries-setting\";\r\nimport { performanceTrackingSetting } from \"@/application/settings/performance-tracking-setting\";\r\nimport { performanceSamplingSetting } from \"@/application/settings/performance-sampling-setting\";\r\nimport { metricsPersistenceEnabledSetting } from \"@/application/settings/metrics-persistence-enabled-setting\";\r\nimport { metricsPersistenceKeySetting } from \"@/application/settings/metrics-persistence-key-setting\";\r\nimport { notificationQueueMaxSizeSetting } from \"@/application/settings/notification-queue-max-size-setting\";\r\n\r\n/**\r\n * Default registry containing all module setting definitions.\r\n *\r\n * Implements Open/Closed Principle: New settings can be added to this array\r\n * without modifying ModuleSettingsRegistrar.\r\n */\r\nexport class DefaultSettingDefinitionRegistry implements SettingDefinitionRegistry {\r\n  getAll(): readonly SettingDefinition<unknown>[] {\r\n    return [\r\n      castSettingDefinitionToUnknown(logLevelSetting),\r\n      castSettingDefinitionToUnknown(cacheEnabledSetting),\r\n      castSettingDefinitionToUnknown(cacheDefaultTtlSetting),\r\n      castSettingDefinitionToUnknown(cacheMaxEntriesSetting),\r\n      castSettingDefinitionToUnknown(performanceTrackingSetting),\r\n      castSettingDefinitionToUnknown(performanceSamplingSetting),\r\n      castSettingDefinitionToUnknown(metricsPersistenceEnabledSetting),\r\n      castSettingDefinitionToUnknown(metricsPersistenceKeySetting),\r\n      castSettingDefinitionToUnknown(notificationQueueMaxSizeSetting),\r\n    ];\r\n  }\r\n}\r\n","import type { SettingValidator } from \"@/domain/types/setting-validator\";\r\n\r\n/**\r\n * Registry interface for managing setting validators.\r\n *\r\n * Provides methods to register and retrieve custom validators\r\n * while maintaining backward compatibility with direct property access.\r\n */\r\nexport interface SettingValidatorRegistry {\r\n  /**\r\n   * Registers a new validator with the given name.\r\n   *\r\n   * @param name - Validator name (must be a valid identifier)\r\n   * @param validator - Validator function\r\n   * @throws {Error} If name is invalid or conflicts with built-in validators\r\n   */\r\n  register<T>(name: string, validator: SettingValidator<T>): void;\r\n\r\n  /**\r\n   * Gets a validator by name.\r\n   *\r\n   * @param name - Validator name\r\n   * @returns Validator function or undefined if not found\r\n   */\r\n  get<T>(name: string): SettingValidator<T> | undefined;\r\n\r\n  /**\r\n   * Checks if a validator with the given name exists.\r\n   *\r\n   * @param name - Validator name\r\n   * @returns True if validator exists, false otherwise\r\n   */\r\n  has(name: string): boolean;\r\n}\r\n\r\n/**\r\n * Standard validators that are always available.\r\n */\r\ninterface StandardValidators {\r\n  /**\r\n   * Validates that value is a boolean.\r\n   */\r\n  boolean: SettingValidator<boolean>;\r\n\r\n  /**\r\n   * Validates that value is a number.\r\n   */\r\n  number: SettingValidator<number>;\r\n\r\n  /**\r\n   * Validates that value is a non-negative number.\r\n   */\r\n  nonNegativeNumber: SettingValidator<number>;\r\n\r\n  /**\r\n   * Validates that value is a non-negative integer.\r\n   */\r\n  nonNegativeInteger: SettingValidator<number>;\r\n\r\n  /**\r\n   * Validates that value is a positive integer (greater than 0).\r\n   */\r\n  positiveInteger: SettingValidator<number>;\r\n\r\n  /**\r\n   * Validates that value is a string.\r\n   */\r\n  string: SettingValidator<string>;\r\n\r\n  /**\r\n   * Validates that value is a non-empty string.\r\n   */\r\n  nonEmptyString: SettingValidator<string>;\r\n\r\n  /**\r\n   * Validates that value is a number between 0 and 1 (inclusive).\r\n   */\r\n  samplingRate: SettingValidator<number>;\r\n\r\n  /**\r\n   * Creates a validator for enum values.\r\n   */\r\n  oneOf: <T extends string | number>(validValues: readonly T[]) => SettingValidator<T>;\r\n}\r\n\r\n/**\r\n * Extended type that combines standard validators with registry functionality.\r\n */\r\ntype SettingValidatorsType = StandardValidators & SettingValidatorRegistry;\r\n\r\n/**\r\n * Creates an extensible validators registry with standard validators.\r\n *\r\n * Maintains backward compatibility: All standard validators are accessible\r\n * as direct properties (e.g., `SettingValidators.boolean()`).\r\n * Additional validators can be registered via the `register()` method.\r\n *\r\n * Useful for creating isolated registry instances in tests.\r\n */\r\nexport function createSettingValidators(): SettingValidatorsType {\r\n  const customValidators = new Map<string, SettingValidator<unknown>>();\r\n\r\n  // Define standard validators\r\n  const standardValidators: StandardValidators = {\r\n    /**\r\n     * Validates that value is a boolean.\r\n     */\r\n    boolean: (value: unknown): value is boolean => typeof value === \"boolean\",\r\n\r\n    /**\r\n     * Validates that value is a number.\r\n     */\r\n    number: (value: unknown): value is number => typeof value === \"number\" && !Number.isNaN(value),\r\n\r\n    /**\r\n     * Validates that value is a non-negative number.\r\n     */\r\n    nonNegativeNumber: (value: unknown): value is number =>\r\n      typeof value === \"number\" && !Number.isNaN(value) && value >= 0,\r\n\r\n    /**\r\n     * Validates that value is a non-negative integer.\r\n     */\r\n    nonNegativeInteger: (value: unknown): value is number =>\r\n      typeof value === \"number\" && Number.isInteger(value) && value >= 0,\r\n\r\n    /**\r\n     * Validates that value is a positive integer (greater than 0).\r\n     */\r\n    positiveInteger: (value: unknown): value is number =>\r\n      typeof value === \"number\" && Number.isInteger(value) && value > 0,\r\n\r\n    /**\r\n     * Validates that value is a string.\r\n     */\r\n    string: (value: unknown): value is string => typeof value === \"string\",\r\n\r\n    /**\r\n     * Validates that value is a non-empty string.\r\n     */\r\n    nonEmptyString: (value: unknown): value is string =>\r\n      typeof value === \"string\" && value.length > 0,\r\n\r\n    /**\r\n     * Validates that value is a number between 0 and 1 (inclusive).\r\n     */\r\n    samplingRate: (value: unknown): value is number =>\r\n      typeof value === \"number\" && !Number.isNaN(value) && value >= 0 && value <= 1,\r\n\r\n    /**\r\n     * Creates a validator for enum values.\r\n     */\r\n    oneOf: <T extends string | number>(validValues: readonly T[]): SettingValidator<T> => {\r\n      return (value: unknown): value is T =>\r\n        (typeof value === \"string\" || typeof value === \"number\") &&\r\n        (validValues as readonly (string | number)[]).includes(value);\r\n    },\r\n  };\r\n\r\n  // Create registry methods\r\n  const registry: SettingValidatorRegistry = {\r\n    register<T>(name: string, validator: SettingValidator<T>): void {\r\n      // Prevent overriding standard validators\r\n      if (name in standardValidators) {\r\n        throw new Error(\r\n          `Cannot override built-in validator: ${name}. Use a different name for your custom validator.`\r\n        );\r\n      }\r\n\r\n      // Validate identifier format (basic check)\r\n      if (!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(name)) {\r\n        throw new Error(`Invalid validator name: ${name}. Must be a valid JavaScript identifier.`);\r\n      }\r\n\r\n      customValidators.set(name, validator as SettingValidator<unknown>);\r\n    },\r\n\r\n    get<T>(name: string): SettingValidator<T> | undefined {\r\n      // Check standard validators first\r\n      /* type-coverage:ignore-next-line -- Proxy pattern: Dynamic property access on standard validators object requires cast */\r\n      const standard = standardValidators[name as keyof StandardValidators];\r\n      if (standard) {\r\n        /* type-coverage:ignore-next-line -- Generic type narrowing: Validator runtime type matches T, but TypeScript cannot infer from runtime check */\r\n        return standard as SettingValidator<T>;\r\n      }\r\n\r\n      // Check custom validators\r\n      /* type-coverage:ignore-next-line -- Generic type narrowing: Map.get returns unknown, but validator is registered with type T */\r\n      return customValidators.get(name) as SettingValidator<T> | undefined;\r\n    },\r\n\r\n    has(name: string): boolean {\r\n      return name in standardValidators || customValidators.has(name);\r\n    },\r\n  };\r\n\r\n  // Combine standard validators with registry methods using Proxy for dynamic property access\r\n  return new Proxy({ ...standardValidators, ...registry } as SettingValidatorsType, {\r\n    get(target, prop: string | symbol) {\r\n      // Handle symbol properties (e.g., Symbol.iterator)\r\n      if (typeof prop === \"symbol\") {\r\n        /* type-coverage:ignore-next-line -- Proxy pattern: Symbol properties require cast to access target object properties */\r\n        return (target as unknown as Record<string | symbol, unknown>)[prop];\r\n      }\r\n\r\n      // Try standard validators first\r\n      if (prop in standardValidators) {\r\n        /* type-coverage:ignore-next-line -- Proxy pattern: Dynamic property access on standard validators object requires cast */\r\n        return standardValidators[prop as keyof StandardValidators];\r\n      }\r\n\r\n      // Try registry methods\r\n      if (prop in registry) {\r\n        /* type-coverage:ignore-next-line -- Proxy pattern: Dynamic property access on registry object requires cast */\r\n        return registry[prop as keyof SettingValidatorRegistry];\r\n      }\r\n\r\n      // Try custom validators\r\n      const custom = customValidators.get(prop);\r\n      if (custom) {\r\n        return custom;\r\n      }\r\n\r\n      // Fallback to target property (for other properties like prototype)\r\n      /* type-coverage:ignore-next-line -- Proxy pattern: Fallback property access requires cast for prototype/other properties */\r\n      return target[prop as keyof SettingValidatorsType];\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Pre-defined validators for common setting types.\r\n *\r\n * Extensible via the `register()` method while maintaining backward compatibility\r\n * with direct property access (e.g., `SettingValidators.boolean()`).\r\n *\r\n * @example\r\n * ```typescript\r\n * // Use standard validators (backward compatible)\r\n * const isValid = SettingValidators.boolean(true);\r\n *\r\n * // Register custom validator\r\n * SettingValidators.register(\"custom\", (v): v is CustomType => {\r\n *   // validation logic\r\n * });\r\n *\r\n * // Use custom validator\r\n * const customValidator = SettingValidators.get(\"custom\");\r\n * ```\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention -- PascalCase intentional for namespace-like object\r\nexport const SettingValidators = createSettingValidators();\r\n","/**\r\n * Runtime config bindings using domain-neutral validators.\r\n *\r\n * DIP-Compliant: Uses SettingValidators from domain layer instead of\r\n * Valibot schemas from infrastructure layer.\r\n *\r\n * Separated from RuntimeConfigSync to follow Single Responsibility Principle.\r\n * This file contains only the binding configuration, not the synchronization logic.\r\n */\r\n\r\nimport { SETTING_KEYS } from \"@/application/constants/app-constants\";\r\nimport type { RuntimeConfigBinding } from \"@/application/services/RuntimeConfigSync\";\r\nimport { SettingValidators } from \"@/domain/utils/setting-validators\";\r\nimport type { LogLevel } from \"@/domain/types/log-level\";\r\nimport { getNotificationQueueConstants } from \"@/application/settings/notification-queue-max-size-setting\";\r\n\r\n/**\r\n * LogLevel validator that checks if value is a valid LogLevel enum value.\r\n */\r\nconst isLogLevel = (value: unknown): value is LogLevel =>\r\n  typeof value === \"number\" && value >= 0 && value <= 3;\r\n\r\n/**\r\n * Runtime config bindings using domain-neutral validators.\r\n *\r\n * Maps setting keys to their corresponding runtime config bindings,\r\n * which define how settings are synchronized with RuntimeConfigService.\r\n */\r\nexport const runtimeConfigBindings = {\r\n  [SETTING_KEYS.LOG_LEVEL]: {\r\n    runtimeKey: \"logLevel\",\r\n    validator: isLogLevel,\r\n    normalize: (value: LogLevel) => value,\r\n  } satisfies RuntimeConfigBinding<LogLevel, \"logLevel\">,\r\n  [SETTING_KEYS.CACHE_ENABLED]: {\r\n    runtimeKey: \"enableCacheService\",\r\n    validator: SettingValidators.boolean,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enableCacheService\">,\r\n  [SETTING_KEYS.CACHE_TTL_MS]: {\r\n    runtimeKey: \"cacheDefaultTtlMs\",\r\n    validator: SettingValidators.nonNegativeNumber,\r\n    normalize: (value: number) => value,\r\n  } satisfies RuntimeConfigBinding<number, \"cacheDefaultTtlMs\">,\r\n  [SETTING_KEYS.CACHE_MAX_ENTRIES]: {\r\n    runtimeKey: \"cacheMaxEntries\",\r\n    validator: SettingValidators.nonNegativeInteger,\r\n    normalize: (value: number) => (value > 0 ? value : undefined),\r\n  } satisfies RuntimeConfigBinding<number, \"cacheMaxEntries\">,\r\n  [SETTING_KEYS.PERFORMANCE_TRACKING_ENABLED]: {\r\n    runtimeKey: \"enablePerformanceTracking\",\r\n    validator: SettingValidators.boolean,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enablePerformanceTracking\">,\r\n  [SETTING_KEYS.PERFORMANCE_SAMPLING_RATE]: {\r\n    runtimeKey: \"performanceSamplingRate\",\r\n    validator: SettingValidators.samplingRate,\r\n    normalize: (value: number) => value,\r\n  } satisfies RuntimeConfigBinding<number, \"performanceSamplingRate\">,\r\n  [SETTING_KEYS.METRICS_PERSISTENCE_ENABLED]: {\r\n    runtimeKey: \"enableMetricsPersistence\",\r\n    validator: SettingValidators.boolean,\r\n    normalize: (value: boolean) => value,\r\n  } satisfies RuntimeConfigBinding<boolean, \"enableMetricsPersistence\">,\r\n  [SETTING_KEYS.METRICS_PERSISTENCE_KEY]: {\r\n    runtimeKey: \"metricsPersistenceKey\",\r\n    validator: SettingValidators.nonEmptyString,\r\n    normalize: (value: string) => value,\r\n  } satisfies RuntimeConfigBinding<string, \"metricsPersistenceKey\">,\r\n  [SETTING_KEYS.NOTIFICATION_QUEUE_MAX_SIZE]: {\r\n    runtimeKey: \"notificationQueueMaxSize\",\r\n    validator: SettingValidators.positiveInteger,\r\n    normalize: (value: number) => {\r\n      const constants = getNotificationQueueConstants();\r\n      return Math.max(constants.minSize, Math.min(constants.maxSize, Math.floor(value)));\r\n    },\r\n  } satisfies RuntimeConfigBinding<number, \"notificationQueueMaxSize\">,\r\n} as const;\r\n","/**\r\n * Default implementation of RuntimeConfigBindingRegistry.\r\n *\r\n * Provides all runtime config bindings for settings.\r\n * This is the migration path from the hardcoded bindings in RuntimeConfigSync.\r\n */\r\n\r\nimport type { RuntimeConfigBindingRegistry } from \"./runtime-config-binding-registry.interface\";\r\nimport type { RuntimeConfigKey } from \"@/domain/types/runtime-config\";\r\nimport type { RuntimeConfigBinding } from \"@/application/services/RuntimeConfigSync\";\r\nimport { castBindingToUnknown } from \"@/application/utils/registry-casts\";\r\nimport { runtimeConfigBindings } from \"@/application/config/runtime-config-bindings\";\r\n\r\n/**\r\n * Default registry containing all runtime config bindings.\r\n *\r\n * Implements Open/Closed Principle: New bindings can be added to the source object\r\n * without modifying ModuleSettingsRegistrar.\r\n */\r\nexport class DefaultRuntimeConfigBindingRegistry implements RuntimeConfigBindingRegistry {\r\n  getAll(): ReadonlyMap<string, RuntimeConfigBinding<unknown, RuntimeConfigKey>> {\r\n    const map = new Map<string, RuntimeConfigBinding<unknown, RuntimeConfigKey>>();\r\n\r\n    // Iterate over runtimeConfigBindings entries and convert each binding\r\n    // Object.entries() returns a union of all binding types, handled by castBindingToUnknown\r\n    Object.entries(runtimeConfigBindings).forEach(([key, binding]) => {\r\n      map.set(key, castBindingToUnknown(binding));\r\n    });\r\n\r\n    return map;\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { moduleSettingsRegistrarToken } from \"@/infrastructure/shared/tokens/core/module-settings-registrar.token\";\r\nimport {\r\n  runtimeConfigSyncToken,\r\n  runtimeConfigSettingsSyncToken,\r\n  settingRegistrationErrorMapperToken,\r\n  settingDefinitionRegistryToken,\r\n  runtimeConfigBindingRegistryToken,\r\n} from \"@/application/tokens/application.tokens\";\r\nimport { DIModuleSettingsRegistrar } from \"@/application/services/ModuleSettingsRegistrar\";\r\nimport { DIRuntimeConfigSync } from \"@/application/services/RuntimeConfigSync\";\r\nimport { DIRuntimeConfigSettingsSync } from \"@/application/services/runtime-config-settings-sync\";\r\nimport { DISettingRegistrationErrorMapper } from \"@/application/services/SettingRegistrationErrorMapper\";\r\nimport { DefaultSettingDefinitionRegistry } from \"@/application/services/registries/default-setting-definition-registry\";\r\nimport { DefaultRuntimeConfigBindingRegistry } from \"@/application/services/registries/default-runtime-config-binding-registry\";\r\n\r\n/**\r\n * Registers registrar services.\r\n *\r\n * Services registered:\r\n * - RuntimeConfigSync (singleton) - Handles Settings-to-RuntimeConfig synchronization\r\n * - RuntimeConfigSettingsSync (singleton) - Encapsulates RuntimeConfig synchronization for Settings\r\n * - SettingRegistrationErrorMapper (singleton) - Maps registration errors to notifications\r\n * - ModuleSettingsRegistrar (singleton) - Manages all settings registration\r\n *\r\n * NOTE: Event listeners are now registered via registerEventPorts() in event-ports.config.ts.\r\n * This separation improves modularity and follows Single Responsibility Principle.\r\n *\r\n * DESIGN: Registrars are DI services that can be resolved when needed.\r\n * They are NOT instantiated with 'new' in business logic.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerRegistrars(container: ServiceContainer): Result<void, string> {\r\n  // Register RuntimeConfigSync first (required by RuntimeConfigSettingsSync)\r\n  const runtimeConfigSyncResult = container.registerClass(\r\n    runtimeConfigSyncToken,\r\n    DIRuntimeConfigSync,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(runtimeConfigSyncResult)) {\r\n    return err(`Failed to register RuntimeConfigSync: ${runtimeConfigSyncResult.error.message}`);\r\n  }\r\n\r\n  // Register RuntimeConfigSettingsSync (required by ModuleSettingsRegistrar)\r\n  const runtimeConfigSettingsSyncResult = container.registerClass(\r\n    runtimeConfigSettingsSyncToken,\r\n    DIRuntimeConfigSettingsSync,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(runtimeConfigSettingsSyncResult)) {\r\n    return err(\r\n      `Failed to register RuntimeConfigSettingsSync: ${runtimeConfigSettingsSyncResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register SettingRegistrationErrorMapper (required by ModuleSettingsRegistrar)\r\n  const errorMapperResult = container.registerClass(\r\n    settingRegistrationErrorMapperToken,\r\n    DISettingRegistrationErrorMapper,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(errorMapperResult)) {\r\n    return err(\r\n      `Failed to register SettingRegistrationErrorMapper: ${errorMapperResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register SettingDefinitionRegistry (required by ModuleSettingsRegistrar)\r\n  const settingDefinitionRegistryResult = container.registerClass(\r\n    settingDefinitionRegistryToken,\r\n    DefaultSettingDefinitionRegistry,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingDefinitionRegistryResult)) {\r\n    return err(\r\n      `Failed to register SettingDefinitionRegistry: ${settingDefinitionRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register RuntimeConfigBindingRegistry (required by ModuleSettingsRegistrar)\r\n  const runtimeConfigBindingRegistryResult = container.registerClass(\r\n    runtimeConfigBindingRegistryToken,\r\n    DefaultRuntimeConfigBindingRegistry,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(runtimeConfigBindingRegistryResult)) {\r\n    return err(\r\n      `Failed to register RuntimeConfigBindingRegistry: ${runtimeConfigBindingRegistryResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ModuleSettingsRegistrar\r\n  const settingsRegistrarResult = container.registerClass(\r\n    moduleSettingsRegistrarToken,\r\n    DIModuleSettingsRegistrar,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsRegistrarResult)) {\r\n    return err(\r\n      `Failed to register ModuleSettingsRegistrar: ${settingsRegistrarResult.error.message}`\r\n    );\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"Registrars\",\r\n  priority: 150,\r\n  execute: registerRegistrars,\r\n});\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformJournalEventPort,\r\n  JournalCreatedEvent,\r\n  JournalUpdatedEvent,\r\n  JournalDeletedEvent,\r\n  JournalChanges,\r\n} from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type {\r\n  EventRegistrationId,\r\n  PlatformEventError,\r\n} from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { FoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport { castToRecord, normalizeToRecord } from \"@/infrastructure/di/types/utilities/type-casts\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformJournalEventPort.\r\n *\r\n * Maps Foundry's Hook system to platform-agnostic journal events.\r\n * Uses FoundryHooksPort which implements PlatformEventPort for platform-agnostic event handling.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundryJournalEventAdapter(foundryHooksPort);\r\n *\r\n * adapter.onJournalCreated((event) => {\r\n *   console.log(`Journal created: ${event.journalId}`);\r\n * });\r\n * ```\r\n */\r\nexport class FoundryJournalEventAdapter implements PlatformJournalEventPort {\r\n  private registrations = new Map<EventRegistrationId, () => void>();\r\n  private nextId = 1;\r\n\r\n  constructor(private readonly foundryHooksPort: FoundryHooksPort) {}\r\n\r\n  // ===== Specialized Journal Methods =====\r\n\r\n  onJournalCreated(\r\n    callback: (event: JournalCreatedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\r\n      \"createJournalEntry\", // Foundry-spezifischer Hook-Name\r\n      (...args: unknown[]) => {\r\n        const [foundryEntry] = args;\r\n        // Mapping: Foundry-Event → Domain-Event\r\n        const event: JournalCreatedEvent = {\r\n          journalId: this.extractId(foundryEntry),\r\n          timestamp: Date.now(),\r\n        };\r\n        callback(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  onJournalUpdated(\r\n    callback: (event: JournalUpdatedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\r\n      \"updateJournalEntry\", // Foundry-spezifisch\r\n      (...args: unknown[]) => {\r\n        const [foundryEntry, changes] = args;\r\n        const event: JournalUpdatedEvent = {\r\n          journalId: this.extractId(foundryEntry),\r\n          changes: this.normalizeChanges(changes),\r\n          timestamp: Date.now(),\r\n        };\r\n        callback(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  onJournalDeleted(\r\n    callback: (event: JournalDeletedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\"deleteJournalEntry\", (...args: unknown[]) => {\r\n      const [foundryEntry] = args;\r\n      const event: JournalDeletedEvent = {\r\n        journalId: this.extractId(foundryEntry),\r\n        timestamp: Date.now(),\r\n      };\r\n      callback(event);\r\n    });\r\n  }\r\n\r\n  unregisterListener(registrationId: EventRegistrationId): Result<void, PlatformEventError> {\r\n    const cleanup = this.registrations.get(registrationId);\r\n    if (!cleanup) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"EVENT_UNREGISTRATION_FAILED\",\r\n          message: `No registration found for ID ${registrationId}`,\r\n        },\r\n      };\r\n    }\r\n\r\n    cleanup();\r\n    this.registrations.delete(registrationId);\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  // ===== Lifecycle =====\r\n\r\n  /**\r\n   * Cleanup all registered listeners.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    for (const cleanup of this.registrations.values()) {\r\n      cleanup();\r\n    }\r\n    this.registrations.clear();\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  private registerFoundryHook(\r\n    hookName: string,\r\n    callback: (...args: unknown[]) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Use PlatformEventPort.registerListener() instead of FoundryHooks.on()\r\n    // Wrap callback to match PlatformEventPort signature (single event parameter)\r\n    // The event parameter contains the original Foundry hook arguments as an array\r\n    const platformCallback = (event: unknown): void => {\r\n      // Foundry hooks pass multiple arguments, but PlatformEventPort expects single event\r\n      // We pass the event as an array to preserve the original Foundry hook signature\r\n      // Type guard: check if event is an array\r\n      // Use explicit type guard function to avoid type assertion\r\n      function isArrayOfUnknown(value: unknown): value is unknown[] {\r\n        return Array.isArray(value);\r\n      }\r\n      if (isArrayOfUnknown(event)) {\r\n        // Type guard: ensure all array elements are valid before spreading\r\n        // Use type predicate to narrow the type\r\n        function isValidArg(arg: unknown): arg is unknown {\r\n          return arg !== null && arg !== undefined;\r\n        }\r\n        const validArgs: unknown[] = event.filter(isValidArg);\r\n        if (validArgs.length > 0) {\r\n          callback(...validArgs);\r\n        }\r\n      } else {\r\n        // Fallback: if event is not an array, pass it as single argument\r\n        // This path is for compatibility with non-array events, which should be rare\r\n        // Type guard: ensure event is not null/undefined before passing\r\n        // Use type narrowing function to avoid type assertion\r\n        function isNotNullOrUndefined(value: unknown): value is NonNullable<unknown> {\r\n          return value !== null && value !== undefined;\r\n        }\r\n        if (isNotNullOrUndefined(event)) {\r\n          callback(event);\r\n        }\r\n      }\r\n    };\r\n    const result = this.foundryHooksPort.registerListener(hookName, platformCallback);\r\n\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n\r\n    const registrationId = result.value;\r\n\r\n    // Store cleanup function using PlatformEventPort.unregisterListener()\r\n    this.registrations.set(registrationId, () => {\r\n      this.foundryHooksPort.unregisterListener(registrationId);\r\n    });\r\n\r\n    return { ok: true, value: registrationId };\r\n  }\r\n\r\n  private extractId(foundryEntry: unknown): string {\r\n    // Foundry entries always have an id property\r\n    if (typeof foundryEntry === \"object\" && foundryEntry !== null && \"id\" in foundryEntry) {\r\n      const entry = castToRecord(foundryEntry);\r\n      if (typeof entry.id === \"string\") {\r\n        return entry.id;\r\n      }\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  private normalizeChanges(foundryChanges: unknown): JournalChanges {\r\n    if (!foundryChanges || typeof foundryChanges !== \"object\") {\r\n      return {};\r\n    }\r\n    // Use runtime-safe cast instead of type assertion\r\n    const changes = normalizeToRecord(foundryChanges);\r\n    const result: JournalChanges = { ...changes };\r\n    if (\r\n      changes.flags !== undefined &&\r\n      typeof changes.flags === \"object\" &&\r\n      changes.flags !== null\r\n    ) {\r\n      // Copy validated object into result.flags using runtime-safe cast\r\n      result.flags = normalizeToRecord(changes.flags);\r\n    }\r\n    if (changes.name !== undefined && typeof changes.name === \"string\") {\r\n      result.name = changes.name;\r\n    }\r\n    return result;\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryJournalEventAdapter.\r\n */\r\nexport class DIFoundryJournalEventAdapter extends FoundryJournalEventAdapter {\r\n  static dependencies = [foundryHooksToken] as const;\r\n\r\n  constructor(foundryHooksPort: FoundryHooksPort) {\r\n    super(foundryHooksPort);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformJournalUiEventPort,\r\n  JournalDirectoryRenderedEvent,\r\n  JournalUiEvent,\r\n} from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type {\r\n  EventRegistrationId,\r\n  PlatformEventError,\r\n} from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { FoundryHooksPort } from \"@/infrastructure/adapters/foundry/services/FoundryHooksPort\";\r\nimport { foundryHooksToken } from \"@/infrastructure/shared/tokens/foundry/foundry-hooks.token\";\r\nimport {\r\n  getFirstElementIfArray,\r\n  castToRecord,\r\n} from \"@/infrastructure/di/types/utilities/type-casts\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformJournalUiEventPort.\r\n *\r\n * Maps Foundry's Hook system to platform-agnostic journal UI events.\r\n * Uses FoundryHooksPort which implements PlatformEventPort for platform-agnostic event handling.\r\n *\r\n * NOTE: This adapter handles UI-specific events (directory render, context menu).\r\n * Core journal lifecycle events are handled by FoundryJournalEventAdapter.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundryJournalUiEventAdapter(foundryHooksPort);\r\n *\r\n * adapter.onJournalDirectoryRendered((event) => {\r\n *   console.log(`Journal directory rendered: ${event.directoryId}`);\r\n * });\r\n * ```\r\n */\r\nexport class FoundryJournalUiEventAdapter implements PlatformJournalUiEventPort {\r\n  private registrations = new Map<EventRegistrationId, () => void>();\r\n  private nextId = 1;\r\n\r\n  constructor(private readonly foundryHooksPort: FoundryHooksPort) {}\r\n\r\n  // ===== UI Event Methods =====\r\n\r\n  onJournalDirectoryRendered(\r\n    callback: (event: JournalDirectoryRenderedEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    return this.registerFoundryHook(\"renderJournalDirectory\", (app: unknown, html: unknown) => {\r\n      // Extract directory ID from Foundry app (typically \"journal\")\r\n      const directoryId = this.extractDirectoryId(app);\r\n      if (!directoryId) {\r\n        // Skip if we can't determine directory ID\r\n        return;\r\n      }\r\n\r\n      // Verify that HTML element exists (for validation, but don't pass it to domain)\r\n      const htmlElement = this.extractHtmlElement(html);\r\n      if (!htmlElement) {\r\n        // Skip if HTML element is not available\r\n        return;\r\n      }\r\n\r\n      // Create platform-agnostic event (no DOM types)\r\n      const event: JournalDirectoryRenderedEvent = {\r\n        directoryId,\r\n        timestamp: Date.now(),\r\n      };\r\n      callback(event);\r\n    });\r\n  }\r\n\r\n  // ===== Generic Methods (from PlatformEventPort) =====\r\n\r\n  registerListener(\r\n    eventType: string,\r\n    callback: (event: JournalUiEvent) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    // Fallback für generische registerListener\r\n    // In der Praxis sollten die spezialisierten Methoden genutzt werden\r\n    return this.registerFoundryHook(eventType, (...args: unknown[]) => {\r\n      // For generic registerListener, we need to map Foundry events to JournalUiEvent\r\n      // This is a simplified implementation - specific methods should be used instead\r\n      if (args.length > 0 && typeof args[0] === \"object\" && args[0] !== null) {\r\n        const candidate = args[0];\r\n        const event = this.toJournalUiEvent(candidate);\r\n        if (event) {\r\n          callback(event);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Type guard function to convert unknown to JournalUiEvent without type assertion.\r\n   *\r\n   * NOTE: This method is only called from registerListener, which already ensures\r\n   * that candidate is an object and not null. The redundant check was removed\r\n   * to achieve 100% code coverage.\r\n   */\r\n  private toJournalUiEvent(candidate: unknown): JournalUiEvent | null {\r\n    const record = castToRecord(candidate);\r\n\r\n    // Check for JournalDirectoryRenderedEvent (has directoryId)\r\n    if (\"directoryId\" in record && typeof record.directoryId === \"string\") {\r\n      return {\r\n        directoryId: record.directoryId,\r\n        timestamp: typeof record.timestamp === \"number\" ? record.timestamp : Date.now(),\r\n      };\r\n    }\r\n\r\n    // Check for JournalContextMenuEvent (has journalId and options)\r\n    if (\r\n      \"journalId\" in record &&\r\n      typeof record.journalId === \"string\" &&\r\n      \"options\" in record &&\r\n      Array.isArray(record.options)\r\n    ) {\r\n      return {\r\n        journalId: record.journalId,\r\n        // type-coverage:ignore-next-line - Fallback path for generic registerListener, not used in practice\r\n        options: record.options,\r\n        timestamp: typeof record.timestamp === \"number\" ? record.timestamp : Date.now(),\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  unregisterListener(registrationId: EventRegistrationId): Result<void, PlatformEventError> {\r\n    const cleanup = this.registrations.get(registrationId);\r\n    if (!cleanup) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"EVENT_UNREGISTRATION_FAILED\",\r\n          message: `No registration found for ID ${registrationId}`,\r\n        },\r\n      };\r\n    }\r\n\r\n    cleanup();\r\n    this.registrations.delete(registrationId);\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  // ===== Lifecycle =====\r\n\r\n  /**\r\n   * Cleanup all registered listeners.\r\n   * Should be called during module shutdown.\r\n   */\r\n  dispose(): void {\r\n    for (const cleanup of this.registrations.values()) {\r\n      cleanup();\r\n    }\r\n    this.registrations.clear();\r\n  }\r\n\r\n  // ===== Private Helpers =====\r\n\r\n  private registerFoundryHook(\r\n    hookName: string,\r\n    callback: (...args: unknown[]) => void\r\n  ): Result<EventRegistrationId, PlatformEventError> {\r\n    const platformCallback = (event: unknown): void => {\r\n      function isArrayOfUnknown(value: unknown): value is unknown[] {\r\n        return Array.isArray(value);\r\n      }\r\n      if (isArrayOfUnknown(event)) {\r\n        function isValidArg(arg: unknown): arg is unknown {\r\n          return arg !== null && arg !== undefined;\r\n        }\r\n        const validArgs: unknown[] = event.filter(isValidArg);\r\n        if (validArgs.length > 0) {\r\n          callback(...validArgs);\r\n        }\r\n      } else {\r\n        function isNotNullOrUndefined(value: unknown): value is NonNullable<unknown> {\r\n          return value !== null && value !== undefined;\r\n        }\r\n        if (isNotNullOrUndefined(event)) {\r\n          callback(event);\r\n        }\r\n      }\r\n    };\r\n    const result = this.foundryHooksPort.registerListener(hookName, platformCallback);\r\n\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n\r\n    const registrationId = result.value;\r\n\r\n    // Store cleanup function using PlatformEventPort.unregisterListener()\r\n    this.registrations.set(registrationId, () => {\r\n      this.foundryHooksPort.unregisterListener(registrationId);\r\n    });\r\n\r\n    return { ok: true, value: registrationId };\r\n  }\r\n\r\n  private extractDirectoryId(app: unknown): string | null {\r\n    // Foundry's renderJournalDirectory hook passes the app instance\r\n    // For journal directory, the ID is typically \"journal\"\r\n    // We can also check app.id or app.tabName if available\r\n    if (typeof app === \"object\" && app !== null) {\r\n      if (\"id\" in app && typeof app.id === \"string\") {\r\n        return app.id;\r\n      }\r\n      if (\"tabName\" in app && typeof app.tabName === \"string\") {\r\n        return app.tabName;\r\n      }\r\n    }\r\n    // Default to \"journal\" for journal directory\r\n    return \"journal\";\r\n  }\r\n\r\n  private extractHtmlElement(htmlInput: unknown): HTMLElement | null {\r\n    if (htmlInput instanceof HTMLElement) return htmlInput;\r\n    return getFirstElementIfArray(htmlInput, (el): el is HTMLElement => el instanceof HTMLElement);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundryJournalUiEventAdapter.\r\n */\r\nexport class DIFoundryJournalUiEventAdapter extends FoundryJournalUiEventAdapter {\r\n  static dependencies = [foundryHooksToken] as const;\r\n\r\n  constructor(foundryHooksPort: FoundryHooksPort) {\r\n    super(foundryHooksPort);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { CacheInvalidationPort } from \"@/domain/ports/cache/cache-invalidation-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  cacheInvalidationPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { getFirstArrayElement } from \"@/application/utils/array-utils\";\r\n\r\n/**\r\n * Use-Case: Invalidate journal cache when journal entries change.\r\n *\r\n * Platform-agnostic - works with any PlatformJournalEventPort implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new InvalidateJournalCacheOnChangeUseCase(\r\n *   journalEventPort,\r\n *   cache,\r\n *   notifications\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();  // Stop listening\r\n * ```\r\n */\r\nexport class InvalidateJournalCacheOnChangeUseCase implements EventRegistrar {\r\n  private registrationIds: EventRegistrationId[] = [];\r\n\r\n  constructor(\r\n    private readonly journalEvents: PlatformJournalEventPort,\r\n    private readonly cache: CacheInvalidationPort,\r\n    private readonly notifications: NotificationPublisherPort\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listeners for journal change events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    // Register for all journal change events\r\n    const results = [\r\n      this.journalEvents.onJournalCreated((event) => {\r\n        this.invalidateCache(\"created\", event.journalId);\r\n      }),\r\n      this.journalEvents.onJournalUpdated((event) => {\r\n        this.invalidateCache(\"updated\", event.journalId);\r\n\r\n        // Check if hidden flag changed\r\n        if (event.changes.flags?.[\"hidden\"] !== undefined) {\r\n          this.triggerUIUpdate(event.journalId);\r\n        }\r\n      }),\r\n      this.journalEvents.onJournalDeleted((event) => {\r\n        this.invalidateCache(\"deleted\", event.journalId);\r\n      }),\r\n    ];\r\n\r\n    // Collect registration IDs for cleanup\r\n    const errors: Error[] = [];\r\n    for (const result of results) {\r\n      if (result.ok) {\r\n        this.registrationIds.push(result.value);\r\n      } else {\r\n        const error = new Error(\r\n          `Failed to register journal event listener: ${result.error.message}`\r\n        );\r\n        errors.push(error);\r\n        this.notifications.error(\r\n          \"Failed to register journal event listener\",\r\n          {\r\n            code: result.error.code,\r\n            message: result.error.message,\r\n            details: result.error.details,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Roll back any registered listeners\r\n      this.dispose();\r\n      // Return first error - errors array is non-empty, so getFirstArrayElement is safe\r\n      return err(getFirstArrayElement(errors));\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Invalidate cache entries related to journals.\r\n   */\r\n  private invalidateCache(reason: string, journalId: string): void {\r\n    const removed = this.cache.invalidateWhere((meta) => meta.tags.includes(\"journal:hidden\"));\r\n\r\n    if (removed > 0) {\r\n      this.notifications.debug(\r\n        `Invalidated ${removed} journal cache entries (${reason})`,\r\n        { journalId },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger UI update when journal visibility changes.\r\n   */\r\n  private triggerUIUpdate(journalId: string): void {\r\n    this.notifications.debug(\r\n      \"Journal hidden flag changed, UI update needed\",\r\n      { journalId },\r\n      { channels: [\"ConsoleChannel\"] }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister all event listeners.\r\n   */\r\n  dispose(): void {\r\n    for (const id of this.registrationIds) {\r\n      this.journalEvents.unregisterListener(id);\r\n    }\r\n    this.registrationIds = [];\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for InvalidateJournalCacheOnChangeUseCase.\r\n */\r\nexport class DIInvalidateJournalCacheOnChangeUseCase extends InvalidateJournalCacheOnChangeUseCase {\r\n  static dependencies = [\r\n    platformJournalEventPortToken,\r\n    cacheInvalidationPortToken,\r\n    notificationPublisherPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalEvents: PlatformJournalEventPort,\r\n    cache: CacheInvalidationPort,\r\n    notifications: NotificationPublisherPort\r\n  ) {\r\n    super(journalEvents, cache, notifications);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalUiEventPort } from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type { PlatformJournalDirectoryUiPort } from \"@/domain/ports/platform-journal-directory-ui-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { JournalVisibilityService } from \"@/application/services/JournalVisibilityService\";\r\nimport type { JournalDirectoryProcessor } from \"@/application/services/JournalDirectoryProcessor\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  journalVisibilityServiceToken,\r\n  journalDirectoryProcessorToken,\r\n} from \"@/application/tokens/application.tokens\";\r\nimport {\r\n  platformJournalUiEventPortToken,\r\n  platformJournalDirectoryUiPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Use-Case: Process journal directory when it's rendered.\r\n *\r\n * Platform-agnostic - works with any PlatformJournalUiEventPort implementation.\r\n *\r\n * Orchestrates the flow:\r\n * 1. JournalVisibilityService retrieves hidden entries (business logic)\r\n * 2. JournalDirectoryProcessor processes directory via port (DIP-compliant, no HTMLElement)\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new ProcessJournalDirectoryOnRenderUseCase(\r\n *   journalUiEvents,\r\n *   journalDirectoryUI,\r\n *   journalVisibilityService,\r\n *   directoryProcessor,\r\n *   notifications\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();   // Stop listening\r\n * ```\r\n */\r\nexport class ProcessJournalDirectoryOnRenderUseCase implements EventRegistrar {\r\n  private registrationId: EventRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly journalUiEvents: PlatformJournalUiEventPort,\r\n    private readonly journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    private readonly journalVisibility: JournalVisibilityService,\r\n    private readonly directoryProcessor: JournalDirectoryProcessor,\r\n    private readonly notifications: NotificationPublisherPort\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listener for directory render events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    const result = this.journalUiEvents.onJournalDirectoryRendered((event) => {\r\n      this.notifications.debug(\r\n        \"Journal directory rendered, processing visibility\",\r\n        { timestamp: event.timestamp, directoryId: event.directoryId },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n\r\n      // 1. Get hidden entries (business logic)\r\n      const hiddenResult = this.journalVisibility.getHiddenJournalEntries();\r\n      if (!hiddenResult.ok) {\r\n        this.notifications.error(\"Failed to get hidden entries\", hiddenResult.error, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n        return;\r\n      }\r\n\r\n      // 2. Process directory via port (DIP-compliant: no HTMLElement in Application layer)\r\n      const processResult = this.directoryProcessor.processDirectory(\r\n        event.directoryId,\r\n        hiddenResult.value\r\n      );\r\n\r\n      if (!processResult.ok) {\r\n        this.notifications.error(\"Failed to process directory\", processResult.error, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n      }\r\n    });\r\n\r\n    if (result.ok) {\r\n      this.registrationId = result.value;\r\n      return ok(undefined);\r\n    } else {\r\n      return err(new Error(result.error.message));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister event listener.\r\n   */\r\n  dispose(): void {\r\n    if (this.registrationId !== undefined) {\r\n      this.journalUiEvents.unregisterListener(this.registrationId);\r\n      this.registrationId = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for ProcessJournalDirectoryOnRenderUseCase.\r\n */\r\nexport class DIProcessJournalDirectoryOnRenderUseCase extends ProcessJournalDirectoryOnRenderUseCase {\r\n  static dependencies = [\r\n    platformJournalUiEventPortToken,\r\n    platformJournalDirectoryUiPortToken,\r\n    journalVisibilityServiceToken,\r\n    journalDirectoryProcessorToken,\r\n    notificationPublisherPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalUiEvents: PlatformJournalUiEventPort,\r\n    journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    journalVisibility: JournalVisibilityService,\r\n    directoryProcessor: JournalDirectoryProcessor,\r\n    notifications: NotificationPublisherPort\r\n  ) {\r\n    super(\r\n      journalUiEvents,\r\n      journalDirectoryUI,\r\n      journalVisibility,\r\n      directoryProcessor,\r\n      notifications\r\n    );\r\n  }\r\n}\r\n","/**\r\n * Domain-layer constants.\r\n *\r\n * Diese Konstanten repräsentieren Domain-Konzepte, die unabhängig von\r\n * jeglicher Technologie oder Framework-Implementierung sind.\r\n */\r\n\r\n/**\r\n * Domain-level feature flags.\r\n * Diese Flags definieren Domain-Funktionalität, nicht technische Implementation.\r\n */\r\nexport const DOMAIN_FLAGS = {\r\n  /** Flag key für versteckte Journal-Einträge */\r\n  HIDDEN: \"hidden\",\r\n} as const;\r\n\r\n/**\r\n * Domain event names.\r\n * Diese Hook-Namen repräsentieren Domain-Events, die unabhängig von\r\n * der Platform-Implementierung (Foundry) sind.\r\n */\r\nexport const DOMAIN_EVENTS = {\r\n  /** Event: Journal Directory wird gerendert */\r\n  RENDER_JOURNAL_DIRECTORY: \"renderJournalDirectory\",\r\n\r\n  /** Event: System-Initialisierung */\r\n  INIT: \"init\",\r\n\r\n  /** Event: System ist bereit */\r\n  READY: \"ready\",\r\n\r\n  /** Event: Journal Entry wird erstellt */\r\n  CREATE_JOURNAL_ENTRY: \"createJournalEntry\",\r\n\r\n  /** Event: Journal Entry wird aktualisiert */\r\n  UPDATE_JOURNAL_ENTRY: \"updateJournalEntry\",\r\n\r\n  /** Event: Journal Entry wird gelöscht */\r\n  DELETE_JOURNAL_ENTRY: \"deleteJournalEntry\",\r\n} as const;\r\n\r\n// Deep freeze für Runtime-Immutability\r\nObject.freeze(DOMAIN_FLAGS);\r\nObject.freeze(DOMAIN_EVENTS);\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalEventPort } from \"@/domain/ports/events/platform-journal-event-port.interface\";\r\nimport type { EventRegistrationId } from \"@/domain/ports/events/platform-event-port.interface\";\r\nimport type { PlatformJournalDirectoryUiPort } from \"@/domain/ports/platform-journal-directory-ui-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { BatchUpdateContextService } from \"@/application/services/BatchUpdateContextService\";\r\nimport type { EventRegistrar } from \"./event-registrar.interface\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  platformJournalDirectoryUiPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { batchUpdateContextServiceToken } from \"@/application/tokens/application.tokens\";\r\nimport { DOMAIN_FLAGS } from \"@/domain/constants/domain-constants\";\r\nimport { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\n\r\n/**\r\n * Use-Case: Trigger journal directory re-render when hidden flag changes.\r\n *\r\n * Fully platform-agnostic through PlatformJournalEventPort and PlatformUIPort.\r\n *\r\n * Uses BatchUpdateContextService to skip re-renders during batch updates,\r\n * optimizing performance when multiple journals are updated at once.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new TriggerJournalDirectoryReRenderUseCase(\r\n *   journalEventPort,\r\n *   platformUI,\r\n *   notifications,\r\n *   batchContext\r\n * );\r\n *\r\n * useCase.register();  // Start listening\r\n * useCase.dispose();   // Stop listening\r\n * ```\r\n */\r\nexport class TriggerJournalDirectoryReRenderUseCase implements EventRegistrar {\r\n  private registrationId: EventRegistrationId | undefined;\r\n\r\n  constructor(\r\n    private readonly journalEvents: PlatformJournalEventPort,\r\n    private readonly journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    private readonly notifications: NotificationPublisherPort,\r\n    private readonly batchContext: BatchUpdateContextService\r\n  ) {}\r\n\r\n  /**\r\n   * Register event listener for journal update events.\r\n   */\r\n  register(): Result<void, Error> {\r\n    const result = this.journalEvents.onJournalUpdated((event) => {\r\n      // Prüfe, ob hidden flag geändert wurde\r\n      // Flags werden in Foundry unter einem Scope gespeichert: flags[moduleId][flagKey]\r\n      const moduleId = MODULE_METADATA.ID;\r\n      const flagKey = DOMAIN_FLAGS.HIDDEN;\r\n\r\n      const moduleFlags = event.changes.flags?.[moduleId];\r\n      if (moduleFlags && typeof moduleFlags === \"object\" && flagKey in moduleFlags) {\r\n        // Skip re-render if this journal is part of a batch update\r\n        // The batch operation will trigger a single re-render at the end\r\n        if (this.batchContext.isInBatch(event.journalId)) {\r\n          this.notifications.debug(\r\n            \"Skipping journal directory re-render during batch update\",\r\n            { journalId: event.journalId },\r\n            { channels: [\"ConsoleChannel\"] }\r\n          );\r\n          return;\r\n        }\r\n\r\n        this.triggerReRender(event.journalId);\r\n      }\r\n    });\r\n\r\n    if (result.ok) {\r\n      this.registrationId = result.value;\r\n      return ok(undefined);\r\n    } else {\r\n      return err(new Error(result.error.message));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger journal directory re-render.\r\n   */\r\n  private triggerReRender(journalId: string): void {\r\n    const result = this.journalDirectoryUI.rerenderJournalDirectory();\r\n\r\n    if (!result.ok) {\r\n      this.notifications.warn(\r\n        \"Failed to re-render journal directory after hidden flag change\",\r\n        result.error,\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (result.value) {\r\n      this.notifications.debug(\r\n        \"Triggered journal directory re-render after hidden flag change\",\r\n        { journalId },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister event listener.\r\n   */\r\n  dispose(): void {\r\n    if (this.registrationId !== undefined) {\r\n      this.journalEvents.unregisterListener(this.registrationId);\r\n      this.registrationId = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for TriggerJournalDirectoryReRenderUseCase.\r\n */\r\nexport class DITriggerJournalDirectoryReRenderUseCase extends TriggerJournalDirectoryReRenderUseCase {\r\n  static dependencies = [\r\n    platformJournalEventPortToken,\r\n    platformJournalDirectoryUiPortToken,\r\n    notificationPublisherPortToken,\r\n    batchUpdateContextServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalEvents: PlatformJournalEventPort,\r\n    journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    notifications: NotificationPublisherPort,\r\n    batchContext: BatchUpdateContextService\r\n  ) {\r\n    super(journalEvents, journalDirectoryUI, notifications, batchContext);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok } from \"@/domain/utils/result\";\r\nimport type { JournalContextMenuHandler } from \"@/application/handlers/journal-context-menu-handler.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type { PlatformContextMenuRegistrationPort } from \"@/domain/ports/platform-context-menu-registration-port.interface\";\r\nimport type { PlatformLoggingPort } from \"@/domain/ports/platform-logging-port.interface\";\r\nimport { journalContextMenuHandlersToken } from \"@/application/tokens/application.tokens\";\r\nimport {\r\n  platformContextMenuRegistrationPortToken,\r\n  platformLoggingPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\n\r\n/**\r\n * Use-Case: Register custom context menu entries for journal entries.\r\n *\r\n * Orchestrates multiple handlers that can add menu items.\r\n * Registers callbacks with the PlatformContextMenuRegistrationPort.\r\n *\r\n * NOTE: This is NOT an EventRegistrar. The libWrapper is registered separately\r\n * during init, and this use-case only manages callback registration.\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new RegisterContextMenuUseCase(\r\n *   contextMenuRegistration,\r\n *   [hideJournalHandler, otherHandler]\r\n * );\r\n *\r\n * useCase.register();  // Register callbacks\r\n * useCase.dispose();   // Unregister callbacks\r\n * ```\r\n */\r\nexport class RegisterContextMenuUseCase {\r\n  private callback: ((event: JournalContextMenuEvent) => void) | undefined;\r\n\r\n  constructor(\r\n    private readonly contextMenuRegistration: PlatformContextMenuRegistrationPort,\r\n    private readonly handlers: JournalContextMenuHandler[],\r\n    private readonly logger: PlatformLoggingPort\r\n  ) {}\r\n\r\n  /**\r\n   * Register callback for context menu events.\r\n   * All handlers are called for each context menu event.\r\n   * Errors in individual handlers are caught and logged, but don't stop other handlers.\r\n   */\r\n  register(): Result<void, Error> {\r\n    // Create callback that calls all handlers with error isolation\r\n    this.callback = (event: JournalContextMenuEvent) => {\r\n      // Rufe alle Handler auf mit Fehler-Isolation\r\n      for (const handler of this.handlers) {\r\n        try {\r\n          handler.handle(event);\r\n        } catch (error) {\r\n          // Log error but continue with next handler\r\n          const handlerError = error instanceof Error ? error : new Error(String(error));\r\n          this.logger.warn(`Context menu handler failed: ${handlerError.message}`, {\r\n            error: handlerError,\r\n            handler: handler.constructor.name,\r\n          });\r\n          // Continue with next handler - don't let one handler failure stop the chain\r\n        }\r\n      }\r\n    };\r\n\r\n    this.contextMenuRegistration.addCallback(this.callback);\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Cleanup: Unregister callback.\r\n   */\r\n  dispose(): void {\r\n    if (this.callback !== undefined) {\r\n      this.contextMenuRegistration.removeCallback(this.callback);\r\n      this.callback = undefined;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for RegisterContextMenuUseCase.\r\n * Resolves dependencies from container.\r\n */\r\nexport class DIRegisterContextMenuUseCase extends RegisterContextMenuUseCase {\r\n  static dependencies = [\r\n    platformContextMenuRegistrationPortToken,\r\n    journalContextMenuHandlersToken,\r\n    platformLoggingPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    contextMenuRegistration: PlatformContextMenuRegistrationPort,\r\n    handlers: JournalContextMenuHandler[],\r\n    logger: PlatformLoggingPort\r\n  ) {\r\n    super(contextMenuRegistration, handlers, logger);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport type { PlatformJournalCollectionPort } from \"@/domain/ports/collections/platform-journal-collection-port.interface\";\r\nimport type { PlatformJournalRepository } from \"@/domain/ports/repositories/platform-journal-repository.interface\";\r\nimport type { PlatformJournalDirectoryUiPort } from \"@/domain/ports/platform-journal-directory-ui-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { JournalVisibilityConfig } from \"@/application/services/JournalVisibilityConfig\";\r\nimport type { BatchUpdateContextService } from \"@/application/services/BatchUpdateContextService\";\r\nimport {\r\n  platformJournalCollectionPortToken,\r\n  platformJournalRepositoryToken,\r\n  platformJournalDirectoryUiPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport {\r\n  journalVisibilityConfigToken,\r\n  batchUpdateContextServiceToken,\r\n} from \"@/application/tokens/application.tokens\";\r\n\r\n/**\r\n * Use-Case: Show all hidden journals by setting their hidden flag to false.\r\n *\r\n * Platform-agnostic - works with any PlatformJournalCollectionPort and PlatformJournalRepository implementation.\r\n *\r\n * Iterates through all journal entries, checks if they have the hidden flag set,\r\n * and sets it to false if it's not already false. Uses BatchUpdateContextService to track\r\n * batch updates and optimize re-renders (single re-render after all updates instead of one per journal).\r\n *\r\n * @example\r\n * ```typescript\r\n * const useCase = new ShowAllHiddenJournalsUseCase(\r\n *   journalCollection,\r\n *   journalRepository,\r\n *   journalDirectoryUI,\r\n *   notifications,\r\n *   config,\r\n *   batchContext\r\n * );\r\n *\r\n * const result = await useCase.execute();\r\n * if (result.ok) {\r\n *   console.log(`Unhidden ${result.value} journals`);\r\n * }\r\n * ```\r\n */\r\nexport class ShowAllHiddenJournalsUseCase {\r\n  constructor(\r\n    private readonly journalCollection: PlatformJournalCollectionPort,\r\n    private readonly journalRepository: PlatformJournalRepository,\r\n    private readonly journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    private readonly notifications: NotificationPublisherPort,\r\n    private readonly config: JournalVisibilityConfig,\r\n    private readonly batchContext: BatchUpdateContextService\r\n  ) {}\r\n\r\n  /**\r\n   * Execute the use-case: Show all hidden journals.\r\n   *\r\n   * @returns Result with number of journals that were unhidden, or error\r\n   */\r\n  async execute(): Promise<Result<number, Error>> {\r\n    // Get all journals\r\n    const allJournalsResult = this.journalCollection.getAll();\r\n    if (!allJournalsResult.ok) {\r\n      return err(new Error(`Failed to get all journals: ${allJournalsResult.error.message}`));\r\n    }\r\n\r\n    const allJournals = allJournalsResult.value;\r\n\r\n    // First pass: Collect all journal IDs that need to be updated\r\n    const journalsToUpdate: Array<{ journal: (typeof allJournals)[0]; journalId: string }> = [];\r\n\r\n    for (const journal of allJournals) {\r\n      try {\r\n        // Check current flag value\r\n        const flagResult = this.journalRepository.getFlag(\r\n          journal.id,\r\n          this.config.moduleNamespace,\r\n          this.config.hiddenFlagKey\r\n        );\r\n\r\n        if (!flagResult.ok) {\r\n          // Log error but continue with other journals\r\n          this.notifications.warn(\r\n            `Failed to read hidden flag for journal \"${journal.name ?? journal.id}\"`,\r\n            {\r\n              errorCode: flagResult.error.code,\r\n              errorMessage: flagResult.error.message,\r\n              journalId: journal.id,\r\n            },\r\n            { channels: [\"ConsoleChannel\"] }\r\n          );\r\n          continue;\r\n        }\r\n\r\n        const currentFlag = flagResult.value;\r\n\r\n        // Only collect journals that need to be updated\r\n        if (currentFlag !== false) {\r\n          journalsToUpdate.push({ journal, journalId: journal.id });\r\n        }\r\n      } catch (error) {\r\n        // Catch any unexpected errors\r\n        const errorMessage = error instanceof Error ? error.message : String(error);\r\n        this.notifications.warn(\r\n          `Unexpected error checking journal \"${journal.name ?? journal.id}\"`,\r\n          {\r\n            error: errorMessage,\r\n            journalId: journal.id,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Add all journal IDs to batch context before starting updates\r\n    const journalIdsToUpdate = journalsToUpdate.map(({ journalId }) => journalId);\r\n    if (journalIdsToUpdate.length > 0) {\r\n      this.batchContext.addToBatch(...journalIdsToUpdate);\r\n    }\r\n\r\n    // Second pass: Perform updates\r\n    let changedCount = 0;\r\n    const errors: Array<{ journalId: string; error: string }> = [];\r\n\r\n    for (const { journal, journalId } of journalsToUpdate) {\r\n      try {\r\n        const setFlagResult = await this.journalRepository.setFlag(\r\n          journalId,\r\n          this.config.moduleNamespace,\r\n          this.config.hiddenFlagKey,\r\n          false\r\n        );\r\n\r\n        if (!setFlagResult.ok) {\r\n          // Log error but continue with other journals\r\n          errors.push({\r\n            journalId,\r\n            error: `Failed to set flag: ${setFlagResult.error.message}`,\r\n          });\r\n          this.notifications.warn(\r\n            `Failed to set hidden flag for journal \"${journal.name ?? journalId}\"`,\r\n            {\r\n              errorCode: setFlagResult.error.code,\r\n              errorMessage: setFlagResult.error.message,\r\n              journalId,\r\n            },\r\n            { channels: [\"ConsoleChannel\"] }\r\n          );\r\n          continue;\r\n        }\r\n\r\n        changedCount++;\r\n      } catch (error) {\r\n        // Catch any unexpected errors\r\n        const errorMessage = error instanceof Error ? error.message : String(error);\r\n        errors.push({\r\n          journalId,\r\n          error: errorMessage,\r\n        });\r\n        this.notifications.warn(\r\n          `Unexpected error processing journal \"${journal.name ?? journalId}\"`,\r\n          {\r\n            error: errorMessage,\r\n            journalId,\r\n          },\r\n          { channels: [\"ConsoleChannel\"] }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Remove all journal IDs from batch context after updates complete\r\n    if (journalIdsToUpdate.length > 0) {\r\n      this.batchContext.removeFromBatch(...journalIdsToUpdate);\r\n    }\r\n\r\n    // Log summary\r\n    if (changedCount > 0) {\r\n      this.notifications.info(\r\n        `${changedCount} ${changedCount === 1 ? \"Journal\" : \"Journale\"} wieder eingeblendet`,\r\n        {\r\n          count: changedCount,\r\n        }\r\n      );\r\n    } else {\r\n      this.notifications.info(\"Keine versteckten Journale gefunden\", {});\r\n    }\r\n\r\n    // Log errors if any\r\n    if (errors.length > 0) {\r\n      this.notifications.warn(\r\n        `${errors.length} Fehler beim Verarbeiten von Journals`,\r\n        {\r\n          errorCount: errors.length,\r\n          errors: errors.slice(0, 5), // Only show first 5 errors\r\n        },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n\r\n    // Trigger UI re-render\r\n    const rerenderResult = this.journalDirectoryUI.rerenderJournalDirectory();\r\n    if (!rerenderResult.ok) {\r\n      this.notifications.warn(\r\n        \"Journal-Verzeichnis konnte nicht neu gerendert werden\",\r\n        {\r\n          errorCode: rerenderResult.error.code,\r\n          errorMessage: rerenderResult.error.message,\r\n        },\r\n        { channels: [\"ConsoleChannel\"] }\r\n      );\r\n    }\r\n\r\n    return ok(changedCount);\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for ShowAllHiddenJournalsUseCase.\r\n */\r\nexport class DIShowAllHiddenJournalsUseCase extends ShowAllHiddenJournalsUseCase {\r\n  static dependencies = [\r\n    platformJournalCollectionPortToken,\r\n    platformJournalRepositoryToken,\r\n    platformJournalDirectoryUiPortToken,\r\n    notificationPublisherPortToken,\r\n    journalVisibilityConfigToken,\r\n    batchUpdateContextServiceToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalCollection: PlatformJournalCollectionPort,\r\n    journalRepository: PlatformJournalRepository,\r\n    journalDirectoryUI: PlatformJournalDirectoryUiPort,\r\n    notifications: NotificationPublisherPort,\r\n    config: JournalVisibilityConfig,\r\n    batchContext: BatchUpdateContextService\r\n  ) {\r\n    super(\r\n      journalCollection,\r\n      journalRepository,\r\n      journalDirectoryUI,\r\n      notifications,\r\n      config,\r\n      batchContext\r\n    );\r\n  }\r\n}\r\n","import type { JournalContextMenuHandler } from \"./journal-context-menu-handler.interface\";\r\nimport type { JournalContextMenuEvent } from \"@/domain/ports/events/platform-journal-ui-event-port.interface\";\r\nimport type { PlatformJournalRepository } from \"@/domain/ports/repositories/platform-journal-repository.interface\";\r\nimport type { PlatformUIPort } from \"@/domain/ports/platform-ui-port.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport {\r\n  platformJournalRepositoryToken,\r\n  platformUIPortToken,\r\n  notificationPublisherPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { DOMAIN_FLAGS } from \"@/domain/constants/domain-constants\";\r\nimport { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\n\r\n/**\r\n * Handler that adds \"Journal ausblenden\" menu item to journal context menus.\r\n *\r\n * This handler checks if a journal is already hidden and only adds the menu item\r\n * if the journal is not hidden. When clicked, it sets the HIDDEN flag and shows a notification.\r\n */\r\nexport class HideJournalContextMenuHandler implements JournalContextMenuHandler {\r\n  constructor(\r\n    private readonly journalRepository: PlatformJournalRepository,\r\n    private readonly platformUI: PlatformUIPort,\r\n    private readonly notifications: NotificationPublisherPort\r\n  ) {}\r\n\r\n  handle(event: JournalContextMenuEvent): void {\r\n    // Journal-ID ist bereits im Event enthalten (DIP-compliant)\r\n    const journalId = event.journalId;\r\n\r\n    if (!journalId) {\r\n      return; // Kein Journal-Eintrag\r\n    }\r\n\r\n    // Prüfe, ob unser MenuItem bereits existiert\r\n    const existingItem = event.options.find((item) => item.name === \"Journal ausblenden\");\r\n\r\n    if (existingItem) {\r\n      return; // Bereits hinzugefügt\r\n    }\r\n\r\n    // Prüfe, ob Journal bereits versteckt ist\r\n    const flagResult = this.journalRepository.getFlag(\r\n      journalId,\r\n      MODULE_METADATA.ID,\r\n      DOMAIN_FLAGS.HIDDEN\r\n    );\r\n\r\n    // Nur hinzufügen, wenn nicht versteckt\r\n    if (flagResult.ok && flagResult.value !== true) {\r\n      event.options.push({\r\n        name: \"Journal ausblenden\",\r\n        icon: '<i class=\"fas fa-eye-slash\"></i>',\r\n        callback: async (_journalId: string) => {\r\n          // Journal verstecken\r\n          const hideResult = await this.journalRepository.setFlag(\r\n            journalId,\r\n            MODULE_METADATA.ID,\r\n            DOMAIN_FLAGS.HIDDEN,\r\n            true\r\n          );\r\n\r\n          if (hideResult.ok) {\r\n            // Hole Journal-Eintrag über Repository, um den Namen zu bekommen\r\n            const journalEntryResult = this.journalRepository.getById(journalId);\r\n            const journalName =\r\n              journalEntryResult.ok && journalEntryResult.value\r\n                ? (journalEntryResult.value.name ?? journalId)\r\n                : journalId; // Fallback auf ID, falls Name nicht verfügbar\r\n\r\n            // Notification mit Journal-Namen (für UI)\r\n            const notifyResult = this.platformUI.notify(\r\n              `Journal \"${journalName}\" wurde ausgeblendet`,\r\n              \"info\"\r\n            );\r\n\r\n            if (!notifyResult.ok) {\r\n              this.notifications.warn(\r\n                \"Failed to show notification after hiding journal\",\r\n                notifyResult.error,\r\n                { channels: [\"ConsoleChannel\"] }\r\n              );\r\n            }\r\n\r\n            // Log mit Journal-ID (für Debugging)\r\n            this.notifications.debug(\r\n              `Journal ${journalId} (${journalName}) hidden via context menu`,\r\n              { journalId, journalName },\r\n              { channels: [\"ConsoleChannel\"] }\r\n            );\r\n          } else {\r\n            this.notifications.error(\r\n              `Failed to hide journal ${journalId}`,\r\n              { code: hideResult.error.code, message: hideResult.error.message },\r\n              {\r\n                channels: [\"ConsoleChannel\", \"UINotificationChannel\"],\r\n              }\r\n            );\r\n          }\r\n        },\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for HideJournalContextMenuHandler.\r\n */\r\nexport class DIHideJournalContextMenuHandler extends HideJournalContextMenuHandler {\r\n  static dependencies = [\r\n    platformJournalRepositoryToken,\r\n    platformUIPortToken,\r\n    notificationPublisherPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    journalRepository: PlatformJournalRepository,\r\n    platformUI: PlatformUIPort,\r\n    notifications: NotificationPublisherPort\r\n  ) {\r\n    super(journalRepository, platformUI, notifications);\r\n  }\r\n}\r\n","import type { EventRegistrar } from \"@/application/use-cases/event-registrar.interface\";\r\n\r\n/**\r\n * Disposes all hooks in the provided array.\r\n *\r\n * This is a lifecycle method that is called when the module is disabled or reloaded.\r\n * Each hook's dispose() method is called to clean up any registered Foundry hooks.\r\n *\r\n * @param hooks - Array of EventRegistrar instances to dispose\r\n */\r\nexport function disposeHooks(hooks: EventRegistrar[]): void {\r\n  for (const hook of hooks) {\r\n    hook.dispose();\r\n  }\r\n}\r\n","import type { EventRegistrar } from \"@/application/use-cases/event-registrar.interface\";\r\nimport type { NotificationPublisherPort } from \"@/domain/ports/notifications/notification-publisher-port.interface\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { disposeHooks } from \"@/application/utils/dispose-hooks\";\r\nimport { notificationPublisherPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport {\r\n  invalidateJournalCacheOnChangeUseCaseToken,\r\n  processJournalDirectoryOnRenderUseCaseToken,\r\n  triggerJournalDirectoryReRenderUseCaseToken,\r\n} from \"@/application/tokens/event.tokens\";\r\n\r\n/**\r\n * ModuleEventRegistrar\r\n *\r\n * Manages registration of all platform-agnostic event listeners using Strategy Pattern.\r\n * Each event listener is implemented as a separate EventRegistrar class.\r\n *\r\n * **Design Benefits:**\r\n * - Easy to add new event listeners without modifying this class\r\n * - Each event listener can be tested in isolation\r\n * - Clear separation of concerns\r\n * - Full DI architecture: Event listeners injected as dependencies\r\n * - Platform-agnostic: Works with any event system (Foundry, Roll20, etc.)\r\n */\r\nexport class ModuleEventRegistrar {\r\n  private eventRegistrars: EventRegistrar[];\r\n\r\n  constructor(\r\n    processJournalDirectoryOnRender: EventRegistrar,\r\n    invalidateJournalCacheOnChange: EventRegistrar,\r\n    triggerJournalDirectoryReRender: EventRegistrar,\r\n    private readonly notifications: NotificationPublisherPort\r\n  ) {\r\n    this.eventRegistrars = [\r\n      processJournalDirectoryOnRender,\r\n      invalidateJournalCacheOnChange,\r\n      triggerJournalDirectoryReRender,\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Registers all event listeners.\r\n   *\r\n   * NOTE: Container parameter removed - event listeners receive all dependencies via constructor injection.\r\n   */\r\n  registerAll(): Result<void, Error[]> {\r\n    const errors: Error[] = [];\r\n\r\n    for (const registrar of this.eventRegistrars) {\r\n      const result = registrar.register();\r\n      if (!result.ok) {\r\n        // Convert string error to structured format\r\n        const error = {\r\n          code: \"EVENT_REGISTRATION_FAILED\" as const,\r\n          message: result.error.message,\r\n        };\r\n        // Bootstrap error - log to console only (no UI notification)\r\n        this.notifications.error(\"Failed to register event listener\", error, {\r\n          channels: [\"ConsoleChannel\"],\r\n        });\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      return err(errors);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  /**\r\n   * Dispose all event listeners.\r\n   * Called when the module is disabled or reloaded.\r\n   */\r\n  disposeAll(): void {\r\n    disposeHooks(this.eventRegistrars);\r\n  }\r\n}\r\n\r\nexport class DIModuleEventRegistrar extends ModuleEventRegistrar {\r\n  static dependencies = [\r\n    processJournalDirectoryOnRenderUseCaseToken,\r\n    invalidateJournalCacheOnChangeUseCaseToken,\r\n    triggerJournalDirectoryReRenderUseCaseToken,\r\n    notificationPublisherPortToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    processJournalDirectoryOnRender: EventRegistrar,\r\n    invalidateJournalCacheOnChange: EventRegistrar,\r\n    triggerJournalDirectoryReRender: EventRegistrar,\r\n    notifications: NotificationPublisherPort\r\n  ) {\r\n    super(\r\n      processJournalDirectoryOnRender,\r\n      invalidateJournalCacheOnChange,\r\n      triggerJournalDirectoryReRender,\r\n      notifications\r\n    );\r\n  }\r\n}\r\n","/**\r\n * Service for tracking journal IDs during batch update operations.\r\n *\r\n * This service allows use-cases to mark multiple journal IDs as part of a batch operation,\r\n * which can be checked by other services (e.g., event handlers) to optimize behavior\r\n * (e.g., skip individual re-renders during batch updates).\r\n *\r\n * **Thread-Safety:**\r\n * JavaScript is single-threaded, so Set operations are inherently thread-safe.\r\n * However, this service should be used as a singleton to ensure consistent state\r\n * across all use-cases that need to check batch status.\r\n *\r\n * **Usage:**\r\n * ```typescript\r\n * // In a use-case performing batch updates:\r\n * batchContext.addToBatch(...journalIds);\r\n * // ... perform updates ...\r\n * batchContext.removeFromBatch(...journalIds);\r\n *\r\n * // In an event handler:\r\n * if (batchContext.isInBatch(journalId)) {\r\n *   // Skip individual processing, wait for batch completion\r\n *   return;\r\n * }\r\n * ```\r\n *\r\n * **Platform-Agnostic:**\r\n * This service is purely in-memory and platform-agnostic, making it suitable\r\n * for any VTT platform (Foundry, Roll20, etc.).\r\n */\r\nexport class BatchUpdateContextService {\r\n  private readonly batchIds = new Set<string>();\r\n\r\n  /**\r\n   * Adds one or more journal IDs to the batch update context.\r\n   *\r\n   * @param journalIds - Journal IDs to add to the batch\r\n   */\r\n  addToBatch(...journalIds: string[]): void {\r\n    for (const id of journalIds) {\r\n      this.batchIds.add(id);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes one or more journal IDs from the batch update context.\r\n   *\r\n   * @param journalIds - Journal IDs to remove from the batch\r\n   */\r\n  removeFromBatch(...journalIds: string[]): void {\r\n    for (const id of journalIds) {\r\n      this.batchIds.delete(id);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all journal IDs from the batch update context.\r\n   *\r\n   * Useful for cleanup in error scenarios or when batch state needs to be reset.\r\n   */\r\n  clearBatch(): void {\r\n    this.batchIds.clear();\r\n  }\r\n\r\n  /**\r\n   * Checks if a journal ID is currently part of a batch update.\r\n   *\r\n   * @param journalId - The journal ID to check\r\n   * @returns `true` if the journal ID is in the batch, `false` otherwise\r\n   */\r\n  isInBatch(journalId: string): boolean {\r\n    return this.batchIds.has(journalId);\r\n  }\r\n\r\n  /**\r\n   * Checks if the batch update context is empty.\r\n   *\r\n   * @returns `true` if no journal IDs are in the batch, `false` otherwise\r\n   */\r\n  isEmpty(): boolean {\r\n    return this.batchIds.size === 0;\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for BatchUpdateContextService.\r\n *\r\n * This service must be registered as a SINGLETON to ensure that all use-cases\r\n * and event handlers share the same batch context state.\r\n */\r\nexport class DIBatchUpdateContextService extends BatchUpdateContextService {\r\n  static dependencies = [] as const;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  platformJournalEventPortToken,\r\n  platformJournalUiEventPortToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { hideJournalContextMenuHandlerToken } from \"@/application/tokens/application.tokens\";\r\nimport {\r\n  invalidateJournalCacheOnChangeUseCaseToken,\r\n  processJournalDirectoryOnRenderUseCaseToken,\r\n  triggerJournalDirectoryReRenderUseCaseToken,\r\n  registerContextMenuUseCaseToken,\r\n  showAllHiddenJournalsUseCaseToken,\r\n  moduleEventRegistrarToken,\r\n} from \"@/application/tokens/event.tokens\";\r\nimport { journalContextMenuHandlersToken } from \"@/application/tokens/application.tokens\";\r\nimport { DIFoundryJournalEventAdapter } from \"@/infrastructure/adapters/foundry/event-adapters/foundry-journal-event-adapter\";\r\nimport { DIFoundryJournalUiEventAdapter } from \"@/infrastructure/adapters/foundry/event-adapters/foundry-journal-ui-event-adapter\";\r\nimport { DIInvalidateJournalCacheOnChangeUseCase } from \"@/application/use-cases/invalidate-journal-cache-on-change.use-case\";\r\nimport { DIProcessJournalDirectoryOnRenderUseCase } from \"@/application/use-cases/process-journal-directory-on-render.use-case\";\r\nimport { DITriggerJournalDirectoryReRenderUseCase } from \"@/application/use-cases/trigger-journal-directory-rerender.use-case\";\r\nimport { DIRegisterContextMenuUseCase } from \"@/application/use-cases/register-context-menu.use-case\";\r\nimport { DIShowAllHiddenJournalsUseCase } from \"@/application/use-cases/show-all-hidden-journals.use-case\";\r\nimport { DIHideJournalContextMenuHandler } from \"@/application/handlers/hide-journal-context-menu-handler\";\r\nimport { DIModuleEventRegistrar } from \"@/application/services/ModuleEventRegistrar\";\r\nimport { DIBatchUpdateContextService } from \"@/application/services/BatchUpdateContextService\";\r\nimport type { JournalContextMenuHandler } from \"@/application/handlers/journal-context-menu-handler.interface\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport { batchUpdateContextServiceToken } from \"@/application/tokens/application.tokens\";\r\n\r\n/**\r\n * Helper function to resolve multiple services and extract their values.\r\n * This function respects the Result-Pattern by propagating errors through Results\r\n * before converting to an exception (which is required by FactoryFunction<T>).\r\n *\r\n * @template T - The type of service to resolve\r\n * @param container - The service container\r\n * @param tokens - Array of tokens to resolve\r\n * @returns Array of resolved service instances\r\n * @throws Error if any service resolution fails\r\n */\r\nfunction resolveMultipleServices<T>(\r\n  container: ServiceContainer,\r\n  tokens: Array<{ token: symbol; name: string }>\r\n): T[] {\r\n  const results: T[] = [];\r\n  for (const { token, name } of tokens) {\r\n    const result = container.resolveWithError(token);\r\n    if (!result.ok) {\r\n      throw new Error(`Failed to resolve ${name}: ${result.error.message}`);\r\n    }\r\n    results.push(castResolvedService<T>(result.value));\r\n  }\r\n  return results;\r\n}\r\n\r\n/**\r\n * Registers event port services.\r\n *\r\n * Services registered:\r\n * - PlatformJournalEventPort (singleton) - Platform-agnostic journal lifecycle event handling\r\n * - PlatformJournalUiEventPort (singleton) - Platform-agnostic journal UI event handling\r\n * - InvalidateJournalCacheOnChangeUseCase (singleton) - Cache invalidation use-case\r\n * - ProcessJournalDirectoryOnRenderUseCase (singleton) - Directory render use-case\r\n * - TriggerJournalDirectoryReRenderUseCase (singleton) - UI re-render use-case\r\n * - HideJournalContextMenuHandler (singleton) - Handler for \"Journal ausblenden\" context menu item\r\n * - RegisterContextMenuUseCase (singleton) - Context menu callback registration (NOT an event registrar)\r\n * - ShowAllHiddenJournalsUseCase (singleton) - Use-case for showing all hidden journals\r\n * - BatchUpdateContextService (singleton) - Service for tracking journal IDs during batch updates\r\n * - ModuleEventRegistrar (singleton) - Manages all event listeners\r\n *\r\n * DESIGN: Event ports are platform-agnostic abstractions over event systems.\r\n * They enable multi-VTT support by decoupling from Foundry-specific APIs.\r\n *\r\n * NOTE: RegisterContextMenuUseCase is NOT an EventRegistrar. It manages callbacks\r\n * for the context menu libWrapper, which is registered separately during init.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerEventPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register PlatformJournalEventPort (Foundry implementation) - Core lifecycle events\r\n  const eventPortResult = container.registerClass(\r\n    platformJournalEventPortToken,\r\n    DIFoundryJournalEventAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(eventPortResult)) {\r\n    return err(`Failed to register PlatformJournalEventPort: ${eventPortResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformJournalUiEventPort (Foundry implementation) - UI-specific events\r\n  const uiEventPortResult = container.registerClass(\r\n    platformJournalUiEventPortToken,\r\n    DIFoundryJournalUiEventAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(uiEventPortResult)) {\r\n    return err(`Failed to register PlatformJournalUiEventPort: ${uiEventPortResult.error.message}`);\r\n  }\r\n\r\n  // Register InvalidateJournalCacheOnChangeUseCase\r\n  const cacheInvalidationUseCaseResult = container.registerClass(\r\n    invalidateJournalCacheOnChangeUseCaseToken,\r\n    DIInvalidateJournalCacheOnChangeUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(cacheInvalidationUseCaseResult)) {\r\n    return err(\r\n      `Failed to register InvalidateJournalCacheOnChangeUseCase: ${cacheInvalidationUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ProcessJournalDirectoryOnRenderUseCase\r\n  const directoryRenderUseCaseResult = container.registerClass(\r\n    processJournalDirectoryOnRenderUseCaseToken,\r\n    DIProcessJournalDirectoryOnRenderUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(directoryRenderUseCaseResult)) {\r\n    return err(\r\n      `Failed to register ProcessJournalDirectoryOnRenderUseCase: ${directoryRenderUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register TriggerJournalDirectoryReRenderUseCase\r\n  const reRenderUseCaseResult = container.registerClass(\r\n    triggerJournalDirectoryReRenderUseCaseToken,\r\n    DITriggerJournalDirectoryReRenderUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(reRenderUseCaseResult)) {\r\n    return err(\r\n      `Failed to register TriggerJournalDirectoryReRenderUseCase: ${reRenderUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register HideJournalContextMenuHandler\r\n  const hideJournalHandlerResult = container.registerClass(\r\n    hideJournalContextMenuHandlerToken,\r\n    DIHideJournalContextMenuHandler,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(hideJournalHandlerResult)) {\r\n    return err(\r\n      `Failed to register HideJournalContextMenuHandler: ${hideJournalHandlerResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register array of context menu handlers using a factory function\r\n  // This allows handlers to be resolved after container validation\r\n  // NOTE: Factory functions must return T, not Result<T, E>, so we use a helper\r\n  // that respects the Result-Pattern by propagating Results before converting to exception\r\n  const handlersArrayResult = container.registerFactory(\r\n    journalContextMenuHandlersToken,\r\n    (): JournalContextMenuHandler[] => {\r\n      return resolveMultipleServices<JournalContextMenuHandler>(container, [\r\n        { token: hideJournalContextMenuHandlerToken, name: \"HideJournalContextMenuHandler\" },\r\n      ]);\r\n    },\r\n    ServiceLifecycle.SINGLETON,\r\n    [hideJournalContextMenuHandlerToken]\r\n  );\r\n  if (isErr(handlersArrayResult)) {\r\n    return err(\r\n      `Failed to register JournalContextMenuHandlers array: ${handlersArrayResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register RegisterContextMenuUseCase\r\n  const contextMenuUseCaseResult = container.registerClass(\r\n    registerContextMenuUseCaseToken,\r\n    DIRegisterContextMenuUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(contextMenuUseCaseResult)) {\r\n    return err(\r\n      `Failed to register RegisterContextMenuUseCase: ${contextMenuUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register BatchUpdateContextService\r\n  const batchUpdateContextServiceResult = container.registerClass(\r\n    batchUpdateContextServiceToken,\r\n    DIBatchUpdateContextService,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(batchUpdateContextServiceResult)) {\r\n    return err(\r\n      `Failed to register BatchUpdateContextService: ${batchUpdateContextServiceResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ShowAllHiddenJournalsUseCase\r\n  const showAllHiddenJournalsUseCaseResult = container.registerClass(\r\n    showAllHiddenJournalsUseCaseToken,\r\n    DIShowAllHiddenJournalsUseCase,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(showAllHiddenJournalsUseCaseResult)) {\r\n    return err(\r\n      `Failed to register ShowAllHiddenJournalsUseCase: ${showAllHiddenJournalsUseCaseResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register ModuleEventRegistrar\r\n  const eventRegistrarResult = container.registerClass(\r\n    moduleEventRegistrarToken,\r\n    DIModuleEventRegistrar,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(eventRegistrarResult)) {\r\n    return err(`Failed to register ModuleEventRegistrar: ${eventRegistrarResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"EventPorts\",\r\n  priority: 140,\r\n  execute: registerEventPorts,\r\n});\r\n","import type { JournalMapper } from \"./journal-mapper.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\n\r\n/**\r\n * Registry for journal mappers with priority-based selection.\r\n *\r\n * When mapping a Foundry entity to domain, the registry returns the first mapper\r\n * that supports the entity (based on registration order).\r\n *\r\n * This enables extensible mapping: new mappers can be registered to handle\r\n * additional fields or entity variants without modifying existing code (OCP).\r\n *\r\n * @example\r\n * ```typescript\r\n * const registry = new JournalMapperRegistry();\r\n * registry.register(new DefaultJournalMapper());\r\n * registry.register(new FolderJournalMapper());\r\n *\r\n * const domainEntry = registry.mapToDomain(foundryEntry);\r\n * ```\r\n */\r\nexport class JournalMapperRegistry {\r\n  private readonly mappers: JournalMapper[] = [];\r\n\r\n  /**\r\n   * Registers a mapper with the registry.\r\n   *\r\n   * Mappers are checked in registration order (first registered = highest priority).\r\n   * The first mapper that returns true for `supports()` will be used.\r\n   *\r\n   * @param mapper - The mapper to register\r\n   * @throws Error if the mapper is already registered\r\n   */\r\n  register(mapper: JournalMapper): void {\r\n    if (this.mappers.includes(mapper)) {\r\n      throw new Error(\"Mapper is already registered\");\r\n    }\r\n    this.mappers.push(mapper);\r\n  }\r\n\r\n  /**\r\n   * Unregisters a mapper from the registry.\r\n   *\r\n   * @param mapper - The mapper to unregister\r\n   */\r\n  unregister(mapper: JournalMapper): void {\r\n    const index = this.mappers.indexOf(mapper);\r\n    if (index !== -1) {\r\n      this.mappers.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns all registered mappers in priority order.\r\n   *\r\n   * @returns Array of mappers (first = highest priority)\r\n   */\r\n  getAll(): readonly JournalMapper[] {\r\n    return [...this.mappers];\r\n  }\r\n\r\n  /**\r\n   * Finds the first mapper that supports the given entity.\r\n   *\r\n   * @param entity - The Foundry entity to find a mapper for\r\n   * @returns The first matching mapper, or undefined if none found\r\n   */\r\n  findMapper(entity: unknown): JournalMapper | undefined {\r\n    return this.mappers.find((mapper) => mapper.supports(entity));\r\n  }\r\n\r\n  /**\r\n   * Maps a Foundry journal entry to a domain journal entry using the first matching mapper.\r\n   *\r\n   * @param entity - The Foundry journal entry to map\r\n   * @returns The domain journal entry\r\n   * @throws Error if no mapper supports the entity\r\n   */\r\n  mapToDomain(entity: unknown): JournalEntry {\r\n    const mapper = this.findMapper(entity);\r\n    if (!mapper) {\r\n      throw new Error(`No mapper found for entity: ${JSON.stringify(entity).substring(0, 100)}`);\r\n    }\r\n\r\n    // Type narrowing: mapper.supports() is a type guard\r\n    if (!mapper.supports(entity)) {\r\n      throw new Error(\r\n        `Mapper supports() returned false after findMapper() returned it: ${mapper.constructor.name}`\r\n      );\r\n    }\r\n\r\n    return mapper.toDomain(entity);\r\n  }\r\n\r\n  /**\r\n   * Validates that no two mappers have overlapping support.\r\n   *\r\n   * This is useful for detecting configuration errors during development.\r\n   * Note: This is a best-effort check and may not catch all overlaps.\r\n   *\r\n   * @param testEntities - Optional array of test entities to check against\r\n   * @returns Array of conflicts (empty if none)\r\n   */\r\n  validateNoOverlaps(testEntities: unknown[] = []): Array<{\r\n    entity: unknown;\r\n    mappers: JournalMapper[];\r\n  }> {\r\n    const conflicts: Array<{ entity: unknown; mappers: JournalMapper[] }> = [];\r\n\r\n    for (const entity of testEntities) {\r\n      const matchingMappers = this.mappers.filter((mapper) => mapper.supports(entity));\r\n      if (matchingMappers.length > 1) {\r\n        conflicts.push({\r\n          entity,\r\n          mappers: matchingMappers,\r\n        });\r\n      }\r\n    }\r\n\r\n    return conflicts;\r\n  }\r\n}\r\n","import type { JournalMapper } from \"./journal-mapper.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { FoundryJournalEntry } from \"@/infrastructure/adapters/foundry/types\";\r\n\r\n/**\r\n * Default mapper for Foundry journal entries.\r\n *\r\n * Handles the standard mapping: id and name fields.\r\n * This is the fallback mapper that should be registered last in the registry\r\n * (lowest priority) to handle standard journal entries.\r\n *\r\n * Conversion rules:\r\n * - `id` is copied as-is\r\n * - `name` is converted: `undefined` → `null` (domain requires `string | null`)\r\n */\r\nexport class DefaultJournalMapper implements JournalMapper {\r\n  /**\r\n   * Type guard: checks if entity is a Foundry journal entry.\r\n   *\r\n   * Supports any object with an `id` property (basic check).\r\n   * More specific mappers should be registered before this one.\r\n   *\r\n   * @param entity - The entity to check\r\n   * @returns True if entity has id property\r\n   */\r\n  supports(entity: unknown): entity is FoundryJournalEntry {\r\n    return (\r\n      typeof entity === \"object\" &&\r\n      entity !== null &&\r\n      \"id\" in entity &&\r\n      typeof (entity as { id: unknown }).id === \"string\"\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Maps a Foundry journal entry to a domain journal entry.\r\n   *\r\n   * @param entity - The Foundry journal entry\r\n   * @returns The domain journal entry\r\n   */\r\n  toDomain(entity: FoundryJournalEntry): JournalEntry {\r\n    return {\r\n      id: entity.id,\r\n      name: entity.name ?? null,\r\n    };\r\n  }\r\n}\r\n","import type { FilterOperator } from \"./filter-operator.interface\";\r\n\r\n/**\r\n * Registry for filter operators.\r\n *\r\n * Enables dynamic registration and lookup of filter operators (Strategy Pattern).\r\n * This allows extending the filter system without modifying existing code (OCP-compliant).\r\n */\r\nexport class FilterOperatorRegistry {\r\n  private readonly operators = new Map<string, FilterOperator>();\r\n\r\n  /**\r\n   * Registers a filter operator.\r\n   *\r\n   * @param operator - The operator to register\r\n   * @throws Error if an operator with the same name is already registered\r\n   */\r\n  register(operator: FilterOperator): void {\r\n    if (this.operators.has(operator.name)) {\r\n      throw new Error(\r\n        `Filter operator \"${operator.name}\" is already registered. Use unregister() first to replace an existing operator.`\r\n      );\r\n    }\r\n    this.operators.set(operator.name, operator);\r\n  }\r\n\r\n  /**\r\n   * Unregisters a filter operator.\r\n   *\r\n   * @param name - The name of the operator to unregister\r\n   * @returns true if the operator was unregistered, false if it wasn't registered\r\n   */\r\n  unregister(name: string): boolean {\r\n    return this.operators.delete(name);\r\n  }\r\n\r\n  /**\r\n   * Gets a filter operator by name.\r\n   *\r\n   * @param name - The name of the operator\r\n   * @returns The operator if found, undefined otherwise\r\n   */\r\n  get(name: string): FilterOperator | undefined {\r\n    return this.operators.get(name);\r\n  }\r\n\r\n  /**\r\n   * Checks if an operator is registered.\r\n   *\r\n   * @param name - The name of the operator\r\n   * @returns true if registered, false otherwise\r\n   */\r\n  has(name: string): boolean {\r\n    return this.operators.has(name);\r\n  }\r\n\r\n  /**\r\n   * Gets all registered operator names.\r\n   *\r\n   * @returns Array of operator names\r\n   */\r\n  getOperatorNames(): string[] {\r\n    return Array.from(this.operators.keys());\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Equals operator: exact match comparison.\r\n */\r\nexport class EqualsOperator implements FilterOperator {\r\n  readonly name = \"equals\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return fieldValue === filterValue;\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Not equals operator: negated exact match comparison.\r\n */\r\nexport class NotEqualsOperator implements FilterOperator {\r\n  readonly name = \"notEquals\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return fieldValue !== filterValue;\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Contains operator: case-insensitive substring match.\r\n */\r\nexport class ContainsOperator implements FilterOperator {\r\n  readonly name = \"contains\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return String(fieldValue).toLowerCase().includes(String(filterValue).toLowerCase());\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Starts with operator: case-insensitive prefix match.\r\n */\r\nexport class StartsWithOperator implements FilterOperator {\r\n  readonly name = \"startsWith\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return String(fieldValue).toLowerCase().startsWith(String(filterValue).toLowerCase());\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Ends with operator: case-insensitive suffix match.\r\n */\r\nexport class EndsWithOperator implements FilterOperator {\r\n  readonly name = \"endsWith\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return String(fieldValue).toLowerCase().endsWith(String(filterValue).toLowerCase());\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * In operator: checks if field value is in the filter array.\r\n */\r\nexport class InOperator implements FilterOperator {\r\n  readonly name = \"in\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    if (!Array.isArray(filterValue)) {\r\n      return false;\r\n    }\r\n    const filterArray: unknown[] = filterValue;\r\n    return filterArray.includes(fieldValue);\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Not in operator: checks if field value is not in the filter array.\r\n */\r\nexport class NotInOperator implements FilterOperator {\r\n  readonly name = \"notIn\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    if (!Array.isArray(filterValue)) {\r\n      return false;\r\n    }\r\n    const filterArray: unknown[] = filterValue;\r\n    return !filterArray.includes(fieldValue);\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Greater than operator: numeric comparison.\r\n */\r\nexport class GreaterThanOperator implements FilterOperator {\r\n  readonly name = \"greaterThan\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return Number(fieldValue) > Number(filterValue);\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Less than operator: numeric comparison.\r\n */\r\nexport class LessThanOperator implements FilterOperator {\r\n  readonly name = \"lessThan\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return Number(fieldValue) < Number(filterValue);\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Greater than or equal operator: numeric comparison.\r\n */\r\nexport class GreaterThanOrEqualOperator implements FilterOperator {\r\n  readonly name = \"greaterThanOrEqual\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return Number(fieldValue) >= Number(filterValue);\r\n  }\r\n}\r\n","import type { FilterOperator } from \"../filter-operator.interface\";\r\n\r\n/**\r\n * Less than or equal operator: numeric comparison.\r\n */\r\nexport class LessThanOrEqualOperator implements FilterOperator {\r\n  readonly name = \"lessThanOrEqual\";\r\n\r\n  matches(fieldValue: unknown, filterValue: unknown): boolean {\r\n    return Number(fieldValue) <= Number(filterValue);\r\n  }\r\n}\r\n","import { FilterOperatorRegistry } from \"./filter-operator-registry\";\r\nimport { EqualsOperator } from \"./operators/equals-operator\";\r\nimport { NotEqualsOperator } from \"./operators/not-equals-operator\";\r\nimport { ContainsOperator } from \"./operators/contains-operator\";\r\nimport { StartsWithOperator } from \"./operators/starts-with-operator\";\r\nimport { EndsWithOperator } from \"./operators/ends-with-operator\";\r\nimport { InOperator } from \"./operators/in-operator\";\r\nimport { NotInOperator } from \"./operators/not-in-operator\";\r\nimport { GreaterThanOperator } from \"./operators/greater-than-operator\";\r\nimport { LessThanOperator } from \"./operators/less-than-operator\";\r\nimport { GreaterThanOrEqualOperator } from \"./operators/greater-than-or-equal-operator\";\r\nimport { LessThanOrEqualOperator } from \"./operators/less-than-or-equal-operator\";\r\n\r\n/**\r\n * Creates a FilterOperatorRegistry with all default filter operators registered.\r\n *\r\n * This factory function provides the standard set of filter operators used by\r\n * Foundry collection adapters. Custom operators can be registered after creation.\r\n *\r\n * @returns A FilterOperatorRegistry with all default operators registered\r\n */\r\nexport function createDefaultFilterOperators(): FilterOperatorRegistry {\r\n  const registry = new FilterOperatorRegistry();\r\n\r\n  // Register all default operators\r\n  registry.register(new EqualsOperator());\r\n  registry.register(new NotEqualsOperator());\r\n  registry.register(new ContainsOperator());\r\n  registry.register(new StartsWithOperator());\r\n  registry.register(new EndsWithOperator());\r\n  registry.register(new InOperator());\r\n  registry.register(new NotInOperator());\r\n  registry.register(new GreaterThanOperator());\r\n  registry.register(new LessThanOperator());\r\n  registry.register(new GreaterThanOrEqualOperator());\r\n  registry.register(new LessThanOrEqualOperator());\r\n\r\n  return registry;\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalCollectionPort } from \"@/domain/ports/collections/platform-journal-collection-port.interface\";\r\nimport type { EntityCollectionError } from \"@/domain/ports/collections/entity-collection-error.interface\";\r\nimport type { EntitySearchQuery } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { EntityQueryBuilder } from \"@/domain/ports/collections/entity-query-builder.interface\";\r\nimport type { EntityFilter } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport { JournalMapperRegistry } from \"../mappers/journal-mapper-registry\";\r\nimport { DefaultJournalMapper } from \"../mappers/default-journal-mapper\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { FilterOperatorRegistry } from \"./filter-operator-registry\";\r\nimport { createDefaultFilterOperators } from \"./default-filter-operators\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformJournalCollectionPort.\r\n *\r\n * Maps Foundry's game.journal collection to platform-agnostic journal collection port.\r\n * Type mapping is handled by JournalMapperRegistry (OCP-compliant).\r\n * Filter operators are handled by FilterOperatorRegistry (OCP-compliant Strategy Pattern).\r\n */\r\nexport class FoundryJournalCollectionAdapter implements PlatformJournalCollectionPort {\r\n  constructor(\r\n    private readonly foundryGame: FoundryGame, // FoundryGamePort (version-agnostisch), nicht FoundryV13GamePort!\r\n    private readonly mapperRegistry: JournalMapperRegistry, // Mapper registry for extensible mapping (OCP)\r\n    private readonly operatorRegistry: FilterOperatorRegistry = createDefaultFilterOperators() // Operator registry for extensible filtering (OCP)\r\n  ) {}\r\n\r\n  getAll(): Result<JournalEntry[], EntityCollectionError> {\r\n    const result = this.foundryGame.getJournalEntries();\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"COLLECTION_NOT_AVAILABLE\",\r\n          message: `Failed to get journals from Foundry: ${result.error.message}`,\r\n          details: result.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Map Foundry types → Domain types using mapper registry\r\n    const entries: JournalEntry[] = [];\r\n    for (const foundryEntry of result.value) {\r\n      try {\r\n        entries.push(this.mapperRegistry.mapToDomain(foundryEntry));\r\n      } catch (error) {\r\n        return err({\r\n          code: \"PLATFORM_ERROR\",\r\n          message: `Failed to map journal entry to domain: ${error instanceof Error ? error.message : String(error)}`,\r\n          details: error,\r\n        });\r\n      }\r\n    }\r\n\r\n    return ok(entries);\r\n  }\r\n\r\n  getById(id: string): Result<JournalEntry | null, EntityCollectionError> {\r\n    const result = this.foundryGame.getJournalEntryById(id);\r\n\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"PLATFORM_ERROR\",\r\n          message: `Failed to get journal ${id} from Foundry: ${result.error.message}`,\r\n          details: result.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Not found → return null (not an error)\r\n    if (!result.value) {\r\n      return ok(null);\r\n    }\r\n\r\n    // Map Foundry type → Domain type using mapper registry\r\n    try {\r\n      const entry = this.mapperRegistry.mapToDomain(result.value);\r\n      return ok(entry);\r\n    } catch (error) {\r\n      return err({\r\n        code: \"PLATFORM_ERROR\",\r\n        message: `Failed to map journal entry to domain: ${error instanceof Error ? error.message : String(error)}`,\r\n        details: error,\r\n      });\r\n    }\r\n  }\r\n\r\n  getByIds(ids: string[]): Result<JournalEntry[], EntityCollectionError> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityCollectionError[] = [];\r\n\r\n    for (const id of ids) {\r\n      const result = this.getById(id);\r\n      if (!result.ok) {\r\n        errors.push(result.error);\r\n      } else if (result.value) {\r\n        // Found - add to results\r\n        results.push(result.value);\r\n      }\r\n      // else: Not found - skip (not an error for batch operations)\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  exists(id: string): Result<boolean, EntityCollectionError> {\r\n    const result = this.getById(id);\r\n    if (!result.ok) {\r\n      return result; // Propagate error\r\n    }\r\n    return ok(result.value !== null);\r\n  }\r\n\r\n  count(): Result<number, EntityCollectionError> {\r\n    const result = this.getAll();\r\n    if (!result.ok) {\r\n      return {\r\n        ok: false,\r\n        error: result.error,\r\n      };\r\n    }\r\n    return ok(result.value.length);\r\n  }\r\n\r\n  search(query: EntitySearchQuery<JournalEntry>): Result<JournalEntry[], EntityCollectionError> {\r\n    // Get all entities first\r\n    const allResult = this.getAll();\r\n    if (!allResult.ok) {\r\n      return allResult;\r\n    }\r\n\r\n    let results = allResult.value;\r\n\r\n    // Apply filters\r\n    if (query.filters && query.filters.length > 0) {\r\n      const filters = query.filters; // Type narrowing\r\n      results = results.filter((entity) => {\r\n        // All filters must match (AND logic)\r\n        return filters.every((filter) => {\r\n          const fieldValue = entity[filter.field];\r\n          return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n        });\r\n      });\r\n    }\r\n\r\n    // Apply filter groups (for complex AND/OR logic)\r\n    if (query.filterGroups && query.filterGroups.length > 0) {\r\n      const filterGroups = query.filterGroups; // Type narrowing\r\n      results = results.filter((entity) => {\r\n        // All groups must match (AND between groups)\r\n        return filterGroups.every((group) => {\r\n          if (group.filters.length === 0) return true;\r\n\r\n          if (group.logic === \"OR\") {\r\n            // At least one filter in group must match\r\n            return group.filters.some((filter) => {\r\n              const fieldValue = entity[filter.field];\r\n              return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n            });\r\n          } else {\r\n            // All filters in group must match (AND)\r\n            return group.filters.every((filter) => {\r\n              const fieldValue = entity[filter.field];\r\n              return this.matchesFilter(fieldValue, filter.operator, filter.value);\r\n            });\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    // Apply sorting\r\n    if (query.sortBy) {\r\n      const sortBy = query.sortBy; // Type narrowing\r\n      results.sort((a, b) => {\r\n        const aValue = a[sortBy];\r\n        const bValue = b[sortBy];\r\n\r\n        if (aValue === bValue) return 0;\r\n        if (aValue === null || aValue === undefined) return 1;\r\n        if (bValue === null || bValue === undefined) return -1;\r\n\r\n        const comparison = aValue < bValue ? -1 : 1;\r\n        return query.sortOrder === \"desc\" ? -comparison : comparison;\r\n      });\r\n    }\r\n\r\n    // Apply pagination\r\n    if (query.offset) {\r\n      results = results.slice(query.offset);\r\n    }\r\n    if (query.limit) {\r\n      results = results.slice(0, query.limit);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  query(): EntityQueryBuilder<JournalEntry> {\r\n    return new FoundryJournalQueryBuilder(this);\r\n  }\r\n\r\n  /**\r\n   * Checks if a field value matches a filter using the registered operator.\r\n   *\r\n   * Uses FilterOperatorRegistry (Strategy Pattern) for OCP-compliant extensibility.\r\n   * New operators can be added without modifying this method.\r\n   *\r\n   * @param fieldValue - The value from the entity field\r\n   * @param operator - The operator name (e.g., \"equals\", \"contains\")\r\n   * @param filterValue - The value from the filter\r\n   * @returns true if the field value matches the filter, false otherwise\r\n   */\r\n  private matchesFilter(fieldValue: unknown, operator: string, filterValue: unknown): boolean {\r\n    const op = this.operatorRegistry.get(operator);\r\n    if (!op) {\r\n      return false; // Unknown operator → no match\r\n    }\r\n    return op.matches(fieldValue, filterValue);\r\n  }\r\n}\r\n\r\n/**\r\n * Query builder implementation for Foundry journal collection.\r\n */\r\nclass FoundryJournalQueryBuilder implements EntityQueryBuilder<JournalEntry> {\r\n  private query: EntitySearchQuery<JournalEntry> = {};\r\n  private currentOrGroup: Array<{\r\n    field: keyof JournalEntry;\r\n    operator: EntityFilter<JournalEntry>[\"operator\"];\r\n    value: unknown;\r\n  }> | null = null;\r\n\r\n  constructor(private readonly adapter: FoundryJournalCollectionAdapter) {}\r\n\r\n  where(\r\n    field: keyof JournalEntry,\r\n    operator: EntityFilter<JournalEntry>[\"operator\"],\r\n    value: unknown\r\n  ): EntityQueryBuilder<JournalEntry> {\r\n    // If we're inside an or() callback, add to currentOrGroup\r\n    if (this.currentOrGroup !== null) {\r\n      this.currentOrGroup.push({ field, operator, value });\r\n      return this;\r\n    }\r\n\r\n    // Otherwise, close any open OR group and add to AND filters\r\n    this.closeOrGroup();\r\n\r\n    if (!this.query.filters) {\r\n      this.query.filters = [];\r\n    }\r\n    this.query.filters.push({ field, operator, value });\r\n    return this;\r\n  }\r\n\r\n  orWhere(\r\n    field: keyof JournalEntry,\r\n    operator: EntityFilter<JournalEntry>[\"operator\"],\r\n    value: unknown\r\n  ): EntityQueryBuilder<JournalEntry> {\r\n    // Start OR group if not already started\r\n    if (this.currentOrGroup === null) {\r\n      this.currentOrGroup = [];\r\n      // Move the last where() filter into the OR group\r\n      if (this.query.filters && this.query.filters.length > 0) {\r\n        // type-coverage:ignore-next-line - Array with length > 0 guarantees element from pop()\r\n        const lastFilter = this.query.filters.pop()!;\r\n        this.currentOrGroup.push({\r\n          field: lastFilter.field,\r\n          operator: lastFilter.operator,\r\n          value: lastFilter.value,\r\n        });\r\n      }\r\n    }\r\n\r\n    this.currentOrGroup.push({ field, operator, value });\r\n    return this;\r\n  }\r\n\r\n  or(callback: (qb: EntityQueryBuilder<JournalEntry>) => void): EntityQueryBuilder<JournalEntry> {\r\n    // Close any open OR group first\r\n    this.closeOrGroup();\r\n\r\n    // Create new OR group\r\n    const orGroup: Array<{\r\n      field: keyof JournalEntry;\r\n      operator: EntityFilter<JournalEntry>[\"operator\"];\r\n      value: unknown;\r\n    }> = [];\r\n\r\n    // Move the last where() filter into the OR group\r\n    if (this.query.filters && this.query.filters.length > 0) {\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element from pop()\r\n      const lastFilter = this.query.filters.pop()!;\r\n      orGroup.push({\r\n        field: lastFilter.field,\r\n        operator: lastFilter.operator,\r\n        value: lastFilter.value,\r\n      });\r\n    }\r\n\r\n    // Temporarily set currentOrGroup to capture filters from callback\r\n    const originalOrGroup = this.currentOrGroup;\r\n    this.currentOrGroup = orGroup;\r\n\r\n    // Execute callback - where() calls inside will be captured in orGroup\r\n    callback(this);\r\n\r\n    // Restore original state\r\n    this.currentOrGroup = originalOrGroup;\r\n\r\n    // Add OR group to filterGroups\r\n    if (orGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"OR\",\r\n        filters: orGroup.map((f) => ({ field: f.field, operator: f.operator, value: f.value })),\r\n      });\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  and(callback: (qb: EntityQueryBuilder<JournalEntry>) => void): EntityQueryBuilder<JournalEntry> {\r\n    // Close any open OR group first\r\n    this.closeOrGroup();\r\n\r\n    // Create new AND group\r\n    const andGroup: Array<{\r\n      field: keyof JournalEntry;\r\n      operator: EntityFilter<JournalEntry>[\"operator\"];\r\n      value: unknown;\r\n    }> = [];\r\n\r\n    // Temporarily set filters to capture where() calls from callback\r\n    const originalFilters = this.query.filters;\r\n    this.query.filters = andGroup as EntityFilter<JournalEntry>[];\r\n\r\n    // Execute callback - where() calls inside will be captured in andGroup\r\n    callback(this);\r\n\r\n    // Restore original state\r\n    if (originalFilters !== undefined) {\r\n      this.query.filters = originalFilters;\r\n    } else {\r\n      delete this.query.filters;\r\n    }\r\n\r\n    // Add AND group to filterGroups\r\n    if (andGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"AND\",\r\n        filters: andGroup.map((f) => ({ field: f.field, operator: f.operator, value: f.value })),\r\n      });\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  limit(count: number): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before limit\r\n    this.query.limit = count;\r\n    return this;\r\n  }\r\n\r\n  offset(count: number): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before offset\r\n    this.query.offset = count;\r\n    return this;\r\n  }\r\n\r\n  sortBy(field: keyof JournalEntry, order: \"asc\" | \"desc\"): EntityQueryBuilder<JournalEntry> {\r\n    this.closeOrGroup(); // Close OR group before sort\r\n    this.query.sortBy = field;\r\n    this.query.sortOrder = order;\r\n    return this;\r\n  }\r\n\r\n  execute(): Result<JournalEntry[], EntityCollectionError> {\r\n    this.closeOrGroup(); // Close any open OR group before execution\r\n    return this.adapter.search(this.query);\r\n  }\r\n\r\n  /**\r\n   * Closes the current OR group and adds it to filterGroups.\r\n   * Called automatically before where(), limit(), offset(), sortBy(), execute().\r\n   */\r\n  private closeOrGroup(): void {\r\n    if (this.currentOrGroup && this.currentOrGroup.length > 0) {\r\n      if (!this.query.filterGroups) {\r\n        this.query.filterGroups = [];\r\n      }\r\n      this.query.filterGroups.push({\r\n        logic: \"OR\",\r\n        filters: this.currentOrGroup.map((f) => ({\r\n          field: f.field,\r\n          operator: f.operator,\r\n          value: f.value,\r\n        })),\r\n      });\r\n      this.currentOrGroup = null;\r\n    }\r\n  }\r\n}\r\n\r\n// DI-Wrapper\r\nexport class DIFoundryJournalCollectionAdapter extends FoundryJournalCollectionAdapter {\r\n  static dependencies = [foundryGameToken] as const; // foundryGameToken → FoundryGamePort (version-agnostisch)\r\n\r\n  constructor(foundryGame: FoundryGame) {\r\n    // FoundryGamePort wird injiziert\r\n    // Create mapper registry with default mapper\r\n    // Note: Registry should be injected via DI in the future for better testability\r\n    const mapperRegistry = new JournalMapperRegistry();\r\n    mapperRegistry.register(new DefaultJournalMapper());\r\n    super(foundryGame, mapperRegistry);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { PlatformJournalRepository } from \"@/domain/ports/repositories/platform-journal-repository.interface\";\r\nimport type {\r\n  EntityRepositoryError,\r\n  CreateEntityData,\r\n  EntityChanges,\r\n} from \"@/domain/ports/repositories/platform-entity-repository.types\";\r\nimport type { EntityCollectionError } from \"@/domain/ports/collections/entity-collection-error.interface\";\r\nimport type { EntitySearchQuery } from \"@/domain/ports/collections/entity-search-query.interface\";\r\nimport type { EntityQueryBuilder } from \"@/domain/ports/collections/entity-query-builder.interface\";\r\nimport type { JournalEntry } from \"@/domain/entities/journal-entry\";\r\nimport type { FoundryGame } from \"@/infrastructure/adapters/foundry/interfaces/FoundryGame\";\r\nimport type { FoundryDocument } from \"@/infrastructure/adapters/foundry/interfaces/FoundryDocument\";\r\nimport { FoundryJournalCollectionAdapter } from \"../collection-adapters/foundry-journal-collection-adapter\";\r\nimport { JournalMapperRegistry } from \"../mappers/journal-mapper-registry\";\r\nimport { DefaultJournalMapper } from \"../mappers/default-journal-mapper\";\r\nimport { ok, err } from \"@/domain/utils/result\";\r\nimport {\r\n  castFoundryDocumentForFlag,\r\n  castFoundryDocumentWithUpdate,\r\n  castFoundryJournalEntryClass,\r\n  castCreatedJournalEntry,\r\n} from \"@/infrastructure/adapters/foundry/runtime-casts\";\r\nimport { foundryGameToken } from \"@/infrastructure/shared/tokens/foundry/foundry-game.token\";\r\nimport { foundryDocumentToken } from \"@/infrastructure/shared/tokens/foundry/foundry-document.token\";\r\nimport * as v from \"valibot\";\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformJournalRepository.\r\n *\r\n * Uses composition to combine collection adapter with CRUD operations.\r\n * Type mapping is handled by JournalMapperRegistry (OCP-compliant).\r\n */\r\nexport class FoundryJournalRepositoryAdapter implements PlatformJournalRepository {\r\n  constructor(\r\n    private readonly collection: FoundryJournalCollectionAdapter, // Injected via composition\r\n    private readonly foundryGame: FoundryGame, // FoundryGamePort (version-agnostisch), nicht FoundryV13GamePort!\r\n    private readonly foundryDocument: FoundryDocument, // FoundryDocumentPort (version-agnostisch), nicht FoundryV13DocumentPort!\r\n    private readonly mapperRegistry: JournalMapperRegistry // Mapper registry for extensible mapping (OCP)\r\n  ) {}\r\n\r\n  // ===== Collection Methods (delegate to collection adapter) =====\r\n\r\n  getAll(): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.getAll();\r\n  }\r\n  getById(id: string): Result<JournalEntry | null, EntityCollectionError> {\r\n    return this.collection.getById(id);\r\n  }\r\n  getByIds(ids: string[]): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.getByIds(ids);\r\n  }\r\n  exists(id: string): Result<boolean, EntityCollectionError> {\r\n    return this.collection.exists(id);\r\n  }\r\n  count(): Result<number, EntityCollectionError> {\r\n    return this.collection.count();\r\n  }\r\n  search(query: EntitySearchQuery<JournalEntry>): Result<JournalEntry[], EntityCollectionError> {\r\n    return this.collection.search(query);\r\n  }\r\n  query(): EntityQueryBuilder<JournalEntry> {\r\n    return this.collection.query();\r\n  }\r\n\r\n  // ===== CREATE Operations =====\r\n\r\n  async create(\r\n    data: CreateEntityData<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    // Foundry: JournalEntry.create() - statische Methode\r\n    // Nutzt FoundryDocumentPort für create()\r\n    // JournalEntry ist eine globale Foundry-Klasse\r\n    const journalEntryClassResult = castFoundryJournalEntryClass();\r\n    if (!journalEntryClassResult.ok) {\r\n      return err({\r\n        code: \"PLATFORM_ERROR\",\r\n        message: `Foundry JournalEntry class not available: ${journalEntryClassResult.error.message}`,\r\n        details: journalEntryClassResult.error,\r\n      });\r\n    }\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    const JournalEntryClass = journalEntryClassResult.value;\r\n\r\n    try {\r\n      const createResult = await this.foundryDocument.create(JournalEntryClass, data);\r\n      if (!createResult.ok) {\r\n        return err({\r\n          code: \"OPERATION_FAILED\",\r\n          message: `Failed to create journal: ${createResult.error.message}`,\r\n          details: createResult.error,\r\n        });\r\n      }\r\n\r\n      // Map Foundry type → Domain type using mapper registry\r\n      // Use runtime-safe cast function to convert generic TDocument to FoundryJournalEntry\r\n      const foundryEntry = castCreatedJournalEntry(createResult.value);\r\n      try {\r\n        const createdEntry = this.mapperRegistry.mapToDomain(foundryEntry);\r\n        return ok(createdEntry);\r\n      } catch (error) {\r\n        return err({\r\n          code: \"OPERATION_FAILED\",\r\n          message: `Failed to map journal to domain: ${error instanceof Error ? error.message : String(error)}`,\r\n          details: error,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to create journal: ${error instanceof Error ? error.message : String(error)}`,\r\n        details: error,\r\n      });\r\n    }\r\n  }\r\n\r\n  async createMany(\r\n    data: CreateEntityData<JournalEntry>[]\r\n  ): Promise<Result<JournalEntry[], EntityRepositoryError>> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const item of data) {\r\n      const result = await this.create(item);\r\n      if (result.ok) {\r\n        results.push(result.value);\r\n      } else {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  // ===== UPDATE Operations =====\r\n\r\n  async update(\r\n    id: string,\r\n    changes: EntityChanges<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    // Get current entity\r\n    const currentResult = this.getById(id);\r\n    if (!currentResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: {\r\n          code: \"ENTITY_NOT_FOUND\",\r\n          message: `Journal ${id} not found`,\r\n          details: currentResult.error,\r\n        },\r\n      };\r\n    }\r\n\r\n    if (!currentResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found in Foundry`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Prepare update data (nur normale Properties, KEINE Flags!)\r\n    // Flags werden über setFlag()/unsetFlag() gesetzt, nicht über update()\r\n    //\r\n    // WICHTIG: Properties löschen durch \"-=\" Notation!\r\n    // Foundry VTT verwendet Differences und Merges, daher braucht man eine spezielle\r\n    // Notation, um zu signalisieren, dass ein Wert gelöscht werden soll.\r\n    // Syntax: 'propertyName.-=key': null (für nested: 'system.-=key': null)\r\n    //\r\n    // HINWEIS:\r\n    // - Normale Properties: 'propertyName.-=': null oder 'system.-=key': null\r\n    // - Flags: unsetFlag() (empfohlen) oder 'flags.scope.-=key': null\r\n    // - Arrays: Müssen als Ganzes geschrieben werden (keine Index-Modifikation möglich)\r\n    const updateData: Record<string, unknown> = {};\r\n    if (changes.name !== undefined) {\r\n      if (changes.name === null) {\r\n        // Property löschen: \"-=\" Notation verwenden\r\n        updateData[\"name.-=\"] = null;\r\n      } else {\r\n        // Property aktualisieren: normaler Wert\r\n        updateData.name = changes.name;\r\n      }\r\n    }\r\n    // Weitere Properties hier hinzufügen...\r\n    // ❌ KEINE Flags hier! Flags werden über setFlag()/unsetFlag() gesetzt\r\n    // ❌ Arrays müssen als Ganzes geschrieben werden, nicht per Index!\r\n\r\n    // Foundry: entry.update(updateData) - nur für normale Properties\r\n    // Nutzt FoundryDocumentPort für update()\r\n    const docWithUpdateResult = castFoundryDocumentWithUpdate<{ id: string; name?: string | null }>(\r\n      foundryEntry\r\n    );\r\n    if (!docWithUpdateResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support update: ${docWithUpdateResult.error.message}`,\r\n        details: docWithUpdateResult.error,\r\n      });\r\n    }\r\n    const updateResult = await this.foundryDocument.update(docWithUpdateResult.value, updateData);\r\n    if (!updateResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to update journal ${id}: ${updateResult.error.message}`,\r\n        details: updateResult.error,\r\n      });\r\n    }\r\n\r\n    // Get updated entry (mapped to domain type)\r\n    const updatedResult = this.getById(id);\r\n    if (!updatedResult.ok || !updatedResult.value) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: \"Failed to retrieve updated journal\",\r\n      });\r\n    }\r\n\r\n    return ok(updatedResult.value);\r\n  }\r\n\r\n  async updateMany(\r\n    updates: Array<{ id: string; changes: EntityChanges<JournalEntry> }>\r\n  ): Promise<Result<JournalEntry[], EntityRepositoryError>> {\r\n    const results: JournalEntry[] = [];\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const update of updates) {\r\n      const result = await this.update(update.id, update.changes);\r\n      if (result.ok) {\r\n        results.push(result.value);\r\n      } else {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(results);\r\n  }\r\n\r\n  async patch(\r\n    id: string,\r\n    partial: Partial<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    return this.update(id, partial);\r\n  }\r\n\r\n  async upsert(\r\n    id: string,\r\n    data: CreateEntityData<JournalEntry>\r\n  ): Promise<Result<JournalEntry, EntityRepositoryError>> {\r\n    const existsResult = this.exists(id);\r\n    if (!existsResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to check if journal ${id} exists`,\r\n        details: existsResult.error,\r\n      });\r\n    }\r\n\r\n    if (existsResult.value) {\r\n      // Update existing\r\n      return this.update(id, data);\r\n    } else {\r\n      // Create new - id needs to be added since CreateEntityData omits id\r\n      // For upsert, we need to provide id, so we cast to include it\r\n      // type-coverage:ignore-next-line - id is intentionally added for upsert operation\r\n      return this.create({ ...data, id } as CreateEntityData<JournalEntry>);\r\n    }\r\n  }\r\n\r\n  // ===== DELETE Operations =====\r\n\r\n  async delete(id: string): Promise<Result<void, EntityRepositoryError>> {\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    // Nutzt FoundryDocumentPort für delete()\r\n    const deleteResult = await this.foundryDocument.delete(foundryResult.value);\r\n    if (!deleteResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to delete journal ${id}: ${deleteResult.error.message}`,\r\n        details: deleteResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  async deleteMany(ids: string[]): Promise<Result<void, EntityRepositoryError>> {\r\n    const errors: EntityRepositoryError[] = [];\r\n\r\n    for (const id of ids) {\r\n      const result = await this.delete(id);\r\n      if (!result.ok) {\r\n        errors.push(result.error);\r\n      }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      // Guaranteed to exist due to length > 0 check\r\n      // type-coverage:ignore-next-line - Array with length > 0 guarantees element at index 0\r\n      const firstError = errors[0]!;\r\n      return err(firstError);\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  // ===== Flag Convenience Methods =====\r\n\r\n  getFlag(id: string, scope: string, key: string): Result<unknown | null, EntityRepositoryError> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Use FoundryDocument.getFlag() with unknown schema to accept any value\r\n    const flagResult = this.foundryDocument.getFlag(documentResult.value, scope, key, v.unknown());\r\n    if (!flagResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to get flag ${scope}.${key}: ${flagResult.error.message}`,\r\n        details: flagResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(flagResult.value);\r\n  }\r\n\r\n  async setFlag(\r\n    id: string,\r\n    scope: string,\r\n    key: string,\r\n    value: unknown\r\n  ): Promise<Result<void, EntityRepositoryError>> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Foundry: entry.setFlag(scope, key, value) - separate API für Flags!\r\n    const flagResult = await this.foundryDocument.setFlag(documentResult.value, scope, key, value);\r\n\r\n    if (!flagResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to set flag ${scope}.${key}: ${flagResult.error.message}`,\r\n        details: flagResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n\r\n  async unsetFlag(\r\n    id: string,\r\n    scope: string,\r\n    key: string\r\n  ): Promise<Result<void, EntityRepositoryError>> {\r\n    // Get Foundry entry\r\n    const foundryResult = this.foundryGame.getJournalEntryById(id);\r\n    if (!foundryResult.ok || !foundryResult.value) {\r\n      return err({\r\n        code: \"ENTITY_NOT_FOUND\",\r\n        message: `Journal ${id} not found`,\r\n      });\r\n    }\r\n\r\n    const foundryEntry = foundryResult.value;\r\n\r\n    // Cast to document with flag methods\r\n    const documentResult = castFoundryDocumentForFlag(foundryEntry);\r\n    if (!documentResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Document does not support flags: ${documentResult.error.message}`,\r\n        details: documentResult.error,\r\n      });\r\n    }\r\n\r\n    // Foundry: entry.unsetFlag(scope, key) - recommended method for flags!\r\n    // Use FoundryDocument.unsetFlag() which uses the recommended approach\r\n    const unsetResult = await this.foundryDocument.unsetFlag(documentResult.value, scope, key);\r\n\r\n    if (!unsetResult.ok) {\r\n      return err({\r\n        code: \"OPERATION_FAILED\",\r\n        message: `Failed to unset flag ${scope}.${key}: ${unsetResult.error.message}`,\r\n        details: unsetResult.error,\r\n      });\r\n    }\r\n\r\n    return ok(undefined);\r\n  }\r\n}\r\n\r\n// DI-Wrapper\r\nexport class DIFoundryJournalRepositoryAdapter extends FoundryJournalRepositoryAdapter {\r\n  static dependencies = [foundryGameToken, foundryDocumentToken] as const;\r\n\r\n  constructor(foundryGame: FoundryGame, foundryDocument: FoundryDocument) {\r\n    // Create mapper registry with default mapper\r\n    // Note: Registry should be injected via DI in the future for better testability\r\n    const mapperRegistry = new JournalMapperRegistry();\r\n    mapperRegistry.register(new DefaultJournalMapper());\r\n    // Create collection adapter via composition (not delegation)\r\n    // Pass mapper registry to collection adapter so both use the same registry\r\n    const collection = new FoundryJournalCollectionAdapter(foundryGame, mapperRegistry);\r\n    super(collection, foundryGame, foundryDocument, mapperRegistry);\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport {\r\n  platformJournalCollectionPortToken,\r\n  platformJournalRepositoryToken,\r\n} from \"@/application/tokens/domain-ports.tokens\";\r\nimport { DIFoundryJournalCollectionAdapter } from \"@/infrastructure/adapters/foundry/collection-adapters/foundry-journal-collection-adapter\";\r\nimport { DIFoundryJournalRepositoryAdapter } from \"@/infrastructure/adapters/foundry/repository-adapters/foundry-journal-repository-adapter\";\r\n\r\n/**\r\n * Registers entity collection and repository ports.\r\n *\r\n * Services registered:\r\n * - PlatformJournalCollectionPort (singleton) - Read-only access to journal collections\r\n * - PlatformJournalRepository (singleton) - Full CRUD access to journal entries\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerEntityPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register PlatformJournalCollectionPort\r\n  const collectionResult = container.registerClass(\r\n    platformJournalCollectionPortToken,\r\n    DIFoundryJournalCollectionAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(collectionResult)) {\r\n    return err(\r\n      `Failed to register PlatformJournalCollectionPort: ${collectionResult.error.message}`\r\n    );\r\n  }\r\n\r\n  // Register PlatformJournalRepository\r\n  const repositoryResult = container.registerClass(\r\n    platformJournalRepositoryToken,\r\n    DIFoundryJournalRepositoryAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(repositoryResult)) {\r\n    return err(`Failed to register PlatformJournalRepository: ${repositoryResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"EntityPorts\",\r\n  priority: 100,\r\n  execute: registerEntityPorts,\r\n});\r\n","/**\r\n * Injection token for SettingTypeMapper.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { SettingTypeMapper } from \"@/infrastructure/adapters/foundry/settings-adapters/mappers/setting-type-mapper.interface\";\r\n\r\n/**\r\n * Injection token for SettingTypeMapper.\r\n *\r\n * Provides mapping from platform-agnostic SettingType to Foundry-specific type constructors.\r\n * Enables Open/Closed Principle by allowing new mapping strategies without modifying adapters.\r\n *\r\n * @example\r\n * ```typescript\r\n * const mapper = container.resolve(settingTypeMapperToken);\r\n * const result = mapper.map(String);\r\n * ```\r\n */\r\nexport const settingTypeMapperToken = createInjectionToken<SettingTypeMapper>(\"SettingTypeMapper\");\r\n","/**\r\n * Injection token for SettingsErrorMapper.\r\n *\r\n * Uses type-only import to prevent circular dependencies while maintaining type safety.\r\n * TypeScript removes type imports at compile time, so they don't create runtime dependencies.\r\n */\r\nimport { createInjectionToken } from \"@/infrastructure/di/token-factory\";\r\nimport type { SettingsErrorMapper } from \"@/infrastructure/adapters/foundry/settings-adapters/mappers/settings-error-mapper.interface\";\r\n\r\n/**\r\n * Injection token for SettingsErrorMapper.\r\n *\r\n * Provides mapping from Foundry-specific errors to platform-agnostic SettingsError.\r\n * Enables Open/Closed Principle by allowing new error mapping strategies without modifying adapters.\r\n *\r\n * @example\r\n * ```typescript\r\n * const mapper = container.resolve(settingsErrorMapperToken);\r\n * const settingsError = mapper.map(foundryError, context);\r\n * ```\r\n */\r\nexport const settingsErrorMapperToken =\r\n  createInjectionToken<SettingsErrorMapper>(\"SettingsErrorMapper\");\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type {\r\n  PlatformSettingsPort,\r\n  PlatformSettingConfig,\r\n} from \"@/domain/ports/platform-settings-port.interface\";\r\nimport type { DomainSettingsError } from \"@/domain/types/settings\";\r\nimport type { SettingsError } from \"@/domain/types/settings-error\";\r\nimport type { ValidationSchema } from \"@/domain/types/validation-schema.interface\";\r\nimport type {\r\n  FoundrySettings,\r\n  SettingConfig,\r\n} from \"@/infrastructure/adapters/foundry/interfaces/FoundrySettings\";\r\nimport * as v from \"valibot\";\r\nimport { foundrySettingsToken } from \"@/infrastructure/shared/tokens/foundry/foundry-settings.token\";\r\nimport { settingTypeMapperToken } from \"@/infrastructure/shared/tokens/foundry/setting-type-mapper.token\";\r\nimport { settingsErrorMapperToken } from \"@/infrastructure/shared/tokens/foundry/settings-error-mapper.token\";\r\nimport type { SettingTypeMapper } from \"./mappers/setting-type-mapper.interface\";\r\nimport type { SettingsErrorMapper } from \"./mappers/settings-error-mapper.interface\";\r\n\r\n/**\r\n * Maps DomainSettingsError to SettingsError for PlatformSettingsPort compatibility.\r\n */\r\nfunction mapDomainErrorToSettingsError(error: DomainSettingsError): SettingsError {\r\n  let code: SettingsError[\"code\"];\r\n  switch (error.code) {\r\n    case \"SETTING_REGISTRATION_FAILED\":\r\n      code = \"SETTING_REGISTRATION_FAILED\";\r\n      break;\r\n    case \"SETTING_NOT_FOUND\":\r\n      code = \"SETTING_NOT_REGISTERED\";\r\n      break;\r\n    case \"INVALID_SETTING_VALUE\":\r\n      code = \"SETTING_VALIDATION_FAILED\";\r\n      break;\r\n    case \"SETTING_READ_FAILED\":\r\n    case \"SETTING_WRITE_FAILED\":\r\n      // For read/write failures, check if it's a \"not found\" scenario\r\n      if (\r\n        error.message.toLowerCase().includes(\"not found\") ||\r\n        error.message.toLowerCase().includes(\"not registered\")\r\n      ) {\r\n        code = \"SETTING_NOT_REGISTERED\";\r\n      } else {\r\n        code = \"SETTING_VALIDATION_FAILED\";\r\n      }\r\n      break;\r\n    case \"PLATFORM_NOT_AVAILABLE\":\r\n      code = \"PLATFORM_NOT_AVAILABLE\";\r\n      break;\r\n    default:\r\n      code = \"SETTING_REGISTRATION_FAILED\";\r\n  }\r\n  return {\r\n    code,\r\n    message: error.message,\r\n    details: error.details,\r\n  };\r\n}\r\n\r\n/**\r\n * Foundry-specific implementation of PlatformSettingsPort.\r\n *\r\n * Maps Foundry's game.settings API to platform-agnostic settings port.\r\n *\r\n * @example\r\n * ```typescript\r\n * const adapter = new FoundrySettingsAdapter(foundrySettings);\r\n *\r\n * adapter.register(\"my-module\", \"enabled\", {\r\n *   name: \"Enable Feature\",\r\n *   scope: \"world\",\r\n *   type: Boolean,\r\n *   default: true,\r\n * });\r\n *\r\n * const result = adapter.get(\"my-module\", \"enabled\", booleanSchema);\r\n * ```\r\n */\r\nexport class FoundrySettingsAdapter implements PlatformSettingsPort {\r\n  constructor(\r\n    private readonly foundrySettings: FoundrySettings,\r\n    private readonly typeMapper: SettingTypeMapper,\r\n    private readonly errorMapper: SettingsErrorMapper\r\n  ) {}\r\n\r\n  /**\r\n   * Register a setting in Foundry.\r\n   *\r\n   * Maps platform config → Foundry config.\r\n   */\r\n  register<T>(\r\n    namespace: string,\r\n    key: string,\r\n    config: PlatformSettingConfig<T>\r\n  ): Result<void, SettingsError> {\r\n    // Map Platform config → Foundry config\r\n    const typeResult = this.typeMapper.map(config.type);\r\n    if (!typeResult.ok) {\r\n      return {\r\n        ok: false,\r\n        error: mapDomainErrorToSettingsError(typeResult.error),\r\n      };\r\n    }\r\n\r\n    const foundryConfig: SettingConfig<T> = {\r\n      name: config.name,\r\n      ...(config.hint !== undefined && { hint: config.hint }),\r\n      scope: config.scope,\r\n      config: config.config,\r\n      type: typeResult.value,\r\n      ...(config.choices !== undefined && { choices: config.choices }),\r\n      default: config.default,\r\n      ...(config.onChange !== undefined && { onChange: config.onChange }),\r\n    };\r\n\r\n    const result = this.foundrySettings.register(namespace, key, foundryConfig);\r\n\r\n    if (!result.ok) {\r\n      const domainError = this.errorMapper.map(result.error, {\r\n        operation: \"register\",\r\n        namespace,\r\n        key,\r\n      });\r\n      return {\r\n        ok: false,\r\n        error: mapDomainErrorToSettingsError(domainError),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n\r\n  /**\r\n   * Get setting value from Foundry with validation.\r\n   *\r\n   * Uses a permissive valibot schema (v.unknown()) to retrieve the raw value,\r\n   * then validates it using the provided ValidationSchema. This allows any\r\n   * ValidationSchema implementation to be used, not just ValibotValidationSchema.\r\n   */\r\n  get<T>(namespace: string, key: string, schema: ValidationSchema<T>): Result<T, SettingsError> {\r\n    // Get raw value using permissive schema (allows any value)\r\n    const rawResult = this.foundrySettings.get(namespace, key, v.unknown());\r\n\r\n    if (!rawResult.ok) {\r\n      const domainError = this.errorMapper.map(rawResult.error, {\r\n        operation: \"get\",\r\n        namespace,\r\n        key,\r\n      });\r\n      return {\r\n        ok: false,\r\n        error: mapDomainErrorToSettingsError(domainError),\r\n      };\r\n    }\r\n\r\n    // Validate using the provided schema (schema-agnostic)\r\n    const validationResult = schema.validate(rawResult.value);\r\n    if (!validationResult.ok) {\r\n      // ValidationSchema.validate returns Result<T, SettingsError>, so we can return it directly\r\n      return validationResult;\r\n    }\r\n    return validationResult;\r\n  }\r\n\r\n  /**\r\n   * Set setting value in Foundry.\r\n   *\r\n   * Persists to Foundry's database and triggers onChange.\r\n   */\r\n  async set<T>(namespace: string, key: string, value: T): Promise<Result<void, SettingsError>> {\r\n    const result = await this.foundrySettings.set(namespace, key, value);\r\n\r\n    if (!result.ok) {\r\n      const domainError = this.errorMapper.map(result.error, {\r\n        operation: \"set\",\r\n        namespace,\r\n        key,\r\n      });\r\n      return {\r\n        ok: false,\r\n        error: mapDomainErrorToSettingsError(domainError),\r\n      };\r\n    }\r\n\r\n    return { ok: true, value: undefined };\r\n  }\r\n}\r\n\r\n/**\r\n * DI-enabled wrapper for FoundrySettingsAdapter.\r\n */\r\nexport class DIFoundrySettingsAdapter extends FoundrySettingsAdapter {\r\n  static dependencies = [\r\n    foundrySettingsToken,\r\n    settingTypeMapperToken,\r\n    settingsErrorMapperToken,\r\n  ] as const;\r\n\r\n  constructor(\r\n    foundrySettings: FoundrySettings,\r\n    typeMapper: SettingTypeMapper,\r\n    errorMapper: SettingsErrorMapper\r\n  ) {\r\n    super(foundrySettings, typeMapper, errorMapper);\r\n  }\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { SettingType } from \"@/domain/ports/platform-settings-port.interface\";\r\nimport type { DomainSettingsError } from \"@/domain/types/settings\";\r\nimport type { SettingTypeMapper } from \"./setting-type-mapper.interface\";\r\n\r\n/**\r\n * Default implementation of SettingTypeMapper for Foundry VTT.\r\n *\r\n * Maps platform-agnostic setting types to Foundry's type constructors.\r\n * Supports both constructor types (typeof String) and string types (\"String\").\r\n *\r\n * DESIGN: This is a separate class to follow Open/Closed Principle.\r\n * New setting types can be added by creating a new mapper implementation\r\n * or extending this one, without modifying FoundrySettingsAdapter.\r\n */\r\nexport class FoundrySettingTypeMapper implements SettingTypeMapper {\r\n  /**\r\n   * Maps a platform-agnostic SettingType to Foundry-specific type constructor.\r\n   *\r\n   * @param type - The setting type to map\r\n   * @returns Result containing the Foundry type constructor or a SettingsError\r\n   */\r\n  map(\r\n    type: SettingType\r\n  ): Result<typeof String | typeof Number | typeof Boolean, DomainSettingsError> {\r\n    if (type === \"String\" || type === String) {\r\n      return { ok: true, value: String };\r\n    }\r\n    if (type === \"Number\" || type === Number) {\r\n      return { ok: true, value: Number };\r\n    }\r\n    if (type === \"Boolean\" || type === Boolean) {\r\n      return { ok: true, value: Boolean };\r\n    }\r\n    return {\r\n      ok: false,\r\n      error: {\r\n        code: \"SETTING_REGISTRATION_FAILED\",\r\n        message: `Unknown setting type: ${type}. Supported types are: String, Number, Boolean`,\r\n        details: { type },\r\n      },\r\n    };\r\n  }\r\n}\r\n","import type { FoundryError } from \"@/infrastructure/adapters/foundry/errors/FoundryErrors\";\r\nimport type { DomainSettingsError } from \"@/domain/types/settings\";\r\nimport type { SettingsErrorMapper, ErrorMappingContext } from \"./settings-error-mapper.interface\";\r\n\r\n/**\r\n * Default implementation of SettingsErrorMapper for Foundry VTT.\r\n *\r\n * Maps Foundry-specific error codes to platform-agnostic SettingsError codes.\r\n *\r\n * DESIGN: This is a separate class to follow Open/Closed Principle.\r\n * New Foundry error codes can be handled by creating a new mapper implementation\r\n * or extending this one, without modifying FoundrySettingsAdapter.\r\n */\r\nexport class FoundrySettingsErrorMapper implements SettingsErrorMapper {\r\n  /**\r\n   * Maps a FoundryError to a platform-agnostic SettingsError.\r\n   *\r\n   * @param foundryError - The Foundry-specific error to map\r\n   * @param context - Context information about the operation and setting\r\n   * @returns Platform-agnostic SettingsError\r\n   */\r\n  map(foundryError: FoundryError, context: ErrorMappingContext): DomainSettingsError {\r\n    // Map Foundry error codes to DomainSettingsError codes\r\n    let code: DomainSettingsError[\"code\"];\r\n    switch (foundryError.code) {\r\n      case \"API_NOT_AVAILABLE\":\r\n        code = \"PLATFORM_NOT_AVAILABLE\";\r\n        break;\r\n      case \"VALIDATION_FAILED\":\r\n        code = \"INVALID_SETTING_VALUE\";\r\n        break;\r\n      case \"OPERATION_FAILED\":\r\n        // Check if it's a registration failure\r\n        if (context.operation === \"register\") {\r\n          code = \"SETTING_REGISTRATION_FAILED\";\r\n        } else {\r\n          // For get/set operations, check the error message\r\n          const message = foundryError.message.toLowerCase();\r\n          if (message.includes(\"not registered\") || message.includes(\"not found\")) {\r\n            code = \"SETTING_NOT_FOUND\";\r\n          } else if (context.operation === \"get\") {\r\n            code = \"SETTING_READ_FAILED\";\r\n          } else {\r\n            code = \"SETTING_WRITE_FAILED\";\r\n          }\r\n        }\r\n        break;\r\n      default:\r\n        // Default based on operation type\r\n        if (context.operation === \"register\") {\r\n          code = \"SETTING_REGISTRATION_FAILED\";\r\n        } else if (context.operation === \"get\") {\r\n          code = \"SETTING_READ_FAILED\";\r\n        } else {\r\n          code = \"SETTING_WRITE_FAILED\";\r\n        }\r\n    }\r\n\r\n    return {\r\n      code,\r\n      message: `Failed to ${context.operation} setting \"${context.namespace}.${context.key}\": ${foundryError.message}`,\r\n      details: foundryError,\r\n    };\r\n  }\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { platformSettingsPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { DIFoundrySettingsAdapter } from \"@/infrastructure/adapters/foundry/settings-adapters/foundry-settings-adapter\";\r\nimport { FoundrySettingTypeMapper } from \"@/infrastructure/adapters/foundry/settings-adapters/mappers/foundry-setting-type-mapper\";\r\nimport { FoundrySettingsErrorMapper } from \"@/infrastructure/adapters/foundry/settings-adapters/mappers/foundry-settings-error-mapper\";\r\nimport { settingTypeMapperToken } from \"@/infrastructure/shared/tokens/foundry/setting-type-mapper.token\";\r\nimport { settingsErrorMapperToken } from \"@/infrastructure/shared/tokens/foundry/settings-error-mapper.token\";\r\n\r\n/**\r\n * Registers settings port services.\r\n *\r\n * Services registered:\r\n * - SettingTypeMapper (singleton) - Maps platform-agnostic setting types to Foundry types\r\n * - SettingsErrorMapper (singleton) - Maps Foundry errors to platform-agnostic errors\r\n * - PlatformSettingsPort (singleton) - Platform-agnostic settings handling\r\n *\r\n * DESIGN: Settings ports are platform-agnostic abstractions over settings systems.\r\n * They enable multi-VTT support by decoupling from Foundry-specific APIs.\r\n * Mappers follow Open/Closed Principle, allowing extensions without modifying adapters.\r\n *\r\n * @param container - The service container to register services in\r\n * @returns Result indicating success or error with details\r\n */\r\nexport function registerSettingsPorts(container: ServiceContainer): Result<void, string> {\r\n  // Register SettingTypeMapper (Foundry implementation)\r\n  const typeMapperResult = container.registerClass(\r\n    settingTypeMapperToken,\r\n    FoundrySettingTypeMapper,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(typeMapperResult)) {\r\n    return err(`Failed to register SettingTypeMapper: ${typeMapperResult.error.message}`);\r\n  }\r\n\r\n  // Register SettingsErrorMapper (Foundry implementation)\r\n  const errorMapperResult = container.registerClass(\r\n    settingsErrorMapperToken,\r\n    FoundrySettingsErrorMapper,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(errorMapperResult)) {\r\n    return err(`Failed to register SettingsErrorMapper: ${errorMapperResult.error.message}`);\r\n  }\r\n\r\n  // Register PlatformSettingsPort (Foundry implementation)\r\n  // Dependencies: foundrySettingsToken, settingTypeMapperToken, settingsErrorMapperToken\r\n  const settingsPortResult = container.registerClass(\r\n    platformSettingsPortToken,\r\n    DIFoundrySettingsAdapter,\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(settingsPortResult)) {\r\n    return err(`Failed to register PlatformSettingsPort: ${settingsPortResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"SettingsPorts\",\r\n  priority: 90,\r\n  execute: registerSettingsPorts,\r\n});\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport { assertCacheKey, type CacheKey } from \"@/infrastructure/di/types/utilities/type-casts\";\r\nimport type { ICacheConfigManager } from \"./config/cache-config-manager.interface\";\r\nimport type { ICacheStore } from \"./store/cache-store.interface\";\r\nimport type { CachePolicy } from \"./policy/cache-policy.interface\";\r\n\r\n/**\r\n * CacheKey Brand-Type - re-exportiert von type-casts für Konsistenz.\r\n *\r\n * Inline-Definition in type-casts.ts verhindert zirkuläre Dependency!\r\n * Diese Datei importiert und re-exportiert, damit bestehender Code weiterhin funktioniert.\r\n */\r\nexport type { CacheKey } from \"@/infrastructure/di/types/utilities/type-casts\";\r\n\r\nconst KEY_SEPARATOR = \":\";\r\n\r\n/**\r\n * Parts required to build a cache key.\r\n */\r\nexport interface CacheKeyParts {\r\n  /** Logical namespace, e.g. \"journal\" */\r\n  namespace: string;\r\n  /** Resource or operation name, e.g. \"hidden\" */\r\n  resource: string;\r\n  /** Optional identifier or scope information */\r\n  identifier?: string | number | null;\r\n}\r\n\r\n/**\r\n * Options to configure cache entries at set-time.\r\n */\r\nexport interface CacheSetOptions {\r\n  /** Explicit TTL in milliseconds. Falls back to service default when omitted. */\r\n  ttlMs?: number;\r\n  /** Arbitrary tags that can be used for bulk invalidation. */\r\n  tags?: readonly string[];\r\n}\r\n\r\n/**\r\n * Snapshot of metadata tracked for a cache entry.\r\n */\r\nexport interface CacheEntryMetadata {\r\n  key: CacheKey;\r\n  createdAt: number;\r\n  expiresAt: number | null;\r\n  lastAccessedAt: number;\r\n  hits: number;\r\n  tags: readonly string[];\r\n}\r\n\r\n/**\r\n * Result returned from cache lookups.\r\n */\r\nexport interface CacheLookupResult<T> {\r\n  hit: boolean;\r\n  value?: T;\r\n  metadata: CacheEntryMetadata;\r\n}\r\n\r\n/**\r\n * Aggregate statistics for the entire cache.\r\n */\r\nexport interface CacheStatistics {\r\n  hits: number;\r\n  misses: number;\r\n  evictions: number;\r\n  size: number;\r\n  enabled: boolean;\r\n}\r\n\r\n/**\r\n * Predicate used for targeted cache invalidation.\r\n */\r\nexport type CacheInvalidationPredicate = (entry: CacheEntryMetadata) => boolean;\r\n\r\n/**\r\n * Maintenance port for cache internal components.\r\n * Used by infrastructure components that need access to cache internals\r\n * (e.g., CacheConfigSync for configuration synchronization).\r\n *\r\n * Follows Interface Segregation Principle (ISP) by separating maintenance\r\n * operations from normal cache operations.\r\n */\r\nexport interface CacheMaintenancePort {\r\n  getConfigManager(): ICacheConfigManager;\r\n  getStore(): ICacheStore;\r\n  getPolicy(): CachePolicy;\r\n}\r\n\r\n/**\r\n * CacheService contract exposed through DI.\r\n * Configuration updates are handled separately via CacheConfigSyncObserver.\r\n */\r\nexport interface CacheService extends CacheMaintenancePort {\r\n  readonly isEnabled: boolean;\r\n  readonly size: number;\r\n  get<TValue>(key: CacheKey): CacheLookupResult<TValue> | null;\r\n  set<TValue>(key: CacheKey, value: TValue, options?: CacheSetOptions): CacheEntryMetadata;\r\n  delete(key: CacheKey): boolean;\r\n  has(key: CacheKey): boolean;\r\n  clear(): number;\r\n  invalidateWhere(predicate: CacheInvalidationPredicate): number;\r\n  getMetadata(key: CacheKey): CacheEntryMetadata | null;\r\n  getStatistics(): CacheStatistics;\r\n  getOrSet<TValue>(\r\n    key: CacheKey,\r\n    factory: () => TValue | Promise<TValue>,\r\n    options?: CacheSetOptions\r\n  ): Promise<Result<CacheLookupResult<TValue>, string>>;\r\n}\r\n\r\n// Re-export CacheServiceConfig for backward compatibility\r\nexport type { CacheServiceConfig } from \"./cache-config.interface\";\r\n\r\n/**\r\n * Normalizes individual key segments.\r\n */\r\nfunction normalizeSegment(segment: string): string {\r\n  return segment\r\n    .trim()\r\n    .replace(/\\s+/g, \"-\")\r\n    .replace(/[^a-zA-Z0-9-_]/g, \"\")\r\n    .toLowerCase();\r\n}\r\n\r\n/**\r\n * Creates a module-scoped cache key.\r\n *\r\n * @param parts - Cache key parts (namespace, resource, identifier)\r\n * @param moduleId - Module ID for scoping (injected via DI to avoid Infrastructure → Application dependency)\r\n * @returns Branded CacheKey\r\n */\r\nexport function createCacheKey(parts: CacheKeyParts, moduleId: string): CacheKey {\r\n  const { namespace, resource, identifier } = parts;\r\n  const payload = [moduleId, namespace, resource];\r\n  if (identifier !== null && identifier !== undefined) {\r\n    payload.push(String(identifier));\r\n  }\r\n  return assertCacheKey(payload.map(normalizeSegment).join(KEY_SEPARATOR));\r\n}\r\n\r\n/**\r\n * Helper to build cache key factories for a namespace.\r\n *\r\n * @param namespace - Cache namespace\r\n * @param moduleId - Module ID for scoping (injected via DI to avoid Infrastructure → Application dependency)\r\n * @returns Factory function that creates cache keys for the namespace\r\n */\r\nexport function createCacheNamespace(namespace: string, moduleId: string) {\r\n  const normalizedNamespace = normalizeSegment(namespace);\r\n  return (resource: string, identifier?: string | number | null): CacheKey =>\r\n    identifier === undefined\r\n      ? createCacheKey({ namespace: normalizedNamespace, resource }, moduleId)\r\n      : createCacheKey({ namespace: normalizedNamespace, resource, identifier }, moduleId);\r\n}\r\n","import type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport type { JournalVisibilityConfig } from \"@/application/services/JournalVisibilityConfig\";\r\nimport { journalVisibilityConfigToken } from \"@/application/tokens/application.tokens\";\r\nimport { createCacheNamespace } from \"@/infrastructure/cache/cache.interface\";\r\nimport { MODULE_METADATA, APP_DEFAULTS } from \"@/application/constants/app-constants\";\r\nimport { DOMAIN_FLAGS } from \"@/domain/constants/domain-constants\";\r\nimport type { DomainCacheKey } from \"@/domain/types/cache/cache-types\";\r\n\r\n/**\r\n * Registers JournalVisibilityConfig for JournalVisibilityService.\r\n *\r\n * Encapsulates infrastructure details (module IDs, flag keys, cache key factory)\r\n * into a config object that is injected into the Application layer service.\r\n *\r\n * @param container - Root service container used during bootstrap\r\n * @returns Result with `void` on success or error message if registration fails\r\n */\r\nexport function registerJournalVisibilityConfig(container: ServiceContainer): Result<void, string> {\r\n  // Create cache key factory using Infrastructure utilities\r\n  const buildCacheKey = createCacheNamespace(\"journal-visibility\", MODULE_METADATA.ID);\r\n  const cacheKeyFactory = (resource: string): DomainCacheKey => {\r\n    // Convert Infrastructure CacheKey (branded) to DomainCacheKey (string)\r\n    return buildCacheKey(resource) as DomainCacheKey;\r\n  };\r\n\r\n  const config: JournalVisibilityConfig = {\r\n    moduleNamespace: MODULE_METADATA.ID,\r\n    hiddenFlagKey: DOMAIN_FLAGS.HIDDEN,\r\n    unknownName: APP_DEFAULTS.UNKNOWN_NAME,\r\n    cacheKeyFactory,\r\n  };\r\n\r\n  const configResult = container.registerValue(journalVisibilityConfigToken, config);\r\n  if (isErr(configResult)) {\r\n    return err(`Failed to register JournalVisibilityConfig: ${configResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n// Self-register this module's dependency registration step\r\nimport { registerDependencyStep } from \"@/framework/config/dependency-registry\";\r\nregisterDependencyStep({\r\n  name: \"JournalVisibilityConfig\",\r\n  priority: 110,\r\n  execute: registerJournalVisibilityConfig,\r\n});\r\n","import { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { ok, err, isErr } from \"@/domain/utils/result\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport { metricsCollectorToken } from \"@/infrastructure/shared/tokens/observability/metrics-collector.token\";\r\nimport { environmentConfigToken } from \"@/infrastructure/shared/tokens/core/environment-config.token\";\r\nimport { containerHealthCheckToken } from \"@/infrastructure/shared/tokens/core/container-health-check.token\";\r\nimport { metricsHealthCheckToken } from \"@/infrastructure/shared/tokens/core/metrics-health-check.token\";\r\nimport { healthCheckRegistryToken } from \"@/application/tokens/health-check-registry.token\";\r\nimport { serviceContainerToken } from \"@/infrastructure/shared/tokens/core/service-container.token\";\r\nimport { runtimeConfigToken } from \"@/application/tokens/runtime-config.token\";\r\nimport { platformContainerPortToken } from \"@/application/tokens/domain-ports.tokens\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { createRuntimeConfigAdapter } from \"@/infrastructure/config/runtime-config-adapter\";\r\nimport { getDIContainerHealthCheckClass } from \"@/application/health/ContainerHealthCheck\";\r\nimport { getDIMetricsHealthCheckClass } from \"@/application/health/MetricsHealthCheck\";\r\nimport { ServiceLifecycle } from \"@/infrastructure/di/types/core/servicelifecycle\";\r\nimport { castContainerTokenToPlatformContainerPortToken } from \"@/infrastructure/di/types/utilities/runtime-safe-cast\";\r\nimport { moduleIdToken } from \"@/infrastructure/shared/tokens/infrastructure/module-id.token\";\r\nimport { MODULE_METADATA } from \"@/application/constants/app-constants\";\r\nimport {\r\n  DependencyRegistrationRegistry,\r\n  dependencyRegistry,\r\n} from \"@/framework/config/dependency-registry\";\r\nimport { registerPortRegistries } from \"@/framework/config/modules/port-infrastructure.config\";\r\nimport { initializeCacheConfigSync } from \"@/framework/config/modules/cache-services.config\";\r\n\r\n// Import dependency modules manifest to trigger their self-registration\r\n// This follows the Open/Closed Principle: new modules are added to the manifest,\r\n// not to this file. See dependency-modules.ts for the module list.\r\nimport \"@/framework/config/dependency-modules\";\r\n\r\n// Track whether internal steps have been registered to avoid duplicate registrations\r\nlet internalStepsRegistered = false;\r\n\r\n/**\r\n * Creates and initializes the dependency registration registry.\r\n *\r\n * This function registers internal/core dependency registration steps that are\r\n * part of the framework itself. Module-specific steps are registered via\r\n * the global dependencyRegistry by importing their config modules.\r\n *\r\n * REGISTRATION ORDER (via priorities):\r\n * - Internal/Framework Steps:\r\n *   1. Static Values (10) - EnvironmentConfig, RuntimeConfig, ServiceContainer\r\n *   2. Subcontainer Values (70) - Foundry Port Registries\r\n *   3. Loop Prevention Services (160) - Health checks\r\n *   4. Validation (170) - Container validation\r\n *   5. Loop Prevention Init (180) - Initialize health checks\r\n *   6. Cache Config Sync Init (190) - Initialize cache synchronization\r\n *\r\n * - Module Steps (registered via module config imports):\r\n *   See individual module config files for their priorities.\r\n *\r\n * NOTE: Internal steps are only registered once, even if this function is called multiple times.\r\n * This allows the function to be called multiple times (e.g., in tests) without duplicate registrations.\r\n */\r\nfunction createDependencyRegistrationRegistry(): DependencyRegistrationRegistry {\r\n  // Register internal/framework steps only once\r\n  if (!internalStepsRegistered) {\r\n    dependencyRegistry.register({\r\n      name: \"StaticValues\",\r\n      priority: 10,\r\n      execute: registerStaticValues,\r\n    });\r\n    dependencyRegistry.register({\r\n      name: \"SubcontainerValues\",\r\n      priority: 70,\r\n      execute: registerSubcontainerValues,\r\n    });\r\n    dependencyRegistry.register({\r\n      name: \"LoopPreventionServices\",\r\n      priority: 160,\r\n      execute: registerLoopPreventionServices,\r\n    });\r\n    dependencyRegistry.register({ name: \"Validation\", priority: 170, execute: validateContainer });\r\n    dependencyRegistry.register({\r\n      name: \"LoopPreventionInit\",\r\n      priority: 180,\r\n      execute: initializeLoopPreventionValues,\r\n    });\r\n    dependencyRegistry.register({\r\n      name: \"CacheConfigSyncInit\",\r\n      priority: 190,\r\n      execute: initializeCacheConfigSync,\r\n    });\r\n    internalStepsRegistered = true;\r\n  }\r\n\r\n  return dependencyRegistry;\r\n}\r\n\r\n/**\r\n * Resets the dependency registration registry.\r\n * This is primarily useful for testing scenarios where a clean state is needed.\r\n *\r\n * @internal\r\n */\r\nexport function resetDependencyRegistry(): void {\r\n  dependencyRegistry.reset();\r\n  internalStepsRegistered = false;\r\n}\r\n\r\n/**\r\n * Registers EnvironmentConfig as a static bootstrap value.\r\n */\r\nfunction registerEnvironmentConfig(container: ServiceContainer): Result<void, string> {\r\n  const envResult = container.registerValue(environmentConfigToken, ENV);\r\n  if (isErr(envResult)) {\r\n    return err(`Failed to register EnvironmentConfig: ${envResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers RuntimeConfigAdapter as a static bootstrap value.\r\n */\r\nfunction registerRuntimeConfig(container: ServiceContainer): Result<void, string> {\r\n  const runtimeConfigAdapter = createRuntimeConfigAdapter(ENV);\r\n  const runtimeConfigResult = container.registerValue(runtimeConfigToken, runtimeConfigAdapter);\r\n  if (isErr(runtimeConfigResult)) {\r\n    return err(`Failed to register RuntimeConfigAdapter: ${runtimeConfigResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers ServiceContainer as a static bootstrap value (self-reference).\r\n */\r\nfunction registerServiceContainer(container: ServiceContainer): Result<void, string> {\r\n  const containerResult = container.registerValue(serviceContainerToken, container);\r\n  if (isErr(containerResult)) {\r\n    return err(`Failed to register ServiceContainer: ${containerResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers PlatformContainerPort as an alias to ServiceContainer.\r\n *\r\n * ServiceContainer implements PlatformContainerPort, so this provides the abstraction\r\n * for Framework layer without duplicating the instance.\r\n * Note: Type assertion is required because PlatformContainerPort and Container are different types,\r\n * even though ServiceContainer implements both. This is a known limitation of the type system\r\n * when dealing with interface aliases. The runtime behavior is correct.\r\n * The cast function is in runtime-safe-cast.ts which is excluded from type coverage,\r\n * so we use a direct assertion here.\r\n */\r\nfunction registerPlatformContainerPortAlias(container: ServiceContainer): Result<void, string> {\r\n  const aliasResult = container.registerAlias(\r\n    platformContainerPortToken,\r\n    castContainerTokenToPlatformContainerPortToken(serviceContainerToken)\r\n  );\r\n  if (isErr(aliasResult)) {\r\n    return err(`Failed to register PlatformContainerPort alias: ${aliasResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers ModuleId as a static bootstrap value.\r\n *\r\n * This allows Infrastructure services to access module ID without importing from Application layer.\r\n */\r\nfunction registerModuleId(container: ServiceContainer): Result<void, string> {\r\n  const moduleIdResult = container.registerValue(moduleIdToken, MODULE_METADATA.ID);\r\n  if (isErr(moduleIdResult)) {\r\n    return err(`Failed to register ModuleId: ${moduleIdResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers static bootstrap values that already exist outside the container.\r\n *\r\n * This function orchestrates the registration of all static values by calling\r\n * individual registration functions. Each registration function has a single\r\n * responsibility (SRP), improving testability and maintainability.\r\n */\r\nfunction registerStaticValues(container: ServiceContainer): Result<void, string> {\r\n  const results = [\r\n    registerEnvironmentConfig(container),\r\n    registerRuntimeConfig(container),\r\n    registerServiceContainer(container),\r\n    registerPlatformContainerPortAlias(container),\r\n    registerModuleId(container),\r\n  ];\r\n\r\n  for (const result of results) {\r\n    if (isErr(result)) return result;\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Registers sub-container style values (e.g., Foundry Port registries).\r\n */\r\nfunction registerSubcontainerValues(container: ServiceContainer): Result<void, string> {\r\n  return registerPortRegistries(container);\r\n}\r\n\r\n/**\r\n * Registers loop-prevention health checks with DI metadata.\r\n */\r\nfunction registerLoopPreventionServices(container: ServiceContainer): Result<void, string> {\r\n  const containerCheckResult = container.registerClass(\r\n    containerHealthCheckToken,\r\n    getDIContainerHealthCheckClass(),\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(containerCheckResult)) {\r\n    return err(`Failed to register ContainerHealthCheck: ${containerCheckResult.error.message}`);\r\n  }\r\n\r\n  const metricsCheckResult = container.registerClass(\r\n    metricsHealthCheckToken,\r\n    getDIMetricsHealthCheckClass(),\r\n    ServiceLifecycle.SINGLETON\r\n  );\r\n  if (isErr(metricsCheckResult)) {\r\n    return err(`Failed to register MetricsHealthCheck: ${metricsCheckResult.error.message}`);\r\n  }\r\n\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Instantiates loop-prevention services (health checks) after validation.\r\n */\r\nfunction initializeLoopPreventionValues(container: ServiceContainer): Result<void, string> {\r\n  const registryRes = container.resolveWithError(healthCheckRegistryToken);\r\n  const metricsRes = container.resolveWithError(metricsCollectorToken);\r\n  if (!registryRes.ok) {\r\n    return err(`Failed to resolve HealthCheckRegistry: ${registryRes.error.message}`);\r\n  }\r\n  if (!metricsRes.ok) {\r\n    return err(`Failed to resolve MetricsCollector: ${metricsRes.error.message}`);\r\n  }\r\n\r\n  const containerCheckResult = container.resolveWithError(containerHealthCheckToken);\r\n  if (!containerCheckResult.ok) {\r\n    return err(`Failed to resolve ContainerHealthCheck: ${containerCheckResult.error.message}`);\r\n  }\r\n\r\n  const metricsCheckResult = container.resolveWithError(metricsHealthCheckToken);\r\n  if (!metricsCheckResult.ok) {\r\n    return err(`Failed to resolve MetricsHealthCheck: ${metricsCheckResult.error.message}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Validates the container configuration.\r\n * Ensures all dependencies are resolvable and no circular dependencies exist.\r\n */\r\nfunction validateContainer(container: ServiceContainer): Result<void, string> {\r\n  const validateResult = container.validate();\r\n  if (isErr(validateResult)) {\r\n    const errorMessages = validateResult.error.map((e) => e.message).join(\", \");\r\n    return err(`Validation failed: ${errorMessages}`);\r\n  }\r\n  return ok(undefined);\r\n}\r\n\r\n/**\r\n * Configures all dependency injection mappings for the application.\r\n *\r\n * RESPONSIBILITY: Orchestrate registration of all service modules.\r\n *\r\n * DESIGN PRINCIPLES:\r\n * - Services are self-configuring via constructor dependencies\r\n * - Observability uses self-registration pattern\r\n * - No manual wiring - all connections via DI\r\n * - Modular config files by domain\r\n * - Uses Registry Pattern for extensibility (Open/Closed Principle)\r\n *\r\n * REGISTRATION ORDER:\r\n * See createDependencyRegistrationRegistry() for the complete ordered list.\r\n * The registry manages the execution order via priority values.\r\n *\r\n * @param container - The service container to configure\r\n * @returns Result indicating success or configuration errors\r\n *\r\n * @example\r\n * ```typescript\r\n * const container = ServiceContainer.createRoot();\r\n * const result = configureDependencies(container);\r\n * if (isOk(result)) {\r\n *   const logger = container.resolve(loggerToken);\r\n * }\r\n * ```\r\n */\r\nexport function configureDependencies(container: ServiceContainer): Result<void, string> {\r\n  const registry = createDependencyRegistrationRegistry();\r\n  return registry.configure(container);\r\n}\r\n","import type { Result } from \"@/domain/types/result\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { configureDependencies } from \"@/framework/config/dependencyconfig\";\r\n\r\n/**\r\n * Interface for dependency configurator.\r\n * Responsible for configuring dependencies in a ServiceContainer.\r\n */\r\nexport interface IDependencyConfigurator {\r\n  /**\r\n   * Configures all dependencies in the given container.\r\n   *\r\n   * @param container - The service container to configure\r\n   * @returns Result indicating success or configuration errors\r\n   */\r\n  configure(container: ServiceContainer): Result<void, string>;\r\n}\r\n\r\n/**\r\n * Configurator for setting up dependency injection mappings.\r\n *\r\n * **Responsibility:** Only dependency configuration.\r\n * Delegates to configureDependencies() for actual implementation.\r\n *\r\n * @example\r\n * ```typescript\r\n * const configurator = new DependencyConfigurator();\r\n * const result = configurator.configure(container);\r\n * if (!result.ok) {\r\n *   console.error(result.error);\r\n * }\r\n * ```\r\n */\r\nexport class DependencyConfigurator implements IDependencyConfigurator {\r\n  /**\r\n   * Configures all dependencies in the given container.\r\n   *\r\n   * @param container - The service container to configure\r\n   * @returns Result indicating success or configuration errors\r\n   */\r\n  configure(container: ServiceContainer): Result<void, string> {\r\n    return configureDependencies(container);\r\n  }\r\n}\r\n","import { LOG_PREFIX } from \"@/application/constants/app-constants\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { ENV } from \"@/framework/config/environment\";\r\nimport { BootstrapPerformanceTracker } from \"@/infrastructure/observability/bootstrap-performance-tracker\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { BootstrapErrorHandler } from \"@/framework/core/bootstrap-error-handler\";\r\nimport { RuntimeConfigAdapter } from \"@/infrastructure/config/runtime-config-adapter\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { IContainerFactory } from \"@/framework/core/factory/container-factory\";\r\nimport { ContainerFactory } from \"@/framework/core/factory/container-factory\";\r\nimport type { IDependencyConfigurator } from \"@/framework/core/config/dependency-configurator\";\r\nimport { DependencyConfigurator } from \"@/framework/core/config/dependency-configurator\";\r\n\r\n/**\r\n * CompositionRoot\r\n *\r\n * **Responsibility:** Only coordination (Facade pattern).\r\n * Delegates all actual work to specialized components:\r\n * - ContainerFactory: Container creation\r\n * - DependencyConfigurator: Dependency configuration\r\n * - BootstrapPerformanceTracker: Performance tracking\r\n * - BootstrapErrorHandler: Error handling\r\n *\r\n * **Design:**\r\n * This class acts as a pure facade that coordinates the bootstrap process.\r\n * All responsibilities are delegated to specialized components following SRP.\r\n *\r\n * NOT responsible for:\r\n * - API exposition (handled by ModuleApiInitializer)\r\n * - Event listener registration (handled by ModuleEventRegistrar)\r\n * - Settings registration (handled by ModuleSettingsRegistrar)\r\n */\r\nexport class CompositionRoot {\r\n  private container: ServiceContainer | null = null;\r\n  private readonly containerFactory: IContainerFactory;\r\n  private readonly dependencyConfigurator: IDependencyConfigurator;\r\n  private readonly performanceTracker: BootstrapPerformanceTracker;\r\n  private readonly errorHandler: typeof BootstrapErrorHandler;\r\n\r\n  /**\r\n   * Creates a new CompositionRoot instance.\r\n   *\r\n   * @param containerFactory - Factory for creating containers (defaults to ContainerFactory)\r\n   * @param dependencyConfigurator - Configurator for setting up dependencies (defaults to DependencyConfigurator)\r\n   * @param performanceTracker - Optional performance tracker (created internally if not provided)\r\n   * @param errorHandler - Optional error handler (defaults to BootstrapErrorHandler)\r\n   */\r\n  constructor(\r\n    containerFactory?: IContainerFactory,\r\n    dependencyConfigurator?: IDependencyConfigurator,\r\n    performanceTracker?: BootstrapPerformanceTracker,\r\n    errorHandler?: typeof BootstrapErrorHandler\r\n  ) {\r\n    this.containerFactory = containerFactory ?? new ContainerFactory();\r\n    this.dependencyConfigurator = dependencyConfigurator ?? new DependencyConfigurator();\r\n    this.performanceTracker =\r\n      performanceTracker ?? new BootstrapPerformanceTracker(new RuntimeConfigAdapter(ENV), null);\r\n    this.errorHandler = errorHandler ?? BootstrapErrorHandler;\r\n  }\r\n\r\n  /**\r\n   * Attempts to log bootstrap completion message.\r\n   * Extracted to separate method for better testability.\r\n   *\r\n   * @param container - The service container to resolve logger from\r\n   * @param duration - The bootstrap duration in milliseconds\r\n   * @internal For testing purposes - public to allow direct testing\r\n   */\r\n  tryLogBootstrapCompletion(container: ServiceContainer, duration: number): void {\r\n    // Use logger from container if available (container is validated at this point)\r\n    const loggerResult = container.resolveWithError(loggerToken);\r\n    if (loggerResult.ok) {\r\n      const logger = castResolvedService<Logger>(loggerResult.value);\r\n      logger.debug(`Bootstrap completed in ${duration.toFixed(2)}ms`);\r\n    } else {\r\n      // Logger not available - silently continue (graceful degradation)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Erstellt den ServiceContainer und führt Basis-Registrierungen aus.\r\n   * Misst Performance für Diagnose-Zwecke.\r\n   *\r\n   * **Coordination Flow:**\r\n   * 1. ContainerFactory creates container\r\n   * 2. BootstrapPerformanceTracker tracks performance\r\n   * 3. DependencyConfigurator configures dependencies\r\n   * 4. BootstrapErrorHandler handles errors if needed\r\n   *\r\n   * **Performance Tracking:**\r\n   * Uses BootstrapPerformanceTracker with ENV (direct import) and null MetricsCollector.\r\n   * MetricsCollector is not yet available during bootstrap phase.\r\n   *\r\n   * @returns Result mit initialisiertem Container oder Fehlermeldung\r\n   */\r\n  bootstrap(): Result<ServiceContainer, string> {\r\n    // 1. Create container via ContainerFactory\r\n    const container = this.containerFactory.createRoot(ENV);\r\n\r\n    // 2. Track bootstrap performance and configure dependencies\r\n    const configured = this.performanceTracker.track(\r\n      () => this.dependencyConfigurator.configure(container),\r\n      (duration) => {\r\n        this.tryLogBootstrapCompletion(container, duration);\r\n      }\r\n    );\r\n\r\n    if (configured.ok) {\r\n      this.container = container;\r\n      return { ok: true, value: container };\r\n    }\r\n\r\n    // 3. Handle error via BootstrapErrorHandler\r\n    this.errorHandler.logError(configured.error, {\r\n      phase: \"bootstrap\",\r\n      component: \"CompositionRoot\",\r\n      metadata: { error: configured.error },\r\n    });\r\n\r\n    return { ok: false, error: configured.error };\r\n  }\r\n\r\n  /**\r\n   * Liefert den initialisierten Container als Result.\r\n   * @returns Result mit Container oder Fehlermeldung\r\n   */\r\n  getContainer(): Result<ServiceContainer, string> {\r\n    if (!this.container) {\r\n      return { ok: false, error: `${LOG_PREFIX} Container not initialized` };\r\n    }\r\n    return { ok: true, value: this.container };\r\n  }\r\n}\r\n","import { MODULE_METADATA, LOG_PREFIX } from \"@/application/constants/app-constants\";\r\nimport { isOk } from \"@/domain/utils/result\";\r\nimport { loggerToken } from \"@/infrastructure/shared/tokens/core/logger.token\";\r\nimport { bootstrapInitHookServiceToken } from \"@/infrastructure/shared/tokens/core/bootstrap-init-hook-service.token\";\r\nimport { bootstrapReadyHookServiceToken } from \"@/infrastructure/shared/tokens/core/bootstrap-ready-hook-service.token\";\r\nimport { CompositionRoot } from \"@/framework/core/composition-root\";\r\nimport { tryGetFoundryVersion } from \"@/infrastructure/adapters/foundry/versioning/versiondetector\";\r\nimport { BootstrapErrorHandler } from \"@/framework/core/bootstrap-error-handler\";\r\nimport type { Result } from \"@/domain/types/result\";\r\nimport type { ServiceContainer } from \"@/infrastructure/di/container\";\r\nimport { castResolvedService } from \"@/infrastructure/di/types/utilities/bootstrap-casts\";\r\nimport type { Logger } from \"@/infrastructure/logging/logger.interface\";\r\nimport type { BootstrapInitHookService } from \"@/framework/core/bootstrap-init-hook\";\r\nimport type { BootstrapReadyHookService } from \"@/framework/core/bootstrap-ready-hook\";\r\n\r\n/**\r\n * Boot-Orchestrierung für das Modul.\r\n *\r\n * Ablauf:\r\n * - Vor init: DI-Container erstellen (CompositionRoot.bootstrap) und bei Fehler abbrechen\r\n * - In init: API (resolve) exponieren, Ports selektieren/binden (via externem Selector), Hooks registrieren\r\n * - In ready: nur Logging o.ä. – Services sind über api.resolve nutzbar\r\n */\r\n\r\n/**\r\n * Function to encapsulate initialization logic.\r\n * This allows us to use return statements for soft aborts.\r\n *\r\n * NOTE: The function is fully covered via init-solid.test.ts; only truly\r\n * environment-dependent branches (Foundry globals) use fine-grained v8 ignores.\r\n */\r\nfunction initializeFoundryModule(): void {\r\n  const containerResult = root.getContainer();\r\n  /* v8 ignore start -- @preserve */\r\n  // Edge case: getContainer() fails after successful bootstrap.\r\n  // This is extremely unlikely in practice, but the error path exists for defensive programming.\r\n  // The root instance is created at module level (line 162), making it difficult to mock\r\n  // this specific error path in tests. The code path exists and will execute in real scenarios.\r\n  if (!containerResult.ok) {\r\n    console.error(`${LOG_PREFIX} ${containerResult.error}`);\r\n    return;\r\n  }\r\n  /* v8 ignore stop -- @preserve */\r\n\r\n  const loggerResult = containerResult.value.resolveWithError(loggerToken);\r\n  if (!loggerResult.ok) {\r\n    console.error(`${LOG_PREFIX} Failed to resolve logger: ${loggerResult.error.message}`);\r\n    return;\r\n  }\r\n  const logger = castResolvedService<Logger>(loggerResult.value);\r\n\r\n  // Resolve bootstrap hook services and register hooks\r\n  // CRITICAL: Use direct Hooks.on() for init/ready hooks to avoid chicken-egg problem.\r\n  // The PlatformEventPort system requires version detection (game.version), but game.version\r\n  // might not be available before the init hook runs. These bootstrap hooks must be registered\r\n  // immediately, so we use direct Foundry Hooks API here.\r\n  // All other hooks (registered inside init) can use PlatformEventPort normally.\r\n  const initHookServiceResult = containerResult.value.resolveWithError(\r\n    bootstrapInitHookServiceToken\r\n  );\r\n  if (!initHookServiceResult.ok) {\r\n    logger.error(\r\n      `Failed to resolve BootstrapInitHookService: ${initHookServiceResult.error.message}`\r\n    );\r\n    return;\r\n  }\r\n  const initHookService = castResolvedService<BootstrapInitHookService>(\r\n    initHookServiceResult.value\r\n  );\r\n  initHookService.register();\r\n\r\n  const readyHookServiceResult = containerResult.value.resolveWithError(\r\n    bootstrapReadyHookServiceToken\r\n  );\r\n  if (!readyHookServiceResult.ok) {\r\n    logger.error(\r\n      `Failed to resolve BootstrapReadyHookService: ${readyHookServiceResult.error.message}`\r\n    );\r\n    return;\r\n  }\r\n  const readyHookService = castResolvedService<BootstrapReadyHookService>(\r\n    readyHookServiceResult.value\r\n  );\r\n  readyHookService.register();\r\n}\r\n\r\n// Eager bootstrap DI before Foundry init\r\nconst root = new CompositionRoot();\r\nconst bootstrapResult = root.bootstrap();\r\nconst bootstrapOk = isOk(bootstrapResult);\r\n\r\n/**\r\n * Internal export for testing purposes only.\r\n * Returns the container from init-solid.ts.\r\n * This allows integration tests to use the same container instance as the module.\r\n *\r\n * @internal - For testing only\r\n */\r\nexport function getRootContainer(): Result<ServiceContainer, string> {\r\n  return root.getContainer();\r\n}\r\n\r\n/* v8 ignore start -- @preserve */\r\n/* Bootstrap-Fehlerpfade sind stark Foundry-versionsabhängig und schwer\r\n * deterministisch in Unit-Tests abzudecken. Die Logik wird über Integrationspfade geprüft;\r\n * für das Coverage-Gateway markieren wir diese Zweige vorerst als ignoriert. */\r\nif (!bootstrapOk) {\r\n  // Detect version once and reuse for both error logging and version-specific checks\r\n  const foundryVersion = tryGetFoundryVersion();\r\n\r\n  BootstrapErrorHandler.logError(bootstrapResult.error, {\r\n    phase: \"bootstrap\",\r\n    component: \"CompositionRoot\",\r\n    metadata: {\r\n      foundryVersion,\r\n    },\r\n  });\r\n\r\n  // Check if error is due to old Foundry version\r\n  let isOldFoundryVersion = false;\r\n  if (\r\n    typeof bootstrapResult.error === \"string\" &&\r\n    bootstrapResult.error.includes(\"PORT_SELECTION_FAILED\")\r\n  ) {\r\n    if (foundryVersion !== undefined && foundryVersion < 13) {\r\n      isOldFoundryVersion = true;\r\n      /* v8 ignore next -- @preserve */\r\n      if (typeof ui !== \"undefined\" && ui?.notifications) {\r\n        ui.notifications.error(\r\n          `${MODULE_METADATA.NAME} benötigt mindestens Foundry VTT Version 13. ` +\r\n            `Ihre Version: ${foundryVersion}. Bitte aktualisieren Sie Foundry VTT.`,\r\n          { permanent: true }\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Show generic error notification (only if not old Foundry version)\r\n  if (!isOldFoundryVersion && typeof ui !== \"undefined\" && ui?.notifications) {\r\n    ui.notifications?.error(\r\n      `${MODULE_METADATA.NAME} failed to initialize. Check console for details.`,\r\n      { permanent: true }\r\n    );\r\n  }\r\n\r\n  // Soft abort: Don't proceed with initialization\r\n  // (no throw, no return - just don't call initializeFoundryModule)\r\n} else {\r\n  // Only initialize if bootstrap succeeded\r\n  initializeFoundryModule();\r\n}\r\n/* v8 ignore stop -- @preserve */\r\n"],"names":["_disposed","value","map","transform","getFallback","promise","description","LogLevel","fallback","parser","config","store","instance","entries","ServiceLifecycle","SL","instanceResult","withTimeout","ServiceContainerImpl","message","v.object","v.string","v.optional","v.record","v.unknown","v.custom","v.safeParse","v.array","v.picklist","v.boolean","v.any","sanitizeHtml","document","size","clampTtl","DEFAULT_CACHE_SERVICE_CONFIG","partial","maxEntries","getFirstArrayElement","array","metadata","configResult","serviceResult","maintenancePortResult","maxSize","maxLength","LogLevelEnum","match","check","InitPhaseCriticality","args","game","ui","result","regex","resolveMultipleServices","realChannel","custom","record"],"mappings":"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","x_google_ignoreList":[80]}