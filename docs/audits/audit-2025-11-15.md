# Audit-Report „Sauberkeitsfokus“ – 15.11.2025

## Kontext
- **Scope:** `fvtt_relationship_app_module` (v0.24.0), Fokus auf SOLID, Dokumentation, Naming, Settings/Runtime-Konfiguration
- **Quellen:** `src/`, `docs/`, `lang/`, `module.json`
- **Nicht betrachtet:** UI-/Svelte-Implementierungen (laufende TODOs)

## Zusammenfassung
- 8 Findings (2 Hoch, 4 Mittel, 2 Niedrig)
- Hauptthemen: Service-Locator-Antipattern, nicht wirksame Runtime-Overrides, veraltete Dokumentation & Strings, fehlende JSDoc-Tags

## Findings im Detail

### 1. `ModuleSettingsRegistrar` verletzt SRP/DIP (Hoch)
```112:226:src/core/module-settings-registrar.ts
  registerAll(container: ServiceContainer): void {
    const settingsResult = container.resolveWithError(foundrySettingsToken);
    const loggerResult = container.resolveWithError(loggerToken);
    const i18nResult = container.resolveWithError(i18nFacadeToken);
    const notificationCenterResult = container.resolveWithError(notificationCenterToken);
    const runtimeConfigResult = container.resolveWithError(runtimeConfigToken);
    …
    this.registerDefinition(logLevelSetting, …);
```
- **Problem:** Klasse zieht fünf Dependencies über den Container (Service Locator), orchestriert Logging, I18n, Foundry-Settings, RuntimeConfig-Bridging und Error-Handling gleichzeitig.
- **Impact:** Schwer testbar, mehrere Gründe zur Änderung (Settings hinzufügen, Logging verändern, RuntimeConfig anpassen).
- **Empfehlung:** Dependencies via Konstruktor injizieren (`DIModuleSettingsRegistrar` mit statischen Dependencies) und Verantwortung splitten (z. B. `RuntimeConfigSettingBridge`, `ModuleSettingLogger`).

### 2. Cache-Settings wirken nicht zur Laufzeit (Hoch)
```18:47:src/config/modules/cache-services.config.ts
  const config: CacheServiceConfig = {
    enabled: runtimeConfig.get("enableCacheService"),
    defaultTtlMs: runtimeConfig.get("cacheDefaultTtlMs"),
    namespace: MODULE_CONSTANTS.MODULE.ID,
    ...(typeof maxEntries === "number" && maxEntries > 0 ? { maxEntries } : {}),
  };
  const configResult = container.registerValue(cacheServiceConfigToken, config);
```
- **Problem:** `CacheServiceConfig` wird einmalig beim Bootstrap aus dem RuntimeConfig-Snapshot erzeugt und als Value registriert. `CacheService` beobachtet kein `RuntimeConfigService`.
- **Impact:** Foundry-Einstellungen (`cacheEnabled`, `cacheTtlMs`, `cacheMaxEntries`) greifen nur nach komplettem Reload; widerspricht Release Notes zu Live-Overrides.
- **Empfehlung:** Entweder (a) `CacheService` selbst an `runtimeConfig.onChange()` binden oder (b) `CacheServiceConfig` als Factory registrieren, die bei jeder Resolution aktuelle Werte liefert.

### 3. Verwaiste i18n-Keys & Settings-Mismatch (Mittel)
```1:25:lang/en.json
  "MODULE.SETTINGS.enableFeature.name": "Enable Feature",
  "MODULE.SETTINGS.debugMode.name": "Debug Mode",
…
  "MODULE.SETTINGS.metricsPersistenceKey.hint": "LocalStorage key used when metrics persistence is enabled."
```
```59:68:src/constants.ts
  SETTINGS: {
    LOG_LEVEL: "logLevel",
    CACHE_ENABLED: "cacheEnabled",
    CACHE_TTL_MS: "cacheTtlMs",
    CACHE_MAX_ENTRIES: "cacheMaxEntries",
    PERFORMANCE_TRACKING_ENABLED: "performanceTrackingEnabled",
    PERFORMANCE_SAMPLING_RATE: "performanceSamplingRate",
    METRICS_PERSISTENCE_ENABLED: "metricsPersistenceEnabled",
    METRICS_PERSISTENCE_KEY: "metricsPersistenceKey",
  },
```
- **Problem:** Übersetzungen für `enableFeature`/`debugMode` existieren, aber keine entsprechenden Setting-Definitionen oder Konstanten.
- **Impact:** Übersetzungsdateien verwittern, verunsichern Contributor bzgl. existierender Settings.
- **Empfehlung:** Keys entfernen oder Setting implementieren + in `MODULE_CONSTANTS.SETTINGS` aufnehmen.

### 4. `enableDebugMode` Config bleibt ungenutzt (Mittel)
```3:45:src/core/runtime-config/runtime-config.service.ts
export type RuntimeConfigValues = {
  …
  enableDebugMode: boolean;
  …
};
```
`rg "enableDebugMode" src` zeigt ausschließlich Tests & Fallback-Konfiguration.
- **Impact:** Flags erzeugen Erwartungshaltung (Docs sprechen von Debug-Modus), entfalten aber keine Wirkung.
- **Empfehlung:** Entweder Consumer ergänzen (z. B. Debug-spezifische Logger/Validierungen an `RuntimeConfigService`) oder Feld entfernen und Dokumentation korrigieren.

### 5. JSDoc-Vertragslücken (Mittel)
```12:48:src/config/modules/cache-services.config.ts
/**
 * Registers CacheService and its configuration.
 *
 * Reads defaults …
 */
export function registerCacheServices(container: ServiceContainer): Result<void, string> {
```
```152:179:src/core/api/module-api-initializer.ts
  /**
   * Applies read-only wrappers when API consumers resolve sensitive services.
   *
   * @param token …
   * @param service …
   * @param wellKnownTokens …
   */
  private wrapSensitiveService(…): TServiceType {
```
- **Problem:** Styleguide verlangt `@param`/`@returns` für exportierte/öffentliche Funktionen. `registerCacheServices` hat keine Tags; `wrapSensitiveService` dokumentiert Rückgabewert nicht.
- **Impact:** Automatische Doku-Generierung & Leser*innen bekommen keine Signaturinfos.
- **Empfehlung:** JSDoc-Tags ergänzen (inkl. `@returns`) und Styleguide-Verweis in PR-Checklist aufnehmen.

### 6. Dokumentations-Metadaten veraltet (Mittel)
```3:6:docs/INDEX.md
**Datum:** 2025-11-13
**Projekt-Version:** 0.19.1 (Pre-Release)
```
```3:7:docs/PROJECT-ANALYSIS.md
**Aktualisiert:** 2025-11-14 (v0.20.0)
```
```3:7:docs/DEPENDENCY-MAP.md
**Aktualisiert:** 2025-11-13 (v0.19.1)
```
- **Problem:** Leitdokumente deklarieren alte Versionsstände, obwohl `module.json` bereits v0.24.0 ausweist.
- **Impact:** Contributors erhalten falsche Versions-/Scope-Informationen, Audit-Trails reißen ab.
- **Empfehlung:** Header-Daten aktualisieren und neue Features (RuntimeConfig Layer, CacheService, NotificationCenter) in den jeweiligen Abschnitten einpflegen.

### 7. `docs/CONFIGURATION.md` listet nicht alle ENV-Variablen (Mittel)
```11:19:docs/CONFIGURATION.md
| Variable | Typ | Standard | Beschreibung |
| `MODE` | string | `development` | …
| `VITE_ENABLE_PERF_TRACKING` | boolean | …
| `VITE_ENABLE_METRICS_PERSISTENCE` | boolean | …
| `VITE_METRICS_PERSISTENCE_KEY` | string | …
| `VITE_CACHE_ENABLED` | boolean | …
| `VITE_CACHE_TTL_MS` | number | …
| `VITE_CACHE_MAX_ENTRIES` | number | — |
```
```100:123:src/config/environment.ts
  performanceSamplingRate:
    import.meta.env.MODE === "production"
      ? parseSamplingRate(import.meta.env.VITE_PERF_SAMPLING_RATE, 0.01)
      : 1.0,
```
- **Problem:** Tabelle erwähnt `VITE_PERF_SAMPLING_RATE`/`VITE_ENABLE_DEBUG_MODE` nicht, obwohl `EnvironmentConfig` diese nutzt (Sampling Rate entscheidet über Observability-Overhead).
- **Impact:** Operatoren können Sampling nicht konfigurieren; Dokumentation suggeriert fixe Werte.
- **Empfehlung:** Tabelle um alle `ENV`-Felder ergänzen und RuntimeConfig-Abschnitt mit Sampling-Beispiel aktualisieren.

### 8. Offener TODO ohne Tracking (Niedrig)
```9:15:src/index.ts
import "../styles/tailwind.css";
// TODO: Re-enable UI style imports once the Svelte-based network UI is shipped.
// import "@xyflow/svelte/dist/style.css";
```
- **Problem:** TODO ohne Ticket/Issue-Referenz oder Owner; Gefahr, dass UI-Styles nach Launch vergessen werden.
- **Empfehlung:** Issue verlinken oder TODO in README/roadmap eintragen; ggf. Feature-Flag für UI-Styles vorsehen.

## Nächste Schritte
1. Ownership & Timeline für Findings festlegen (Ticket + Priorität).
2. RuntimeConfig/Cache-Service-Neuordnung vorziehen (Risk of misconfigured caches in prod).
3. Dokumentations-Header & ENV-Tabelle sofort aktualisieren (geringer Aufwand, hohe Klarheit).
4. Nachziehen von Styleguide-Prüfungen (lint rule oder PR-Checklist).

